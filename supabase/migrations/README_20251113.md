# Migration 20251113 - Fix CarCard API Errors

## Overview
This migration fixes several API errors appearing in the CarCard component console logs by:
1. Adding rating columns to the cars table
2. Fixing query errors in RealtimePricingService
3. Improving error handling in car-locations service

## Changes Made

### 1. Database Migration: Add Rating Columns to Cars Table
**File**: `20251113_add_rating_columns_to_cars.sql`

Adds `rating_avg` and `rating_count` columns to the `cars` table with:
- Default values of 0
- Constraints (rating_avg: 0-5, rating_count: >= 0)
- Indexes for performance
- Trigger to auto-update ratings when reviews change

### 2. Service Fixes

#### RealtimePricingService (`realtime-pricing.service.ts`)
- **Fixed**: `exchange_rates` query changed from `.single()` to `.maybeSingle()` to handle 0 rows
- **Fixed**: `pricing_demand_snapshots` query now has proper error handling with early return

#### CarLocationsService (`car-locations.service.ts`)
- **Fixed**: Silent handling of `car_stats` table not existing (error code PGRST205)
- **Reason**: Ratings now come from `cars` table directly, not from `car_stats`

## How to Apply

### Option 1: Supabase Dashboard (Recommended)
1. Go to Supabase Dashboard → SQL Editor
2. Copy contents of `20251113_add_rating_columns_to_cars.sql`
3. Run the migration
4. Verify: Check that `cars` table now has `rating_avg` and `rating_count` columns

### Option 2: Supabase CLI
```bash
supabase db push
```

## Verification

After applying the migration, verify the following:

1. **Console Errors Should Be Gone**:
   - ✅ No more "406 Not Acceptable" errors for exchange_rates
   - ✅ No more "400 Bad Request" errors for pricing_demand_snapshots
   - ✅ No more "404 Not Found" errors for car_stats

2. **Cars Table Has Rating Columns**:
   ```sql
   SELECT rating_avg, rating_count FROM cars LIMIT 5;
   ```
   Should return 0 values for all cars (until reviews are added)

3. **CarCard Component Displays Correctly**:
   - Car cards should display without console errors
   - Rating display should work (shows nothing when rating_count = 0)

## Impact

### Before
- Console filled with red API errors
- CarCard trying to load from non-existent tables
- Frontend logs showing "ObjectUnsubscribedError" and other issues

### After
- Clean console logs
- Graceful fallbacks for missing data
- Rating system ready for when reviews are implemented
- Proper error handling with informative warnings only when needed

## Notes

- The `car_stats` table is NOT created by this migration
- If you want to use the car_stats approach (separate stats table), you'll need to:
  1. Run the `database/setup-reviews-system.sql` script
  2. Update the car-locations service to use car_stats again
- Current approach: ratings stored directly on cars table (simpler, faster queries)

## Rollback (if needed)

To rollback this migration:
```sql
-- Remove trigger and function
DROP TRIGGER IF EXISTS trigger_update_car_rating ON public.reviews;
DROP FUNCTION IF EXISTS public.update_car_rating_on_review_change();

-- Remove columns
ALTER TABLE public.cars
  DROP COLUMN IF EXISTS rating_avg,
  DROP COLUMN IF EXISTS rating_count;
```

## Related Issues

This migration fixes the console errors seen in the following scenario:
- User visits marketplace page
- CarCard components load
- API calls to exchange_rates, pricing_demand_snapshots, and car_stats fail
- Console shows red errors affecting developer experience

## Author
Claude AI Assistant
Date: 2025-11-13
