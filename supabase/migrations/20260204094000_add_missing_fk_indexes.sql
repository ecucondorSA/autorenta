-- ============================================================================
-- MIGRATION: Add missing FK indexes (non-concurrent for migration safety)
-- Date: 2026-02-04
-- Notes:
--   - These indexes were created CONCURRENTLY in production.
--   - Using non-concurrent CREATE INDEX here to remain transaction-safe.
-- ============================================================================

CREATE INDEX IF NOT EXISTS idx_ab_test_metrics_test_id_fk ON public.ab_test_metrics (test_id);
CREATE INDEX IF NOT EXISTS idx_ab_tests_campaign_id_fk ON public.ab_tests (campaign_id);
CREATE INDEX IF NOT EXISTS idx_accounting_accounts_parent_account_id_fk ON public.accounting_accounts (parent_account_id);
CREATE INDEX IF NOT EXISTS idx_accounting_audit_log_resolved_by_fk ON public.accounting_audit_log (resolved_by);
CREATE INDEX IF NOT EXISTS idx_accounting_ledger_account_code_fk ON public.accounting_ledger (account_code);
CREATE INDEX IF NOT EXISTS idx_accounting_ledger_created_by_fk ON public.accounting_ledger (created_by);
CREATE INDEX IF NOT EXISTS idx_accounting_ledger_user_id_fk ON public.accounting_ledger (user_id);
CREATE INDEX IF NOT EXISTS idx_accounting_period_closures_closed_by_fk ON public.accounting_period_closures (closed_by);
CREATE INDEX IF NOT EXISTS idx_admin_audit_log_admin_user_id_fk ON public.admin_audit_log (admin_user_id);
CREATE INDEX IF NOT EXISTS idx_admin_users_granted_by_fk ON public.admin_users (granted_by);
CREATE INDEX IF NOT EXISTS idx_admin_users_revoked_by_fk ON public.admin_users (revoked_by);
CREATE INDEX IF NOT EXISTS idx_admin_users_user_id_fk ON public.admin_users (user_id);
CREATE INDEX IF NOT EXISTS idx_app_config_created_by_fk ON public.app_config (created_by);
CREATE INDEX IF NOT EXISTS idx_bank_accounts_user_id_fk ON public.bank_accounts (user_id);
CREATE INDEX IF NOT EXISTS idx_bookings_cancelled_by_fk ON public.bookings (cancelled_by);
CREATE INDEX IF NOT EXISTS idx_bookings_car_id_fk ON public.bookings (car_id);
CREATE INDEX IF NOT EXISTS idx_bookings_owner_id_fk ON public.bookings (owner_id);
CREATE INDEX IF NOT EXISTS idx_bookings_renter_id_fk ON public.bookings (renter_id);
CREATE INDEX IF NOT EXISTS idx_campaign_events_campaign_id_fk ON public.campaign_events (campaign_id);
CREATE INDEX IF NOT EXISTS idx_campaign_events_user_id_fk ON public.campaign_events (user_id);
CREATE INDEX IF NOT EXISTS idx_campaign_schedules_created_by_fk ON public.campaign_schedules (created_by);
CREATE INDEX IF NOT EXISTS idx_car_blocked_dates_car_id_fk ON public.car_blocked_dates (car_id);
CREATE INDEX IF NOT EXISTS idx_car_photos_car_id_fk ON public.car_photos (car_id);
CREATE INDEX IF NOT EXISTS idx_car_pricing_matrix_car_id_fk ON public.car_pricing_matrix (car_id);
CREATE INDEX IF NOT EXISTS idx_car_pricing_matrix_risk_category_fk ON public.car_pricing_matrix (risk_category);
CREATE INDEX IF NOT EXISTS idx_car_stats_car_id_fk ON public.car_stats (car_id);
CREATE INDEX IF NOT EXISTS idx_cars_owner_id_fk ON public.cars (owner_id);
CREATE INDEX IF NOT EXISTS idx_cars_owner_id_fk_cde223 ON public.cars (owner_id);
CREATE INDEX IF NOT EXISTS idx_cars_fipe_history_car_id_fk ON public.cars_fipe_history (car_id);
CREATE INDEX IF NOT EXISTS idx_credit_reports_user_id_fk ON public.credit_reports (user_id);
CREATE INDEX IF NOT EXISTS idx_driver_risk_profile_user_id_fk ON public.driver_risk_profile (user_id);
CREATE INDEX IF NOT EXISTS idx_driver_risk_scores_user_id_fk ON public.driver_risk_scores (user_id);
CREATE INDEX IF NOT EXISTS idx_email_events_send_id_fk ON public.email_events (send_id);
CREATE INDEX IF NOT EXISTS idx_email_sends_sequence_id_fk ON public.email_sends (sequence_id);
CREATE INDEX IF NOT EXISTS idx_email_sends_step_id_fk ON public.email_sends (step_id);
CREATE INDEX IF NOT EXISTS idx_email_sends_subscriber_id_fk ON public.email_sends (subscriber_id);
CREATE INDEX IF NOT EXISTS idx_email_sequence_steps_sequence_id_fk ON public.email_sequence_steps (sequence_id);
CREATE INDEX IF NOT EXISTS idx_email_subscribers_source_campaign_id_fk ON public.email_subscribers (source_campaign_id);
CREATE INDEX IF NOT EXISTS idx_email_subscribers_user_id_fk ON public.email_subscribers (user_id);
CREATE INDEX IF NOT EXISTS idx_email_verification_audit_log_user_id_fk ON public.email_verification_audit_log (user_id);
CREATE INDEX IF NOT EXISTS idx_ev_policies_car_id_fk ON public.ev_policies (car_id);
CREATE INDEX IF NOT EXISTS idx_ev_policy_violations_booking_id_fk ON public.ev_policy_violations (booking_id);
CREATE INDEX IF NOT EXISTS idx_ev_policy_violations_policy_id_fk ON public.ev_policy_violations (policy_id);
CREATE INDEX IF NOT EXISTS idx_evidence_items_package_id_fk ON public.evidence_items (package_id);
CREATE INDEX IF NOT EXISTS idx_evidence_items_verified_by_fk ON public.evidence_items (verified_by);
CREATE INDEX IF NOT EXISTS idx_evidence_packages_booking_id_fk ON public.evidence_packages (booking_id);
CREATE INDEX IF NOT EXISTS idx_evidence_packages_sealed_by_fk ON public.evidence_packages (sealed_by);
CREATE INDEX IF NOT EXISTS idx_feature_flag_audit_log_changed_by_fk ON public.feature_flag_audit_log (changed_by);
CREATE INDEX IF NOT EXISTS idx_feature_flag_audit_log_feature_flag_id_fk ON public.feature_flag_audit_log (feature_flag_id);
CREATE INDEX IF NOT EXISTS idx_feature_flag_events_flag_id_fk ON public.feature_flag_events (flag_id);
CREATE INDEX IF NOT EXISTS idx_feature_flag_events_user_id_fk ON public.feature_flag_events (user_id);
CREATE INDEX IF NOT EXISTS idx_feature_flag_overrides_created_by_fk ON public.feature_flag_overrides (created_by);
CREATE INDEX IF NOT EXISTS idx_feature_flag_overrides_feature_flag_id_fk ON public.feature_flag_overrides (feature_flag_id);
CREATE INDEX IF NOT EXISTS idx_feature_flags_created_by_fk ON public.feature_flags (created_by);
CREATE INDEX IF NOT EXISTS idx_feature_flags_updated_by_fk ON public.feature_flags (updated_by);
CREATE INDEX IF NOT EXISTS idx_fgo_claims_booking_id_fk ON public.fgo_claims (booking_id);
CREATE INDEX IF NOT EXISTS idx_fgo_claims_claimant_id_fk ON public.fgo_claims (claimant_id);
CREATE INDEX IF NOT EXISTS idx_fgo_claims_reviewed_by_fk ON public.fgo_claims (reviewed_by);
CREATE INDEX IF NOT EXISTS idx_fgo_contributions_booking_id_fk ON public.fgo_contributions (booking_id);
CREATE INDEX IF NOT EXISTS idx_google_calendar_tokens_user_id_fk ON public.google_calendar_tokens (user_id);
CREATE INDEX IF NOT EXISTS idx_immobilizer_commands_approved_by_fk ON public.immobilizer_commands (approved_by);
CREATE INDEX IF NOT EXISTS idx_immobilizer_commands_booking_id_fk ON public.immobilizer_commands (booking_id);
CREATE INDEX IF NOT EXISTS idx_immobilizer_commands_car_id_fk ON public.immobilizer_commands (car_id);
CREATE INDEX IF NOT EXISTS idx_immobilizer_commands_requested_by_fk ON public.immobilizer_commands (requested_by);
CREATE INDEX IF NOT EXISTS idx_iot_devices_car_id_fk ON public.iot_devices (car_id);
CREATE INDEX IF NOT EXISTS idx_iot_devices_installed_by_fk ON public.iot_devices (installed_by);
CREATE INDEX IF NOT EXISTS idx_marketing_alerts_content_id_fk ON public.marketing_alerts (content_id);
CREATE INDEX IF NOT EXISTS idx_marketing_alerts_persona_id_fk ON public.marketing_alerts (persona_id);
CREATE INDEX IF NOT EXISTS idx_marketing_campaigns_created_by_fk ON public.marketing_campaigns (created_by);
CREATE INDEX IF NOT EXISTS idx_marketing_content_persona_id_fk ON public.marketing_content (persona_id);
CREATE INDEX IF NOT EXISTS idx_marketing_content_queue_authority_concept_id_fk ON public.marketing_content_queue (authority_concept_id);
CREATE INDEX IF NOT EXISTS idx_marketing_content_queue_hook_variant_id_fk ON public.marketing_content_queue (hook_variant_id);
CREATE INDEX IF NOT EXISTS idx_marketing_engagement_content_id_fk ON public.marketing_engagement (content_id);
CREATE INDEX IF NOT EXISTS idx_marketing_metrics_daily_campaign_id_fk ON public.marketing_metrics_daily (campaign_id);
CREATE INDEX IF NOT EXISTS idx_marketing_posts_log_queue_id_fk ON public.marketing_posts_log (queue_id);
CREATE INDEX IF NOT EXISTS idx_messages_booking_id_fk ON public.messages (booking_id);
CREATE INDEX IF NOT EXISTS idx_messages_car_id_fk ON public.messages (car_id);
CREATE INDEX IF NOT EXISTS idx_messages_sender_id_fk ON public.messages (sender_id);
CREATE INDEX IF NOT EXISTS idx_newsletter_editions_created_by_fk ON public.newsletter_editions (created_by);
CREATE INDEX IF NOT EXISTS idx_notification_history_user_id_fk ON public.notification_history (user_id);
CREATE INDEX IF NOT EXISTS idx_notification_preferences_user_id_fk ON public.notification_preferences (user_id);
CREATE INDEX IF NOT EXISTS idx_notification_queue_template_code_fk ON public.notification_queue (template_code);
CREATE INDEX IF NOT EXISTS idx_notification_queue_user_id_fk ON public.notification_queue (user_id);
CREATE INDEX IF NOT EXISTS idx_notification_settings_user_id_fk ON public.notification_settings (user_id);
CREATE INDEX IF NOT EXISTS idx_notifications_user_id_fk ON public.notifications (user_id);
CREATE INDEX IF NOT EXISTS idx_otp_delivery_logs_user_id_fk ON public.otp_delivery_logs (user_id);
CREATE INDEX IF NOT EXISTS idx_outreach_campaigns_created_by_fk ON public.outreach_campaigns (created_by);
CREATE INDEX IF NOT EXISTS idx_outreach_messages_contact_id_fk ON public.outreach_messages (contact_id);
CREATE INDEX IF NOT EXISTS idx_passkey_challenges_user_id_fk ON public.passkey_challenges (user_id);
CREATE INDEX IF NOT EXISTS idx_passkeys_user_id_fk ON public.passkeys (user_id);
CREATE INDEX IF NOT EXISTS idx_payment_captures_queue_booking_id_fk ON public.payment_captures_queue (booking_id);
CREATE INDEX IF NOT EXISTS idx_phone_otp_codes_user_id_fk ON public.phone_otp_codes (user_id);
CREATE INDEX IF NOT EXISTS idx_photo_quality_logs_car_id_fk ON public.photo_quality_logs (car_id);
CREATE INDEX IF NOT EXISTS idx_photo_quality_logs_user_id_fk ON public.photo_quality_logs (user_id);
CREATE INDEX IF NOT EXISTS idx_plate_detection_logs_car_id_fk ON public.plate_detection_logs (car_id);
CREATE INDEX IF NOT EXISTS idx_plate_detection_logs_user_id_fk ON public.plate_detection_logs (user_id);
CREATE INDEX IF NOT EXISTS idx_playbook_executions_booking_id_fk ON public.playbook_executions (booking_id);
CREATE INDEX IF NOT EXISTS idx_playbook_executions_playbook_id_fk ON public.playbook_executions (playbook_id);
CREATE INDEX IF NOT EXISTS idx_playbook_executions_recovery_case_id_fk ON public.playbook_executions (recovery_case_id);
CREATE INDEX IF NOT EXISTS idx_playbook_executions_ticket_id_fk ON public.playbook_executions (ticket_id);
CREATE INDEX IF NOT EXISTS idx_playbook_steps_playbook_id_fk ON public.playbook_steps (playbook_id);
CREATE INDEX IF NOT EXISTS idx_profiles_id_fk ON public.profiles (id);
CREATE INDEX IF NOT EXISTS idx_push_tokens_user_id_fk ON public.push_tokens (user_id);
CREATE INDEX IF NOT EXISTS idx_recovery_cases_assigned_to_fk ON public.recovery_cases (assigned_to);
CREATE INDEX IF NOT EXISTS idx_recovery_cases_booking_id_fk ON public.recovery_cases (booking_id);
CREATE INDEX IF NOT EXISTS idx_referral_codes_user_id_fk ON public.referral_codes (user_id);
CREATE INDEX IF NOT EXISTS idx_referral_rewards_referral_id_fk ON public.referral_rewards (referral_id);
CREATE INDEX IF NOT EXISTS idx_referral_rewards_user_id_fk ON public.referral_rewards (user_id);
CREATE INDEX IF NOT EXISTS idx_referrals_referral_code_id_fk ON public.referrals (referral_code_id);
CREATE INDEX IF NOT EXISTS idx_referrals_referrer_id_fk ON public.referrals (referrer_id);
CREATE INDEX IF NOT EXISTS idx_reviews_booking_id_fk ON public.reviews (booking_id);
CREATE INDEX IF NOT EXISTS idx_reviews_reviewee_id_fk ON public.reviews (reviewee_id);
CREATE INDEX IF NOT EXISTS idx_reviews_reviewer_id_fk ON public.reviews (reviewer_id);
CREATE INDEX IF NOT EXISTS idx_reward_pool_contributions_booking_id_fk ON public.reward_pool_contributions (booking_id);
CREATE INDEX IF NOT EXISTS idx_reward_pool_contributions_owner_id_fk ON public.reward_pool_contributions (owner_id);
CREATE INDEX IF NOT EXISTS idx_reward_pool_contributions_pool_id_fk ON public.reward_pool_contributions (pool_id);
CREATE INDEX IF NOT EXISTS idx_reward_pool_payouts_owner_id_fk ON public.reward_pool_payouts (owner_id);
CREATE INDEX IF NOT EXISTS idx_reward_pool_payouts_pool_id_fk ON public.reward_pool_payouts (pool_id);
CREATE INDEX IF NOT EXISTS idx_risk_assessments_booking_id_fk ON public.risk_assessments (booking_id);
CREATE INDEX IF NOT EXISTS idx_risk_assessments_user_id_fk ON public.risk_assessments (user_id);
CREATE INDEX IF NOT EXISTS idx_risk_events_booking_id_fk ON public.risk_events (booking_id);
CREATE INDEX IF NOT EXISTS idx_risk_events_owner_id_fk ON public.risk_events (owner_id);
CREATE INDEX IF NOT EXISTS idx_risk_events_renter_id_fk ON public.risk_events (renter_id);
CREATE INDEX IF NOT EXISTS idx_risk_score_history_user_id_fk ON public.risk_score_history (user_id);
CREATE INDEX IF NOT EXISTS idx_sdui_analytics_user_id_fk ON public.sdui_analytics (user_id);
CREATE INDEX IF NOT EXISTS idx_sdui_layouts_created_by_fk ON public.sdui_layouts (created_by);
CREATE INDEX IF NOT EXISTS idx_social_publishing_log_campaign_id_fk ON public.social_publishing_log (campaign_id);
CREATE INDEX IF NOT EXISTS idx_special_events_created_by_fk ON public.special_events (created_by);
CREATE INDEX IF NOT EXISTS idx_subscriptions_payment_transaction_id_fk ON public.subscriptions (payment_transaction_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_plan_id_fk ON public.subscriptions (plan_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_user_id_fk ON public.subscriptions (user_id);
CREATE INDEX IF NOT EXISTS idx_support_ticket_messages_sender_id_fk ON public.support_ticket_messages (sender_id);
CREATE INDEX IF NOT EXISTS idx_support_ticket_messages_ticket_id_fk ON public.support_ticket_messages (ticket_id);
CREATE INDEX IF NOT EXISTS idx_support_tickets_assigned_to_fk ON public.support_tickets (assigned_to);
CREATE INDEX IF NOT EXISTS idx_support_tickets_booking_id_fk ON public.support_tickets (booking_id);
CREATE INDEX IF NOT EXISTS idx_support_tickets_recovery_case_id_fk ON public.support_tickets (recovery_case_id);
CREATE INDEX IF NOT EXISTS idx_support_tickets_user_id_fk ON public.support_tickets (user_id);
CREATE INDEX IF NOT EXISTS idx_user_blocks_blocker_id_fk ON public.user_blocks (blocker_id);
CREATE INDEX IF NOT EXISTS idx_user_documents_reviewed_by_fk ON public.user_documents (reviewed_by);
CREATE INDEX IF NOT EXISTS idx_user_documents_user_id_fk ON public.user_documents (user_id);
CREATE INDEX IF NOT EXISTS idx_user_identity_levels_manual_reviewed_by_fk ON public.user_identity_levels (manual_reviewed_by);
CREATE INDEX IF NOT EXISTS idx_user_identity_levels_user_id_fk ON public.user_identity_levels (user_id);
CREATE INDEX IF NOT EXISTS idx_user_risk_scores_user_id_fk ON public.user_risk_scores (user_id);
CREATE INDEX IF NOT EXISTS idx_user_risk_stats_user_id_fk ON public.user_risk_stats (user_id);
CREATE INDEX IF NOT EXISTS idx_user_verifications_user_id_fk ON public.user_verifications (user_id);
CREATE INDEX IF NOT EXISTS idx_user_wallets_user_id_fk ON public.user_wallets (user_id);
CREATE INDEX IF NOT EXISTS idx_vehicle_documents_manual_reviewed_by_fk ON public.vehicle_documents (manual_reviewed_by);
CREATE INDEX IF NOT EXISTS idx_vehicle_documents_user_id_fk ON public.vehicle_documents (user_id);
CREATE INDEX IF NOT EXISTS idx_vehicle_documents_vehicle_id_fk ON public.vehicle_documents (vehicle_id);
CREATE INDEX IF NOT EXISTS idx_vehicle_pricing_models_category_id_fk ON public.vehicle_pricing_models (category_id);
CREATE INDEX IF NOT EXISTS idx_vehicle_recognition_logs_car_id_fk ON public.vehicle_recognition_logs (car_id);
CREATE INDEX IF NOT EXISTS idx_vehicle_telemetry_booking_id_fk ON public.vehicle_telemetry (booking_id);
CREATE INDEX IF NOT EXISTS idx_vehicle_telemetry_car_id_fk ON public.vehicle_telemetry (car_id);
CREATE INDEX IF NOT EXISTS idx_wallet_split_config_locador_id_fk ON public.wallet_split_config (locador_id);
CREATE INDEX IF NOT EXISTS idx_wallet_transactions_user_id_fk ON public.wallet_transactions (user_id);
CREATE INDEX IF NOT EXISTS idx_wallets_user_id_fk ON public.wallets (user_id);
CREATE INDEX IF NOT EXISTS idx_webhook_retry_queue_resolved_by_fk ON public.webhook_retry_queue (resolved_by);
CREATE INDEX IF NOT EXISTS idx_withdrawal_requests_approved_by_fk ON public.withdrawal_requests (approved_by);
CREATE INDEX IF NOT EXISTS idx_withdrawal_requests_bank_account_id_fk ON public.withdrawal_requests (bank_account_id);
CREATE INDEX IF NOT EXISTS idx_withdrawal_requests_user_id_fk ON public.withdrawal_requests (user_id);
CREATE INDEX IF NOT EXISTS idx_withdrawal_transactions_request_id_fk ON public.withdrawal_transactions (request_id);
CREATE INDEX IF NOT EXISTS idx_accounting_period_balances_account_id_fk
ON public.accounting_period_balances (account_id);
CREATE INDEX IF NOT EXISTS idx_messages_recipient_id_fk
ON public.messages (recipient_id);
CREATE INDEX IF NOT EXISTS idx_user_blocks_blocked_id_fk
ON public.user_blocks (blocked_id);
