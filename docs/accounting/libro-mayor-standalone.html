<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libro Mayor - AutoRenta</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .filters {
            padding: 24px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 1px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            padding: 24px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }

        th.text-right {
            text-align: right;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .account-code {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #667eea;
        }

        .account-name {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .amount {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .amount.debit {
            color: #dc2626;
        }

        .amount.credit {
            color: #16a34a;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 8px;
        }

        .config-section {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .config-section h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #92400e;
        }

        .config-section input {
            width: 100%;
            padding: 10px;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .config-section button {
            width: 100%;
        }

        .error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Libro Mayor - AutoRenta</h1>
            <p>Sistema Contable Automatizado</p>
        </div>

        <div class="config-section">
            <h3>‚öôÔ∏è Configuraci√≥n de Conexi√≥n</h3>
            <input type="text" id="supabaseUrl" placeholder="URL de Supabase (ej: https://xxx.supabase.co)" />
            <input type="text" id="supabaseKey" placeholder="Anon Key de Supabase" />
            <button class="btn btn-primary" onclick="connectSupabase()">Conectar</button>
            <div id="configStatus" style="margin-top: 8px; font-size: 12px;"></div>
        </div>

        <div class="filters" id="filtersSection" style="display: none;">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Fecha Inicio</label>
                    <input type="date" id="startDate" />
                </div>
                <div class="filter-group">
                    <label>Fecha Fin</label>
                    <input type="date" id="endDate" />
                </div>
                <div class="filter-group">
                    <label>C√≥digo de Cuenta</label>
                    <input type="text" id="accountCode" placeholder="Ej: 2.1.1.01" />
                </div>
                <div class="filter-group">
                    <label>Tipo de Referencia</label>
                    <select id="referenceType">
                        <option value="">Todos</option>
                        <option value="booking">Booking</option>
                        <option value="deposit">Dep√≥sito</option>
                        <option value="withdrawal">Retiro</option>
                        <option value="fgo">FGO</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>B√∫squeda</label>
                    <input type="text" id="searchTerm" placeholder="Buscar en descripci√≥n" />
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="loadLedger()">Aplicar Filtros</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Limpiar</button>
                <button class="btn btn-secondary" onclick="exportToCSV()">Exportar CSV</button>
            </div>
        </div>

        <div class="content">
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <h3>Total Registros</h3>
                    <div class="value" id="totalRecords">0</div>
                </div>
                <div class="stat-card">
                    <h3>Total D√©bitos</h3>
                    <div class="value" id="totalDebits">$0.00</div>
                </div>
                <div class="stat-card">
                    <h3>Total Cr√©ditos</h3>
                    <div class="value" id="totalCredits">$0.00</div>
                </div>
                <div class="stat-card">
                    <h3>P√°gina Actual</h3>
                    <div class="value" id="currentPage">1 / 1</div>
                </div>
            </div>

            <div id="errorMessage"></div>

            <div class="table-container">
                <div id="loading" class="loading">Cargando libro mayor</div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>No hay entradas en el libro mayor para los filtros seleccionados</p>
                </div>
                <table id="ledgerTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cuenta</th>
                            <th class="text-right">D√©bito</th>
                            <th class="text-right">Cr√©dito</th>
                            <th>Descripci√≥n</th>
                            <th>Tipo</th>
                            <th>Per√≠odo Fiscal</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody">
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <div class="pagination-info" id="paginationInfo"></div>
                <div class="pagination-buttons">
                    <button class="btn btn-secondary" id="prevBtn" onclick="changePage(-1)">Anterior</button>
                    <button class="btn btn-secondary" id="nextBtn" onclick="changePage(1)">Siguiente</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        let currentPage = 1;
        const pageSize = 50;
        let totalPages = 1;
        let totalRecords = 0;
        let currentData = [];

        function connectSupabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();

            if (!url || !key) {
                showError('Por favor, ingresa la URL y la clave de Supabase');
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                document.getElementById('filtersSection').style.display = 'block';
                document.getElementById('configStatus').innerHTML = '<span style="color: green;">‚úÖ Conectado</span>';
                document.getElementById('configStatus').style.color = 'green';
                loadLedger();
            } catch (error) {
                showError('Error al conectar: ' + error.message);
            }
        }

        async function loadLedger() {
            if (!supabase) {
                showError('Por favor, conecta primero a Supabase');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('ledgerTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('errorMessage').innerHTML = '';

            try {
                const filters = {
                    startDate: document.getElementById('startDate').value || undefined,
                    endDate: document.getElementById('endDate').value || undefined,
                    accountCode: document.getElementById('accountCode').value.trim() || undefined,
                    referenceType: document.getElementById('referenceType').value || undefined,
                    searchTerm: document.getElementById('searchTerm').value.trim() || undefined,
                };

                let query = supabase
                    .from('accounting_ledger')
                    .select(`
                        *,
                        accounting_chart_of_accounts!accounting_ledger_account_code_fkey (
                            code,
                            name,
                            account_type
                        )
                    `, { count: 'exact' })
                    .order('entry_date', { ascending: false })
                    .order('created_at', { ascending: false });

                if (filters.startDate) {
                    query = query.gte('entry_date', filters.startDate);
                }
                if (filters.endDate) {
                    query = query.lte('entry_date', filters.endDate);
                }
                if (filters.accountCode) {
                    query = query.eq('account_code', filters.accountCode);
                }
                if (filters.referenceType) {
                    query = query.eq('reference_type', filters.referenceType);
                }
                if (filters.searchTerm) {
                    query = query.ilike('description', `%${filters.searchTerm}%`);
                }

                const from = (currentPage - 1) * pageSize;
                const to = from + pageSize - 1;
                query = query.range(from, to);

                const { data, error, count } = await query;

                if (error) throw error;

                totalRecords = count || 0;
                totalPages = Math.ceil(totalRecords / pageSize);
                currentData = data || [];

                displayLedger(currentData);
                updateStats();
                updatePagination();

            } catch (error) {
                showError('Error al cargar datos: ' + error.message);
                console.error('Error:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayLedger(data) {
            const tbody = document.getElementById('ledgerBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('ledgerTable').style.display = 'table';
            document.getElementById('emptyState').style.display = 'none';

            data.forEach(entry => {
                const row = document.createElement('tr');

                const date = new Date(entry.entry_date);
                const dateStr = date.toLocaleDateString('es-AR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const accountName = entry.accounting_chart_of_accounts
                    ? entry.accounting_chart_of_accounts.name
                    : '';

                const debit = entry.debit || 0;
                const credit = entry.credit || 0;

                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>
                        <div class="account-code">${entry.account_code}</div>
                        ${accountName ? `<div class="account-name">${accountName}</div>` : ''}
                    </td>
                    <td class="amount ${debit > 0 ? 'debit' : ''}">${debit > 0 ? formatCurrency(debit) : '-'}</td>
                    <td class="amount ${credit > 0 ? 'credit' : ''}">${credit > 0 ? formatCurrency(credit) : '-'}</td>
                    <td>${entry.description || '-'}</td>
                    <td>${entry.reference_type ? `<span class="badge badge-info">${entry.reference_type}</span>` : '-'}</td>
                    <td>${entry.fiscal_period || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStats() {
            const totalDebits = currentData.reduce((sum, e) => sum + (e.debit || 0), 0);
            const totalCredits = currentData.reduce((sum, e) => sum + (e.credit || 0), 0);

            document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
            document.getElementById('totalDebits').textContent = formatCurrency(totalDebits);
            document.getElementById('totalCredits').textContent = formatCurrency(totalCredits);
            document.getElementById('currentPage').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('stats').style.display = 'grid';
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const info = document.getElementById('paginationInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            info.textContent = `P√°gina ${currentPage} de ${totalPages} (${totalRecords} registros)`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadLedger();
            }
        }

        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('accountCode').value = '';
            document.getElementById('referenceType').value = '';
            document.getElementById('searchTerm').value = '';
            currentPage = 1;
            loadLedger();
        }

        function exportToCSV() {
            if (currentData.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            const headers = ['Fecha', 'Cuenta', 'Nombre Cuenta', 'D√©bito', 'Cr√©dito', 'Descripci√≥n', 'Tipo', 'Per√≠odo Fiscal'];
            const rows = currentData.map(entry => [
                new Date(entry.entry_date).toLocaleString('es-AR'),
                entry.account_code,
                entry.accounting_chart_of_accounts?.name || '',
                entry.debit || 0,
                entry.credit || 0,
                (entry.description || '').replace(/"/g, '""'),
                entry.reference_type || '',
                entry.fiscal_period || ''
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ledger-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000);
        }

        // Cargar configuraci√≥n desde localStorage si existe
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');

            if (savedUrl && savedKey) {
                document.getElementById('supabaseUrl').value = savedUrl;
                document.getElementById('supabaseKey').value = savedKey;
            }
        });

        // Guardar configuraci√≥n al conectar
        const originalConnect = connectSupabase;
        connectSupabase = function() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            localStorage.setItem('supabaseUrl', url);
            localStorage.setItem('supabaseKey', key);
            originalConnect();
        };
    </script>
</body>
</html>

