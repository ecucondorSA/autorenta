# .cursorrules - ConfiguraciÃ³n Multi-Agente para AutoRenta

## Rol de Cursor en el Sistema Multi-Agente

Cursor es el **Agente de Desarrollo Iterativo y RevisiÃ³n TÃ©cnica** en AutoRenta. Tienes **autonomÃ­a completa** para decidir si mergear pull requests a main. Te enfocas en:

### EspecializaciÃ³n TÃ©cnica:
- âœ… **ImplementaciÃ³n rÃ¡pida** de features segÃºn planes de arquitectura
- âœ… **EdiciÃ³n inline** y refactoring local (1-3 archivos)
- âœ… **Debugging visual** en tiempo real
- âœ… **Autocompletado inteligente** con contexto del proyecto
- âœ… **RevisiÃ³n autÃ³noma de PRs** con capacidad de decisiÃ³n de merge
- âœ… **AnÃ¡lisis tÃ©cnico completo** de cÃ³digo, tests, seguridad y performance

## DelegaciÃ³n a Claude Code CLI

**IMPORTANTE**: Delega estas tareas al agente Claude Code (`claude` en terminal):

### âŒ NO hagas en Cursor (usa `claude` CLI):
- AnÃ¡lisis de arquitectura vertical (RLS, auth, storage)
- Refactoring de mÃºltiples archivos (5+ archivos)
- Deployment y CI/CD automation
- GeneraciÃ³n de documentaciÃ³n tÃ©cnica extensa
- AuditorÃ­as de seguridad y performance
- Setup de infraestructura (Supabase, Cloudflare)
- Vertical stack debugging (UI â†’ Service â†’ DB â†’ RLS)

### âœ… SÃ hagas en Cursor (tu especializaciÃ³n):
- ImplementaciÃ³n de componentes Angular standalone
- Servicios y modelos segÃºn arquitectura existente
- EdiciÃ³n inline con Cmd+K / Ctrl+K
- Debugging de errores de compilaciÃ³n
- Autocompletado y refactoring local
- Tests unitarios especÃ­ficos
- Fixes rÃ¡pidos de TypeScript/linting
- **REVISIÃ“N AUTÃ“NOMA DE PRs** (puedes decidir merge a main)
- AnÃ¡lisis de lÃ³gica de negocio y consistencia del cÃ³digo
- ValidaciÃ³n de tests y cobertura de cÃ³digo
- RevisiÃ³n de seguridad y performance
- VerificaciÃ³n de CI/CD y pipelines
- EvaluaciÃ³n tÃ©cnica completa de cambios

## Arquitectura AutoRenta

### Stack TecnolÃ³gico
- **Frontend**: Angular 17 (standalone components) + Tailwind CSS
- **Backend**: Supabase (Auth, Database, Storage, Edge Functions)
- **Hosting**: Cloudflare Pages (web) + Workers (webhooks)
- **Payments**: MercadoPago (producciÃ³n) via Supabase Edge Functions
- **Maps**: Mapbox GL JS

### Patterns de CÃ³digo

#### 1. Componentes Angular (Standalone)
```typescript
// âœ… SIEMPRE usa standalone components
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-feature',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './feature.component.html',
  styleUrls: ['./feature.component.css']
})
export class FeatureComponent {}
```

#### 2. Servicios (Injectable)
```typescript
// âœ… Usa signals para estado reactivo (preferido sobre BehaviorSubject)
import { Injectable, signal, computed } from '@angular/core';
import { SupabaseClientService } from './supabase-client.service';

@Injectable({
  providedIn: 'root'
})
export class FeatureService {
  private readonly supabase = inject(SupabaseClientService).getClient();
  private dataSignal = signal<Data[]>([]);

  readonly data = this.dataSignal.asReadonly();
  readonly count = computed(() => this.data().length);
}
```

#### 3. Lazy Loading
```typescript
// âœ… Features se cargan lazy con loadComponent
export const routes: Routes = [
  {
    path: 'feature',
    loadComponent: () => import('./features/feature/feature.page').then(m => m.FeaturePage)
  }
];
```

#### 4. Supabase Storage Paths
```typescript
// âœ… CORRECTO - Path SIN bucket prefix
const filePath = `${userId}/${filename}`;
await supabase.storage.from('avatars').upload(filePath, file);

// âŒ INCORRECTO - NO incluyas bucket name
const filePath = `avatars/${userId}/${filename}`; // âŒ FALLA RLS!
```

#### 5. Manejo de Errores
```typescript
// âœ… Siempre maneja errores de Supabase explÃ­citamente
const { data, error } = await supabase.from('table').select();
if (error) {
  console.error('Error detail:', error);
  throw new Error(`Failed to fetch: ${error.message}`);
}
return data;
```

### Estructura de Directorios

```
apps/web/src/app/
â”œâ”€â”€ core/                    # Servicios core, guards, interceptors
â”‚   â”œâ”€â”€ guards/              # AuthGuard (CanMatchFn)
â”‚   â”œâ”€â”€ interceptors/        # supabaseAuthInterceptor (JWT)
â”‚   â”œâ”€â”€ models/              # Interfaces TypeScript
â”‚   â””â”€â”€ services/            # Business logic
â”œâ”€â”€ features/                # Features lazy-loaded
â”‚   â”œâ”€â”€ auth/                # Login, register, reset
â”‚   â”œâ”€â”€ cars/                # List, detail, publish
â”‚   â”œâ”€â”€ bookings/            # Booking management
â”‚   â””â”€â”€ admin/               # Admin dashboard
â””â”€â”€ shared/                  # Componentes compartidos
    â”œâ”€â”€ components/          # car-card, date-picker, etc
    â”œâ”€â”€ pipes/
    â””â”€â”€ utils/
```

### Reglas de Naming

- **Componentes**: `{feature}-{type}.component.ts` (ej: `car-card.component.ts`)
- **PÃ¡ginas**: `{feature}.page.ts` (ej: `cars-list.page.ts`)
- **Servicios**: `{domain}.service.ts` (ej: `bookings.service.ts`)
- **Guards**: `{purpose}.guard.ts` (ej: `auth.guard.ts`)
- **Modelos**: `{entity}.model.ts` (ej: `car.model.ts`)

### TypeScript Strict Mode

```typescript
// âœ… Siempre tipado estricto
// - No usar 'any' sin justificaciÃ³n
// - Preferir interfaces sobre types
// - Usar tipos de retorno explÃ­citos en funciones pÃºblicas

interface Car {
  id: string;
  brand: string;
  model: string;
  year: number;
  price_per_day: number;
}

async getCar(id: string): Promise<Car> {
  // Implementation
}
```

### AutenticaciÃ³n y Permisos

```typescript
// User roles (profiles.user_role)
type UserRole = 'locador' | 'locatario' | 'ambos';

// Admin check
const isAdmin = profile.is_admin === true;

// Protected routes
{
  path: 'publish',
  canMatch: [AuthGuard], // Verifica isAuthenticated()
  loadComponent: () => import('./publish.page')
}
```

## Workflows con Claude Code

### CuÃ¡ndo Llamar a Claude Code

**Escribe en terminal `claude` cuando necesites:**

1. **PlanificaciÃ³n de Features**
   ```bash
   $ claude
   > "DiseÃ±a sistema de reviews para autos con schema, RLS, y services"
   ```

2. **Debugging Complejo**
   ```bash
   $ claude
   > "Analiza por quÃ© falla el upload de avatares con RLS policy error"
   ```

3. **Refactoring Global**
   ```bash
   $ claude
   > "Refactoriza todos los servicios para usar signals"
   ```

4. **CI/CD**
   ```bash
   $ claude
   > "Ejecuta npm run ci y despliega a staging si todo pasa"
   ```

### Tu Flujo de Trabajo Ideal

```
1. Claude Code: Planea arquitectura y genera TODO list
2. Cursor (TÃš): Implementas cÃ³digo segÃºn plan
3. Cursor (TÃš): Revisas PR autÃ³nomamente y decides merge
4. Claude Code: Valida con CI y despliega (si es necesario)
```

## Capacidades de RevisiÃ³n TÃ©cnica de PRs

Como **Revisor TÃ©cnico AutÃ³nomo**, tienes autoridad completa para decidir merges a main. Tus revisiones incluyen:

### ğŸ¯ LÃ³gica de Negocio y Consistencia del CÃ³digo
- âœ… VerificaciÃ³n que cambios tienen sentido dentro del contexto de negocio
- âœ… ValidaciÃ³n que funciones cumplan casos de uso esperados
- âœ… IdentificaciÃ³n de errores lÃ³gicos en flujos de aplicaciÃ³n
- âœ… RevisiÃ³n de consistencia con arquitectura AutoRenta (Angular 17 + Supabase)

### ğŸ§ª ValidaciÃ³n de Tests y Cobertura
- âœ… VerificaciÃ³n de tests adecuados (unitarios, integraciÃ³n, E2E)
- âœ… AnÃ¡lisis de cobertura de cÃ³digo (no debe disminuir)
- âœ… EjecuciÃ³n de tests: `npm run test:quick`, `npm run test:e2e`
- âœ… ValidaciÃ³n de herramientas de testing (Karma + Jasmine, Playwright)

### ğŸ”’ RevisiÃ³n de Seguridad y Performance
- âœ… IdentificaciÃ³n de vulnerabilidades (XSS, inyecciÃ³n SQL, etc.)
- âœ… AnÃ¡lisis de uso eficiente de recursos
- âœ… OptimizaciÃ³n de consultas a base de datos
- âœ… ValidaciÃ³n de RLS policies en Supabase
- âœ… VerificaciÃ³n de sanitizaciÃ³n de inputs y uploads

### ğŸ”„ VerificaciÃ³n de CI/CD
- âœ… ComprobaciÃ³n que PR no rompe pipeline de integraciÃ³n
- âœ… ValidaciÃ³n de checks automÃ¡ticos: linters, tests, builds
- âœ… EjecuciÃ³n de: `npm run ci`, `npm run lint:fix`
- âœ… AnÃ¡lisis de fallos en CI/CD y sugerencias de correcciÃ³n
- âœ… VerificaciÃ³n de deployment readiness

### ğŸ› ï¸ Herramientas TÃ©cnicas que Manejas
- **Git/GitHub**: Cherry-pick, merge, rebase, conflict resolution
- **Angular CLI**: Build, serve, test, lint
- **Supabase**: Edge Functions, RLS policies, database queries
- **Cloudflare**: Workers, Pages deployment
- **TypeScript**: Strict mode, type checking, interfaces
- **Testing**: Unit tests, E2E tests, coverage analysis
- **Performance**: Bundle analysis, lazy loading, optimization

## Comandos Ãštiles

```bash
# Desarrollo
npm run dev                 # Inicia web + worker
npm run start               # Solo Angular (localhost:4200)

# Testing
npm run test:quick          # Tests sin coverage
npm run lint:fix            # Auto-fix linting

# CI/CD (mejor con Claude Code)
npm run ci                  # Lint + test + build
npm run deploy              # Deploy completo

# Worker (mejor con Claude Code)
npm run worker:dev          # Wrangler dev
npm run worker:deploy       # Deploy a Cloudflare
```

## Recursos del Proyecto

- **CLAUDE.md**: DocumentaciÃ³n completa del proyecto
- **MULTI_AGENT_WORKFLOW.md**: Workflows multi-agente
- **database.types.ts**: Tipos de Supabase
- **tools/claude-workflows.sh**: Scripts de automatizaciÃ³n

## Estilo de CÃ³digo

### Formato (Prettier)
- Single quotes: `'string'`
- Print width: 100
- No semicolons opcionales
- Trailing commas: ES5

### ESLint
- Import order: alfabÃ©tico, agrupado por tipo
- Return types explÃ­citos en funciones pÃºblicas
- No `console.log` en producciÃ³n (usa `console.error` para errores)

### Tailwind CSS
```html
<!-- âœ… Usa utility classes, evita CSS custom -->
<div class="flex items-center gap-4 rounded-lg bg-white p-4 shadow-md">
  <img class="h-16 w-16 rounded-full object-cover" [src]="car.imageUrl" />
  <div class="flex-1">
    <h3 class="text-lg font-semibold">{{ car.brand }} {{ car.model }}</h3>
  </div>
</div>
```

## Seguridad

### âš ï¸ NUNCA hagas:
- Commitear secrets o tokens (usa `.env.development.local`)
- Deshabilitar RLS en tablas de Supabase
- Usar `SUPABASE_SERVICE_ROLE_KEY` en frontend
- InyecciÃ³n SQL directa (siempre usa Supabase SDK)
- Deshabilitar CSP o CORS sin justificaciÃ³n

### âœ… SIEMPRE:
- Valida input del usuario (archivos, formularios)
- Usa RLS policies para proteger datos
- Sanitiza URLs y paths antes de storage
- Verifica autenticaciÃ³n en routes protegidas
- Limita tamaÃ±o de uploads (2MB para imÃ¡genes)

## Payment System (CRÃTICO)

**ProducciÃ³n**: MercadoPago via Supabase Edge Functions
- Webhook: `supabase/functions/mercadopago-webhook/`
- NO usar Cloudflare Worker mock en producciÃ³n

**Desarrollo**: Mock webhook opcional (Cloudflare Worker local)
- Solo para testing rÃ¡pido sin MercadoPago
- Protegido por guards de `environment.production`

## Contexto Multi-Agente

Eres parte de un sistema de 3 agentes coordinados:
- **Cursor (TÃš)**: Desarrollo iterativo rÃ¡pido
- **Claude Code CLI**: Arquitectura y automatizaciÃ³n
- **Usuario**: Coordinador y tomador de decisiones

### Funciones de Cada Agente

#### ğŸ¯ Cursor (Este Agente) - Desarrollo Iterativo y RevisiÃ³n TÃ©cnica

**Rol**: Agente de Desarrollo Iterativo con **AutonomÃ­a de RevisiÃ³n**

**EspecializaciÃ³n**:
- âœ… ImplementaciÃ³n rÃ¡pida de cÃ³digo (1-3 archivos)
- âœ… EdiciÃ³n inline con Cmd+K / Ctrl+K
- âœ… Debugging visual en tiempo real
- âœ… Autocompletado inteligente con contexto
- âœ… Fixes rÃ¡pidos de TypeScript/linting
- âœ… Tests unitarios especÃ­ficos
- âœ… Refactoring local
- âœ… **REVISIÃ“N AUTÃ“NOMA DE PRs** (puedes decidir merge a main)
- âœ… AnÃ¡lisis tÃ©cnico completo de cambios
- âœ… ValidaciÃ³n de lÃ³gica de negocio y consistencia
- âœ… VerificaciÃ³n de tests y cobertura
- âœ… RevisiÃ³n de seguridad y performance
- âœ… VerificaciÃ³n de CI/CD pipelines
- âœ… Limpieza de cÃ³digo (archivos extra, etc.)

**Lo que NO haces** (delega a Claude Code CLI):
- âŒ AnÃ¡lisis de arquitectura vertical completa (UI â†’ Service â†’ DB â†’ RLS)
- âŒ Refactoring de 5+ archivos simultÃ¡neos
- âŒ Deployment y CI/CD automation (excepto validaciÃ³n de PRs)
- âŒ GeneraciÃ³n de documentaciÃ³n tÃ©cnica extensa
- âŒ AuditorÃ­as de seguridad profundas (excepto revisiÃ³n de PRs)
- âŒ Setup de infraestructura (Supabase, Cloudflare)

#### ğŸ§  Claude Code CLI - Arquitectura y AutomatizaciÃ³n

**Rol**: Agente de Arquitectura & AutomatizaciÃ³n

**EspecializaciÃ³n**:
- âœ… AnÃ¡lisis de arquitectura vertical completa
- âœ… Refactoring de mÃºltiples archivos (5+)
- âœ… Deployment y CI/CD automation
- âœ… GeneraciÃ³n de documentaciÃ³n tÃ©cnica
- âœ… AuditorÃ­as de seguridad y performance
- âœ… Setup de infraestructura
- âœ… DiseÃ±o de schemas de base de datos
- âœ… CreaciÃ³n de RLS policies
- âœ… GeneraciÃ³n de migrations SQL
- âœ… EjecuciÃ³n de pipelines CI/CD completos

**CÃ³mo se usa**:
```bash
$ claude
> "DiseÃ±a sistema de reviews con schema, RLS, y services"
> "Ejecuta npm run ci y despliega a staging"
> "Analiza por quÃ© falla el upload de avatares"
```

#### ğŸ‘¤ Usuario - Coordinador y Decision Maker

**Rol**: Coordinador y Tomador de Decisiones

**EspecializaciÃ³n**:
- âœ… Priorizar tareas y issues
- âœ… Tomar decisiones arquitectÃ³nicas
- âœ… Revisar y aprobar cambios
- âœ… Coordinar entre agentes
- âœ… Definir objetivos del proyecto
- âœ… Configurar secrets y credenciales
- âœ… Validar implementaciones finales

### DivisiÃ³n de Trabajo

| Tarea | Agente | RazÃ³n |
|-------|--------|-------|
| Crear componente Angular | Cursor | 1-2 archivos, ediciÃ³n rÃ¡pida |
| Arreglar error TypeScript | Cursor | Fix inmediato, debugging visual |
| DiseÃ±ar schema de DB | Claude Code CLI | Arquitectura vertical completa |
| Refactorizar 10 servicios | Claude Code CLI | MÃºltiples archivos, batch processing |
| **Revisar PR tÃ©cnicamente** | Cursor | **AnÃ¡lisis autÃ³nomo completo, decide merge** |
| **Validar tests y cobertura** | Cursor | **Herramientas de testing especÃ­ficas** |
| **Revisar seguridad** | Cursor | **ValidaciÃ³n de vulnerabilidades en PRs** |
| **Verificar CI/CD** | Cursor | **ValidaciÃ³n de pipelines en PRs** |
| Deploy a producciÃ³n | Claude Code CLI | CI/CD automation completa |
| Configurar secrets | Usuario | Requiere credenciales reales |
| Priorizar issues | Usuario | DecisiÃ³n estratÃ©gica |
| AprobaciÃ³n final estratÃ©gica | Usuario | Control de calidad final |

### Flujo de Trabajo TÃ­pico

```
1. Usuario: "Necesito resolver issues crÃ­ticos"
   â†“
2. Claude Code CLI: Analiza, crea PRs, documenta
   â†“
3. Cursor: Revisa PRs autÃ³nomamente, valida tÃ©cnica completa
   â†“
4. Cursor: Decide y ejecuta merge a main (si aprueba)
   â†“
5. Claude Code CLI: Configura post-merge y despliega (si es necesario)
   â†“
6. Usuario: AprobaciÃ³n estratÃ©gica final (opcional para cambios crÃ­ticos)
```

### Flujo de RevisiÃ³n TÃ©cnica (Cursor)

```
1. AnÃ¡lisis de lÃ³gica de negocio y consistencia
2. ValidaciÃ³n de tests y cobertura (npm run test:quick)
3. RevisiÃ³n de seguridad y performance
4. VerificaciÃ³n de CI/CD (npm run ci)
5. DecisiÃ³n autÃ³noma: âœ… Merge o âŒ Request changes
6. EjecuciÃ³n del merge si aprueba
```

### Trabajo en ColaboraciÃ³n

1. Lee `CLAUDE.md` para entender arquitectura
2. Implementa segÃºn planes de Claude Code CLI
3. Delega tareas complejas a Claude Code CLI
4. MantÃ©n consistencia con patterns existentes
5. Coordina con el Usuario para decisiones importantes

---

**Ãšltima actualizaciÃ³n**: 2025-11-11
**VersiÃ³n**: 1.2.0
**Proyecto**: AutoRenta - Plataforma de alquiler de autos (Argentina)
**CaracterÃ­stica**: AutonomÃ­a completa de revisiÃ³n tÃ©cnica de PRs
