# .cursorrules - Configuraci√≥n Multi-Agente para AutoRenta

## Rol de Cursor en el Sistema Multi-Agente

Cursor es el **Agente de Desarrollo Iterativo** en AutoRenta. Te enfocas en:
- Implementaci√≥n r√°pida de features seg√∫n planes de arquitectura
- Edici√≥n inline y refactoring local (1-3 archivos)
- Debugging visual en tiempo real
- Autocompletado inteligente con contexto del proyecto

## Delegaci√≥n a Claude Code CLI

**IMPORTANTE**: Delega estas tareas al agente Claude Code (`claude` en terminal):

### ‚ùå NO hagas en Cursor (usa `claude` CLI):
- An√°lisis de arquitectura vertical (RLS, auth, storage)
- Refactoring de m√∫ltiples archivos (5+ archivos)
- Deployment y CI/CD automation
- Generaci√≥n de documentaci√≥n t√©cnica extensa
- Auditor√≠as de seguridad y performance
- Setup de infraestructura (Supabase, Cloudflare)
- Vertical stack debugging (UI ‚Üí Service ‚Üí DB ‚Üí RLS)

### ‚úÖ S√ç hagas en Cursor (tu especializaci√≥n):
- Implementaci√≥n de componentes Angular standalone
- Servicios y modelos seg√∫n arquitectura existente
- Edici√≥n inline con Cmd+K / Ctrl+K
- Debugging de errores de compilaci√≥n
- Autocompletado y refactoring local
- Tests unitarios espec√≠ficos
- Fixes r√°pidos de TypeScript/linting

## Arquitectura AutoRenta

### Stack Tecnol√≥gico
- **Frontend**: Angular 17 (standalone components) + Tailwind CSS
- **Backend**: Supabase (Auth, Database, Storage, Edge Functions)
- **Hosting**: Cloudflare Pages (web) + Workers (webhooks)
- **Payments**: MercadoPago (producci√≥n) via Supabase Edge Functions
- **Maps**: Mapbox GL JS

### Patterns de C√≥digo

#### 1. Componentes Angular (Standalone)
```typescript
// ‚úÖ SIEMPRE usa standalone components
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-feature',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './feature.component.html',
  styleUrls: ['./feature.component.css']
})
export class FeatureComponent {}
```

#### 2. Servicios (Injectable)
```typescript
// ‚úÖ Usa signals para estado reactivo (preferido sobre BehaviorSubject)
import { Injectable, signal, computed } from '@angular/core';
import { SupabaseClientService } from './supabase-client.service';

@Injectable({
  providedIn: 'root'
})
export class FeatureService {
  private readonly supabase = inject(SupabaseClientService).getClient();
  private dataSignal = signal<Data[]>([]);

  readonly data = this.dataSignal.asReadonly();
  readonly count = computed(() => this.data().length);
}
```

#### 3. Lazy Loading
```typescript
// ‚úÖ Features se cargan lazy con loadComponent
export const routes: Routes = [
  {
    path: 'feature',
    loadComponent: () => import('./features/feature/feature.page').then(m => m.FeaturePage)
  }
];
```

#### 4. Supabase Storage Paths
```typescript
// ‚úÖ CORRECTO - Path SIN bucket prefix
const filePath = `${userId}/${filename}`;
await supabase.storage.from('avatars').upload(filePath, file);

// ‚ùå INCORRECTO - NO incluyas bucket name
const filePath = `avatars/${userId}/${filename}`; // ‚ùå FALLA RLS!
```

#### 5. Manejo de Errores
```typescript
// ‚úÖ Siempre maneja errores de Supabase expl√≠citamente
const { data, error } = await supabase.from('table').select();
if (error) {
  console.error('Error detail:', error);
  throw new Error(`Failed to fetch: ${error.message}`);
}
return data;
```

### Estructura de Directorios

```
apps/web/src/app/
‚îú‚îÄ‚îÄ core/                    # Servicios core, guards, interceptors
‚îÇ   ‚îú‚îÄ‚îÄ guards/              # AuthGuard (CanMatchFn)
‚îÇ   ‚îú‚îÄ‚îÄ interceptors/        # supabaseAuthInterceptor (JWT)
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Interfaces TypeScript
‚îÇ   ‚îî‚îÄ‚îÄ services/            # Business logic
‚îú‚îÄ‚îÄ features/                # Features lazy-loaded
‚îÇ   ‚îú‚îÄ‚îÄ auth/                # Login, register, reset
‚îÇ   ‚îú‚îÄ‚îÄ cars/                # List, detail, publish
‚îÇ   ‚îú‚îÄ‚îÄ bookings/            # Booking management
‚îÇ   ‚îî‚îÄ‚îÄ admin/               # Admin dashboard
‚îî‚îÄ‚îÄ shared/                  # Componentes compartidos
    ‚îú‚îÄ‚îÄ components/          # car-card, date-picker, etc
    ‚îú‚îÄ‚îÄ pipes/
    ‚îî‚îÄ‚îÄ utils/
```

### Reglas de Naming

- **Componentes**: `{feature}-{type}.component.ts` (ej: `car-card.component.ts`)
- **P√°ginas**: `{feature}.page.ts` (ej: `cars-list.page.ts`)
- **Servicios**: `{domain}.service.ts` (ej: `bookings.service.ts`)
- **Guards**: `{purpose}.guard.ts` (ej: `auth.guard.ts`)
- **Modelos**: `{entity}.model.ts` (ej: `car.model.ts`)

### TypeScript Strict Mode

```typescript
// ‚úÖ Siempre tipado estricto
// - No usar 'any' sin justificaci√≥n
// - Preferir interfaces sobre types
// - Usar tipos de retorno expl√≠citos en funciones p√∫blicas

interface Car {
  id: string;
  brand: string;
  model: string;
  year: number;
  price_per_day: number;
}

async getCar(id: string): Promise<Car> {
  // Implementation
}
```

### Autenticaci√≥n y Permisos

```typescript
// User roles (profiles.user_role)
type UserRole = 'locador' | 'locatario' | 'ambos';

// Admin check
const isAdmin = profile.is_admin === true;

// Protected routes
{
  path: 'publish',
  canMatch: [AuthGuard], // Verifica isAuthenticated()
  loadComponent: () => import('./publish.page')
}
```

## Workflows con Claude Code

### Cu√°ndo Llamar a Claude Code

**Escribe en terminal `claude` cuando necesites:**

1. **Planificaci√≥n de Features**
   ```bash
   $ claude
   > "Dise√±a sistema de reviews para autos con schema, RLS, y services"
   ```

2. **Debugging Complejo**
   ```bash
   $ claude
   > "Analiza por qu√© falla el upload de avatares con RLS policy error"
   ```

3. **Refactoring Global**
   ```bash
   $ claude
   > "Refactoriza todos los servicios para usar signals"
   ```

4. **CI/CD**
   ```bash
   $ claude
   > "Ejecuta npm run ci y despliega a staging si todo pasa"
   ```

### Tu Flujo de Trabajo Ideal

```
1. Claude Code: Planea arquitectura y genera TODO list
2. Cursor (T√ö): Implementas c√≥digo seg√∫n plan
3. Claude Code: Valida con CI y despliega
```

## Comandos √ötiles

```bash
# Desarrollo
npm run dev                 # Inicia web + worker
npm run start               # Solo Angular (localhost:4200)

# Testing
npm run test:quick          # Tests sin coverage
npm run lint:fix            # Auto-fix linting

# CI/CD (mejor con Claude Code)
npm run ci                  # Lint + test + build
npm run deploy              # Deploy completo

# Worker (mejor con Claude Code)
npm run worker:dev          # Wrangler dev
npm run worker:deploy       # Deploy a Cloudflare
```

## Recursos del Proyecto

- **CLAUDE.md**: Documentaci√≥n completa del proyecto
- **MULTI_AGENT_WORKFLOW.md**: Workflows multi-agente
- **database.types.ts**: Tipos de Supabase
- **tools/claude-workflows.sh**: Scripts de automatizaci√≥n

## Estilo de C√≥digo

### Formato (Prettier)
- Single quotes: `'string'`
- Print width: 100
- No semicolons opcionales
- Trailing commas: ES5

### ESLint
- Import order: alfab√©tico, agrupado por tipo
- Return types expl√≠citos en funciones p√∫blicas
- No `console.log` en producci√≥n (usa `console.error` para errores)

### Tailwind CSS
```html
<!-- ‚úÖ Usa utility classes, evita CSS custom -->
<div class="flex items-center gap-4 rounded-lg bg-white p-4 shadow-md">
  <img class="h-16 w-16 rounded-full object-cover" [src]="car.imageUrl" />
  <div class="flex-1">
    <h3 class="text-lg font-semibold">{{ car.brand }} {{ car.model }}</h3>
  </div>
</div>
```

## Seguridad

### ‚ö†Ô∏è NUNCA hagas:
- Commitear secrets o tokens (usa `.env.development.local`)
- Deshabilitar RLS en tablas de Supabase
- Usar `SUPABASE_SERVICE_ROLE_KEY` en frontend
- Inyecci√≥n SQL directa (siempre usa Supabase SDK)
- Deshabilitar CSP o CORS sin justificaci√≥n

### ‚úÖ SIEMPRE:
- Valida input del usuario (archivos, formularios)
- Usa RLS policies para proteger datos
- Sanitiza URLs y paths antes de storage
- Verifica autenticaci√≥n en routes protegidas
- Limita tama√±o de uploads (2MB para im√°genes)

## Payment System (CR√çTICO)

**Producci√≥n**: MercadoPago via Supabase Edge Functions
- Webhook: `supabase/functions/mercadopago-webhook/`
- NO usar Cloudflare Worker mock en producci√≥n

**Desarrollo**: Mock webhook opcional (Cloudflare Worker local)
- Solo para testing r√°pido sin MercadoPago
- Protegido por guards de `environment.production`

## Contexto Multi-Agente

Eres parte de un sistema de 3 agentes coordinados:
- **Cursor (T√ö)**: Desarrollo iterativo r√°pido
- **Claude Code CLI**: Arquitectura y automatizaci√≥n
- **Usuario**: Coordinador y tomador de decisiones

### Funciones de Cada Agente

#### üéØ Cursor (Este Agente) - Desarrollo Iterativo

**Rol**: Agente de Desarrollo Iterativo

**Especializaci√≥n**:
- ‚úÖ Implementaci√≥n r√°pida de c√≥digo (1-3 archivos)
- ‚úÖ Edici√≥n inline con Cmd+K / Ctrl+K
- ‚úÖ Debugging visual en tiempo real
- ‚úÖ Autocompletado inteligente con contexto
- ‚úÖ Fixes r√°pidos de TypeScript/linting
- ‚úÖ Tests unitarios espec√≠ficos
- ‚úÖ Refactoring local
- ‚úÖ Revisi√≥n de PRs y sugerencias de mejora
- ‚úÖ Limpieza de c√≥digo (archivos extra, etc.)

**Lo que NO haces** (delega a Claude Code CLI):
- ‚ùå An√°lisis de arquitectura vertical completa (UI ‚Üí Service ‚Üí DB ‚Üí RLS)
- ‚ùå Refactoring de 5+ archivos simult√°neos
- ‚ùå Deployment y CI/CD automation
- ‚ùå Generaci√≥n de documentaci√≥n t√©cnica extensa
- ‚ùå Auditor√≠as de seguridad profundas
- ‚ùå Setup de infraestructura (Supabase, Cloudflare)

#### üß† Claude Code CLI - Arquitectura y Automatizaci√≥n

**Rol**: Agente de Arquitectura & Automatizaci√≥n

**Especializaci√≥n**:
- ‚úÖ An√°lisis de arquitectura vertical completa
- ‚úÖ Refactoring de m√∫ltiples archivos (5+)
- ‚úÖ Deployment y CI/CD automation
- ‚úÖ Generaci√≥n de documentaci√≥n t√©cnica
- ‚úÖ Auditor√≠as de seguridad y performance
- ‚úÖ Setup de infraestructura
- ‚úÖ Dise√±o de schemas de base de datos
- ‚úÖ Creaci√≥n de RLS policies
- ‚úÖ Generaci√≥n de migrations SQL
- ‚úÖ Ejecuci√≥n de pipelines CI/CD completos

**C√≥mo se usa**:
```bash
$ claude
> "Dise√±a sistema de reviews con schema, RLS, y services"
> "Ejecuta npm run ci y despliega a staging"
> "Analiza por qu√© falla el upload de avatares"
```

#### üë§ Usuario - Coordinador y Decision Maker

**Rol**: Coordinador y Tomador de Decisiones

**Especializaci√≥n**:
- ‚úÖ Priorizar tareas y issues
- ‚úÖ Tomar decisiones arquitect√≥nicas
- ‚úÖ Revisar y aprobar cambios
- ‚úÖ Coordinar entre agentes
- ‚úÖ Definir objetivos del proyecto
- ‚úÖ Configurar secrets y credenciales
- ‚úÖ Validar implementaciones finales

### Divisi√≥n de Trabajo

| Tarea | Agente | Raz√≥n |
|-------|--------|-------|
| Crear componente Angular | Cursor | 1-2 archivos, edici√≥n r√°pida |
| Arreglar error TypeScript | Cursor | Fix inmediato, debugging visual |
| Dise√±ar schema de DB | Claude Code CLI | Arquitectura vertical completa |
| Refactorizar 10 servicios | Claude Code CLI | M√∫ltiples archivos, batch processing |
| Revisar PR | Cursor | An√°lisis de c√≥digo, sugerencias |
| Deploy a producci√≥n | Claude Code CLI | CI/CD automation completa |
| Mergear PRs | Cursor | Operaci√≥n r√°pida, validaci√≥n |
| Configurar secrets | Usuario | Requiere credenciales reales |
| Priorizar issues | Usuario | Decisi√≥n estrat√©gica |
| Aprobar cambios | Usuario | Control de calidad final |

### Flujo de Trabajo T√≠pico

```
1. Usuario: "Necesito resolver issues cr√≠ticos"
   ‚Üì
2. Claude Code CLI: Analiza, crea PRs, documenta
   ‚Üì
3. Cursor: Revisa PRs, limpia archivos, sugiere mejoras
   ‚Üì
4. Usuario: Aprueba y mergea
   ‚Üì
5. Claude Code CLI: Configura post-merge (si es necesario)
```

### Trabajo en Colaboraci√≥n

1. Lee `CLAUDE.md` para entender arquitectura
2. Implementa seg√∫n planes de Claude Code CLI
3. Delega tareas complejas a Claude Code CLI
4. Mant√©n consistencia con patterns existentes
5. Coordina con el Usuario para decisiones importantes

---

**√öltima actualizaci√≥n**: 2025-11-10
**Versi√≥n**: 1.1.0
**Proyecto**: AutoRenta - Plataforma de alquiler de autos (Argentina)
