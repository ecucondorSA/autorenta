# üîí Plan de Validaciones para Sistema de Wallet

**Fecha**: 2025-10-20 19:10 UTC
**Status**: An√°lisis Completo - Listo para Implementar

---

## üìä AN√ÅLISIS DEL SISTEMA ACTUAL

### Capas del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CAPA 1: Frontend (Angular)             ‚îÇ
‚îÇ  - wallet.service.ts                    ‚îÇ
‚îÇ  - wallet.page.ts                       ‚îÇ
‚îÇ  - Validaciones b√°sicas (monto >0, <5k) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CAPA 2: Edge Functions (Supabase)      ‚îÇ
‚îÇ  - mercadopago-create-preference         ‚îÇ
‚îÇ  - mercadopago-webhook                   ‚îÇ
‚îÇ  - mercadopago-poll-pending-payments     ‚îÇ
‚îÇ  ‚ö†Ô∏è POCAS VALIDACIONES                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CAPA 3: RPC Functions (PostgreSQL)     ‚îÇ
‚îÇ  - wallet_initiate_deposit               ‚îÇ
‚îÇ  - wallet_confirm_deposit                ‚îÇ
‚îÇ  - wallet_lock_funds                     ‚îÇ
‚îÇ  - wallet_unlock_funds                   ‚îÇ
‚îÇ  ‚ö†Ô∏è VALIDACIONES B√ÅSICAS                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CAPA 4: Database (RLS + Constraints)   ‚îÇ
‚îÇ  - RLS policies                          ‚îÇ
‚îÇ  - Foreign keys                          ‚îÇ
‚îÇ  - Check constraints                     ‚îÇ
‚îÇ  ‚úÖ BIEN PROTEGIDA                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚ö†Ô∏è PROBLEMAS IDENTIFICADOS

### 1. **Frontend (wallet.service.ts)** ‚úÖ BIEN

**Validaciones Existentes**:
- ‚úÖ Monto > 0 (l√≠nea 201)
- ‚úÖ Monto m√≠nimo $10 (l√≠nea 205)
- ‚úÖ Monto m√°ximo $5,000 (l√≠nea 209)
- ‚úÖ Verificar fondos suficientes antes de bloquear (l√≠nea 420)
- ‚úÖ Validar booking_id (l√≠nea 416, 484)

**Lo que falta**:
- ‚ùå Validar formato de montos (evitar decimales con >2 posiciones)
- ‚ùå Validar que transaction_id sea UUID v√°lido
- ‚ùå Rate limiting del lado del cliente (evitar doble-click)
- ‚ùå Validar balance negativo

### 2. **Edge Functions** ‚ö†Ô∏è MEJORABLE

#### `mercadopago-create-preference/index.ts`

**Validaciones Existentes**:
- ‚úÖ Verificar variables de entorno (l√≠nea 46-67)
- ‚úÖ Validar m√©todo HTTP POST (l√≠nea 71-78)
- ‚úÖ Validar campos requeridos (l√≠nea 85-92)
- ‚úÖ Verificar autorizaci√≥n (l√≠nea 96-104)
- ‚úÖ Verificar transacci√≥n existe y est√° pending (l√≠nea 111-126)

**Lo que falta**:
- ‚ùå **Validar monto contra l√≠mites** (min $10, max $5,000)
- ‚ùå **Validar que transaction pertenece al usuario** (actualmente solo verifica existencia)
- ‚ùå **Prevenir doble-creaci√≥n de preference** (idempotencia)
- ‚ùå **Validar que transaction_id sea UUID v√°lido**
- ‚ùå **Timeout de transacciones** (rechazar pending >30 d√≠as)
- ‚ùå **Rate limiting** (max 5 dep√≥sitos por hora)

#### `mercadopago-webhook/index.ts`

**Validaciones Existentes**:
- ‚úÖ Verificar variables de entorno (l√≠nea 66-76)
- ‚úÖ Validar m√©todo HTTP POST (l√≠nea 79-86)
- ‚úÖ Validar tipo de webhook (l√≠nea 95-103)
- ‚úÖ Verificar pago approved (l√≠nea 197-209)
- ‚úÖ Verificar transacci√≥n existe (l√≠nea 224-233)
- ‚úÖ Idempotencia: ignorar si ya completed (l√≠nea 237-245)

**Lo que falta**:
- ‚ùå **Validar firma del webhook** (HMAC signature de MercadoPago)
- ‚ùå **Validar que payment_id sea string num√©rico v√°lido**
- ‚ùå **Validar que external_reference sea UUID**
- ‚ùå **Verificar que monto del pago coincida con transacci√≥n**
- ‚ùå **Rate limiting de webhooks** (max 100/min)
- ‚ùå **Log de webhooks duplicados** (para auditor√≠a)

### 3. **RPC Functions** ‚ö†Ô∏è CR√çTICO - FALTAN VALIDACIONES

#### `wallet_initiate_deposit`

**¬øQu√© hace?**:
Crea transacci√≥n pending en DB para dep√≥sito.

**Validaciones que DEBE tener**:
- ‚úÖ Usuario autenticado (auth.uid())
- ‚ùå **Validar monto > 0**
- ‚ùå **Validar monto dentro de l√≠mites** ($10-$5,000)
- ‚ùå **Validar provider v√°lido** ('mercadopago', 'stripe', etc.)
- ‚ùå **Rate limiting** (max 5 dep√≥sitos pending por usuario)
- ‚ùå **Validar que no haya >10 transacciones pending**
- ‚ùå **Validar descripci√≥n** (max 200 chars, no SQL injection)

#### `wallet_confirm_deposit` / `wallet_confirm_deposit_admin`

**¬øQu√© hace?**:
Confirma dep√≥sito y acredita fondos al wallet.

**Validaciones que DEBE tener**:
- ‚úÖ Usuario autenticado (auth.uid())
- ‚ùå **Validar que transaction est√© pending** (no completed/failed)
- ‚ùå **Validar que transaction pertenezca al usuario** (p_user_id)
- ‚ùå **Validar que provider_transaction_id no est√© usado** (evitar duplicados)
- ‚ùå **Validar monto del payment coincida con transacci√≥n**
- ‚ùå **Validar que transaction no sea vieja** (<30 d√≠as)
- ‚ùå **Atomic operation** (BEGIN/COMMIT expl√≠cito)

#### `wallet_lock_funds`

**¬øQu√© hace?**:
Bloquea fondos del wallet del usuario para booking.

**Validaciones que DEBE tener**:
- ‚úÖ Usuario autenticado
- ‚ùå **Validar monto > 0**
- ‚ùå **Verificar fondos disponibles >= monto** (BEFORE locking)
- ‚ùå **Validar booking existe y pertenece al usuario**
- ‚ùå **Validar booking en estado v√°lido** (no cancelled/completed)
- ‚ùå **Prevenir doble-bloqueo** (verificar si ya hay lock para booking)
- ‚ùå **Atomic operation**

#### `wallet_unlock_funds`

**¬øQu√© hace?**:
Desbloquea fondos previamente bloqueados.

**Validaciones que DEBE tener**:
- ‚úÖ Usuario autenticado
- ‚ùå **Validar booking existe**
- ‚ùå **Verificar que hay fondos bloqueados** (locked_balance > 0)
- ‚ùå **Validar que booking pertenece al usuario o es owner**
- ‚ùå **Verificar estado del booking** (puede ser cancelled/completed)
- ‚ùå **Prevenir doble-unlock**
- ‚ùå **Atomic operation**

---

## üéØ PRIORIZACI√ìN DE VALIDACIONES

### CR√çTICO (Seguridad y Dinero) üî¥

**Implementar INMEDIATAMENTE**:

1. **`wallet_confirm_deposit_admin`**: Validar provider_transaction_id √∫nico
   - **Riesgo**: Usuario podr√≠a duplicar acreditaci√≥n
   - **Impacto**: P√©rdida de dinero real

2. **`wallet_lock_funds`**: Verificar fondos disponibles ANTES de bloquear
   - **Riesgo**: Balance negativo
   - **Impacto**: Inconsistencia financiera

3. **Edge Functions**: Validar que transaction pertenece al usuario
   - **Riesgo**: Usuario A podr√≠a usar transaction_id de usuario B
   - **Impacto**: Robo de fondos

4. **Webhook**: Validar firma HMAC de MercadoPago
   - **Riesgo**: Webhooks falsos podr√≠an acreditar fondos
   - **Impacto**: Fraude masivo

5. **RPC Functions**: Atomic operations (BEGIN/COMMIT)
   - **Riesgo**: Race conditions en transacciones
   - **Impacto**: Balance inconsistente

### ALTO (Integridad de Datos) üü†

6. **Validar montos dentro de l√≠mites** ($10-$5,000)
   - Frontend ‚úÖ
   - Edge Functions ‚ùå
   - RPC Functions ‚ùå

7. **Validar formato de UUIDs**
   - transaction_id, booking_id, user_id

8. **Prevenir doble-creaci√≥n de preferences**
   - Idempotencia en create-preference

9. **Validar que payment amount == transaction amount**
   - En webhook al confirmar

10. **Timeout de transacciones pending** (>30 d√≠as)
    - Limpiar autom√°ticamente o rechazar

### MEDIO (UX y Performance) üü°

11. **Rate limiting**
    - Frontend: Prevenir doble-click
    - Edge Functions: Max 5 dep√≥sitos/hora, 100 webhooks/min
    - RPC: Max 5 pending por usuario

12. **Validar descripciones** (max 200 chars, sanitizar)

13. **Log de eventos importantes** (auditor√≠a)

14. **Normalizar montos** (redondear a 2 decimales)

---

## üîß PLAN DE IMPLEMENTACI√ìN

### Fase 1: CR√çTICO (Esta sesi√≥n) üî¥

**Archivos a modificar**:
1. `/supabase/functions/mercadopago-webhook/index.ts`
   - Agregar validaci√≥n de firma HMAC
   - Validar payment amount vs transaction amount

2. Crear nueva migration: `20251020_add_wallet_validations.sql`
   - Agregar validaciones a RPC functions
   - Agregar unique constraint en provider_transaction_id
   - Agregar check constraints para montos

3. `/supabase/functions/mercadopago-create-preference/index.ts`
   - Validar ownership de transaction
   - Validar montos contra l√≠mites

**Tiempo estimado**: 1-2 horas

### Fase 2: ALTO (Pr√≥xima sesi√≥n) üü†

**Archivos a modificar**:
1. RPC functions - agregar todas las validaciones de integridad
2. Edge Functions - agregar rate limiting
3. Frontend - mejorar validaciones de formato

**Tiempo estimado**: 2-3 horas

### Fase 3: MEDIO (Mejoras continuas) üü°

**Archivos a modificar**:
1. Logging y auditor√≠a
2. Cleanup autom√°tico de transacciones viejas
3. Dashboard de monitoreo

**Tiempo estimado**: 2-4 horas

---

## üìã CHECKLIST DE VALIDACIONES

### Frontend (`wallet.service.ts`)

- [x] Monto > 0
- [x] Monto m√≠nimo $10
- [x] Monto m√°ximo $5,000
- [x] Verificar fondos antes de lock
- [x] Validar booking_id presente
- [ ] Validar formato de montos (2 decimales)
- [ ] Prevenir doble-click (debounce)
- [ ] Validar UUID format

### Edge Function: `mercadopago-create-preference`

- [x] Verificar env vars
- [x] Validar m√©todo HTTP
- [x] Validar campos requeridos
- [x] Verificar autorizaci√≥n
- [x] Verificar transacci√≥n existe
- [ ] **Validar ownership de transaction**
- [ ] **Validar montos contra l√≠mites**
- [ ] **Idempotencia (evitar doble-preference)**
- [ ] **Validar UUID format**
- [ ] **Timeout de transacciones viejas**

### Edge Function: `mercadopago-webhook`

- [x] Verificar env vars
- [x] Validar m√©todo HTTP
- [x] Validar tipo webhook
- [x] Verificar pago approved
- [x] Verificar transacci√≥n existe
- [x] Idempotencia (ignorar completed)
- [ ] **Validar firma HMAC**
- [ ] **Validar payment_id format**
- [ ] **Validar external_reference UUID**
- [ ] **Verificar payment amount == transaction amount**
- [ ] **Rate limiting (100/min)**
- [ ] **Log webhooks duplicados**

### RPC: `wallet_initiate_deposit`

- [x] Usuario autenticado
- [ ] **Validar monto > 0**
- [ ] **Validar monto dentro l√≠mites**
- [ ] **Validar provider v√°lido**
- [ ] **Rate limiting (max 5 pending)**
- [ ] **Validar descripci√≥n (max 200 chars)**

### RPC: `wallet_confirm_deposit_admin`

- [x] Usuario autenticado
- [ ] **Validar transaction pending**
- [ ] **Validar ownership**
- [ ] **Validar provider_transaction_id √∫nico**
- [ ] **Validar payment amount == transaction amount**
- [ ] **Validar transaction no vieja**
- [ ] **Atomic operation (BEGIN/COMMIT)**

### RPC: `wallet_lock_funds`

- [x] Usuario autenticado
- [ ] **Validar monto > 0**
- [ ] **Verificar fondos disponibles >= monto**
- [ ] **Validar booking existe y pertenece**
- [ ] **Validar booking estado v√°lido**
- [ ] **Prevenir doble-bloqueo**
- [ ] **Atomic operation**

### RPC: `wallet_unlock_funds`

- [x] Usuario autenticado
- [ ] **Validar booking existe**
- [ ] **Verificar locked_balance > 0**
- [ ] **Validar ownership de booking**
- [ ] **Verificar estado booking**
- [ ] **Prevenir doble-unlock**
- [ ] **Atomic operation**

---

## üö® VULNERABILIDADES ACTUALES

### 1. **Falta validaci√≥n de ownership** (CR√çTICO)

**Escenario de ataque**:
```
1. Usuario A crea dep√≥sito ‚Üí transaction_id: "abc-123"
2. Usuario B (malicioso) llama a create-preference con transaction_id: "abc-123"
3. Usuario B obtiene init_point del dep√≥sito de Usuario A
4. Usuario B paga y se acredita en cuenta de Usuario A
```

**Fix**: Validar que `transaction.user_id == auth.uid()`

### 2. **Falta validaci√≥n de firma en webhook** (CR√çTICO)

**Escenario de ataque**:
```
1. Atacante descubre URL del webhook
2. Env√≠a POST con payload falso: { data: { id: "fake-payment-123" } }
3. Webhook intenta confirmar dep√≥sito inexistente
4. Puede causar errores o acreeditar fondos si hay race condition
```

**Fix**: Validar x-signature header de MercadoPago

### 3. **Falta unique constraint en provider_transaction_id** (CR√çTICO)

**Escenario de ataque**:
```
1. Webhook recibe payment_id: "12345"
2. Confirma dep√≥sito de $100
3. Webhook recibe OTRA VEZ payment_id: "12345" (por error de MP o ataque)
4. Acredita OTRO $100 (duplicado)
```

**Fix**: Unique constraint + idempotencia en confirm_deposit

### 4. **Falta verificaci√≥n de fondos en lock_funds** (ALTO)

**Escenario de problema**:
```
1. Usuario tiene $100 disponibles
2. Llama a lock_funds($150)
3. RPC NO verifica si tiene fondos
4. Balance negativo: -$50
```

**Fix**: Verificar `available_balance >= amount` ANTES de UPDATE

### 5. **Falta atomic operations** (ALTO)

**Escenario de race condition**:
```
Thread 1: lock_funds($100) - lee balance: $100
Thread 2: lock_funds($80) - lee balance: $100
Thread 1: actualiza balance = $0
Thread 2: actualiza balance = $20 (SOBRESCRIBE Thread 1!)
Result: Balance inconsistente
```

**Fix**: BEGIN/COMMIT con SELECT FOR UPDATE

---

## üìà IMPACTO ESPERADO

### Antes de validaciones:

| M√©trica | Estado |
|---------|--------|
| **Vulnerabilidades cr√≠ticas** | 3 |
| **Vulnerabilidades altas** | 2 |
| **Riesgo de fraude** | ALTO |
| **Riesgo de balance negativo** | MEDIO |
| **Idempotencia** | PARCIAL (solo webhook) |

### Despu√©s de Fase 1 (CR√çTICO):

| M√©trica | Estado |
|---------|--------|
| **Vulnerabilidades cr√≠ticas** | 0 ‚úÖ |
| **Vulnerabilidades altas** | 2 |
| **Riesgo de fraude** | BAJO ‚úÖ |
| **Riesgo de balance negativo** | BAJO ‚úÖ |
| **Idempotencia** | COMPLETA ‚úÖ |

### Despu√©s de Fase 2 (ALTO):

| M√©trica | Estado |
|---------|--------|
| **Vulnerabilidades cr√≠ticas** | 0 ‚úÖ |
| **Vulnerabilidades altas** | 0 ‚úÖ |
| **Riesgo de fraude** | MUY BAJO ‚úÖ |
| **Riesgo de balance negativo** | MUY BAJO ‚úÖ |
| **Rate limiting** | COMPLETO ‚úÖ |

---

## üîÑ PR√ìXIMOS PASOS

### Ahora (Fase 1 - CR√çTICO):

1. ‚úÖ Crear este documento de an√°lisis
2. ‚è≥ Crear migration con validaciones en RPC
3. ‚è≥ Agregar validaci√≥n de ownership en create-preference
4. ‚è≥ Agregar validaci√≥n de firma en webhook
5. ‚è≥ Agregar unique constraint en provider_transaction_id
6. ‚è≥ Deploy y testing

### Pr√≥xima sesi√≥n (Fase 2 - ALTO):

7. Agregar todas las validaciones de integridad en RPC
8. Implementar rate limiting en Edge Functions
9. Mejorar validaciones en frontend
10. Testing exhaustivo

### Mejoras continuas (Fase 3 - MEDIO):

11. Dashboard de monitoreo
12. Alertas autom√°ticas
13. Cleanup de transacciones viejas
14. Auditor√≠a completa

---

**√öltima actualizaci√≥n**: 2025-10-20 19:15 UTC
**Autor**: Claude Code
**Status**: ‚úÖ An√°lisis completo - Listo para implementar Fase 1
