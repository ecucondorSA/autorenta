<div class="card-premium h-full flex flex-col p-0 overflow-hidden bg-surface-raised">
  <!-- Loading State -->
  @if (loading()) {
    <div class="p-8 flex flex-col items-center justify-center flex-1">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cta-default"></div>
      <p class="mt-4 text-text-secondary text-sm">Analizando tu reputaci√≥n...</p>
    </div>
  }

  <!-- Content -->
  @if (!loading() && bonusMalus()) {
    <div class="flex flex-col h-full">
      <!-- Header with Tier Banner -->
      <div class="relative p-6 pb-8 bg-gradient-to-br from-surface-secondary to-surface-base">
        <!-- Tier Badge (Top Right) -->
        @if (tierDisplay()) {
          <div class="absolute top-4 right-4">
            <span
              [class]="
                tierDisplay()!.badgeClass +
                ' px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-1 shadow-sm'
              "
            >
              <ion-icon [name]="tierDisplay()!.icon"></ion-icon>
              {{ tierDisplay()!.label }}
            </span>
          </div>
        }
        <div class="flex items-start gap-4">
          <!-- Score Circle -->
          <div class="relative flex-shrink-0">
            <svg class="h-20 w-20 transform -rotate-90">
              <!-- Background circle -->
              <circle
                class="text-border-default"
                stroke-width="6"
                stroke="currentColor"
                fill="transparent"
                r="36"
                cx="40"
                cy="40"
              />
              <!-- Progress circle -->
              <circle
                [class]="
                  scorePercentage() >= 75
                    ? 'text-emerald-500'
                    : scorePercentage() >= 50
                      ? 'text-violet-500'
                      : 'text-amber-500'
                "
                stroke-width="6"
                [attr.stroke-dasharray]="226"
                [attr.stroke-dashoffset]="226 - (226 * scorePercentage()) / 100"
                stroke-linecap="round"
                stroke="currentColor"
                fill="transparent"
                r="36"
                cx="40"
                cy="40"
              />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span class="text-xl font-bold text-text-primary">{{
                scorePercentage().toFixed(0)
              }}</span>
              <span class="text-xs uppercase text-text-secondary font-medium">Score</span>
            </div>
          </div>
          <div class="flex-1 pt-1">
            <h3 class="text-lg font-bold text-text-primary leading-tight mb-1 font-satoshi">
              Tu Reputaci√≥n
            </h3>
            <p class="text-sm text-text-secondary leading-snug">
              {{ display()?.message }}
            </p>
            <!-- Key Benefit Highlight -->
            <div
              class="mt-3 inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-surface-base border border-border-default/50"
            >
              <span class="text-lg">üõ°Ô∏è</span>
              <span class="text-xs font-semibold text-text-primary">
                {{ depositBenefit() }}
              </span>
            </div>
          </div>
        </div>
      </div>
      <!-- Stats Grid -->
      <div class="grid grid-cols-2 gap-px bg-border-default/30">
        <div
          class="bg-surface-raised p-3 flex flex-col items-center justify-center hover:bg-surface-secondary/30 transition-colors"
        >
          <span class="text-xs text-text-secondary uppercase tracking-wide font-medium"
            >Rating</span
          >
          <span class="text-lg font-bold text-text-primary mt-1">
            {{ bonusMalus()!.metrics.average_rating | number: '1.1-1' }}
          </span>
        </div>
        <div
          class="bg-surface-raised p-3 flex flex-col items-center justify-center hover:bg-surface-secondary/30 transition-colors"
        >
          <span
            class="text-xs text-text-secondary uppercase tracking-wide font-medium font-friendly"
            >Viajes</span
          >
          <span class="text-lg font-bold text-text-primary mt-1">
            {{ bonusMalus()!.metrics.completed_rentals }}
          </span>
        </div>
      </div>
      <!-- Toggle Details -->
      <button
        (click)="toggleDetails()"
        class="w-full py-2 flex items-center justify-center gap-2 text-xs font-medium text-cta-default hover:bg-cta-default/5 transition-colors border-t border-border-default/30"
      >
        <span>{{ showDetails() ? 'Ocultar detalles' : 'Ver desglose completo' }}</span>
        <ion-icon [name]="showDetails() ? 'chevron-up' : 'chevron-down'"></ion-icon>
      </button>
      <!-- Expanded Details -->
      @if (showDetails()) {
        <div
          class="p-4 bg-surface-secondary/30 border-t border-border-default/30 animate-fade-in text-sm"
        >
          <!-- Metrics List -->
          <div class="space-y-3 mb-4">
            <div class="flex items-center justify-between">
              <span class="text-text-secondary">Tasa de cancelaci√≥n</span>
              <span class="font-medium text-text-primary"
                >{{ (bonusMalus()!.metrics.cancellation_rate * 100).toFixed(0) }}%</span
              >
            </div>
            <div class="flex items-center justify-between">
              <span class="text-text-secondary">Identidad Verificada</span>
              <span
                [class]="
                  bonusMalus()!.metrics.is_verified
                    ? 'text-emerald-600 font-medium'
                    : 'text-amber-600'
                "
              >
                {{ bonusMalus()!.metrics.is_verified ? 'S√≠' : 'Pendiente' }}
              </span>
            </div>
          </div>
          <!-- Improvement Tips -->
          @if (tips().length > 0) {
            <div>
              <h4 class="text-xs font-bold uppercase text-text-secondary mb-2 font-satoshi">
                Consejos para mejorar
              </h4>
              <ul class="space-y-2">
                @for (tip of tips(); track tip) {
                  <li
                    class="flex items-start gap-2 text-xs text-text-primary bg-surface-base p-2 rounded border border-border-default/50"
                  >
                    <span class="text-amber-500 mt-0.5">üí°</span>
                    <span>{{ tip }}</span>
                  </li>
                }
              </ul>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
