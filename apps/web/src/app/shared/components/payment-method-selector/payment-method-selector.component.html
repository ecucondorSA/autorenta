<div class="payment-method-selector">
  <!-- Header -->
  <div class="mb-4">
    <h3 class="text-lg font-semibold text-text-primary mb-1">Método de Pago</h3>
    <p class="text-sm text-text-secondary dark:text-text-secondary">
      Selecciona cómo deseas pagar tu reserva
    </p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoadingBalance()" class="py-8 text-center">
    <div
      class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-cta-default"
    ></div>
    <p class="text-sm text-text-secondary dark:text-text-secondary mt-2">
      Cargando información del wallet...
    </p>
  </div>

  <!-- Payment Options -->
  <div *ngIf="!isLoadingBalance()" class="space-y-3">
    <!-- Option 1: Credit Card (Mercado Pago) -->
    <div
      class="payment-option border rounded-lg p-4 cursor-pointer transition-all"
      [class.border-cta-default]="selectedMethod() === 'credit_card'"
      [class.bg-cta-default/10]="selectedMethod() === 'credit_card'"
      [class.border-border-default]="selectedMethod() !== 'credit_card'"
      [class.hover:border-border-muted]="selectedMethod() !== 'credit_card'"
      (click)="selectMethod('credit_card')"
    >
      <div class="flex items-start">
        <input
          type="radio"
          name="paymentMethod"
          value="credit_card"
          [checked]="selectedMethod() === 'credit_card'"
          class="mt-1 mr-3 text-cta-default focus:ring-cta-default"
        />
        <div class="flex-1">
          <div class="flex items-center justify-between mb-1">
            <span class="font-medium text-text-primary">Tarjeta de Crédito/Débito</span>
            <svg
              class="w-5 h-5 text-text-secondary dark:text-text-secondary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
              ></path>
            </svg>
          </div>
          <p class="text-sm text-text-secondary dark:text-text-secondary">Paga con Mercado Pago</p>
          <div class="mt-2 flex items-center gap-2">
            <span class="text-xs px-2 py-1 bg-success-light/20 text-success-light rounded"
              >Mercado Pago</span
            >
            <span class="text-xs px-2 py-1 bg-surface-raised text-text-primary rounded"
              >Todas las tarjetas</span
            >
          </div>
          <div
            *ngIf="selectedMethod() === 'credit_card'"
            class="mt-3 p-3 bg-surface-raised rounded border border-cta-default/40"
          >
            <p class="text-sm font-medium text-text-primary">Total a pagar:</p>
            <p class="h4 text-cta-default">{{ formatCurrency(totalAmount) }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Option 2: 100% Wallet (only if sufficient funds) -->
    <div
      *ngIf="hasSufficientFunds()"
      class="payment-option border rounded-lg p-4 cursor-pointer transition-all"
      [class.border-success-light]="selectedMethod() === 'wallet'"
      [class.bg-success-light/10]="selectedMethod() === 'wallet'"
      [class.border-border-default]="selectedMethod() !== 'wallet'"
      [class.hover:border-border-muted]="selectedMethod() !== 'wallet'"
      (click)="selectMethod('wallet')"
    >
      <div class="flex items-start">
        <input
          type="radio"
          name="paymentMethod"
          value="wallet"
          [checked]="selectedMethod() === 'wallet'"
          class="mt-1 mr-3 text-success-light focus:ring-success-light"
        />
        <div class="flex-1">
          <div class="flex items-center justify-between mb-1">
            <span class="font-medium text-text-primary">Pagar con Wallet</span>
            <svg
              class="w-5 h-5 text-text-secondary dark:text-text-secondary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
              ></path>
            </svg>
          </div>
          <p class="text-sm text-text-secondary dark:text-text-secondary">
            Usa tu saldo disponible
          </p>
          <div class="mt-2 flex items-center gap-2">
            <span
              class="text-xs px-2 py-1 bg-success-light/20 text-success-light rounded flex items-center gap-1"
            >
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                ></path>
              </svg>
              Fondos suficientes
            </span>
            <span class="text-xs px-2 py-1 bg-cta-default/20 text-cta-default rounded"
              >Sin comisiones</span
            >
          </div>
          <div *ngIf="selectedMethod() === 'wallet'" class="mt-3 space-y-2">
            <div class="p-3 bg-surface-raised rounded border border-success-light/40">
              <div class="flex justify-between items-center">
                <span class="text-sm text-text-secondary dark:text-text-secondary"
                  >Balance disponible:</span
                >
                <span class="text-sm font-medium text-text-primary">{{
                  formatCurrency(availableBalance())
                }}</span>
              </div>
              <div
                class="flex justify-between items-center mt-2 pt-2 border-t border-border-default"
              >
                <span class="text-sm font-medium text-text-primary">Se usará del wallet:</span>
                <span class="h4 text-success-light">{{ formatCurrency(totalAmount) }}</span>
              </div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-sm text-text-secondary dark:text-text-secondary"
                  >Balance restante:</span
                >
                <span class="text-sm font-medium text-text-primary">{{
                  formatCurrency(availableBalance() - totalAmount)
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Option 3: Partial Wallet + Card (only if partial funds) -->
    <div
      *ngIf="hasPartialFunds()"
      class="payment-option border rounded-lg p-4 cursor-pointer transition-all"
      [class.border-purple-600]="selectedMethod() === 'partial_wallet'"
      [class.bg-purple-50]="selectedMethod() === 'partial_wallet'"
      [class.border-border-default]="selectedMethod() !== 'partial_wallet'"
      [class.hover:border-border-muted]="selectedMethod() !== 'partial_wallet'"
      (click)="selectMethod('partial_wallet')"
    >
      <div class="flex items-start">
        <input
          type="radio"
          name="paymentMethod"
          value="partial_wallet"
          [checked]="selectedMethod() === 'partial_wallet'"
          class="mt-1 mr-3 text-purple-600 focus:ring-purple-500"
        />
        <div class="flex-1">
          <div class="flex items-center justify-between mb-1">
            <span class="font-medium text-text-primary">Pago Mixto</span>
            <div class="flex items-center gap-1">
              <svg
                class="w-5 h-5 text-text-secondary dark:text-text-secondary"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
                ></path>
              </svg>
              <span class="text-text-muted dark:text-text-secondary">+</span>
              <svg
                class="w-5 h-5 text-text-secondary dark:text-text-secondary"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                ></path>
              </svg>
            </div>
          </div>
          <p class="text-sm text-text-secondary dark:text-text-secondary">
            Combina wallet y tarjeta
          </p>
          <div class="mt-2">
            <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded"
              >Optimiza tu saldo</span
            >
          </div>

          <!-- Wallet Amount Adjuster (only when selected) -->
          <div *ngIf="selectedMethod() === 'partial_wallet'" class="mt-3 space-y-3">
            <div class="p-3 bg-surface-raised rounded border border-purple-200">
              <label for="walletAmount" class="block text-sm font-medium text-text-primary mb-2">
                Monto a usar del wallet:
              </label>
              <div class="flex items-center gap-2">
                <div class="relative flex-1">
                  <span
                    class="absolute left-3 top-2.5 text-text-secondary dark:text-text-secondary font-medium"
                    >$</span
                  >
                  <input
                    type="number"
                    id="walletAmount"
                    [value]="walletAmountToUse()"
                    (input)="updateWalletAmount($any($event.target).value)"
                    [min]="0"
                    [max]="Math.min(availableBalance(), totalAmount)"
                    step="10"
                    class="pl-8 pr-3 py-2 w-full border border-border-muted rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                </div>
                <button
                  type="button"
                  (click)="useMaxWallet()"
                  class="px-3 py-2 text-sm bg-purple-600 text-text-inverse rounded-lg hover:bg-purple-700 transition-colors whitespace-nowrap"
                >
                  Usar Máximo
                </button>
              </div>
              <div class="mt-2 flex items-center">
                <div class="flex-1 bg-surface-hover rounded-full h-2">
                  <div
                    class="bg-purple-600 h-2 rounded-full transition-all"
                    [style.width.%]="walletPercentage()"
                  ></div>
                </div>
                <span class="ml-2 text-xs text-text-secondary dark:text-text-secondary"
                  >{{ walletPercentage() }}%</span
                >
              </div>
              <p class="text-xs text-text-secondary dark:text-text-secondary mt-1">
                Disponible: {{ formatCurrency(availableBalance()) }}
              </p>
            </div>

            <!-- Payment Breakdown -->
            <div class="p-3 bg-surface-raised rounded border border-purple-200 space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-sm text-text-secondary dark:text-text-secondary"
                  >Del wallet:</span
                >
                <span class="text-sm font-medium text-purple-700">{{
                  formatCurrency(walletAmountToUse())
                }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-text-secondary dark:text-text-secondary"
                  >Con tarjeta:</span
                >
                <span class="text-sm font-medium text-cta-default">{{
                  formatCurrency(cardAmount())
                }}</span>
              </div>
              <div class="flex justify-between items-center pt-2 border-t border-border-default">
                <span class="text-sm font-medium text-text-primary">Total:</span>
                <span class="text-lg font-bold text-text-primary">{{
                  formatCurrency(totalAmount)
                }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No Funds Warning (only if no wallet funds) -->
    <div
      *ngIf="!hasSufficientFunds() && !hasPartialFunds()"
      class="bg-cta-default/10 border border-cta-default/40 rounded-lg p-4"
    >
      <div class="flex items-start">
        <svg
          class="w-5 h-5 text-cta-default mt-0.5 flex-shrink-0"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <div class="ml-3">
          <h4 class="text-sm font-medium text-cta-default">Sin saldo en wallet</h4>
          <p class="text-sm text-cta-default mt-1">
            Deposita fondos en tu wallet para pagar sin tarjeta de crédito.
            <a href="/wallet" class="underline hover:text-cta-default">Ir a Wallet</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
