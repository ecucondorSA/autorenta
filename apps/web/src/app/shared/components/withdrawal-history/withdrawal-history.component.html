<div class="space-y-4">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <h3 class="text-lg font-semibold text-text-primary font-satoshi">Historial de Retiros</h3>
    <button
      (click)="onRefresh()"
      [disabled]="loading"
      class="px-3 py-1 text-sm border border-border-muted dark:border-border-default text-text-primary rounded-lg hover:bg-surface-base dark:bg-surface-base disabled:opacity-50 disabled:cursor-not-allowed transition"
    >
      @if (loading) {
        Actualizando...
      } @else {
        <app-icon name="refresh" [size]="16" cssClass="inline-block mr-1" /> Actualizar
      }
    </button>
  </div>

  <!-- Loading State -->
  @if (loading) {
    <div class="text-center py-8">
      <div
        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-cta-default"
      ></div>
      <p class="mt-2 text-sm text-text-secondary dark:text-text-secondary">Cargando historial...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!loading && requests.length === 0) {
    <div
      class="text-center py-12 bg-surface-base dark:bg-surface-base rounded-2xl border-2 border-dashed border-border-muted dark:border-border-default"
    >
      <svg
        class="mx-auto h-12 w-12 text-text-muted dark:text-text-secondary"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
        ></path>
      </svg>
      <h3 class="mt-2 text-sm font-semibold text-text-primary font-satoshi">No hay retiros</h3>
      <p class="mt-1 text-sm text-text-secondary dark:text-text-secondary">
        Todavía no has solicitado ningún retiro
      </p>
    </div>
  }

  <!-- Requests List -->
  @if (!loading && requests.length > 0) {
    <div class="space-y-3">
      @for (request of requests; track request.id) {
        <div
          class="bg-surface-raised dark:bg-surface-secondary border border-border-default dark:border-border-muted rounded-xl p-4 hover:shadow-md transition-shadow"
        >
          <div class="flex items-start justify-between">
            <!-- Request Info -->
            <div class="flex-1">
              <!-- Status Badge -->
              <div class="flex items-center gap-2 mb-2">
                <span
                  class="px-3 py-1 rounded-lg text-sm font-semibold flex items-center gap-1"
                  [ngClass]="getStatusClass(request.status)"
                >
                  {{ getStatusIcon(request.status) }}
                  {{ getStatusLabel(request.status) }}
                </span>
                <span class="text-xs text-text-secondary dark:text-text-secondary">
                  {{ formatDate(request.created_at) }}
                </span>
              </div>

              <!-- Amount Info -->
              <div class="grid grid-cols-3 gap-4 mb-2">
                <div>
                  <p class="text-xs text-text-secondary dark:text-text-secondary">Solicitado</p>
                  <p class="text-lg font-bold text-text-primary">
                    ${{ request.amount | number: '1.2-2' }}
                  </p>
                </div>
                <div>
                  <p class="text-xs text-text-secondary dark:text-text-secondary">Comisión</p>
                  <p class="text-sm font-semibold text-error-text">
                    -${{ request.fee_amount | number: '1.2-2' }}
                  </p>
                </div>
                <div>
                  <p class="text-xs text-text-secondary dark:text-text-secondary">Neto</p>
                  <p class="text-lg font-bold text-success-strong">
                    ${{ request.net_amount | number: '1.2-2' }}
                  </p>
                </div>
              </div>

              <!-- Additional Info -->
              @if (request.user_notes) {
                <p class="text-sm text-text-secondary dark:text-text-secondary mb-2">
                  <strong>Nota:</strong> {{ request.user_notes }}
                </p>
              }

              @if (request.rejection_reason) {
                <div
                  class="mt-2 p-2 bg-error-bg dark:bg-error-bg0/15 border border-error-border dark:border-error-border/40 rounded-lg"
                >
                  <p class="text-xs text-error-strong">
                    <strong>Motivo de rechazo:</strong> {{ request.rejection_reason }}
                  </p>
                </div>
              }

              @if (request.failure_reason) {
                <div
                  class="mt-2 p-2 bg-error-bg dark:bg-error-bg0/15 border border-error-border dark:border-error-border/40 rounded-lg"
                >
                  <p class="text-xs text-error-strong">
                    <strong>Error:</strong> {{ request.failure_reason }}
                  </p>
                </div>
              }

              @if (request.admin_notes) {
                <div
                  class="mt-2 p-2 bg-cta-default/10 dark:bg-cta-default/15 border border-cta-default dark:border-cta-default/40 rounded-lg"
                >
                  <p class="text-xs text-cta-default dark:text-cta-default">
                    <strong>Nota del admin:</strong> {{ request.admin_notes }}
                  </p>
                </div>
              }

              <!-- Dates -->
              <div
                class="mt-2 flex flex-wrap gap-4 text-xs text-text-secondary dark:text-text-secondary"
              >
                @if (request.approved_at) {
                  <span
                    ><app-icon name="check-circle" [size]="16" cssClass="inline-block mr-1" />
                    Aprobado: {{ formatDate(request.approved_at) }}</span
                  >
                }
                @if (request.processed_at) {
                  <span
                    ><app-icon name="refresh" [size]="16" cssClass="inline-block mr-1" /> Procesado:
                    {{ formatDate(request.processed_at) }}</span
                  >
                }
                @if (request.completed_at) {
                  <span
                    ><app-icon name="check-circle" [size]="16" cssClass="inline-block mr-1" />
                    Completado: {{ formatDate(request.completed_at) }}</span
                  >
                }
              </div>
            </div>

            <!-- Actions -->
            @if (canCancel(request)) {
              <button
                (click)="onCancel(request.id)"
                class="ml-4 px-3 py-1 text-sm border border-error-border text-error-strong rounded-lg hover:bg-error-bg dark:hover:bg-error-bg0/15 transition"
              >
                Cancelar
              </button>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
