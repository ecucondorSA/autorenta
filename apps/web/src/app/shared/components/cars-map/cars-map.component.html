
<div class="cars-map-container" [class.map-variant-photo]="markerVariant === 'photo'" [class.map-variant-price]="markerVariant === 'price'">
  <div *ngIf="loading()" class="map-overlay loading-overlay">
    <div class="spinner"></div>
    <p>Cargando mapa de autos disponibles...</p>
  </div>

  <div *ngIf="error() && !loading()" class="map-overlay error-overlay">
    <div class="error-content">
      <svg class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <p class="error-message">{{ error() }}</p>
    </div>
  </div>

  <div #mapContainer class="map-canvas"></div>

  <!-- Details Panel -->
  <div class="absolute top-0 left-0 h-full w-96 p-4 z-10 transition-transform duration-300 ease-in-out"
       [class.translate-x-0]="selectedCar()"
       [class.-translate-x-full]="!selectedCar()">
    <app-map-details-panel
      [carLocation]="selectedCar()"
      (close)="onDetailsPanelClose()">
    </app-map-details-panel>
  </div>


  <!-- Controles de mapa -->
  <div class="map-controls-container" *ngIf="!loading() && !error()">
    <!-- Botón seguir ubicación -->
    <button
      class="map-control-button"
      [class.active]="followUserLocation"
      (click)="toggleFollowLocation()"
      title="Seguir mi posición"
      type="button"
    >
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
        />
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
        />
      </svg>
    </button>

    <!-- Botón bloquear zoom/rotación -->
    <button
      class="map-control-button"
      [class.active]="lockZoomRotation"
      (click)="toggleLock()"
      [title]="lockZoomRotation ? 'Desbloquear zoom/rotación' : 'Bloquear zoom/rotación'"
      type="button"
    >
      <ng-container *ngIf="!lockZoomRotation">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"
          />
        </svg>
      </ng-container>
      <ng-container *ngIf="lockZoomRotation">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
          />
        </svg>
      </ng-container>
    </button>
  </div>

  <!-- Control de radio de búsqueda -->
  <div class="search-radius-control" *ngIf="showSearchRadius && !loading() && !error() && userLocation">
    <div class="search-radius-label">Radio de búsqueda</div>
    <input
      type="range"
      class="search-radius-slider"
      [min]="1"
      [max]="20"
      [step]="1"
      [value]="searchRadiusKm"
      (input)="onSearchRadiusChange($event)"
      title="Ajustar radio de búsqueda"
    />
    <div class="search-radius-value">{{ searchRadiusKm }} km</div>
  </div>

  <!-- Booking Panel -->
  <app-map-booking-panel
    [car]="selectedCarForBooking()"
    [isOpen]="bookingPanelOpen"
    [userLocation]="userLocation || undefined"
    (bookingConfirmed)="onBookingConfirmed($event)"
    (close)="onBookingPanelClose()"
  />
</div>

