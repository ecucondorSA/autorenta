<div
  class="cars-map-container"
  [class.map-variant-photo]="markerVariant === 'photo'"
  [class.map-variant-price]="markerVariant === 'price'"
>
  <div *ngIf="loading()" class="map-overlay loading-overlay">
    <div class="spinner"></div>
    <p>Cargando mapa de autos disponibles...</p>
  </div>

  <div *ngIf="error() && !loading()" class="map-overlay error-overlay">
    <div class="error-content">
      <svg class="error-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <p class="error-message">{{ error() }}</p>
    </div>
  </div>

  <div #mapContainer class="map-canvas"></div>

  <!-- Map Info Layer - Ubicación y Estadísticas -->
  <div class="map-info-layer" *ngIf="!loading() && !error()">
    <!-- User Location Info -->
    <div class="info-card user-location-card" *ngIf="userLocation">
      <div class="info-card-header">
        <svg class="info-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
          />
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
          />
        </svg>
        <h3 class="info-title">Tu Ubicación</h3>
      </div>
      <div class="info-content">
        <div class="info-row">
          <span class="info-label">Latitud:</span>
          <span class="info-value tabular-nums">{{ userLocation.lat.toFixed(6) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Longitud:</span>
          <span class="info-value tabular-nums">{{ userLocation.lng.toFixed(6) }}</span>
        </div>
        <div class="info-row" *ngIf="locationAccuracy">
          <span class="info-label">Precisión:</span>
          <span class="info-value tabular-nums">±{{ locationAccuracy.toFixed(0) }}m</span>
        </div>
        <div class="info-row" *ngIf="lastLocationUpdate">
          <span class="info-label">Actualizado:</span>
          <span class="info-value">{{ getLocationUpdateText() }}</span>
        </div>
        <div class="info-row" *ngIf="showSearchRadius">
          <span class="info-label">Radio búsqueda:</span>
          <span class="info-value tabular-nums">{{ searchRadiusKm }} km</span>
        </div>
      </div>
    </div>

    <!-- Cars Statistics Info -->
    <div class="info-card cars-stats-card">
      <div class="info-card-header">
        <svg class="info-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
          />
        </svg>
        <h3 class="info-title">Autos Publicados</h3>
      </div>
      <div class="info-content">
        <div class="info-row info-row-highlight">
          <span class="info-label">Total:</span>
          <span class="info-value tabular-nums">{{ cars.length }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">
            <span class="status-indicator status-available"></span>
            Disponibles:
          </span>
          <span class="info-value tabular-nums">{{ getAvailableCarsCount() }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">
            <span class="status-indicator status-in-use"></span>
            En uso:
          </span>
          <span class="info-value tabular-nums">{{ getInUseCarsCount() }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">
            <span class="status-indicator status-soon"></span>
            Pronto disponibles:
          </span>
          <span class="info-value tabular-nums">{{ getSoonAvailableCarsCount() }}</span>
        </div>
        <div class="info-row" *ngIf="useClustering && cars.length > clusteringThreshold">
          <span class="info-label">Clustering:</span>
          <span class="info-value info-badge">Activo</span>
        </div>
      </div>
    </div>

    <!-- Map Legend -->
    <div class="info-card legend-card">
      <div class="info-card-header">
        <svg class="info-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <h3 class="info-title">Leyenda</h3>
      </div>
      <div class="info-content">
        <div class="legend-item">
          <div class="legend-marker user-marker"></div>
          <span class="legend-label">Tu ubicación</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker car-available"></div>
          <span class="legend-label">Auto disponible</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker car-soon"></div>
          <span class="legend-label">Pronto disponible</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker car-in-use"></div>
          <span class="legend-label">En uso</span>
        </div>
        <div class="legend-item" *ngIf="showSearchRadius && userLocation">
          <div class="legend-marker search-radius"></div>
          <span class="legend-label">Radio de búsqueda</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Panel -->
  <div
    class="absolute top-0 left-0 h-full w-96 p-4 z-10 transition-transform duration-300 ease-in-out"
    [class.translate-x-0]="selectedCar()"
    [class.-translate-x-full]="!selectedCar()"
  >
    <app-map-details-panel [carLocation]="selectedCar()" (close)="onDetailsPanelClose()">
    </app-map-details-panel>
  </div>

  <!-- Controles de mapa -->
  <div class="map-controls-container" *ngIf="!loading() && !error()">
    <!-- Botón seguir ubicación -->
    <button
      class="map-control-button"
      [class.active]="followUserLocation"
      (click)="toggleFollowLocation()"
      title="Seguir mi posición"
      type="button"
    >
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
        />
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
        />
      </svg>
    </button>

    <!-- Botón bloquear zoom/rotación -->
    <button
      class="map-control-button"
      [class.active]="lockZoomRotation"
      (click)="toggleLock()"
      [title]="lockZoomRotation ? 'Desbloquear zoom/rotación' : 'Bloquear zoom/rotación'"
      type="button"
    >
      <ng-container *ngIf="!lockZoomRotation">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"
          />
        </svg>
      </ng-container>
      <ng-container *ngIf="lockZoomRotation">
        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"
          />
        </svg>
      </ng-container>
    </button>
  </div>

  <!-- Control de radio de búsqueda -->
  <div
    class="search-radius-control"
    *ngIf="showSearchRadius && !loading() && !error() && userLocation"
  >
    <div class="search-radius-label">Radio de búsqueda</div>
    <input
      type="range"
      class="search-radius-slider"
      [min]="1"
      [max]="20"
      [step]="1"
      [value]="searchRadiusKm"
      (input)="onSearchRadiusChange($event)"
      title="Ajustar radio de búsqueda"
    />
    <div class="search-radius-value">{{ searchRadiusKm }} km</div>
  </div>

  <!-- Booking Panel -->
  <app-map-booking-panel
    [car]="selectedCarForBooking()"
    [isOpen]="bookingPanelOpen"
    [userLocation]="userLocation || undefined"
    (bookingConfirmed)="onBookingConfirmed($event)"
    (close)="onBookingPanelClose()"
  />
</div>
