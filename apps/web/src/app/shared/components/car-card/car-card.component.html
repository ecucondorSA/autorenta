<article [routerLink]="['/cars', car.id]" [attr.data-car-id]="car.id" data-testid="car-card"
  class="group relative flex flex-col h-full bg-[#1A1A1A] rounded-[1.5rem] overflow-hidden border border-white/5 shadow-lg transition-all duration-300 cursor-pointer hover:border-white/10 hover:shadow-2xl hover:-translate-y-1"
  [class.ring-2]="selected" [class.ring-brand-primary]="selected" [class.grayscale]="!isOwnerVerified()"
  [class.opacity-75]="!isOwnerVerified()">
  <!-- Image Container -->
  <div class="relative w-full aspect-[4/3] overflow-hidden bg-zinc-900">
    <!-- Skeleton / Loading State -->
    <div class="absolute inset-0 bg-zinc-800 animate-pulse" *ngIf="!displayImage()"></div>

    <!-- Real Image -->
    @if (displayImage(); as img) {
    @if (isBase64Image(img.url)) {
    <img [src]="img.url" [alt]="img.alt" loading="lazy"
      class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-105" />
    } @else {
    <img [ngSrc]="img.url" [alt]="img.alt" [priority]="_priority()" fill
      class="object-cover transition-transform duration-700 ease-out group-hover:scale-105" />
    }
    }

    <!-- Top Left Badges (Status) -->
    <div class="absolute top-3 left-3 z-10 flex gap-2">
      @if (urgentMode) {
      <span
        class="bg-red-600/90 backdrop-blur-md text-white px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-lg animate-pulse border border-red-500/20">
        ¡Oferta!
      </span>
      }
      @if (!isOwnerVerified()) {
      <span
        class="bg-amber-500/90 backdrop-blur-md text-black px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider shadow-lg border border-amber-400/20">
        Pendiente
      </span>
      }
    </div>

    <!-- Top Right Badges (Rating & Instant) -->
    <div class="absolute top-3 right-3 z-10 flex flex-col gap-2 items-end">
      @if (hasInstantBooking()) {
      <span
        class="bg-emerald-500/90 text-white p-1.5 rounded-full backdrop-blur-md shadow-lg border border-emerald-400/20"
        title="Reserva Instantánea">
        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
      </span>
      }

      @if (car.rating_count > 0) {
      <div
        class="flex items-center gap-1 bg-black/60 backdrop-blur-md px-2 py-1 rounded-full border border-white/10 shadow-lg">
        <svg class="w-3 h-3 text-yellow-400 fill-current" viewBox="0 0 20 20">
          <path
            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
        <span class="text-xs font-bold text-white">{{ car.rating_avg | number: '1.1-1' }}</span>
      </div>
      }
    </div>
  </div>

  <!-- Content Section -->
  <div class="flex flex-col flex-1 p-4 pb-5 pt-4">
    <!-- Title & Location -->
    <div class="mb-4">
      <h3
        class="font-bold text-lg text-white leading-snug tracking-tight line-clamp-2 font-display group-hover:text-brand-primary transition-colors min-h-[3.25rem]"
        [title]="displayTitle()">
        {{ displayTitle() }}
      </h3>
      <p class="text-xs font-medium text-zinc-500 mt-1 flex items-center gap-1.5 truncate">
        <svg class="w-3.5 h-3.5 text-zinc-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <span class="truncate">{{ car.location_city || 'Ubicación desconocida' }}</span>
      </p>
    </div>

    <!-- Specs Row (Icons) -->
    @if (!mapVariant) {
    <div class="flex items-center gap-4 mb-5 text-zinc-400">
      <!-- Transmission -->
      <div class="flex items-center gap-1.5" title="Transmisión">
        <svg class="w-4 h-4 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
        </svg>
        <span class="text-xs font-medium">{{ car.transmission === 'automatic' ? 'Auto' : 'Manual' }}</span>
      </div>

      <!-- Seats -->
      <div class="flex items-center gap-1.5" title="Asientos">
        <svg class="w-4 h-4 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span class="text-xs font-medium">{{ car.seats }}</span>
      </div>

      <!-- Fuel -->
      <div class="flex items-center gap-1.5" title="Combustible">
        @if (car.fuel_type?.toLowerCase()?.includes('electric') || car.fuel_type?.toLowerCase()?.includes('eléctrico'))
        {
        <svg class="w-4 h-4 text-brand-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <span class="text-xs font-medium text-brand-primary">Eléctrico</span>
        } @else {
        <svg class="w-4 h-4 text-zinc-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          <!-- Fallback to generic, or gas pump if I had the path handy, using Filter icon as abstract engine/fuel for now or better lightning bolt for all since it looks cool? No, gas pump needed. Let's use generic Canister -->
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
        </svg>
        <span class="text-xs font-medium">{{ car.fuel_type || 'Nafta' }}</span>
        }
      </div>
    </div>
    }

    <!-- Footer: Price & CTA -->
    <div class="mt-auto flex items-end justify-between border-t border-white/5 pt-4">
      <div>
        <div class="flex items-baseline gap-1">
          @if (hasValidPrice()) {
          <span class="text-sm font-medium text-brand-primary">$</span>
          <span class="text-2xl font-black text-white tracking-tight font-satoshi">
            {{ displayPrice() | number:'1.0-0' }}
          </span>
          } @else {
          <span class="text-sm font-bold text-zinc-400">Consultar</span>
          }
        </div>
        <p class="text-[10px] text-zinc-500 font-medium">por día</p>
      </div>

      <button
        class="group/btn relative w-10 h-10 rounded-full bg-white text-black flex items-center justify-center hover:bg-brand-primary transition-all shadow-lg active:scale-95 overflow-hidden"
        (click)="$event.stopPropagation();" [routerLink]="['/cars', car.id]" aria-label="Ver detalles">
        <div class="absolute inset-0 bg-brand-primary opacity-0 group-hover/btn:opacity-100 transition-opacity"></div>
        <svg class="w-5 h-5 relative z-10 transition-transform group-hover/btn:-rotate-45" fill="none"
          stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3" />
        </svg>
      </button>
    </div>
  </div>
</article>