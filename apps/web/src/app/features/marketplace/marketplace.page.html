<!-- App Header (full-bleed hero) -->
<app-app-header
  [compact]="false"
  [showSearch]="true"
  [searchValue]="searchValue()"
  (searchChange)="onSearchChange($event)"
  (searchSubmit)="onSearchSubmit($event)"
/>

<!-- Utility Bar (sticky on scroll) -->
<app-utility-bar
  [searchValue]="searchValue()"
  [quickFilters]="quickFilters"
  [showSearch]="true"
  (searchChange)="onSearchChange($event)"
  (searchSubmit)="onSearchSubmit($event)"
  (quickFilterClick)="onQuickFilterClick($event)"
/>

<!-- Barra superior fija -->
<app-pwa-titlebar />

<!-- RegiÃ³n principal: split 60/40 desktop, tabs mobile -->
<div class="marketplace-container flex flex-col lg:flex-row h-[calc(100vh-64px)] overflow-hidden pt-16">
  <!-- Mapa (60% desktop, full mobile) -->
  <div class="map-section flex-1 lg:w-[60%] relative">
    <app-cars-map
      [cars]="carMapLocations()"
      [selectedCarId]="selectedCarId()"
      [userLocation]="userLocation()"
      [markerVariant]="contextualMarkerVariant()"
      [searchRadiusKm]="radiusKm()"
      [showSearchRadius]="true"
      (carSelected)="onCarSelected($event)"
      (quickBook)="onQuickBook($event)"
      (userLocationChange)="onUserLocationChange($event)"
      (searchRadiusChange)="onSearchRadiusChange($event)"
      class="w-full h-full"
    />

    <!-- Panel flotante de filtros sobre el mapa -->
    <div
      *ngIf="filtersVisible()"
      class="absolute top-4 left-4 z-10 max-w-sm"
      [class.lg:left-4]="!drawerOpen()"
      [class.lg:left-[calc(30%+1rem)]="drawerOpen()"
    >
      <app-map-filters (filterChange)="onFiltersChange($event)" />
    </div>

    <!-- Urgent rental banner flotante -->
    <div *ngIf="selectedCar() && selectedCar()!.region_id && expressMode()" class="absolute top-4 right-4 z-10 max-w-sm">
      <app-urgent-rental-banner
        [carId]="selectedCar()!.id"
        [regionId]="selectedCar()!.region_id!"
        [expressMode]="expressMode"
      />
    </div>

    <!-- Floating Action FABs -->
    <app-floating-action-fab
      [actions]="fabActions"
      position="bottom-right"
      (actionClick)="onFabActionClick($event)"
    />

    <!-- Personalized Location Component -->
    <app-personalized-location
      [map]="carsMapComponent.mapInstance || undefined"
      [userLocation]="userLocation() || undefined"
      [radiusKm]="radiusKm"
      [showRadiusSlider]="true"
      (locationChange)="onUserLocationChange($event.center)"
    />
  </div>

  <!-- Drawer lateral (40% desktop, bottom sheet mobile) -->
  <div
    class="drawer-section lg:w-[40%] bg-surface-raised dark:bg-surface-secondary border-t lg:border-t-0 lg:border-l border-border-default dark:border-gray-600 flex flex-col overflow-hidden transition-transform duration-300"
    [class.drawer-open]="drawerOpen()"
    [class.drawer-closed]="!drawerOpen()"
    [class.fixed]="isMobile()"
    [class.bottom-0]="isMobile()"
    [class.left-0]="isMobile()"
    [class.right-0]="isMobile()"
    [class.h-[60vh]="isMobile() && drawerOpen()"
    [class.hidden]="isMobile() && !drawerOpen()"
  >
    <!-- Drawer header -->
    <div class="drawer-header flex items-center justify-between p-4 border-b border-border-default dark:border-gray-600 flex-shrink-0">
      <div>
        <h2 class="text-lg font-semibold text-text-primary dark:text-text-inverse-pure">
          Autos disponibles
        </h2>
        <p *ngIf="carsWithDistance().length > 0" class="text-sm text-text-secondary dark:text-text-secondary">
          {{ carsWithDistance().length }} {{ carsWithDistance().length === 1 ? 'auto encontrado' : 'autos encontrados' }}
        </p>
      </div>
      <button
        *ngIf="isMobile()"
        type="button"
        (click)="onDrawerClose()"
        class="p-2 rounded-lg hover:bg-surface-secondary dark:hover:bg-charcoal-medium transition-colors"
        aria-label="Cerrar panel"
      >
        <svg class="w-6 h-6 text-text-secondary dark:text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Drawer content -->
    <div #drawerContent class="drawer-content flex-1 overflow-y-auto p-4 space-y-4">
      <!-- Loading state -->
      <div *ngIf="loading()" class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cta-default"></div>
      </div>

      <!-- Empty state -->
      <div *ngIf="!loading() && carsWithDistance().length === 0" class="flex flex-col items-center justify-center py-12 text-center">
        <svg
          class="w-16 h-16 text-text-secondary dark:text-text-secondary/50 mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
          />
        </svg>
        <p class="text-text-secondary dark:text-text-secondary">No hay autos disponibles</p>
        <p class="text-sm text-text-secondary dark:text-text-secondary/70 mt-2">
          Intenta ajustar los filtros
        </p>
      </div>

      <!-- Info Banner -->
      <app-info-banner
        title="Marketplace P2P verificado"
        description="Conectamos personas con autos verificados. Sin intermediarios, sin tarjetas."
      />

      <!-- Availability Alert -->
      <app-availability-alert
        [count]="carsWithDistance().length"
        zone="tu zona"
        (expandRadius)="radiusKm.set(radiusKm() + 5)"
      />

      <!-- Car cards list -->
      <div *ngIf="!loading() && carsWithDistance().length > 0" class="space-y-4">
        <div
          *ngFor="let car of carsWithDistance(); trackBy: trackByCarId"
          class="car-card-wrapper"
          [class.car-card-wrapper--selected]="selectedCarId() === car.id"
          [attr.data-car-id]="car.id"
        >
          <app-car-card
            [car]="car"
            [selected]="selectedCarId() === car.id"
            [distance]="car.distanceText"
            (click)="onCarSelected(car.id)"
            class="cursor-pointer transition-all hover:shadow-md"
          />
          <app-social-proof-indicators [car]="car" class="mt-2" />
        </div>
      </div>
    </div>

    <!-- Drawer footer con CTA (desktop) -->
    <div *ngIf="selectedCar() && !isMobile()" class="drawer-footer p-4 border-t border-border-default dark:border-gray-600 flex-shrink-0">
      <app-sticky-cta-mobile
        [pricePerDay]="selectedCar()!.price_per_day"
        [ctaText]="'Reservar sin tarjeta'"
        [expressMode]="false"
        (ctaClick)="onReserveClick()"
      />
    </div>
  </div>
</div>

<!-- Sticky CTA Mobile (solo mobile) -->
<div *ngIf="isMobile() && selectedCar()" class="fixed bottom-20 left-0 right-0 z-50 px-4 pb-4">
  <app-sticky-cta-mobile
    [pricePerDay]="selectedCar()!.price_per_day"
    [ctaText]="'Reservar sin tarjeta'"
    [expressMode]="false"
    (ctaClick)="onReserveClick()"
  />
</div>

<!-- Quick Booking Modal -->
<app-quick-booking-modal
  *ngIf="quickBookingCar()"
  [car]="quickBookingCar()!"
  [userLocation]="userLocation() || undefined"
  [isOpen]="quickBookingModalOpen()"
  (confirm)="onQuickBookingConfirm($event)"
  (cancel)="onQuickBookingCancel()"
/>

<!-- WhatsApp FAB -->
<app-whatsapp-fab />

<!-- Stats Strip -->
<app-stats-strip />

<!-- Notification Toast -->
<app-notification-toast
  [message]="toastMessage()"
  [isVisible]="toastVisible"
  [type]="'info'"
  (dismiss)="toastVisible.set(false)"
/>

<!-- Mobile bottom nav -->
<app-mobile-bottom-nav />
