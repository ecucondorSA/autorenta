<!-- üé® MARKETPLACE V2 - PREMIUM AIRBNB-STYLE DESIGN -->

<!-- Hero Header with Search -->
<div
  class="hero-header relative bg-gradient-to-br from-blue-400 via-cyan-300 to-teal-200 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 text-white overflow-hidden min-h-[600px] flex items-center"
>
  <!-- Animated background pattern -->
  <div class="absolute inset-0 opacity-10 dark:opacity-5">
    <div
      class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAxMCAwIEwgMCAwIDAgMTAiIGZpbGw9Im5vbmUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNncmlkKSIvPjwvc3ZnPg==')]"
    ></div>
  </div>

  <!-- Gradient overlay for better text contrast -->
  <div
    class="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/10 dark:from-black/40 dark:via-black/10 dark:to-black/30"
  ></div>

  <!-- Subtle accent gradient for dark mode depth -->
  <div
    class="absolute inset-0 bg-gradient-to-tr from-cyan-900/20 via-transparent to-blue-900/20 opacity-0 dark:opacity-100"
  ></div>

  <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 lg:py-20 w-full">
    <!-- Hero Title Section -->
    <div class="text-center mb-12">
      <!-- Logo y t√≠tulo -->
      <div class="flex items-center justify-center gap-4 mb-6">
        <div
          (click)="onLogoClick()"
          class="w-32 h-32 md:w-36 md:h-36 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center shadow-lg border border-white/20 overflow-hidden cursor-pointer hover:bg-white/20 hover:shadow-xl hover:border-white/30 hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-white/50 focus:ring-offset-2 focus:ring-offset-transparent transition-all duration-200"
          role="button"
          tabindex="0"
          (keydown.enter)="onLogoClick()"
          (keydown.space)="onLogoClick()"
          aria-label="Ver mapa del marketplace"
        >
          <img
            src="/assets/images/c40-logo.png"
            alt="Autorentar Logo"
            class="w-full h-full object-contain p-2 pointer-events-none"
            onerror="this.style.display='none'"
          />
        </div>
        <h1 class="text-5xl md:text-6xl font-bold text-white drop-shadow-2xl">Autorentar</h1>
      </div>

      <!-- T√≠tulo principal -->
      <h2
        class="text-3xl md:text-5xl lg:text-6xl font-extrabold text-white mb-4 drop-shadow-2xl leading-tight"
      >
        Encuentra tu auto ideal
      </h2>

      <!-- Subt√≠tulo descriptivo -->
      <p class="text-lg md:text-xl text-white/90 mb-8 max-w-2xl mx-auto drop-shadow-lg">
        Miles de veh√≠culos verificados listos para tu pr√≥xima aventura
      </p>

      <!-- Stats bar -->
      <div class="flex items-center justify-center gap-4 md:gap-8 mb-8 flex-wrap">
        <div
          class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-4 py-2 rounded-full shadow-lg"
        >
          <img src="assets/images/MB.png" alt="Auto" class="h-6 w-6 object-contain" />
          <span class="text-sm md:text-base font-semibold text-white"
            >{{ carsWithDistance().length }}+ autos</span
          >
        </div>
        <div
          class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-4 py-2 rounded-full shadow-lg"
        >
          <span class="text-2xl">‚≠ê</span>
          <span class="text-sm md:text-base font-semibold text-white">4.8/5 rating</span>
        </div>
        <div
          class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-4 py-2 rounded-full shadow-lg"
        >
          <span class="text-2xl">üõ°Ô∏è</span>
          <span class="text-sm md:text-base font-semibold text-white">100% asegurado</span>
        </div>
      </div>
    </div>

    <!-- Quick Actions (replacing old quick stats) -->
    <div class="hidden md:flex items-center justify-center gap-4 mb-8">
      <button
        class="px-6 py-3 bg-white text-cyan-600 font-semibold rounded-xl shadow-xl hover:shadow-2xl hover:scale-105 transform transition-all duration-200"
      >
        ‚ö° Reserva instant√°nea
      </button>
      <button
        (click)="onLogoClick()"
        class="px-6 py-3 bg-white/10 backdrop-blur-md text-white border-2 border-white/30 font-semibold rounded-xl hover:bg-white/20 hover:scale-105 transform transition-all duration-200"
      >
        Explora el marketplace
      </button>
    </div>

    <!-- Preserved for compatibility -->
    <div class="hidden">
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 bg-surface-raised/20 backdrop-blur-sm rounded-xl flex items-center justify-center"
        >
          <span class="text-2xl">üöó</span>
        </div>
        <div>
          <h1 class="text-xl font-bold text-text-primary dark:text-text-primary drop-shadow-sm">
            Autorentar
          </h1>
          <p class="text-xs text-text-primary dark:text-text-primary drop-shadow-sm">
            Tu auto ideal te espera
          </p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <!-- Quick stats -->
        <div class="hidden md:flex items-center gap-4 text-sm">
          <div
            class="flex items-center gap-2 bg-surface-base/95 dark:bg-surface-raised/95 backdrop-blur-sm px-3 py-1.5 rounded-lg text-text-primary dark:text-text-primary shadow-md"
          >
            <span class="text-lg">‚ö°</span>
            <span class="font-medium">{{ carsWithDistance().length }} autos disponibles</span>
          </div>
          <div
            class="flex items-center gap-2 bg-surface-base/95 dark:bg-surface-raised/95 backdrop-blur-sm px-3 py-1.5 rounded-lg text-text-primary dark:text-text-primary shadow-md"
          >
            <span class="text-lg">‚úì</span>
            <span class="font-medium">Reserva en 2 minutos</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Search Card -->
    <div class="max-w-5xl mx-auto">
      <div
        class="bg-white dark:bg-slate-800 backdrop-blur-xl rounded-3xl shadow-2xl hover:shadow-3xl dark:shadow-slate-950/50 transition-shadow duration-300 p-8 border border-white/20 dark:border-slate-700/50"
      >
        <!-- Search title -->
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">
          Comienza tu b√∫squeda
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Location Search -->
          <div class="relative group">
            <label
              class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 mb-3"
            >
              <svg
                class="w-5 h-5 text-cyan-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              Ubicaci√≥n
            </label>
            <div class="relative">
              <input
                type="text"
                placeholder="¬øD√≥nde necesitas el auto?"
                [value]="selectedLocation() || searchValue()"
                (input)="onLocationInputChange($event)"
                (focus)="showLocationSuggestions.set(true)"
                (blur)="onLocationInputBlur()"
                (keydown.escape)="closeLocationSuggestions()"
                class="w-full px-5 py-4 bg-gray-50 dark:bg-slate-700 border-2 border-gray-200 dark:border-slate-600 rounded-2xl focus:outline-none focus:ring-2 focus:ring-cyan-500 dark:focus:ring-cyan-400 focus:border-transparent text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-400 transition-all duration-200 hover:border-cyan-300 dark:hover:border-cyan-400"
              />

              <!-- Loading indicator -->
              <div
                *ngIf="locationSearchLoading()"
                class="absolute right-4 top-1/2 -translate-y-1/2"
              >
                <div
                  class="animate-spin rounded-full h-5 w-5 border-2 border-cyan-500 border-t-transparent"
                ></div>
              </div>

              <!-- Dropdown de sugerencias -->
              <div
                *ngIf="showLocationSuggestions() && locationSuggestions().length > 0"
                class="absolute z-50 w-full mt-2 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-slate-700 max-h-80 overflow-y-auto"
              >
                <div class="py-2">
                  <button
                    *ngFor="let suggestion of locationSuggestions(); trackBy: trackBySuggestion"
                    (click)="onLocationSuggestionSelect(suggestion)"
                    class="w-full px-5 py-3 text-left hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors flex items-start gap-3 group"
                  >
                    <svg
                      class="w-5 h-5 text-cyan-500 mt-0.5 flex-shrink-0"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                    </svg>
                    <div class="flex-1 min-w-0">
                      <p
                        class="text-sm font-semibold text-gray-900 dark:text-white group-hover:text-cyan-600 dark:group-hover:text-cyan-400"
                      >
                        {{ suggestion.placeName }}
                      </p>
                      <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                        {{ suggestion.fullAddress }}
                      </p>
                    </div>
                  </button>
                </div>
              </div>

              <!-- Mensaje cuando no hay resultados -->
              <div
                *ngIf="
                  showLocationSuggestions() &&
                  !locationSearchLoading() &&
                  locationSuggestions().length === 0 &&
                  (selectedLocation() || searchValue()).length >= 2
                "
                class="absolute z-50 w-full mt-2 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-slate-700 p-4"
              >
                <p class="text-sm text-gray-500 dark:text-gray-400 text-center">
                  No se encontraron ubicaciones
                </p>
              </div>
            </div>
          </div>

          <!-- Date Range -->
          <app-date-search
            [label]="'Fechas'"
            [placeholder]="'¬øCu√°ndo lo necesitas?'"
            [initialFrom]="dateRange().from"
            [initialTo]="dateRange().to"
            [googleCalendarId]="googleCalendarId()"
            [showGoogleCalendar]="true"
            (searchClick)="openDatePicker()"
            (dateChange)="onDateRangeChange($event)"
          ></app-date-search>

          <!-- Search Button -->
          <div class="flex items-end">
            <button
              (click)="onSearchSubmit(searchValue())"
              class="w-full px-6 py-4 bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-600 hover:to-teal-600 text-white font-semibold rounded-2xl shadow-lg hover:shadow-2xl transform hover:scale-[1.02] active:scale-[0.98] transition-all duration-200 flex items-center justify-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              Buscar autos
            </button>
          </div>
        </div>

        <!-- Quick Filters Pills - Modernized -->
        <div class="mt-6 pt-6 border-t border-gray-100 dark:border-slate-700">
          <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-4">Filtros populares</p>
          <div class="flex items-center gap-3 overflow-x-auto pb-2 scrollbar-hide">
            <app-tooltip
              *ngFor="let filter of quickFilters"
              [text]="filter.tooltip || 'Filtrar autos por ' + filter.label.toLowerCase()"
              position="top"
            >
              <button
                (click)="onQuickFilterClick(filter.id)"
                class="group flex items-center gap-2 px-4 py-2.5 bg-gray-100 dark:bg-slate-700 hover:bg-gradient-to-r hover:from-cyan-500 hover:to-teal-500 border border-gray-200 dark:border-slate-600 hover:border-transparent rounded-full text-sm font-medium text-gray-700 dark:text-gray-100 hover:text-white hover:shadow-lg hover:scale-105 active:scale-95 transition-all duration-200 flex-shrink-0"
              >
                <!-- Icon SVG based on filter.id -->
                <svg
                  *ngIf="filter.id === 'immediate'"
                  class="w-4 h-4 transition-transform duration-200 group-hover:scale-110"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
                <svg
                  *ngIf="filter.id === 'verified'"
                  class="w-4 h-4 transition-transform duration-200 group-hover:scale-110"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <svg
                  *ngIf="filter.id === 'no-card'"
                  class="w-4 h-4 transition-transform duration-200 group-hover:scale-110"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                  />
                </svg>
                <svg
                  *ngIf="filter.id === 'near-me'"
                  class="w-4 h-4 transition-transform duration-200 group-hover:scale-110"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <svg
                  *ngIf="filter.id === 'electric'"
                  class="w-4 h-4 transition-transform duration-200 group-hover:scale-110"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 10V3L4 14h7v7l9-11h-7z"
                  />
                </svg>
                <span class="whitespace-nowrap">{{ filter.label }}</span>
              </button>
            </app-tooltip>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Wave separator -->
  <div class="absolute bottom-0 left-0 right-0">
    <svg viewBox="0 0 1440 48" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-12">
      <path
        d="M0 48H1440V0C1440 0 1080 48 720 48C360 48 0 0 0 0V48Z"
        fill="currentColor"
        class="text-text-primary dark:text-text-primary"
      />
    </svg>
  </div>
</div>

<!-- Main Content Area -->
<div class="marketplace-content bg-surface-secondary/30 dark:bg-surface-secondary min-h-screen">
  <div class="max-w-[2000px] mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
    <!-- Stats Strip -->
    <div class="mb-6">
      <app-stats-strip [stats]="statsStripData()" />
    </div>

    <!-- Trust Badges -->
    <div class="mb-12 grid grid-cols-2 md:grid-cols-4 gap-6 lg:gap-8">
      <app-tooltip
        text="Todos nuestros locadores pasan por un proceso de verificaci√≥n exhaustivo con DNI, licencia de conducir y antecedentes"
        position="top"
      >
        <app-card
          variant="elevated"
          padding="lg"
          [hoverable]="true"
          class="flex items-center gap-3"
        >
          <div
            class="w-10 h-10 bg-success-light/20 dark:bg-success-light/30 rounded-full flex items-center justify-center"
          >
            <span class="text-xl">‚úì</span>
          </div>
          <div>
            <p class="text-xs text-text-secondary dark:text-text-secondary">Verificaci√≥n</p>
            <p class="text-sm font-semibold text-text-primary dark:text-text-primary">
              100% Segura
            </p>
          </div>
        </app-card>
      </app-tooltip>

      <app-tooltip
        text="Cobertura completa de seguro para da√±os al veh√≠culo, robo y responsabilidad civil incluida en todas las reservas"
        position="top"
      >
        <app-card
          variant="elevated"
          padding="lg"
          [hoverable]="true"
          class="flex items-center gap-3"
        >
          <div
            class="w-10 h-10 bg-cta-default/20 dark:bg-cta-default/30 rounded-full flex items-center justify-center"
          >
            <span class="text-xl">üõ°Ô∏è</span>
          </div>
          <div>
            <p class="text-xs text-text-secondary dark:text-text-secondary">Seguro</p>
            <p class="text-sm font-semibold text-text-primary dark:text-text-primary">Incluido</p>
          </div>
        </app-card>
      </app-tooltip>

      <app-tooltip
        text="Reserva sin necesidad de tarjeta de cr√©dito. Paga en efectivo al recoger el auto o usa otros m√©todos de pago"
        position="top"
      >
        <app-card
          variant="elevated"
          padding="lg"
          [hoverable]="true"
          class="flex items-center gap-3"
        >
          <div
            class="w-10 h-10 bg-cta-default/20 dark:bg-cta-default/30 rounded-full flex items-center justify-center"
          >
            <span class="text-xl">üí≥</span>
          </div>
          <div>
            <p class="text-xs text-text-secondary dark:text-text-secondary">Sin tarjeta</p>
            <p class="text-sm font-semibold text-text-primary dark:text-text-primary">Requerida</p>
          </div>
        </app-card>
      </app-tooltip>

      <app-tooltip
        text="Entrega inmediata en la mayor√≠a de las ubicaciones. Recoge tu auto en minutos sin esperas innecesarias"
        position="top"
      >
        <app-card
          variant="elevated"
          padding="lg"
          [hoverable]="true"
          class="flex items-center gap-3"
        >
          <div
            class="w-10 h-10 bg-warning-light/20 dark:bg-warning-light/30 rounded-full flex items-center justify-center"
          >
            <span class="text-xl">‚ö°</span>
          </div>
          <div>
            <p class="text-xs text-text-secondary dark:text-text-secondary">Entrega</p>
            <p class="text-sm font-semibold text-text-primary dark:text-text-primary">Inmediata</p>
          </div>
        </app-card>
      </app-tooltip>
    </div>

    <!-- View Toggle -->
    <div class="flex items-center justify-between mb-8 lg:mb-10">
      <h2 class="text-2xl font-bold text-text-primary dark:text-text-primary">
        Autos cerca de ti
        <span class="text-base font-normal text-text-secondary ml-2"
          >({{ carsWithDistance().length }} resultados)</span
        >
      </h2>

      <div class="flex items-center gap-2">
        <!-- View mode toggle -->
        <div class="bg-surface-raised dark:bg-surface-raised rounded-lg p-1 shadow-sm flex">
          <button
            [class.bg-cta-default]="viewMode() === 'grid'"
            [class.text-cta-text]="viewMode() === 'grid'"
            [class.text-text-primary]="viewMode() !== 'grid'"
            (click)="viewMode.set('grid')"
            class="px-3 py-2 rounded-md transition-all duration-200"
          >
            <span class="text-lg">‚ñ¶</span>
          </button>
          <button
            [class.bg-cta-default]="viewMode() === 'list'"
            [class.text-cta-text]="viewMode() === 'list'"
            [class.text-text-primary]="viewMode() !== 'list'"
            (click)="viewMode.set('list')"
            class="px-3 py-2 rounded-md transition-all duration-200"
          >
            <span class="text-lg">‚ò∞</span>
          </button>
          <button
            [class.bg-cta-default]="viewMode() === 'map'"
            [class.text-cta-text]="viewMode() === 'map'"
            [class.text-text-primary]="viewMode() !== 'map'"
            (click)="viewMode.set('map')"
            class="px-3 py-2 rounded-md transition-all duration-200"
          >
            <span class="text-lg">üó∫Ô∏è</span>
          </button>
        </div>

        <!-- Sort dropdown -->
        <select
          class="bg-surface-raised dark:bg-surface-raised border border-border-default dark:border-border-default rounded-lg px-4 py-2 text-sm text-text-primary dark:text-text-primary focus:outline-none focus:ring-2 focus:ring-cta-default"
        >
          <option>M√°s cercanos</option>
          <option>Precio: menor a mayor</option>
          <option>Precio: mayor a menor</option>
          <option>Mejor valorados</option>
        </select>
      </div>
    </div>

    <!-- Grid View -->
    <div
      *ngIf="viewMode() === 'grid'"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 lg:gap-10"
    >
      <div
        *ngFor="let car of carsWithDistance(); trackBy: trackByCarId"
        class="car-card-enhanced group"
        (click)="onCarSelected(car.id)"
      >
        <!-- Enhanced Car Card -->
        <div
          class="bg-surface-raised dark:bg-surface-raised text-text-primary rounded-2xl shadow-md hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:scale-[1.02]"
        >
          <!-- Image Container with Badge -->
          <div class="relative aspect-[4/3] overflow-hidden">
            <img
              [src]="extractPhotoGallery(car)[0] || '/assets/images/car-placeholder.svg'"
              [alt]="car.brand_text_backup + ' ' + car.model_text_backup"
              class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
              loading="lazy"
            />

            <!-- Gradient overlay -->
            <div
              class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"
            ></div>

            <!-- Top badges -->
            <div class="absolute top-3 left-3 flex flex-col gap-2">
              <span
                *ngIf="car.distance && car.distance < 5"
                class="bg-success-light text-text-primary text-xs font-semibold px-2 py-1 rounded-full backdrop-blur-sm"
              >
                ‚ö° Cerca de ti
              </span>
              <span
                *ngIf="getCarInstantBooking(car)"
                class="bg-warning-light text-text-primary text-xs font-semibold px-2 py-1 rounded-full backdrop-blur-sm"
              >
                üî• Reserva instant√°nea
              </span>
            </div>

            <!-- Favorite button -->
            <button
              class="absolute top-3 right-3 w-9 h-9 bg-surface-raised/90 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-surface-raised transition-colors shadow-lg"
            >
              <span class="text-lg">‚ô°</span>
            </button>

            <!-- Distance badge at bottom -->
            <div *ngIf="car.distanceText" class="absolute bottom-3 left-3">
              <span
                class="bg-surface-raised/95 backdrop-blur-sm text-text-primary text-xs font-semibold px-3 py-1.5 rounded-full flex items-center gap-1.5"
              >
                <span>üìç</span>
                <span>{{ car.distanceText }}</span>
              </span>
            </div>

            <!-- Photo counter -->
            <div class="absolute bottom-3 right-3">
              <span
                class="bg-surface-overlay/70 backdrop-blur-sm text-text-inverse text-xs px-2 py-1 rounded-full flex items-center gap-1"
              >
                <span>üì∑</span>
                <span>{{ extractPhotoGallery(car).length }}</span>
              </span>
            </div>
          </div>

          <!-- Card Content -->
          <div class="p-4 text-text-primary">
            <!-- Title and Rating -->
            <div class="mb-3">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="text-lg font-bold text-text-primary dark:text-text-primary truncate">
                  {{ car.brand_text_backup }} {{ car.model_text_backup }}
                </h3>
                <!-- ‚úÖ NEW: Dynamic pricing badge -->
                @if (car.uses_dynamic_pricing) {
                  <app-dynamic-pricing-badge />
                }
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-1 text-xs text-text-secondary">
                  <span class="text-warning-500">‚≠ê</span>
                  <span class="font-semibold">4.8</span>
                  <span>(124 viajes)</span>
                </div>
                <span class="text-xs text-text-secondary">{{ car.location_city }}</span>
              </div>
            </div>

            <!-- Features -->
            <div class="flex items-center gap-3 mb-4 text-xs text-text-secondary">
              <div class="flex items-center gap-1">
                <span>‚öôÔ∏è</span>
                <span>{{ car.transmission || 'Manual' }}</span>
              </div>
              <div class="flex items-center gap-1">
                <span>üë•</span>
                <span>{{ car.seats || 5 }} asientos</span>
              </div>
              <div class="flex items-center gap-1">
                <span>‚õΩ</span>
                <span>{{ car.fuel_type || 'Nafta' }}</span>
              </div>
            </div>

            <!-- Price and CTA -->
            <div
              class="flex items-center justify-between pt-3 border-t border-border-default dark:border-border-muted"
            >
              <div>
                <p class="text-xs text-text-secondary">Desde</p>
                <p class="text-2xl font-bold text-cta-default">
                  ${{ car.price_per_day | number: '1.0-0' }}
                  <span class="text-sm font-normal text-text-secondary">/d√≠a</span>
                </p>
              </div>
              <button
                (click)="onQuickBook(car.id); $event.stopPropagation()"
                class="px-4 py-2 bg-cta-default text-cta-text font-semibold rounded-lg transition-colors shadow-md hover:shadow-lg"
              >
                Reservar
              </button>
            </div>
          </div>

          <!-- Social Proof -->
          <div class="px-4 pb-4 text-text-primary">
            <app-social-proof-indicators [car]="car" />
          </div>
        </div>
      </div>

      <!-- Loading skeleton -->
      <div *ngIf="loading()" class="col-span-full flex items-center justify-center py-12">
        <div class="flex flex-col items-center gap-4">
          <div
            class="animate-spin rounded-full h-12 w-12 border-4 border-cta-default border-t-transparent"
          ></div>
          <p class="text-text-secondary">Cargando autos incre√≠bles...</p>
        </div>
      </div>

      <!-- Empty state -->
      <div *ngIf="!loading() && carsWithDistance().length === 0" class="col-span-full">
        <div class="bg-surface-raised dark:bg-surface-raised rounded-2xl p-12 text-center">
          <div
            class="w-24 h-24 bg-surface-secondary dark:bg-surface-base rounded-full flex items-center justify-center mx-auto mb-4"
          >
            <span class="text-5xl">üîç</span>
          </div>
          <h3 class="text-xl font-bold text-text-primary dark:text-text-primary mb-2">
            No encontramos autos
          </h3>
          <p class="text-text-secondary mb-6">
            Intenta ajustar los filtros o buscar en otra ubicaci√≥n
          </p>
          <button
            class="px-6 py-3 bg-cta-default hover:bg-cta-default/90 text-cta-text font-semibold rounded-lg transition-colors"
          >
            Limpiar filtros
          </button>
        </div>
      </div>
    </div>

    <!-- List View -->
    <div *ngIf="viewMode() === 'list'" class="space-y-6 lg:space-y-8">
      <div
        *ngFor="let car of carsWithDistance(); trackBy: trackByCarId"
        (click)="onCarSelected(car.id)"
        class="bg-surface-raised dark:bg-surface-raised text-text-primary rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden cursor-pointer"
      >
        <div class="flex flex-col md:flex-row">
          <!-- Image -->
          <div class="relative md:w-80 aspect-[16/9] md:aspect-auto overflow-hidden flex-shrink-0">
            <img
              [src]="extractPhotoGallery(car)[0] || '/assets/images/car-placeholder.svg'"
              [alt]="car.brand_text_backup + ' ' + car.model_text_backup"
              class="w-full h-full object-cover hover:scale-110 transition-transform duration-500"
              loading="lazy"
            />
          </div>

          <!-- Content -->
          <div class="flex-1 p-6 flex flex-col justify-between text-text-primary">
            <div>
              <div class="flex items-start justify-between mb-3">
                <div>
                  <div class="flex items-center gap-2 mb-1">
                    <h3 class="text-xl font-bold text-text-primary dark:text-text-primary">
                      {{ car.brand_text_backup }} {{ car.model_text_backup }}
                    </h3>
                    <!-- ‚úÖ NEW: Dynamic pricing badge -->
                    @if (car.uses_dynamic_pricing) {
                      <app-dynamic-pricing-badge />
                    }
                  </div>
                  <div class="flex items-center gap-3 text-sm text-text-secondary">
                    <span class="flex items-center gap-1">
                      <span class="text-warning-500">‚≠ê</span>
                      <span class="font-semibold">4.8</span>
                    </span>
                    <span>‚Ä¢</span>
                    <span>üìç {{ car.distanceText }}</span>
                    <span>‚Ä¢</span>
                    <span>{{ car.location_city }}</span>
                  </div>
                </div>
                <div class="text-right">
                  <p class="text-3xl font-bold text-cta-default">
                    ${{ car.price_per_day | number: '1.0-0' }}
                  </p>
                  <p class="text-sm text-text-secondary">por d√≠a</p>
                </div>
              </div>

              <p *ngIf="car.description" class="text-text-secondary text-sm mb-4 line-clamp-2">
                {{ car.description }}
              </p>

              <div class="flex items-center gap-4 mb-4">
                <span class="flex items-center gap-1.5 text-sm text-text-secondary">
                  <span>‚öôÔ∏è</span>
                  <span>{{ car.transmission || 'Manual' }}</span>
                </span>
                <span class="flex items-center gap-1.5 text-sm text-text-secondary">
                  <span>üë•</span>
                  <span>{{ car.seats || 5 }} asientos</span>
                </span>
                <span class="flex items-center gap-1.5 text-sm text-text-secondary">
                  <span>‚õΩ</span>
                  <span>{{ car.fuel_type || 'Nafta' }}</span>
                </span>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <button
                (click)="onCarSelected(car.id); $event.stopPropagation()"
                class="flex-1 px-6 py-3 bg-surface-secondary dark:bg-surface-base hover:bg-border-default text-text-primary dark:text-text-primary font-semibold rounded-lg transition-colors"
              >
                Ver detalles
              </button>
              <button
                (click)="onQuickBook(car.id); $event.stopPropagation()"
                class="flex-1 px-6 py-3 bg-cta-default hover:bg-cta-default/90 text-cta-text font-semibold rounded-lg transition-colors shadow-md"
              >
                Reservar ahora
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Map View -->
    <div
      *ngIf="viewMode() === 'map'"
      class="relative h-[calc(100vh-400px)] min-h-[600px] rounded-2xl overflow-hidden shadow-2xl"
    >
      <app-cars-map
        [cars]="carMapLocations()"
        [selectedCarId]="selectedCarId()"
        [userLocation]="userLocation()"
        [markerVariant]="contextualMarkerVariant()"
        [searchRadiusKm]="radiusKm()"
        [showSearchRadius]="true"
        (carSelected)="onCarSelected($event)"
        (quickBook)="onQuickBook($event)"
        (userLocationChange)="onUserLocationChange($event)"
        (searchRadiusChange)="onSearchRadiusChange($event)"
        class="w-full h-full"
      />
    </div>
  </div>
</div>

<!-- Quick Booking Modal -->
<app-quick-booking-modal
  *ngIf="quickBookingCar()"
  [car]="quickBookingCar()!"
  [userLocation]="userLocation() || undefined"
  [isOpen]="quickBookingModalOpen()"
  (confirmBooking)="onQuickBookingConfirm($event)"
  (cancelBooking)="onQuickBookingCancel()"
/>

<!-- Filters Sheet -->
<div
  *ngIf="showFilters()"
  class="fixed inset-0 z-[999] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm p-4"
  (click)="closeFiltersPanel()"
>
  <div
    class="w-full max-w-4xl bg-white dark:bg-slate-900 rounded-3xl shadow-2xl overflow-hidden border border-white/20 dark:border-slate-700/60"
    (click)="$event.stopPropagation()"
  >
    <div
      class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-slate-700"
    >
      <div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Filtros avanzados</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          Personaliz√° tu b√∫squeda para encontrar el auto perfecto
        </p>
      </div>
      <button
        type="button"
        class="w-10 h-10 rounded-full bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-200 flex items-center justify-center hover:scale-105 transition-transform"
        aria-label="Cerrar filtros"
        (click)="closeFiltersPanel()"
      >
        ‚úï
      </button>
    </div>
    <div class="max-h-[80vh] overflow-y-auto p-6">
      <app-map-filters
        [availableCars]="carMapLocations()"
        [userLocation]="userLocation() || undefined"
        (filterChange)="onFiltersChange($event)"
      ></app-map-filters>
    </div>
  </div>
</div>

<!-- Floating Action Button -->
<app-floating-action-fab
  [actions]="fabActions"
  position="bottom-right"
  (actionClick)="onFabActionClick($event)"
/>

<!-- Date Picker Modal -->
<div
  *ngIf="showDatePicker()"
  class="fixed inset-0 z-50 flex items-start justify-center pt-6 px-4"
  (click)="closeDatePicker()"
>
  <div
    class="w-full max-w-lg bg-white dark:bg-slate-800 rounded-3xl shadow-2xl border border-gray-100 dark:border-slate-700/50 overflow-hidden transform transition-all duration-300"
    (click)="$event.stopPropagation()"
  >
    <!-- Header con gradiente de marca -->
    <div
      class="bg-gradient-to-r from-cyan-500 via-cyan-400 to-teal-500 px-5 py-4 flex items-center justify-between"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center"
        >
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            />
          </svg>
        </div>
        <h3 class="text-lg font-bold text-white">Selecciona las fechas</h3>
      </div>
      <button
        (click)="closeDatePicker()"
        class="w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg flex items-center justify-center transition-all duration-200 hover:scale-110"
        aria-label="Cerrar"
      >
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <!-- Contenido -->
    <div
      class="p-5 bg-gradient-to-b from-white to-gray-50/50 dark:from-slate-800 dark:to-slate-900/50"
    >
      <app-date-range-picker
        [initialFrom]="dateRange().from"
        [initialTo]="dateRange().to"
        (rangeChange)="onDateRangeChange($event)"
      />

      <!-- Footer con bot√≥n de acci√≥n -->
      <div
        class="mt-5 pt-4 border-t border-gray-200 dark:border-slate-700/50 flex items-center justify-end gap-3"
      >
        <button
          (click)="closeDatePicker()"
          class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors"
        >
          Cancelar
        </button>
        <button
          (click)="closeDatePicker()"
          class="px-6 py-2.5 bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-600 hover:to-teal-600 text-white font-semibold rounded-xl text-sm shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 transition-all duration-200 flex items-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
          Aplicar fechas
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Location Picker Modal -->
<div
  *ngIf="showLocationPicker()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
  (click)="closeLocationPicker()"
>
  <div
    class="w-full max-w-lg bg-white dark:bg-slate-800 rounded-3xl shadow-2xl overflow-hidden"
    (click)="$event.stopPropagation()"
  >
    <div
      class="px-6 py-4 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between"
    >
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Selecciona la ubicaci√≥n</h3>
      <button
        (click)="closeLocationPicker()"
        class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors"
      >
        <svg
          class="w-6 h-6 text-gray-600 dark:text-gray-300"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>
    <div class="p-6">
      <!-- Search input -->
      <div class="mb-4">
        <input
          type="text"
          placeholder="Buscar ubicaci√≥n..."
          [value]="selectedLocation()"
          (input)="selectedLocation.set($any($event.target).value)"
          class="w-full px-4 py-3 bg-gray-50 dark:bg-slate-700 border-2 border-gray-200 dark:border-slate-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-cyan-500 dark:focus:ring-cyan-400 text-gray-900 dark:text-white placeholder:text-gray-400"
        />
      </div>

      <!-- Popular locations -->
      <div class="space-y-2">
        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-3">
          Ubicaciones populares
        </p>
        <button
          *ngFor="let location of ['Buenos Aires', 'C√≥rdoba', 'Rosario', 'Mendoza', 'La Plata']"
          (click)="onLocationSelect(location)"
          class="w-full px-4 py-3 text-left bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600 rounded-xl transition-colors text-gray-900 dark:text-white"
        >
          <div class="flex items-center gap-3">
            <svg
              class="w-5 h-5 text-cyan-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
              />
            </svg>
            <span>{{ location }}</span>
          </div>
        </button>
      </div>

      <!-- Use my location button -->
      <button
        (click)="onLogoClick()"
        class="w-full mt-4 px-4 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-600 hover:to-teal-600 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center gap-2"
      >
        <span class="text-xl">üìç</span>
        Usar mi ubicaci√≥n
      </button>
    </div>
  </div>
</div>

<!-- Mobile Bottom Nav -->
<app-mobile-bottom-nav />

<!-- WhatsApp FAB -->
<app-whatsapp-fab />

<!-- Price Transparency Modal -->
@if (showPriceTransparencyModal()) {
  <app-price-transparency-modal (closed)="onPriceTransparencyModalClose()" />
}
