<ng-container *ngIf="car(); else loadingOrError">
  <!-- 🎨 Layout Premium: Grid 2 columnas en desktop -->
  <section class="grid gap-4 sm:gap-6 lg:gap-8 lg:grid-cols-[2fr_1fr]">

    <!-- 📸 COLUMNA IZQUIERDA: Fotos e Información del Auto -->
    <div class="space-y-4 sm:space-y-6">

      <!-- Galería de fotos premium con carousel -->
      <div class="card-premium car-gallery rounded-2xl border border-pearl-gray bg-white-pure p-4 sm:p-6 shadow-soft">
        <!-- Foto principal con navegación -->
        <div class="relative mb-4">
          <img
            *ngIf="currentPhoto(); else placeholderPremium"
            [src]="currentPhoto()!.url"
            [alt]="car()?.title ?? ''"
            class="h-80 w-full rounded-xl object-cover shadow-medium"
          />
          <ng-template #placeholderPremium>
            <div class="flex h-80 items-center justify-center rounded-xl bg-gradient-to-br from-accent-warm/10 to-accent-petrol/10">
              <div class="text-center">
                <svg class="mx-auto mb-4 h-24 w-24 text-accent-warm/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <circle cx="7" cy="17" r="2" stroke-width="1.5"/>
                  <circle cx="17" cy="17" r="2" stroke-width="1.5"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 15h14M8 12l1-4h6l1 4"/>
                </svg>
                <p class="text-sm font-medium text-charcoal-medium">Sin fotos disponibles</p>
              </div>
            </div>
          </ng-template>

          <!-- Botones de navegación -->
          <div *ngIf="hasMultiplePhotos()" class="absolute inset-0 flex items-center justify-between px-4">
            <button
              type="button"
              (click)="previousPhoto()"
              aria-label="Ver foto anterior"
              class="flex h-12 w-12 items-center justify-center rounded-full bg-white-pure/90 text-smoke-black shadow-medium backdrop-blur-sm transition-all hover:bg-white-pure hover:scale-110 focus:outline-none focus:ring-2 focus:ring-accent-petrol focus:ring-offset-2"
            >
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
            <button
              type="button"
              (click)="nextPhoto()"
              aria-label="Ver foto siguiente"
              class="flex h-12 w-12 items-center justify-center rounded-full bg-white-pure/90 text-smoke-black shadow-medium backdrop-blur-sm transition-all hover:bg-white-pure hover:scale-110 focus:outline-none focus:ring-2 focus:ring-accent-petrol focus:ring-offset-2"
            >
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
          </div>

          <!-- Contador de fotos -->
          <div *ngIf="hasMultiplePhotos()" class="absolute bottom-4 right-4 rounded-full bg-smoke-black/70 px-3 py-1 text-xs font-medium text-white-pure backdrop-blur-sm">
            {{ currentPhotoIndex() + 1 }} / {{ allPhotos().length }}
          </div>
        </div>

        <!-- Miniaturas -->
        <div *ngIf="hasMultiplePhotos()" class="grid grid-cols-4 gap-2 md:grid-cols-6">
          <button
            *ngFor="let photo of allPhotos(); let i = index"
            type="button"
            (click)="goToPhoto(i)"
            [class.ring-2]="currentPhotoIndex() === i"
            [class.ring-accent-petrol]="currentPhotoIndex() === i"
            [class.opacity-50]="currentPhotoIndex() !== i"
            class="aspect-square overflow-hidden rounded-lg transition-all hover:opacity-100"
          >
            <img
              [src]="photo.url"
              [alt]="'Foto ' + (i + 1)"
              loading="lazy"
              decoding="async"
              width="100"
              height="100"
              class="h-full w-full object-cover"
            />
          </button>
        </div>
      </div>

      <!-- Título y ubicación -->
      <div class="space-y-3">
        <div class="flex items-start justify-between gap-4">
          <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-tight text-smoke-black">{{ car()?.title }}</h1>

          <!-- Share Menu -->
          <app-share-menu
            [title]="car()?.title || 'Auto en Autorentar'"
            [text]="'Mirá este auto increíble en Autorentar: ' + (car()?.title || '')"
            [url]="'https://autorenta-web.pages.dev/cars/' + car()?.id"
          ></app-share-menu>
        </div>

        <!-- Ubicación con ícono y botón de navegación -->
        <div class="space-y-2">
          <div class="flex items-start gap-2 text-charcoal-medium dark:text-pearl-light/70">
            <svg class="mt-0.5 h-5 w-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <p class="text-base">
              <ng-container *ngIf="car()?.location_formatted_address; else oldLocation">
                {{ car()?.location_formatted_address }}
              </ng-container>
              <ng-template #oldLocation>
                {{ car()?.location_city }}, {{ car()?.location_state }}
              </ng-template>
            </p>
          </div>

          <!-- Botones de navegación -->
          <div class="flex gap-2 ml-7">
            <button
              (click)="getDirectionsFromCurrentLocation()"
              *ngIf="car()?.location_lat && car()?.location_lng"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-accent-petrol dark:bg-accent-petrol/90 hover:bg-accent-petrol/90 dark:hover:bg-accent-petrol text-white-pure font-semibold text-sm transition-all shadow-sm hover:shadow-md"
            >
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
              </svg>
              {{ 'navigation.getDirections' | translate }}
            </button>

            <button
              (click)="openNavigation()"
              *ngIf="car()?.location_lat && car()?.location_lng"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-accent-petrol dark:border-accent-petrol/80 text-accent-petrol dark:text-accent-petrol/90 hover:bg-accent-petrol/5 dark:hover:bg-accent-petrol/10 font-semibold text-sm transition-all"
              title="Abrir en app de mapas"
            >
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
              </svg>
              <span class="hidden sm:inline">{{ 'navigation.openMap' | translate }}</span>
            </button>
          </div>
        </div>

        <!-- Rating y reviews -->
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-1">
            <svg class="h-5 w-5 text-accent-warm" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            <span class="font-semibold text-smoke-black">{{ car()?.rating_avg || 'Nuevo' }}</span>
          </div>
          <span class="text-sm text-ash-gray">{{ car()?.rating_count || 0 }} {{ 'carDetail.reviews' | translate }}</span>
        </div>
      </div>

      <!-- Especificaciones del auto -->
      <div class="card-premium rounded-2xl border border-pearl-gray bg-white-pure p-4 sm:p-6 shadow-soft">
        <h2 class="h4 mb-4">Especificaciones</h2>
        <div class="grid grid-cols-2 gap-4 md:grid-cols-3">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sand-light">
              <svg class="h-5 w-5 text-accent-petrol" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
              </svg>
            </div>
            <div>
              <p class="text-xs text-ash-gray">Transmisión</p>
              <p class="font-semibold text-smoke-black">{{ car()?.transmission | titlecase }}</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sand-light">
              <svg class="h-5 w-5 text-accent-petrol" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </div>
            <div>
              <p class="text-xs text-ash-gray">Combustible</p>
              <p class="font-semibold text-smoke-black">{{ car()?.fuel_type | titlecase }}</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sand-light">
              <svg class="h-5 w-5 text-accent-petrol" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
            </div>
            <div>
              <p class="text-xs text-ash-gray">Asientos</p>
              <p class="font-semibold text-smoke-black">{{ car()?.seats }} personas</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sand-light">
              <svg class="h-5 w-5 text-accent-petrol" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
            </div>
            <div>
              <p class="text-xs text-ash-gray">Año</p>
              <p class="font-semibold text-smoke-black">{{ car()?.year }}</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sand-light">
              <svg class="h-5 w-5 text-accent-petrol" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
              </svg>
            </div>
            <div>
              <p class="text-xs text-ash-gray">Color</p>
              <p class="font-semibold text-smoke-black">{{ car()?.color | titlecase }}</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sand-light">
              <svg class="h-5 w-5 text-accent-petrol" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
              </svg>
            </div>
            <div>
              <p class="text-xs text-ash-gray">Puertas</p>
              <p class="font-semibold text-smoke-black">{{ car()?.doors }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Descripción -->
      <div class="card-premium rounded-2xl border border-pearl-gray bg-white-pure p-4 sm:p-6 shadow-soft">
        <h2 class="h4 mb-3">Descripción</h2>
        <p class="leading-relaxed text-charcoal-medium">
          {{ car()?.description || 'Sin descripción disponible' }}
        </p>
      </div>

      <!-- Información del dueño/anfitrión -->
      <div *ngIf="car()?.owner && authService.isAuthenticated()" class="card-premium rounded-2xl border border-pearl-gray bg-white-pure p-4 sm:p-6 shadow-soft">
        <h2 class="h4 mb-4">{{ 'carDetail.host' | translate }}</h2>

        <div class="flex items-start gap-4">
          <!-- Avatar del dueño (clickeable) -->
          <a
            [routerLink]="['/users', car()!.owner!.id]"
            class="flex-shrink-0 transition-opacity hover:opacity-80 focus:outline-none focus:ring-2 focus:ring-accent-petrol focus:ring-offset-2 rounded-full"
          >
            <img
              *ngIf="car()?.owner?.avatar_url; else defaultAvatar"
              [src]="car()!.owner!.avatar_url!"
              [alt]="car()!.owner!.full_name"
              loading="lazy"
              decoding="async"
              width="64"
              height="64"
              class="h-16 w-16 rounded-full object-cover ring-2 ring-sand-light"
            />
            <ng-template #defaultAvatar>
              <div class="flex h-16 w-16 items-center justify-center rounded-full bg-sand-light ring-2 ring-pearl-gray">
                <svg class="h-8 w-8 text-charcoal-medium" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                </svg>
              </div>
            </ng-template>
          </a>

          <!-- Información del dueño -->
          <div class="flex-1">
            <a
              [routerLink]="['/users', car()!.owner!.id]"
              class="inline-block text-lg font-semibold text-smoke-black dark:text-ivory-luminous hover:text-accent-petrol dark:hover:text-accent-petrol transition-colors focus:outline-none focus:underline"
            >
              {{ car()?.owner?.full_name }}
            </a>

            <!-- Rating y verificaciones -->
            <div class="mt-2 flex flex-wrap items-center gap-3">
              <!-- Rating del anfitrión -->
              <div *ngIf="car()?.owner && car()!.owner!.rating_count && car()!.owner!.rating_count > 0" class="flex items-center gap-1 text-sm">
                <svg class="h-4 w-4 text-accent-warm" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span class="font-semibold text-smoke-black">{{ car()?.owner?.rating_avg | number:'1.1-1' }}</span>
                <span class="text-ash-gray">({{ car()?.owner?.rating_count }} {{ 'carDetail.reviews' | translate }})</span>
              </div>

              <!-- Badge de nuevo anfitrión -->
              <div *ngIf="car()?.owner && (!car()!.owner!.rating_count || car()!.owner!.rating_count === 0)" class="rounded-full bg-sand-light px-2 py-0.5 text-xs font-medium text-charcoal-medium">
                {{ 'carDetail.newHost' | translate }}
              </div>
            </div>

            <!-- Verificaciones -->
            <div class="mt-3 flex flex-wrap gap-2">
              <div *ngIf="car()?.owner?.is_email_verified" class="flex items-center gap-1 text-xs text-accent-petrol">
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                  <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                </svg>
                <span>{{ 'publicProfile.badges.emailVerified' | translate }}</span>
              </div>

              <div *ngIf="car()?.owner?.is_phone_verified" class="flex items-center gap-1 text-xs text-accent-petrol">
                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                </svg>
                <span>{{ 'publicProfile.badges.phoneVerified' | translate }}</span>
              </div>
            </div>

            <!-- Tiempo en la plataforma -->
            <p class="mt-3 text-sm text-ash-gray dark:text-pearl-light/60">
              {{ 'publicProfile.memberSince' | translate }} {{ car()?.owner?.created_at | date:'MMM yyyy' }}
            </p>

            <!-- Botón Ver Perfil -->
            <a
              [routerLink]="['/users', car()!.owner!.id]"
              class="mt-4 inline-flex items-center gap-2 rounded-lg bg-sand-light dark:bg-slate-deep/40 px-4 py-2 text-sm font-semibold text-smoke-black dark:text-ivory-luminous hover:bg-accent-petrol/10 dark:hover:bg-accent-petrol/20 transition-colors focus:outline-none focus:ring-2 focus:ring-accent-petrol focus:ring-offset-2"
            >
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              {{ 'carDetail.viewFullProfile' | translate }}
            </a>
          </div>
        </div>
      </div>

      <!-- Información pública del anfitrión (sin login) -->
      <div *ngIf="car()?.owner && !authService.isAuthenticated()" class="card-premium rounded-2xl border border-pearl-gray bg-white-pure p-4 sm:p-6 shadow-soft">
        <h2 class="h4 mb-4">{{ 'carDetail.host' | translate }}</h2>

        <div class="flex items-start gap-4 mb-6">
          <!-- Avatar del anfitrión (solo visual, sin link) -->
          <div class="flex-shrink-0">
            <img
              *ngIf="car()?.owner?.avatar_url; else defaultAvatarPublic"
              [src]="car()!.owner!.avatar_url!"
              [alt]="car()!.owner!.full_name || ('carDetail.host' | translate)"
              loading="lazy"
              decoding="async"
              width="64"
              height="64"
              class="h-16 w-16 rounded-full object-cover ring-2 ring-sand-light"
            />
            <ng-template #defaultAvatarPublic>
              <div class="flex h-16 w-16 items-center justify-center rounded-full bg-sand-light ring-2 ring-pearl-gray">
                <svg class="h-8 w-8 text-charcoal-medium" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                </svg>
              </div>
            </ng-template>
          </div>

          <!-- Información básica del anfitrión -->
          <div class="flex-1">
            <p class="text-lg font-semibold text-smoke-black dark:text-ivory-luminous">
              {{ car()?.owner?.full_name || ('carDetail.host' | translate) }}
            </p>

            <!-- Rating del anfitrión (público) -->
            <div class="mt-2 flex flex-wrap items-center gap-3">
              <div *ngIf="car()?.owner && car()!.owner!.rating_count && car()!.owner!.rating_count > 0" class="flex items-center gap-1 text-sm">
                <svg class="h-4 w-4 text-accent-warm" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                <span class="font-semibold text-smoke-black dark:text-ivory-luminous">{{ car()?.owner?.rating_avg | number:'1.1-1' }}</span>
                <span class="text-ash-gray dark:text-pearl-light/70">({{ car()?.owner?.rating_count }} {{ 'carDetail.reviews' | translate }})</span>
              </div>

              <!-- Badge de nuevo anfitrión (público) -->
              <div *ngIf="car()?.owner && (!car()!.owner!.rating_count || car()!.owner!.rating_count === 0)" class="rounded-full bg-sand-light px-2 py-0.5 text-xs font-medium text-charcoal-medium">
                {{ 'carDetail.newHost' | translate }}
              </div>
            </div>

            <!-- Tiempo en la plataforma (público) -->
            <p class="mt-3 text-sm text-ash-gray dark:text-pearl-light/60">
              {{ 'publicProfile.memberSince' | translate }} {{ car()?.owner?.created_at | date:'MMM yyyy' }}
            </p>
          </div>
        </div>

        <!-- Mensaje para iniciar sesión y ver más -->
        <div class="rounded-xl bg-accent-petrol/5 border border-accent-petrol/20 p-4 text-center">
          <svg class="mx-auto mb-3 h-10 w-10 text-accent-petrol/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
          </svg>
          <p class="mb-2 text-sm font-semibold text-smoke-black dark:text-ivory-luminous">{{ 'carDetail.loginToViewProfile' | translate }}</p>
          <p class="mb-4 text-xs text-charcoal-medium dark:text-pearl-light/70">{{ 'carDetail.loginDescription' | translate }}</p>
          <a routerLink="/auth/login" class="btn-primary inline-block px-6 py-2 text-sm font-semibold">
            {{ 'auth.login' | translate }}
          </a>
        </div>
      </div>

      <!-- Términos y condiciones del dueño -->
      <div *ngIf="car()?.terms_and_conditions" class="card-premium rounded-2xl border border-pearl-gray bg-white-pure p-4 sm:p-6 shadow-soft">
        <h2 class="h4 mb-3">Términos y Condiciones</h2>
        <p class="whitespace-pre-line leading-relaxed text-charcoal-medium">
          {{ car()?.terms_and_conditions }}
        </p>
      </div>

      <!-- Reviews Section -->
      <div id="reviews" class="card-premium reviews-section rounded-2xl border border-pearl-gray bg-white-pure p-4 sm:p-6 shadow-soft">
        <div class="mb-4 sm:mb-6">
          <h2 class="h3 mb-2">⭐ Calificaciones y Reseñas</h2>

          <!-- Stats Summary -->
          <div *ngIf="carStats() as stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-sand-light rounded-xl">
            <div class="text-center">
              <div class="text-3xl font-bold text-accent-petrol">{{ stats.rating_avg | number:'1.1-1' }}</div>
              <div class="text-xs text-ash-gray">Calificación</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-smoke-black">{{ stats.reviews_count }}</div>
              <div class="text-xs text-ash-gray">Reseñas</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-smoke-black">{{ stats.completed_bookings }}</div>
              <div class="text-xs text-ash-gray">Viajes</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-accent-petrol">{{ (1 - stats.cancellation_rate) * 100 | number:'1.0-0' }}%</div>
              <div class="text-xs text-ash-gray">Éxito</div>
            </div>
          </div>

          <!-- Category Ratings -->
          <div *ngIf="carStats() && carStats()!.reviews_count > 0" class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
            <div class="flex items-center justify-between p-3 bg-white-pure rounded-lg border border-pearl-gray">
              <span class="text-sm text-charcoal-medium">🧼 Limpieza</span>
              <span class="font-semibold text-smoke-black">{{ carStats()!.rating_cleanliness_avg | number:'1.1-1' }}</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white-pure rounded-lg border border-pearl-gray">
              <span class="text-sm text-charcoal-medium">💬 Comunicación</span>
              <span class="font-semibold text-smoke-black">{{ carStats()!.rating_communication_avg | number:'1.1-1' }}</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white-pure rounded-lg border border-pearl-gray">
              <span class="text-sm text-charcoal-medium">✓ Precisión</span>
              <span class="font-semibold text-smoke-black">{{ carStats()!.rating_accuracy_avg | number:'1.1-1' }}</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white-pure rounded-lg border border-pearl-gray">
              <span class="text-sm text-charcoal-medium">📍 Ubicación</span>
              <span class="font-semibold text-smoke-black">{{ carStats()!.rating_location_avg | number:'1.1-1' }}</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white-pure rounded-lg border border-pearl-gray">
              <span class="text-sm text-charcoal-medium">🔑 Check-in</span>
              <span class="font-semibold text-smoke-black">{{ carStats()!.rating_checkin_avg | number:'1.1-1' }}</span>
            </div>
            <div class="flex items-center justify-between p-3 bg-white-pure rounded-lg border border-pearl-gray">
              <span class="text-sm text-charcoal-medium">💰 Valor</span>
              <span class="font-semibold text-smoke-black">{{ carStats()!.rating_value_avg | number:'1.1-1' }}</span>
            </div>
          </div>
        </div>

        <!-- Reviews List -->
        <div *ngIf="reviewsLoading()" class="text-center py-8">
          <p class="text-ash-gray">Cargando reseñas...</p>
        </div>

        <div *ngIf="!reviewsLoading() && reviews().length === 0" class="text-center py-8">
          <p class="text-ash-gray">Este auto aún no tiene reseñas. ¡Sé el primero en reservarlo!</p>
        </div>

        <div *ngIf="!reviewsLoading() && reviews().length > 0" class="space-y-4">
          <app-review-card
            *ngFor="let review of reviews()"
            [review]="review"
            [showCarTitle]="false"
          ></app-review-card>
        </div>
      </div>

      <!-- Botón volver -->
      <a routerLink="/cars" class="inline-flex items-center gap-2 text-sm font-medium text-accent-petrol hover:text-accent-petrol/80">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        Volver a buscar
      </a>
    </div>

    <!-- 💰 COLUMNA DERECHA: Booking Card -->
    <aside class="space-y-4">
      <!-- Card de reserva -->
      <div class="card-premium lg:sticky lg:top-24 rounded-2xl border border-pearl-gray bg-white-pure p-4 sm:p-6 shadow-elevated">
        <!-- Dynamic Pricing Display (si hay region_id) -->
        <div *ngIf="useDynamicPricing()" class="mb-6">
          <app-dynamic-price-display
            [regionId]="car()!['region_id']!"
            [rentalStart]="rentalStartDate().toISOString()"
            [rentalHours]="rentalHours()"
            [carId]="car()!.id"
            [showTotal]="true"
            [showBreakdown]="true"
            [autoRefresh]="false"
          />
        </div>

        <!-- Precio estático (fallback si no hay region_id) -->
        <div *ngIf="!useDynamicPricing()" class="mb-6">
          <p class="text-3xl font-bold text-smoke-black">
            {{ car()?.price_per_day | money }}
          </p>
          <p class="text-sm text-charcoal-medium">por día</p>
        </div>

        <!-- Wallet Balance Display -->
        <div *ngIf="availableBalance() > 0" class="mb-6 rounded-xl border border-emerald-200 bg-emerald-50 p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <svg class="h-5 w-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
              </svg>
              <span class="text-sm font-medium text-emerald-900">Tu Wallet</span>
            </div>
            <span class="text-lg font-bold text-emerald-700">${{ availableBalance() | number:'1.2-2' }}</span>
          </div>
          <p class="mt-2 text-xs text-emerald-700">
            Podés usar tu saldo para pagar esta reserva
          </p>
        </div>

        <!-- Selector de fechas -->
        <div class="mb-6">
          <app-date-range-picker
            label="Fechas de alquiler"
            (rangeChange)="onRangeChange($event)"
          ></app-date-range-picker>
        </div>

        <!-- Payment Method Selector con Wallet -->
        <div *ngIf="totalPrice() as total" class="mb-6">
          <app-payment-method-selector
            [totalAmount]="total"
            (paymentMethodChange)="onPaymentMethodChange($event)"
          ></app-payment-method-selector>
        </div>

        <!-- Desglose de precios -->
        <div *ngIf="totalPrice() as total" class="mb-6 space-y-3">
          <div class="rounded-xl bg-sand-light p-4">
            <h3 class="mb-3 text-sm font-semibold text-smoke-black">Resumen de Precios</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-charcoal-medium">{{ car()?.price_per_day | money }} x {{ daysCount() }} días</span>
                <span class="font-semibold text-smoke-black">{{ total | money }}</span>
              </div>
              <div *ngIf="car()?.deposit_required && car()?.deposit_amount" class="flex justify-between">
                <span class="text-charcoal-medium">Depósito de seguridad</span>
                <span class="font-semibold text-smoke-black">{{ car()?.deposit_amount | money }}</span>
              </div>
              <div class="border-t border-pearl-gray pt-2">
                <div class="flex justify-between">
                  <span class="font-semibold text-smoke-black">Total</span>
                  <span class="text-xl font-bold text-smoke-black">{{ totalWithDeposit() | money }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Información del depósito -->
          <div *ngIf="car()?.deposit_required" class="rounded-lg bg-accent-petrol/10 p-3 insurance-info">
            <p class="text-xs text-accent-petrol">
              <svg class="mb-1 inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              El depósito de seguridad se devolverá al finalizar el alquiler
            </p>
          </div>
        </div>

        <!-- Mensajes de error -->
        <div
          *ngIf="bookingError()"
          class="mb-4 rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-800"
        >
          {{ bookingError() }}
        </div>

        <!-- Botón de reserva -->
        <button
          id="book-now"
          *ngIf="authService.isAuthenticated()"
          (click)="onBookClick()"
          [disabled]="!canBook() || bookingInProgress()"
          [class.opacity-50]="!canBook() || bookingInProgress()"
          [class.cursor-not-allowed]="!canBook() || bookingInProgress()"
          class="btn-primary w-full py-3 text-base font-semibold disabled:hover:bg-smoke-black"
        >
          <span *ngIf="!bookingInProgress()">Solicitar reserva</span>
          <span *ngIf="bookingInProgress()">Procesando...</span>
        </button>

        <!-- Botón para usuarios no autenticados -->
        <button
          *ngIf="!authService.isAuthenticated()"
          (click)="navigateToLogin()"
          class="btn-primary w-full py-3 text-base font-semibold"
        >
          Inicia sesión para reservar
        </button>

        <!-- Información adicional -->
        <div class="mt-4 space-y-2 text-xs text-ash-gray">
          <p class="flex items-center gap-2">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Cancelación gratuita hasta 24hs antes
          </p>
          <p class="flex items-center gap-2">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
            Pago seguro con Mercado Pago
          </p>
        </div>
      </div>
    </aside>
  </section>
</ng-container>

<ng-template #loadingOrError>
  <p *ngIf="loading(); else errorTpl" class="text-center text-sm text-slate-500">
    Cargando auto...
  </p>
</ng-template>

<ng-template #errorTpl>
  <p class="text-center text-sm text-red-600">{{ error() ?? 'No pudimos cargar el auto.' }}</p>
</ng-template>
