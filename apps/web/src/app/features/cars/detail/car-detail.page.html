<!-- Breadcrumbs navigation -->
<!-- TODO: Re-add when breadcrumbs component is created -->
<!-- <app-breadcrumbs [items]="breadcrumbItems()" /> -->

@if (car()) {
  <!-- ✅ HEADER & TITLE SECTION (Fuera del grid principal) -->
  <header class="max-w-7xl mx-auto px-4 pt-4 md:pt-6 pb-4">
    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold tracking-tight text-text-primary mb-2 text-balance font-satoshi">
      {{ displayTitle() }}
    </h1>
    <div class="flex flex-wrap items-center justify-between gap-4 text-sm">
      <!-- Rating & Location -->
      <div class="flex items-center flex-wrap gap-2 md:gap-4 text-xs md:text-sm">
        <div class="flex items-center gap-1 font-semibold">
          <app-icon name="star-filled" [size]="16" cssClass="text-text-primary" />
          <span class="text-text-primary">{{ car()?.rating_avg || 'Nuevo' }}</span>
          <span class="text-text-secondary font-normal mx-1">·</span>
          <a
            href="#reviews"
            class="text-text-primary underline font-medium hover:text-text-secondary"
            >{{ car()?.rating_count || 0 }} reseñas</a
            >
          </div>
          <div class="hidden sm:block w-1 h-1 bg-text-secondary rounded-full"></div>
          <div
            class="flex items-center gap-1 text-text-primary font-medium underline cursor-pointer hover:text-text-secondary line-clamp-1"
            >
            @if (car()?.location_formatted_address) {
              {{ car()?.location_formatted_address }}
            } @else {
              {{ car()?.location_city }}, {{ car()?.location_state }}
            }
          </div>
          @if (distanceKm() !== null && distanceKm() !== undefined) {
            <span
              class="px-2 py-0.5 bg-surface-raised border border-border-default rounded text-xs text-text-secondary whitespace-nowrap"
              >
              a {{ distanceKm() | number: '1.1-1' }} km
            </span>
          }
        </div>
        <!-- Share Buttons (Icon only on mobile) -->
        <div class="flex items-center gap-2">
          <button
            class="flex items-center gap-2 px-2 md:px-3 py-2 rounded-lg hover:bg-surface-raised transition-colors text-text-primary text-sm font-medium"
            aria-label="Compartir"
            >
            <app-icon name="share" [size]="20" />
            <span class="hidden md:inline underline decoration-transparent hover:decoration-text-primary font-friendly">Compartir</span>
          </button>
          <button
            class="flex items-center gap-2 px-2 md:px-3 py-2 rounded-lg hover:bg-surface-raised transition-colors text-text-primary text-sm font-medium"
            aria-label="Guardar en favoritos"
            >
            <app-icon name="heart" [size]="20" />
            <span class="hidden md:inline underline decoration-transparent hover:decoration-text-primary">Guardar</span>
          </button>
        </div>
      </div>
    </header>
    <!-- ✅ HERO GALLERY (Grid Mosaico) -->
    <div class="max-w-7xl mx-auto px-0 md:px-4 mb-8">
      <div
        class="grid grid-cols-1 md:grid-cols-4 gap-2 h-[280px] sm:h-[350px] md:h-[400px] md:rounded-2xl overflow-hidden relative"
        >
        <!-- Foto Principal (Grande) -->
        <div
          class="md:col-span-2 md:row-span-2 h-full bg-surface-secondary relative group cursor-pointer"
          >
          <img
            [src]="heroPhotoUrls()[0]"
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            [alt]="displayTitle() + ' - Vista principal'"
            loading="eager"
            decoding="async"
            (error)="onImgError($event)"
            />
          <!-- Botón Ver Fotos (Visible en móvil sobre la imagen) -->
          <button
            class="md:hidden absolute bottom-4 right-4 bg-black/70 backdrop-blur-md text-white px-3 py-1.5 rounded-lg text-xs font-semibold shadow-md flex items-center gap-2 border border-white/20"
            >
            <app-icon name="grid" [size]="14" />
            1/{{ car()?.photos?.length || 1 }}
          </button>
        </div>
        <!-- Fotos Secundarias (Hidden on mobile) -->
        <div class="hidden md:block h-full bg-surface-secondary relative group cursor-pointer">
          <img
            [src]="heroPhotoUrls()[1]"
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            [alt]="displayTitle() + ' - Vista 2'"
            loading="lazy"
            decoding="async"
            (error)="onImgError($event)"
            />
        </div>
        <div
          class="hidden md:block h-full bg-surface-secondary relative group cursor-pointer rounded-tr-2xl"
          >
          <img
            [src]="heroPhotoUrls()[2]"
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            [alt]="displayTitle() + ' - Vista 3'"
            loading="lazy"
            decoding="async"
            (error)="onImgError($event)"
            />
        </div>
        <div class="hidden md:block h-full bg-surface-secondary relative group cursor-pointer">
          <img
            [src]="heroPhotoUrls()[3]"
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            [alt]="displayTitle() + ' - Vista 4'"
            loading="lazy"
            decoding="async"
            (error)="onImgError($event)"
            />
        </div>
        <div
          class="hidden md:block h-full bg-surface-secondary relative group cursor-pointer rounded-br-2xl"
          >
          <img
            [src]="heroPhotoUrls()[4]"
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
            [alt]="displayTitle() + ' - Vista 5'"
            loading="lazy"
            decoding="async"
            (error)="onImgError($event)"
            />
          <!-- Botón "Ver todas" (Desktop) -->
          <button
            class="absolute bottom-4 right-4 bg-white text-black px-4 py-2 rounded-lg text-sm font-semibold shadow-md hover:scale-105 transition-transform flex items-center gap-2"
            >
            <app-icon name="grid" [size]="16" />
            Mostrar todas las fotos
          </button>
        </div>
      </div>
    </div>
    <!-- ✅ MAIN CONTENT GRID -->
    <div class="max-w-7xl mx-auto px-4">
      <section class="grid gap-12 lg:grid-cols-[2fr_1fr] pb-[calc(6rem+env(safe-area-inset-bottom))]">
        <!-- LEFT COLUMN: Details -->
        <div class="space-y-8">
          <!-- HOST INFO HEADER -->
          <div class="flex justify-between items-center pb-6 border-b border-border-default">
            <div>
              <h2 class="text-xl font-semibold text-text-primary mb-1 font-satoshi">
                {{ displayTitle() }} de {{ car()?.owner?.full_name?.split(' ')?.[0] }}
              </h2>
              <div class="text-text-secondary text-sm">
                {{ car()?.year }} · {{ car()?.seats }} plazas · {{ car()?.doors }} puertas ·
                {{ car()?.transmission }}
              </div>
            </div>
            <!-- Avatar -->
            <div class="relative">
              <img
                [src]="car()?.owner?.avatar_url || '/assets/avatar-placeholder.png'"
                class="w-14 h-14 rounded-full object-cover border border-border-default shadow-sm"
                [alt]="car()?.owner?.full_name"
                loading="lazy"
                decoding="async"
                (error)="onImgError($event, '/assets/avatar-placeholder.png')"
                />
              @if (car()?.owner?.is_email_verified) {
                <div
                  class="absolute bottom-0 right-0 p-1 bg-success-default rounded-full border-2 border-surface-base text-white"
                  >
                  <app-icon name="check" [size]="10" />
                </div>
              }
            </div>
          </div>
          <!-- FEATURES GRID -->
          <div class="py-4">
            <div class="flex items-start gap-4 mb-6">
              <app-icon name="calendar" [size]="24" cssClass="text-text-primary mt-1" />
              <div>
                <h3 class="font-semibold text-text-primary font-satoshi">Cancelación gratuita por 24hs</h3>
                <p class="text-text-secondary text-sm">
                  Tenés un período de gracia para cancelar sin costo.
                </p>
              </div>
            </div>
            <div class="flex items-start gap-4 mb-6">
              <app-icon name="lock" [size]="24" cssClass="text-text-primary mt-1" />
              <div>
                <p class="font-semibold text-text-primary">Check-in autónomo o presencial</p>
                <p class="text-text-secondary text-sm">
                  Coordina fácilmente la entrega con {{ car()?.owner?.full_name?.split(' ')?.[0] }}.
                </p>
              </div>
            </div>
            <div class="flex items-start gap-4">
              <app-icon name="shield" [size]="24" cssClass="text-text-primary mt-1" />
              <div>
                <p class="font-semibold text-text-primary font-luxury">Seguro incluído</p>
                <p class="text-text-secondary text-sm">
                  Viajá tranquilo con nuestra cobertura contra todo riesgo.
                </p>
              </div>
            </div>
          </div>
          <div class="border-t border-border-default my-6"></div>
          <!-- DESCRIPCION -->
          <div>
            <h2 class="text-xl font-semibold text-text-primary mb-4 font-satoshi">Sobre este vehículo</h2>
            <p class="leading-relaxed text-text-primary whitespace-pre-line">
              {{ car()?.description || 'Sin descripción disponible' }}
            </p>
          </div>
          <div class="border-t border-border-default my-6"></div>
          <!-- ESPECIFICACIONES (Clean Tags) -->
          <div>
            <h2 class="text-xl font-semibold text-text-primary mb-4 font-satoshi">Lo que ofrece este auto</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div
                class="flex items-center gap-3 p-3 rounded-xl hover:bg-surface-raised transition-colors"
                >
                <app-icon name="settings" [size]="24" cssClass="text-text-secondary" />
                <span>{{ car()?.transmission | titlecase }}</span>
              </div>
              <div
                class="flex items-center gap-3 p-3 rounded-xl hover:bg-surface-raised transition-colors"
                >
                <app-icon name="lightning" [size]="24" cssClass="text-text-secondary" />
                <span>{{ car()?.fuel_type | titlecase }}</span>
              </div>
              <div
                class="flex items-center gap-3 p-3 rounded-xl hover:bg-surface-raised transition-colors"
                >
                <app-icon name="users" [size]="24" cssClass="text-text-secondary" />
                <span>{{ car()?.seats }} Asientos</span>
              </div>
              <div
                class="flex items-center gap-3 p-3 rounded-xl hover:bg-surface-raised transition-colors"
                >
                <app-icon name="calendar" [size]="24" cssClass="text-text-secondary" />
                <span>Modelo {{ car()?.year }}</span>
              </div>
            </div>
          </div>
          <!-- REVIEWS -->
          <div id="reviews" class="py-8 border-t border-border-default mt-8">
            <h2 class="text-2xl font-semibold text-text-primary mb-6 flex items-center gap-2 font-satoshi">
              <app-icon name="star-filled" [size]="24" cssClass="text-cta-default" />
              {{ car()?.rating_avg || 'Nuevo' }} · {{ car()?.rating_count || 0 }} reseñas
            </h2>
            <!-- Nuevo componente de reviews -->
            @if (car()?.id) {
              <app-car-reviews-section [carId]="car()!.id" />
            }
          </div>
        </div>
        <!-- RIGHT COLUMN: Booking Widget -->
        <aside class="relative hidden lg:block">
          <div
            class="sticky top-24 rounded-2xl border border-border-default dark:border-neutral-800 bg-surface-raised dark:bg-surface-raised p-6 shadow-xl"
            >
            <!-- Header del Widget -->
            <div class="flex items-baseline justify-between mb-6">
              <div class="flex items-baseline gap-1">
                @if (formattedPrice()) {
                  <span class="text-2xl font-bold text-text-primary">{{ formattedPrice() }}</span>
                  <span class="text-text-secondary font-normal"> por día</span>
                } @else {
                  <span class="text-xl font-semibold text-text-secondary">Próximamente</span>
                }
              </div>
              <div class="flex items-center gap-1 text-sm">
                <app-icon name="star-filled" [size]="16" cssClass="text-text-primary" />
                <span class="font-semibold text-text-primary">{{
                  car()?.rating_avg || 'Nuevo'
                }}</span>
                <span class="text-text-secondary">·</span>
                <span class="text-text-secondary underline"
                  >{{ car()?.rating_count || 0 }} reseñas</span
                  >
                </div>
              </div>
              <!-- Date Picker Wrapper -->
              <div class="rounded-xl border border-text-secondary/30 overflow-hidden mb-4">
                <app-date-range-picker
                  #bookingDatePicker
                  [label]="expressMode() ? 'Duración de alquiler' : 'Llegada - Salida'"
                  (rangeChange)="onRangeChange($event)"
                  [initialFrom]="dateRange().from"
                  [initialTo]="dateRange().to"
                  [dailyPrice]="displayPrice()"
                  [showPrices]="!expressMode()"
                  [carId]="car()?.id ?? null"
                  [availabilityChecker]="!expressMode() ? checkAvailability : null"
                  [blockedRanges]="blockedRanges()"
                ></app-date-range-picker>
              </div>
              <!-- Reserve Button -->
              @if (authService.isAuthenticated()) {
                <button
                  id="book-now"
                  (click)="onBookClick()"
                  [disabled]="bookingInProgress()"
                  class="w-full py-4 bg-gradient-to-r from-cta-default to-cta-hover text-cta-text font-bold rounded-xl text-lg shadow-lg hover:shadow-xl active:scale-95 transition-all duration-200 flex items-center justify-center gap-2 mb-4"
                  [ngClass]="{ 'opacity-50 cursor-not-allowed': bookingInProgress() }"
                  [attr.aria-label]="canBook() ? 'Reservar Ahora' : 'Seleccionar Fechas'"
                  >
                  @if (!bookingInProgress()) {
                    <span>
                      {{ canBook() ? 'Reservar Ahora' : 'Ver Disponibilidad' }}
                    </span>
                  }
                  @if (bookingInProgress()) {
                    <span class="flex items-center gap-2">
                      <svg class="animate-spin h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                        <circle
                          class="opacity-25"
                          cx="12"
                          cy="12"
                          r="10"
                          stroke="currentColor"
                          stroke-width="4"
                        ></circle>
                        <path
                          class="opacity-75"
                          fill="currentColor"
                          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                      </svg>
                      Procesando...
                    </span>
                  }
                </button>
              }
              @if (canBook()) {
                <p class="text-center text-xs text-text-secondary mb-6">
                  No se te cobrará nada todavía
                </p>
              }
              @if (bookingError()) {
                <div class="mb-4 rounded-lg border border-error-border/60 bg-error-bg/15 px-4 py-3 text-sm text-error-text">
                  <div class="flex items-start gap-2">
                    <app-icon name="alert-triangle" [size]="16" cssClass="mt-0.5" />
                    <span>{{ bookingError() }}</span>
                  </div>
                </div>
              }
              <!-- Price Breakdown (Only if dates selected) -->
              @if (totalPrice() && hasValidPrice()) {
                <div class="space-y-3 pt-4 border-t border-border-default">
                  <div class="flex justify-between text-text-primary">
                    <span class="underline decoration-text-secondary/30"
                      >{{ formattedPrice() || 'Próximamente' }} x {{ daysCount() }} días</span
                      >
                      <span>{{ totalPrice() | number:'1.0-0':'en-US' }}</span>
                    </div>
                    <div class="flex justify-between text-text-primary">
                      <span class="underline decoration-text-secondary/30 cursor-pointer" (click)="showRiskCalculator.set(!showRiskCalculator())">
                        Seguro y protección
                        <span class="text-xs ml-1">{{ showRiskCalculator() ? '▲' : '▼' }}</span>
                      </span>
                      <span class="text-success-default">¡Incluido!</span>
                    </div>
                    <!-- Risk Calculator Details (expandible) -->
                    @if (showRiskCalculator() && riskCalculation()) {
                      <div class="mt-3 animate-fadeIn">
                        <app-risk-calculator-viewer
                          [riskCalculation]="riskCalculation()"
                          [carValueUsd]="car()?.value_usd || 0">
                        </app-risk-calculator-viewer>
                      </div>
                    }
                    <div class="border-t border-border-default my-2"></div>
                    <div class="flex justify-between text-lg font-bold text-text-primary">
                      <span>Total</span>
                      <span>{{ totalPrice() | number:'1.0-0':'en-US' }}</span>
                    </div>
                  </div>
                }
              </div>
              <!-- Contact Host (Secondary Action - More Prominent) -->
              @if (authService.isAuthenticated() && car() && !isCurrentUserOwner()) {
                <button
                  type="button"
                  (click)="onContactOwner()"
                  class="w-full mt-4 py-3 px-4 bg-surface-base hover:bg-primary-50 dark:hover:bg-primary-900/20 border-2 border-primary-200 dark:border-primary-800 hover:border-primary-400 dark:hover:border-primary-600 rounded-xl text-primary-700 dark:text-primary-400 font-semibold transition-all duration-200 flex items-center justify-center gap-3 group"
                  >
                  <div class="p-2 bg-primary-100 dark:bg-primary-900/30 rounded-full group-hover:bg-primary-200 dark:group-hover:bg-primary-800/40 transition-colors">
                    <app-icon name="message" [size]="18" class="text-primary-600 dark:text-primary-400" />
                  </div>
                  <span class="flex flex-col items-start">
                    <span class="text-sm font-luxury">Contactar al anfitrión</span>
                    <span class="text-xs text-text-secondary font-normal">Consulta antes de reservar</span>
                  </span>
                </button>
              }
            </aside>
          </section>
        </div>
      } @else {
        <div class="flex flex-col items-center justify-center py-32 space-y-6">
          <div class="relative">
            <div
              class="w-16 h-16 rounded-full border-4 border-primary-100 dark:border-primary-900/30 border-t-primary-600 animate-spin"
            ></div>
          </div>
          <div class="text-center space-y-2">
            <p class="text-text-primary font-medium animate-pulse">Cargando vehículo...</p>
          </div>
        </div>
      }


      <ng-template #errorTpl>
        <div
          class="max-w-2xl mx-auto mt-12 p-8 bg-error-bg/10 border border-error-border/50 rounded-2xl text-center"
          >
          <h3 class="text-lg font-bold text-error-strong font-satoshi">No pudimos encontrar este auto</h3>
          <p class="text-text-secondary mt-2">
            {{ error() ?? 'El vehículo no existe o fue eliminado.' }}
          </p>
          <a
            routerLink="/cars"
            class="mt-4 inline-block px-6 py-2 bg-surface-raised border border-border-default rounded-lg font-medium hover:bg-surface-base"
            >Volver al catálogo</a
            >
          </div>
        </ng-template>

        <!-- Sticky CTA Mobile (only visible on mobile when authenticated) -->
        @if (authService.isAuthenticated() && car()) {
          <app-sticky-cta-mobile
            [pricePerDay]="hasValidPrice() ? displayPrice() : null"
            [totalPrice]="totalPrice()"
            [daysCount]="daysCount()"
            [ctaText]="canBook() ? 'Solicitar Reserva' : 'Seleccionar Fechas'"
            [showCalendarIcon]="!canBook()"
            [disabled]="bookingInProgress()"
            [loading]="bookingInProgress()"
            [expressMode]="expressMode()"
            (ctaClick)="onBookClick()"
          ></app-sticky-cta-mobile>
        }
