<section class="cars-map-page bg-ivory-soft dark:bg-graphite-dark transition-colors duration-300">
  <ng-template #carouselCard let-car>
    <button
      type="button"
      role="listitem"
      class="map-carousel-card"
      [class.map-carousel-card--active]="isCarSelected(car.id)"
      (click)="onCarSelected(car.id)"
      [attr.aria-label]="'Ver más sobre ' + (car.title || 'este auto económico')"
      tabindex="0"
    >
      <div class="map-carousel-card__media">
        <img
          *ngIf="car.photos?.length"
          [src]="car.photos[0].url"
          [alt]="car.title"
          class="map-carousel-card__image"
          loading="lazy"
        />
        <div *ngIf="!car.photos?.length" class="map-carousel-card__placeholder">
          <svg class="w-6 h-6 text-charcoal-medium" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <circle cx="7" cy="17" r="2" stroke-width="1.5"></circle>
            <circle cx="17" cy="17" r="2" stroke-width="1.5"></circle>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 15h14M8 12l1-4h6l1 4"></path>
          </svg>
        </div>
      </div>
      <div class="map-carousel-card__body">
        <p class="map-carousel-card__title">{{ car.title }}</p>
        <div class="map-carousel-card__meta">
          <span class="map-carousel-card__price">{{ car.price_per_day | money }}</span>
          <span class="map-carousel-card__price-suffix">/ día</span>
        </div>
        <div class="map-carousel-card__foot">
          <span *ngIf="car.distanceText" class="map-carousel-card__distance">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            {{ car.distanceText }}
          </span>
          <span *ngIf="car.owner?.rating_avg" class="map-carousel-card__rating">
            ⭐ {{ car.owner.rating_avg | number:'1.1-1' }}
          </span>
        </div>
        <div class="map-carousel-card__actions">
          <a
            [routerLink]="['/cars', car.id]"
            class="map-carousel-card__cta"
            (click)="$event.stopPropagation()"
            [attr.aria-label]="'Alquilar ' + (car.title || '')"
          >
            Alquilar
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
      </div>
    </button>
  </ng-template>

  <div class="layout-grid">
    <div class="map-panel">
      <div id="map-container" class="map-wrapper">
        <app-cars-map
          [cars]="cars()"
          [selectedCarId]="selectedCarId()"
          (carSelected)="onMapCarSelected($event)"
          (userLocationChange)="onUserLocationChange($event)"
        ></app-cars-map>

        <div class="pointer-events-none absolute inset-0">
          <div class="map-controls pointer-events-auto">
            <div id="filters" data-tour-step="guided-search" class="map-controls__filters filter-section">
              <app-map-filters
                (filtersChange)="onFiltersChange($event)"
                (filtersReset)="onFiltersReset()"
              ></app-map-filters>
            </div>
            <div class="map-controls__sort">
              <label class="sr-only" for="sort-by">Ordenar resultados</label>
              <select
                id="sort-by"
                [value]="sortBy()"
                (change)="onSortChange($any($event.target).value)"
                class="map-controls__select"
              >
                <option value="distance">Más cercanos</option>
                <option value="price_asc">Precio: menor a mayor</option>
                <option value="price_desc">Precio: mayor a menor</option>
                <option value="rating">Mejor valorados</option>
                <option value="newest">Más nuevos</option>
              </select>
            </div>
          </div>

          <!-- Carousel Unificado Responsive -->
          <div
            *ngIf="showEconomyCarousel()"
            class="map-carousel-container pointer-events-none"
            role="region"
            [attr.aria-label]="isMobile() ? 'Autos sugeridos cerca tuyo' : 'Autos cercanos y económicos'"
          >
            <div class="map-carousel-heading pointer-events-auto">
              <span class="map-carousel-heading__pill">
                <span class="hidden lg:inline">Cercanos y económicos</span>
                <span class="lg:hidden">Sugeridos cerca tuyo</span>
              </span>
            </div>
            <div 
              #unifiedCarousel
              class="map-carousel pointer-events-auto" 
              data-tour-step="guided-select-car" 
              role="list"
              (mouseenter)="onCarouselMouseEnter()"
              (mouseleave)="onCarouselMouseLeave()"
              (touchstart)="onCarouselMouseEnter()"
              (touchend)="onCarouselMouseLeave()"
            >
              <ng-container *ngFor="let car of economyCars(); trackBy: trackByCarId">
                <ng-container
                  [ngTemplateOutlet]="carouselCard"
                  [ngTemplateOutletContext]="{ $implicit: car }"
                ></ng-container>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </div>

    <aside class="list-panel">
      <div class="list-panel-inner" id="tour-results-panel">
        <header class="list-panel-header">
          <div>
            <h2 class="list-panel-title">Autos disponibles</h2>
            <p class="list-panel-subtitle" aria-live="polite" role="status">
              {{ premiumCars().length }} modelos media/alta gama
              <span *ngIf="premiumCars().length"> · Ordenados por {{ sortLabel() }}</span>
            </p>
          </div>
          <div class="list-panel-actions">
            <label class="sr-only" for="sort-by-mobile">Ordenar resultados</label>
            <select
              id="sort-by-mobile"
              class="list-panel-sort"
              [value]="sortBy()"
              (change)="onSortChange($any($event.target).value)"
            >
              <option value="distance">Más cercanos</option>
              <option value="price_asc">Precio: menor a mayor</option>
              <option value="price_desc">Precio: mayor a menor</option>
              <option value="rating">Mejor valorados</option>
              <option value="newest">Más nuevos</option>
            </select>
          </div>
        </header>

        <div *ngIf="loading()" class="list-panel-loading">
          <span class="loading-spinner" aria-hidden="true"></span>
          <span class="sr-only">Cargando resultados</span>
        </div>

        <ng-container *ngIf="!loading()">
          <div *ngIf="premiumCars().length === 0" class="empty-state">
            <svg class="empty-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <p>No encontramos autos de media/alta gama para tu búsqueda.</p>
            <p class="hint">Ajustá los filtros o probá otra ciudad para ver más opciones premium.</p>
          </div>

          <div *ngIf="premiumCars().length > 0" class="list-panel-cards">
            <app-car-card
              *ngFor="let car of premiumCars(); trackBy: trackByCarId"
              [id]="'car-card-' + car.id"
              [car]="car"
              [selected]="isCarSelected(car.id)"
              (click)="onCarSelected(car.id)"
              class="w-full cursor-pointer"
            ></app-car-card>
          </div>
        </ng-container>
      </div>
    </aside>
  </div>
</section>
