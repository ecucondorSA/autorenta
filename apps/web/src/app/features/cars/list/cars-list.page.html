<section
  class="cars-marketplace bg-surface-base dark:bg-surface-base transition-colors duration-300 min-h-screen"
>
  <!-- Barra superior fija -->
  <app-pwa-titlebar />

  <!-- Breadcrumbs navigation -->
  <!-- TODO: Re-add when breadcrumbs component is created -->
  <!-- <app-breadcrumbs [items]="breadcrumbItems()" /> -->

  <!-- Layout Airbnb: Grid + Map -->
  <div class="marketplace-container">
    <!-- MAIN: Grid de autos (izquierda en desktop, arriba en mobile) -->
    <div class="grid-section">
      <!-- Header con filtros y controles -->
      <div class="marketplace-header">
        <div class="header-content">
          <div class="header-left">
            <h1 class="marketplace-title">Alquila tu pr√≥ximo auto</h1>
            <p class="marketplace-subtitle">{{ premiumCars().length }} veh√≠culos disponibles</p>
          </div>
          <div class="header-right">
            <app-map-filters (filterChange)="onFiltersChange($event)" />
          </div>
        </div>
      </div>

      <!-- Grid principal de autos (Airbnb style) -->
      <div class="cars-grid-wrapper">
        <div class="cars-grid">
          <!-- Car Card V3 (Professional Airbnb-style cards) -->
          <div
            *ngFor="let car of premiumCars(); trackBy: trackByCar"
            class="car-grid-item"
            (click)="onCarSelected(car.id)"
            [class.selected]="selectedCarId() === car.id"
          >
            <!-- TODO: Re-add when car-card-v3 component is created -->
            <!--<app-car-card-v3
              [car]="carToCardFormat(car)"
              (onReserve)="onReserveClick($event)"
            />-->
            <p style="padding: 1rem">{{ car.brand }} {{ car.model }}</p>
          </div>
        </div>

        <!-- Empty state -->
        <div *ngIf="premiumCars().length === 0" class="empty-state">
          <p>No hay autos disponibles con esos filtros</p>
        </div>
      </div>
    </div>

    <!-- SIDEBAR: Mapa (derecha en desktop, abajo en mobile) -->
    <aside class="map-sidebar" *ngIf="selectedCarId()">
      <div class="map-sidebar-content">
        <div id="map-container" class="w-full h-full">
          <app-cars-map
            [cars]="carMapLocations()"
            [selectedCarId]="selectedCarId()"
            [userLocation]="userLocation()"
            (carSelected)="onMapCarSelected($event)"
            (userLocationChange)="onUserLocationChange($event)"
          ></app-cars-map>
        </div>

        <!-- Urgent Banner over map -->
        <div
          *ngIf="selectedCarId() && urgentAvailability()?.available"
          class="urgent-banner-overlay pointer-events-none"
        >
          <div class="pointer-events-auto">
            <app-urgent-rental-banner
              [carId]="selectedCarId()!"
              [regionId]="selectedCar()?.region_id || ''"
              [expressMode]="expressModeSignal"
            />
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Sticky CTA Mobile -->
  <app-sticky-cta-mobile
    *ngIf="selectedCarId() && selectedCarPrice()"
    [pricePerDay]="selectedCarPrice()!"
    [ctaText]="'Rentar ahora'"
    [expressMode]="urgentAvailability()?.available || false"
    (ctaClick)="onReserveClick(selectedCarId()!)"
  />

  <!-- WhatsApp FAB -->
  <app-whatsapp-fab
    *ngIf="selectedCar()"
    [car]="selectedCar()!"
    [ownerPhone]="null"
    [ownerName]="selectedCar()?.owner?.full_name || null"
  />

  <!-- Filters FAB (Mobile only) -->
  <button
    type="button"
    class="filters-fab"
    (click)="toggleFiltersDrawer()"
    aria-label="Abrir filtros"
  >
    <span class="filters-icon">üîç</span>
    <span class="filters-label">Filtros</span>
  </button>

  <!-- Filters Drawer (Mobile Bottom Sheet) -->
  <!-- TODO: Re-add when filters-drawer component is created -->
  <!-- <app-filters-drawer
    [availableCars]="carMapLocations()"
    [isOpenInput]="drawerOpen()"
    (filterChange)="onFiltersChange($event)"
    (onClose)="closeFiltersDrawer()"
  /> -->
</section>
