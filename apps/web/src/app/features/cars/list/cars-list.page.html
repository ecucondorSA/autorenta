<section class="cars-map-page bg-surface-base dark:bg-surface-base transition-colors duration-300">
  <!-- Barra superior fija -->
  <app-pwa-titlebar />

  <!-- Layout principal 70/30 (desktop) o full-width (mobile) -->
  <div class="map-page-layout">
    <!-- RegiÃ³n del mapa (70% desktop, full mobile) -->
    <div class="map-section">
      <div id="map-container" class="w-full h-full relative">
        <app-cars-map
          [cars]="carMapLocations()"
          [selectedCarId]="selectedCarId()"
          [userLocation]="userLocation()"
          (carSelected)="onMapCarSelected($event)"
          (userLocationChange)="onUserLocationChange($event)"
        ></app-cars-map>

        <!-- Filtros flotantes sobre el mapa -->
        <div class="map-filters-overlay pointer-events-none">
          <div class="pointer-events-auto">
            <app-map-filters (filterChange)="onFiltersChange($event)" />
          </div>
        </div>

        <!-- Urgent Rental Banner (si hay auto seleccionado) -->
        <div
          *ngIf="selectedCarId() && urgentAvailability()?.available"
          class="urgent-banner-overlay pointer-events-none"
        >
          <div class="pointer-events-auto">
            <app-urgent-rental-banner
              [carId]="selectedCarId()!"
              [regionId]="selectedCar()?.region_id || ''"
              [expressMode]="expressModeSignal"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Drawer lateral (30% desktop, tabs mobile) -->
    <app-cars-drawer
      [carsInput]="premiumCars()"
      [isOpenInput]="drawerOpen()"
      [selectedCarIdInput]="selectedCarId()"
      (carSelected)="onCarSelected($event)"
      (closeDrawer)="onDrawerClose()"
      (reserveClick)="onReserveClick($event)"
    />
  </div>

  <!-- Sticky CTA Mobile -->
  <app-sticky-cta-mobile
    *ngIf="selectedCarId() && selectedCarPrice()"
    [pricePerDay]="selectedCarPrice()!"
    [ctaText]="'Rentar ahora'"
    [expressMode]="urgentAvailability()?.available || false"
    (ctaClick)="onReserveClick(selectedCarId()!)"
  />

  <!-- WhatsApp FAB -->
  <!-- Note: ownerPhone will be loaded via getOwnerContact when needed -->
  <app-whatsapp-fab
    *ngIf="selectedCar()"
    [car]="selectedCar()!"
    [ownerPhone]="null"
    [ownerName]="selectedCar()?.owner?.full_name || null"
  />

  <!-- Mobile Bottom Nav -->
  <app-mobile-bottom-nav />
</section>
