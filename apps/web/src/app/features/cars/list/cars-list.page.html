<section
  class="cars-marketplace bg-surface-base transition-colors duration-300 min-h-screen"
>
  <!-- Barra superior fija -->
  <!-- Recompilation trigger 1 -->
  <app-pwa-titlebar />

  <!-- Desktop Header with View Toggles (hidden on mobile when map view) -->
  <div
    class="bg-white border-b border-slate-200 sticky top-0 z-50"
    [class.hidden]="viewMode() === 'map'"
    [class.lg:block]="true"
  >
    <div
      class="max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 flex items-center justify-between gap-4 py-3 pt-[calc(0.75rem+env(safe-area-inset-top))]"
    >
      <!-- Header Left -->
      <div class="header-left">
        <h1 class="text-2xl font-bold text-slate-900 font-satoshi">
          Alquila tu pr√≥ximo auto
        </h1>
        <p
          class="text-sm text-slate-600"
          data-testid="results-count"
          aria-live="polite"
        >
          {{ premiumCars().length }} veh√≠culos disponibles
        </p>
      </div>

      <!-- Sort Dropdown + View Toggle -->
      <div class="flex items-center gap-3">
        <!-- Sort Dropdown -->
        <div class="relative">
          <label for="sort-select" class="sr-only">Ordenar por</label>
          <select
            id="sort-select"
            data-testid="sort-select"
            [value]="sortBy()"
            (change)="onSortChange($any($event.target).value)"
            class="appearance-none bg-white border border-slate-200 rounded-lg px-3 py-2 pr-8 text-sm font-medium text-slate-700 cursor-pointer hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-cyan-500"
          >
            <option value="rating">Mejor valorados</option>
            <option value="price_asc">Precio: menor a mayor</option>
            <option value="price_desc">Precio: mayor a menor</option>
            <option value="distance">M√°s cercanos</option>
            <option value="newest">M√°s recientes</option>
          </select>
          <app-icon
            name="chevron-down"
            [size]="16"
            cssClass="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"
          />
        </div>

        <!-- View Toggle (Desktop only - mobile uses floating pill) -->
        <div
          class="hidden lg:flex bg-slate-100 p-1 rounded-xl items-center border border-slate-200"
        >
          <button
            type="button"
            data-testid="view-map"
            [class.bg-white]="viewMode() === 'map'"
            [class.shadow-sm]="viewMode() === 'map'"
            [class.text-slate-900]="viewMode() === 'map'"
            [class.text-slate-500]="viewMode() !== 'map'"
            (click)="viewMode.set('map')"
            [attr.aria-pressed]="viewMode() === 'map'"
            aria-label="Cambiar a vista mapa"
            class="px-3 py-2 rounded-lg transition-all duration-200 hover:text-slate-900 flex items-center gap-1.5 text-sm font-medium"
            title="Vista Mapa"
          >
            <app-icon name="map" [size]="16" />
            <span>Mapa</span>
          </button>
          <button
            type="button"
            data-testid="view-grid"
            [class.bg-white]="viewMode() !== 'map'"
            [class.shadow-sm]="viewMode() !== 'map'"
            [class.text-slate-900]="viewMode() !== 'map'"
            [class.text-slate-500]="viewMode() === 'map'"
            (click)="viewMode.set('grid')"
            [attr.aria-pressed]="viewMode() !== 'map'"
            aria-label="Cambiar a vista lista"
            class="px-3 py-2 rounded-lg transition-all duration-200 hover:text-slate-900 flex items-center gap-1.5 text-sm font-medium"
            title="Vista Lista"
          >
            <app-icon name="menu" [size]="16" />
            <span>Lista</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- üéØ SPLIT VIEW CONTAINER (Desktop: side-by-side, Mobile: toggle) -->
  <div
    class="flex flex-col lg:flex-row lg:h-[calc(100vh-4rem)]"
    [class.h-screen]="viewMode() === 'map' && !isDesktop()"
  >
    <!-- üì¶ LEFT PANEL: Lista de Autos (scrollable independiente) -->
    <div
      class="w-full lg:overflow-y-auto lg:h-full px-4 sm:px-6 py-6"
      [ngClass]="{
        'lg:w-1/2 xl:w-[55%]': viewMode() === 'map',
        'lg:w-full xl:w-full': viewMode() !== 'map',
        'hidden lg:block': viewMode() === 'map'
      }"
    >
      <!-- üîé BARRA DE B√öSQUEDA ESTILO AIRBNB -->
      <div class="mb-8">
        <!-- T√≠tulo compacto -->
        <div class="text-center mb-6">
          <h2 class="text-xl lg:text-2xl font-bold text-text-primary">
            Encuentra tu auto perfecto
          </h2>
        </div>

        <!-- Barra √∫nica de b√∫squeda -->
        <div class="relative max-w-4xl mx-auto">
          <div class="flex flex-col lg:flex-row items-stretch bg-white rounded-full shadow-lg border border-slate-200 hover:shadow-xl transition-shadow duration-300 overflow-hidden">

            <!-- Ubicaci√≥n -->
            <div class="flex-1 relative group">
              <div class="px-6 py-4 cursor-pointer hover:bg-slate-50 transition-colors rounded-l-full">
                <label class="block text-xs font-semibold text-slate-800 mb-0.5">Ubicaci√≥n</label>
                <input
                  id="search-cars-input"
                  type="text"
                  data-testid="search-input"
                  [value]="searchQuery()"
                  (input)="onSearchInput($event)"
                  (keyup.enter)="onSearchSubmit()"
                  aria-autocomplete="list"
                  [attr.aria-expanded]="searchSuggestions().length > 0"
                  aria-label="Buscar veh√≠culos"
                  aria-controls="search-suggestions"
                  placeholder="¬øA d√≥nde vas?"
                  class="w-full bg-transparent text-sm text-slate-600 placeholder:text-slate-400 focus:outline-none"
                />
              </div>

              <!-- Sugerencias dropdown -->
              @if (searchSuggestions().length > 0) {
                <div
                  id="search-suggestions"
                  role="listbox"
                  class="absolute left-0 right-0 top-full mt-2 z-50 bg-white border border-slate-200 rounded-2xl shadow-2xl overflow-hidden"
                >
                  @for (suggestion of searchSuggestions(); track suggestion; let idx = $index) {
                    <button
                      type="button"
                      role="option"
                      [id]="'search-suggestion-' + idx"
                      (click)="onSuggestionClick(suggestion)"
                      class="w-full text-left px-4 py-3 text-slate-700 hover:bg-slate-50 transition-colors flex items-center gap-3 border-b border-slate-100 last:border-0"
                    >
                      <span class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                        <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        </svg>
                      </span>
                      <span class="text-sm">{{ suggestion }}</span>
                    </button>
                  }
                </div>
              }
            </div>

            <!-- Divisor vertical (solo desktop) -->
            <div class="hidden lg:block w-px bg-slate-200 my-3"></div>

            <!-- Fechas -->
            <div class="flex-1 lg:flex-[1.2]">
              <div class="px-6 py-4 hover:bg-slate-50 transition-colors">
                <label class="block text-xs font-semibold text-slate-800 mb-0.5">Fechas</label>
                <app-date-range-picker
                  [initialFrom]="dateRange().from"
                  [initialTo]="dateRange().to"
                  (rangeChange)="onRangeChange($event)"
                  [compact]="true"
                />
              </div>
            </div>

            <!-- Bot√≥n buscar (circular en desktop) -->
            <div class="p-2 flex items-center">
              <button
                (click)="onSearchSubmit()"
                class="w-full lg:w-12 lg:h-12 flex items-center justify-center gap-2 px-6 py-3 lg:p-0 bg-[#39ff14] hover:bg-[#2ecc11] text-black font-semibold rounded-full shadow-lg hover:shadow-[0_0_20px_rgba(57,255,20,0.5)] transform hover:scale-105 active:scale-95 transition-all duration-200"
                aria-label="Buscar"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <span class="lg:hidden">Buscar</span>
              </button>
            </div>
          </div>

          <!-- Badges de confianza -->
          <div class="flex items-center justify-center gap-4 mt-4 text-xs text-slate-500">
            <span class="flex items-center gap-1">
              <svg class="w-3.5 h-3.5 text-[#39ff14]" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              Verificados
            </span>
            <span class="flex items-center gap-1">
              <svg class="w-3.5 h-3.5 text-[#39ff14]" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              Seguro incluido
            </span>
            <span class="flex items-center gap-1">
              <svg class="w-3.5 h-3.5 text-[#39ff14]" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              Soporte 24/7
            </span>
          </div>
        </div>
      </div>

        <!-- Footer de Filtros: Toggle + Limpiar -->
        <div class="mt-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4 pt-2">
          <!-- Toggle Disponibles -->
          @if (dateRange().from && dateRange().to) {
            <button
              type="button"
              (click)="toggleShowUnavailable()"
              class="group flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-50 transition-colors cursor-pointer"
            >
              <div
                [class.bg-cyan-600]="showUnavailableCars()"
                [class.bg-slate-300]="!showUnavailableCars()"
                class="relative h-5 w-9 flex-shrink-0 rounded-full transition-colors duration-200 ease-in-out"
              >
                <span
                  [class.translate-x-4]="showUnavailableCars()"
                  [class.translate-x-0]="!showUnavailableCars()"
                  class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out border border-slate-100"
                ></span>
              </div>
              <div class="flex flex-col items-start">
                <span class="text-xs font-bold text-slate-700">
                  Mostrar no disponibles
                </span>
                @if (showUnavailableCars()) {
                  <span class="text-[10px] text-amber-600 font-medium">
                    (Ver disponibilidad futura)
                  </span>
                }
              </div>
            </button>
          } @else {
            <div></div>
            <!-- Spacer -->
          }

          <!-- Bot√≥n Limpiar -->
          @if (
            maxDistance() !== null ||
            minPrice() !== null ||
            maxPrice() !== null ||
            minRating() !== null ||
            showUnavailableCars()
          ) {
            <button
              type="button"
              (click)="clearFilters()"
              class="text-xs font-bold uppercase tracking-wider text-slate-400 hover:text-rose-500 transition-colors flex items-center gap-1"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
              Limpiar Filtros
            </button>
          }
        </div>

      <!-- Error State -->
      @if (loadError()) {
        <div class="mb-6" role="alert" aria-live="polite" data-testid="load-error">
          <div
            class="p-4 bg-white rounded-lg border border-slate-200 flex items-start justify-between gap-4"
          >
            <div>
              <p class="text-sm font-semibold text-slate-900">Error al cargar</p>
              <p class="text-sm text-slate-600 mt-1">{{ loadError() }}</p>
            </div>
            <button
              type="button"
              (click)="loadCars()"
              class="px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 active:bg-cyan-800 text-white text-sm font-semibold whitespace-nowrap"
            >
              Reintentar
            </button>
          </div>
        </div>
      }

      <!-- SKELETON LOADING -->
      @if (loading() && (viewMode() === 'grid' || (viewMode() === 'map' && isDesktop()))) {
        <div class="grid grid-cols-2 sm:grid-cols-2 gap-3 sm:gap-x-4 sm:gap-y-8">
          @for (_ of [1, 2, 3, 4, 5, 6]; track _) {
            <div class="animate-pulse">
              <!-- Image Skeleton -->
              <div class="aspect-[4/3] rounded-xl bg-slate-200 mb-3"></div>
              <!-- Content Skeleton -->
              <div class="space-y-2">
                <div class="flex justify-between">
                  <div class="h-4 bg-slate-200 rounded w-3/4"></div>
                  <div class="h-4 bg-slate-200 rounded w-12"></div>
                </div>
                <div class="h-3 bg-slate-200 rounded w-1/2"></div>
                <div class="h-4 bg-slate-200 rounded w-1/3"></div>
              </div>
            </div>
          }
        </div>
      }

      <!-- SKELETON LOADING (List view) -->
      @if (loading() && viewMode() === 'list') {
        <div class="flex flex-col gap-4 max-w-5xl mx-auto" data-testid="list-skeleton">
          @for (_ of [1, 2, 3]; track _) {
            <div
              class="animate-pulse bg-white rounded-2xl border border-slate-200 overflow-hidden flex flex-col md:flex-row"
            >
              <div
                class="w-full sm:w-48 md:w-56 lg:w-72 aspect-video md:aspect-[4/3] bg-slate-200 flex-shrink-0"
              ></div>
              <div class="p-5 flex-1 space-y-3">
                <div class="h-5 bg-slate-200 rounded w-2/3"></div>
                <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                <div class="h-4 bg-slate-200 rounded w-1/3"></div>
              </div>
            </div>
          }
        </div>
      }

      <!-- GRID VIEW - Airbnb Style (Desktop/Tablet)
         Desktop split-view: when viewMode() === 'map', keep the grid visible in the left panel. -->
      @if (!loading() && (viewMode() === 'grid' || (viewMode() === 'map' && isDesktop()))) {
        <!-- Desktop/Tablet Grid (Hidden on Mobile) -->
        <div
          class="hidden sm:grid sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-x-4 gap-y-6 grid-view"
        >
          @for (car of premiumCars(); track car.id; let idx = $index) {
            <a
              [routerLink]="['/cars', car.id]"
              [attr.data-car-id]="car.id"
              [id]="'car-card-desktop-' + car.id"
              data-testid="car-card"
              class="airbnb-card group block cursor-pointer transition-transform duration-200 no-min-touch"
              (mouseenter)="onCardMouseEnter(car.id)"
              (mouseleave)="onCardMouseLeave()"
            >
              <!-- Image Container -->
              <div
                class="aspect-[16/10] relative overflow-hidden rounded-xl bg-slate-100 mb-3"
              >
                @if (idx < 2) {
                  <img
                    [ngSrc]="car.image_url || '/assets/images/car-placeholder.svg'"
                    [alt]="car.brand + ' ' + car.model"
                    fill
                    [priority]="true"
                    sizes="(min-width: 1280px) 18vw, (min-width: 1024px) 24vw, (min-width: 640px) 45vw, 85vw"
                    class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  />
                } @else {
                  <img
                    [ngSrc]="car.image_url || '/assets/images/car-placeholder.svg'"
                    [alt]="car.brand + ' ' + car.model"
                    fill
                    sizes="(min-width: 1280px) 18vw, (min-width: 1024px) 24vw, (min-width: 640px) 45vw, 85vw"
                    class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  />
                }
                <!-- Favorite Heart Button -->
                <button
                  type="button"
                  (click)="toggleFavorite($event, car.id)"
                  [attr.aria-label]="
                    isFavorite(car.id) ? 'Quitar de favoritos' : 'Agregar a favoritos'
                  "
                  class="absolute top-3 left-3 w-8 h-8 flex items-center justify-center rounded-full bg-white/80 hover:bg-white shadow-sm backdrop-blur-sm transition-all hover:scale-110"
                >
                  <app-icon
                    [name]="isFavorite(car.id) ? 'heart-filled' : 'heart'"
                    [size]="20"
                    [cssClass]="isFavorite(car.id) ? 'text-rose-500' : 'text-slate-600'"
                  />
                </button>
                <!-- Badges Desktop (optimized: uses pre-computed carBadges Map) -->
                <div class="absolute top-3 right-3 flex flex-col gap-1.5 items-end">
                  <!-- Badge de disponibilidad -->
                  @if (showUnavailableCars() && car.isAvailableForDates === false) {
                    <span
                      class="px-2 py-1 bg-amber-500/90 text-white text-xs font-semibold rounded-full shadow-md flex items-center gap-1 backdrop-blur-sm"
                    >
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                      @if (car.nextAvailableDate) {
                        Libre desde {{ car.nextAvailableDate | date: 'd MMM' }}
                      } @else {
                        No disponible
                      }
                    </span>
                  }
                  @if (carBadges().get(car.id)?.topRated) {
                    <span
                      class="px-2 py-1 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs font-bold rounded-full shadow-md flex items-center gap-1"
                    >
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path
                          d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                        />
                      </svg>
                      Superanfitri√≥n
                    </span>
                  }
                  @if (
                    carBadges().get(car.id)?.instantBooking && !carBadges().get(car.id)?.topRated
                  ) {
                    <span
                      class="px-2 py-1 bg-cyan-500 text-white text-xs font-semibold rounded-full shadow-md flex items-center gap-1"
                    >
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                          d="M13 2L4 14h7l-1 8 9-12h-7l1-8z"
                          stroke-width="1.75"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                      Reserva inmediata
                    </span>
                  }
                </div>
              </div>
              <!-- Content Desktop -->
              <div class="space-y-1">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2 min-w-0">
                    <p class="text-sm font-semibold text-slate-900 truncate">
                      {{ car.location_city || car.location_state || 'Argentina' }}
                    </p>
                    @if (car.distanceText) {
                      <span class="text-xs text-slate-500 flex-shrink-0"
                        >¬∑ {{ car.distanceText }}</span
                      >
                    }
                  </div>
                  @if (car.rating_avg) {
                    <div class="flex items-center gap-1 flex-shrink-0">
                      <app-icon
                        name="star-filled"
                        [size]="16"
                        cssClass="text-slate-900"
                      />
                      <span class="text-sm font-medium text-slate-900">{{
                        car.rating_avg | number: '1.1-1'
                      }}</span>
                      @if (car.rating_count) {
                        <span class="text-xs text-slate-500"
                          >({{ car.rating_count }})</span
                        >
                      }
                    </div>
                  }
                </div>
                <h3
                  class="text-sm text-slate-500 truncate font-bold font-satoshi"
                >
                  {{ car.brand }} {{ car.model }} {{ car.year }}
                </h3>
                <p class="text-sm text-slate-500">
                  {{ car.transmission | titlecase }} ¬∑ {{ car.seats }} asientos ¬∑
                  {{ car.fuel_type | titlecase }}
                </p>
                <p class="pt-1">
                  <span class="font-semibold text-slate-900"
                    >{{ car.price_per_day | money }}</span
                  >
                  <span class="text-slate-500"> / d√≠a</span>
                </p>
              </div>
            </a>
          }
        </div>

        <!-- üì± MOBILE TINDER-STYLE SWIPE VIEW -->
        <div
          class="sm:hidden flex overflow-x-auto snap-x snap-mandatory gap-4 pb-8 -mx-4 px-4 scrollbar-hide items-stretch h-[calc(100vh-14rem)]"
        >
          @for (car of premiumCars(); track car.id; let idx = $index) {
            <a
              [routerLink]="['/cars', car.id]"
              class="relative flex-shrink-0 w-[85vw] snap-center bg-white rounded-3xl overflow-hidden shadow-lg border border-slate-200 flex flex-col no-min-touch"
            >
              <!-- Full Height Image -->
              <div class="h-[65%] relative">
                @if (idx === 0) {
                  <img
                    [ngSrc]="car.image_url || '/assets/images/car-placeholder.svg'"
                    [alt]="car.brand + ' ' + car.model"
                    fill
                    [priority]="true"
                    sizes="85vw"
                    class="w-full h-full object-cover"
                  />
                } @else {
                  <img
                    [ngSrc]="car.image_url || '/assets/images/car-placeholder.svg'"
                    [alt]="car.brand + ' ' + car.model"
                    fill
                    sizes="85vw"
                    class="w-full h-full object-cover"
                  />
                }
                <!-- Gradient Overlay -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>

                <!-- Badge de disponibilidad (mobile) -->
                @if (showUnavailableCars() && car.isAvailableForDates === false) {
                  <div class="absolute top-4 left-4 z-10">
                    <span
                      class="px-3 py-1.5 bg-amber-500/90 text-white text-xs font-semibold rounded-full shadow-lg flex items-center gap-1.5 backdrop-blur-sm"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                      @if (car.nextAvailableDate) {
                        Libre desde {{ car.nextAvailableDate | date: 'd MMM' }}
                      } @else {
                        No disponible
                      }
                    </span>
                  </div>
                }

                <!-- Price Tag on Image (Tinder Style) -->
                <div class="absolute bottom-4 left-4 text-white">
                  <p class="text-2xl font-bold font-satoshi">
                      {{ car.price_per_day | money }}
                  </p>
                  <p class="text-sm font-medium opacity-90">por d√≠a</p>
                </div>

                <!-- Heart Top Right -->
                <button
                  type="button"
                  (click)="toggleFavorite($event, car.id)"
                  class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-black/20 backdrop-blur-md transition-transform active:scale-90"
                  [attr.aria-label]="
                    isFavorite(car.id) ? 'Quitar de favoritos' : 'Agregar a favoritos'
                  "
                >
                  <app-icon
                    [name]="isFavorite(car.id) ? 'heart-filled' : 'heart'"
                    [size]="24"
                    [cssClass]="isFavorite(car.id) ? 'text-rose-500' : 'text-white'"
                  />
                </button>
              </div>

              <!-- Bottom Content -->
              <div class="flex-1 h-full p-5 flex flex-col justify-between bg-white overflow-hidden">
                <div>
                  <div class="flex justify-between items-start mb-1">
                    <h3
                      class="text-xl font-bold text-slate-900 font-satoshi leading-tight"
                    >
                      {{ car.brand }} {{ car.model }}
                    </h3>
                    @if (car.rating_avg) {
                      <div
                        class="flex items-center gap-1 bg-slate-100 px-2 py-1 rounded-lg"
                      >
                        <app-icon name="star-filled" [size]="14" cssClass="text-amber-500" />
                        <span class="text-sm font-bold text-slate-900">
                          {{ car.rating_avg | number: '1.1-1' }}
                          @if (car.rating_count) {
                            <span class="text-xs font-semibold text-slate-600"
                              >({{ car.rating_count }})</span
                            >
                          }
                        </span>
                      </div>
                    }
                  </div>
                  <p class="text-slate-500 text-sm mb-4">
                    {{ car.year }} ¬∑ {{ car.location_city || 'Argentina' }}
                    @if (car.distanceText) {
                      ¬∑ {{ car.distanceText }}
                    }
                  </p>

                  <!-- Features Chips -->
                  <div class="flex flex-wrap gap-2">
                    <span
                      class="px-3 py-1 bg-slate-50 border border-slate-100 rounded-full text-xs text-slate-600"
                    >
                      {{ car.transmission | titlecase }}
                    </span>
                    <span
                      class="px-3 py-1 bg-slate-50 border border-slate-100 rounded-full text-xs text-slate-600"
                    >
                      {{ car.seats }} asientos
                    </span>
                  </div>
                </div>

                <div class="w-full mt-4">
                  <div
                    class="w-full py-3 bg-cyan-600 hover:bg-cyan-700 active:bg-cyan-800 text-white rounded-xl font-bold transition-colors text-center"
                    [attr.aria-label]="'Ver detalles de ' + car.brand + ' ' + car.model"
                    role="text"
                  >
                    Ver detalles
                  </div>
                </div>
              </div>
            </a>
          }

          <!-- "Load More" Card -->
          @if (hasMoreCars()) {
            <div
              class="relative flex-shrink-0 w-[85vw] snap-center flex items-center justify-center"
            >
              <button
                (click)="loadMore()"
                class="flex flex-col items-center gap-4 p-8 rounded-full hover:bg-slate-50 transition-colors"
              >
                <div
                  class="w-16 h-16 rounded-full bg-cyan-100 flex items-center justify-center text-cyan-600"
                >
                  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M14 5l7 7m0 0l-7 7m7-7H3"
                    ></path>
                  </svg>
                </div>
                <span class="font-bold text-lg text-slate-900">Ver m√°s autos</span>
              </button>
            </div>
          }
        </div>
      }

      <!-- LOAD MORE BUTTON (Desktop only) -->
      @if (
        !loading() &&
        (viewMode() === 'grid' || (viewMode() === 'map' && isDesktop())) &&
        hasMoreCars()
      ) {
        <!-- ... existing load more button logic but wrapped to hide on mobile since it's inside the carousel now ... -->
        <div class="hidden sm:flex mt-8 mb-12 justify-center pb-20 lg:pb-0">
          <button
            (click)="loadMore()"
            class="px-6 py-3 bg-white border border-slate-200 rounded-full shadow-sm text-slate-900 font-medium hover:bg-slate-50 transition-colors flex items-center gap-2 group"
          >
            <span>Ver m√°s autos</span>
            <svg
              class="w-4 h-4 group-hover:translate-y-0.5 transition-transform"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </button>
        </div>
      }

      <!-- LIST VIEW -->
      @if (viewMode() === 'list') {
        <div class="flex flex-col gap-4 max-w-5xl mx-auto list-view">
          @for (car of premiumCars(); track car.id; let idx = $index) {
            <a
              [routerLink]="['/cars', car.id]"
              (click)="onCarouselCardClick(car.id, $event)"
              [attr.data-car-id]="car.id"
              [id]="'car-card-' + car.id"
              data-testid="car-card"
              class="bg-white rounded-2xl shadow-sm hover:shadow-md transition-all duration-200 border border-slate-200 overflow-hidden cursor-pointer flex flex-col md:flex-row no-min-touch"
              [class.ring-2]="activeMapCarId() === car.id"
              [class.ring-cyan-500]="activeMapCarId() === car.id"
              (mouseenter)="onCardMouseEnter(car.id)"
              (mouseleave)="onCardMouseLeave()"
            >
              <!-- Image -->
              <div
                class="w-full sm:w-48 md:w-56 lg:w-72 aspect-video md:aspect-[4/3] relative bg-slate-100 flex-shrink-0"
              >
                <img
                  [ngSrc]="car.image_url || '/assets/images/car-placeholder.svg'"
                  [alt]="car.brand + ' ' + car.model"
                  fill
                  [priority]="idx < 2"
                  sizes="(min-width: 1024px) 25vw, (min-width: 768px) 35vw, (min-width: 640px) 45vw, 100vw"
                  class="w-full h-full object-cover"
                />
              </div>
              <!-- Content -->
              <div class="p-5 flex-1 h-full flex flex-col justify-between overflow-hidden">
                <div>
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <h3
                        class="text-xl font-bold text-slate-900"
                        data-testid="car-title"
                      >
                        {{ car.brand }} {{ car.model }}
                      </h3>
                      <p
                        class="text-sm text-slate-500 flex items-center gap-1 mt-1"
                        data-testid="car-location"
                      >
                        <app-icon name="map-pin" [size]="16" cssClass="text-slate-500" />
                        <span class="truncate">{{
                          car.location_city || 'Ubicaci√≥n no disponible'
                        }}</span>
                        @if (car.distanceText) {
                          <span class="text-xs text-slate-500 flex-shrink-0"
                            >¬∑ {{ car.distanceText }}</span
                          >
                        }
                      </p>
                    </div>
                    <div class="text-right">
                      @if (car.price_per_day && car.price_per_day > 0) {
                        <div
                          class="text-2xl font-bold text-cyan-600"
                          data-testid="car-price"
                        >
                          {{ car.price_per_day | money }}
                        </div>
                        <div class="text-xs text-slate-500">por d√≠a</div>
                      } @else {
                        <div class="text-lg font-semibold text-primary-600">Consultar precio</div>
                      }

                      @if (car.rating_avg) {
                        <div class="mt-1 flex items-center justify-end gap-1">
                          <app-icon
                            name="star-filled"
                            [size]="14"
                            cssClass="text-slate-900"
                          />
                          <span class="text-sm font-semibold text-slate-900">{{
                            car.rating_avg | number: '1.1-1'
                          }}</span>
                          @if (car.rating_count) {
                            <span class="text-xs text-slate-500"
                              >({{ car.rating_count }})</span
                            >
                          }
                        </div>
                      }
                    </div>
                  </div>
                  @if (car.description) {
                    <p class="text-slate-600 text-sm line-clamp-2 mb-4">
                      {{ car.description }}
                    </p>
                  }
                  <div class="flex flex-wrap gap-3">
                    <span
                      class="px-3 py-1 bg-slate-100 rounded-full text-xs font-medium text-slate-700 flex items-center gap-1"
                    >
                      <svg
                        class="w-3.5 h-3.5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <circle cx="12" cy="12" r="3" stroke-width="1.75" />
                        <path
                          d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"
                          stroke-width="1.75"
                          stroke-linecap="round"
                        />
                      </svg>
                      {{ car.transmission || 'Manual' }}
                    </span>
                    <span
                      class="px-3 py-1 bg-slate-100 rounded-full text-xs font-medium text-slate-700 flex items-center gap-1"
                    >
                      ‚õΩ {{ car.fuel_type || 'Nafta' }}
                    </span>
                    <span
                      class="px-3 py-1 bg-slate-100 rounded-full text-xs font-medium text-slate-700 flex items-center gap-1"
                    >
                      üë• {{ car.seats || 5 }} asientos
                    </span>
                  </div>
                </div>
              </div>
            </a>
          }
        </div>
      }

      <!-- Empty State -->
      @if (!loading() && !loadError() && premiumCars().length === 0) {
        <div class="text-center py-20" data-testid="empty-state">
          <img
            src="/assets/images/empty-states/empty-search.svg"
            alt="No se encontraron autos"
            class="w-64 h-64 mx-auto mb-6" width="256" height="256" />
          <h3 class="text-xl font-bold text-slate-900 mb-2 font-satoshi">
            No encontramos veh√≠culos
          </h3>
          <p class="text-slate-500">Intenta ajustar tu b√∫squeda o filtros.</p>
        </div>
      }

      <!-- üöÄ INFINITE SCROLL: Sentinel element for IntersectionObserver -->
      @if (premiumCars().length > 0) {
        <div #infiniteScrollSentinel class="w-full h-4" aria-hidden="true"></div>

        <!-- Loading more indicator -->
        @if (loadingMore()) {
          <div class="flex justify-center py-8">
            <div class="flex items-center gap-3 text-slate-500">
              <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                />
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                />
              </svg>
              <span class="text-sm font-medium">Cargando m√°s autos...</span>
            </div>
          </div>
        }

        <!-- Total count indicator -->
        @if (totalCars() > 0 && !serverHasMore() && !loadingMore()) {
          <div class="text-center py-6 text-slate-500 text-sm">
            Mostrando {{ premiumCars().length }} de {{ totalCars() }} veh√≠culos
          </div>
        }
      }
    </div>
    <!-- END LEFT PANEL -->

    <!-- üó∫Ô∏è RIGHT PANEL: Mapa (Desktop: fixed height, Mobile: fullscreen) -->
    @if (viewMode() === 'map') {
      <div
        class="w-full lg:w-1/2 xl:w-[45%] fixed inset-0 z-40 lg:relative lg:inset-auto lg:z-auto lg:h-full flex-shrink-0 overflow-hidden lg:border-l lg:border-slate-200"
        data-testid="cars-map"
      >
        @if (loading() && premiumCars().length === 0) {
          <div
            class="absolute inset-0 z-[401] flex items-center justify-center bg-white/80"
          >
            <div class="text-sm font-semibold text-slate-900">
              Cargando veh√≠culos‚Ä¶
            </div>
          </div>
        }

        @if (!loading() && loadError() && premiumCars().length === 0) {
          <div
            class="absolute inset-0 z-[401] flex items-center justify-center bg-white/80 p-6"
          >
            <div
              class="max-w-md w-full bg-white rounded-xl border border-slate-200 p-4"
            >
              <p class="text-sm font-semibold text-slate-900">Error al cargar</p>
              <p class="text-sm text-slate-600 mt-1">{{ loadError() }}</p>
              <button
                type="button"
                (click)="loadCars()"
                class="mt-4 w-full px-3 py-2 rounded-lg bg-cyan-600 hover:bg-cyan-700 active:bg-cyan-800 text-white text-sm font-semibold"
              >
                Reintentar
              </button>
            </div>
          </div>
        }

        @if (!loading() && !loadError() && premiumCars().length === 0) {
          <div
            class="absolute inset-0 z-[401] flex items-center justify-center bg-white/80 p-6"
          >
            <div class="max-w-md w-full text-center">
              <p class="text-sm font-semibold text-slate-900">
                No encontramos veh√≠culos
              </p>
              <p class="text-sm text-slate-600 mt-1">
                Intenta ajustar tu b√∫squeda o filtros.
              </p>
            </div>
          </div>
        }

        <app-cars-map
          [cars]="carMapLocations()"
          [selectedCarId]="activeMapCarId()"
          [userLocation]="userLocation()"
          (carSelected)="onMapCarSelected($event)"
          (userLocationChange)="onUserLocationChange($event)"
          class="w-full h-full"
        ></app-cars-map>

        <!-- Urgent Banner over map -->
        @if (selectedCarId() && urgentAvailability()?.available) {
          <div class="absolute bottom-6 left-0 right-0 px-4 z-[400] pointer-events-none">
            <div class="max-w-2xl mx-auto pointer-events-auto">
              <app-urgent-rental-banner
                [carId]="selectedCarId()!"
                [regionId]="selectedCar()?.region_id || ''"
                [expressMode]="expressModeSignal"
              />
            </div>
          </div>
        }

        <!-- Map Controls Overlay -->
        <div class="absolute top-20 lg:top-4 left-4 z-10 flex flex-col gap-2">
          <button
            type="button"
            class="w-11 h-11 bg-white rounded-xl shadow-xl border-2 border-slate-300 flex items-center justify-center hover:bg-primary-50 hover:border-primary-400 active:scale-95 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed group"
            [class.ring-2]="isCenteredOnUser()"
            [class.ring-primary-500]="isCenteredOnUser()"
            [disabled]="isLocating()"
            [attr.aria-busy]="isLocating()"
            [attr.aria-pressed]="isCenteredOnUser()"
            (click)="centerOnUserLocation()"
            title="Mi ubicaci√≥n"
            aria-label="Centrar mapa en mi ubicaci√≥n actual"
          >
            @if (isLocating()) {
              <svg class="w-5 h-5 animate-spin text-primary-600" viewBox="0 0 24 24" fill="none">
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                />
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"
                />
              </svg>
            } @else {
              <app-icon
                name="location"
                [size]="22"
                cssClass="text-slate-600 group-hover:text-primary-600 transition-colors"
              />
            }
          </button>
        </div>
      </div>
      <!-- END RIGHT PANEL -->
    }
  </div>
  <!-- END SPLIT VIEW CONTAINER -->

  <!-- üì± Mobile Car Carousel (Bottom of Map) - Premium 10/10 Design -->
  @if (viewMode() === 'map') {
    <div
      class="fixed bottom-[72px] left-0 right-0 z-[100] lg:hidden"
      data-testid="mobile-car-carousel"
    >
      <!-- Glass Container with inner glow -->
      <div class="mx-2 bg-white/80 backdrop-blur-2xl rounded-[20px] shadow-[0_8px_32px_rgba(0,0,0,0.12)] border border-white/60 p-2.5 relative overflow-hidden">
        <!-- Inner glow effect -->
        <div class="absolute inset-0 bg-gradient-to-b from-white/40 to-transparent pointer-events-none rounded-[20px]"></div>

        <!-- Carousel wrapper with fade edges -->
        <div class="relative">
          <!-- Left fade indicator -->
          <div class="absolute left-0 top-0 bottom-0 w-6 bg-gradient-to-r from-white/90 to-transparent z-10 pointer-events-none rounded-l-xl"></div>
          <!-- Right fade indicator -->
          <div class="absolute right-0 top-0 bottom-0 w-6 bg-gradient-to-l from-white/90 to-transparent z-10 pointer-events-none rounded-r-xl"></div>

          <!-- Carousel Track -->
          <div
            #unifiedCarousel
            class="flex flex-nowrap gap-2.5 overflow-x-auto snap-x snap-mandatory scrollbar-hide px-1"
            style="-webkit-overflow-scrolling: touch"
          >
          @for (car of premiumCars(); track car.id; let idx = $index) {
            <a
              [routerLink]="['/cars', car.id]"
              (click)="onCarouselCardClick(car.id, $event)"
              [attr.data-car-id]="car.id"
              class="flex-shrink-0 w-[260px] snap-start bg-white rounded-2xl shadow-[0_2px_12px_rgba(0,0,0,0.08)] border border-slate-100 overflow-hidden transition-all duration-300 active:scale-[0.97] mobile-map-carousel-card no-min-touch hover:shadow-[0_4px_20px_rgba(0,0,0,0.12)] cursor-pointer"
              [class.ring-2]="activeMapCarId() === car.id"
              [class.ring-cyan-400]="activeMapCarId() === car.id"
              [class.shadow-cyan-100]="activeMapCarId() === car.id"
            >
              <div class="flex h-[100px]">
                <!-- Car Image with overlay -->
                <div class="w-[92px] h-full flex-shrink-0 bg-gradient-to-br from-slate-100 to-slate-200 relative overflow-hidden">
                  <img
                    [ngSrc]="car.image_url || '/assets/images/car-placeholder.svg'"
                    [alt]="car.brand + ' ' + car.model"
                    width="92"
                    height="100"
                    [priority]="idx < 3"
                    class="w-full h-full object-cover"
                  />
                  <!-- Subtle gradient overlay -->
                  <div class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent"></div>
                  <!-- Top Rated Badge -->
                  @if (carBadges().get(car.id)?.topRated) {
                    <span class="absolute top-1.5 left-1.5 px-1.5 py-0.5 bg-gradient-to-r from-amber-400 to-amber-500 text-white text-[8px] font-bold rounded-full shadow-sm flex items-center gap-0.5">
                      <svg class="w-2 h-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                      TOP
                    </span>
                  }
                </div>
                <!-- Car Info -->
                <div class="flex-1 h-full p-2 min-w-0 flex flex-col justify-between overflow-hidden">
                  <!-- Header: Title + Rating -->
                  <div>
                    <div class="flex items-start justify-between gap-1.5">
                      <h4 class="font-semibold text-[12px] text-slate-800 truncate leading-4 tracking-tight">
                        {{ car.brand }} {{ car.model }}
                      </h4>
                      <!-- Always show rating -->
                      <div class="flex items-center gap-0.5 flex-shrink-0 bg-slate-50 px-1.5 py-0.5 rounded-full">
                        <svg class="w-3 h-3 text-amber-400" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <span class="text-[10px] font-bold text-slate-700">{{ car.rating_avg ? (car.rating_avg | number: '1.1-1') : '5.0' }}</span>
                      </div>
                    </div>
                    <p class="text-[10px] text-slate-400 truncate mt-0.5 font-medium">
                      {{ car.location_city || 'Buenos Aires' }}
                    </p>
                  </div>
                  <!-- Footer: Price + CTA -->
                  <div class="flex items-center justify-between">
                    @if (car.price_per_day && car.price_per_day > 0) {
                      <div class="flex items-baseline gap-0.5">
                        <span class="font-bold text-[14px] text-slate-900 tracking-tight leading-5">{{ car.price_per_day | money }}</span>
                        <span class="text-[9px] font-medium text-slate-400">/d√≠a</span>
                      </div>
                    } @else {
                      <span class="font-semibold text-[11px] text-cyan-600">Consultar</span>
                    }
                    <span class="inline-flex items-center gap-1 px-2.5 py-1.5 text-[10px] font-bold text-white bg-gradient-to-r from-cyan-500 to-cyan-600 rounded-lg shadow-[0_2px_8px_rgba(6,182,212,0.35)] hover:shadow-[0_4px_12px_rgba(6,182,212,0.45)] transition-shadow">
                      Ver
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                      </svg>
                    </span>
                  </div>
                </div>
              </div>
            </a>
          }
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Sticky CTA Mobile -->
  @if (selectedCarId() && selectedCarPrice()) {
    <app-sticky-cta-mobile
      [pricePerDay]="selectedCarPrice()!"
      [ctaText]="'Rentar ahora'"
      [expressMode]="urgentAvailability()?.available || false"
      (ctaClick)="onReserveClick(selectedCarId()!)"
    />
  }

  <!-- Floating Actions Pill (Map/List + Filters) -->
  @if (!loading()) {
    <div
      class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-40 flex items-center gap-3 lg:hidden"
    >
      <!-- Map/List Toggle -->
      <button
        type="button"
        (click)="viewMode() === 'map' ? viewMode.set('grid') : viewMode.set('map')"
        [attr.aria-pressed]="viewMode() === 'map'"
        [attr.aria-label]="viewMode() === 'map' ? 'Cambiar a vista lista' : 'Cambiar a vista mapa'"
        class="flex items-center gap-2 px-5 py-3 bg-text-primary text-text-inverse rounded-full shadow-2xl font-bold text-sm tracking-wide hover:bg-black transition-all active:scale-95 border border-white/10"
      >
        @if (viewMode() !== 'map') {
          <span>Mapa</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
            />
          </svg>
        } @else {
          <span>Lista</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        }
      </button>
    </div>
  }
</section>
