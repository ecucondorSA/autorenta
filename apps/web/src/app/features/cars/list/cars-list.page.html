<section class="cars-map-page bg-ivory-soft dark:bg-graphite-dark transition-colors duration-300">
  <!-- ✅ FIXED: Uso de app-car-card para precios dinámicos consistentes -->
  <ng-template #carouselCard let-car>
    <div class="map-carousel-card-wrapper" role="listitem" [attr.data-car-id]="car.id">
      <app-car-card
        [car]="car"
        [selected]="isCarSelected(car.id)"
        [distance]="car.distanceText"
        (click)="onCarSelected(car.id)"
        class="map-carousel-card--dynamic"
        [attr.aria-label]="'Ver más sobre ' + (car.title || 'este auto económico')"
      ></app-car-card>
    </div>
  </ng-template>

  <!-- Mapa full-width (sin panel lateral) -->
  <div class="w-full h-screen">
    <div id="map-container" class="w-full h-full relative">
      <app-cars-map
        [cars]="carMapLocations()"
        [selectedCarId]="selectedCarId()"
        (carSelected)="onMapCarSelected($event)"
        (userLocationChange)="onUserLocationChange($event)"
      ></app-cars-map>

      <div class="pointer-events-none absolute inset-0">
        <div class="map-controls pointer-events-auto">
          <div
            id="filters"
            data-tour-step="guided-search"
            class="map-controls__filters filter-section"
          >
            <app-map-filters
              (filtersChange)="onFiltersChange($event)"
              (filtersReset)="onFiltersReset()"
            ></app-map-filters>
          </div>
          <div class="map-controls__sort">
            <label class="sr-only" for="sort-by">Ordenar resultados</label>
            <select
              id="sort-by"
              [value]="sortBy()"
              (change)="onSortChange($any($event.target).value)"
              class="map-controls__select"
            >
              <option value="distance">Más cercanos</option>
              <option value="price_asc">Precio: menor a mayor</option>
              <option value="price_desc">Precio: mayor a menor</option>
              <option value="rating">Mejor valorados</option>
              <option value="newest">Más nuevos</option>
            </select>
          </div>
        </div>

        <!-- Carousel de autos económicos (solo desktop) -->
        <div
          *ngIf="showEconomyCarousel()"
          class="hidden md:block map-carousel-container pointer-events-none"
          role="region"
          [attr.aria-label]="'Autos cercanos y económicos'"
        >
          <div class="map-carousel-heading pointer-events-auto">
            <span class="map-carousel-heading__pill">
              Cercanos y económicos
            </span>
          </div>
          <div
            #unifiedCarousel
            class="map-carousel pointer-events-auto"
            data-tour-step="guided-select-car"
            role="list"
            (mouseenter)="onCarouselMouseEnter()"
            (mouseleave)="onCarouselMouseLeave()"
            (touchstart)="onCarouselMouseEnter()"
            (touchend)="onCarouselMouseLeave()"
          >
            <ng-container *ngFor="let car of economyCars(); trackBy: trackByCarId">
              <ng-container
                [ngTemplateOutlet]="carouselCard"
                [ngTemplateOutletContext]="{ $implicit: car }"
              ></ng-container>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
