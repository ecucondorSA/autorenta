<div
  class="min-h-screen bg-surface-base dark:bg-surface-base py-8 px-4 transition-colors duration-300 text-text-primary dark:text-text-secondary"
>
  <div class="max-w-6xl mx-auto">
    <!-- Hero -->
    <div class="grid gap-6 mb-8 lg:grid-cols-5">
      <div
        class="lg:col-span-3 bg-surface-raised dark:bg-surface-raised rounded-2xl shadow-soft border border-border-default/70 dark:border-neutral-800/70 p-6 transition-colors"
      >
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <p
              class="text-xs uppercase tracking-wide text-text-secondary/70 dark:text-text-secondary/60"
            >
              Publicar Auto
            </p>
            <h1 class="text-3xl font-bold text-text-primary dark:text-text-primary mt-1">
              {{ editMode() ? 'Editar Auto' : 'Completa la informaci√≥n de tu veh√≠culo' }}
            </h1>
            <p class="text-sm text-text-secondary dark:text-text-secondary/75 mt-2 max-w-xl">
              Ingres√° datos del veh√≠culo, condiciones y fotos. Este flujo te gu√≠a para que la
              publicaci√≥n quede lista para revisi√≥n.
            </p>
          </div>
          <div class="hidden sm:flex flex-col text-right">
            <p class="text-xs text-text-secondary/70 dark:text-text-secondary/60">Paso 2 de 2</p>
            <div class="flex items-center gap-2 mt-2">
              <span class="h-2 rounded-full bg-primary-600 dark:bg-cta-default w-14"></span>
              <span class="h-2 rounded-full bg-primary-100 dark:bg-neutral-700 w-6"></span>
            </div>
          </div>
        </div>

        <div class="mt-6 grid gap-4 sm:grid-cols-3">
          <div class="rounded-xl border border-border-default/70 dark:border-neutral-800/70 p-4">
            <p
              class="text-xs uppercase tracking-wide text-text-secondary/70 dark:text-text-secondary/60"
            >
              Fotos listas
            </p>
            <p class="text-2xl font-bold text-cta-default dark:text-cta-default/80">
              {{ uploadedPhotos().length }}/10
            </p>
            <p class="text-xs text-text-secondary dark:text-text-secondary/70 mt-1">
              Necesit√°s al menos 3
            </p>
          </div>
          <div class="rounded-xl border border-border-default/70 dark:border-neutral-800/70 p-4">
            <p
              class="text-xs uppercase tracking-wide text-text-secondary/70 dark:text-text-secondary/60"
            >
              Revisi√≥n estimada
            </p>
            <p class="text-2xl font-bold text-warning-light dark:text-warning-light/90">24-48h</p>
            <p class="text-xs text-text-secondary dark:text-text-secondary/70 mt-1">
              Te avisamos por mail cada cambio
            </p>
          </div>
          <div class="rounded-xl border border-border-default/70 dark:border-neutral-800/70 p-4">
            <p
              class="text-xs uppercase tracking-wide text-text-secondary/70 dark:text-text-secondary/60"
            >
              Comisi√≥n
            </p>
            <p class="text-2xl font-bold text-cta-default dark:text-cta-default/80">15-25%</p>
            <p class="text-xs text-text-secondary dark:text-text-secondary/70 mt-1">
              Dependiendo de categor√≠a
            </p>
          </div>
        </div>

        <div
          *ngIf="editMode()"
          class="mt-4 bg-warning-bg/90 dark:bg-warning-bg0/15 border border-warning-border dark:border-warning-400/50 rounded-lg p-3 flex items-start gap-2"
        >
          <span class="text-warning-text dark:text-warning-200 text-lg">‚úèÔ∏è</span>
          <div class="flex-1">
            <p class="text-sm text-warning-strong dark:text-warning-100 font-medium">Modo edici√≥n</p>
            <p class="text-xs text-warning-text dark:text-warning-100/80 mt-1">
              Est√°s editando un auto existente. Los cambios se guardan al enviar el formulario.
            </p>
          </div>
        </div>
        <div
          *ngIf="autofilledFromLast() && !editMode()"
          class="mt-4 bg-cta-default/10 dark:bg-cta-default/15 border border-cta-default/30 dark:border-cta-default/40 rounded-lg p-3 flex items-start gap-2"
        >
          <span class="text-cta-default dark:text-text-primary text-lg">‚ÑπÔ∏è</span>
          <div class="flex-1">
            <p class="text-sm text-cta-default dark:text-text-primary font-medium">
              Datos autocompletados
            </p>
            <p class="text-xs text-cta-default/80 dark:text-text-secondary/80 mt-1">
              Usamos tu √∫ltima publicaci√≥n para ahorrar tiempo. Revis√° marca, modelo y fotos antes
              de confirmar.
            </p>
          </div>
        </div>

        <div
          *ngIf="mpStatusLoading()"
          class="mt-4 flex items-center gap-3 rounded-lg border border-border-default/50 bg-surface-raised/70 p-3 text-sm text-text-secondary dark:border-neutral-700 dark:bg-surface-raised/60 dark:text-text-secondary/80"
        >
          <span class="inline-flex h-2.5 w-2.5 animate-ping rounded-full bg-cta-default"></span>
          Comprobando el estado de tu cuenta de Mercado Pago...
        </div>

        <div
          *ngIf="mpStatusError()"
          class="mt-4 rounded-xl border border-error-border bg-error-bg/90 p-4 text-sm text-error-strong dark:border-error-border/60 dark:bg-error-bg0/10 dark:text-error-200"
        >
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div class="flex items-start gap-2">
              <span class="text-lg">‚ö†Ô∏è</span>
              <div>
                <p class="font-semibold">No pudimos verificar Mercado Pago</p>
                <p class="text-xs md:text-sm">
                  {{ mpStatusError() }}. Intent√° nuevamente en unos minutos o volv√© a vincular tu
                  cuenta.
                </p>
              </div>
            </div>
            <button
              type="button"
              class="rounded-lg border border-error-300/80 px-4 py-2 text-xs font-semibold text-error-strong transition hover:bg-error-bg-hover/80 dark:border-error-400/50 dark:bg-transparent dark:text-error-100 dark:hover:bg-error-bg0/20"
              (click)="openOnboardingModal()"
            >
              Reintentar vinculaci√≥n
            </button>
          </div>
        </div>

        <div
          *ngIf="showMpBanner()"
          class="mt-4 rounded-2xl border border-cta-default/40/80 bg-cta-default/10/80 p-5 text-sm text-cta-default shadow-sm dark:border-cta-default/40 dark:bg-cta-default/15 dark:text-cta-default"
        >
          <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div class="flex items-start gap-3">
              <span class="text-2xl leading-none">üí≥</span>
              <div class="space-y-1">
                <p class="text-base font-semibold">Conect√° Mercado Pago y empez√° a ganar</p>
                <p class="text-xs md:text-sm md:max-w-xl">
                  Conect√° tu cuenta en 30 segundos y empez√° a recibir reservas con pagos
                  autom√°ticos. Tu auto se guardar√° como borrador y podr√°s activarlo cuando quieras.
                </p>
              </div>
            </div>
            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                class="rounded-lg bg-cta-default text-cta-text shadow-soft transition hover:bg-cta-default/90 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-600"
                (click)="openOnboardingModal()"
              >
                Conectar ahora
              </button>
              <button
                type="button"
                class="rounded-lg border border-transparent px-4 py-2 text-sm font-medium text-cta-default/80 transition hover:bg-cta-default/20/80 dark:text-cta-default/90 dark:hover:bg-cta-default/25"
                (click)="dismissOnboardingReminder()"
              >
                Recordarme luego
              </button>
            </div>
          </div>
        </div>

        <div
          *ngIf="!mpStatusLoading() && mpReady()"
          class="mt-4 rounded-2xl border border-emerald-200/80 bg-success-light/10/90 p-5 text-sm text-success-light shadow-sm dark:border-emerald-400/40 dark:bg-success-light/20 dark:text-success-light"
        >
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div class="flex items-start gap-3">
              <span class="text-2xl leading-none">‚úÖ</span>
              <div class="space-y-1">
                <p class="text-base font-semibold">Mercado Pago vinculado correctamente</p>
                <p class="text-xs md:text-sm md:max-w-xl">
                  Recibir√°s pagos autom√°ticos con split inmediato en cada reserva confirmada.
                </p>
                <p
                  *ngIf="mpStatus()?.collectorId"
                  class="text-xs text-success-light/80 dark:text-success-light/80"
                >
                  Collector ID: {{ mpStatus()?.collectorId }}
                </p>
                <!-- TODO: Fix MarketplaceStatus type conflict between services -->
                <!-- <p
                  *ngIf="mpStatus()?.completedAt"
                  class="text-xs text-success-light/80 dark:text-success-light/80"
                >
                  Onboarding completado
                  {{ mpStatus()?.completedAt | date: 'dd/MM/yyyy HH:mm' }}.
                </p> -->
              </div>
            </div>
            <button
              type="button"
              class="rounded-lg border border-emerald-300/60 px-4 py-2 text-sm font-medium text-success-light transition hover:bg-success-light/20 dark:border-emerald-400/40 dark:text-success-light dark:hover:bg-success-light/25"
              (click)="openOnboardingModal()"
            >
              Ver opciones
            </button>
          </div>
        </div>
      </div>

      <div
        class="lg:col-span-2 rounded-2xl border border-border-default/70 dark:border-neutral-800/70 bg-gradient-to-br from-sand-light to-ivory-soft dark:from-slate-deep/40 dark:to-anthracite p-6 shadow-soft"
      >
        <h3
          class="text-lg font-semibold text-text-primary dark:text-text-primary mb-3 flex items-center gap-2"
        >
          <span>üß≠</span> Checklist r√°pido
        </h3>
        <ul class="space-y-3 text-sm text-text-secondary dark:text-text-secondary/80">
          <li class="flex items-start gap-2">
            <span class="text-cta-default mt-0.5">‚Ä¢</span>Sub√≠ al menos 3 fotos con buena
            iluminaci√≥n.
          </li>
          <li class="flex items-start gap-2">
            <span class="text-cta-default mt-0.5">‚Ä¢</span>Ingres√° el valor estimado para calcular
            seguros y dep√≥sitos.
          </li>
          <li class="flex items-start gap-2">
            <span class="text-cta-default mt-0.5">‚Ä¢</span>Defin√≠ precios, m√≠nimos y dep√≥sito seg√∫n
            tu disponibilidad.
          </li>
          <li class="flex items-start gap-2">
            <span class="text-cta-default mt-0.5">‚Ä¢</span>Complet√° direcci√≥n exacta para habilitar
            mapa y retiro.
          </li>
        </ul>
        <div
          class="mt-5 rounded-xl bg-surface-raised dark:bg-surface-raised border border-border-default/50 dark:border-neutral-800/50 p-4 text-sm"
        >
          <p class="font-semibold text-text-primary dark:text-text-primary mb-2">Workflow</p>
          <ol
            class="list-decimal list-inside space-y-1 text-text-secondary dark:text-text-secondary/70"
          >
            <li>Informaci√≥n del veh√≠culo</li>
            <li>Precio y condiciones</li>
            <li>Ubicaci√≥n</li>
            <li>Fotos y revisi√≥n final</li>
          </ol>
        </div>
      </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-5">
      <div class="lg:col-span-3">
        <!-- Main Form -->
        <form [formGroup]="publishForm" (ngSubmit)="onSubmit()" class="space-y-6">
          <!-- 1. Veh√≠culo -->
          <div class="publish-card bg-surface-raised rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-text-primary mb-4 flex items-center gap-2">
              <span class="text-2xl">üöó</span>
              Informaci√≥n del Veh√≠culo
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Brand -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-text-primary mb-2">Marca *</label>
                <select
                  formControlName="brand_id"
                  (change)="onBrandChange()"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                >
                  <option value="">Selecciona una marca</option>
                  <option *ngFor="let brand of brands()" [value]="brand.id">
                    {{ brand.name }}
                  </option>
                </select>
              </div>

              <!-- Model -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-text-primary mb-2">Modelo *</label>
                <select
                  formControlName="model_id"
                  (change)="onModelChange()"
                  [disabled]="!publishForm.get('brand_id')?.value"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent disabled:bg-surface-raised"
                >
                  <option value="">Selecciona un modelo</option>
                  <option *ngFor="let model of filteredModels()" [value]="model.id">
                    {{ model.name }}
                  </option>
                </select>
                <p *ngIf="selectedModelInfo()" class="mt-1 text-xs text-text-secondary">
                  {{ selectedModelInfo()?.category }} ‚Ä¢ {{ selectedModelInfo()?.seats }} asientos ‚Ä¢
                  {{ selectedModelInfo()?.doors }} puertas
                </p>
              </div>

              <!-- Year -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">A√±o *</label>
                <input
                  type="number"
                  formControlName="year"
                  [min]="minYear"
                  [max]="maxYear"
                  placeholder="2024"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
              </div>

              <!-- Mileage -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Kilometraje *</label>
                <input
                  type="number"
                  formControlName="mileage"
                  min="0"
                  placeholder="50000"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
              </div>

              <!-- Color -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Color *</label>
                <input
                  type="text"
                  formControlName="color"
                  placeholder="Ej: Blanco, Negro"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
              </div>

              <!-- Transmission -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Transmisi√≥n *</label>
                <select
                  formControlName="transmission"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default"
                >
                  <option value="">Selecciona</option>
                  <option value="manual">Manual</option>
                  <option value="automatic">Autom√°tica</option>
                </select>
              </div>

              <!-- Fuel -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Combustible *</label>
                <select
                  formControlName="fuel"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default"
                >
                  <option value="">Selecciona</option>
                  <option value="nafta">Nafta</option>
                  <option value="gasoil">Diesel</option>
                  <option value="electrico">El√©ctrico</option>
                  <option value="hibrido">H√≠brido</option>
                </select>
              </div>
            </div>
          </div>

          <!-- 2. Precio -->
          <div class="publish-card bg-surface-raised rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-text-primary mb-4 flex items-center gap-2">
              <span class="text-2xl">üí∞</span>
              Precio y Condiciones
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Price per day -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2"
                  >Modo de precios *</label
                >
                <div class="grid xs:grid-cols-2 gap-3">
                  <button
                    type="button"
                    class="w-full rounded-xl border px-4 py-3 text-left transition"
                    [class.border-primary-600]="isDynamicPricing()"
                    [class.bg-primary-50]="isDynamicPricing()"
                    [class.text-primary-700]="isDynamicPricing()"
                    [class.border-border-muted]="!isDynamicPricing()"
                    (click)="setPricingStrategy('dynamic')"
                  >
                    <p class="text-sm font-semibold flex items-center gap-2">
                      Precio din√°mico
                      <span
                        class="text-2xs uppercase tracking-wide bg-primary-100 text-primary-700 px-2 py-0.5 rounded-full"
                        >Recomendado</span
                      >
                    </p>
                    <p class="text-xs text-text-secondary mt-1">
                      AutoRenta ajusta el valor seg√∫n demanda y temporada.
                    </p>
                  </button>
                  <button
                    type="button"
                    class="w-full rounded-xl border px-4 py-3 text-left transition"
                    [class.border-primary-600]="!isDynamicPricing()"
                    [class.bg-primary-50]="!isDynamicPricing()"
                    [class.text-primary-700]="!isDynamicPricing()"
                    [class.border-border-muted]="isDynamicPricing()"
                    (click)="setPricingStrategy('custom')"
                  >
                    <p class="text-sm font-semibold">Precio personalizado</p>
                    <p class="text-xs text-text-secondary mt-1">Defin√≠ manualmente el valor diario.</p>
                  </button>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-text-primary mb-2 flex items-center gap-2">
                  Precio por d√≠a *
                  <span class="text-xs text-text-secondary" *ngIf="isDynamicPricing()"
                    >(AutoRenta lo ajustar√° autom√°ticamente)</span
                  >
                </label>
                <input
                  type="number"
                  formControlName="price_per_day"
                  min="1"
                  placeholder="50"
                  [readonly]="isDynamicPricing()"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent disabled:bg-surface-raised"
                />
                <p class="mt-1 text-xs text-text-secondary" *ngIf="!isDynamicPricing()">
                  Puedes actualizar este valor cuando quieras desde tu panel.
                </p>
              </div>

              <!-- Currency -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Moneda *</label>
                <select
                  formControlName="currency"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default"
                >
                  <option value="USD">USD - D√≥lar</option>
                  <option value="ARS">ARS - Peso Argentino</option>
                  <option value="UYU">UYU - Peso Uruguayo</option>
                </select>
              </div>

              <!-- ‚úÖ NUEVO: Valor del Veh√≠culo (USD) -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-text-primary mb-2 flex items-center gap-2">
                  Valor Estimado del Veh√≠culo (USD) *
                  <span
                    class="text-xs text-text-secondary font-normal"
                    title="Este valor se usa para calcular seguros y garant√≠as"
                    >‚ÑπÔ∏è</span
                  >
                </label>
                <input
                  type="number"
                  formControlName="value_usd"
                  min="5000"
                  max="500000"
                  placeholder="15000"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
                <p class="mt-1 text-xs text-text-secondary">
                  Ingresa el valor aproximado de mercado de tu veh√≠culo. Este valor se usa para
                  calcular coberturas de seguro y dep√≥sitos de garant√≠a.
                </p>
              </div>

              <!-- Min rental days -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">D√≠as m√≠nimos *</label>
                <input
                  type="number"
                  formControlName="min_rental_days"
                  min="1"
                  placeholder="1"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
              </div>

              <!-- Max rental days -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">D√≠as m√°ximos</label>
                <input
                  type="number"
                  formControlName="max_rental_days"
                  min="1"
                  placeholder="30"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
                <p class="mt-1 text-xs text-text-secondary">Dejar vac√≠o = sin l√≠mite</p>
              </div>

              <!-- Deposit -->
              <div class="md:col-span-2 border-t border-border-default pt-4">
                <div class="flex items-center gap-3 mb-3">
                  <input
                    type="checkbox"
                    formControlName="deposit_required"
                    id="deposit_required"
                    class="w-5 h-5 text-cta-default rounded focus:ring-2 focus:ring-cta-default"
                  />
                  <label
                    for="deposit_required"
                    class="text-sm font-medium text-text-primary cursor-pointer"
                  >
                    Requiere dep√≥sito de garant√≠a
                  </label>
                </div>
                <div *ngIf="publishForm.get('deposit_required')?.value">
                  <input
                    type="number"
                    formControlName="deposit_amount"
                    min="0"
                    placeholder="200"
                    class="w-full md:w-1/2 rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                  />
                  <p class="mt-1 text-xs text-text-secondary">Monto del dep√≥sito</p>
                </div>
              </div>

              <!-- Insurance -->
              <div class="md:col-span-2">
                <div class="flex items-center gap-3">
                  <input
                    type="checkbox"
                    formControlName="insurance_included"
                    id="insurance_included"
                    class="w-5 h-5 text-cta-default rounded focus:ring-2 focus:ring-cta-default"
                  />
                  <label
                    for="insurance_included"
                    class="text-sm font-medium text-text-primary cursor-pointer"
                  >
                    El seguro est√° incluido en el precio
                  </label>
                </div>
              </div>

              <!-- Auto-approval -->
              <div class="md:col-span-2">
                <div
                  class="flex items-start gap-3 p-4 bg-cta-default/10 dark:bg-cta-default/20 rounded-lg border border-cta-default/40 dark:border-cta-default"
                >
                  <input
                    type="checkbox"
                    formControlName="auto_approval"
                    id="auto_approval"
                    class="w-5 h-5 text-cta-default rounded focus:ring-2 focus:ring-cta-default mt-0.5"
                  />
                  <div class="flex-1">
                    <label
                      for="auto_approval"
                      class="text-sm font-medium text-text-primary dark:text-text-primary cursor-pointer block mb-1"
                    >
                      Aprobar reservas autom√°ticamente
                    </label>
                    <p class="text-xs text-text-secondary dark:text-text-secondary/75">
                      Las reservas se aprobar√°n instant√°neamente sin tu intervenci√≥n. Si no est√°
                      activado, tendr√°s 24 horas para revisar y aprobar cada solicitud.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 3. Ubicaci√≥n -->
          <div class="publish-card bg-surface-raised rounded-lg shadow-sm p-6">
            <h2 class="text-xl font-semibold text-text-primary mb-4 flex items-center gap-2">
              <span class="text-2xl">üìç</span>
              Ubicaci√≥n
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Street -->
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-text-primary mb-2">Calle *</label>
                <input
                  type="text"
                  formControlName="location_street"
                  placeholder="Ej: Av. Corrientes"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
              </div>

              <!-- Street number -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">N√∫mero *</label>
                <input
                  type="text"
                  formControlName="location_street_number"
                  placeholder="1234"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
              </div>

              <!-- City -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Ciudad *</label>
                <input
                  type="text"
                  formControlName="location_city"
                  placeholder="Ej: Buenos Aires"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
              </div>

              <!-- State -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Provincia *</label>
                <input
                  type="text"
                  formControlName="location_state"
                  placeholder="Ej: Buenos Aires"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default focus:border-transparent"
                />
              </div>

              <!-- Country -->
              <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Pa√≠s *</label>
                <select
                  formControlName="location_country"
                  class="w-full rounded-lg border border-border-muted px-4 py-2.5 focus:ring-2 focus:ring-cta-default"
                >
                  <option value="AR">Argentina</option>
                  <option value="UY">Uruguay</option>
                  <option value="BR">Brasil</option>
                  <option value="CL">Chile</option>
                  <option value="PY">Paraguay</option>
                </select>
              </div>
            </div>

            <!-- GPS Location Button - Minimalist -->
            <div class="mt-4 flex items-center justify-between">
              <button
                type="button"
                (click)="useCurrentLocation()"
                class="btn-secondary flex items-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                    clip-rule="evenodd"
                  />
                </svg>
                üìç Usar Mi Ubicaci√≥n
              </button>
              <div *ngIf="manualCoordinates()" class="text-xs text-text-primary">‚úì GPS activo</div>
            </div>
          </div>

          <!-- 4. Fotos -->
          <div
            class="publish-card bg-surface-raised dark:bg-surface-raised rounded-2xl border border-border-default/70 dark:border-neutral-800/70 shadow-sm p-6"
          >
            <h2 class="text-xl font-semibold text-text-primary mb-4 flex items-center gap-2">
              <span class="text-2xl">üì∏</span>
              Fotos ({{ uploadedPhotos().length }}/10)
            </h2>

            <div class="mb-4 space-y-3">
              <!-- Bot√≥n principal: Agregar fotos manuales -->
              <div class="flex flex-wrap gap-3">
                <label
                  class="cursor-pointer bg-cta-default text-cta-text px-6 py-3 rounded-lg transition inline-flex items-center gap-2"
                  [class.opacity-50]="isProcessingPhotos()"
                  [class.cursor-not-allowed]="isProcessingPhotos()"
                >
                  <span *ngIf="!isProcessingPhotos()">‚ûï Agregar Fotos</span>
                  <span *ngIf="isProcessingPhotos()" class="flex items-center gap-2">
                    <svg
                      class="animate-spin h-5 w-5"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                    >
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="4"
                      ></circle>
                      <path
                        class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                      ></path>
                    </svg>
                    Procesando...
                  </span>
                  <input
                    type="file"
                    accept="image/*"
                    multiple
                    (change)="onPhotoSelected($event)"
                    class="hidden"
                    [disabled]="isProcessingPhotos()"
                  />
                </label>

                <!-- Bot√≥n: Buscar fotos de stock -->
                <button
                  type="button"
                  (click)="showStockPhotosModal.set(true)"
                  [disabled]="uploadedPhotos().length >= 10"
                  class="bg-cta-default text-cta-text px-6 py-3 rounded-lg transition inline-flex items-center gap-2"
                >
                  üì∏ Buscar Fotos de Stock
                </button>

                <!-- Bot√≥n: Generar con IA -->
                <button
                  type="button"
                  (click)="showAIPhotosModal.set(true)"
                  [disabled]="uploadedPhotos().length >= 10"
                  class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-text-inverse px-6 py-3 rounded-lg transition inline-flex items-center gap-2"
                >
                  ‚ú® Generar con IA
                </button>
              </div>

              <!-- Ayuda y tips -->
              <p class="text-xs text-text-secondary">
                M√≠nimo 3 fotos, m√°ximo 10. Primera foto ser√° la portada.
                <br />
                <span class="text-cta-default dark:text-warning-light font-medium"
                  >‚ú® Las fotos se procesar√°n autom√°ticamente para remover el fondo</span
                >
                <br />
                <span class="text-purple-600 dark:text-pink-400 font-medium"
                  >ü§ñ O genera fotos profesionales con IA seleccionando primero marca y modelo</span
                >
              </p>
            </div>

            <div *ngIf="uploadedPhotos().length > 0" class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div *ngFor="let photo of uploadedPhotos(); let i = index" class="relative group">
                <img
                  [src]="photo.preview"
                  [alt]="'Foto ' + (i + 1)"
                  class="w-full h-32 object-cover rounded-lg border-2"
                  [class.border-cta-default]="i === 0"
                  [class.border-border-muted]="i !== 0"
                />
                <div
                  *ngIf="i === 0"
                  class="absolute top-2 left-2 bg-cta-default text-cta-text text-xs font-semibold px-2 py-1 rounded"
                >
                  PORTADA
                </div>
                <button
                  type="button"
                  (click)="removePhoto(i)"
                  class="absolute top-2 right-2 bg-error-600 text-text-inverse p-1.5 rounded opacity-0 group-hover:opacity-100 transition"
                >
                  ‚úï
                </button>
              </div>
            </div>

            <div
              class="mt-3 rounded-xl border border-dashed border-border-default/70 dark:border-neutral-800/70 bg-surface-base/70 dark:bg-neutral-900/60 p-3 text-xs text-text-secondary dark:text-text-secondary/70"
            >
              üí° Tip: combin√° exteriores, interiores y tablero. La primera foto debe mostrar el auto
              completo con buena iluminaci√≥n.
            </div>

            <div
              *ngIf="uploadedPhotos().length < 3"
              class="mt-4 bg-warning-bg border border-warning-border rounded-lg p-3"
            >
              <p class="text-sm text-warning-strong">
                ‚ö†Ô∏è Necesitas al menos 3 fotos para publicar. Actualmente tienes
                {{ uploadedPhotos().length }}.
              </p>
            </div>
          </div>

          <!-- Actions -->
          <div
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 pt-4 border-t border-border-default dark:border-neutral-800/60"
          >
            <div class="text-xs text-text-secondary dark:text-text-secondary/60">
              Al enviar, revisaremos la publicaci√≥n y te avisaremos si necesitamos m√°s informaci√≥n.
            </div>
            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
              <button
                type="button"
                (click)="goBack()"
                class="w-full sm:w-auto text-sm font-semibold text-text-secondary dark:text-text-secondary hover:text-text-primary"
              >
                Cancelar
              </button>
              <button
                type="submit"
                [disabled]="publishForm.invalid || isSubmitting()"
                class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 rounded-lg text-cta-text font-semibold bg-primary-600 hover:bg-primary-700 dark:bg-cta-default dark:hover:bg-cta-default/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <svg
                  *ngIf="isSubmitting()"
                  class="animate-spin -ml-1 mr-3 h-5 w-5 text-text-inverse"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                <span *ngIf="!isSubmitting()">{{
                  editMode() ? 'Guardar cambios' : 'Publicar Auto'
                }}</span>
                <span *ngIf="isSubmitting()">{{
                  editMode() ? 'Guardando...' : 'Publicando...'
                }}</span>
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Sidebar -->
      <aside class="lg:col-span-2 space-y-6">
        <div class="lg:sticky lg:top-6 space-y-6">
          <app-host-support-info-panel></app-host-support-info-panel>

          <section
            class="rounded-2xl border border-border-default/70 dark:border-neutral-800/70 bg-surface-raised dark:bg-surface-raised p-5 shadow-soft"
          >
            <h3
              class="text-base font-semibold text-text-primary dark:text-text-primary mb-3 flex items-center gap-2"
            >
              <span>üìö</span> Obligaciones clave
            </h3>
            <ul class="space-y-3 text-sm text-text-secondary dark:text-text-secondary/80">
              <li class="flex gap-3">
                <span class="text-cta-default dark:text-cta-default/80">üõ°Ô∏è</span>
                Seguro vigente que habilite alquiler a terceros.
              </li>
              <li class="flex gap-3">
                <span class="text-cta-default dark:text-cta-default/80">‚öôÔ∏è</span>
                Mantenimiento, VTV y documentaci√≥n al d√≠a.
              </li>
              <li class="flex gap-3">
                <span class="text-cta-default dark:text-cta-default/80">üìÑ</span>
                C√©dula, DNI y p√≥lizas listos para verificaci√≥n.
              </li>
              <li class="flex gap-3">
                <span class="text-cta-default dark:text-cta-default/80">‚è±Ô∏è</span>
                Responder solicitudes dentro de 24 h (si no us√°s auto-aprobaci√≥n).
              </li>
            </ul>
            <a
              href="/docs/anfitriones"
              class="mt-4 inline-flex items-center gap-2 text-sm font-semibold text-primary-700 dark:text-cta-default hover:underline"
            >
              Ver gu√≠a completa
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 7h6m0 0v6m0-6L10 16"
                />
              </svg>
            </a>
          </section>
        </div>
      </aside>
    </div>
  </div>

  <!-- Stock Photos Modal -->
  @if (showStockPhotosModal()) {
    <div
      class="fixed inset-0 z-50 flex items-center justify-center bg-surface-overlay/50 backdrop-blur-sm"
      (click)="showStockPhotosModal.set(false)"
    >
      <div
        class="bg-surface-raised dark:bg-surface-base rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        (click)="$event.stopPropagation()"
      >
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-text-primary dark:text-text-inverse">
              üì∏ Buscar Fotos de Stock
            </h2>
            <button
              type="button"
              (click)="showStockPhotosModal.set(false)"
              class="text-text-secondary hover:text-text-primary dark:text-text-muted dark:hover:text-gray-200"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <app-stock-photos-selector
            [brand]="getCurrentBrand()"
            [model]="getCurrentModel()"
            [year]="getCurrentYear()"
            (photosSelected)="onStockPhotosSelected($event)"
          ></app-stock-photos-selector>
        </div>
      </div>
    </div>
  }

  <!-- AI Photo Generator Modal -->
  @if (showAIPhotosModal()) {
    <div
      class="fixed inset-0 z-50 flex items-center justify-center bg-surface-overlay/50 backdrop-blur-sm"
      (click)="showAIPhotosModal.set(false)"
    >
      <div
        class="bg-surface-raised dark:bg-surface-base rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        (click)="$event.stopPropagation()"
      >
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-text-primary dark:text-text-inverse">
              ‚ú® Generar Fotos con IA
            </h2>
            <button
              type="button"
              (click)="showAIPhotosModal.set(false)"
              class="text-text-secondary hover:text-text-primary dark:text-text-muted dark:hover:text-gray-200"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <app-ai-photo-generator
            [brand]="getCurrentBrand()"
            [model]="getCurrentModel()"
            [year]="getCurrentYear()"
            (photosGenerated)="onAIPhotosGenerated($event)"
          ></app-ai-photo-generator>
        </div>
      </div>
    </div>
  }
</div>
