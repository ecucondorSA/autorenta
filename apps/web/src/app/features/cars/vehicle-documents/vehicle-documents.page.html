<div class="documents-page">
  <!-- Header -->
  <div class="page-header">
    <button class="back-button" (click)="goBack()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </button>
    <div>
      <h1 class="page-title">Documentos del Vehículo</h1>
      <p class="page-subtitle">Gestiona la documentación requerida</p>
    </div>
  </div>

  <!-- Expiring Documents Alert -->
  <div *ngIf="expiringDocs().length > 0" class="alert alert-warning">
    <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
      />
    </svg>
    <div>
      <h3 class="alert-title">Documentos próximos a vencer</h3>
      <p class="alert-text">
        Tienes {{ expiringDocs().length }} documento(s) que vence(n) en los próximos 30 días.
        Actualízalos para mantener tu auto activo.
      </p>
    </div>
  </div>

  <!-- Missing Required Docs Alert -->
  <div *ngIf="getMissingRequiredDocs().length > 0" class="alert alert-error">
    <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
      />
    </svg>
    <div>
      <h3 class="alert-title">Documentos requeridos faltantes</h3>
      <p class="alert-text">
        Para publicar tu auto, debes subir todos los documentos obligatorios:
        <strong>{{ getMissingRequiredDocs().map(k => getDocumentKindLabel(k)).join(', ') }}</strong>
      </p>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Cargando documentos...</p>
  </div>

  <!-- Documents Grid -->
  <div *ngIf="!loading()" class="documents-grid">
    <div *ngFor="let kind of documentKinds" class="document-card">
      <div class="document-header">
        <div class="document-icon">{{ getDocumentKindIcon(kind) }}</div>
        <div class="document-info">
          <h3 class="document-title">{{ getDocumentKindLabel(kind) }}</h3>
          <span *ngIf="isRequired(kind)" class="required-badge">Obligatorio</span>
        </div>
      </div>

      <!-- Has Document -->
      <div *ngIf="hasDocument(kind)" class="document-body">
        <ng-container *ngIf="getDocumentByKind(kind) as doc">
          <div class="document-status" [ngClass]="getStatusColor(doc.status)">
            {{ getStatusLabel(doc.status) }}
          </div>

          <div class="document-details">
            <div *ngIf="doc.expiry_date" class="document-detail">
              <svg class="detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
              <span>Vence: {{ formatDate(doc.expiry_date) }}</span>
              <span *ngIf="isExpired(doc.expiry_date)" class="expired-badge">Vencido</span>
              <span
                *ngIf="!isExpired(doc.expiry_date) && isExpiring(doc.expiry_date)"
                class="expiring-badge"
                >Por vencer</span
              >
            </div>

            <div class="document-detail">
              <svg class="detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
              <span>Subido: {{ formatDate(doc.created_at) }}</span>
            </div>

            <div *ngIf="doc.notes" class="document-notes">
              <svg class="detail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"
                />
              </svg>
              <span>{{ doc.notes }}</span>
            </div>
          </div>

          <div class="document-actions">
            <button class="btn-secondary" (click)="viewDocument(doc)">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                />
              </svg>
              Ver
            </button>

            <button
              *ngIf="doc.status === 'pending'"
              class="btn-danger"
              (click)="deleteDocument(doc)"
            >
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
              Eliminar
            </button>

            <button
              *ngIf="doc.status === 'rejected' || isExpired(doc.expiry_date)"
              class="btn-primary"
              (click)="openUploadModal(kind)"
            >
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                />
              </svg>
              Resubir
            </button>
          </div>
        </ng-container>
      </div>

      <!-- No Document -->
      <div *ngIf="!hasDocument(kind)" class="document-empty">
        <p class="empty-text">No has subido este documento</p>
        <button class="btn-primary" (click)="openUploadModal(kind)">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            />
          </svg>
          Subir Documento
        </button>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div *ngIf="showUploadModal()" class="modal-overlay" (click)="closeUploadModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Subir Documento</h2>
        <button class="modal-close" (click)="closeUploadModal()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <form (submit)="$event.preventDefault(); uploadDocument()">
          <!-- Document Kind -->
          <div class="form-group">
            <label class="form-label">Tipo de Documento *</label>
            <select class="form-control" [(ngModel)]="uploadForm().kind" name="kind" required>
              <option *ngFor="let kind of documentKinds" [value]="kind">
                {{ getDocumentKindIcon(kind) }} {{ getDocumentKindLabel(kind) }}
              </option>
            </select>
          </div>

          <!-- File Upload -->
          <div class="form-group">
            <label class="form-label">Archivo (PDF o Imagen, máx 5MB) *</label>
            <input
              type="file"
              class="form-control"
              accept=".pdf,.jpg,.jpeg,.png"
              (change)="onFileSelected($event)"
              required
            />
            <p *ngIf="uploadForm().file" class="file-name">
              {{ uploadForm().file!.name }}
            </p>
          </div>

          <!-- Expiry Date -->
          <div class="form-group">
            <label class="form-label">Fecha de Vencimiento (opcional)</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="uploadForm().expiry_date"
              name="expiry_date"
            />
          </div>

          <!-- Notes -->
          <div class="form-group">
            <label class="form-label">Notas (opcional)</label>
            <textarea
              class="form-control"
              [(ngModel)]="uploadForm().notes"
              name="notes"
              rows="3"
              placeholder="Información adicional sobre el documento..."
            ></textarea>
          </div>

          <!-- Actions -->
          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeUploadModal()">
              Cancelar
            </button>
            <button type="submit" class="btn-primary" [disabled]="uploading()">
              <svg
                *ngIf="!uploading()"
                class="btn-icon"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
                />
              </svg>
              <div *ngIf="uploading()" class="btn-spinner"></div>
              {{ uploading() ? 'Subiendo...' : 'Subir' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
