<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin/accounting"></ion-back-button>
    </ion-buttons>
    <ion-title>Reconocimiento de Ingresos (NIIF 15)</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <ion-card color="success">
      <ion-card-content>
        <p class="text-sm text-gray-500">Ingresos Brutos Reconocidos</p>
        <p class="text-2xl font-bold">${{ getTotalRevenue().toFixed(2) }}</p>
      </ion-card-content>
    </ion-card>
    <ion-card color="primary">
      <ion-card-content>
        <p class="text-sm text-gray-500">Comisiones</p>
        <p class="text-2xl font-bold">${{ getTotalCommission().toFixed(2) }}</p>
      </ion-card-content>
    </ion-card>
    <ion-card color="tertiary">
      <ion-card-content>
        <p class="text-sm text-gray-500">Monto Locador</p>
        <p class="text-2xl font-bold">${{ getTotalOwnerAmount().toFixed(2) }}</p>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Filters -->
  <ion-card class="mb-4">
    <ion-card-header>
      <ion-card-title>Filtros</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <ion-item>
          <ion-label position="stacked">Booking ID</ion-label>
          <ion-input
            [(ngModel)]="filters"
            [ngModelOptions]="{ standalone: true }"
            name="bookingId"
            placeholder="ID del booking"
          ></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Estado</ion-label>
          <ion-select
            [(ngModel)]="filters"
            [ngModelOptions]="{ standalone: true }"
            name="isRecognized"
          >
            <ion-select-option value="">Todos</ion-select-option>
            <ion-select-option value="true">Reconocido</ion-select-option>
            <ion-select-option value="false">Pendiente</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Fecha Inicio</ion-label>
          <ion-input
            type="date"
            [(ngModel)]="filters"
            [ngModelOptions]="{ standalone: true }"
            name="startDate"
          ></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Fecha Fin</ion-label>
          <ion-input
            type="date"
            [(ngModel)]="filters"
            [ngModelOptions]="{ standalone: true }"
            name="endDate"
          ></ion-input>
        </ion-item>
      </div>

      <div class="flex gap-2 mt-4">
        <ion-button (click)="applyFilters()">Aplicar</ion-button>
        <ion-button fill="outline" (click)="clearFilters()">Limpiar</ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Loading State -->
  <div *ngIf="loading()" class="flex flex-col items-center justify-center py-12">
    <ion-spinner name="crescent"></ion-spinner>
    <p class="mt-4 text-gray-500">Cargando reconocimiento de ingresos...</p>
  </div>

  <!-- Revenue Recognition List -->
  <ion-card *ngIf="!loading()">
    <ion-card-header>
      <ion-card-title>
        Registros de Reconocimiento ({{ revenueRecognition().length }})
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div *ngIf="revenueRecognition().length === 0" class="text-center py-8 text-gray-500">
        <p>No hay registros que coincidan con los filtros</p>
      </div>

      <div *ngIf="revenueRecognition().length > 0" class="space-y-4">
        <ion-item *ngFor="let record of revenueRecognition()" class="mb-4">
          <ion-label>
            <h3>Booking: {{ record.booking_id.slice(0, 8) }}</h3>
            <p class="text-sm">
              Tipo: {{ record.revenue_type }} • Fecha: {{ record.recognition_date | date: 'short' }}
            </p>
            <div class="mt-2 grid grid-cols-3 gap-2 text-xs">
              <div>
                <p class="text-gray-500">Bruto</p>
                <p class="font-semibold">${{ record.gross_amount.toFixed(2) }}</p>
              </div>
              <div>
                <p class="text-gray-500">Comisión</p>
                <p class="font-semibold">${{ record.commission_amount.toFixed(2) }}</p>
              </div>
              <div>
                <p class="text-gray-500">Locador</p>
                <p class="font-semibold">${{ record.owner_amount.toFixed(2) }}</p>
              </div>
            </div>
          </ion-label>
          <ion-badge slot="end" [color]="record.is_recognized ? 'success' : 'warning'">
            {{ record.is_recognized ? 'Reconocido' : 'Pendiente' }}
          </ion-badge>
        </ion-item>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>
