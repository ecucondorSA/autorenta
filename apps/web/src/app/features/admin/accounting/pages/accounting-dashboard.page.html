<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin"></ion-back-button>
    </ion-buttons>
    <ion-title>Dashboard Contable</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refresh()" [disabled]="loading()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  @if (loading()) {
    <div class="flex flex-col items-center justify-center py-12">
      <ion-spinner name="crescent"></ion-spinner>
      <p class="mt-4 text-text-secondary">Cargando datos contables...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <ion-card color="danger">
      <ion-card-content>
        <div class="flex items-center">
          <ion-icon name="alert-circle" class="text-2xl mr-3"></ion-icon>
          <div>
            <strong>Error</strong>
            <p>{{ error() }}</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  }

  <!-- Dashboard Content -->
  @if (!loading() && dashboard()) {
    <div>
      <!-- Financial Health Alerts -->
      @if (healthCheck()?.alerts && healthCheck()!.alerts.length > 0) {
        <ion-card [color]="getHealthColor(healthCheck()?.profitability)" class="mb-4">
          <ion-card-header>
            <div class="flex items-center">
              <ion-icon
                [name]="getHealthIcon(healthCheck()?.profitability)"
                class="text-2xl mr-2"
              ></ion-icon>
              <ion-card-title>Alertas Financieras</ion-card-title>
            </div>
          </ion-card-header>
          <ion-card-content>
            <ion-list lines="none" class="bg-transparent">
              @for (alert of healthCheck()?.alerts; track alert) {
                <ion-item class="bg-transparent">
                  <ion-icon name="alert-circle" slot="start"></ion-icon>
                  <ion-label class="ion-text-wrap">{{ alert }}</ion-label>
                </ion-item>
              }
            </ion-list>
          </ion-card-content>
        </ion-card>
      }
      <!-- Quick Links -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <ion-button expand="block" fill="outline" routerLink="../balance-sheet">
          <ion-icon name="stats-chart" slot="start"></ion-icon>
          Balance
        </ion-button>
        <ion-button expand="block" fill="outline" routerLink="../income-statement">
          <ion-icon name="trending-up" slot="start"></ion-icon>
          P&L
        </ion-button>
        <ion-button expand="block" fill="outline" routerLink="../ledger">
          <ion-icon name="book" slot="start"></ion-icon>
          Libro Mayor
        </ion-button>
        <ion-button expand="block" fill="outline" routerLink="../reconciliation">
          <ion-icon name="sync" slot="start"></ion-icon>
          Conciliación
        </ion-button>
        <ion-button expand="block" fill="outline" routerLink="../revenue-recognition">
          <ion-icon name="cash" slot="start"></ion-icon>
          Ingresos (NIIF 15)
        </ion-button>
        <ion-button expand="block" fill="outline" routerLink="../period-closures">
          <ion-icon name="calendar" slot="start"></ion-icon>
          Cierres
        </ion-button>
        <ion-button expand="block" fill="outline" routerLink="../financial-health">
          <ion-icon name="heart" slot="start"></ion-icon>
          Salud Financiera
        </ion-button>
        <ion-button expand="block" fill="outline" routerLink="../manual-entry">
          <ion-icon name="create" slot="start"></ion-icon>
          Asiento Manual
        </ion-button>
      </div>
      <!-- Balance General - KPIs -->
      <h2 class="text-xl font-bold mb-3 mt-6 font-satoshi">Balance General (NIIF)</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <app-kpi-card
          title="Total Activos"
          [value]="dashboard()!.total_assets"
          icon="cash-outline"
          color="success"
        />
        <app-kpi-card
          title="Total Pasivos"
          [value]="dashboard()!.total_liabilities"
          icon="document-text-outline"
          color="warning"
        />
        <app-kpi-card
          title="Patrimonio"
          [value]="dashboard()!.total_equity"
          icon="business-outline"
          color="primary"
        />
      </div>
      <!-- Ecuación Contable -->
      <ion-card [color]="accountingEquationVerified() ? 'success' : 'danger'" class="mb-6">
        <ion-card-content>
          <div class="flex items-center justify-center">
            <ion-icon
              [name]="accountingEquationVerified() ? 'checkmark-circle' : 'close-circle'"
              class="text-2xl mr-2"
            ></ion-icon>
            <p class="font-bold">
              Ecuación Contable: A = P + E
              {{ accountingEquationVerified() ? '✓ Verificada' : '✗ Descuadrada' }}
            </p>
          </div>
        </ion-card-content>
      </ion-card>
      <!-- Estado de Resultados - KPIs -->
      <h2 class="text-xl font-bold mb-3 mt-6 font-satoshi">Estado de Resultados - Mes Actual</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <app-kpi-card
          title="Ingresos (Comisiones)"
          [value]="dashboard()!.monthly_income"
          icon="arrow-down-circle-outline"
          color="success"
        />
        <app-kpi-card
          title="Gastos Operativos"
          [value]="dashboard()!.monthly_expenses"
          icon="arrow-up-circle-outline"
          color="danger"
        />
        <app-kpi-card
          title="Utilidad Neta"
          [value]="dashboard()!.monthly_profit"
          icon="trending-up-outline"
          [color]="(dashboard()!.monthly_profit || 0) >= 0 ? 'success' : 'danger'"
        />
        <app-kpi-card
          title="Margen de Utilidad"
          [value]="profitMargin()"
          format="percent"
          icon="analytics-outline"
          [color]="profitMargin() >= 10 ? 'success' : profitMargin() >= 5 ? 'warning' : 'danger'"
        />
      </div>
      <!-- Pasivos Específicos NIIF 15 & 37 -->
      <h2 class="text-xl font-bold mb-3 mt-6 font-satoshi">Pasivos Específicos (NIIF 15 & 37)</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <app-kpi-card
          title="Billetera Usuarios"
          [value]="dashboard()!.wallet_liability"
          icon="wallet-outline"
          color="tertiary"
        />
        <app-kpi-card
          title="Provisión FGO"
          [value]="dashboard()!.fgo_provision"
          icon="shield-checkmark-outline"
          color="warning"
        />
        <app-kpi-card
          title="Depósitos de Garantía"
          [value]="dashboard()!.active_security_deposits"
          icon="lock-closed-outline"
          color="primary"
        />
      </div>
      <!-- Health Indicators -->
      <h2 class="text-xl font-bold mb-3 mt-6 font-satoshi">Indicadores de Salud Financiera</h2>
      @if (healthCheck()) {
        <ion-card>
          <ion-card-content>
            <ion-list lines="full">
              <ion-item>
                <ion-icon
                  [name]="healthCheck()?.walletReconciled ? 'checkmark-circle' : 'close-circle'"
                  [color]="healthCheck()?.walletReconciled ? 'success' : 'danger'"
                  slot="start"
                  class="text-2xl"
                ></ion-icon>
                <ion-label>
                  <h3 class="font-semibold font-satoshi">Conciliación Wallet</h3>
                  <p>
                    {{
                      healthCheck()?.walletReconciled
                        ? 'OK - Sin diferencias'
                        : 'Error - Verificar conciliación'
                    }}
                  </p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-icon
                  [name]="healthCheck()?.fgoAdequate ? 'checkmark-circle' : 'warning'"
                  [color]="healthCheck()?.fgoAdequate ? 'success' : 'warning'"
                  slot="start"
                  class="text-2xl"
                ></ion-icon>
                <ion-label>
                  <h3 class="font-semibold font-satoshi">Provisión FGO</h3>
                  <p>
                    {{
                      healthCheck()?.fgoAdequate
                        ? 'Adecuada (≥5% de depósitos)'
                        : 'Insuficiente - Revisar'
                    }}
                  </p>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-icon
                  name="trending-up"
                  [color]="getHealthColor(healthCheck()?.profitability)"
                  slot="start"
                  class="text-2xl"
                ></ion-icon>
                <ion-label>
                  <h3 class="font-semibold font-satoshi font-luxury">Rentabilidad</h3>
                  <p>
                    {{
                      healthCheck()?.profitability === 'GOOD'
                        ? 'Buena (margen ≥5%)'
                        : healthCheck()?.profitability === 'WARNING'
                          ? 'Regular (margen <5%)'
                          : 'Crítica (pérdidas)'
                    }}
                  </p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      }
      <!-- Footer Info -->
      <div class="mt-8 mb-4 text-center text-text-secondary text-sm">
        <p>Sistema contable automatizado según NIIF 15 (Ingresos) y NIIF 37 (Provisiones)</p>
        <p>Actualizado automáticamente en tiempo real</p>
      </div>
    </div>
  }
</ion-content>
