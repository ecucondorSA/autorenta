<ion-header>
  <ion-toolbar>
    <ion-title>üìä Dashboard Contable</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refresh()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando datos contables...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading() && dashboard()">
    <!-- Health Check Alerts -->
    <ion-card
      *ngIf="healthCheck()?.alerts?.length > 0"
      [color]="getHealthColor(healthCheck()?.profitability)"
    >
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="warning-outline"></ion-icon>
          Alertas Financieras
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item *ngFor="let alert of healthCheck()?.alerts" color="transparent">
            <ion-icon name="alert-circle" slot="start"></ion-icon>
            <ion-label>{{ alert }}</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Estado de Situaci√≥n Financiera -->
    <ion-card>
      <ion-card-header>
        <ion-card-subtitle>Balance General (NIIF)</ion-card-subtitle>
        <ion-card-title>Estado de Situaci√≥n Financiera</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <h3>üí∞ Total Activos</h3>
              <p>Efectivo, cuentas por cobrar</p>
            </ion-label>
            <ion-note slot="end" color="success">
              {{ formatCurrency(dashboard()?.total_assets) }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>üìã Total Pasivos</h3>
              <p>Billetera usuarios, garant√≠as, FGO</p>
            </ion-label>
            <ion-note slot="end" color="danger">
              {{ formatCurrency(dashboard()?.total_liabilities) }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>üè¶ Patrimonio</h3>
              <p>Capital + Utilidades acumuladas</p>
            </ion-label>
            <ion-note slot="end" color="primary">
              {{ formatCurrency(dashboard()?.total_equity) }}
            </ion-note>
          </ion-item>
        </ion-list>

        <div class="accounting-equation">
          <ion-text color="medium">
            <p class="ion-text-center">
              <small>Ecuaci√≥n Contable: Activos = Pasivos + Patrimonio</small>
            </p>
          </ion-text>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Resultados del Mes -->
    <ion-card>
      <ion-card-header>
        <ion-card-subtitle>Estado de Resultados</ion-card-subtitle>
        <ion-card-title>P&L - Mes Actual</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <h3>üíµ Ingresos</h3>
              <p>Comisiones (NIIF 15 - Rol Agente)</p>
            </ion-label>
            <ion-note slot="end" color="success">
              {{ formatCurrency(dashboard()?.monthly_income) }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>üí∏ Gastos</h3>
              <p>Operativos, FGO, comisiones MP</p>
            </ion-label>
            <ion-note slot="end" color="danger">
              {{ formatCurrency(dashboard()?.monthly_expenses) }}
            </ion-note>
          </ion-item>

          <ion-item lines="none">
            <ion-label>
              <h2><strong>üìä Utilidad Neta</strong></h2>
              <p>Resultado del per√≠odo</p>
            </ion-label>
            <ion-note
              slot="end"
              [color]="(dashboard()?.monthly_profit ?? 0) >= 0 ? 'success' : 'danger'"
            >
              <strong>{{ formatCurrency(dashboard()?.monthly_profit) }}</strong>
            </ion-note>
          </ion-item>
        </ion-list>

        <!-- Profit Margin -->
        <div
          class="profit-margin"
          *ngIf="dashboard()?.monthly_income && (dashboard()?.monthly_income ?? 0) > 0"
        >
          <ion-text color="medium">
            <p class="ion-text-center">
              <small>
                Margen:
                {{
                  ((dashboard()!.monthly_profit / dashboard()!.monthly_income) * 100).toFixed(1)
                }}%
              </small>
            </p>
          </ion-text>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Pasivos Espec√≠ficos (NIIF 15 y 37) -->
    <ion-card>
      <ion-card-header>
        <ion-card-subtitle>Obligaciones Normativas</ion-card-subtitle>
        <ion-card-title>Pasivos NIIF 15 & 37</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-label>
              <h3>üëõ Billetera Usuarios</h3>
              <p>NIIF 15 - Pasivo por Contrato</p>
            </ion-label>
            <ion-note slot="end" color="warning">
              {{ formatCurrency(dashboard()?.wallet_liability) }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>üõ°Ô∏è Provisi√≥n FGO</h3>
              <p>NIIF 37 - Fondo Garant√≠a Operativa</p>
            </ion-label>
            <ion-note slot="end" color="tertiary">
              {{ formatCurrency(dashboard()?.fgo_provision) }}
            </ion-note>
          </ion-item>

          <ion-item>
            <ion-label>
              <h3>üîí Dep√≥sitos de Garant√≠a</h3>
              <p>NIIF 37 - Provisiones Activas</p>
            </ion-label>
            <ion-note slot="end" color="secondary">
              {{ formatCurrency(dashboard()?.active_security_deposits) }}
            </ion-note>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Health Status -->
    <ion-card *ngIf="healthCheck()">
      <ion-card-header>
        <ion-card-subtitle>Indicadores de Salud</ion-card-subtitle>
        <ion-card-title>Estado Financiero</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item>
            <ion-icon
              [name]="healthCheck()?.walletReconciled ? 'checkmark-circle' : 'close-circle'"
              [color]="healthCheck()?.walletReconciled ? 'success' : 'danger'"
              slot="start"
            >
            </ion-icon>
            <ion-label>
              <h3>Conciliaci√≥n Wallet</h3>
              <p>
                {{ healthCheck()?.walletReconciled ? 'OK - Sin diferencias' : 'Error - Verificar' }}
              </p>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-icon
              [name]="healthCheck()?.fgoAdequate ? 'checkmark-circle' : 'warning'"
              [color]="healthCheck()?.fgoAdequate ? 'success' : 'warning'"
              slot="start"
            >
            </ion-icon>
            <ion-label>
              <h3>Provisi√≥n FGO</h3>
              <p>{{ healthCheck()?.fgoAdequate ? 'Adecuada' : 'Insuficiente - Revisar' }}</p>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-icon
              name="trending-up"
              [color]="getHealthColor(healthCheck()?.profitability)"
              slot="start"
            >
            </ion-icon>
            <ion-label>
              <h3>Rentabilidad</h3>
              <p>
                {{
                  healthCheck()?.profitability === 'GOOD'
                    ? 'Buena'
                    : healthCheck()?.profitability === 'WARNING'
                      ? 'Regular'
                      : 'Cr√≠tica'
                }}
              </p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Footer Info -->
    <ion-text color="medium">
      <p class="ion-text-center ion-padding">
        <small>
          Sistema contable automatizado seg√∫n NIIF 15 (Ingresos) y NIIF 37 (Provisiones)
          <br />
          Actualizado autom√°ticamente en tiempo real
        </small>
      </p>
    </ion-text>
  </div>
</ion-content>
