<div class="fgo-overview-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Fondo de Garant√≠a Operativa (FGO)</h1>
    <div class="header-actions">
      <button class="btn-action btn-transfer" (click)="openTransferModal()">
        <span class="icon">‚ÜîÔ∏è</span>
        Transferir Subfondos
      </button>
      <button class="btn-action btn-siniestro" (click)="openSiniestroModal()">
        <span class="icon">üí∏</span>
        Pagar Siniestro
      </button>
      <button class="btn-refresh" (click)="refreshData()" [disabled]="loadingStatus">
        <span class="icon">üîÑ</span>
        Actualizar
      </button>
      <button class="btn-recalculate" (click)="recalculateMetrics()" [disabled]="loadingStatus">
        <span class="icon">üßÆ</span>
        Recalcular M√©tricas
      </button>
    </div>
  </div>

  <!-- Estado General del FGO -->
  <section class="fgo-status-section">
    <h2>Estado General</h2>

    <div *ngIf="loadingStatus" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando estado del FGO...</p>
    </div>

    <div *ngIf="!loadingStatus && fgoStatus" class="status-grid">
      <!-- Balance Total -->
      <div class="status-card card-primary">
        <div class="card-header">
          <h3>Balance Total</h3>
          <span class="icon">üí∞</span>
        </div>
        <div class="card-body">
          <div class="main-value">{{ formatUsd(fgoStatus.totalBalance) }}</div>
          <div class="card-meta">
            <div class="meta-item">
              <span class="label">Meta:</span>
              <span class="value">{{ formatUsd(fgoStatus.targetBalance) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Ratio de Cobertura (RC) -->
      <div class="status-card" [ngClass]="getStatusClass(fgoStatus.status)">
        <div class="card-header">
          <h3>Cobertura (RC)</h3>
          <span class="status-icon">{{ getStatusIcon(fgoStatus.status) }}</span>
        </div>
        <div class="card-body">
          <div class="main-value">{{ formatRatio(fgoStatus.coverageRatio) }}</div>
          <div class="status-label">{{ getStatusMessage(fgoStatus.status) }}</div>
        </div>
      </div>

      <!-- Loss Ratio (LR) -->
      <div class="status-card">
        <div class="card-header">
          <h3>Loss Ratio (LR)</h3>
          <span class="icon">üìä</span>
        </div>
        <div class="card-body">
          <div class="main-value">{{ formatRatio(fgoStatus.lossRatio) }}</div>
          <div class="card-meta">
            <div class="meta-item">
              <span class="label">Siniestros pagados:</span>
              <span class="value">{{ formatUsd(fgoStatus.totalSiniestrosPaid) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Alpha Percentage -->
      <div class="status-card">
        <div class="card-header">
          <h3>Par√°metro Alpha (Œ±)</h3>
          <span class="icon">‚öôÔ∏è</span>
        </div>
        <div class="card-body">
          <div class="main-value">{{ fgoStatus.alphaPercentage }}%</div>
          <div class="card-meta">
            <div class="meta-item">
              <span class="label">Total aportes:</span>
              <span class="value">{{ formatUsd(fgoStatus.totalContributions) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Subfondos -->
  <section class="subfunds-section">
    <h2>Distribuci√≥n por Subfondo</h2>

    <div *ngIf="loadingSubfunds" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando subfondos...</p>
    </div>

    <div *ngIf="!loadingSubfunds && subfunds.length > 0" class="subfunds-grid">
      <div *ngFor="let subfund of subfunds" class="subfund-card">
        <div class="subfund-header">
          <h3>{{ getSubfundName(subfund.type) }}</h3>
          <div class="subfund-percentage" [style.color]="getSubfundColor(subfund.type)">
            {{ subfund.percentage.toFixed(1) }}%
          </div>
        </div>
        <div class="subfund-body">
          <div class="subfund-balance">{{ formatUsd(subfund.balanceUsd) }}</div>
          <div class="subfund-description">{{ subfund.description || subfund.purpose }}</div>
        </div>
        <div class="subfund-progress">
          <div
            class="progress-bar"
            [style.width.%]="subfund.percentage"
            [style.background-color]="getSubfundColor(subfund.type)"
          ></div>
        </div>
      </div>
    </div>

    <div *ngIf="!loadingSubfunds && subfunds.length === 0" class="empty-state">
      <p>No se encontraron subfondos</p>
    </div>
  </section>

  <!-- Movimientos Recientes -->
  <section class="movements-section">
    <div class="section-header">
      <h2>Movimientos Recientes</h2>
      <div class="section-actions">
        <span class="movement-count">{{ recentMovements.length }} movimientos</span>
      </div>
    </div>

    <div *ngIf="loadingMovements" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando movimientos...</p>
    </div>

    <div *ngIf="!loadingMovements && recentMovements.length > 0" class="movements-table-container">
      <table class="movements-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Subfondo</th>
            <th>Monto</th>
            <th>Operaci√≥n</th>
            <th>Usuario</th>
            <th>Referencia</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let movement of recentMovements"
            [class.movement-credit]="movement.operation === 'credit'"
            [class.movement-debit]="movement.operation === 'debit'"
          >
            <td class="movement-date">{{ formatDate(movement.timestamp) }}</td>
            <td class="movement-type">{{ getMovementTypeName(movement.movementType) }}</td>
            <td class="movement-subfund">{{ getSubfundName(movement.subfundType) }}</td>
            <td
              class="movement-amount"
              [class.positive]="movement.operation === 'credit'"
              [class.negative]="movement.operation === 'debit'"
            >
              <span class="operation-sign">{{ movement.operation === 'credit' ? '+' : '-' }}</span>
              {{ formatUsd(movement.amount) }}
            </td>
            <td class="movement-operation">
              <span
                class="badge"
                [class.badge-credit]="movement.operation === 'credit'"
                [class.badge-debit]="movement.operation === 'debit'"
              >
                {{ movement.operation === 'credit' ? 'Cr√©dito' : 'D√©bito' }}
              </span>
            </td>
            <td class="movement-user">{{ movement.userName || 'Sistema' }}</td>
            <td class="movement-ref">
              <code>{{ movement.reference }}</code>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="!loadingMovements && recentMovements.length === 0" class="empty-state">
      <p>No se encontraron movimientos recientes</p>
    </div>
  </section>

  <!-- Footer Info -->
  <div class="page-footer">
    <div class="footer-info" *ngIf="fgoStatus">
      <span class="info-item">
        <strong>√öltima actualizaci√≥n:</strong> {{ formatDate(fgoStatus.updatedAt) }}
      </span>
      <span class="info-item">
        <strong>M√©tricas calculadas:</strong> {{ formatDate(fgoStatus.lastCalculatedAt) }}
      </span>
    </div>
  </div>

  <!-- Modal: Transferir entre Subfondos -->
  <div class="modal-overlay" *ngIf="showTransferModal" (click)="closeTransferModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Transferir entre Subfondos</h2>
        <button class="btn-close" (click)="closeTransferModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <form class="transfer-form">
          <div class="form-group">
            <label for="fromSubfund">Desde Subfondo</label>
            <select id="fromSubfund" [(ngModel)]="transferForm.fromSubfund" name="fromSubfund">
              <option value="">Seleccionar...</option>
              <option value="liquidity">Liquidez</option>
              <option value="capitalization">Capitalizaci√≥n</option>
              <option value="profitability">Rentabilidad</option>
            </select>
          </div>
          <div class="form-group">
            <label for="toSubfund">Hacia Subfondo</label>
            <select id="toSubfund" [(ngModel)]="transferForm.toSubfund" name="toSubfund">
              <option value="">Seleccionar...</option>
              <option value="liquidity">Liquidez</option>
              <option value="capitalization">Capitalizaci√≥n</option>
              <option value="profitability">Rentabilidad</option>
            </select>
          </div>
          <div class="form-group">
            <label for="amount">Monto (USD)</label>
            <input
              type="number"
              id="amount"
              [(ngModel)]="transferForm.amount"
              name="amount"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
          </div>
          <div class="form-group">
            <label for="reason">Motivo</label>
            <textarea
              id="reason"
              [(ngModel)]="transferForm.reason"
              name="reason"
              rows="3"
              placeholder="Describe el motivo de la transferencia..."
            ></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeTransferModal()">Cancelar</button>
        <button
          class="btn-primary"
          (click)="submitTransfer()"
          [disabled]="!isTransferFormValid() || processingTransfer"
        >
          {{ processingTransfer ? 'Procesando...' : 'Transferir' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Pagar Siniestro -->
  <div class="modal-overlay" *ngIf="showSiniestroModal" (click)="closeSiniestroModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Pagar Siniestro</h2>
        <button class="btn-close" (click)="closeSiniestroModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <form class="siniestro-form">
          <div class="form-group">
            <label for="bookingId">ID de Reserva</label>
            <input
              type="text"
              id="bookingId"
              [(ngModel)]="siniestroForm.bookingId"
              name="bookingId"
              placeholder="UUID de la reserva"
            />
          </div>
          <div class="form-group">
            <label for="siniestroAmount">Monto (USD)</label>
            <input
              type="number"
              id="siniestroAmount"
              [(ngModel)]="siniestroForm.amount"
              name="siniestroAmount"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
          </div>
          <div class="form-group">
            <label for="description">Descripci√≥n</label>
            <textarea
              id="description"
              [(ngModel)]="siniestroForm.description"
              name="description"
              rows="4"
              placeholder="Describe el siniestro (da√±os, circunstancias, etc.)..."
            ></textarea>
          </div>
          <div class="alert-warning">
            ‚ö†Ô∏è Esta acci√≥n debitar√° <strong>{{ formatUsd(siniestroForm.amount || 0) }}</strong> del
            subfondo de Liquidez.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeSiniestroModal()">Cancelar</button>
        <button
          class="btn-danger"
          (click)="submitSiniestro()"
          [disabled]="!isSiniestroFormValid() || processingSiniestro"
        >
          {{ processingSiniestro ? 'Procesando...' : 'Pagar Siniestro' }}
        </button>
      </div>
    </div>
  </div>
</div>
