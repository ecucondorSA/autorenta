<div class="max-w-4xl mx-auto p-4">
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-text-primary dark:text-text-inverse mb-2">
      Historial de Movimientos
    </h1>
    <p class="text-text-secondary dark:text-text-secondary dark:text-text-secondary">
      Todos tus movimientos de AutoCrÃ©ditos
    </p>
  </div>

  <div class="bg-surface-raised dark:bg-surface-base rounded-lg shadow p-4 mb-4">
    <div class="flex flex-wrap gap-4">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-sm font-medium text-text-primary dark:text-text-secondary mb-2">
          Tipo de movimiento
        </label>
        <select
          [ngModel]="selectedKind()"
          (ngModelChange)="selectedKind.set($event)"
          class="w-full px-3 py-2 border border-border-subtle dark:border-border-default rounded-md bg-surface-raised dark:bg-surface-base text-text-primary dark:text-text-inverse"
        >
          <option [ngValue]="null">Todos</option>
          <option value="deposit">DepÃ³sitos</option>
          <option value="transfer_out">Transferencias enviadas</option>
          <option value="transfer_in">Transferencias recibidas</option>
          <option value="rental_charge">Cargos por alquiler</option>
          <option value="rental_payment">Pagos recibidos</option>
          <option value="refund">Reembolsos</option>
          <option value="withdrawal">Retiros</option>
          <option value="bonus">Bonificaciones</option>
          <option value="fee">Comisiones</option>
        </select>
      </div>

      <div class="flex items-end">
        <button
          (click)="refreshHistory()"
          [disabled]="loading()"
          class="px-4 py-2 bg-cta-default text-cta-text rounded-md hover:bg-cta-default disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ loading() ? 'Cargando...' : 'Actualizar' }}
        </button>
      </div>
    </div>
  </div>

  <div
    *ngIf="error()"
    class="bg-error-50 dark:bg-error-900/20 border border-error-200 dark:border-error-800 rounded-lg p-4 mb-4"
  >
    <p class="text-error-800 dark:text-error-200">{{ error() }}</p>
  </div>

  <div
    *ngIf="loading() && filteredHistory().length === 0"
    class="bg-surface-raised dark:bg-surface-base rounded-lg shadow p-8 text-center"
  >
    <div
      class="animate-spin rounded-full h-12 w-12 border-b-2 border-cta-default mx-auto mb-4"
    ></div>
    <p class="text-text-secondary dark:text-text-secondary dark:text-text-secondary">Cargando historial...</p>
  </div>

  <div
    *ngIf="!loading() && filteredHistory().length === 0"
    class="bg-surface-raised dark:bg-surface-base rounded-lg shadow p-8 text-center"
  >
    <div class="text-6xl mb-4">ðŸ“‹</div>
    <h3 class="text-lg font-semibold text-text-primary dark:text-text-inverse mb-2">
      No hay movimientos
    </h3>
    <p class="text-text-secondary dark:text-text-secondary dark:text-text-secondary">
      {{
        selectedKind()
          ? 'No hay movimientos de este tipo'
          : 'AÃºn no tienes movimientos en tu wallet'
      }}
    </p>
  </div>

  <div *ngIf="filteredHistory().length > 0" class="space-y-3">
    <div
      *ngFor="let entry of filteredHistory()"
      class="bg-surface-raised dark:bg-surface-base rounded-lg shadow hover:shadow-md transition-shadow"
    >
      <div class="p-4">
        <div class="flex items-start justify-between">
          <div class="flex items-start space-x-3 flex-1">
            <div class="text-3xl mt-1">
              {{ ledgerService.getKindIcon(entry.kind) }}
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-sm font-semibold text-text-primary dark:text-text-inverse mb-1">
                {{ ledgerService.getKindLabel(entry.kind) }}
              </h3>
              <p
                *ngIf="entry.meta && entry.meta['description']"
                class="text-sm text-text-secondary dark:text-text-secondary dark:text-text-secondary mb-1"
              >
                {{ entry.meta['description'] }}
              </p>
              <p class="text-xs text-text-secondary dark:text-text-secondary dark:text-text-secondary font-mono">
                Ref: {{ entry.ref }}
              </p>
              <p
                *ngIf="entry.booking_id"
                class="text-xs text-text-secondary dark:text-text-secondary dark:text-text-secondary mt-1"
              >
                Reserva: {{ entry.booking_id.substring(0, 8) }}...
                <span
                  *ngIf="entry.booking_status"
                  class="ml-1 px-2 py-0.5 bg-surface-hover dark:bg-surface-base rounded"
                >
                  {{ entry.booking_status }}
                </span>
              </p>
              <p class="text-xs text-text-secondary dark:text-text-secondary dark:text-text-secondary mt-1">
                {{ formatDate(entry.ts) }}
              </p>
            </div>
          </div>
          <div class="text-right ml-4">
            <p class="text-lg font-bold" [ngClass]="ledgerService.getKindColor(entry.kind)">
              {{ formatBalanceChange(entry.balance_change_cents) }}
            </p>
            <p class="text-xs text-text-secondary dark:text-text-secondary dark:text-text-secondary">
              {{ ledgerService.formatAmount(entry.amount_cents) }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
