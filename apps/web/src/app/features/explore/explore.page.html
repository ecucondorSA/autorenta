<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-searchbar
      [(ngModel)]="searchQuery"
      (ionChange)="onSearch()"
      placeholder="Buscar autos..."
      [animated]="true"
      class="search-bar-toolbar"
    ></ion-searchbar>

    <ion-buttons slot="end">
      <ion-button (click)="toggleFilters()">
        <ion-icon slot="icon-only" name="options-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Filters Panel (Collapsible) -->
  <app-map-filters
    *ngIf="showFilters"
    (filtersChange)="onFiltersChange($event)"
    class="filters-panel"
  ></app-map-filters>
</ion-header>

<ion-content [fullscreen]="true" class="explore-content">
  <!-- Map View (Fullscreen) -->
  <div class="map-container">
    <app-cars-map
      [cars]="filteredCars"
      [selectedCarId]="null"
      (carSelected)="onCarSelected($event)"
    ></app-cars-map>
  </div>

  <!-- Floating Action Buttons -->
  <div class="fab-container">
    <!-- Center on User Location -->
    <ion-fab vertical="top" horizontal="end" slot="fixed" class="fab-location">
      <ion-fab-button size="small" (click)="centerOnUser()">
        <ion-icon name="locate-outline"></ion-icon>
      </ion-fab-button>
    </ion-fab>

    <!-- Show List View -->
    <ion-fab vertical="bottom" horizontal="center" slot="fixed" class="fab-list">
      <ion-fab-button (click)="toggleList()">
        <ion-icon name="list-outline"></ion-icon>
        <span class="fab-label">Ver lista ({{ filteredCars.length }})</span>
      </ion-fab-button>
    </ion-fab>
  </div>
</ion-content>

<!-- Bottom Sheet - List View -->
<ion-modal
  #listModal
  [isOpen]="showList"
  [initialBreakpoint]="0.5"
  [breakpoints]="[0, 0.5, 0.75, 1]"
  (ionModalDidDismiss)="onModalDismiss()"
  class="list-modal"
>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="listModal.dismiss()">Cerrar</ion-button>
        </ion-buttons>
        <ion-label>
          <strong>{{ filteredCars.length }} autos encontrados</strong>
        </ion-label>
      </ion-toolbar>
    </ion-header>

    <ion-content class="list-content">
      <ion-list>
        <app-car-card
          *ngFor="let car of filteredCars"
          [car]="car"
          [routerLink]="['/cars', car.id]"
          (click)="listModal.dismiss()"
          class="list-car-card"
        ></app-car-card>
      </ion-list>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="filteredCars.length === 0 && !loading">
        <ion-icon name="search-outline" size="large"></ion-icon>
        <p>No se encontraron autos con estos filtros</p>
        <ion-button (click)="resetFilters()"> Limpiar filtros </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
