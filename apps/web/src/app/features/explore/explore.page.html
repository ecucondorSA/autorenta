<!-- Desktop Header -->
<ion-header [translucent]="true" class="md:block hidden">
  <ion-toolbar color="primary">
    <ion-searchbar
      [(ngModel)]="searchQuery"
      (ionChange)="onSearch()"
      placeholder="Buscar autos..."
      [animated]="true"
      class="search-bar-toolbar"
    ></ion-searchbar>
  </ion-toolbar>
</ion-header>

<!-- Mobile: Floating Search -->
<div class="md:hidden block absolute top-safe-top left-0 right-0 z-20 p-3">
  <div class="flex gap-2">
    <div class="flex-1 bg-surface-raised dark:bg-surface-secondary rounded-full shadow-lg">
      <ion-searchbar
        [(ngModel)]="searchQuery"
        (ionChange)="onSearch()"
        placeholder="Â¿A dÃ³nde vas?"
        [animated]="true"
        class="mobile-search"
      ></ion-searchbar>
    </div>
  </div>
</div>

<ion-content [fullscreen]="true" class="explore-content">
  <!-- ðŸŽ¯ MAP CENTRIC LAYOUT -->
  <div class="map-centric-container">
    <!-- Left: Map (70% desktop, 100% mobile) -->
    <div class="map-section">
      <app-cars-map
        #carsMapRef
        [cars]="carMapLocations()"
        [selectedCarId]="selectedCarId()"
        [userLocation]="userLocation()"
        (carSelected)="onMapCarSelected($event)"
        (userLocationChange)="onUserLocationChange($event)"
      ></app-cars-map>

      <!-- ðŸŽ¯ Map Filters (Floating chips/inline) -->
      <app-map-filters
        [availableCars]="carMapLocations()"
        [userLocation]="userLocation() || undefined"
        (filterChange)="onFilterChange($event)"
      ></app-map-filters>

      <!-- Floating Action Buttons -->
      <div class="fab-container">
        <ion-fab vertical="top" horizontal="end" slot="fixed" class="fab-location">
          <ion-fab-button size="small" (click)="centerOnUser()">
            <ion-icon name="locate-outline"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      </div>

      <!-- WhatsApp FAB (floating) - Removed until we verify correct inputs -->
      <!-- <app-whatsapp-fab
        *ngIf="selectedCar()"
        [carOwnerId]="selectedCar()?.carId"
        class="whatsapp-fab-map"
      ></app-whatsapp-fab> -->
    </div>

    <!-- Right: Drawer (30% desktop, bottom-sheet mobile) -->
    <app-map-drawer
      [selectedCar]="selectedCar()"
      [userLocation]="userLocation() || undefined"
      [isOpen]="isDrawerOpen()"
      [isMobile]="isMobileView()"
      (closeDrawer)="onCloseDrawer()"
      (reserveClick)="onReserveClick($event)"
      (chatClick)="onChatClick($event)"
    ></app-map-drawer>
  </div>

  <!-- Desktop: Bottom Carousel (Alternative view, hidden when drawer is open) -->
  <div
    *ngIf="!isMobileView && !isDrawerOpen && filteredCars.length > 0"
    #carouselContainer
    class="map-carousel"
    (mouseenter)="onCarouselHover(true)"
    (mouseleave)="onCarouselHover(false)"
  >
    <div class="map-carousel-scroll">
      <div
        *ngFor="let car of filteredCars; let i = index"
        class="map-carousel-card-wrapper"
        role="listitem"
        [attr.data-car-id]="car.id"
        [class.selected]="car.id === selectedCarId()"
      >
        <app-car-card
          [car]="car"
          [priority]="i === 0"
          [selected]="car.id === selectedCarId()"
          (click)="onCarouselCardSelected(car.id)"
          class="map-carousel-card"
          [attr.aria-label]="'Ver mÃ¡s sobre ' + (car.title || 'este auto')"
        ></app-car-card>
      </div>
    </div>
  </div>

  <!-- Mobile: Sticky CTA - Removed until we verify correct inputs -->
  <!-- <app-sticky-cta-mobile
    *ngIf="isMobileView() && selectedCar()"
    [car]="selectedCar()"
    [isActive]="selectedCarId() !== null"
    (ctaClick)="onStickyCtaClick()"
  ></app-sticky-cta-mobile> -->
</ion-content>
