<!-- Desktop Header with View Toggles -->
<ion-header
  [translucent]="true"
  class="bg-surface-base border-b border-border-default"
  >
  <ion-toolbar class="--background: transparent; --min-height: 80px;">
    <div
      class="max-w-[1920px] mx-auto w-full px-4 sm:px-6 lg:px-8 flex items-center justify-between gap-4 py-3 pt-[calc(0.75rem+env(safe-area-inset-top))]"
      >
      <!-- Search Bar (Expanded style) -->
      <div class="flex-1 max-w-2xl">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          (input)="onSearch()"
          placeholder="Buscar por marca, modelo o ciudad..."
          class="w-full px-4 py-3 bg-surface-secondary border-2 border-transparent focus:border-cta-default rounded-xl focus:outline-none focus:ring-4 focus:ring-cta-default/10 text-text-primary placeholder:text-text-placeholder transition-all duration-200 shadow-sm"
          />
      </div>

      <!-- View Toggles & Filters -->
      <div class="flex items-center gap-3">
        <!-- Map Provider Toggle (only visible in map view) -->
        @if (viewMode() === 'map') {
          <div
            class="bg-surface-secondary p-1 rounded-xl flex items-center border border-border-default"
            >
            <button
              [class.bg-surface-raised]="mapProvider() === 'mapbox'"
              [class.shadow-soft]="mapProvider() === 'mapbox'"
              [class.text-text-primary]="mapProvider() === 'mapbox'"
              [class.text-text-muted]="mapProvider() !== 'mapbox'"
              (click)="mapProvider.set('mapbox')"
              class="px-3 py-2 rounded-lg transition-all duration-200 hover:text-text-primary flex items-center gap-1.5 text-sm font-medium"
              title="Mapa Mapbox"
              >
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                  />
              </svg>
              <span>Mapbox</span>
            </button>
            <button
              [class.bg-surface-raised]="mapProvider() === 'waze'"
              [class.shadow-soft]="mapProvider() === 'waze'"
              [class.text-info-500]="mapProvider() === 'waze'"
              [class.text-text-muted]="mapProvider() !== 'waze'"
              (click)="mapProvider.set('waze')"
              class="px-3 py-2 rounded-lg transition-all duration-200 hover:text-text-primary flex items-center gap-1.5 text-sm font-medium"
              title="Tr√°fico en tiempo real - Waze"
              >
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8z"
                  />
                <path
                  d="M12 6c-3.3 0-6 2.7-6 6s2.7 6 6 6 6-2.7 6-6-2.7-6-6-6zm0 10c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"
                  />
              </svg>
              <span>Waze</span>
            </button>
          </div>
        }

        <!-- View Toggle -->
        <div
          class="bg-surface-secondary p-1 rounded-xl flex items-center border border-border-default"
          >
          <button
            [class.bg-surface-raised]="viewMode() === 'map'"
            [class.shadow-soft]="viewMode() === 'map'"
            [class.text-text-primary]="viewMode() === 'map'"
            [class.text-text-muted]="viewMode() !== 'map'"
            (click)="viewMode.set('map')"
            class="p-2 rounded-lg transition-all duration-200 hover:text-text-primary"
            title="Vista Mapa"
            >
            <ion-icon name="map-outline" class="text-xl"></ion-icon>
          </button>
          <button
            [class.bg-surface-raised]="viewMode() === 'grid'"
            [class.shadow-soft]="viewMode() === 'grid'"
            [class.text-text-primary]="viewMode() === 'grid'"
            [class.text-text-muted]="viewMode() !== 'grid'"
            (click)="viewMode.set('grid')"
            class="p-2 rounded-lg transition-all duration-200 hover:text-text-primary"
            title="Vista Cuadr√≠cula"
            >
            <ion-icon name="grid-outline" class="text-xl"></ion-icon>
          </button>
          <button
            [class.bg-surface-raised]="viewMode() === 'list'"
            [class.shadow-soft]="viewMode() === 'list'"
            [class.text-text-primary]="viewMode() === 'list'"
            [class.text-text-muted]="viewMode() !== 'list'"
            (click)="viewMode.set('list')"
            class="p-2 rounded-lg transition-all duration-200 hover:text-text-primary"
            title="Vista Lista"
            >
            <ion-icon name="list-outline" class="text-xl"></ion-icon>
          </button>
        </div>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="bg-surface-secondary">
  <!-- üó∫Ô∏è MAP VIEW -->
  @if (viewMode() === 'map') {
    <div
      class="h-full w-full relative flex flex-col md:flex-row overflow-hidden"
      >
      <!-- Map Area -->
      <div class="flex-1 relative h-full">
        <!-- Mapbox Map -->
        @if (mapProvider() === 'mapbox') {
          <app-cars-map
            #carsMapRef
            [cars]="carMapLocations()"
            [selectedCarId]="selectedCarId()"
            [userLocation]="userLocation()"
            (carSelected)="onMapCarSelected($event)"
            (userLocationChange)="onUserLocationChange($event)"
          ></app-cars-map>
        }
        <!-- Waze Live Map -->
        @if (mapProvider() === 'waze' && userLocation()) {
          <app-waze-live-map
            [lat]="userLocation()!.lat"
            [lng]="userLocation()!.lng"
            [zoom]="14"
            [showPin]="true"
            [showInfoBadge]="true"
          ></app-waze-live-map>
        }
        <!-- Fallback message if no user location for Waze -->
        @if (mapProvider() === 'waze' && !userLocation()) {
          <div
            class="absolute inset-0 flex items-center justify-center bg-surface-base"
            >
            <div class="text-center space-y-3 p-6">
              <svg
                class="w-12 h-12 text-warning-strong mx-auto"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
              </svg>
              <p class="text-text-primary font-medium">Necesitamos tu ubicaci√≥n</p>
              <p class="text-text-secondary text-sm">
                Por favor, permite el acceso a tu ubicaci√≥n para usar Waze
              </p>
              <button
                (click)="getUserLocation()"
                class="mt-4 px-4 py-2 bg-cta-default text-cta-text rounded-lg hover:bg-cta-hover transition-colors font-bold"
                >
                Permitir ubicaci√≥n
              </button>
            </div>
          </div>
        }
        <!-- Floating Map Filters (only for Mapbox) -->
        @if (mapProvider() === 'mapbox') {
          <app-map-filters
            [availableCars]="carMapLocations()"
            [userLocation]="userLocation() || undefined"
            (filterChange)="onFilterChange($event)"
          ></app-map-filters>
        }
        <!-- Location FAB -->
        <div
          class="absolute bottom-[calc(6rem+env(safe-area-inset-bottom))] right-4 md:bottom-8 md:right-8 z-[400]"
          >
          <button
            (click)="centerOnUser()"
            class="w-12 h-12 bg-surface-raised rounded-full shadow-lg flex items-center justify-center text-text-primary hover:bg-surface-secondary transition-colors border border-border-default"
            >
            <ion-icon name="locate-outline" class="text-xl"></ion-icon>
          </button>
        </div>
      </div>
    </div>
  }

  <!-- üì¶ GRID & LIST VIEW CONTAINER -->
  @if (viewMode() !== 'map') {
    <div class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Results Header -->
      <div class="mb-8 flex items-center justify-between">
        <h2 class="text-2xl font-bold text-text-primary font-satoshi">
          {{ filteredCars.length }} veh√≠culos encontrados
        </h2>
        <div class="flex items-center gap-3">
          <label class="text-sm text-text-muted" for="sort-select">
            Ordenar por
          </label>
          <select
            id="sort-select"
            class="rounded-lg border border-border-default bg-surface-base px-3 py-2 text-sm text-text-primary shadow-sm focus:border-cta-default focus:ring-1 focus:ring-cta-default outline-none"
            (change)="onSortChange($any($event.target).value)"
            >
            @for (option of sortOptions; track option) {
              <option
                [value]="option.value"
                [selected]="sortOrder() === option.value"
                >
                {{ option.label }}
              </option>
            }
          </select>
        </div>
      </div>
      <!-- GRID VIEW -->
      @if (viewMode() === 'grid') {
        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"
          >
          @for (car of filteredCars; track car; let i = $index) {
            <div
              class="group card-premium cursor-pointer"
              (click)="onCarouselCardSelected(car.id)"
              >
              <!-- Image -->
              <div class="aspect-[4/3] relative overflow-hidden bg-surface-secondary">
                <img
                  [src]="extractPhotoGallery(car)[0] || '/assets/images/car-placeholder.svg'"
                  [alt]="car.brand_text_backup + ' ' + car.model_text_backup"
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                  loading="lazy"
                  />
                <div
                  class="absolute top-3 right-3 bg-surface-base/90 backdrop-blur px-3 py-1 rounded-full text-sm font-bold text-text-primary shadow-sm border border-border-default"
                  >
                  @if (car.price_per_day && car.price_per_day > 0) {
                    ${{ car.price_per_day | number: '1.0-0' }}
                    <span class="text-xs font-normal text-text-secondary">/d√≠a</span>
                  } @else {
                    <span class="text-text-primary">Consultar</span>
                  }
                </div>
              </div>
              <!-- Content -->
              <div class="p-4">
                <h3 class="text-lg font-bold text-text-primary mb-1 truncate font-satoshi">
                  {{ car.brand_text_backup }} {{ car.model_text_backup }}
                </h3>
                <p class="text-sm text-text-secondary mb-3 flex items-center gap-1">
                  <ion-icon name="location-outline"></ion-icon>
                  {{ car.location_city || 'Ubicaci√≥n no disponible' }}
                </p>
                <div class="flex items-center gap-3 text-sm text-text-muted">
                  <span
                    class="flex items-center gap-1 bg-surface-secondary px-2 py-1 rounded-md"
                    >
                    <svg
                      class="w-4 h-4 text-text-secondary"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                      >
                      <circle cx="12" cy="12" r="3" stroke-width="1.75" />
                      <path
                        d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"
                        stroke-width="1.75"
                        stroke-linecap="round"
                        />
                    </svg>
                    {{ car.transmission || 'Manual' }}
                  </span>
                  <span
                    class="flex items-center gap-1 bg-surface-secondary px-2 py-1 rounded-md"
                    >
                    üë• {{ car.seats || 5 }}
                  </span>
                </div>
              </div>
            </div>
          }
        </div>
      }
      <!-- LIST VIEW -->
      @if (viewMode() === 'list') {
        <div class="flex flex-col gap-4 max-w-5xl mx-auto">
          @for (car of filteredCars; track car) {
            <div
              class="card-premium cursor-pointer flex flex-col md:flex-row"
              (click)="onCarouselCardSelected(car.id)"
              >
              <!-- Image -->
              <div class="md:w-72 aspect-video md:aspect-auto relative bg-surface-secondary">
                <img
                  [src]="extractPhotoGallery(car)[0] || '/assets/images/car-placeholder.svg'"
                  [alt]="car.brand_text_backup + ' ' + car.model_text_backup"
                  class="w-full h-full object-cover"
                  loading="lazy"
                  />
              </div>
              <!-- Content -->
              <div class="p-5 flex-1 flex flex-col justify-between">
                <div>
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <h3 class="text-xl font-bold text-text-primary font-satoshi">
                        {{ car.brand_text_backup }} {{ car.model_text_backup }}
                      </h3>
                      <p class="text-sm text-text-secondary flex items-center gap-1 mt-1">
                        <svg
                          class="w-4 h-4 text-text-muted"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                          >
                          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke-width="1.75" />
                          <circle cx="12" cy="10" r="3" stroke-width="1.75" />
                        </svg>
                        {{ car.location_city }}, {{ car.location_state }}
                      </p>
                    </div>
                    <div class="text-right">
                      @if (car.price_per_day && car.price_per_day > 0) {
                        <div class="text-2xl font-bold text-text-primary">
                          ${{ car.price_per_day | number: '1.0-0' }}
                        </div>
                        <div class="text-xs text-text-secondary">por d√≠a</div>
                      } @else {
                        <div class="text-lg font-semibold text-text-primary">Consultar precio</div>
                      }
                    </div>
                  </div>
                  @if (car.description) {
                    <p
                      class="text-text-secondary text-sm line-clamp-2 mb-4"
                      >
                      {{ car.description }}
                    </p>
                  }
                  <div class="flex flex-wrap gap-3">
                    <span
                      class="px-3 py-1 bg-surface-secondary rounded-full text-xs font-medium text-text-secondary flex items-center gap-1"
                      >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        >
                        <circle cx="12" cy="12" r="3" stroke-width="1.75" />
                        <path
                          d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"
                          stroke-width="1.75"
                          stroke-linecap="round"
                          />
                      </svg>
                      {{ car.transmission || 'Manual' }}
                    </span>
                    <span
                      class="px-3 py-1 bg-surface-secondary rounded-full text-xs font-medium text-text-secondary flex items-center gap-1"
                      >
                      ‚õΩ {{ car.fuel_type || 'Nafta' }}
                    </span>
                    <span
                      class="px-3 py-1 bg-surface-secondary rounded-full text-xs font-medium text-text-secondary flex items-center gap-1"
                      >
                      üë• {{ car.seats || 5 }} asientos
                    </span>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      }
      <!-- Empty State -->
      @if (filteredCars.length === 0 && !loading) {
        <div class="text-center py-20">
          <div
            class="w-20 h-20 bg-surface-secondary rounded-full flex items-center justify-center mx-auto mb-4 text-4xl"
            >
            üîç
          </div>
          <h3 class="text-xl font-bold text-text-primary mb-2 font-satoshi">
            No encontramos veh√≠culos
          </h3>
          <p class="text-text-secondary">Intenta ajustar tu b√∫squeda o filtros.</p>
        </div>
      }
    </div>
  }
</ion-content>