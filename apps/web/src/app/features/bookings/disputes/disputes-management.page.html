<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="'/bookings/' + bookingId()"></ion-back-button>
    </ion-buttons>
    <ion-title>Gestión de Disputas</ion-title>
    @if (canCreateDispute() && !showCreateForm()) {
      <ion-buttons slot="end">
        <ion-button (click)="openCreateForm()">
          <ion-icon name="add" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-buttons>
    }
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Role indicator -->
  @if (booking()) {
    <div class="flex items-center gap-2 mb-4">
      <span
        class="text-xs px-2 py-1 rounded-full"
        [class]="isOwner() ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'"
      >
        {{ isOwner() ? 'Eres el Anfitrión' : 'Eres el Locatario' }}
      </span>
    </div>
  }

  <!-- Booking Info -->
  @if (booking()) {
    <ion-card class="mb-4">
      <ion-card-header>
        <ion-card-title>Reserva #{{ booking()!.id.slice(0, 8) }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p class="text-sm">
          <strong>Auto:</strong> {{ booking()!.car?.brand }} {{ booking()!.car?.model }}
        </p>
        <p class="text-sm">
          <strong>Período:</strong> {{ booking()!.start_at | date: 'short' }} -
          {{ booking()!.end_at | date: 'short' }}
        </p>
      </ion-card-content>
    </ion-card>
  }

  <!-- Inline Create Dispute Form -->
  @if (showCreateForm()) {
    <div
      class="create-dispute-form bg-surface-raised border-2 border-cta-default rounded-xl p-4 mb-6 animate-in slide-in-from-top"
    >
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Nueva Disputa</h3>
        <button (click)="closeCreateForm()" class="p-2 rounded-full hover:bg-surface-hover">
          <ion-icon name="close" class="text-xl"></ion-icon>
        </button>
      </div>

      <form (ngSubmit)="createDispute()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text-secondary mb-2"
            >Tipo de Disputa *</label
          >
          <select
            [ngModel]="newDisputeKind()"
            (ngModelChange)="newDisputeKind.set($event)"
            [ngModelOptions]="{ standalone: true }"
            class="w-full px-4 py-3 rounded-xl border border-border-default bg-surface-base"
            required
          >
            <option value="">Seleccionar...</option>
            <option value="damage">Daños al vehículo</option>
            <option value="no_show">No se presentó</option>
            <option value="late_return">Devolución tardía</option>
            <option value="other">Otro</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-text-secondary mb-2">Descripción *</label>
          <textarea
            [ngModel]="newDisputeDescription()"
            (ngModelChange)="newDisputeDescription.set($event)"
            [ngModelOptions]="{ standalone: true }"
            rows="4"
            class="w-full px-4 py-3 rounded-xl border border-border-default bg-surface-base resize-none"
            placeholder="Describe el problema en detalle..."
            required
          ></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-text-secondary mb-2"
            >Evidencias (opcional)</label
          >
          <input
            type="file"
            multiple
            accept="image/*,.pdf"
            (change)="onEvidenceFilesSelected($event)"
            class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-cta-default file:text-cta-text"
          />
          @if (evidenceFiles().length > 0) {
            <p class="text-xs text-text-secondary mt-2">
              {{ evidenceFiles().length }} archivo(s) seleccionado(s)
            </p>
          }
        </div>

        <div class="flex gap-3 pt-2">
          <button
            type="button"
            (click)="closeCreateForm()"
            class="flex-1 py-3 rounded-xl border border-border-default font-semibold hover:bg-surface-hover"
          >
            Cancelar
          </button>
          <button
            type="submit"
            [disabled]="loading() || !newDisputeKind() || !newDisputeDescription()"
            class="flex-1 py-3 rounded-xl bg-cta-default text-cta-text font-bold disabled:opacity-50"
          >
            @if (loading()) {
              <ion-spinner name="crescent" class="w-5 h-5"></ion-spinner>
            } @else {
              Crear Disputa
            }
          </button>
        </div>
      </form>
    </div>
  }

  <!-- Loading State -->
  @if (loading() && !showCreateForm()) {
    <div class="flex flex-col items-center justify-center py-12">
      <ion-spinner name="crescent"></ion-spinner>
      <p class="mt-4 text-text-secondary">Cargando disputas...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && disputes().length === 0 && !showCreateForm()) {
    <div class="text-center py-12">
      <ion-icon name="document-text-outline" class="text-6xl text-text-muted mb-4"></ion-icon>
      <p class="text-text-secondary mb-4">No hay disputas para esta reserva</p>
      @if (canCreateDispute()) {
        <ion-button (click)="openCreateForm()">
          <ion-icon name="add" slot="start"></ion-icon>
          Crear Disputa
        </ion-button>
      } @else {
        <p class="text-xs text-text-muted">
          No puedes crear disputas en el estado actual de la reserva
        </p>
      }
    </div>
  }

  <!-- Disputes List -->
  @if (!loading() && disputes().length > 0) {
    <div class="space-y-4">
      @for (dispute of disputes(); track dispute) {
        <ion-card class="mb-4">
          <ion-card-header>
            <div class="flex items-center justify-between">
              <ion-card-title class="text-base">
                Disputa #{{ dispute.id.slice(0, 8) }}
              </ion-card-title>
              <ion-badge [color]="getStatusColor(dispute.status)">
                {{ getStatusLabel(dispute.status) }}
              </ion-badge>
            </div>
            <ion-card-subtitle>
              {{ getKindLabel(dispute.kind) }} • {{ formatDate(dispute.created_at) }}
            </ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <p class="text-sm mb-4">{{ dispute.description || 'Sin descripción' }}</p>
            <div class="flex gap-2">
              <ion-button fill="outline" size="small" (click)="openEvidenceModal(dispute)">
                <ion-icon name="images" slot="start"></ion-icon>
                Ver Evidencias
              </ion-button>
            </div>
            @if (dispute.resolved_at) {
              <div class="mt-4 pt-4 border-t">
                <p class="text-xs text-text-secondary">
                  Resuelto el {{ formatDate(dispute.resolved_at) }}
                </p>
              </div>
            }
          </ion-card-content>
        </ion-card>
      }
    </div>
  }

  <!-- Evidence Modal -->
  @if (showEvidenceModal()) {
    <div
      class="fixed inset-0 z-50 flex items-center justify-center bg-surface-overlay/50 p-4"
      (click)="closeEvidenceModal()"
    >
      <ion-card
        class="max-w-4xl w-full max-h-[90vh] overflow-y-auto"
        (click)="$event.stopPropagation()"
      >
        <ion-card-header>
          <ion-card-title
            >Evidencias - Disputa #{{ selectedDispute()?.id?.slice(0, 8) }}</ion-card-title
          >
        </ion-card-header>
        <ion-card-content>
          <!-- Evidence Gallery -->
          @if (evidence().length > 0) {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
              @for (item of evidence(); track item) {
                <div class="relative p-3 rounded-lg border border-border-default bg-surface-base">
                  @if (item.path) {
                    <div class="h-48">
                      @if (isImage(item.path)) {
                        <img
                          [src]="item.path"
                          [alt]="item.note || 'Evidencia'"
                          class="w-full h-full object-cover rounded"
                          width="400"
                          height="192"
                        />
                      }
                      @if (!isImage(item.path)) {
                        <div
                          class="w-full h-full bg-surface-raised rounded flex items-center justify-center"
                        >
                          <ion-icon name="document" class="text-4xl text-text-muted"></ion-icon>
                        </div>
                      }
                      @if (item.note) {
                        <p class="text-xs text-text-secondary mt-2">{{ item.note }}</p>
                      }
                      <a
                        [href]="item.path"
                        target="_blank"
                        class="text-xs text-cta-default mt-1 block"
                      >
                        Ver completo
                      </a>
                    </div>
                  } @else {
                    <div class="flex flex-col h-full justify-between">
                      <div>
                        <h4 class="font-semibold text-text-primary mb-1 font-satoshi">
                          Comentario:
                        </h4>
                        <p class="text-sm text-text-secondary whitespace-pre-wrap">
                          {{ item.note }}
                        </p>
                      </div>
                      <p class="text-xs text-text-muted mt-2 text-right">
                        {{ formatDate(item.created_at) }}
                      </p>
                    </div>
                  }
                </div>
              }
            </div>
          }
          @if (evidence().length === 0) {
            <div class="text-center py-8 text-text-secondary">
              <p>No hay evidencias para esta disputa</p>
            </div>
          }
          <!-- Add Evidence Form -->
          <div class="mt-6 pt-6 border-t">
            <h3 class="text-lg font-semibold mb-3 font-satoshi">Agregar Evidencia</h3>
            <ion-item class="mb-4">
              <ion-label position="stacked">Archivos</ion-label>
              <ion-input
                type="file"
                multiple
                accept="image/*,.pdf"
                (change)="onEvidenceFilesSelected($event)"
              ></ion-input>
            </ion-item>
            <ion-item class="mb-4">
              <ion-label position="stacked">Nota (opcional)</ion-label>
              <ion-input
                [(ngModel)]="evidenceNote"
                name="evidenceNote"
                placeholder="Descripción de la evidencia"
              ></ion-input>
            </ion-item>
            <ion-button
              expand="block"
              (click)="addEvidenceToSelectedDispute()"
              [disabled]="evidenceFiles().length === 0 || uploadingEvidence()"
            >
              <ion-icon name="cloud-upload" slot="start"></ion-icon>
              {{ uploadingEvidence() ? 'Subiendo...' : 'Subir Evidencias' }}
            </ion-button>
          </div>
          <!-- NEW: Add Comment Section -->
          <div class="mt-6 pt-6 border-t">
            <h3 class="text-lg font-semibold mb-3 font-satoshi">Agregar Comentario</h3>
            <ion-item class="mb-4">
              <ion-label position="stacked">Tu Comentario</ion-label>
              <ion-textarea
                [(ngModel)]="newComment"
                name="newComment"
                rows="3"
                placeholder="Escribe tu respuesta o comentario..."
              ></ion-textarea>
            </ion-item>
            <ion-button
              expand="block"
              (click)="addCommentToSelectedDispute()"
              [disabled]="!newComment() || newComment().trim() === '' || uploadingEvidence()"
            >
              <ion-icon name="send" slot="start"></ion-icon>
              Enviar Comentario
            </ion-button>
          </div>
          <!-- END NEW -->
          <ion-button expand="block" fill="outline" class="mt-4" (click)="closeEvidenceModal()">
            Cerrar
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>
  }
</ion-content>
