<ion-header>
  <ion-toolbar [color]="booking()?.status === 'confirmed' ? 'success' : 'primary'">
    <ion-title>
      @if (loading()) {
        Procesando...
      } @else if (booking()?.status === 'confirmed') {
        ¡Reserva Confirmada!
      } @else {
        ¡Solicitud Enviada!
      }
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding bg-surface-base">
  <!-- Loading State -->
  @if (loading()) {
    <div class="flex flex-col items-center justify-center min-h-screen">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="mt-4 text-text-secondary">Cargando detalles...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error(); as errorMsg) {
    <div class="max-w-2xl mx-auto mt-8">
      <ion-card color="danger">
        <ion-card-header>
          <ion-card-title>Error</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ errorMsg }}</p>
          <ion-button expand="block" [routerLink]="['/bookings']" class="mt-4">
            Ver Mis Reservas
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>
  }

  <!-- Success State -->
  @else if (booking(); as bkg) {
    <div class="success-container max-w-3xl mx-auto" data-testid="booking-success-page">
      <!-- ✅ Payment Status Indicator (solo si viene de MercadoPago) -->
      @if (paymentStatus() !== 'pending' || pollAttempts > 0) {
        <div class="mb-6">
          @if (paymentStatus() === 'pending') {
            <ion-card color="warning">
              <ion-card-content>
                <div class="flex items-center mb-2">
                  <ion-spinner name="crescent" class="mr-3"></ion-spinner>
                  <div class="flex-1">
                    <h3 class="font-semibold font-satoshi font-luxury">Verificando pago...</h3>
                    <p class="text-sm">
                      Esperando confirmación de MercadoPago
                      @if (pollAttempts > 0) {
                        <span class="text-xs">(~{{ getEstimatedTimeRemaining() }}s restantes)</span>
                      }
                    </p>
                  </div>
                </div>
                @if (pollProgress() > 0) {
                  <div class="mt-2">
                    <div class="flex justify-between text-xs text-text-secondary mb-1">
                      <span>Verificación {{ pollAttempts }} de {{ MAX_POLL_ATTEMPTS }}</span>
                      <span>{{ pollProgress() }}%</span>
                    </div>
                    <ion-progress-bar
                      [value]="pollProgress() / 100"
                      color="warning"
                    ></ion-progress-bar>
                  </div>
                }
              </ion-card-content>
            </ion-card>
          } @else if (paymentStatus() === 'completed') {
            <ion-card color="success">
              <ion-card-content class="flex items-center">
                <ion-icon name="checkmark-circle" class="text-3xl mr-3"></ion-icon>
                <div>
                  <h3 class="font-semibold font-satoshi font-luxury">¡Pago confirmado!</h3>
                  <p class="text-sm font-luxury">MercadoPago procesó tu pago exitosamente</p>
                </div>
              </ion-card-content>
            </ion-card>
          } @else if (paymentStatus() === 'failed') {
            <ion-card color="danger">
              <ion-card-content>
                <div class="flex items-center mb-3">
                  <ion-icon name="close-circle" class="text-3xl mr-3"></ion-icon>
                  <div>
                    <h3 class="font-semibold font-satoshi font-luxury">Pago rechazado</h3>
                    <p class="text-sm">
                      MercadoPago no pudo procesar tu pago. Esto puede deberse a fondos
                      insuficientes, tarjeta vencida o problemas de seguridad.
                    </p>
                  </div>
                </div>
                <div class="flex gap-2 mt-4">
                  <ion-button
                    size="small"
                    expand="block"
                    fill="solid"
                    color="danger"
                    (click)="retryPayment()"
                  >
                    <ion-icon name="card-outline" slot="start"></ion-icon>
                    Reintentar con otro método
                  </ion-button>
                  <ion-button
                    size="small"
                    expand="block"
                    fill="outline"
                    color="medium"
                    [routerLink]="['/bookings']"
                  >
                    Ver mis reservas
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>
          } @else if (paymentStatus() === 'timeout') {
            <ion-card color="warning">
              <ion-card-content>
                <div class="flex items-center mb-3">
                  <ion-icon name="time-outline" class="text-3xl mr-3"></ion-icon>
                  <div>
                    <h3 class="font-semibold font-satoshi">Verificación en proceso</h3>
                    <p class="text-sm">
                      El pago puede tardar unos minutos en confirmarse. Revisa tu email o consulta
                      el detalle de la reserva más tarde.
                    </p>
                  </div>
                </div>
                <ion-button size="small" fill="clear" (click)="retryPolling()">
                  <ion-icon name="refresh-outline" slot="start"></ion-icon>
                  Reintentar verificación
                </ion-button>
              </ion-card-content>
            </ion-card>
          }
        </div>
      }

      <!-- Success Icon -->
      <div class="text-center mb-6">
        <ion-icon
          name="checkmark-circle"
          color="success"
          class="success-icon"
          style="font-size: 120px"
        >
        </ion-icon>
      </div>

      <!-- Main Message -->
      @if (bkg.status === 'confirmed') {
        <h1
          class="text-3xl font-bold text-center mb-2 text-text-primary tracking-tight font-satoshi"
        >
          ¡Tu reserva está confirmada!
        </h1>
      } @else {
        <h1
          class="text-3xl font-bold text-center mb-2 text-text-primary tracking-tight font-satoshi"
        >
          ¡Tu solicitud fue enviada!
        </h1>
      }

      <p class="text-center text-text-secondary mb-6">
        @if (bkg.status === 'confirmed') {
          Hemos enviado los detalles a tu email
        } @else {
          El anfitrión revisará tu solicitud. Te avisaremos cuando responda.
        }
      </p>

      <div class="flex flex-col items-center gap-3 mb-8">
        <div
          class="inline-flex items-center gap-2 px-3 py-2 rounded-full bg-surface-secondary text-text-secondary border border-border-default text-sm"
        >
          <ion-icon name="time-outline"></ion-icon>
          <span>Te llevamos al detalle en {{ autoRedirectSeconds() }}s</span>
        </div>
        <div class="flex flex-wrap items-center justify-center gap-2">
          <ion-button size="small" fill="solid" color="primary" (click)="goToBookingDetail()">
            Ver detalles ahora
          </ion-button>
          <ion-button size="small" fill="clear" color="medium" (click)="cancelAutoRedirect()">
            Quedarme aquí
          </ion-button>
        </div>
      </div>

      <!-- Booking Summary Card -->
      <ion-card class="mb-6 card-premium">
        <ion-card-header>
          <ion-card-title class="flex items-center text-text-primary">
            <ion-icon name="calendar-outline" class="mr-2 text-cta-default"></ion-icon>
            Detalles de tu Reserva
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="space-y-4">
            <!-- Car Info -->
            <div class="flex items-center space-x-4 pb-4 border-b border-border-default">
              <div
                class="w-24 h-24 bg-surface-secondary rounded-lg flex items-center justify-center"
              >
                <ion-icon name="car-outline" class="text-4xl text-text-muted"></ion-icon>
              </div>
              <div>
                <h3 class="font-semibold text-lg text-text-primary font-satoshi">
                  {{ getCarName() }}
                </h3>
                <p class="text-sm text-text-secondary">
                  <ion-icon name="location-outline"></ion-icon>
                  @if (bkg.status === 'confirmed') {
                    Reserva confirmada
                  } @else {
                    Solicitud enviada
                  }
                </p>
              </div>
            </div>

            <!-- Dates -->
            <div class="detail-row text-text-secondary">
              <span class="label">
                <ion-icon name="log-in-outline"></ion-icon>
                Desde:
              </span>
              <span class="value text-text-primary">{{
                bkg.start_at | date: 'dd/MM/yyyy HH:mm'
              }}</span>
            </div>

            <div class="detail-row text-text-secondary">
              <span class="label">
                <ion-icon name="log-out-outline"></ion-icon>
                Hasta:
              </span>
              <span class="value text-text-primary">{{
                bkg.end_at | date: 'dd/MM/yyyy HH:mm'
              }}</span>
            </div>

            <!-- Total -->
            <div class="detail-row pt-4 border-t border-border-default">
              <span class="label font-semibold text-text-primary">
                <ion-icon name="cash-outline"></ion-icon>
                @if (bkg.status === 'confirmed') {
                  Total Pagado:
                } @else {
                  Total estimado:
                }
              </span>
              <span class="value font-bold text-success-text">
                {{ bkg.total_amount | currency: bkg.currency || 'ARS' : 'symbol' : '1.0-0' }}
              </span>
            </div>

            <!-- Booking ID -->
            <div class="detail-row text-xs">
              <span class="label text-text-muted">Número de Reserva:</span>
              <span class="value font-mono text-text-secondary">
                {{ bookingId() | slice: 0 : 8 }}...
              </span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- P2P Flow Timeline -->
      @if (bkg.status !== 'confirmed') {
        <div class="mb-6 bg-surface-secondary rounded-2xl p-6 border border-border-default">
          <h3 class="text-lg font-bold text-text-primary mb-4 flex items-center gap-2">
            <ion-icon name="git-branch-outline" class="text-info-500"></ion-icon>
            Estado de tu Solicitud
          </h3>

          <div class="relative">
            <!-- Timeline Line -->
            <div class="absolute left-4 top-8 bottom-8 w-0.5 bg-border-default"></div>

            <!-- Step 1: Solicitud Enviada - COMPLETADO -->
            <div class="flex items-start gap-4 mb-6">
              <div
                class="relative z-10 w-8 h-8 rounded-full bg-success-500 flex items-center justify-center flex-shrink-0"
              >
                <ion-icon name="checkmark" class="text-white text-lg"></ion-icon>
              </div>
              <div class="flex-1 pt-1">
                <h4 class="font-semibold text-success-text">Solicitud Enviada</h4>
                <p class="text-sm text-text-secondary">Tu garantía está pre-autorizada</p>
              </div>
            </div>

            <!-- Step 2: Esperando Aprobación - EN PROGRESO -->
            <div class="flex items-start gap-4 mb-6">
              <div
                class="relative z-10 w-8 h-8 rounded-full bg-warning-500 flex items-center justify-center flex-shrink-0 animate-pulse"
              >
                <ion-icon name="hourglass-outline" class="text-white text-lg"></ion-icon>
              </div>
              <div class="flex-1 pt-1">
                <h4 class="font-semibold text-warning-text">Esperando Aprobación</h4>
                <p class="text-sm text-text-secondary">
                  El anfitrión revisará tu perfil y responderá pronto
                </p>
                <p class="text-xs text-text-muted mt-1">Tiempo promedio: 2-4 horas</p>
              </div>
            </div>

            <!-- Step 3: Check-in - PENDIENTE -->
            <div class="flex items-start gap-4 mb-6">
              <div
                class="relative z-10 w-8 h-8 rounded-full bg-surface-pressed flex items-center justify-center flex-shrink-0"
              >
                <span class="text-text-muted font-bold text-sm">3</span>
              </div>
              <div class="flex-1 pt-1 opacity-60">
                <h4 class="font-semibold text-text-muted">Check-in</h4>
                <p class="text-sm text-text-muted">Firma del contrato con fotos del vehículo</p>
              </div>
            </div>

            <!-- Step 4: Viaje - PENDIENTE -->
            <div class="flex items-start gap-4">
              <div
                class="relative z-10 w-8 h-8 rounded-full bg-surface-pressed flex items-center justify-center flex-shrink-0"
              >
                <span class="text-text-muted font-bold text-sm">4</span>
              </div>
              <div class="flex-1 pt-1 opacity-60">
                <h4 class="font-semibold text-text-muted">¡A disfrutar!</h4>
                <p class="text-sm text-text-muted">Tu viaje comienza</p>
              </div>
            </div>
          </div>

          <!-- Info Box -->
          <div class="mt-6 p-4 bg-surface-raised rounded-xl border border-border-default">
            <div class="flex items-start gap-3">
              <ion-icon
                name="notifications-outline"
                class="text-info-500 text-xl flex-shrink-0 mt-0.5"
              ></ion-icon>
              <div>
                <p class="text-sm text-text-primary font-medium">
                  Te notificaremos cuando el anfitrión responda
                </p>
                <p class="text-xs text-text-secondary mt-1">
                  Recibirás un email y notificación push
                </p>
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Next Steps Card (solo si está confirmado) -->
      @if (bkg.status === 'confirmed') {
        <ion-card class="mb-6 card-premium">
          <ion-card-header>
            <ion-card-title class="flex items-center text-text-primary">
              <ion-icon name="list-outline" class="mr-2 text-cta-default"></ion-icon>
              Próximos Pasos
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list lines="full">
              <ion-item class="item-premium">
                <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
                <ion-label class="ion-text-wrap">
                  <h3 class="font-semibold font-satoshi text-text-primary">Revisa tu email</h3>
                  <p class="text-sm text-text-secondary">
                    Te enviamos todos los detalles y el contrato
                  </p>
                </ion-label>
              </ion-item>

              <ion-item class="item-premium">
                <ion-icon name="chatbubble-outline" slot="start" color="primary"></ion-icon>
                <ion-label class="ion-text-wrap">
                  <h3 class="font-semibold font-satoshi text-text-primary">
                    Contacta al propietario
                  </h3>
                  <p class="text-sm text-text-secondary">
                    Coordina la entrega del vehículo con 24hs de anticipación
                  </p>
                </ion-label>
              </ion-item>

              <ion-item class="item-premium">
                <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
                <ion-label class="ion-text-wrap">
                  <h3 class="font-semibold font-satoshi text-text-primary">
                    Prepara tu documentación
                  </h3>
                  <p class="text-sm text-text-secondary">
                    DNI, licencia de conducir vigente y tarjeta de crédito a tu nombre
                  </p>
                </ion-label>
              </ion-item>

              <ion-item lines="none" class="item-premium">
                <ion-icon name="car-outline" slot="start" color="primary"></ion-icon>
                <ion-label class="ion-text-wrap">
                  <h3 class="font-semibold font-satoshi text-text-primary">¡Disfruta tu viaje!</h3>
                  <p class="text-sm text-text-secondary">
                    Recuerda devolver el vehículo en las mismas condiciones
                  </p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      }

      <!-- Action Buttons -->
      <div class="action-buttons space-y-3">
        <ion-button
          expand="block"
          [routerLink]="['/bookings', bookingId()]"
          color="primary"
          size="large"
          data-testid="view-details-button"
        >
          <ion-icon name="document-text-outline" slot="start"></ion-icon>
          Ver Detalles de la Reserva
        </ion-button>

        <ion-button
          expand="block"
          [routerLink]="['/cars']"
          fill="outline"
          color="primary"
          size="large"
          data-testid="search-more-button"
        >
          <ion-icon name="search-outline" slot="start"></ion-icon>
          Buscar Más Vehículos
        </ion-button>

        <ion-button
          expand="block"
          [routerLink]="['/']"
          fill="clear"
          color="medium"
          data-testid="home-button"
        >
          <ion-icon name="home-outline" slot="start"></ion-icon>
          Ir al Inicio
        </ion-button>
      </div>

      <!-- Referral Banner -->
      <div class="mt-8">
        <app-referral-banner />
      </div>

      <!-- Confetti Animation (optional) -->
      <div class="confetti-container">
        <!-- Add confetti animation here if desired -->
      </div>
    </div>
  }
</ion-content>
