<ion-header>
  <ion-toolbar color="success">
    <ion-title>¡Reserva Confirmada!</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  @if (loading()) {
    <div class="flex flex-col items-center justify-center min-h-screen">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p class="mt-4 text-gray-600">Cargando detalles...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error(); as errorMsg) {
    <div class="max-w-2xl mx-auto mt-8">
      <ion-card color="danger">
        <ion-card-header>
          <ion-card-title>Error</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ errorMsg }}</p>
          <ion-button expand="block" [routerLink]="['/bookings']" class="mt-4">
            Ver Mis Reservas
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>
  }

  <!-- Success State -->
  @else if (booking(); as bkg) {
    <div class="success-container max-w-3xl mx-auto">
      <!-- ✅ Payment Status Indicator (solo si viene de MercadoPago) -->
      @if (paymentStatus() !== 'pending' || pollAttempts > 0) {
        <div class="mb-6">
          @if (paymentStatus() === 'pending') {
            <ion-card color="warning">
              <ion-card-content class="flex items-center">
                <ion-spinner name="crescent" class="mr-3"></ion-spinner>
                <div>
                  <h3 class="font-semibold">Verificando pago...</h3>
                  <p class="text-sm">Esperando confirmación de MercadoPago</p>
                </div>
              </ion-card-content>
            </ion-card>
          }
          @else if (paymentStatus() === 'completed') {
            <ion-card color="success">
              <ion-card-content class="flex items-center">
                <ion-icon name="checkmark-circle" class="text-3xl mr-3"></ion-icon>
                <div>
                  <h3 class="font-semibold">¡Pago confirmado!</h3>
                  <p class="text-sm">MercadoPago procesó tu pago exitosamente</p>
                </div>
              </ion-card-content>
            </ion-card>
          }
          @else if (paymentStatus() === 'failed') {
            <ion-card color="danger">
              <ion-card-content class="flex items-center">
                <ion-icon name="close-circle" class="text-3xl mr-3"></ion-icon>
                <div>
                  <h3 class="font-semibold">Pago rechazado</h3>
                  <p class="text-sm">
                    MercadoPago no pudo procesar tu pago. Por favor intenta nuevamente.
                  </p>
                </div>
              </ion-card-content>
            </ion-card>
          }
          @else if (paymentStatus() === 'timeout') {
            <ion-card color="warning">
              <ion-card-content class="flex items-center">
                <ion-icon name="time-outline" class="text-3xl mr-3"></ion-icon>
                <div>
                  <h3 class="font-semibold">Verificación en proceso</h3>
                  <p class="text-sm">
                    El pago puede tardar unos minutos en confirmarse. Revisa tu email o consulta
                    el detalle de la reserva más tarde.
                  </p>
                </div>
              </ion-card-content>
            </ion-card>
          }
        </div>
      }

      <!-- Success Icon -->
      <div class="text-center mb-6">
        <ion-icon
          name="checkmark-circle"
          color="success"
          class="success-icon"
          style="font-size: 120px"
        >
        </ion-icon>
      </div>

      <!-- Main Message -->
      <h1 class="text-3xl font-bold text-center mb-2 text-gray-900 dark:text-white">
        ¡Tu reserva está confirmada!
      </h1>

      <p class="text-center text-gray-600 dark:text-gray-400 mb-8">
        Hemos enviado los detalles a tu email
      </p>

      <!-- Booking Summary Card -->
      <ion-card class="mb-6">
        <ion-card-header>
          <ion-card-title class="flex items-center">
            <ion-icon name="calendar-outline" class="mr-2"></ion-icon>
            Detalles de tu Reserva
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="space-y-4">
            <!-- Car Info -->
            <div
              class="flex items-center space-x-4 pb-4 border-b border-gray-200 dark:border-gray-700"
            >
              <div
                class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center"
              >
                <ion-icon name="car-outline" class="text-4xl text-gray-400"></ion-icon>
              </div>
              <div>
                <h3 class="font-semibold text-lg">{{ getCarName() }}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  <ion-icon name="location-outline"></ion-icon>
                  Reserva confirmada
                </p>
              </div>
            </div>

            <!-- Dates -->
            <div class="detail-row">
              <span class="label">
                <ion-icon name="log-in-outline"></ion-icon>
                Desde:
              </span>
              <span class="value">{{ bkg.start_at | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>

            <div class="detail-row">
              <span class="label">
                <ion-icon name="log-out-outline"></ion-icon>
                Hasta:
              </span>
              <span class="value">{{ bkg.end_at | date: 'dd/MM/yyyy HH:mm' }}</span>
            </div>

            <!-- Total -->
            <div class="detail-row pt-4 border-t border-gray-200 dark:border-gray-700">
              <span class="label font-semibold">
                <ion-icon name="cash-outline"></ion-icon>
                Total Pagado:
              </span>
              <span class="value font-bold text-green-600">
                {{ bkg.total_amount | currency: 'ARS' : 'symbol' : '1.0-0' }}
              </span>
            </div>

            <!-- Booking ID -->
            <div class="detail-row text-xs">
              <span class="label text-gray-500">Número de Reserva:</span>
              <span class="value font-mono text-gray-700 dark:text-gray-300">
                {{ bookingId() | slice: 0 : 8 }}...
              </span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Next Steps Card -->
      <ion-card class="mb-6">
        <ion-card-header>
          <ion-card-title class="flex items-center">
            <ion-icon name="list-outline" class="mr-2"></ion-icon>
            Próximos Pasos
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list lines="full">
            <ion-item>
              <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
              <ion-label class="ion-text-wrap">
                <h3 class="font-semibold">Revisa tu email</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Te enviamos todos los detalles y el contrato de alquiler
                </p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon name="chatbubble-outline" slot="start" color="primary"></ion-icon>
              <ion-label class="ion-text-wrap">
                <h3 class="font-semibold">Contacta al propietario</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Coordina la entrega del vehículo con 24hs de anticipación
                </p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon name="document-text-outline" slot="start" color="primary"></ion-icon>
              <ion-label class="ion-text-wrap">
                <h3 class="font-semibold">Prepara tu documentación</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  DNI, licencia de conducir vigente y tarjeta de crédito a tu nombre
                </p>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-icon name="car-outline" slot="start" color="primary"></ion-icon>
              <ion-label class="ion-text-wrap">
                <h3 class="font-semibold">¡Disfruta tu viaje!</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Recuerda devolver el vehículo en las mismas condiciones
                </p>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Action Buttons -->
      <div class="action-buttons space-y-3">
        <ion-button
          expand="block"
          [routerLink]="['/bookings', bookingId()]"
          color="primary"
          size="large"
        >
          <ion-icon name="document-text-outline" slot="start"></ion-icon>
          Ver Detalles de la Reserva
        </ion-button>

        <ion-button
          expand="block"
          [routerLink]="['/cars']"
          fill="outline"
          color="primary"
          size="large"
        >
          <ion-icon name="search-outline" slot="start"></ion-icon>
          Buscar Más Vehículos
        </ion-button>

        <ion-button expand="block" [routerLink]="['/']" fill="clear" color="medium">
          <ion-icon name="home-outline" slot="start"></ion-icon>
          Ir al Inicio
        </ion-button>
      </div>

      <!-- Confetti Animation (optional) -->
      <div class="confetti-container">
        <!-- Add confetti animation here if desired -->
      </div>
    </div>
  }
</ion-content>
