<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/bookings/owner"></ion-back-button>
    </ion-buttons>
    <ion-title>Check-Out del Auto</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <div *ngIf="loading()" class="text-center py-16">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p class="mt-4 text-text-secondary">Cargando reserva...</p>
  </div>

  <!-- Check-Out Form -->
  <div *ngIf="!loading() && booking()" class="max-w-2xl mx-auto">
    <!-- Booking Info Card -->
    <div class="card-premium p-6 mb-6">
      <h2 class="text-xl font-bold text-text-primary mb-4">Informaci√≥n de la Reserva</h2>

      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-text-secondary">Auto:</span>
          <span class="font-semibold">{{ booking()?.car?.title }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-text-secondary">Locatario:</span>
          <span class="font-semibold">{{ booking()?.renter_id || 'N/A' }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-text-secondary">Per√≠odo:</span>
          <span class="font-semibold">
            {{ booking()?.start_at | date: 'dd/MM/yyyy' }} -
            {{ booking()?.end_at | date: 'dd/MM/yyyy' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Check-In Comparison Card -->
    <div *ngIf="checkInData()" class="bg-cta-default/10 border border-cta-default/40 rounded-xl p-4 mb-6">
      <h3 class="font-semibold text-cta-default mb-3">üìã Estado al Check-In</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-cta-default">Kilometraje:</span>
          <span class="font-semibold text-cta-default"
            >{{ checkInData().odometer_reading | number }} km</span
          >
        </div>
        <div class="flex justify-between">
          <span class="text-cta-default">Combustible:</span>
          <span class="font-semibold text-cta-default">{{ checkInData().fuel_level }}%</span>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form class="space-y-6">
      <!-- Odometer -->
      <div class="card-premium p-6">
        <h3 class="font-bold text-text-primary mb-4">1. Kilometraje Actual</h3>
        <ion-item>
          <ion-label position="stacked">Kilometraje *</ion-label>
          <ion-input
            type="number"
            [value]="odometer()"
            (ionInput)="odometer.set($any($event.target).value)"
            placeholder="Ej: 45250"
            required
          ></ion-input>
        </ion-item>
        <div *ngIf="odometerDifference() !== null" class="mt-3 p-3 bg-surface-secondary rounded-lg">
          <div class="flex justify-between items-center">
            <span class="text-sm text-text-secondary">Kil√≥metros recorridos:</span>
            <span class="font-bold text-cta-default">{{ odometerDifference() | number }} km</span>
          </div>
        </div>
      </div>

      <!-- Fuel Level -->
      <div class="card-premium p-6">
        <h3 class="font-bold text-text-primary mb-4">2. Nivel de Combustible</h3>
        <div class="px-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-text-secondary">Nivel:</span>
            <span class="font-bold text-cta-default">{{ fuelLevelPercentage }}</span>
          </div>
          <ion-range
            [value]="fuelLevel()"
            (ionChange)="fuelLevel.set($any($event.detail.value))"
            min="0"
            max="100"
            step="10"
            snaps="true"
            ticks="true"
            color="primary"
          >
            <ion-label slot="start">0%</ion-label>
            <ion-label slot="end">100%</ion-label>
          </ion-range>
        </div>
        <div
          *ngIf="fuelDifference() !== null"
          class="mt-3 p-3 rounded-lg"
          [class.bg-success-light/10]="fuelDifference()! >= 0"
          [class.bg-error-50]="fuelDifference()! < 0">
          <div class="flex justify-between items-center">
            <span class="text-sm">Diferencia de combustible:</span>
            <span
              class="font-bold"
              [class.text-success-light]="fuelDifference()! >= 0"
              [class.text-error-700]="fuelDifference()! < 0"
            >
              {{ fuelDifference()! > 0 ? '+' : '' }}{{ fuelDifference() }}%
            </span>
          </div>
        </div>
      </div>

      <!-- Photos -->
      <div class="card-premium p-6">
        <h3 class="font-bold text-text-primary mb-4">3. Fotos del Auto (m√≠nimo 4) *</h3>
        <p class="text-sm text-text-secondary mb-4">
          Toma fotos del estado actual del auto, especialmente de cualquier da√±o nuevo
        </p>
        <input
          type="file"
          #fileInput
          accept="image/*"
          multiple
          (change)="onFilesSelected($event)"
          style="display: none"
        />
        <button
          type="button"
          (click)="fileInput.click()"
          class="w-full px-4 py-3 border-2 border-dashed border-border-default rounded-lg hover:border-cta-default transition-colors"
        >
          <ion-icon name="camera" class="text-2xl text-cta-default"></ion-icon>
          <p class="text-sm text-text-secondary mt-2">Click para subir fotos</p>
        </button>
        <div *ngIf="uploadedPhotos().length > 0" class="grid grid-cols-2 gap-4 mt-4">
          <div *ngFor="let photo of uploadedPhotos(); let i = index" class="relative">
            <img [src]="photo" alt="Foto {{ i + 1 }}" class="w-full h-32 object-cover rounded-lg" />
          </div>
        </div>
        <p class="text-sm text-text-secondary mt-2">
          {{ uploadedPhotos().length }} foto(s) subida(s)
        </p>
      </div>

      <!-- Damages Toggle -->
      <div class="card-premium p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-text-primary">4. ¬øHay da√±os nuevos?</h3>
          <ion-toggle
            [checked]="hasDamages()"
            (ionChange)="toggleDamages()"
            color="danger"
          ></ion-toggle>
        </div>

        <!-- Damages Form (if hasDamages) -->
        <div *ngIf="hasDamages()" class="space-y-4 pt-4 border-t border-border-default">
          <div class="bg-warning-50 border border-warning-200 rounded-lg p-3">
            <p class="text-sm text-warning-800">
              ‚ö†Ô∏è El monto de da√±os se deducir√° del dep√≥sito de garant√≠a ($250 USD) del locatario.
            </p>
          </div>

          <ion-item>
            <ion-label position="stacked">Monto del da√±o (USD) *</ion-label>
            <ion-input
              type="number"
              [value]="damageAmount()"
              (ionInput)="damageAmount.set($any($event.target).value)"
              placeholder="Ej: 50"
              min="1"
              max="250"
              required
            ></ion-input>
            <ion-note slot="helper">M√°ximo: $250 USD</ion-note>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Descripci√≥n del da√±o *</ion-label>
            <ion-textarea
              [value]="damagesNotes()"
              (ionInput)="damagesNotes.set($any($event.target).value)"
              rows="4"
              placeholder="Describe el da√±o en detalle..."
              required
            ></ion-textarea>
          </ion-item>
        </div>

        <!-- No Damages (if !hasDamages) -->
        <div *ngIf="!hasDamages()" class="bg-success-light/10 border border-success-light/40 rounded-lg p-4 mt-4">
          <div class="flex items-center gap-2">
            <ion-icon name="checkmark-circle" class="text-success-light text-2xl"></ion-icon>
            <span class="text-sm text-success-light">El auto fue devuelto en buenas condiciones</span>
          </div>
        </div>
      </div>

      <!-- Signature -->
      <div class="card-premium p-6">
        <h3 class="font-bold text-text-primary mb-4">5. Firma Digital *</h3>
        <div class="border-2 border-dashed border-border-default rounded-lg p-4">
          <div class="bg-surface-raised border border-border-default rounded p-4 text-center">
            <p class="text-sm text-text-secondary">Firma digital (simulada)</p>
            <button
              type="button"
              (click)="signatureDataUrl.set('signature-placeholder')"
              class="mt-2 px-4 py-2 bg-cta-default text-cta-text rounded-lg"
            >
              {{ signatureDataUrl() ? '‚úì Firmado' : 'Firmar' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="card-premium p-6 bg-gradient-to-br from-cta-default/5 to-warning-light/5">
        <h3 class="font-bold text-text-primary mb-4">Resumen</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-text-secondary">Kil√≥metros recorridos:</span>
            <span class="font-semibold">{{ odometerDifference() || '---' }} km</span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">Diferencia de combustible:</span>
            <span
              class="font-semibold"
              [class.text-success-light]="fuelDifference()! >= 0"
              [class.text-error-600]="fuelDifference()! < 0"
            >
              {{
                fuelDifference() !== null
                  ? (fuelDifference()! > 0 ? '+' : '') + fuelDifference() + '%'
                  : '---'
              }}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">Da√±os reportados:</span>
            <span
              class="font-semibold"
              [class.text-error-600]="hasDamages()"
              [class.text-success-light]="!hasDamages()"
            >
              {{ hasDamages() ? 'S√≠ ($' + damageAmount() + ' USD)' : 'No' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex gap-4">
        <button
          type="button"
          (click)="cancel()"
          class="flex-1 px-6 py-3 rounded-xl border-2 border-border-default text-text-secondary font-semibold hover:bg-surface-secondary transition-all"
          [disabled]="submitting()"
        >
          Cancelar
        </button>
        <button
          type="button"
          (click)="submitCheckOut()"
          [disabled]="!canSubmit() || submitting()"
          class="flex-1 px-6 py-3 rounded-xl bg-cta-default text-cta-text-pure font-semibold hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <ion-spinner *ngIf="submitting()" name="crescent" class="mr-2"></ion-spinner>
          {{ submitting() ? 'Procesando...' : 'Completar Check-Out' }}
        </button>
      </div>
    </form>
  </div>
</ion-content>
