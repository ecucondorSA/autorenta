<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/bookings/owner"></ion-back-button>
    </ion-buttons>
    <ion-title>Check-Out del Auto</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <div *ngIf="loading()" class="text-center py-16">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p class="mt-4 text-text-secondary">Cargando reserva...</p>
  </div>

  <!-- Check-Out Form -->
  <div *ngIf="!loading() && booking()" class="max-w-2xl mx-auto">
    <!-- Booking Info Card -->
    <div class="card-premium p-6 mb-6">
      <h2 class="text-xl font-bold text-text-primary mb-4">Informaci√≥n de la Reserva</h2>

      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-text-secondary">Auto:</span>
          <span class="font-semibold">{{ booking()?.car?.title }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-text-secondary">Locatario:</span>
          <span class="font-semibold">{{ booking()?.renter_id || 'N/A' }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-text-secondary">Per√≠odo:</span>
          <span class="font-semibold">
            {{ booking()?.start_at | date: 'dd/MM/yyyy' }} -
            {{ booking()?.end_at | date: 'dd/MM/yyyy' }}
          </span>
        </div>
      </div>
    </div>

    <!-- Check-In Comparison Card -->
    <div *ngIf="checkInData()"
      class="bg-cta-default/10 border border-cta-default/40 rounded-xl p-4 mb-6">
      <h3 class="font-semibold text-cta-default mb-3">üìã Estado al Check-In</h3>
      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-cta-default">Kilometraje:</span>
          <span class="font-semibold text-cta-default">{{ checkInData().odometer_reading | number }}
            km</span>
        </div>
        <div class="flex justify-between">
          <span class="text-cta-default">Combustible:</span>
          <span class="font-semibold text-cta-default">{{ checkInData().fuel_level }}%</span>
        </div>
      </div>
    </div>

    <!-- Step 1: Inspection Uploader -->
    <div *ngIf="step() === 'inspection'" class="mb-8">
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <p class="text-sm text-blue-800">
          ‚ÑπÔ∏è <strong>Instrucciones:</strong> Realiza la inspecci√≥n final. Si hay da√±os nuevos,
          aseg√∫rate de tomar fotos claras como evidencia.
        </p>
      </div>

      <app-inspection-uploader [bookingId]="booking()!.id" [stage]="'check_out'"
        (inspectionCompleted)="onInspectionCompleted($event)"
        (inspectionCancelled)="cancel()"></app-inspection-uploader>
    </div>

    <!-- Step 2: Damage Claim -->
    <div *ngIf="step() === 'damages'" class="mb-8">
      <div class="card-premium p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-text-primary">¬øHay da√±os nuevos que reportar?</h3>
          <ion-toggle [checked]="hasDamages()" (ionChange)="toggleDamages()"
            color="danger"></ion-toggle>
        </div>

        <!-- Damages Form (if hasDamages) -->
        <div *ngIf="hasDamages()" class="space-y-4 pt-4 border-t border-border-default">
          <div class="bg-warning-bg border border-warning-border rounded-lg p-3">
            <p class="text-sm text-warning-strong">
              ‚ö†Ô∏è El monto de da√±os se deducir√° del dep√≥sito de garant√≠a ($250 USD) del locatario.
            </p>
          </div>

          <ion-item>
            <ion-label position="stacked">Monto del da√±o (USD) *</ion-label>
            <ion-input type="number" [value]="damageAmount()"
              (ionInput)="damageAmount.set($any($event.target).value)" placeholder="Ej: 50" min="1"
              max="250" required></ion-input>
            <ion-note slot="helper">M√°ximo: $250 USD</ion-note>
          </ion-item>

          <ion-item>
            <ion-label position="stacked">Descripci√≥n del da√±o *</ion-label>
            <ion-textarea [value]="damagesNotes()"
              (ionInput)="damagesNotes.set($any($event.target).value)" rows="4"
              placeholder="Describe el da√±o en detalle..." required></ion-textarea>
          </ion-item>
        </div>

        <!-- No Damages (if !hasDamages) -->
        <div *ngIf="!hasDamages()"
          class="bg-success-light/10 border border-success-light/40 rounded-lg p-4 mt-4">
          <div class="flex items-center gap-2">
            <ion-icon name="checkmark-circle" class="text-success-light text-2xl"></ion-icon>
            <span class="text-sm text-success-light">El auto fue devuelto en buenas
              condiciones</span>
          </div>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex gap-4 mt-6">
        <button type="button" (click)="step.set('inspection')"
          class="flex-1 px-6 py-3 rounded-xl border-2 border-border-default text-text-secondary font-semibold hover:bg-surface-secondary transition-all"
          [disabled]="submitting()">
          Volver a Fotos
        </button>
        <button type="button" (click)="submitCheckOut()"
          [disabled]="!canSubmitDamages() || submitting()"
          class="flex-1 px-6 py-3 rounded-xl bg-cta-default text-cta-text-pure font-semibold hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <ion-spinner *ngIf="submitting()" name="crescent" class="mr-2"></ion-spinner>
          {{ submitting() ? 'Procesando...' : 'Finalizar Check-Out' }}
        </button>
      </div>
    </div>
  </div>
</ion-content>
