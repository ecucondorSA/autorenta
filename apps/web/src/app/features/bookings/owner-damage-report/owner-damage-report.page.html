<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/bookings/owner"></ion-back-button>
    </ion-buttons>
    <ion-title>Reportar Daños</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <div *ngIf="loading()" class="text-center py-16">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p class="mt-4 text-charcoal-medium">Cargando reserva...</p>
  </div>

  <!-- Damage Report Form -->
  <div *ngIf="!loading() && booking()" class="max-w-2xl mx-auto">
    <!-- Booking Info Card -->
    <div class="card-premium p-6 mb-6">
      <h2 class="text-xl font-bold text-smoke-black mb-4">Información de la Reserva</h2>

      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-charcoal-medium">Auto:</span>
          <span class="font-semibold">{{ booking()?.car?.title }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-charcoal-medium">Locatario:</span>
          <span class="font-semibold">{{ booking()?.renter_id || 'N/A' }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-charcoal-medium">Período:</span>
          <span class="font-semibold">
            {{ booking()?.start_at | date:'dd/MM/yyyy' }} - {{ booking()?.end_at | date:'dd/MM/yyyy' }}
          </span>
        </div>
        <div class="flex justify-between">
          <span class="text-charcoal-medium">Depósito de garantía:</span>
          <span class="font-semibold text-accent-petrol">{{ maxFormattedAmount }}</span>
        </div>
      </div>
    </div>

    <!-- Important Notice -->
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
      <div class="flex items-start gap-3">
        <svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div>
          <h3 class="font-semibold text-amber-900 mb-1">Importante</h3>
          <p class="text-sm text-amber-800">
            El monto reportado será deducido del depósito de garantía del locatario (máximo {{ maxFormattedAmount }}).
            Asegurate de incluir fotos claras del daño y una descripción detallada.
            Una vez enviado, no podrás modificar este reporte.
          </p>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form class="space-y-6">
      <!-- Damage Description -->
      <div class="card-premium p-6">
        <h3 class="font-bold text-smoke-black mb-4">1. Descripción del Daño *</h3>
        <ion-item>
          <ion-label position="stacked">Describe el daño en detalle</ion-label>
          <ion-textarea
            [value]="damageDescription()"
            (ionInput)="damageDescription.set($any($event.target).value)"
            rows="6"
            placeholder="Ej: Rayón profundo de 15cm en la puerta del conductor, cerca de la manija. El rayón atraviesa la pintura y llega hasta el metal."
            required
          ></ion-textarea>
          <ion-note slot="helper">
            {{ descriptionCharCount() }} / 1000 caracteres (mínimo 20)
          </ion-note>
        </ion-item>
        <div *ngIf="descriptionCharCount() > 0 && descriptionCharCount() < 20" class="mt-2 p-3 bg-red-50 rounded-lg">
          <p class="text-sm text-red-800">
            ⚠️ La descripción debe tener al menos 20 caracteres para ser válida
          </p>
        </div>
      </div>

      <!-- Damage Amount -->
      <div class="card-premium p-6">
        <h3 class="font-bold text-smoke-black mb-4">2. Monto del Daño (USD) *</h3>
        <ion-item>
          <ion-label position="stacked">Costo estimado de reparación</ion-label>
          <ion-input
            type="number"
            [value]="damageAmount()"
            (ionInput)="damageAmount.set($any($event.target).value)"
            placeholder="Ej: 150"
            min="1"
            [max]="maxDepositAmount()"
            required
          ></ion-input>
          <ion-note slot="helper">Máximo: {{ maxFormattedAmount }}</ion-note>
        </ion-item>
        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
          <div class="flex justify-between items-center">
            <span class="text-sm text-blue-700">Monto a deducir del depósito:</span>
            <span class="font-bold text-blue-900">{{ formattedAmount }}</span>
          </div>
        </div>
        <div *ngIf="damageAmount() > maxDepositAmount()" class="mt-2 p-3 bg-red-50 rounded-lg">
          <p class="text-sm text-red-800">
            ⚠️ El monto no puede exceder el depósito de garantía ({{ maxFormattedAmount }})
          </p>
        </div>
      </div>

      <!-- Photos Upload -->
      <div class="card-premium p-6">
        <h3 class="font-bold text-smoke-black mb-4">3. Fotos de Evidencia (1-10 fotos) *</h3>
        <p class="text-sm text-charcoal-medium mb-4">
          Sube fotos claras del daño. Las fotos deben mostrar claramente el daño y su ubicación en el vehículo.
        </p>

        <input
          type="file"
          #fileInput
          accept="image/*"
          multiple
          (change)="onFilesSelected($event)"
          style="display: none"
        />

        <button
          type="button"
          (click)="fileInput.click()"
          [disabled]="uploadedFiles().length >= 10"
          class="w-full px-4 py-3 border-2 border-dashed border-pearl-gray rounded-lg hover:border-accent-petrol transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <ion-icon name="camera" class="text-2xl text-accent-petrol"></ion-icon>
          <p class="text-sm text-charcoal-medium mt-2">
            {{ uploadedFiles().length >= 10 ? 'Límite de 10 fotos alcanzado' : 'Click para subir fotos' }}
          </p>
        </button>

        <!-- Photo Previews -->
        <div *ngIf="uploadedPreviews().length > 0" class="mt-4">
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            <div *ngFor="let preview of uploadedPreviews(); let i = index" class="relative">
              <img [src]="preview" alt="Foto {{i+1}}" class="w-full h-32 object-cover rounded-lg" />
              <button
                type="button"
                (click)="removeFile(i)"
                class="absolute -top-2 -right-2 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-700 transition-colors"
              >
                <ion-icon name="close" class="text-lg"></ion-icon>
              </button>
            </div>
          </div>
          <p class="text-sm text-charcoal-medium mt-3">
            {{ uploadedFiles().length }} foto(s) subida(s) • Máx 5MB por foto
          </p>
        </div>

        <div *ngIf="uploadedFiles().length === 0" class="mt-4 p-3 bg-amber-50 rounded-lg">
          <p class="text-sm text-amber-800">
            ⚠️ Debes subir al menos 1 foto para enviar el reporte
          </p>
        </div>
      </div>

      <!-- Summary -->
      <div class="card-premium p-6 bg-gradient-to-br from-accent-petrol/5 to-accent-warm/5">
        <h3 class="font-bold text-smoke-black mb-4">Resumen del Reporte</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-charcoal-medium">Descripción:</span>
            <span class="font-semibold" [class.text-red-600]="descriptionCharCount() < 20" [class.text-green-600]="descriptionCharCount() >= 20">
              {{ descriptionCharCount() >= 20 ? '✓ Completa' : '✗ Incompleta' }}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-charcoal-medium">Monto del daño:</span>
            <span class="font-semibold" [class.text-red-600]="damageAmount() <= 0 || damageAmount() > maxDepositAmount()" [class.text-green-600]="damageAmount() > 0 && damageAmount() <= maxDepositAmount()">
              {{ formattedAmount }}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-charcoal-medium">Fotos de evidencia:</span>
            <span class="font-semibold" [class.text-red-600]="uploadedFiles().length === 0" [class.text-green-600]="uploadedFiles().length > 0">
              {{ uploadedFiles().length }} foto(s)
            </span>
          </div>
        </div>

        <div class="mt-4 p-3 rounded-lg" [class.bg-green-50]="canSubmit()" [class.bg-gray-50]="!canSubmit()">
          <div class="flex items-center gap-2">
            <ion-icon
              [name]="canSubmit() ? 'checkmark-circle' : 'alert-circle'"
              [class.text-green-600]="canSubmit()"
              [class.text-gray-400]="!canSubmit()"
              class="text-xl"
            ></ion-icon>
            <span class="text-sm" [class.text-green-800]="canSubmit()" [class.text-gray-600]="!canSubmit()">
              {{ canSubmit() ? 'Listo para enviar' : 'Completa todos los campos requeridos' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex gap-4">
        <button
          type="button"
          (click)="cancel()"
          class="flex-1 px-6 py-3 rounded-xl border-2 border-pearl-gray text-charcoal-medium font-semibold hover:bg-sand-light transition-all"
          [disabled]="submitting()"
        >
          Cancelar
        </button>
        <button
          type="button"
          (click)="submitDamageReport()"
          [disabled]="!canSubmit() || submitting()"
          class="flex-1 px-6 py-3 rounded-xl bg-red-600 text-white-pure font-semibold hover:bg-red-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <ion-spinner *ngIf="submitting()" name="crescent" class="mr-2"></ion-spinner>
          {{ submitting() ? 'Enviando reporte...' : 'Enviar Reporte de Daños' }}
        </button>
      </div>

      <!-- Disclaimer -->
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
        <p class="text-xs text-gray-600">
          Al enviar este reporte, confirmas que la información proporcionada es precisa y que el daño ocurrió durante el período de alquiler.
          El locatario será notificado inmediatamente y podrá ver el reporte en el detalle de la reserva.
        </p>
      </div>
    </form>
  </div>
</ion-content>
