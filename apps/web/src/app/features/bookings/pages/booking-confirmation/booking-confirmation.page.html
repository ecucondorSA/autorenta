<div class="confirmation-container">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p class="loading-text font-luxury">Verificando el pago...</p>
    </div>
  }

  <!-- Success State -->
  @if (!isLoading() && isSuccess()) {
    <div class="confirmation-content success-state">
      <!-- Success Icon with Animation -->
      <div class="status-icon-wrapper success">
        <div class="checkmark-circle">
          <svg class="checkmark" viewBox="0 0 52 52">
            <circle class="checkmark-circle-bg" cx="26" cy="26" r="25" fill="none" />
            <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
          </svg>
        </div>
      </div>
      <!-- Success Message -->
      <h1 class="status-title success font-bold font-satoshi">{{ confirmationMessage() }}</h1>
      <p class="status-subtitle">
        Tu reserva ha sido confirmada exitosamente. Recibirás un correo con los detalles.
      </p>
      <!-- Payment Details Card -->
      <div class="details-card">
        <h2 class="card-title font-bold font-satoshi font-luxury">Detalles del Pago</h2>
        <div class="detail-row">
          <span class="detail-label">Proveedor</span>
          <span class="detail-value">{{ providerDisplayName() }}</span>
        </div>
        @if (paymentReferenceId()) {
          <div class="detail-row">
            <span class="detail-label">ID de Referencia</span>
            <span class="detail-value code">{{ paymentReferenceId() }}</span>
          </div>
        }
        @if (booking()) {
          <div class="detail-row">
            <span class="detail-label">Monto Total</span>
            <span class="detail-value amount">
              {{ formatCurrency(bookingTotalUsd(), 'USD') }}
            </span>
          </div>
        }
        <div class="detail-row">
          <span class="detail-label">Fecha</span>
          <span class="detail-value">{{ formatDate(confirmedAt()) }}</span>
        </div>
      </div>
      <!-- Booking Summary Card -->
      @if (booking()) {
        <div class="details-card">
          <h2 class="card-title font-bold font-satoshi">Resumen de la Reserva</h2>
          <div class="detail-row">
            <span class="detail-label">ID de Reserva</span>
            <span class="detail-value code">{{ booking()!.id }}</span>
          </div>
          @if (booking()!.car) {
            <div class="detail-row">
              <span class="detail-label">Vehículo</span>
              <span class="detail-value">{{ booking()!.car!.brand }} {{ booking()!.car!.model }}</span>
            </div>
          }
          <div class="detail-row">
            <span class="detail-label">Desde</span>
            <span class="detail-value">{{ $any(booking()!['start_date']) | date: 'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Hasta</span>
            <span class="detail-value">{{ $any(booking()!['end_date']) | date: 'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Estado</span>
            <span class="status-badge confirmed">Confirmada</span>
          </div>
        </div>
      }
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn-primary" (click)="viewBookingDetails()">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
            />
          </svg>
          Ver Detalles de la Reserva
        </button>
        <button class="btn-secondary" (click)="downloadReceipt()" [disabled]="downloadingReceipt()">
          @if (downloadingReceipt()) {
            <div
              class="btn-icon w-5 h-5 border-2 border-gray-400 border-t-transparent rounded-full animate-spin"
            ></div>
            <span>Generando PDF...</span>
          } @else {
            <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <span>Descargar Recibo PDF</span>
          }
        </button>
        <button class="btn-link" (click)="goToMyBookings()">Ver Todas mis Reservas</button>
      </div>
    </div>
  }

  <!-- Pending State -->
  @if (!isLoading() && isPending()) {
    <div class="confirmation-content pending-state">
      <!-- Pending Icon -->
      <div class="status-icon-wrapper pending">
        <svg class="pending-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
      </div>
      <!-- Pending Message -->
      <h1 class="status-title pending font-bold font-satoshi">{{ confirmationMessage() }}</h1>
      <p class="status-subtitle">
        Tu pago está siendo procesado. Esto puede tomar unos minutos. Te notificaremos cuando se
        confirme.
      </p>
      <!-- Payment Details Card -->
      <div class="details-card">
        <h2 class="card-title font-bold font-satoshi font-luxury">Información del Pago</h2>
        <div class="detail-row">
          <span class="detail-label">Proveedor</span>
          <span class="detail-value">{{ providerDisplayName() }}</span>
        </div>
        @if (paymentReferenceId()) {
          <div class="detail-row">
            <span class="detail-label">ID de Referencia</span>
            <span class="detail-value code">{{ paymentReferenceId() }}</span>
          </div>
        }
        <div class="detail-row">
          <span class="detail-label">Estado</span>
          <span class="status-badge pending">Pendiente</span>
        </div>
      </div>
      <!-- Info Banner -->
      <div class="info-banner pending">
        <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <div class="info-text">
          <p class="font-medium">¿Qué sigue?</p>
          <ul class="info-list">
            <li>Verificaremos tu pago con {{ providerDisplayName() }}</li>
            <li>Recibirás un email cuando se confirme</li>
            <li>Puedes cerrar esta página</li>
          </ul>
        </div>
      </div>
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn-secondary" (click)="retry()">
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          Actualizar Estado
        </button>
        <button class="btn-link" (click)="goToHome()">Volver al Inicio</button>
      </div>
    </div>
  }

  <!-- Error State -->
  @if (!isLoading() && isError()) {
    <div class="confirmation-content error-state">
      <!-- Error Icon -->
      <div class="status-icon-wrapper error">
        <svg class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
      </div>
      <!-- Error Message -->
      <h1 class="status-title error font-bold font-satoshi">{{ confirmationMessage() }}</h1>
      <p class="status-subtitle">
        {{
          errorMessage() || 'Hubo un problema al procesar tu pago. Por favor intenta nuevamente.'
        }}
      </p>
      <!-- Error Details Card -->
      <div class="details-card error">
        <h2 class="card-title font-bold font-satoshi">¿Qué puedes hacer?</h2>
        <ul class="error-actions-list">
          <li>Verifica tu método de pago</li>
          <li>Asegúrate de tener fondos suficientes</li>
          <li>Intenta con otro proveedor de pago</li>
          <li>Contacta a soporte si el problema persiste</li>
        </ul>
      </div>
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button
          class="btn-primary"
          (click)="router.navigate(['/bookings', bookingId(), 'checkout'])"
        >
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          Reintentar Pago
        </button>
        <button class="btn-secondary" (click)="goToHome()">Volver al Inicio</button>
        <button class="btn-link" (click)="retry()">Actualizar Estado</button>
      </div>
    </div>
  }

  <!-- Help Section (Always visible except on loading) -->
  @if (!isLoading()) {
    <div class="help-section">
      <p class="help-text">
        ¿Necesitas ayuda?
        <a href="mailto:soporte@autorentar.com" class="help-link">Contacta a Soporte</a>
      </p>
    </div>
  }
</div>
