<div
  class="payment-page min-h-screen bg-zinc-950 text-zinc-100 font-sans selection:bg-brand-primary selection:text-black"
>
  <!-- Secure Header -->
  <header
    class="bg-zinc-900/80 backdrop-blur-md border-b border-white/5 py-4 sticky top-0 z-50 supports-[backdrop-filter]:bg-zinc-900/60"
  >
    <div class="max-w-7xl mx-auto px-4 lg:px-8 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a
          routerLink="/cars/list"
          class="p-2 -ml-2 text-zinc-400 hover:text-white hover:bg-white/10 rounded-full transition-all"
          title="Volver al catálogo"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </a>
        <h1 class="text-lg font-bold text-white font-satoshi tracking-tight">Solicitud de Uso Compartido</h1>
      </div>
      
      <!-- Trust Indicator -->
      <div class="hidden sm:flex items-center gap-2 text-xs font-medium text-zinc-400 bg-white/5 px-3 py-1.5 rounded-full border border-white/5">
        <svg class="w-3.5 h-3.5 text-brand-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        Validación Segura
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 lg:px-8 py-8 lg:py-12">
    <!-- Loading State -->
    @if (loading()) {
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12">
        <div class="lg:col-span-8 space-y-8">
          <app-skeleton-loader type="card" [height]="200"></app-skeleton-loader>
          <app-skeleton-loader type="rect" [height]="300"></app-skeleton-loader>
        </div>
        <div class="lg:col-span-4">
          <app-skeleton-loader type="card" [height]="400"></app-skeleton-loader>
        </div>
      </div>
    }

    <!-- Error State -->
    @if (error(); as errorMsg) {
      <div class="max-w-xl mx-auto text-center py-12">
        <div class="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">Algo salió mal</h3>
        <p class="text-zinc-400 mb-8">{{ errorMsg }}</p>
        <a routerLink="/cars/list" class="btn-primary inline-flex items-center gap-2">
          Volver al catálogo
        </a>
      </div>
    }

    <!-- Checkout Grid -->
    @if (!loading() && !error() && car()) {
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-16 items-start">
        
        <!-- LEFT COLUMN: Steps -->
        <div class="lg:col-span-7 xl:col-span-8 space-y-10">
          
          <!-- STEP 1: Trip Summary (Interactive) -->
          <section class="space-y-4">
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-bold text-white font-satoshi flex items-center gap-3">
                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-zinc-800 text-zinc-400 text-sm font-bold border border-white/5">1</span>
                Tu viaje
              </h2>
              @if (!isEditingDates()) {
                <button (click)="toggleEditDates()" class="text-sm text-brand-primary font-bold hover:text-brand-primary/80 transition-colors">Editar fechas</button>
              }
            </div>
            
            <div class="bg-zinc-900/50 border border-white/5 rounded-2xl p-5 hover:border-white/10 transition-colors relative">
              <div class="flex flex-col md:flex-row gap-5">
                <!-- Car Thumb (Clickable) -->
                <button 
                  (click)="openPhotoGallery()"
                  class="w-full md:w-32 h-48 md:h-32 rounded-xl overflow-hidden bg-zinc-950 flex-shrink-0 border border-white/5 relative group cursor-zoom-in shadow-lg">
                  <img [src]="car()?.photos?.[0]?.url || '/assets/images/car-placeholder.svg'" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" alt="Car" loading="lazy">
                  <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <span class="text-xs font-bold text-white bg-black/60 px-2 py-1 rounded-full backdrop-blur-sm border border-white/10">Ver fotos</span>
                  </div>
                </button>
                
                <!-- Info or Date Picker -->
                <div class="flex-1 min-w-0 relative">
                  @if (isEditingDates()) {
                    <!-- HIGH CONTRAST DATE PICKER ISLAND -->
                    <div class="absolute top-0 left-0 w-full z-20 animate-fade-in-up">
                      <div class="bg-white text-zinc-900 rounded-xl shadow-2xl border border-zinc-200 p-4 ring-4 ring-black/20">
                        <div class="flex justify-between items-center mb-4">
                          <h4 class="font-bold text-zinc-900 text-sm">Selecciona fechas</h4>
                          <button (click)="toggleEditDates()" class="p-1 rounded-full hover:bg-zinc-100 text-zinc-500">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                          </button>
                        </div>
                        
                        <!-- The picker handles its own logic, we just provide the clean container -->
                        <app-date-range-picker 
                          [compact]="false" 
                          [initialFrom]="bookingInput()?.startDate | date:'yyyy-MM-dd'"
                          [initialTo]="bookingInput()?.endDate | date:'yyyy-MM-dd'"
                          (rangeChange)="onDatesChanged($event)">
                        </app-date-range-picker>
                        
                        <div class="mt-4 pt-3 border-t border-zinc-100 flex justify-end">
                          <button (click)="toggleEditDates()" class="text-xs font-bold text-brand-primary uppercase tracking-wider hover:underline">Listo</button>
                        </div>
                      </div>
                    </div>
                    <!-- Overlay backdrop -->
                    <div class="fixed inset-0 bg-black/60 z-10 backdrop-blur-sm" (click)="toggleEditDates()"></div>
                  } @else {
                    <h3 class="text-xl font-bold text-white font-satoshi truncate">{{ car()?.brand }} {{ car()?.model }}</h3>
                    <p class="text-sm text-zinc-400 mb-4">{{ car()?.year }} • {{ car()?.transmission === 'automatic' ? 'Automático' : 'Manual' }}</p>
                    
                    <div class="flex flex-wrap gap-x-8 gap-y-4 text-sm bg-black/30 p-4 rounded-xl border border-white/5">
                      <div>
                        <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider mb-0.5">Retiro</p>
                        <p class="text-white font-bold font-mono">{{ bookingInput()?.startDate | date:'EEE d MMM, HH:mm' }}</p>
                      </div>
                      <div class="w-px bg-white/10 hidden sm:block"></div>
                      <div>
                        <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider mb-0.5">Devolución</p>
                        <p class="text-white font-bold font-mono">{{ bookingInput()?.endDate | date:'EEE d MMM, HH:mm' }}</p>
                      </div>
                    </div>
                  }
                </div>
              </div>
              
              <!-- Telemetry Badge (New) -->
              @if (car()?.has_telemetry) {
                <div class="absolute top-4 right-4">
                  <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 backdrop-blur-md shadow-lg">
                    <svg class="w-3 h-3 text-emerald-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <span class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider">GPS Protegido</span>
                  </div>
                </div>
              }
            </div>
          </section>

          <!-- STEP 2: Protection -->
          <section class="space-y-4">
            <h2 class="text-xl font-bold text-white font-satoshi flex items-center gap-3">
              <span class="flex items-center justify-center w-8 h-8 rounded-full bg-zinc-800 text-zinc-400 text-sm font-bold border border-white/5">2</span>
              Nivel de Protección
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <!-- Standard -->
              <button 
                type="button" 
                (click)="setCoverageUpgrade('standard')"
                class="relative p-5 rounded-2xl border transition-all text-left group"
                [class.bg-zinc-800]="coverageUpgrade() === 'standard'"
                [class.border-white]="coverageUpgrade() === 'standard'"
                [class.bg-zinc-900]="coverageUpgrade() !== 'standard'"
                [class.border-white-10]="coverageUpgrade() !== 'standard'"
                [class.opacity-60]="coverageUpgrade() !== 'standard'">
                
                <div class="text-sm font-bold text-white mb-1">Estándar</div>
                <div class="text-xs text-zinc-400 mb-3">Cobertura Esencial</div>
                <div class="text-lg font-mono font-bold text-white mb-1">USD 0</div>
                <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Deducible: ${{ riskSnapshot()?.deductibleUsd }}</div>
              </button>

              <!-- Premium -->
              <button 
                type="button" 
                (click)="setCoverageUpgrade('premium50')"
                class="relative p-5 rounded-2xl border transition-all text-left group"
                [class.bg-zinc-800]="coverageUpgrade() === 'premium50'"
                [class.border-brand-primary]="coverageUpgrade() === 'premium50'"
                [class.bg-zinc-900]="coverageUpgrade() !== 'premium50'"
                [class.border-white-10]="coverageUpgrade() !== 'premium50'"
                [class.opacity-80]="coverageUpgrade() !== 'premium50'">
                
                <div class="text-sm font-bold text-white mb-1">Premium</div>
                <div class="text-xs text-zinc-400 mb-3">Responsabilidad Reducida</div>
                <div class="text-lg font-mono font-bold text-brand-primary mb-1">+ ${{ rentalCostUsd() * 0.10 | number:'1.0-0' }}</div>
                <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Deducible: ${{ (riskSnapshot()?.deductibleUsd || 0) * 0.5 | number:'1.0-0' }}</div>
              </button>

              <!-- Zero -->
              <button 
                type="button" 
                (click)="setCoverageUpgrade('zero')"
                class="relative p-5 rounded-2xl border transition-all text-left group overflow-hidden"
                [class.bg-zinc-800]="coverageUpgrade() === 'zero'"
                [class.border-brand-primary]="coverageUpgrade() === 'zero'"
                [class.bg-zinc-900]="coverageUpgrade() !== 'zero'"
                [class.border-white-10]="coverageUpgrade() !== 'zero'">
                
                @if (coverageUpgrade() === 'zero') {
                  <div class="absolute inset-0 bg-brand-primary/5 pointer-events-none"></div>
                }
                
                <div class="flex justify-between items-start">
                  <div class="text-sm font-bold text-white mb-1">Zero Risk</div>
                  <span class="bg-brand-primary text-black text-[10px] font-bold px-1.5 py-0.5 rounded">POPULAR</span>
                </div>
                <div class="text-xs text-zinc-400 mb-3">Protección Patrimonial Total</div>
                <div class="text-lg font-mono font-bold text-brand-primary mb-1">+ ${{ rentalCostUsd() * 0.20 | number:'1.0-0' }}</div>
                <div class="text-[10px] text-zinc-500 uppercase tracking-wider font-bold">Deducible: $0</div>
              </button>
            </div>
          </section>

          <!-- STEP 3: Payment & Guarantee -->
          <section class="space-y-4">
            <h2 class="text-xl font-bold text-white font-satoshi flex items-center gap-3">
              <span class="flex items-center justify-center w-8 h-8 rounded-full bg-zinc-800 text-zinc-400 text-sm font-bold border border-white/5">3</span>
              Garantía y Pago
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <!-- Option A: Card Hold -->
              <button 
                (click)="setPaymentMode('card')"
                class="relative p-5 rounded-2xl border text-left transition-all group overflow-hidden"
                [class.bg-zinc-800]="paymentMode() === 'card'"
                [class.border-brand-primary]="paymentMode() === 'card'"
                [class.bg-zinc-900]="paymentMode() !== 'card'"
                [class.border-white-10]="paymentMode() !== 'card'">
                
                <div class="flex justify-between items-start mb-3">
                  <div class="p-2 bg-zinc-950 rounded-lg border border-white/10 group-hover:border-white/20 transition-colors">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                  </div>
                  @if (paymentMode() === 'card') { <div class="w-4 h-4 rounded-full bg-brand-primary shadow-[0_0_10px_#39FF14]"></div> }
                </div>
                
                <h3 class="font-bold text-white mb-1">Colateral Bancario</h3>
                <p class="text-xs text-zinc-400 mb-3 min-h-[2.5em]">Autorizas una retención temporal. <span class="text-brand-primary font-bold">Se libera íntegramente</span> al finalizar el uso.</p>
                
                <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-zinc-950 border border-white/10 text-[10px] text-zinc-400">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                  Fondo de Garantía: USD {{ riskSnapshot()?.holdEstimatedUsd | number:'1.0-0' }}
                </div>
              </button>
              
              <!-- Option B: Wallet / Subscription -->
              <button 
                (click)="setPaymentMode('wallet')"
                class="relative p-5 rounded-2xl border text-left transition-all group overflow-hidden"
                [class.bg-zinc-800]="paymentMode() === 'wallet'"
                [class.border-emerald-500]="paymentMode() === 'wallet'"
                [class.bg-zinc-900]="paymentMode() !== 'wallet'"
                [class.border-white-10]="paymentMode() !== 'wallet'">
                
                <div class="flex justify-between items-start mb-3">
                  <div class="p-2 bg-zinc-950 rounded-lg border border-white/10 group-hover:border-emerald-500/30 transition-colors">
                    <svg class="w-6 h-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                  </div>
                  @if (paymentMode() === 'wallet') { <div class="w-4 h-4 rounded-full bg-emerald-500 shadow-[0_0_10px_#10B981]"></div> }
                </div>
                
                <h3 class="font-bold text-white mb-1">Acceso Club Preferente</h3>
                <p class="text-xs text-zinc-400 mb-3 min-h-[2.5em]">Tu estatus de socio es tu aval. <span class="text-amber-500 font-bold">Libera tu liquidez</span> y evita bloqueos bancarios.</p>
                
                <div class="flex flex-wrap gap-2">
                  <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-zinc-950 border border-white/10 text-[10px]"
                    [class.text-emerald-400]="discountApplied()"
                    [class.text-zinc-400]="!discountApplied()">
                    <svg class="w-3 h-3" [class.text-emerald-500]="discountApplied()" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    {{ discountApplied() ? 'Confianza Certificada' : 'Garantía Estándar' }}
                  </div>
                  
                  @if (discountApplied()) {
                    <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-md bg-emerald-500/20 border border-emerald-500/30 text-[10px] text-emerald-300 font-bold uppercase tracking-wider">
                      Beneficio Club
                    </div>
                  }
                </div>
              </button>
            </div>

            <!-- Eligibility Warning (If subscriber but no discount) -->
            @if (subscriptionService.tier() && !discountApplied() && paymentMode() === 'wallet') {
              <div class="mb-6 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-xl flex items-start gap-3">
                <svg class="w-5 h-5 text-yellow-500 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <div>
                  <p class="text-xs font-bold text-yellow-200">Garantía reducida no disponible</p>
                  <p class="text-[11px] text-yellow-200/70">{{ eligibilityReason() }}</p>
                </div>
              </div>
            }

            <!-- Guarantee Explanation Box -->
            <div class="bg-zinc-900/80 border border-white/10 rounded-2xl p-6">
              
              <!-- MercadoPago Form -->
              @if (paymentMode() === 'card' && riskSnapshot() && fxSnapshot()) {
                <div class="mb-4 flex items-start gap-3 p-3 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                  <svg class="w-5 h-5 text-blue-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <div>
                    <p class="text-sm text-blue-200 font-medium">Estás autorizando un bloqueo temporal.</p>
                    <p class="text-xs text-blue-300/80 mt-1">El dinero no sale de tu cuenta a menos que haya un incidente. Se libera automáticamente al finalizar.</p>
                  </div>
                </div>

                <div class="mt-4">
                  <app-card-hold-panel
                    [riskSnapshot]="riskSnapshot()!"
                    [fxSnapshot]="fxSnapshot()!"
                    [userId]="currentUserId()"
                    [bookingId]="bookingId() || undefined"
                    [currentAuthorization]="currentAuthorization()"
                    (authorizationChange)="onAuthorizationChange($event)"
                  ></app-card-hold-panel>
                </div>
              }

              <!-- Wallet Info -->
              @if (paymentMode() === 'wallet') {
                <div class="mb-4 flex items-start gap-3 p-3 bg-amber-500/10 border border-amber-500/20 rounded-xl">
                  <svg class="w-5 h-5 text-amber-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                  <div>
                    <p class="text-sm text-amber-200 font-medium">Estás usando tu saldo para elevar tu nivel de confianza.</p>
                    <p class="text-xs text-amber-300/80 mt-1">Esta inversión anual desbloquea <strong>alquileres sin depósito</strong> y acceso prioritario.</p>
                  </div>
                </div>

                <div class="mt-6 pt-6 border-t border-white/5">
                  <div class="flex justify-between items-center bg-zinc-950 p-4 rounded-xl border border-white/5 mb-4">
                    <span class="text-zinc-400 text-sm">Tu saldo disponible</span>
                    <span class="text-brand-primary font-mono font-bold">USD {{ walletAvailableBalanceUsd() | number:'1.2-2' }}</span>
                  </div>
                  
                  @if (!walletHasSufficientFunds()) {
                    <div class="space-y-4">
                      <div class="p-3 bg-red-500/10 border border-red-500/20 rounded-xl text-red-400 text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Capital insuficiente para activar membresía.
                      </div>
                      
                      <a routerLink="/wallet" class="w-full py-3 bg-zinc-800 hover:bg-zinc-700 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-colors border border-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        Cargar Saldo en Wallet
                      </a>
                    </div>
                  } @else {
                    <div class="text-green-500 text-sm flex items-center gap-2">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                      Saldo suficiente para activar membresía.
                    </div>
                  }
                </div>
              }
            </div>
          </section>

          <!-- Message to Host -->
          <section>
            <label class="block text-sm font-bold text-zinc-400 mb-2">Mensaje al anfitrión (Opcional)</label>
            <textarea 
              [(ngModel)]="messageToHost" 
              class="w-full bg-zinc-900 border border-white/10 rounded-xl p-4 text-white placeholder-zinc-600 focus:outline-none focus:border-brand-primary transition-colors resize-none"
              rows="3"
              placeholder="Hola! Viajo con mi familia por el fin de semana..."></textarea>
          </section>

        </div>

        <!-- RIGHT COLUMN: Sticky Summary -->
        <div class="lg:col-span-5 xl:col-span-4 order-first lg:order-last">
          <div class="sticky top-28 space-y-4">
            <div class="bg-zinc-900 border border-white/10 rounded-3xl p-6 shadow-2xl relative overflow-hidden">
              <!-- Glow Effect -->
              <div class="absolute top-0 right-0 w-64 h-64 bg-brand-primary/5 blur-3xl pointer-events-none rounded-full -mr-32 -mt-32"></div>

              <h3 class="text-lg font-bold text-white font-satoshi mb-6">Resumen de inversión</h3>

              <div class="space-y-3 mb-6">
                <div class="flex justify-between text-sm text-zinc-400">
                  <span>Mantenimiento ({{ rentalDays() }} días)</span>
                  <span class="text-white font-mono">USD {{ rentalCostUsd() | number:'1.2-2' }}</span>
                </div>
                
                @if (coverageUpgradeCostUsd() > 0) {
                  <div class="flex justify-between text-sm text-brand-primary">
                    <span>Upgrade de Protección {{ getCoverageName(coverageUpgrade()) }}</span>
                    <span class="font-mono">USD {{ coverageUpgradeCostUsd() | number:'1.2-2' }}</span>
                  </div>
                }

                <div class="h-px bg-white/10 my-2"></div>

                <div class="flex justify-between items-baseline">
                  <span class="text-base font-bold text-white">Inversión total del viaje</span>
                  <span class="text-2xl font-black text-brand-primary font-satoshi">USD {{ totalRentalUsd() | number:'1.2-2' }}</span>
                </div>
                <p class="text-xs text-zinc-500 text-right mt-1">Se acredita al finalizar el uso</p>
              </div>

              <!-- Terms Checkbox -->
              <div class="mb-6">
                <label class="flex items-start gap-3 cursor-pointer group">
                  <div class="relative flex items-center">
                    <input 
                      type="checkbox" 
                      [checked]="termsAccepted()" 
                      (change)="termsAccepted.set($any($event.target).checked)"
                      class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-white/20 bg-zinc-950 checked:border-brand-primary checked:bg-brand-primary transition-all" />
                    <svg class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-black opacity-0 peer-checked:opacity-100 transition-opacity" viewBox="0 0 14 14" fill="none">
                      <path d="M11.6666 3.5L5.24992 9.91667L2.33325 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <span class="text-xs text-zinc-400 group-hover:text-zinc-300 transition-colors">
                    Acepto los <a href="#" class="underline text-zinc-300 hover:text-brand-primary">Términos de Comodato</a> y la Política de Privacidad.
                  </span>
                </label>
              </div>

              <!-- Primary Action -->
              <button 
                (click)="submitRequest()"
                [disabled]="processingPayment() || !termsAccepted() || (paymentMode() === 'card' && currentAuthorization()?.status !== 'authorized')"
                class="w-full py-4 bg-brand-primary text-black font-black text-lg rounded-xl hover:bg-brand-primary/90 active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-brand-primary/20 flex items-center justify-center gap-2">
                @if (processingPayment()) {
                  <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                  Procesando...
                } @else {
                  Confirmar Solicitud
                }
              </button>
              
              @if (paymentMode() === 'card' && currentAuthorization()?.status !== 'authorized') {
                <p class="text-xs text-center text-yellow-500 mt-3 font-medium animate-pulse">
                  ⚠️ Completa la garantía con tarjeta para continuar
                </p>
              }
            </div>
            
            <!-- Security Note -->
            <div class="flex items-center justify-center gap-2 text-[10px] text-zinc-500 uppercase tracking-widest font-bold">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              Datos encriptados
            </div>
          </div>
        </div>

      </div>
    }
  </main>
</div>