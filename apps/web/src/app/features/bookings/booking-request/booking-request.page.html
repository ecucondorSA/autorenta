<div
  class="payment-page min-h-screen bg-zinc-950 text-zinc-100 font-sans selection:bg-brand-primary selection:text-black"
>
  <!-- Secure Header with Breadcrumbs -->
  <header
    class="bg-zinc-900/80 backdrop-blur-md border-b border-white/5 py-3 sticky top-0 z-50 supports-[backdrop-filter]:bg-zinc-900/60"
  >
    <div class="max-w-7xl mx-auto px-4 lg:px-8">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <button
            (click)="goBack()"
            class="p-2 -ml-2 text-zinc-400 hover:text-white hover:bg-white/10 rounded-full transition-all focus:outline-none focus:ring-2 focus:ring-brand-primary/50"
            aria-label="Volver atrás"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"
              />
            </svg>
          </button>
          
          <div class="flex flex-col">
            <h1 class="text-base font-bold text-white font-satoshi tracking-tight leading-tight">
              Solicitud de Reserva
            </h1>
            <!-- Breadcrumbs -->
            <nav class="hidden sm:flex items-center gap-2 text-xs text-zinc-500" aria-label="Breadcrumb">
              <span>Catálogo</span>
              <svg class="w-3 h-3 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <span>{{ car()?.brand }} {{ car()?.model }}</span>
              <svg class="w-3 h-3 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
              <span class="text-zinc-300">Checkout</span>
            </nav>
          </div>
        </div>

        <!-- Trust Indicator -->
        <div
          class="flex items-center gap-2 text-xs font-medium text-zinc-400 bg-white/5 px-3 py-1.5 rounded-full border border-white/5"
        >
          <svg
            class="w-3.5 h-3.5 text-brand-primary"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
            />
          </svg>
          <span class="hidden sm:inline">Pago Seguro</span>
          <span class="sm:hidden">Seguro</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 lg:px-8 py-6 lg:py-10">
    <!-- Loading State -->
    @if (loading()) {
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 animate-pulse">
        <div class="lg:col-span-8 space-y-8">
          <app-skeleton-loader type="card" [height]="200"></app-skeleton-loader>
          <app-skeleton-loader type="rect" [height]="300"></app-skeleton-loader>
        </div>
        <div class="lg:col-span-4">
          <app-skeleton-loader type="card" [height]="400"></app-skeleton-loader>
        </div>
      </div>
    }

    <!-- Error State -->
    @if (error(); as errorMsg) {
      <div class="max-w-xl mx-auto text-center py-12">
        <div
          class="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6"
        >
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
          </svg>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">No pudimos cargar la reserva</h3>
        <p class="text-zinc-400 mb-8">{{ errorMsg }}</p>
        <button (click)="goBack()" class="btn-primary inline-flex items-center gap-2 px-6 py-3 rounded-full font-bold">
          Volver al catálogo
        </button>
      </div>
    }

    <!-- Checkout Grid -->
    @if (!loading() && !error() && car()) {
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 items-start">
        <!-- LEFT COLUMN: Steps -->
        <div class="lg:col-span-7 xl:col-span-8 space-y-8">
          
          <!-- STEP 1: Trip Summary (Enhanced UX) -->
          <section class="space-y-4">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-bold text-white font-satoshi flex items-center gap-3">
                <span
                  class="flex items-center justify-center w-7 h-7 rounded-full bg-brand-primary text-black text-sm font-bold shadow-lg shadow-brand-primary/20"
                  >1</span
                >
                Tu viaje
              </h2>
            </div>

            <div
              class="bg-zinc-900 border border-white/10 rounded-2xl overflow-hidden transition-all hover:border-white/20"
            >
              <!-- Car & Date Info -->
              <div class="p-5 flex flex-col sm:flex-row gap-5">
                <!-- Car Thumb -->
                <button
                  (click)="openPhotoGallery()"
                  class="w-full sm:w-32 h-48 sm:h-32 rounded-xl overflow-hidden bg-zinc-950 flex-shrink-0 border border-white/5 relative group cursor-zoom-in"
                  aria-label="Ver fotos del auto"
                >
                  <img
                    [src]="car()?.photos?.[0]?.url || '/assets/images/car-placeholder.svg'"
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                    [alt]="car()?.title || 'Vehículo'"
                    loading="lazy"
                  />
                  <div
                    class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"
                  >
                    <span
                      class="text-xs font-bold text-white bg-black/60 px-2 py-1 rounded-full backdrop-blur-sm border border-white/10"
                      >Ver fotos</span
                    >
                  </div>
                </button>

                <!-- Details & Date Actions -->
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <h3 class="text-lg font-bold text-white font-satoshi truncate">
                        {{ car()?.brand }} {{ car()?.model }}
                      </h3>
                      <p class="text-sm text-zinc-400">
                        {{ car()?.year }} •
                        {{ car()?.transmission === 'automatico' ? 'Automático' : 'Manual' }}
                      </p>
                    </div>
                    @if (car()?.has_telemetry) {
                      <div class="hidden sm:block">
                        <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-[10px] font-bold text-emerald-400 uppercase tracking-wider">
                          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                          Verificado
                        </span>
                      </div>
                    }
                  </div>

                  <!-- Date Selection Display -->
                  <div class="bg-black/40 rounded-xl p-3 border border-white/5 flex flex-wrap items-center justify-between gap-4 mt-2">
                    <div class="flex items-center gap-4 text-sm">
                      <div>
                        <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider mb-0.5">Inicio</p>
                        <p class="text-white font-medium">{{ bookingInput()?.startDate | date: 'EEE d MMM, HH:mm' }}</p>
                      </div>
                      <div class="w-px h-8 bg-white/10"></div>
                      <div>
                        <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-wider mb-0.5">Fin</p>
                        <p class="text-white font-medium">{{ bookingInput()?.endDate | date: 'EEE d MMM, HH:mm' }}</p>
                      </div>
                    </div>
                    
                    <button 
                      (click)="toggleEditDates()"
                      class="text-xs font-bold text-brand-primary hover:text-brand-primary/80 transition-colors px-3 py-1.5 rounded-lg hover:bg-brand-primary/10"
                    >
                      Cambiar
                    </button>
                  </div>
                </div>
              </div>

              <!-- Date Picker Modal/Inline Area -->
              @if (isEditingDates()) {
                <div class="border-t border-white/10 bg-zinc-950 p-4 animate-slide-down">
                  <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-bold text-white">Seleccionar nuevas fechas</h4>
                    <button (click)="toggleEditDates()" class="text-zinc-400 hover:text-white">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  
                  <div class="bg-white rounded-xl p-1 overflow-hidden">
                    <app-date-range-picker
                      [compact]="false"
                      [initialFrom]="bookingInput()?.startDate | date: 'yyyy-MM-dd'"
                      [initialTo]="bookingInput()?.endDate | date: 'yyyy-MM-dd'"
                      (rangeChange)="onDatesChanged($event)"
                    ></app-date-range-picker>
                  </div>
                  
                  <div class="mt-4 flex justify-end">
                    <button (click)="toggleEditDates()" class="btn-primary py-2 px-6 text-sm">
                      Confirmar Fechas
                    </button>
                  </div>
                </div>
              }
            </div>
          </section>

          <!-- STEP 2: Protection -->
          <section class="space-y-4">
            <h2 class="text-lg font-bold text-white font-satoshi flex items-center gap-3">
              <span
                class="flex items-center justify-center w-7 h-7 rounded-full bg-zinc-800 text-zinc-400 text-sm font-bold border border-white/5"
                >2</span
              >
              Nivel de Protección
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <!-- Standard -->
              <button
                type="button"
                (click)="setCoverageUpgrade('standard')"
                class="relative p-4 rounded-xl border transition-all text-left group hover:scale-[1.02]"
                [class.bg-zinc-800]="coverageUpgrade() === 'standard'"
                [class.border-white]="coverageUpgrade() === 'standard'"
                [class.ring-1]="coverageUpgrade() === 'standard'"
                [class.ring-white]="coverageUpgrade() === 'standard'"
                [class.bg-zinc-900]="coverageUpgrade() !== 'standard'"
                [class.border-white-10]="coverageUpgrade() !== 'standard'"
                [class.opacity-70]="coverageUpgrade() !== 'standard'"
              >
                <div class="text-sm font-bold text-white mb-1">Estándar</div>
                <div class="text-xs text-zinc-400 mb-3 min-h-[2.5em]">Cobertura esencial con deducible estándar.</div>
                <div class="text-base font-mono font-bold text-white mb-1">Incluido</div>
                <div class="text-[10px] text-zinc-500 uppercase tracking-wider border-t border-white/10 pt-2 mt-2">
                  Deducible: ${{ riskSnapshot()?.deductibleUsd }}
                </div>
              </button>

              <!-- Premium -->
              <button
                type="button"
                (click)="setCoverageUpgrade('premium50')"
                class="relative p-4 rounded-xl border transition-all text-left group hover:scale-[1.02]"
                [class.bg-zinc-800]="coverageUpgrade() === 'premium50'"
                [class.border-brand-primary]="coverageUpgrade() === 'premium50'"
                [class.ring-1]="coverageUpgrade() === 'premium50'"
                [class.ring-brand-primary]="coverageUpgrade() === 'premium50'"
                [class.bg-zinc-900]="coverageUpgrade() !== 'premium50'"
                [class.border-white-10]="coverageUpgrade() !== 'premium50'"
                [class.opacity-80]="coverageUpgrade() !== 'premium50'"
              >
                <div class="text-sm font-bold text-white mb-1">Premium</div>
                <div class="text-xs text-zinc-400 mb-3 min-h-[2.5em]">Reduce tu responsabilidad ante daños al 50%.</div>
                <div class="text-base font-mono font-bold text-brand-primary mb-1">
                  + ${{ rentalCostUsd() * 0.1 | number: '1.0-0' }}
                </div>
                <div class="text-[10px] text-zinc-500 uppercase tracking-wider border-t border-white/10 pt-2 mt-2">
                  Deducible: ${{ (riskSnapshot()?.deductibleUsd || 0) * 0.5 | number: '1.0-0' }}
                </div>
              </button>

              <!-- Zero -->
              <button
                type="button"
                (click)="setCoverageUpgrade('zero')"
                class="relative p-4 rounded-xl border transition-all text-left group overflow-hidden hover:scale-[1.02]"
                [class.bg-zinc-800]="coverageUpgrade() === 'zero'"
                [class.border-brand-primary]="coverageUpgrade() === 'zero'"
                [class.ring-1]="coverageUpgrade() === 'zero'"
                [class.ring-brand-primary]="coverageUpgrade() === 'zero'"
                [class.bg-zinc-900]="coverageUpgrade() !== 'zero'"
                [class.border-white-10]="coverageUpgrade() !== 'zero'"
              >
                @if (coverageUpgrade() === 'zero') {
                  <div class="absolute inset-0 bg-brand-primary/5 pointer-events-none"></div>
                }

                <div class="flex justify-between items-start">
                  <div class="text-sm font-bold text-white mb-1">Zero Risk</div>
                  <span
                    class="bg-brand-primary text-black text-[9px] font-bold px-1.5 py-0.5 rounded shadow-sm"
                    >POPULAR</span
                  >
                </div>
                <div class="text-xs text-zinc-400 mb-3 min-h-[2.5em]">Viaja tranquilo sin responsabilidad económica.</div>
                <div class="text-base font-mono font-bold text-brand-primary mb-1">
                  + ${{ rentalCostUsd() * 0.2 | number: '1.0-0' }}
                </div>
                <div class="text-[10px] text-zinc-500 uppercase tracking-wider font-bold border-t border-white/10 pt-2 mt-2">
                  Deducible: $0
                </div>
              </button>
            </div>
          </section>

          <!-- STEP 3: Payment & Guarantee -->
          <section class="space-y-4">
            <h2 class="text-lg font-bold text-white font-satoshi flex items-center gap-3">
              <span
                class="flex items-center justify-center w-7 h-7 rounded-full bg-zinc-800 text-zinc-400 text-sm font-bold border border-white/5"
                >3</span
              >
              Garantía y Pago
            </h2>

            <!-- Payment Mode Selector -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <!-- Option A: Card Hold -->
              <button
                (click)="setPaymentMode('card')"
                class="relative p-4 rounded-xl border text-left transition-all group overflow-hidden"
                [class.bg-zinc-800]="paymentMode() === 'card'"
                [class.border-brand-primary]="paymentMode() === 'card'"
                [class.bg-zinc-900]="paymentMode() !== 'card'"
                [class.border-white-10]="paymentMode() !== 'card'"
              >
                <div class="flex items-center gap-3 mb-3">
                  <div
                    class="p-2 bg-zinc-950 rounded-lg border border-white/10 group-hover:border-white/20 transition-colors"
                  >
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <h3 class="font-bold text-sm text-white">Tarjeta de Crédito</h3>
                    <p class="text-[10px] text-zinc-400">Pre-autorización bancaria</p>
                  </div>
                  @if (paymentMode() === 'card') {
                    <div class="w-4 h-4 rounded-full bg-brand-primary shadow-[0_0_8px_rgba(57,255,20,0.5)]"></div>
                  }
                </div>
                
                <div class="mt-2 pt-2 border-t border-white/5 flex justify-between items-center">
                  <span class="text-[10px] text-zinc-500 uppercase tracking-wider">Garantía requerida</span>
                  <span class="text-xs font-mono font-bold text-white">USD {{ riskSnapshot()?.holdEstimatedUsd | number: '1.0-0' }}</span>
                </div>
              </button>

              <!-- Option B: Wallet / Subscription -->
              <button
                (click)="setPaymentMode('wallet')"
                class="relative p-4 rounded-xl border text-left transition-all group overflow-hidden"
                [class.bg-zinc-800]="paymentMode() === 'wallet'"
                [class.border-emerald-500]="paymentMode() === 'wallet'"
                [class.bg-zinc-900]="paymentMode() !== 'wallet'"
                [class.border-white-10]="paymentMode() !== 'wallet'"
              >
                <div class="flex items-center gap-3 mb-3">
                  <div
                    class="p-2 bg-zinc-950 rounded-lg border border-white/10 group-hover:border-emerald-500/30 transition-colors"
                  >
                    <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <h3 class="font-bold text-sm text-white">AutoRenta Wallet</h3>
                    <p class="text-[10px] text-zinc-400">Saldo + Membresía</p>
                  </div>
                  @if (paymentMode() === 'wallet') {
                    <div class="w-4 h-4 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></div>
                  }
                </div>

                <div class="mt-2 pt-2 border-t border-white/5 flex flex-wrap items-center gap-2">
                  @if (discountApplied()) {
                    <span class="inline-flex items-center gap-1 text-[10px] font-bold text-emerald-400">
                      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                      Garantía Reducida
                    </span>
                  } @else {
                    <span class="text-[10px] text-zinc-500">Sin beneficios activos</span>
                  }
                </div>
              </button>
            </div>

            <!-- Guarantee Explanation Box -->
            <div class="bg-zinc-900/80 border border-white/10 rounded-2xl p-6">
              <!-- MercadoPago Form -->
              @if (paymentMode() === 'card' && riskSnapshot() && fxSnapshot()) {
                <div class="mt-2">
                  <app-card-hold-panel
                    [riskSnapshot]="riskSnapshot()!"
                    [fxSnapshot]="fxSnapshot()!"
                    [userId]="currentUserId()"
                    [bookingId]="bookingId() || undefined"
                    [currentAuthorization]="currentAuthorization()"
                    (authorizationChange)="onAuthorizationChange($event)"
                  ></app-card-hold-panel>
                </div>
              }

              <!-- Wallet Info -->
              @if (paymentMode() === 'wallet') {
                <div class="flex justify-between items-center bg-zinc-950 p-4 rounded-xl border border-white/5 mb-4">
                  <div class="flex items-center gap-3">
                    <div class="p-2 bg-zinc-900 rounded-lg">
                      <svg class="w-5 h-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div>
                      <p class="text-xs text-zinc-400">Saldo disponible</p>
                      <p class="text-sm font-bold text-white">AutoRenta Credits</p>
                    </div>
                  </div>
                  <span class="text-emerald-400 font-mono font-bold text-lg">USD {{ walletAvailableBalanceUsd() | number: '1.2-2' }}</span>
                </div>

                @if (!walletHasSufficientFunds()) {
                  <div class="p-4 bg-red-500/10 border border-red-500/20 rounded-xl mb-4">
                    <p class="text-sm text-red-400 font-medium flex items-center gap-2 mb-3">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                      Saldo insuficiente
                    </p>
                    <a routerLink="/wallet" class="w-full py-2.5 bg-zinc-800 hover:bg-zinc-700 text-white text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-colors border border-white/10">
                      Cargar Saldo
                    </a>
                  </div>
                }
              }
            </div>
          </section>

          <!-- Message to Host (Improved UX) -->
          <section>
            <label class="block text-sm font-bold text-zinc-300 mb-2 flex justify-between items-center">
              <span>Nota para el anfitrión</span>
              <span class="text-xs font-normal text-zinc-500 bg-zinc-900 px-2 py-0.5 rounded-full border border-white/5">Opcional</span>
            </label>
            <div class="relative">
              <textarea
                [(ngModel)]="messageToHost"
                class="w-full bg-zinc-900 border border-white/10 rounded-xl p-4 text-white placeholder-zinc-600 focus:outline-none focus:border-brand-primary focus:ring-1 focus:ring-brand-primary transition-colors resize-none text-sm leading-relaxed"
                rows="3"
                placeholder="Hola! Me gustaría alquilar tu auto para..."
              ></textarea>
              <div class="absolute bottom-3 right-3 text-[10px] text-zinc-600">
                Se enviará al confirmar
              </div>
            </div>
          </section>
        </div>

        <!-- RIGHT COLUMN: Sticky Summary -->
        <div class="lg:col-span-5 xl:col-span-4 order-first lg:order-last">
          <div class="sticky top-24 space-y-4">
            <div
              class="bg-zinc-900 border border-white/10 rounded-2xl p-5 shadow-2xl relative overflow-hidden"
            >
              <!-- Glow Effect -->
              <div
                class="absolute top-0 right-0 w-64 h-64 bg-brand-primary/5 blur-3xl pointer-events-none rounded-full -mr-32 -mt-32"
              ></div>

              <h3 class="text-lg font-bold text-white font-satoshi mb-5">Resumen de pago</h3>

              <div class="space-y-3 mb-5">
                <div class="flex justify-between text-sm text-zinc-400">
                  <span>Alquiler ({{ rentalDays() }} días)</span>
                  <span class="text-white font-mono">USD {{ rentalCostUsd() | number: '1.2-2' }}</span>
                </div>

                @if (coverageUpgradeCostUsd() > 0) {
                  <div class="flex justify-between text-sm text-brand-primary">
                    <span>Upgrade Protección</span>
                    <span class="font-mono">USD {{ coverageUpgradeCostUsd() | number: '1.2-2' }}</span>
                  </div>
                }

                <div class="h-px bg-white/10 my-3"></div>

                <div class="flex justify-between items-baseline">
                  <span class="text-base font-bold text-white">Total a pagar</span>
                  <span class="text-2xl font-black text-brand-primary font-satoshi">USD {{ totalRentalUsd() | number: '1.2-2' }}</span>
                </div>
                <p class="text-xs text-zinc-500 text-right mt-1">Garantía se retiene por separado</p>
              </div>

              <!-- Terms Checkbox -->
              <div class="mb-5 bg-zinc-950/50 p-3 rounded-xl border border-white/5">
                <label class="flex items-start gap-3 cursor-pointer group">
                  <div class="relative flex items-center pt-0.5">
                    <input
                      type="checkbox"
                      [checked]="termsAccepted()"
                      (change)="termsAccepted.set($any($event.target).checked)"
                      class="peer h-5 w-5 cursor-pointer appearance-none rounded border border-white/20 bg-zinc-900 checked:border-brand-primary checked:bg-brand-primary transition-all"
                    />
                    <svg
                      class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-black opacity-0 peer-checked:opacity-100 transition-opacity"
                      viewBox="0 0 14 14"
                      fill="none"
                    >
                      <path
                        d="M11.6666 3.5L5.24992 9.91667L2.33325 7"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </div>
                  <span class="text-xs text-zinc-400 group-hover:text-zinc-300 transition-colors leading-snug">
                    He leído y acepto los
                    <a href="#" class="underline text-zinc-300 hover:text-brand-primary" (click)="$event.stopPropagation()">Términos de Comodato</a>
                    y la Política de Cancelación.
                  </span>
                </label>
              </div>

              <!-- Primary Action -->
              <button
                (click)="submitRequest()"
                [disabled]="
                  processingPayment() ||
                  !termsAccepted() ||
                  (paymentMode() === 'card' && currentAuthorization()?.status !== 'authorized') ||
                  (paymentMode() === 'wallet' && !walletHasSufficientFunds())
                "
                class="w-full py-4 bg-brand-primary text-black font-black text-lg rounded-xl hover:bg-brand-primary/90 active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-brand-primary/20 flex items-center justify-center gap-2 group"
              >
                @if (processingPayment()) {
                  <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span>Procesando...</span>
                } @else {
                  <span>Confirmar Solicitud</span>
                  <svg class="w-5 h-5 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                }
              </button>

              @if (paymentMode() === 'card' && currentAuthorization()?.status !== 'authorized') {
                <p class="text-[10px] text-center text-yellow-500 mt-3 font-medium flex items-center justify-center gap-1.5 animate-pulse">
                  <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                  Completa la garantía para continuar
                </p>
              }
            </div>

            <!-- Security Note -->
            <div class="flex items-center justify-center gap-2 text-[10px] text-zinc-600 uppercase tracking-widest font-bold">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
              Encriptación de extremo a extremo
            </div>
          </div>
        </div>
      </div>
    }
  </main>
</div>
