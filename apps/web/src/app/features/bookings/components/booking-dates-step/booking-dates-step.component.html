<div class="dates-step-container">
  <!-- Header -->
  <div class="step-header">
    <h2>¿Cuándo necesitas el auto?</h2>
    <p>Selecciona las fechas de tu viaje</p>
  </div>

  <!-- Car Info Card -->
  @if (car) {
    <ion-card class="car-info-card">
      <ion-card-content>
        <div class="car-info-content">
          <img
            [src]="car.photos?.[0]?.url || '/assets/placeholder-car.jpg'"
            [alt]="car.brand + ' ' + car.model"
            class="car-thumbnail"
            width="400"
            height="300"
          />
          <div class="car-details">
            <h3>{{ car.brand }} {{ car.model }}</h3>
            @if (car.price_per_day && car.price_per_day > 0) {
              <p class="car-price font-mono">${{ car.price_per_day }}/día (Aporte)</p>
            } @else {
              <p class="car-price text-primary-600">Consultar aporte</p>
            }
            @if (car.location_formatted_address || car.location_city) {
              <p class="car-location">
                <ion-icon name="location-outline"></ion-icon>
                {{ car.location_formatted_address || car.location_city }}
              </p>
            }
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  }

  <!-- Date Range Picker -->
  <div class="section">
    <h3 class="section-title font-bold font-satoshi">
      <ion-icon name="calendar-outline"></ion-icon>
      Fechas del viaje
    </h3>
    <app-date-range-picker
      [initialFrom]="startDate() ? startDate()!.toISOString().split('T')[0] : null"
      [initialTo]="endDate() ? endDate()!.toISOString().split('T')[0] : null"
      [dailyPrice]="car?.price_per_day"
      [carId]="car?.id ?? null"
      [blockedRanges]="blockedRanges()"
      (rangeChange)="onDateRangeChange($event)"
    />

    @if (totalDays() > 0) {
      <div class="date-summary">
        <p>
          <ion-icon name="time-outline"></ion-icon>
          {{ totalDays() }} día{{ totalDays() > 1 ? 's' : '' }} de uso compartido
        </p>
        <p class="estimated-price">
          <strong>Aporte estimado:</strong> ${{ estimatedPrice() | number: '1.2-2' }} USD
        </p>
      </div>
    }
  </div>

  <!-- Pickup Location -->
  <div class="section">
    <h3 class="section-title font-bold font-satoshi">
      <ion-icon name="pin-outline"></ion-icon>
      Lugar de recogida
    </h3>
    <app-booking-location-form
      [initialLocation]="pickupLocation() ?? undefined"
      [label]="'¿Dónde quieres recoger el auto?'"
      [placeholder]="'Ej: Aeropuerto, hotel, dirección...'"
      [suggestions]="handoverPoints()"
      (locationChange)="onPickupLocationChange($event)"
    />
  </div>

  <!-- Same Location Checkbox -->
  <div class="same-location-toggle">
    <ion-item lines="none">
      <ion-checkbox
        [(ngModel)]="sameLocation"
        (ionChange)="onSameLocationToggle()"
        slot="start"
      ></ion-checkbox>
      <ion-label> Devolver en el mismo lugar </ion-label>
    </ion-item>
  </div>

  <!-- Dropoff Location (if different) -->
  @if (!sameLocation()) {
    <div class="section">
      <h3 class="section-title font-bold font-satoshi">
        <ion-icon name="pin-outline"></ion-icon>
        Lugar de devolución
      </h3>
      <app-booking-location-form
        [initialLocation]="dropoffLocation() ?? undefined"
        [label]="'¿Dónde quieres devolver el auto?'"
        [placeholder]="'Ej: Aeropuerto, hotel, dirección...'"
        [suggestions]="handoverPoints()"
        (locationChange)="onDropoffLocationChange($event)"
      />
      <ion-note color="warning" class="different-location-note">
        <ion-icon name="information-circle-outline"></ion-icon>
        La devolución en un lugar diferente puede tener un costo adicional
      </ion-note>
    </div>
  }

  <!-- Validation Messages -->
  @if (!canProceed()) {
    <div class="validation-message">
      <ion-icon name="alert-circle-outline" color="warning"></ion-icon>
      <p>
        @if (!startDate() || !endDate()) {
          Por favor selecciona las fechas de tu viaje
        } @else if (!pickupLocation()) {
          Por favor indica dónde quieres recoger el auto
        } @else if (!sameLocation() && !dropoffLocation()) {
          Por favor indica dónde quieres devolver el auto
        }
      </p>
    </div>
  }

  <!-- Tips Section -->
  <ion-card class="tips-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="bulb-outline"></ion-icon>
        Consejos
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ul class="tips-list">
        <li>Los usos compartidos largos (7+ días) pueden tener beneficios adicionales</li>
        <li>Verifica la disponibilidad del propietario antes de solicitar el uso</li>
        <li>Considera tiempo extra para recoger y devolver el auto</li>
        <li>La devolución tardía puede tener cargos por compensación adicionales</li>
      </ul>
    </ion-card-content>
  </ion-card>
</div>
