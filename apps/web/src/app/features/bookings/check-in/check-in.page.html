<div class="min-h-screen bg-surface-base dark:bg-surface-raised py-8">
  <div class="max-w-4xl mx-auto px-4">
    <!-- Loading State -->
    @if (loading()) {
      <div class="text-center py-12">
        <div
          class="inline-block h-12 w-12 animate-spin rounded-full border-4 border-border-muted dark:border-border-default border-t-blue-600"
        ></div>
        <p class="mt-4 text-text-secondary dark:text-text-secondary dark:text-text-secondary">
          Cargando reserva...
        </p>
      </div>
    }

    <!-- Error State -->
    @else if (error()) {
      <div
        class="bg-error-bg border border-error-border rounded-xl p-6 dark:bg-error-900/20 dark:border-error-800"
      >
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 text-2xl">⚠️</div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-error-strong mb-2 font-satoshi">Error</h3>
            <p class="text-error-strong">{{ error() }}</p>
            <button
              routerLink="/bookings"
              class="mt-4 px-4 py-2 bg-error-600 text-text-inverse rounded-lg hover:bg-error-700 transition-colors"
            >
              Volver a mis reservas
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Main Content -->
    @else if (booking()) {
      <!-- Header -->
      <div class="mb-6">
        <button
          routerLink="/bookings"
          class="inline-flex items-center gap-2 text-sm font-medium text-text-secondary dark:text-text-secondary hover:text-text-primary dark:text-text-muted dark:hover:text-gray-100 transition-colors mb-4"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            />
          </svg>
          Volver a mis reservas
        </button>

        <div
          class="bg-surface-raised dark:bg-surface-base rounded-xl shadow-sm border border-border-default dark:border-border-muted p-6"
        >
          <h1 class="text-2xl font-bold text-text-primary dark:text-text-inverse mb-2 flex items-center gap-3 font-satoshi">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 17h14v-5l-2-4H7l-2 4v5z" stroke-width="1.75" stroke-linejoin="round"/><circle cx="7.5" cy="17" r="1.5" stroke-width="1.5"/><circle cx="16.5" cy="17" r="1.5" stroke-width="1.5"/></svg>
            Check-in del Vehículo
          </h1>
          <p class="text-text-secondary dark:text-text-secondary dark:text-text-secondary">
            Realizá la inspección inicial del vehículo antes de iniciar el alquiler
          </p>
        </div>
      </div>

      <!-- Booking Info Card -->
      <div
        class="bg-surface-raised dark:bg-surface-base rounded-xl shadow-sm border border-border-default dark:border-border-muted p-6 mb-6"
      >
        <h2 class="text-lg font-semibold text-text-primary dark:text-text-inverse mb-4 font-satoshi">
          Información de la Reserva
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p
              class="text-sm text-text-secondary dark:text-text-secondary dark:text-text-secondary mb-1"
            >
              Vehículo
            </p>
            <p class="font-medium text-text-primary dark:text-text-inverse">
              {{ booking()?.car_brand }} {{ booking()?.car_model }} ({{ booking()?.car_year }})
            </p>
          </div>
          <div>
            <p
              class="text-sm text-text-secondary dark:text-text-secondary dark:text-text-secondary mb-1"
            >
              Inicio del alquiler
            </p>
            <p class="font-medium text-text-primary dark:text-text-inverse">
              {{ formatDateTime(booking()!.start_at) }}
            </p>
          </div>
          <div>
            <p
              class="text-sm text-text-secondary dark:text-text-secondary dark:text-text-secondary mb-1"
            >
              Fin del alquiler
            </p>
            <p class="font-medium text-text-primary dark:text-text-inverse">
              {{ formatDateTime(booking()!.end_at) }}
            </p>
          </div>
          <div>
            <p
              class="text-sm text-text-secondary dark:text-text-secondary dark:text-text-secondary mb-1"
            >
              Estado
            </p>
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
              [ngClass]="{
                'bg-cta-default/20 text-cta-default': booking()?.status === 'confirmed',
                'bg-success-light/20 text-success-strong': booking()?.status === 'in_progress',
              }"
            >
              {{ booking()?.status === 'confirmed' ? 'Confirmada' : 'En progreso' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Check-in Already Completed -->
      @if (inspectionCompleted() && existingInspection()) {
        <div
          class="bg-success-light/10 border border-success-light/40 rounded-xl p-6 dark:bg-success-light/20 dark:border-success-light"
        >
          <div class="flex items-start gap-3">
            <svg class="w-6 h-6 flex-shrink-0 text-success-700 dark:text-success-strong" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-success-700 dark:text-success-strong mb-2 font-satoshi">
                Check-in Completado
              </h3>
              <p class="text-success-700 dark:text-success-strong mb-4">
                El check-in de este vehículo ya fue completado el
                {{
                  existingInspection()?.signedAt
                    ? formatDateTime(existingInspection()!.signedAt!)
                    : ''
                }}.
              </p>
              @if (existingInspection()?.odometer) {
                <p class="text-sm text-success-700 dark:text-success-strong mb-2">
                  <strong>Odómetro:</strong> {{ existingInspection()?.odometer }} km
                </p>
              }
              @if (existingInspection()?.fuelLevel !== undefined) {
                <p class="text-sm text-success-700 dark:text-success-strong mb-4">
                  <strong>Combustible:</strong> {{ existingInspection()?.fuelLevel }}%
                </p>
              }
              <button
                (click)="goToBookingDetail()"
                class="px-4 py-2 bg-success-light text-text-primary rounded-lg hover:bg-success-light transition-colors"
              >
                Ver Detalle de Reserva
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Check-in Form -->
      @else if (canPerformCheckIn()) {
        <div
          class="bg-surface-raised dark:bg-surface-base rounded-xl shadow-sm border border-border-default dark:border-border-muted p-6"
        >
          <div class="mb-6">
            <h2 class="text-lg font-semibold text-text-primary dark:text-text-inverse mb-2 font-satoshi">
              Instrucciones
            </h2>
            <ul
              class="list-disc list-inside space-y-2 text-sm text-text-secondary dark:text-text-secondary dark:text-text-secondary"
            >
              <li>Tomá al menos 8 fotos claras del vehículo (exterior e interior)</li>
              <li>Registrá el kilometraje actual (odómetro)</li>
              <li>Verificá el nivel de combustible</li>
              <li>Confirmá que todo esté en orden antes de firmar</li>
            </ul>
          </div>

          <app-inspection-uploader
            [bookingId]="booking()!.id"
            stage="check_in"
            (inspectionCompleted)="onInspectionCompleted($event)"
          ></app-inspection-uploader>
        </div>
      }

      <!-- Cannot Perform Check-in -->
      @else {
        <div
          class="bg-warning-bg border border-warning-border rounded-xl p-6 dark:bg-warning-900/20 dark:border-warning-800"
        >
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0 text-2xl">⚠️</div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-warning-strong dark:text-warning-200 mb-2 font-satoshi">
                No se puede realizar el check-in
              </h3>
              <p class="text-warning-strong dark:text-warning-300 mb-4">
                El check-in no está disponible en este momento. Verificá que la reserva esté
                confirmada y que seas el locatario.
              </p>
              <button
                (click)="goToBookingDetail()"
                class="px-4 py-2 bg-warning-600 text-text-inverse rounded-lg hover:bg-warning-700 transition-colors"
              >
                Ver Detalle de Reserva
              </button>
            </div>
          </div>
        </div>
      }
    }
  </div>
</div>
