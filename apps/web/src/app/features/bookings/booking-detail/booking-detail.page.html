<div class="max-w-7xl mx-auto py-8 px-4">
  <!-- Loading State -->
  <div *ngIf="loading()" class="text-center py-12">
    <p class="text-gray-600 dark:text-gray-300">Cargando reserva...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error() && !loading()" class="bg-red-50 border border-red-200 rounded-xl p-6">
    <p class="text-red-800">{{ error() }}</p>
    <button
      routerLink="/bookings"
      class="mt-4 px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700"
    >
      Volver a mis reservas
    </button>
  </div>

  <!-- Booking Detail -->
  <div *ngIf="booking() && !loading()" class="space-y-4 sm:space-y-6">
    <!-- Back Button -->
    <button
      routerLink="/bookings"
      class="inline-flex items-center gap-2 text-sm font-medium text-accent-petrol hover:text-accent-warm transition-base mb-2"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 19l-7-7m0 0l7-7m-7 7h18"
        />
      </svg>
      Volver a mis reservas
    </button>

    <!-- Booking Flow Progress -->
    <div
      class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-deep p-4 sm:p-6 shadow-sm"
    >
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-ash-gray dark:text-pearl-light/70">
            Estado del flujo
          </p>
          <p class="text-sm text-charcoal-medium dark:text-pearl-light/80">
            Seguimiento paso a paso de tu reserva
          </p>
        </div>
        <span class="text-xs font-medium text-accent-petrol">
          Paso {{ currentBookingStageIndex() + 1 }} / {{ bookingFlowSteps.length }}
        </span>
      </div>

      <div class="mt-5 flex flex-col gap-4 sm:flex-row sm:items-center sm:gap-0">
        <ng-container *ngFor="let step of bookingFlowSteps; let i = index">
          <div class="flex flex-1 items-start gap-3 p-2">
            <div
              class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border text-sm font-semibold transition-colors"
              [ngClass]="{
                'bg-accent-petrol text-white border-accent-petrol shadow-md shadow-accent-petrol/30': isStepCompleted(i) || isStepCurrent(i),
                'bg-white text-ash-gray border-ash-gray/40 dark:bg-slate-deep/60 dark:text-pearl-light/50 dark:border-pearl-light/20': isStepUpcoming(i)
              }"
            >
              <svg
                *ngIf="isStepCompleted(i)"
                class="h-5 w-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M5 13l4 4L19 7"
                />
              </svg>
              <span *ngIf="!isStepCompleted(i)">{{ i + 1 }}</span>
            </div>
            <div>
              <p
                class="text-sm font-semibold"
                [ngClass]="{
                  'text-smoke-black dark:text-white': isStepCompleted(i) || isStepCurrent(i),
                  'text-ash-gray dark:text-pearl-light/60': isStepUpcoming(i)
                }"
              >
                {{ step.label }}
              </p>
              <p class="text-xs text-ash-gray dark:text-pearl-light/70">
                {{ step.description }}
              </p>
            </div>
          </div>

          <div
            *ngIf="i < bookingFlowSteps.length - 1"
            class="hidden sm:block h-0.5 flex-1 bg-gradient-to-r from-ash-gray/10 via-ash-gray/40 to-ash-gray/10"
          ></div>
        </ng-container>
      </div>
    </div>

    <!-- Two Column Layout for Desktop -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left Column: Booking Info -->
      <div class="space-y-4 sm:space-y-6">
        <!-- Compact Hero Section -->
        <div
          class="relative overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 bg-gradient-to-r from-gray-50 to-gray-100 dark:border-gray-700 dark:from-gray-800 dark:to-gray-900"
        >
          <div class="flex items-center gap-4 p-4">
            <!-- Status Badge -->
            <app-booking-status [booking]="booking()!"></app-booking-status>

            <!-- Car Info -->
            <div class="flex-1 min-w-0">
              <h1 class="text-lg font-bold text-gray-900 dark:text-white truncate">
                {{ booking()?.car_title }}
              </h1>
              <p class="text-sm text-gray-600 dark:text-gray-300 dark:text-gray-300">
                {{ booking()?.car_brand }} {{ booking()?.car_model }} ({{ booking()?.car_year }})
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-300 dark:text-gray-300" *ngIf="booking()?.car_city">
                üìç {{ booking()?.car_city }}
              </p>
            </div>

            <!-- ID Badge -->
            <div class="hidden sm:block">
              <p class="text-xs text-gray-500 dark:text-gray-300 font-mono">ID: {{ booking()?.id | slice: 0 : 8 }}</p>
            </div>
          </div>
        </div>

        <div class="booking-detail-layout">
          <section class="booking-detail-main">
            <!-- Compact Dates Card -->
            <div
              class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-deep p-3 shadow-sm dark:border-gray-700 dark:bg-gray-800"
              id="tour-booking-dates"
            >
              <h3 class="mb-2 text-sm font-semibold text-gray-700 dark:text-gray-300">
                üìÖ Fechas de la Reserva
              </h3>
              <div class="flex items-center gap-4 text-sm">
                <div class="flex-1">
                  <p class="text-xs text-gray-500 dark:text-gray-300">Inicio</p>
                  <p class="font-medium text-gray-900 dark:text-white">
                    {{ formatDateTime(booking()!.start_at) }}
                  </p>
                </div>
                <div class="flex-1">
                  <p class="text-xs text-gray-500 dark:text-gray-300">Fin</p>
                  <p class="font-medium text-gray-900 dark:text-white">
                    {{ formatDateTime(booking()!.end_at) }}
                  </p>
                </div>
                <div class="flex-shrink-0" *ngIf="booking()?.days_count">
                  <p class="text-xs text-gray-500 dark:text-gray-300">Duraci√≥n</p>
                  <p class="font-semibold text-gray-900 dark:text-white">
                    {{ booking()?.days_count }}d
                  </p>
                </div>
              </div>
            </div>

            <!-- üÜï Delivery Information Card -->
            <div
              *ngIf="booking()?.delivery_required && booking()?.delivery_distance_km && booking()?.delivery_distance_km > 0"
              class="rounded-lg border border-blue-200 dark:border-blue-800/50 bg-blue-50 dark:bg-blue-900/20 p-3 shadow-sm"
            >
              <h3 class="mb-3 text-sm font-semibold text-blue-900 dark:text-blue-100">
                üöö Informaci√≥n de Entrega
              </h3>
              <div class="space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-blue-700 dark:text-blue-200">Distancia:</span>
                  <span class="font-medium text-blue-900 dark:text-blue-100">
                    {{ (booking()?.delivery_distance_km).toFixed(1) }} km
                  </span>
                </div>
                <div class="flex justify-between text-sm" *ngIf="booking()?.delivery_fee_cents && booking()?.delivery_fee_cents > 0">
                  <span class="text-blue-700 dark:text-blue-200">Cargo de entrega:</span>
                  <span class="font-medium text-blue-900 dark:text-blue-100">
                    {{ formatCurrency(booking()!.delivery_fee_cents, 'ARS') }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Requirements Card - Solo para reservas confirmadas o en progreso -->
            <div
              *ngIf="booking()?.status === 'confirmed' || booking()?.status === 'in_progress'"
              class="card-premium rounded-2xl p-4 sm:p-6 shadow-soft border-2 border-accent-petrol/20"
            >
              <div class="flex items-center gap-2 mb-4">
                <svg
                  class="w-6 h-6 text-accent-petrol"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <h3 class="h5">Requisitos para el Retiro</h3>
              </div>

              <p class="text-sm text-charcoal-medium dark:text-pearl-light mb-4">
                Asegurate de cumplir con estos requisitos el d√≠a del retiro del veh√≠culo:
              </p>

              <div class="space-y-3">
                <!-- Edad m√≠nima -->
                <div
                  class="flex items-start gap-3 p-3 rounded-lg bg-sand-light/50 dark:bg-slate-deep/30"
                >
                  <svg
                    class="w-5 h-5 text-accent-petrol flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                    />
                  </svg>
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-smoke-black dark:text-white-pure">
                      Edad m√≠nima: 21 a√±os
                    </p>
                    <p class="text-xs text-charcoal-medium dark:text-pearl-light/70 mt-1">
                      Deber√°s presentar tu DNI o pasaporte para verificar tu edad.
                    </p>
                  </div>
                </div>

                <!-- Licencia de conducir -->
                <div
                  class="flex items-start gap-3 p-3 rounded-lg bg-sand-light/50 dark:bg-slate-deep/30"
                >
                  <svg
                    class="w-5 h-5 text-accent-petrol flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                    />
                  </svg>
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-smoke-black dark:text-white-pure">
                      Licencia de conducir v√°lida
                    </p>
                    <p class="text-xs text-charcoal-medium dark:text-pearl-light/70 mt-1">
                      Con antig√ºedad m√≠nima de 1 a√±o y vigente durante toda la reserva.
                    </p>
                  </div>
                </div>

                <!-- Documento de identidad -->
                <div
                  class="flex items-start gap-3 p-3 rounded-lg bg-sand-light/50 dark:bg-slate-deep/30"
                >
                  <svg
                    class="w-5 h-5 text-accent-petrol flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"
                    />
                  </svg>
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-smoke-black dark:text-white-pure">
                      DNI o Pasaporte
                    </p>
                    <p class="text-xs text-charcoal-medium dark:text-pearl-light/70 mt-1">
                      Original y en vigencia. No se aceptan copias.
                    </p>
                  </div>
                </div>

                <!-- M√©todo de pago / Wallet -->
                <div
                  class="flex items-start gap-3 p-3 rounded-lg bg-sand-light/50 dark:bg-slate-deep/30"
                >
                  <svg
                    class="w-5 h-5 text-accent-petrol flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
                    />
                  </svg>
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-smoke-black dark:text-white-pure">
                      Dep√≥sito de garant√≠a pagado
                    </p>
                    <p class="text-xs text-charcoal-medium dark:text-pearl-light/70 mt-1">
                      <span *ngIf="booking()?.payment_method === 'wallet'"
                        >‚úÖ Pagado con Wallet ($250 USD bloqueados)</span
                      >
                      <span *ngIf="booking()?.payment_method !== 'wallet'"
                        >Tarjeta de cr√©dito o efectivo en el momento del retiro.</span
                      >
                    </p>
                  </div>
                </div>

                <!-- Verificaci√≥n de identidad -->
                <div
                  class="flex items-start gap-3 p-3 rounded-lg bg-sand-light/50 dark:bg-slate-deep/30"
                >
                  <svg
                    class="w-5 h-5 text-accent-petrol flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                    />
                  </svg>
                  <div class="flex-1">
                    <p class="text-sm font-semibold text-smoke-black dark:text-white-pure">
                      Perfil verificado
                    </p>
                    <p class="text-xs text-charcoal-medium dark:text-pearl-light/70 mt-1">
                      Verific√° tu identidad en tu perfil antes del retiro para agilizar el proceso.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Nota importante -->
              <div class="info-card-petrol p-4 mt-4">
                <div class="flex items-start gap-2">
                  <svg
                    class="w-5 h-5 text-accent-petrol flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <div class="text-sm text-charcoal-medium dark:text-pearl-light">
                    <p class="font-semibold text-smoke-black dark:text-white-pure mb-1">
                      Importante
                    </p>
                    <p>
                      El anfitri√≥n puede rechazar la entrega si no cumpl√≠s con todos los requisitos.
                      Asegurate de tener todo listo antes de coordinar el retiro.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Check-in/Check-out Actions Card (for renters) -->
            <div
              *ngIf="isRenter() && (canPerformCheckIn() || canPerformCheckOut())"
              class="card-premium rounded-2xl p-4 sm:p-6 shadow-soft border-2 border-accent-petrol/20"
            >
              <h3 class="h5 mb-4">Acciones del Alquiler</h3>
              
              <!-- Check-in Button -->
              <div
                *ngIf="canPerformCheckIn()"
                class="mb-4 p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800"
              >
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/40 flex items-center justify-center">
                      <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                  </div>
                  <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-1">Check-in del Veh√≠culo</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300 dark:text-gray-300 mb-3">
                      Realiz√° la inspecci√≥n inicial del veh√≠culo antes de iniciar el alquiler. Necesitar√°s tomar fotos, registrar el od√≥metro y el nivel de combustible.
                    </p>
                    <a
                      [routerLink]="['/bookings', booking()?.id, 'check-in']"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors shadow-sm"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                      Iniciar Check-in
                    </a>
                  </div>
                </div>
              </div>

              <!-- Check-out Button -->
              <div
                *ngIf="canPerformCheckOut()"
                class="p-4 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800"
              >
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/40 flex items-center justify-center">
                      <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                      </svg>
                    </div>
                  </div>
                  <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-1">Check-out del Veh√≠culo</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300 dark:text-gray-300 mb-3">
                      Realiz√° la inspecci√≥n final del veh√≠culo al devolver el auto. Compar√° el estado con el check-in y report√° cualquier da√±o.
                    </p>
                    <a
                      [routerLink]="['/bookings', booking()?.id, 'check-out']"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors shadow-sm"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                      </svg>
                      Iniciar Check-out
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Check-in/Check-out Status (if completed) -->
            <div
              *ngIf="isRenter() && (hasCheckIn() || hasCheckOut())"
              class="card-premium rounded-2xl p-4 sm:p-6 shadow-soft"
            >
              <h3 class="h5 mb-4">Estado de Inspecciones</h3>
              <div class="space-y-3">
                <div
                  *ngIf="hasCheckIn()"
                  class="flex items-center gap-3 p-3 rounded-lg bg-green-50 dark:bg-green-900/20"
                >
                  <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span class="text-sm font-medium text-green-800 dark:text-green-200">Check-in completado</span>
                </div>
                <div
                  *ngIf="hasCheckOut()"
                  class="flex items-center gap-3 p-3 rounded-lg bg-green-50 dark:bg-green-900/20"
                >
                  <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span class="text-sm font-medium text-green-800 dark:text-green-200">Check-out completado</span>
                </div>
              </div>
            </div>

            <!-- Claims/Siniestros Section -->
            <div
              *ngIf="isRenter() && (canReportClaim() || hasClaim())"
              class="card-premium rounded-2xl p-4 sm:p-6 shadow-soft border-2 border-red-200/50 dark:border-red-900/30"
            >
              <h3 class="h5 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                Siniestros / Da√±os
              </h3>

              <!-- Report Claim Button -->
              <div
                *ngIf="canReportClaim()"
                class="p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800"
              >
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/40 flex items-center justify-center">
                      <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                    </div>
                  </div>
                  <div class="flex-1">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-1">Reportar Siniestro o Da√±o</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-3">
                      ¬øTuviste un accidente o detectaste un da√±o en el veh√≠culo? Reportalo inmediatamente con fotos y detalles. La aseguradora se contactar√° contigo.
                    </p>
                    <a
                      [routerLink]="['/bookings', booking()?.id, 'report-claim']"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors shadow-sm"
                    >
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                      Reportar Siniestro
                    </a>
                  </div>
                </div>
              </div>

              <!-- Claim Status Display -->
              <div *ngIf="hasClaim() && latestClaim()" class="space-y-3">
                <div
                  class="p-4 rounded-xl border"
                  [ngClass]="{
                    'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800': getClaimStatusColor(latestClaim()!.status) === 'orange',
                    'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800': getClaimStatusColor(latestClaim()!.status) === 'blue',
                    'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800': getClaimStatusColor(latestClaim()!.status) === 'green',
                    'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800': getClaimStatusColor(latestClaim()!.status) === 'red',
                    'bg-gray-50 dark:bg-gray-900/20 border-gray-200 dark:border-gray-800': getClaimStatusColor(latestClaim()!.status) === 'gray'
                  }"
                >
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-2">
                        <span
                          class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-semibold rounded-full"
                          [ngClass]="{
                            'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-200': getClaimStatusColor(latestClaim()!.status) === 'orange',
                            'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-200': getClaimStatusColor(latestClaim()!.status) === 'blue',
                            'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200': getClaimStatusColor(latestClaim()!.status) === 'green',
                            'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-200': getClaimStatusColor(latestClaim()!.status) === 'red',
                            'bg-gray-100 text-gray-800 dark:bg-gray-900/40 dark:text-gray-200': getClaimStatusColor(latestClaim()!.status) === 'gray'
                          }"
                        >
                          {{ getClaimStatusLabel(latestClaim()!.status) }}
                        </span>
                        <span class="text-xs text-gray-500 dark:text-gray-400 font-mono">
                          #{{ latestClaim()!.id | slice: 0 : 8 }}
                        </span>
                      </div>
                      <p class="text-sm font-medium text-gray-900 dark:text-white mb-1">
                        Siniestro reportado el {{ formatDate(latestClaim()!.created_at) }}
                      </p>
                      <p class="text-xs text-gray-600 dark:text-gray-300 line-clamp-2">
                        {{ latestClaim()!.description }}
                      </p>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-2" *ngIf="latestClaim()!.photos && latestClaim()!.photos!.length > 0">
                        üì∏ {{ latestClaim()!.photos!.length }} foto(s) de evidencia
                      </p>
                    </div>
                  </div>
                  <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                    <p class="text-xs text-gray-600 dark:text-gray-300">
                      <strong>¬øQu√© sigue?</strong>
                      <span *ngIf="latestClaim()!.status === 'reported'">
                        Un gestor de la aseguradora revisar√° tu reporte en las pr√≥ximas 2 horas.
                      </span>
                      <span *ngIf="latestClaim()!.status === 'under_review'">
                        Tu siniestro est√° siendo evaluado por la aseguradora.
                      </span>
                      <span *ngIf="latestClaim()!.status === 'approved'">
                        Tu siniestro fue aprobado. Se procesar√° el pago correspondiente.
                      </span>
                      <span *ngIf="latestClaim()!.status === 'rejected'">
                        Tu siniestro fue rechazado. Contact√° a soporte para m√°s informaci√≥n.
                      </span>
                      <span *ngIf="latestClaim()!.status === 'paid'">
                        El pago del siniestro fue procesado exitosamente.
                      </span>
                      <span *ngIf="latestClaim()!.status === 'closed'">
                        Este siniestro est√° cerrado.
                      </span>
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- ‚úÖ INSURANCE SUMMARY CARD - Removed loading state -->

            <!-- Pricing Breakdown Card -->
          </section>

          <!-- Removed: app-payment-actions component -->
        </div>

        <app-review-management [booking]="booking()!"></app-review-management>

        <!-- Bilateral Confirmation Section -->
        <div *ngIf="showConfirmationSection()" class="space-y-4">
          <!-- Owner Confirmation Component -->
          <div *ngIf="isOwner()">
            <app-owner-confirmation
              [bookingId]="booking()!.id"
              [ownerConfirmed]="booking()?.owner_confirmed_delivery ?? false"
              [renterConfirmed]="booking()?.renter_confirmed_payment ?? false"
              (confirmed)="handleConfirmationSuccess($event)"
              (errorOccurred)="handleConfirmationError($event)"
            ></app-owner-confirmation>
          </div>

          <!-- Renter Confirmation Component -->
          <div *ngIf="isRenter()">
            <app-renter-confirmation
              [bookingId]="booking()!.id"
              [ownerConfirmed]="booking()?.owner_confirmed_delivery ?? false"
              [renterConfirmed]="booking()?.renter_confirmed_payment ?? false"
              [damageAmount]="booking()?.owner_damage_amount ?? null"
              [damageDescription]="booking()?.owner_damage_description ?? null"
              [depositAmount]="(booking()?.deposit_amount_cents ?? 25000) / 100"
              (confirmed)="handleConfirmationSuccess($event)"
              (errorOccurred)="handleConfirmationError($event)"
            ></app-renter-confirmation>
          </div>
        </div>

        <!-- ‚úÖ REPORT CLAIM BUTTON -->
        <div
          *ngIf="booking()?.status === 'confirmed' || booking()?.status === 'in_progress'"
          class="card-premium p-4 rounded-2xl shadow-soft bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20 border-l-4 border-red-500"
        >
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <svg
                class="w-8 h-8 text-red-600 dark:text-red-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                />
              </svg>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-smoke-black dark:text-white-pure mb-2">
                ¬øTuviste un accidente o da√±o?
              </h3>
              <p class="text-sm text-charcoal-medium dark:text-pearl-light mb-4">
                Reporta cualquier incidente inmediatamente para activar tu cobertura de seguro.
              </p>
              <a
                [routerLink]="['/bookings', booking()?.id, 'report-claim']"
                class="inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-medium transition-base shadow-sm"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                  />
                </svg>
                Reportar Siniestro/Da√±o
              </a>
            </div>
          </div>
        </div>
        <!-- End Left Column -->

        <!-- Right Column: Chat or Payment Reminder -->
        <div
          *ngIf="carOwnerId()"
          id="tour-booking-chat"
          class="lg:sticky lg:top-4 lg:self-start"
        >
          <!-- ‚úÖ Show chat for confirmed/active bookings -->
          <div *ngIf="booking()?.status === 'confirmed' || booking()?.status === 'in_progress' || booking()?.status === 'pending' || showConfirmationSection()">
            <h2 class="mb-4 text-xl font-bold text-gray-800 dark:text-gray-100">
              Chat con el anfitri√≥n
            </h2>
            <app-booking-chat
              [bookingId]="booking()!.id"
              [recipientId]="carOwnerId()!"
              [recipientName]="carOwnerName()"
            ></app-booking-chat>
          </div>

          <!-- ‚úÖ Show payment reminder for pending payment -->
          <div *ngIf="booking()?.status === 'pending_payment'" class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800/60 rounded-xl p-6">
              <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-blue-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                  <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">
                    Reserva pendiente de pago
                  </h3>
                  <p class="text-sm text-blue-700 dark:text-blue-300 mb-4">
                    Para poder chatear con el anfitri√≥n, primero deb√©s completar el pago de tu reserva.
                  </p>
                  <a
                    [routerLink]="['/bookings', booking()?.id, 'payment']"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                    Completar pago
                  </a>
                </div>
              </div>
            </div>

            <!-- FAQ Section for Pending Payment -->
            <div class="bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-xl p-4">
              <h4 class="font-medium text-gray-900 dark:text-gray-100 mb-3">
                Preguntas frecuentes
              </h4>
              <div class="space-y-3 text-sm">
                <div>
                  <p class="font-medium text-gray-800 dark:text-gray-200">¬øCu√°nto tiempo tengo para pagar?</p>
                  <p class="text-gray-600 dark:text-gray-300 dark:text-gray-300">Ten√©s 24 horas para completar el pago antes de que expire la reserva.</p>
                </div>
                <div>
                  <p class="font-medium text-gray-800 dark:text-gray-200">¬øPuedo hacer preguntas al anfitri√≥n?</p>
                  <p class="text-gray-600 dark:text-gray-300 dark:text-gray-300">S√≠, pero primero complet√° el pago para activar el chat.</p>
                </div>
                <div>
                  <p class="font-medium text-gray-800 dark:text-gray-200">¬øQu√© m√©todos de pago aceptan?</p>
                  <p class="text-gray-600 dark:text-gray-300 dark:text-gray-300">Tarjeta de cr√©dito/d√©bito o saldo en tu wallet AutoRenta.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End Right Column -->
      </div>
      <!-- End Two Column Grid -->
    </div>
  </div>
</div>
