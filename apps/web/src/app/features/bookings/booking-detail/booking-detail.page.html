<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 font-sans text-text-primary">
  <!-- Loading State -->
  @if (loading()) {
  <div class="flex flex-col items-center justify-center py-20 space-y-4">
    <div
      class="w-12 h-12 border-4 border-surface-secondary border-t-cta-default rounded-full animate-spin">
    </div>
    <p class="text-text-secondary font-medium animate-pulse">
      Cargando detalles de la reserva...
    </p>
  </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
  <app-error-state title="No pudimos cargar la reserva"
    [message]="error() ?? 'Ocurrió un error inesperado al conectar con el servidor.'"
    variant="banner">
    <button [routerLink]="backLink()"
      class="mt-4 px-6 py-2.5 bg-surface-inverse text-text-inverse rounded-xl hover:bg-surface-inverse/90 transition-colors font-medium text-sm flex items-center gap-2 mx-auto">
      <ion-icon name="arrow-back-outline"></ion-icon>
      {{ backLabel() }}
    </button>
  </app-error-state>
  }

  <!-- Main Content -->
  @if (booking() && !loading()) {
  <!-- Breadcrumb / Back Navigation -->
  <nav class="mb-6 flex items-center justify-between">
    <button [routerLink]="backLink()"
      class="group inline-flex items-center gap-2 text-sm font-medium text-text-secondary hover:text-text-primary transition-colors">
      <div
        class="w-8 h-8 rounded-full bg-surface-secondary flex items-center justify-center group-hover:bg-surface-hover transition-colors">
        <ion-icon name="arrow-back" class="text-lg"></ion-icon>
      </div>
      <span>{{ backLabel() }}</span>
    </button>

    <div class="text-xs text-text-muted font-mono">ID: {{ booking()!.id.slice(0, 8) }}</div>
  </nav>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <!-- ============================================================================================== -->
    <!-- LEFT COLUMN (CONTEXT & HISTORY) - Span 8 -->
    <!-- ============================================================================================== -->
    <div class="lg:col-span-8 space-y-6">
      <!-- 1. COMPACT HERO: Car & Key Stats -->
      <section class="card-premium p-0 flex flex-col sm:flex-row overflow-hidden">
        <!-- Image Section (35%) -->
        <div class="relative sm:w-1/3 h-48 sm:h-auto bg-surface-secondary">
          @if (booking()?.car_image) {
          <img [src]="booking()!.car_image" [alt]="booking()?.car_title"
            class="w-full h-full object-cover" />
          <!-- Status Overlay -->
          <div class="absolute top-3 left-3">
            <app-booking-status
              [booking]="booking()!"
              [deliveryCountdown]="deliveryTimeRemaining()">
            </app-booking-status>
          </div>
          } @else {
          <div class="w-full h-full flex items-center justify-center text-text-muted">
            <ion-icon name="car-sport-outline" class="text-4xl"></ion-icon>
          </div>
          }
        </div>

        <!-- Info Section (65%) -->
        <div class="flex-1 h-full p-5 flex flex-col justify-between overflow-hidden">
          <div>
            <div class="flex justify-between items-start mb-2">
              <h1
                class="text-xl sm:text-2xl font-bold text-text-primary tracking-tight leading-none font-satoshi">
                {{ booking()?.car_brand }} {{ booking()?.car_model }}
                <span class="text-text-muted font-normal ml-1">{{ booking()?.car_year }}</span>
              </h1>
              <!-- Price Tag -->
              <div class="text-right">
                <p class="text-lg font-bold text-text-primary leading-none">
                  {{
                  booking()!.total_amount | currency: booking()!.currency : 'symbol' : '1.0-0'
                  }}
                </p>
                <p class="text-[10px] text-text-muted font-medium uppercase tracking-wide">
                  Total
                </p>
              </div>
            </div>

            <!-- Owner info tiny -->
            <div class="flex items-center gap-2 text-sm text-text-secondary mb-4">
              <div
                class="w-5 h-5 rounded-full bg-surface-secondary flex items-center justify-center text-[10px] font-bold text-text-secondary">
                {{ carOwnerName().charAt(0) }}
              </div>
              <span>{{ carOwnerName() }}</span>
            </div>
          </div>

          <!-- Dashboard Stats Grid -->
          <div class="grid grid-cols-3 gap-2 border-t border-border-default pt-4">
            <div>
              <p class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-0.5">
                Inicio
              </p>
              <p class="text-sm font-semibold text-text-primary">
                {{ booking()!.start_at | date: 'dd MMM, HH:mm' }}
              </p>
            </div>
            <div>
              <p class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-0.5">
                Fin
              </p>
              <p class="text-sm font-semibold text-text-primary">
                {{ booking()!.end_at | date: 'dd MMM, HH:mm' }}
              </p>
            </div>
            <div>
              <p class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-0.5">
                Tiempo
              </p>
              <p class="text-sm font-semibold text-text-primary flex items-center gap-1">
                {{ booking()!.days_count }} días
                @if (deliveryTimeRemaining()) {
                <span class="text-[10px] text-info-700 bg-info-50 px-1.5 py-0.5 rounded-full">{{
                  deliveryTimeRemaining()
                  }}</span>
                }
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- 2. Timeline Bar (Slim) -->
      <section class="card-premium p-6">
        <app-booking-confirmation-timeline [booking]="booking()!" [ownerName]="carOwnerName()"
          [renterName]="booking()?.renter_name ?? 'el locatario'"
          (confirmationRequested)="handleTimelineAction($event)"></app-booking-confirmation-timeline>

        <!-- URGENT ACTION: Guarantee Required -->
        @if ((needsPayment() || booking()?.status === 'pending_payment') && isRenter()) {
        <div
          class="mt-6 p-5 rounded-2xl bg-gradient-to-r from-cta-default to-cta-hover text-cta-text shadow-xl animate-pulse">
          <div class="flex items-center justify-between gap-4">
            <div class="flex-1">
              <h3 class="text-base font-bold flex items-center gap-2">
                <ion-icon name="alert-circle" class="text-xl"></ion-icon>
                Acción Requerida
              </h3>
              <p class="text-sm opacity-90">
                Tu reserva está pausada. Debes garantizar la garantía para avanzar.
              </p>
            </div>
            <a [routerLink]="['/bookings', booking()?.id, 'detail-payment']"
              class="px-6 py-3 bg-white text-cta-default font-bold rounded-xl shadow-lg hover:bg-opacity-90 transition-all whitespace-nowrap">
              Garantizar Ahora
            </a>
          </div>
        </div>
        }

        <!-- Alerts integrated efficiently -->
        @if (flowAlert()) {
        <div class="mt-4 pt-4 border-t border-border-default">
          <div class="flex items-start gap-3">
            <ion-icon
              [name]="flowAlert()!.tone === 'danger' ? 'alert-circle' : 'information-circle'"
              [class]="flowAlert()!.tone === 'danger' ? 'text-error-500' : 'text-info-500'"
              class="mt-0.5"></ion-icon>
            <div class="flex-1">
              <p class="text-sm font-medium text-text-primary">{{ flowAlert()!.title }}</p>
              <p class="text-xs text-text-secondary">{{ flowAlert()!.message }}</p>
            </div>
            @if (flowAlert()!.action) {
            <a [routerLink]="flowAlert()!.action!.route"
              class="text-xs font-bold text-cta-default hover:underline">
              {{ flowAlert()!.action!.label }}
            </a>
            }
          </div>
        </div>
        }
      </section>

      <!-- 2.5 BILATERAL CONFIRMATION ACTIONS -->
      <!-- 2.5 BILATERAL CONFIRMATION ACTIONS -->
      @if (isReturnPhase()) {
      <!-- CASE 1: VEHICLE RETURNED, WAITING FOR OWNER INSPECTION -->
      @if (booking()?.status === 'returned' || (booking()?.returned_at && booking()?.status ===
      'in_progress')) {
      <div class="mt-6 p-6 rounded-2xl bg-surface-secondary border border-border-default">
        <div class="flex items-center gap-4 mb-4">
          <div
            class="w-12 h-12 rounded-full bg-info-100 text-info-600 flex items-center justify-center text-2xl">
            <ion-icon name="hourglass-outline"></ion-icon>
          </div>
          <div>
            <h3 class="text-lg font-bold text-text-primary">Vehículo Devuelto</h3>
            <p class="text-sm text-text-secondary">
              Confirmado el {{ booking()?.returned_at | date: 'medium' }}
            </p>
          </div>
        </div>

        @if (isOwner()) {
        <div class="bg-warning-50 border-l-4 border-warning-500 p-4 mb-4">
          <p class="font-bold text-warning-800">Acción Requerida</p>
          <p class="text-sm text-warning-700">Debes inspeccionar el vehículo para liberar los fondos
            o reportar daños.</p>
        </div>
        <a [routerLink]="['/bookings', booking()?.id, 'owner-check-out']"
          class="block w-full py-3 text-center rounded-xl bg-cta-default text-cta-text font-bold hover:brightness-95 transition-all">
          Iniciar Inspección
        </a>
        } @else {
        <p class="text-sm text-text-muted">
          Esperando que el propietario revise el estado del vehículo. Te notificaremos cuando la
          inspección esté lista para tu revisión final.
        </p>
        }
      </div>
      }

      <!-- CASE 2: OWNER NEEDS TO CONFIRM VEHICLE RETURN (after inspection) -->
      @if (
      isOwner() &&
      (booking()?.status === 'damage_reported' || booking()?.status === 'inspected_good' ||
      booking()?.inspection_status === 'damaged' || booking()?.inspection_status === 'good') &&
      !booking()?.owner_confirmed_delivery
      ) {
      <div id="owner-confirmation-section" class="mt-6">
        <app-owner-confirmation [bookingId]="booking()!.id"
          [ownerConfirmed]="!!booking()?.owner_confirmed_delivery"
          [renterConfirmed]="!!booking()?.renter_confirmed_payment"
          (confirmed)="handleConfirmationSuccess($event)"
          (errorOccurred)="handleConfirmationError($event)"></app-owner-confirmation>
      </div>
      }

      <!-- CASE 3: RENTER NEEDS TO CONFIRM (after owner confirmed) -->
      @if (
      isRenter() &&
      (booking()?.status === 'damage_reported' || booking()?.status === 'inspected_good' ||
      booking()?.inspection_status === 'damaged' || booking()?.inspection_status === 'good') &&
      !booking()?.renter_confirmed_payment
      ) {
      <div id="renter-confirmation-section" class="mt-6">
        <app-renter-confirmation [bookingId]="booking()!.id"
          [ownerConfirmed]="!!booking()?.owner_confirmed_delivery"
          [renterConfirmed]="!!booking()?.renter_confirmed_payment"
          [damageAmount]="(booking()?.damage_amount_cents ?? 0) / 100"
          [damageDescription]="booking()?.damage_description ?? null"
          [depositAmount]="(booking()?.deposit_amount_cents ?? 0) / 100"
          [checkInPhotos]="checkInPhotos()" [checkOutPhotos]="checkOutPhotos()"
          (confirmed)="handleConfirmationSuccess($event)"
          (errorOccurred)="handleConfirmationError($event)"></app-renter-confirmation>
      </div>
      }
      }

      <!-- 3. CHECK-IN CRITICAL INFO CARD (Extracted Component) -->
      <app-booking-check-in-info-card [booking]="booking()!" />

      <!-- 4. LOGISTICS CARD (Delivery/Dropoff info) -->
      @if (booking()?.delivery_required || booking()?.dropoff_location_lat) {
      <section class="card-premium overflow-hidden p-0">
        <div
          class="px-5 py-3 border-b border-border-default bg-surface-secondary/50 flex justify-between items-center">
          <h3 class="text-sm font-bold text-text-primary flex items-center gap-2">
            <ion-icon name="swap-horizontal-outline" class="text-info-500"></ion-icon>
            Devolución
          </h3>
          @if (booking()?.delivery_fee_cents) {
          <span
            class="text-[10px] font-bold bg-success-50 text-success-700 px-2 py-0.5 rounded-full border border-success-200">
            Delivery Incluido
          </span>
          }
        </div>

        <div class="p-5">
          <div class="flex items-start gap-4">
            <div
              class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center shrink-0">
              <ion-icon name="flag" class="text-text-secondary"></ion-icon>
            </div>
            <div class="flex-1">
              <p class="text-[10px] uppercase font-bold text-text-muted tracking-wider mb-1">
                Punto de Devolución
              </p>
              <p class="text-sm font-medium text-text-primary mb-1">
                @if (booking()?.dropoff_location_lat) {
                {{ booking()!.dropoff_location_lat?.toFixed(6) }},
                {{ booking()!.dropoff_location_lng?.toFixed(6) }}
                } @else {
                Mismo punto de retiro
                }
              </p>
              <p class="text-xs text-text-secondary">
                {{ booking()!.end_at | date: 'EEEE d MMMM, HH:mm' }} hs
              </p>
            </div>
          </div>
        </div>
      </section>
      }

      <!-- 4. Pricing & Insurance Breakdown -->
      @if (pricingView() || insuranceView()) {
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        @if (pricingView()) {
        <div class="card-premium p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center text-text-secondary">
              <ion-icon name="receipt-outline" class="text-xl"></ion-icon>
            </div>
            <h3 class="font-bold text-text-primary">Desglose de Precio</h3>
          </div>
          <app-booking-pricing-breakdown [data]="pricingView()!"></app-booking-pricing-breakdown>
        </div>
        }

        @if (insuranceView()) {
        <div class="card-premium p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center text-text-secondary">
              <ion-icon name="shield-checkmark-outline" class="text-xl"></ion-icon>
            </div>
            <h3 class="font-bold text-text-primary">Cobertura y Garantía</h3>
          </div>
          <app-booking-insurance-summary [data]="insuranceView()!"></app-booking-insurance-summary>
        </div>
        }
      </section>
      }

      <!-- 5. Tracking (if active) -->
      @if (tracking()) {
      <section class="card-premium p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center text-text-secondary">
            <ion-icon name="map-outline" class="text-xl"></ion-icon>
          </div>
          <h3 class="font-bold text-text-primary">Tracking GPS</h3>
        </div>
        <app-booking-tracking [session]="tracking()"></app-booking-tracking>
      </section>
      }

      <!-- 6. Operations Timeline -->
      @if (confirmation() || cancellation()) {
      <section class="card-premium p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center text-text-secondary">
            <ion-icon name="time-outline" class="text-xl"></ion-icon>
          </div>
          <h3 class="font-bold text-text-primary">Historial de Operaciones</h3>
        </div>
        <app-booking-ops-timeline [data]="{
          payment_date: payment()?.paid_at ?? null,
          payment_note: null,
          pickup_confirmed_at: confirmation()?.pickup_confirmed_at ?? null,
          dropoff_confirmed_at: confirmation()?.dropoff_confirmed_at ?? null,
          owner_confirmed_at: confirmation()?.owner_confirmed_at ?? null,
          renter_confirmed_at: confirmation()?.renter_confirmed_at ?? null,
          returned_at: booking()?.returned_at ?? null,
          funds_released_at: confirmation()?.funds_released_at ?? null,
          cancelled_at: cancellation()?.cancelled_at ?? null,
          cancellation_reason: cancellation()?.cancellation_reason ?? null,
          cancellation_fee_cents: cancellation()?.cancellation_fee_cents ?? null,
          cancelled_by_role: cancellation()?.cancelled_by_role ?? null
        }"></app-booking-ops-timeline>
      </section>
      }

      <!-- 7. Documentation (Compact Grid) -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Contract Card -->
        <div class="card-premium p-6 flex flex-col h-full">
          <div class="flex items-center gap-3 mb-4">
            <div
              class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center text-text-secondary">
              <ion-icon name="document-text-outline" class="text-xl"></ion-icon>
            </div>
            <h3 class="font-bold text-text-primary">Contrato Digital</h3>
          </div>
          <div class="flex-1">
            <app-booking-contract [bookingId]="booking()!.id"></app-booking-contract>
          </div>
        </div>

        <!-- Refund Status / Insurance -->
        <div class="card-premium p-6 flex flex-col h-full">
          <div class="flex items-center gap-3 mb-4">
            <div
              class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center text-text-secondary">
              <ion-icon name="shield-checkmark-outline" class="text-xl"></ion-icon>
            </div>
            <h3 class="font-bold text-text-primary">Estado de Garantía</h3>
          </div>
          <div class="flex-1">
            <app-refund-status [bookingId]="booking()!.id"></app-refund-status>
          </div>
        </div>
      </section>

      <!-- 4. Extensions Manager (Extracted Component) -->
      <app-booking-extensions-manager
        [booking]="booking()!"
        [isOwner]="isOwner()"
        [isRenter]="isRenter()"
        (bookingUpdated)="booking.set($event)"
      />

      <!-- 5. Traffic Fines Manager (Extracted Component) -->
      <app-booking-traffic-fines-manager
        [booking]="booking()!"
        [isOwner]="isOwner()"
        [isRenter]="isRenter()"
        (reportFineClicked)="showReportTrafficFineModal.set(true)"
        (finesUpdated)="trafficFines.set($event)"
      />

      <!-- 6. Damage & Disputes (Conditional) -->
      @if (hasClaim() || canReportClaim() || isOwner()) {
      <section class="space-y-6">
        <div class="flex items-center justify-between px-1">
          <h2 class="text-lg font-bold text-text-primary">Gestión de Incidentes</h2>
        </div>

        <!-- Damage Comparison (if inspections exist) -->
        @if (hasOwnerCheckIn() && hasCheckOut()) {
        <div class="card-premium p-6">
          <h3 class="font-bold text-text-primary mb-4 flex items-center gap-2">
            <ion-icon name="git-compare-outline" class="text-info-600"></ion-icon>
            Comparativa de Daños
          </h3>
          <app-damage-comparison [bookingId]="booking()!.id"></app-damage-comparison>
        </div>
        }

        <!-- Claims List -->
        @if (hasClaim()) {
        <div class="card-premium p-6">
          <h3 class="font-bold text-text-primary mb-4 text-error-600 flex items-center gap-2">
            <ion-icon name="warning-outline"></ion-icon>
            Siniestros Reportados
          </h3>
          <!-- Simple list of existing claims -->
          @for (claim of bookingClaims(); track claim.id) {
          <div
            class="p-4 rounded-xl bg-surface-secondary border border-border-default mb-3 last:mb-0">
            <div class="flex justify-between items-start">
              <div>
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-surface-raised border border-border-default text-text-primary mb-2">
                  {{ getClaimStatusLabel(claim.status) }}
                </span>
                <p class="font-medium text-text-primary">{{ claim.description }}</p>
                <p class="text-sm text-text-secondary mt-1">
                  Reportado el {{ claim.created_at | date: 'mediumDate' }}
                </p>
              </div>
              <ion-icon name="chevron-forward" class="text-text-muted"></ion-icon>
            </div>
          </div>
          }
        </div>
        }

        <!-- Action Buttons for Reporting -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          @if (canReportDamage()) {
          <a [routerLink]="['/bookings', booking()!.id, 'owner-damage-report']"
            class="flex items-center justify-center gap-2 p-4 rounded-2xl border-2 border-dashed border-border-muted hover:border-error-400 hover:bg-error-50 text-text-secondary hover:text-error-700 transition-all group cursor-pointer">
            <ion-icon name="alert-circle-outline"
              class="text-2xl group-hover:scale-110 transition-transform"></ion-icon>
            <span class="font-semibold">Reportar Daños</span>
          </a>
          }

          @if (canReportClaim()) {
          <a [routerLink]="['/bookings', booking()!.id, 'report-claim']"
            class="flex items-center justify-center gap-2 p-4 rounded-2xl border-2 border-dashed border-border-muted hover:border-error-400 hover:bg-error-50 text-text-secondary hover:text-error-700 transition-all group cursor-pointer">
            <ion-icon name="car-sport-outline"
              class="text-2xl group-hover:scale-110 transition-transform"></ion-icon>
            <span class="font-semibold">Reportar Siniestro</span>
          </a>
          }
        </div>

        <!-- Disputes List -->
        <div class="card-premium p-6">
          <h3 class="font-bold text-text-primary mb-4 flex items-center gap-2">
            <ion-icon name="flag-outline" class="text-warning-600"></ion-icon>
            Disputas
          </h3>
          <app-disputes-list
            [bookingId]="booking()!.id"
            [showCreateButton]="canCreateDispute()"
            (createDispute)="showDisputeForm.set(true)">
          </app-disputes-list>
        </div>

        <!-- Settlement Simulator (Owner Only) -->
        @if (isOwner() && (booking()?.status === 'completed' || isReturnPhase())) {
        <div class="card-premium p-6">
          <h3 class="font-bold text-text-primary mb-4 flex items-center gap-2">
            <ion-icon name="calculator-outline" class="text-info-600"></ion-icon>
            Simulador de Liquidación
          </h3>
          <app-settlement-simulator [bookingId]="booking()!.id"></app-settlement-simulator>
        </div>
        }
      </section>
      }
    </div>

    <!-- ============================================================================================== -->
    <!-- RIGHT COLUMN (ACTIONS & PAYMENTS) - Span 4 -->
    <!-- ============================================================================================== -->
    <div class="lg:col-span-4 space-y-6">
      <!-- 1. STICKY ACTION CARD -->
      <div class="sticky top-6 z-10 space-y-6">
        <!-- Primary Action Card (Extracted Component) -->
        <app-booking-actions-card
          [booking]="booking()!"
          [isOwner]="isOwner()"
          [isRenter]="isRenter()"
          [needsPayment]="needsPayment()"
          [canApproveBooking]="canApproveBooking()"
          [canPerformCheckIn]="canPerformCheckIn()"
          [canPerformCheckOut]="canPerformCheckOut()"
          [canOwnerCheckIn]="canOwnerCheckIn()"
          [canOwnerCheckOut]="canOwnerCheckOut()"
          [canOwnerCancel]="canOwnerCancel()"
          (chatOpen)="openChatPanel()"
          (cancelBooking)="cancelBooking($event)"
          (ownerCancelBooking)="ownerCancelBooking()"
          (approveBooking)="approveBooking()"
          (rejectBooking)="rejectBooking()"
        />

        <!-- 2. AI Tools Panel -->
        <div class="card-premium overflow-hidden p-0">
          <div class="p-4 border-b border-border-default bg-surface-secondary">
            <h3 class="font-bold text-info-900 flex items-center gap-2">
              <ion-icon name="sparkles" class="text-info-500"></ion-icon>
              Asistente IA
            </h3>
          </div>

          <app-ai-legal-panel [booking]="booking()!" [isExpanded]="expandedAiPanel() === 'legal'"
            (togglePanel)="toggleAiPanel('legal')" />

          @if (showTripPlanner()) {
          <app-ai-trip-panel [booking]="booking()!" [isExpanded]="expandedAiPanel() === 'trip'"
            (togglePanel)="toggleAiPanel('trip')" />
          }

          @if (showChecklistPanel()) {
          <app-ai-checklist-panel [booking]="booking()!"
            [inspectionType]="checklistInspectionType()"
            [isExpanded]="expandedAiPanel() === 'checklist'"
            (togglePanel)="toggleAiPanel('checklist')" />
          }
        </div>

        <!-- 3. Reviews (If Completed) -->
        @if (booking()?.status === 'completed') {
        <app-review-management [booking]="booking()!"></app-review-management>
        }
      </div>
    </div>
  </div>
  }
</div>

<!-- ============================================================================================== -->
<!-- MODALS & SIDE PANELS -->
<!-- ============================================================================================== -->

<!-- Chat Side Panel -->
@if (booking()) {
<app-side-panel [isOpen]="chatPanelOpen()"
  [title]="'Chat con ' + (isOwner() ? 'Viajero' : 'Anfitrión')" width="min(450px, 100vw)"
  (closed)="closeChatPanel()">
  @if (carOwnerId()) {
  <app-booking-chat [bookingId]="booking()!.id"
    [recipientId]="isOwner() ? booking()!.renter_id : carOwnerId()!"
    [recipientName]="isOwner() ? booking()!.renter_name || 'Viajero' : carOwnerName()"
    [booking]="booking()" class="h-full"></app-booking-chat>
  }
</app-side-panel>
}

<!-- Feature Modals -->
@defer (when showDisputeForm()) {
<app-dispute-form [isOpen]="showDisputeForm()" [bookingId]="booking()!.id"
  (closeModal)="showDisputeForm.set(false)"
  (disputeCreated)="onDisputeCreated()"></app-dispute-form>
}

@defer (when showRefundForm()) {
<app-refund-request [isOpen]="showRefundForm()" [bookingId]="booking()!.id"
  (closeModal)="showRefundForm.set(false)"
  (refundRequested)="onRefundRequested()"></app-refund-request>
}

@defer (when showReportTrafficFineModal()) {
<app-report-traffic-fine [isOpen]="showReportTrafficFineModal()" [booking]="booking()!"
  (closeModal)="showReportTrafficFineModal.set(false)"
  (fineReported)="onTrafficFineReported($event)"></app-report-traffic-fine>
}

@defer (when showReportOwnerNoShowModal()) {
<app-report-owner-no-show [isOpen]="showReportOwnerNoShowModal()" [booking]="booking()!"
  (closeModal)="showReportOwnerNoShowModal.set(false)"
  (noShowReported)="onOwnerNoShowReported($event)"></app-report-owner-no-show>
}

@defer (when showReportRenterNoShowModal()) {
<app-report-renter-no-show [isOpen]="showReportRenterNoShowModal()" [booking]="booking()!"
  (closeModal)="showReportRenterNoShowModal.set(false)"
  (noShowReported)="onRenterNoShowReported($event)"></app-report-renter-no-show>
}
