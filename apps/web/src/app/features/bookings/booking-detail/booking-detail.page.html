<div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 font-sans text-text-primary">
  <!-- Loading State -->
  @if (loading()) {
    <div class="flex flex-col items-center justify-center py-20 space-y-4">
      <div class="w-12 h-12 border-4 border-surface-secondary border-t-cta-default rounded-full animate-spin"></div>
      <p class="text-text-secondary font-medium animate-pulse">Cargando detalles de la reserva...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !loading()) {
    <app-error-state
      title="No pudimos cargar la reserva"
      [message]="error() ?? 'Ocurrió un error inesperado al conectar con el servidor.'"
      variant="banner">
      <button
        [routerLink]="backLink()"
        class="mt-4 px-6 py-2.5 bg-surface-inverse text-text-inverse rounded-xl hover:bg-surface-inverse/90 transition-colors font-medium text-sm flex items-center gap-2 mx-auto">
        <ion-icon name="arrow-back-outline"></ion-icon>
        {{ backLabel() }}
      </button>
    </app-error-state>
  }

  <!-- Main Content -->
  @if (booking() && !loading()) {
    <!-- Breadcrumb / Back Navigation -->
    <nav class="mb-6 flex items-center justify-between">
      <button
        [routerLink]="backLink()"
        class="group inline-flex items-center gap-2 text-sm font-medium text-text-secondary hover:text-text-primary transition-colors"
      >
        <div class="w-8 h-8 rounded-full bg-surface-secondary flex items-center justify-center group-hover:bg-surface-hover transition-colors">
          <ion-icon name="arrow-back" class="text-lg"></ion-icon>
        </div>
        <span>{{ backLabel() }}</span>
      </button>
      
      <div class="text-xs text-text-muted font-mono">
        ID: {{ booking()!.id.slice(0, 8) }}
      </div>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- ============================================================================================== -->
      <!-- LEFT COLUMN (CONTEXT & HISTORY) - Span 8 -->
      <!-- ============================================================================================== -->
      <div class="lg:col-span-8 space-y-6">
        
        <!-- 1. COMPACT HERO: Car & Key Stats -->
        <section class="card-premium p-0 flex flex-col sm:flex-row overflow-hidden">
          <!-- Image Section (35%) -->
          <div class="relative sm:w-1/3 h-48 sm:h-auto bg-surface-secondary">
            @if (booking()?.car_image) {
              <img 
                [src]="booking()!.car_image" 
                [alt]="booking()?.car_title" 
                class="w-full h-full object-cover"
              />
              <!-- Status Overlay -->
              <div class="absolute top-3 left-3">
                 <span class="px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-widest bg-surface-inverse/90 text-text-inverse backdrop-blur-sm shadow-sm border border-white/10">
                  {{ booking()?.status === 'in_progress' ? 'En Curso' : (booking()?.status | uppercase) }}
                </span>
              </div>
            } @else {
              <div class="w-full h-full flex items-center justify-center text-text-muted">
                <ion-icon name="car-sport-outline" class="text-4xl"></ion-icon>
              </div>
            }
          </div>

          <!-- Info Section (65%) -->
          <div class="flex-1 p-5 flex flex-col justify-between">
            <div>
              <div class="flex justify-between items-start mb-2">
                <h1 class="text-xl sm:text-2xl font-bold text-text-primary tracking-tight leading-none font-satoshi">
                  {{ booking()?.car_brand }} {{ booking()?.car_model }}
                  <span class="text-text-muted font-normal ml-1">{{ booking()?.car_year }}</span>
                </h1>
                <!-- Price Tag -->
                <div class="text-right">
                  <p class="text-lg font-bold text-text-primary leading-none">
                    {{ (booking()!.total_amount) | currency:booking()!.currency:'symbol':'1.0-0' }}
                  </p>
                  <p class="text-[10px] text-text-muted font-medium uppercase tracking-wide">Total</p>
                </div>
              </div>
              
              <!-- Owner info tiny -->
              <div class="flex items-center gap-2 text-sm text-text-secondary mb-4">
                <div class="w-5 h-5 rounded-full bg-surface-secondary flex items-center justify-center text-[10px] font-bold text-text-secondary">
                   {{ carOwnerName().charAt(0) }}
                </div>
                <span>{{ carOwnerName() }}</span>
              </div>
            </div>

            <!-- Dashboard Stats Grid -->
            <div class="grid grid-cols-3 gap-2 border-t border-border-default pt-4">
              <div>
                <p class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-0.5">Inicio</p>
                <p class="text-sm font-semibold text-text-primary">{{ booking()!.start_at | date:'dd MMM, HH:mm' }}</p>
              </div>
              <div>
                <p class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-0.5">Fin</p>
                <p class="text-sm font-semibold text-text-primary">{{ booking()!.end_at | date:'dd MMM, HH:mm' }}</p>
              </div>
              <div>
                <p class="text-[10px] text-text-muted uppercase font-bold tracking-wider mb-0.5">Tiempo</p>
                <p class="text-sm font-semibold text-text-primary flex items-center gap-1">
                  {{ booking()!.days_count }} días
                  @if (deliveryTimeRemaining()) {
                    <span class="text-[10px] text-info-700 bg-info-50 px-1.5 py-0.5 rounded-full">{{ deliveryTimeRemaining() }}</span>
                  }
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- 2. Timeline Bar (Slim) -->
        <section class="card-premium p-6">
          <app-booking-confirmation-timeline
            [booking]="booking()!"
            [ownerName]="carOwnerName()"
            [renterName]="booking()?.renter_name ?? 'el locatario'"
            (confirmationRequested)="handleTimelineAction($event)"
          ></app-booking-confirmation-timeline>
           
           <!-- URGENT ACTION: Guarantee Required -->
           @if ((needsPayment() || booking()?.status === 'pending_payment') && isRenter()) {
            <div class="mt-6 p-5 rounded-2xl bg-gradient-to-r from-cta-default to-cta-hover text-cta-text shadow-xl animate-pulse">
              <div class="flex items-center justify-between gap-4">
                <div class="flex-1">
                  <h3 class="text-base font-bold flex items-center gap-2">
                    <ion-icon name="alert-circle" class="text-xl"></ion-icon>
                    Acción Requerida
                  </h3>
                  <p class="text-sm opacity-90">Tu reserva está pausada. Debes garantizar la garantía para avanzar.</p>
                </div>
                <a [routerLink]="['/bookings', booking()?.id, 'detail-payment']" 
                   class="px-6 py-3 bg-white text-cta-default font-bold rounded-xl shadow-lg hover:bg-opacity-90 transition-all whitespace-nowrap">
                  Garantizar Ahora
                </a>
              </div>
            </div>
           }
           
           <!-- Alerts integrated efficiently -->
           @if (flowAlert()) {
            <div class="mt-4 pt-4 border-t border-border-default">
              <div class="flex items-start gap-3">
                 <ion-icon [name]="flowAlert()!.tone === 'danger' ? 'alert-circle' : 'information-circle'" 
                   [class]="flowAlert()!.tone === 'danger' ? 'text-error-500' : 'text-info-500'" 
                   class="mt-0.5"></ion-icon>
                 <div class="flex-1">
                   <p class="text-sm font-medium text-text-primary">{{ flowAlert()!.title }}</p>
                   <p class="text-xs text-text-secondary">{{ flowAlert()!.message }}</p>
                 </div>
                 @if (flowAlert()!.action) {
                    <a [routerLink]="flowAlert()!.action!.route" class="text-xs font-bold text-cta-default hover:underline">
                      {{ flowAlert()!.action!.label }}
                    </a>
                  }
              </div>
            </div>
           }
        </section>

        <!-- 3. CHECK-IN CRITICAL INFO CARD -->
        @if (booking()?.status === 'confirmed' || booking()?.status === 'in_progress') {
          <section class="bg-surface-inverse text-text-inverse rounded-2xl shadow-xl overflow-hidden">
            <!-- Header -->
            <div class="px-5 py-4 border-b border-white/10 flex justify-between items-center">
              <h3 class="text-base font-bold flex items-center gap-2 text-text-inverse">
                <ion-icon name="location" class="text-xl"></ion-icon>
                Información de Check-in
              </h3>
              <!-- Car Ready Status -->
              <div class="flex items-center gap-2">
                @if (booking()?.owner_confirmed_delivery) {
                  <span class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-success-500/20 border border-success-400/30 text-success-300 text-xs font-bold">
                    <span class="w-2 h-2 rounded-full bg-success-400 animate-pulse"></span>
                    Auto Listo
                  </span>
                } @else {
                  <span class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-warning-500/20 border border-warning-400/30 text-warning-300 text-xs font-bold">
                    <span class="w-2 h-2 rounded-full bg-warning-400"></span>
                    Preparando
                  </span>
                }
              </div>
            </div>

            <div class="p-5 space-y-5">
              <!-- Fecha y Hora Prominente -->
              <div class="bg-white/10 backdrop-blur rounded-xl p-4 border border-white/10">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-text-inverse/70 font-semibold uppercase tracking-wider mb-1">Fecha y Hora de Retiro</p>
                    <p class="text-2xl font-bold text-text-inverse">{{ booking()!.start_at | date:'EEEE d MMMM' }}</p>
                    <p class="text-3xl font-black tracking-tight text-text-inverse">{{ booking()!.start_at | date:'HH:mm' }} hs</p>
                  </div>
                  <div class="text-right">
                    <ion-icon name="calendar" class="text-5xl text-white/30"></ion-icon>
                  </div>
                </div>
              </div>

              <!-- Coordenadas con Navegación -->
              <div class="bg-white/10 backdrop-blur rounded-xl p-4 border border-white/10">
                <p class="text-xs text-text-inverse/70 font-semibold uppercase tracking-wider mb-3">Punto de Encuentro</p>

                @if (booking()?.pickup_location_lat && booking()?.pickup_location_lng) {
                  <!-- Usar coordenadas específicas del pickup -->
                  <p class="text-sm font-medium mb-4 text-text-inverse/90">
                    {{ booking()!.pickup_location_lat?.toFixed(6) }}, {{ booking()!.pickup_location_lng?.toFixed(6) }}
                  </p>

                  <div class="flex gap-3">
                    <a
                      [href]="'https://www.google.com/maps/dir/?api=1&destination=' + booking()!.pickup_location_lat + ',' + booking()!.pickup_location_lng"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-surface-base text-text-primary font-bold text-sm hover:bg-surface-hover transition-all active:scale-[0.98] shadow-lg">
                      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                      </svg>
                      Google Maps
                    </a>
                    <a
                      [href]="'https://waze.com/ul?ll=' + booking()!.pickup_location_lat + ',' + booking()!.pickup_location_lng + '&navigate=yes'"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-info-400 text-black font-bold text-sm hover:bg-info-300 transition-all active:scale-[0.98] shadow-lg">
                      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.54 6.63c.69 2.24.46 4.27-.46 6.13-.67 1.36-1.62 2.49-2.82 3.42-.43.33-.88.63-1.36.89.05.58.01 1.16-.12 1.73-.18.78-.53 1.5-1.03 2.13-.37.47-.81.88-1.31 1.22-.1.07-.22.07-.32 0-.1-.07-.14-.19-.1-.3.22-.57.35-1.18.38-1.79-1.27.24-2.59.18-3.84-.19-1.72-.51-3.17-1.51-4.28-2.93-.98-1.25-1.59-2.68-1.8-4.27-.14-1.1-.08-2.19.19-3.26.34-1.35.96-2.56 1.84-3.61 1.1-1.31 2.47-2.29 4.09-2.89 1.35-.5 2.76-.68 4.2-.53 1.56.16 2.99.66 4.27 1.51 1.2.79 2.18 1.81 2.93 3.02.18.29.33.59.54.99zM12 9c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-4 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm8 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/>
                      </svg>
                      Waze
                    </a>
                  </div>
                } @else {
                  <div class="flex items-center gap-3 text-text-inverse/70">
                    <ion-icon name="location-outline" class="text-2xl"></ion-icon>
                    <span class="text-sm">Ubicación no disponible</span>
                  </div>
                }
              </div>

              <!-- Documentos Físicos Requeridos (PROMINENTE) -->
              <div class="bg-warning-500/20 backdrop-blur rounded-xl p-4 border border-warning-400/30">
                <div class="flex items-start gap-3">
                  <div class="w-10 h-10 rounded-full bg-warning-500/30 flex items-center justify-center shrink-0">
                    <ion-icon name="warning" class="text-xl text-warning-300"></ion-icon>
                  </div>
                  <div>
                    <p class="text-sm font-bold text-warning-200 mb-2">Documentos Físicos Obligatorios</p>
                    <p class="text-xs text-text-inverse/80 mb-3">
                      Aunque la App verificó tu identidad, legalmente debes mostrar los documentos físicos al dueño.
                    </p>
                    <div class="grid grid-cols-2 gap-2">
                      <div class="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-2">
                        <ion-icon name="id-card" class="text-warning-300"></ion-icon>
                        <span class="text-xs font-semibold text-text-inverse">DNI Físico</span>
                      </div>
                      <div class="flex items-center gap-2 bg-white/10 rounded-lg px-3 py-2">
                        <ion-icon name="car" class="text-warning-300"></ion-icon>
                        <span class="text-xs font-semibold text-text-inverse">Carnet Físico</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        }

        <!-- 4. LOGISTICS CARD (Delivery/Dropoff info) -->
        @if (booking()?.delivery_required || booking()?.dropoff_location_lat) {
          <section class="card-premium overflow-hidden p-0">
            <div class="px-5 py-3 border-b border-border-default bg-surface-secondary/50 flex justify-between items-center">
              <h3 class="text-sm font-bold text-text-primary flex items-center gap-2">
                <ion-icon name="swap-horizontal-outline" class="text-info-500"></ion-icon>
                Devolución
              </h3>
              @if (booking()?.delivery_fee_cents) {
                <span class="text-[10px] font-bold bg-success-50 text-success-700 px-2 py-0.5 rounded-full border border-success-200">
                  Delivery Incluido
                </span>
              }
            </div>

            <div class="p-5">
              <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center shrink-0">
                  <ion-icon name="flag" class="text-text-secondary"></ion-icon>
                </div>
                <div class="flex-1">
                  <p class="text-[10px] uppercase font-bold text-text-muted tracking-wider mb-1">Punto de Devolución</p>
                  <p class="text-sm font-medium text-text-primary mb-1">
                    @if (booking()?.dropoff_location_lat) {
                      {{ booking()!.dropoff_location_lat?.toFixed(6) }}, {{ booking()!.dropoff_location_lng?.toFixed(6) }}
                    } @else {
                      Mismo punto de retiro
                    }
                  </p>
                  <p class="text-xs text-text-secondary">
                    {{ booking()!.end_at | date:'EEEE d MMMM, HH:mm' }} hs
                  </p>
                </div>
              </div>
            </div>
          </section>
        }

        <!-- 4. Documentation (Compact Grid) -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Contract Card -->
          <div class="card-premium p-6 flex flex-col h-full">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center text-text-secondary">
                <ion-icon name="document-text-outline" class="text-xl"></ion-icon>
              </div>
              <h3 class="font-bold text-text-primary">Contrato Digital</h3>
            </div>
            <div class="flex-1">
              <app-booking-contract [bookingId]="booking()!.id"></app-booking-contract>
            </div>
          </div>

          <!-- Refund Status / Insurance -->
          <div class="card-premium p-6 flex flex-col h-full">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-full bg-surface-secondary flex items-center justify-center text-text-secondary">
                <ion-icon name="shield-checkmark-outline" class="text-xl"></ion-icon>
              </div>
              <h3 class="font-bold text-text-primary">Estado de Garantía</h3>
            </div>
            <div class="flex-1">
              <app-refund-status [bookingId]="booking()!.id"></app-refund-status>
            </div>
          </div>
        </section>

        <!-- 4. Damage & Disputes (Conditional) -->
        @if (hasClaim() || canReportClaim() || isOwner()) {
          <section class="space-y-6">
            <div class="flex items-center justify-between px-1">
              <h2 class="text-lg font-bold text-text-primary">Gestión de Incidentes</h2>
            </div>

            <!-- Damage Comparison (if inspections exist) -->
            @if (hasOwnerCheckIn() && hasCheckOut()) {
              <div class="card-premium p-6">
                <h3 class="font-bold text-text-primary mb-4 flex items-center gap-2">
                  <ion-icon name="git-compare-outline" class="text-info-600"></ion-icon>
                  Comparativa de Daños
                </h3>
                <app-damage-comparison [bookingId]="booking()!.id"></app-damage-comparison>
              </div>
            }

            <!-- Claims List -->
            @if (hasClaim()) {
              <div class="card-premium p-6">
                <h3 class="font-bold text-text-primary mb-4 text-error-600 flex items-center gap-2">
                  <ion-icon name="warning-outline"></ion-icon>
                  Siniestros Reportados
                </h3>
                <!-- Simple list of existing claims -->
                @for (claim of bookingClaims(); track claim.id) {
                  <div class="p-4 rounded-xl bg-surface-secondary border border-border-default mb-3 last:mb-0">
                    <div class="flex justify-between items-start">
                      <div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-surface-raised border border-border-default text-text-primary mb-2">
                          {{ getClaimStatusLabel(claim.status) }}
                        </span>
                        <p class="font-medium text-text-primary">{{ claim.description }}</p>
                        <p class="text-sm text-text-secondary mt-1">Reportado el {{ claim.created_at | date:'mediumDate' }}</p>
                      </div>
                      <ion-icon name="chevron-forward" class="text-text-muted"></ion-icon>
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Action Buttons for Reporting -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              @if (canReportDamage()) {
                <a [routerLink]="['/bookings', booking()!.id, 'owner-damage-report']"
                   class="flex items-center justify-center gap-2 p-4 rounded-2xl border-2 border-dashed border-border-muted hover:border-error-400 hover:bg-error-50 text-text-secondary hover:text-error-700 transition-all group cursor-pointer">
                  <ion-icon name="alert-circle-outline" class="text-2xl group-hover:scale-110 transition-transform"></ion-icon>
                  <span class="font-semibold">Reportar Daños</span>
                </a>
              }
              
              @if (canReportClaim()) {
                <a [routerLink]="['/bookings', booking()!.id, 'report-claim']"
                   class="flex items-center justify-center gap-2 p-4 rounded-2xl border-2 border-dashed border-border-muted hover:border-error-400 hover:bg-error-50 text-text-secondary hover:text-error-700 transition-all group cursor-pointer">
                  <ion-icon name="car-sport-outline" class="text-2xl group-hover:scale-110 transition-transform"></ion-icon>
                  <span class="font-semibold">Reportar Siniestro</span>
                </a>
              }

              @if (canReportTrafficFine()) {
                <button (click)="showReportTrafficFineModal.set(true)"
                   class="flex items-center justify-center gap-2 p-4 rounded-2xl border-2 border-dashed border-border-muted hover:border-warning-400 hover:bg-warning-50 text-text-secondary hover:text-warning-700 transition-all group cursor-pointer">
                  <ion-icon name="receipt-outline" class="text-2xl group-hover:scale-110 transition-transform"></ion-icon>
                  <span class="font-semibold">Reportar Multa</span>
                </button>
              }
            </div>
          </section>
        }

      </div>

      <!-- ============================================================================================== -->
      <!-- RIGHT COLUMN (ACTIONS & PAYMENTS) - Span 4 -->
      <!-- ============================================================================================== -->
      <div class="lg:col-span-4 space-y-6">
        
        <!-- 1. STICKY ACTION CARD -->
        <div class="sticky top-6 z-10 space-y-6">
          
          <!-- Primary Action Card -->
          <div class="card-premium p-0 overflow-hidden">
            <div class="p-6">
              <h3 class="text-sm font-bold text-text-muted uppercase tracking-wider mb-4">Gestión</h3>
              
              <!-- Contact Button (Primary Communication) -->
              <button 
                (click)="openChatPanel()"
                class="w-full flex items-center justify-center gap-3 p-4 mb-4 rounded-2xl bg-cta-default text-cta-text font-bold text-lg hover:bg-cta-hover active:scale-[0.98] transition-all shadow-md">
                <ion-icon name="chatbubble-ellipses-outline" class="text-2xl"></ion-icon>
                Chat con {{ isOwner() ? 'Viajero' : 'Anfitrión' }}
              </button>

              <!-- Contextual Action Buttons -->
              <div class="space-y-3">

                <!-- Primary Payment/Guarantee Action (Viajero) -->
                @if ((needsPayment() || booking()?.status === 'pending_payment') && isRenter()) {
                  <a [routerLink]="['/bookings', booking()?.id, 'detail-payment']"
                     class="w-full flex items-center justify-between p-4 rounded-xl bg-cta-default text-cta-text hover:bg-cta-hover transition-all shadow-lg transform hover:scale-[1.02] active:scale-95 border-2 border-white/20">
                    <span class="font-bold flex items-center gap-2">
                      <ion-icon name="shield-checkmark-outline"></ion-icon>
                      Garantizar Reserva Ahora
                    </span>
                    <ion-icon name="arrow-forward"></ion-icon>
                  </a>
                  <p class="text-[10px] text-center text-text-muted mt-2">
                    Debes garantizar la reserva para que el anfitrión pueda aprobarla.
                  </p>
                }

                <!-- Waiting for Contribution (Anfitrión) -->
                @if (booking()?.status === 'pending_payment' && isOwner()) {
                  <div class="w-full flex items-center gap-3 p-4 rounded-xl bg-warning-50 text-warning-700 border border-warning-200">
                    <ion-icon name="time-outline" class="text-2xl text-warning-500"></ion-icon>
                    <span class="font-medium">Esperando contribución del viajero</span>
                  </div>
                }

                <!-- Approve/Reject (Owner) -->
                @if (canApproveBooking()) {
                  <div class="grid grid-cols-2 gap-3">
                    <button (click)="rejectBooking()" class="px-4 py-3 rounded-xl border border-border-default text-text-secondary font-semibold hover:bg-surface-secondary transition-colors">
                      Rechazar
                    </button>
                    <button (click)="approveBooking()" class="px-4 py-3 rounded-xl bg-success-600 text-white font-semibold hover:bg-success-700 transition-colors shadow-sm">
                      Aprobar
                    </button>
                  </div>
                }

                <!-- Check-in Action -->
                @if (canPerformCheckIn()) {
                  <a [routerLink]="['/bookings', booking()?.id, 'check-in']"
                     class="w-full flex items-center justify-between p-4 rounded-xl bg-success-50 text-success-900 hover:bg-success-100 transition-colors border border-success-200">
                    <span class="font-semibold flex items-center gap-2">
                      <ion-icon name="checkmark-done-outline"></ion-icon>
                      Iniciar Check-in
                    </span>
                    <ion-icon name="arrow-forward"></ion-icon>
                  </a>
                }

                <!-- Check-out Action (Renter) -->
                @if (canPerformCheckOut()) {
                  <a [routerLink]="['/bookings', booking()?.id, 'check-out']"
                     class="w-full flex items-center justify-between p-4 rounded-xl bg-info-50 text-info-900 hover:bg-info-100 transition-colors border border-info-200">
                    <span class="font-semibold flex items-center gap-2">
                      <ion-icon name="flag-outline"></ion-icon>
                      Finalizar Viaje
                    </span>
                    <ion-icon name="arrow-forward"></ion-icon>
                  </a>
                }

                <!-- Owner Check-in Action -->
                @if (canOwnerCheckIn()) {
                  <a [routerLink]="['/bookings', booking()?.id, 'owner-check-in']"
                     class="w-full flex items-center justify-between p-4 rounded-xl bg-warning-50 text-warning-900 hover:bg-warning-100 transition-colors border border-warning-200">
                    <span class="font-semibold flex items-center gap-2">
                      <ion-icon name="car-outline"></ion-icon>
                      Iniciar Entrega del Vehículo
                    </span>
                    <ion-icon name="arrow-forward"></ion-icon>
                  </a>
                }

                <!-- Owner Check-out Action -->
                @if (canOwnerCheckOut()) {
                  <a [routerLink]="['/bookings', booking()?.id, 'owner-check-out']"
                     class="w-full flex items-center justify-between p-4 rounded-xl bg-info-50 text-info-900 hover:bg-info-100 transition-colors border border-info-200">
                    <span class="font-semibold flex items-center gap-2">
                      <ion-icon name="checkmark-done-outline"></ion-icon>
                      Confirmar Devolución
                    </span>
                    <ion-icon name="arrow-forward"></ion-icon>
                  </a>
                }

                <!-- Cancel Button -->
                @if (canOwnerCancel() || (isRenter() && booking()?.status === 'pending')) {
                  <button 
                    (click)="isOwner() ? ownerCancelBooking() : cancelBooking(booking()!.id)"
                    class="w-full py-3 text-text-muted hover:text-error-600 text-sm font-medium transition-colors">
                    Cancelar Reserva
                  </button>
                }
              </div>
            </div>

            <!-- Financial Summary Mini -->
            <div class="bg-surface-secondary border-t border-border-default p-6">
              <div class="flex justify-between items-center mb-2">
                <span class="text-text-secondary">Total</span>
                <span class="text-xl font-bold text-text-primary">
                  {{ booking()?.total_amount | currency:booking()?.currency:'symbol':'1.0-0' }}
                </span>
              </div>
              @if (booking()?.deposit_amount_cents) {
                <div class="flex justify-between items-center text-sm">
                  <span class="text-text-secondary flex items-center gap-1">
                    <ion-icon name="shield-checkmark-outline"></ion-icon>
                    Garantía
                  </span>
                  <span class="font-medium text-text-primary">
                    {{ (booking()?.deposit_amount_cents ?? 0) / 100 | currency:booking()?.currency:'symbol':'1.0-0' }}
                  </span>
                </div>
              }
            </div>
          </div>

          <!-- 2. AI Tools Panel -->
          <div class="card-premium overflow-hidden p-0">
            <div class="p-4 border-b border-border-default bg-surface-secondary">
              <h3 class="font-bold text-info-900 flex items-center gap-2">
                <ion-icon name="sparkles" class="text-info-500"></ion-icon>
                Asistente IA
              </h3>
            </div>
            
            <app-ai-legal-panel
              [booking]="booking()!"
              [isExpanded]="expandedAiPanel() === 'legal'"
              (togglePanel)="toggleAiPanel('legal')"
            />

            @if (showTripPlanner()) {
              <app-ai-trip-panel
                [booking]="booking()!"
                [isExpanded]="expandedAiPanel() === 'trip'"
                (togglePanel)="toggleAiPanel('trip')"
              />
            }

            @if (showChecklistPanel()) {
              <app-ai-checklist-panel
                [booking]="booking()!"
                [inspectionType]="checklistInspectionType()"
                [isExpanded]="expandedAiPanel() === 'checklist'"
                (togglePanel)="toggleAiPanel('checklist')"
              />
            }
          </div>

          <!-- 3. Reviews (If Completed) -->
          @if (booking()?.status === 'completed') {
            <app-review-management [booking]="booking()!"></app-review-management>
          }

        </div>
      </div>

    </div>
  }
</div>

<!-- ============================================================================================== -->
<!-- MODALS & SIDE PANELS -->
<!-- ============================================================================================== -->

<!-- Chat Side Panel -->
@if (booking()) {
  <app-side-panel
    [isOpen]="chatPanelOpen()"
    [title]="'Chat con ' + (isOwner() ? 'Viajero' : 'Anfitrión')"
    width="min(450px, 100vw)"
    (closed)="closeChatPanel()"
  >
    @if (carOwnerId()) {
      <app-booking-chat
        [bookingId]="booking()!.id"
        [recipientId]="isOwner() ? booking()!.renter_id : carOwnerId()!"
        [recipientName]="isOwner() ? (booking()!.renter_name || 'Viajero') : carOwnerName()"
        [booking]="booking()"
        class="h-full"
      ></app-booking-chat>
    }
  </app-side-panel>
}

<!-- Feature Modals -->
@defer (when showDisputeForm()) {
  <app-dispute-form
    [isOpen]="showDisputeForm()"
    [bookingId]="booking()!.id"
    (closeModal)="showDisputeForm.set(false)"
    (disputeCreated)="onDisputeCreated()"
  ></app-dispute-form>
}

@defer (when showRefundForm()) {
  <app-refund-request
    [isOpen]="showRefundForm()"
    [bookingId]="booking()!.id"
    (closeModal)="showRefundForm.set(false)"
    (refundRequested)="onRefundRequested()"
  ></app-refund-request>
}

@defer (when showReportTrafficFineModal()) {
  <app-report-traffic-fine
    [isOpen]="showReportTrafficFineModal()"
    [booking]="booking()!"
    (closeModal)="showReportTrafficFineModal.set(false)"
    (fineReported)="onTrafficFineReported($event)"
  ></app-report-traffic-fine>
}

@defer (when showReportOwnerNoShowModal()) {
  <app-report-owner-no-show
    [isOpen]="showReportOwnerNoShowModal()"
    [booking]="booking()!"
    (closeModal)="showReportOwnerNoShowModal.set(false)"
    (noShowReported)="onOwnerNoShowReported($event)"
  ></app-report-owner-no-show>
}

@defer (when showReportRenterNoShowModal()) {
  <app-report-renter-no-show
    [isOpen]="showReportRenterNoShowModal()"
    [booking]="booking()!"
    (closeModal)="showReportRenterNoShowModal.set(false)"
    (noShowReported)="onRenterNoShowReported($event)"
  ></app-report-renter-no-show>
}
