<section class="bookings-page min-h-screen bg-surface-base pb-20 sm:pb-0">
  <!-- Hero Header - Premium Glass -->
  <header
    class="sticky top-0 z-20 backdrop-blur-xl bg-white/80 border-b border-border-muted px-4 py-4 sm:px-6 mb-6"
  >
    <div class="container-page flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <div class="flex items-center gap-2 mb-1.5">
          <span
            class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100"
          >
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
            Mis viajes
          </span>
        </div>
        <h1 class="text-2xl sm:text-3xl font-bold text-text-primary tracking-tight font-sans">
          Panel de Reservas
        </h1>
      </div>
      <a
        routerLink="/cars"
        appPressScale
        class="group inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-cta-default text-cta-text font-medium text-sm shadow-premium-sm hover:shadow-premium-md hover:bg-cta-hover transition-all duration-300"
      >
        <app-icon
          name="car-outline"
          [size]="18"
          class="transition-transform group-hover:scale-110"
        ></app-icon>
        <span>Nuevo viaje</span>
      </a>
    </div>
  </header>

  <!-- Filter Pills - Scrollable & Snap -->
  <nav class="container-page px-4 sm:px-6 mb-8" role="tablist" aria-label="Filtrar reservas">
    <div
      class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-4 px-4 sm:mx-0 sm:px-0 sm:flex-wrap snap-x snap-mandatory"
    >
      @for (filter of statusFilters; track filter) {
        <button
          role="tab"
          [attr.aria-selected]="statusFilter() === filter"
          (click)="setStatusFilter(filter)"
          appPressScale
          class="group inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all duration-200 ease-out flex-shrink-0 snap-start border"
          [class]="
            statusFilter() === filter
              ? 'bg-slate-900 text-white border-slate-900 shadow-md'
              : 'bg-white text-slate-600 border-slate-200 hover:border-slate-300 hover:bg-slate-50'
          "
        >
          <span>{{ getFilterLabel(filter) }}</span>
          @if (statusCounts()[filter] > 0) {
            <span
              class="inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold transition-colors"
              [class]="
                statusFilter() === filter ? 'bg-white/20 text-white' : 'bg-slate-100 text-slate-500'
              "
            >
              {{ statusCounts()[filter] }}
            </span>
          }
        </button>
      }
    </div>
  </nav>

  <div class="container-page px-4 sm:px-6 space-y-8">
    <!-- Loading Skeletons -->
    @if (loading() && !error()) {
      <!-- Summary Cards Skeleton -->
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
        @for (_ of [1, 2, 3]; track _) {
          <div class="h-32 rounded-2xl bg-white border border-slate-100 p-4 animate-pulse">
            <div class="w-10 h-10 rounded-xl bg-slate-100 mb-4"></div>
            <div class="h-6 w-16 bg-slate-100 rounded mb-2"></div>
            <div class="h-4 w-24 bg-slate-100 rounded"></div>
          </div>
        }
      </div>
      <!-- Booking List Skeleton -->
      <div class="space-y-4">
        @for (_ of [1, 2, 3]; track _) {
          <div class="rounded-xl border border-slate-100 bg-white p-4 flex gap-4 animate-pulse">
            <div class="w-24 h-24 rounded-lg bg-slate-100 flex-shrink-0"></div>
            <div class="flex-1 space-y-3 py-1">
              <div class="h-5 w-1/3 bg-slate-100 rounded"></div>
              <div class="h-4 w-1/4 bg-slate-100 rounded"></div>
              <div class="h-4 w-1/2 bg-slate-100 rounded mt-4"></div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Error State -->
    @if (error()) {
      <div class="rounded-2xl bg-error-50 border border-error-100 p-6 text-center">
        <div
          class="w-12 h-12 bg-error-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl"
        >
          ‚ö†Ô∏è
        </div>
        <h3 class="font-bold text-slate-900 mb-2">Algo sali√≥ mal</h3>
        <p class="text-slate-600 mb-4 text-sm">{{ error() }}</p>
        <button
          (click)="loadBookings()"
          class="text-sm font-semibold text-error-700 hover:underline"
        >
          Reintentar
        </button>
      </div>
    }

    <!-- Empty State -->
    @if (!loading() && !error() && bookings().length === 0) {
      <div class="flex flex-col items-center justify-center py-20 text-center">
        <div
          class="w-32 h-32 bg-slate-50 rounded-full flex items-center justify-center mb-6 relative"
        >
          <div
            class="absolute inset-0 border border-slate-100 rounded-full animate-ping opacity-20"
          ></div>
          <app-icon name="car-outline" [size]="48" class="text-slate-300"></app-icon>
        </div>
        <h3 class="text-xl font-bold text-slate-900 mb-2">Tu garaje est√° vac√≠o</h3>
        <p class="text-slate-500 max-w-xs mb-8">
          Todav√≠a no ten√©s viajes programados. ¬°Es el momento perfecto para planear tu pr√≥xima
          aventura!
        </p>
        <a
          routerLink="/cars"
          class="btn btn-primary px-8 py-3 rounded-full shadow-lg hover:shadow-xl transition-all"
        >
          Explorar autos
        </a>
      </div>
    }

    <!-- Dashboard Content -->
    @if (!loading() && !error() && bookings().length > 0) {
      <!-- Summary Bento Grid -->
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 animate-fade-in-up">
        <!-- Action Required -->
        <button
          (click)="dashboardStats().actionRequired > 0 && focusSection('action-required')"
          [disabled]="dashboardStats().actionRequired === 0"
          class="col-span-2 sm:col-span-1 p-5 rounded-2xl text-left border transition-all duration-300 relative overflow-hidden group"
          [class]="
            dashboardStats().actionRequired > 0
              ? 'bg-amber-50/50 border-amber-200 hover:border-amber-300 hover:shadow-md cursor-pointer'
              : 'bg-white border-slate-100 opacity-60 cursor-default'
          "
        >
          <div class="relative z-10">
            <div
              class="w-10 h-10 rounded-xl flex items-center justify-center mb-3 text-xl transition-transform group-hover:scale-110"
              [class]="
                dashboardStats().actionRequired > 0
                  ? 'bg-amber-100 text-amber-600'
                  : 'bg-slate-100 text-slate-400'
              "
            >
              ‚ö†Ô∏è
            </div>
            <div class="text-3xl font-bold text-slate-900 font-mono tracking-tight">
              {{ dashboardStats().actionRequired }}
            </div>
            <div class="text-xs font-semibold uppercase tracking-wide mt-1 text-slate-500">
              Requieren Acci√≥n
            </div>
          </div>
        </button>

        <!-- Active -->
        <button
          (click)="dashboardStats().active > 0 && focusSection('active')"
          [disabled]="dashboardStats().active === 0"
          class="p-5 rounded-2xl text-left border transition-all duration-300 relative overflow-hidden group"
          [class]="
            dashboardStats().active > 0
              ? 'bg-emerald-50/50 border-emerald-200 hover:border-emerald-300 hover:shadow-md cursor-pointer'
              : 'bg-white border-slate-100 opacity-60 cursor-default'
          "
        >
          <div class="relative z-10">
            <div
              class="w-10 h-10 rounded-xl flex items-center justify-center mb-3 text-xl transition-transform group-hover:scale-110"
              [class]="
                dashboardStats().active > 0
                  ? 'bg-emerald-100 text-emerald-600'
                  : 'bg-slate-100 text-slate-400'
              "
            >
              üöÄ
            </div>
            <div class="text-3xl font-bold text-slate-900 font-mono tracking-tight">
              {{ dashboardStats().active }}
            </div>
            <div class="text-xs font-semibold uppercase tracking-wide mt-1 text-slate-500">
              En Curso
            </div>
          </div>
        </button>

        <!-- History -->
        <button
          (click)="dashboardStats().history > 0 && focusSection('history')"
          [disabled]="dashboardStats().history === 0"
          class="p-5 rounded-2xl text-left border bg-white transition-all duration-300 relative overflow-hidden group"
          [class]="
            dashboardStats().history > 0
              ? 'border-slate-200 hover:border-slate-300 hover:shadow-md cursor-pointer'
              : 'border-slate-100 opacity-60 cursor-default'
          "
        >
          <div class="relative z-10">
            <div
              class="w-10 h-10 rounded-xl flex items-center justify-center mb-3 text-xl transition-transform group-hover:scale-110 bg-slate-100 text-slate-500"
            >
              üìã
            </div>
            <div class="text-3xl font-bold text-slate-900 font-mono tracking-tight">
              {{ dashboardStats().history }}
            </div>
            <div class="text-xs font-semibold uppercase tracking-wide mt-1 text-slate-500">
              Historial
            </div>
          </div>
        </button>
      </div>

      <!-- Collapsible Sections -->
      <div class="space-y-6">
        @for (section of bookingsBySection(); track section.id) {
          @if (section.count > 0) {
            <div class="animate-slide-up">
              <!-- Section Header -->
              <button
                (click)="toggleSection(section.id)"
                class="flex items-center gap-3 w-full text-left mb-4 group focus:outline-none"
              >
                <span class="text-lg">{{ section.icon }}</span>
                <h2
                  class="text-lg font-bold text-slate-900 font-sans group-hover:text-emerald-700 transition-colors"
                >
                  {{ section.title }}
                </h2>
                <span
                  class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-0.5 rounded-full"
                >
                  {{ section.count }}
                </span>
                <div
                  class="h-px bg-slate-200 flex-1 ml-2 group-hover:bg-slate-300 transition-colors"
                ></div>
                <div
                  class="w-6 h-6 rounded-full border border-slate-200 flex items-center justify-center text-slate-400 transition-transform duration-300"
                  [class.rotate-180]="section.expanded"
                >
                  <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </div>
              </button>

              <!-- Cards List -->
              @if (section.expanded) {
                <div class="space-y-3">
                  @for (booking of section.bookings; track booking.id) {
                    <!-- Premium Card -->
                    <article
                      class="group relative bg-white rounded-xl border transition-all duration-300 hover:-translate-y-0.5 hover:shadow-lg overflow-hidden"
                      [ngClass]="[
                        statusBorderClass(booking),
                        'border-l-[4px] border-y border-r border-slate-200',
                      ]"
                    >
                      <a [routerLink]="['/bookings', booking.id]" class="flex p-4 gap-4">
                        <!-- Photo -->
                        <div
                          class="relative w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden bg-slate-100"
                        >
                          @if (booking.main_photo_url) {
                            <img
                              [src]="booking.main_photo_url"
                              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                              loading="lazy"
                              [alt]="booking.car_brand + ' ' + booking.car_model"
                            />
                          } @else {
                            <div
                              class="w-full h-full flex items-center justify-center text-slate-300"
                            >
                              <app-icon name="car-outline" [size]="24"></app-icon>
                            </div>
                          }
                          <!-- Icon Overlay -->
                          <div
                            class="absolute bottom-1 right-1 w-6 h-6 bg-white/90 backdrop-blur rounded flex items-center justify-center shadow-sm text-sm"
                            [ngClass]="statusIconBgClass(booking)"
                          >
                            {{ statusIcon(booking) }}
                          </div>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 min-w-0 flex flex-col justify-between">
                          <div>
                            <div class="flex justify-between items-start gap-2">
                              <h3
                                class="font-bold text-slate-900 truncate pr-2 group-hover:text-emerald-700 transition-colors"
                              >
                                {{ booking.car_title || 'Auto sin t√≠tulo' }}
                              </h3>
                              <span
                                class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] uppercase font-bold tracking-wider border"
                                [ngClass]="statusBadgeCompactClass(booking)"
                              >
                                {{ statusLabelShort(booking) }}
                              </span>
                            </div>
                            <p class="text-xs text-slate-500 mt-1 flex items-center gap-1">
                              <app-icon name="calendar-outline" [size]="12"></app-icon>
                              {{ rangeLabel(booking) }}
                            </p>
                          </div>

                          <div class="flex items-end justify-between mt-2">
                            <div class="text-sm font-bold text-slate-900 font-mono">
                              {{ booking.total_amount | money }}
                            </div>

                            <!-- Action Hint -->
                            <span
                              class="text-xs font-semibold flex items-center gap-1 transition-colors group-hover:translate-x-1"
                              [class]="
                                canCompletePay(booking)
                                  ? 'text-amber-600'
                                  : 'text-slate-400 group-hover:text-emerald-600'
                              "
                            >
                              @if (canCompletePay(booking)) {
                                Pagar ahora ‚Üí
                              } @else {
                                Ver detalle ‚Üí
                              }
                            </span>
                          </div>
                        </div>
                      </a>
                    </article>
                  }
                </div>
              }
            </div>
          }
        }
      </div>

      <!-- Show All Link -->
      @if (statusFilter() !== 'all') {
        <div class="mt-8 text-center">
          <button
            (click)="setStatusFilter('all'); expandAllSections()"
            class="text-sm font-medium text-emerald-600 hover:text-emerald-700 hover:underline"
          >
            Ver todas las reservas ({{ dashboardStats().total }})
          </button>
        </div>
      }
    }
  </div>
</section>
