<section class="space-y-6">
  <header>
    <h1 class="h2">Mis reservas</h1>
    <p class="text-body text-text-secondary dark:text-text-secondary/80">
      Seguimiento de tus pedidos y su estado actual.
    </p>
  </header>

  <!-- Status Filters -->
  <div
    *ngIf="!loading() && !error() && bookings().length > 0"
    class="flex flex-wrap gap-2 items-center"
  >
    <button
      *ngFor="let filter of statusFilters"
      (click)="setStatusFilter(filter)"
      [class.bg-cta-default]="statusFilter() === filter"
      [class.text-text-inverse]="statusFilter() === filter"
      [class.bg-surface-raised
      dark:bg-surface-secondary]="statusFilter() !== filter"
      [class.text-cta-default]="statusFilter() !== filter"
      [class.dark:bg-surface-secondary]="statusFilter() !== filter"
      [class.dark:text-warning-light]="statusFilter() !== filter"
      class="px-4 py-2 rounded-lg border-2 border-cta-default/30 dark:border-cta-default/50 font-medium text-sm transition-colors hover:bg-cta-default/10 dark:hover:bg-cta-default/20"
    >
      {{ getFilterLabel(filter) }}
      <span
        *ngIf="statusCounts()[filter] > 0"
        class="ml-2 px-2 py-0.5 rounded-full text-xs"
        [ngClass]="{
          'bg-surface-raised dark:bg-surface-secondary/20': statusFilter() === filter,
          'bg-cta-default/10': statusFilter() !== filter,
        }"
      >
        {{ statusCounts()[filter] }}
      </span>
    </button>
  </div>

  <!-- Error message -->
  <div *ngIf="error()" class="info-card-warm">
    <p class="font-semibold text-text-primary dark:text-text-secondary">Error al cargar reservas</p>
    <p class="mt-1 text-text-secondary dark:text-text-secondary/80">{{ error() }}</p>
    <button
      (click)="loadBookings()"
      class="mt-3 px-3 py-2 bg-warning-light text-cta-text rounded-xl text-xs font-semibold hover:bg-cta-default transition-base"
    >
      Reintentar
    </button>
  </div>

  <!-- Loading state -->
  <div
    *ngIf="loading() && !error()"
    class="text-center text-sm text-text-secondary dark:text-text-secondary/70"
  >
    Cargando reservas...
  </div>

  <!-- Bookings list -->
  <div class="bookings-grid" *ngIf="!loading() && !error()">
    <article
      *ngFor="let booking of filteredBookings()"
      class="card-premium overflow-hidden hover-lift shadow-soft booking-card"
      [ngClass]="statusCardClass(booking)"
      data-testid="booking-card"
    >
      <a [routerLink]="['/bookings', booking.id]" class="block">
        <!-- Hero Section with Car Photo Background -->
        <div class="relative h-32 sm:h-40 md:h-48 overflow-hidden">
          <!-- Car Image Background -->
          <div *ngIf="booking.main_photo_url; else defaultBookingHero" class="absolute inset-0">
            <img
              [src]="booking.main_photo_url"
              [alt]="booking.car_title"
              loading="lazy"
              decoding="async"
              width="400"
              height="256"
              class="w-full h-full object-cover"
            />
            <!-- Dark Overlay -->
            <div
              class="absolute inset-0 bg-gradient-to-b from-smoke-black/60 via-smoke-black/40 to-smoke-black/70"
            ></div>
          </div>

          <!-- Default Hero (no image) -->
          <ng-template #defaultBookingHero>
            <div
              class="absolute inset-0 bg-gradient-to-br from-cta-default via-cta-default/90 to-warning-light"
            >
              <!-- Decorative Pattern -->
              <div
                class="absolute inset-0 opacity-10"
                style="
                  background-image: radial-gradient(circle, white 1px, transparent 1px);
                  background-size: 40px 40px;
                "
              ></div>
            </div>
          </ng-template>

          <!-- Content Overlay -->
          <div class="relative h-full flex flex-col justify-between p-4 sm:p-6">
            <!-- Top: Status Badge -->
            <div class="flex justify-between items-start gap-2 flex-wrap">
              <span
                class="badge-status text-text-inverse border-white/30 backdrop-blur-sm"
                [ngClass]="statusBadgeClass(booking)"
              >
                {{ statusLabel(booking) }}
              </span>
              <app-deposit-status-badge
                *ngIf="booking.deposit_status"
                [status]="booking.deposit_status"
              ></app-deposit-status-badge>
            </div>

            <!-- Bottom: Car Info -->
            <div class="text-text-inverse">
              <h3 class="text-xl sm:text-2xl font-bold mb-1 tracking-tight">
                {{ booking.car_title || 'Auto' }}
              </h3>
              <p
                class="text-sm sm:text-base text-text-inverse/90 mb-2"
                *ngIf="booking.car_brand || booking.car_model"
              >
                {{ booking.car_brand }} {{ booking.car_model }}
              </p>
              <p class="text-xs sm:text-sm text-text-inverse/80">
                {{ rangeLabel(booking) }}
              </p>
            </div>
          </div>
        </div>

        <div class="status-banner" [ngClass]="statusBannerClass(booking)">
          <div class="status-banner__icon" aria-hidden="true">{{ statusIcon(booking) }}</div>
          <div>
            <p class="status-banner__title">{{ statusLabel(booking) }}</p>
            <p *ngIf="statusHint(booking)" class="status-banner__hint">{{ statusHint(booking) }}</p>
          </div>
        </div>

        <!-- Action Buttons by Status -->
        <div
          class="p-4 sm:p-5 bg-surface-raised dark:bg-surface-raised dark:bg-surface-secondary/90 transition-base"
          *ngIf="booking.status === 'pending' || booking.status === 'confirmed'"
          [attr.data-tour-step]="'booking-actions-' + booking.status"
        >
          <!-- Pending: Needs Payment -->
          <div *ngIf="booking.status === 'pending'" class="space-y-3">
            <div
              class="flex items-center gap-2 text-warning-text dark:text-warning-400 text-sm font-medium"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>
                {{
                  booking.payment_mode
                    ? 'Acción requerida: Falta completar el pago'
                    : 'Acción requerida: Completa los detalles de pago'
                }}
              </span>
            </div>

            <!-- Action Buttons - Responsive: vertical on mobile, horizontal on desktop -->
            <div class="flex flex-col sm:flex-row gap-2">
              <!-- Completar Pago -->
              <button
                [routerLink]="['/bookings/detail-payment']"
                [queryParams]="{ bookingId: booking.id }"
                (click)="$event.stopPropagation()"
                data-tour-step="complete-payment-btn"
                class="flex-1 px-4 py-3 bg-gradient-to-r from-cta-default to-warning-light text-text-inverse rounded-xl font-semibold hover:shadow-lg transition-all duration-300 hover:scale-105 order-1"
              >
                <app-icon name="credit-card" [size]="20" cssClass="inline-block mr-1" /> Completar
                Pago
              </button>

              <!-- Ver Detalle (secundario) -->
              <button
                [routerLink]="['/bookings', booking.id]"
                (click)="$event.stopPropagation()"
                data-tour-step="view-detail-btn"
                class="px-4 py-3 border-2 border-cta-default/30 dark:border-cta-default/50 text-cta-default dark:text-warning-light rounded-xl font-semibold hover:bg-cta-default/10 dark:hover:bg-cta-default/20 transition-base order-2 sm:flex-none sm:w-auto"
              >
                <app-icon name="clipboard" [size]="20" cssClass="inline-block mr-1" /> Ver Detalle
              </button>

              <!-- Cancelar (siempre visible) -->
              <button
                (click)="$event.preventDefault(); cancelBooking(booking.id)"
                class="px-4 py-3 border-2 border-border-default dark:border-border-default/60 dark:border-neutral-700 text-text-secondary dark:text-text-secondary rounded-xl font-semibold hover:bg-border-default/20 dark:hover:bg-neutral-800 transition-base order-3 sm:flex-none sm:w-auto"
              >
                <app-icon name="close-circle" [size]="20" cssClass="inline-block mr-1" /> Cancelar
              </button>
            </div>
          </div>

          <!-- Confirmed: Show Next Steps -->
          <div *ngIf="booking.status === 'confirmed'" class="space-y-3">
            <p class="text-sm font-medium text-text-primary dark:text-text-primary mb-2">
              <app-icon name="clipboard" [size]="18" cssClass="inline-block mr-1" /> Próximos pasos:
            </p>

            <!-- Main actions grid -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
              <!-- Ver Detalle - Primary action for confirmed bookings -->
              <button
                [routerLink]="['/bookings', booking.id]"
                data-tour-step="view-detail-confirmed-btn"
                class="flex flex-col items-center gap-1 p-3 rounded-lg border-2 border-cta-default/30 dark:border-cta-default/50 bg-cta-default/5 dark:bg-cta-default/10 hover:bg-cta-default/10 dark:hover:bg-cta-default/20 transition-base"
              >
                <app-icon name="clipboard" [size]="32" cssClass="inline-block" />
                <span class="text-xs font-medium text-cta-default dark:text-warning-light"
                  >Ver Detalle</span
                >
              </button>

              <button
                (click)="$event.preventDefault(); showInstructions(booking)"
                data-tour-step="view-instructions-btn"
                class="flex flex-col items-center gap-1 p-3 rounded-lg border border-border-default dark:border-border-default/40 dark:border-neutral-700 hover:bg-cta-default/10 dark:hover:bg-cta-default/20 transition-base"
              >
                <app-icon name="clipboard" [size]="32" cssClass="inline-block" />
                <span class="text-xs font-medium text-text-secondary dark:text-text-secondary"
                  >Instrucciones</span
                >
              </button>
              <button
                (click)="$event.preventDefault(); openChat(booking)"
                data-tour-step="chat-btn"
                class="flex flex-col items-center gap-1 p-3 rounded-lg border border-border-default dark:border-border-default/40 dark:border-neutral-700 hover:bg-cta-default/10 dark:hover:bg-cta-default/20 transition-base"
              >
                <app-icon name="message" [size]="32" cssClass="inline-block" />
                <span class="text-xs font-medium text-text-secondary dark:text-text-secondary"
                  >Chat</span
                >
              </button>
              <button
                (click)="$event.preventDefault(); showMap(booking)"
                data-tour-step="map-btn"
                class="flex flex-col items-center gap-1 p-3 rounded-lg border border-border-default dark:border-border-default/40 dark:border-neutral-700 hover:bg-cta-default/10 dark:hover:bg-cta-default/20 transition-base"
              >
                <app-icon name="location" [size]="32" cssClass="inline-block" />
                <span class="text-xs font-medium text-text-secondary dark:text-text-secondary"
                  >Mapa</span
                >
              </button>
            </div>
          </div>
        </div>

        <!-- Card Footer with Price and Action -->
        <div
          class="p-4 sm:p-5 bg-surface-raised dark:bg-surface-raised dark:bg-surface-secondary/90 border-t border-border-default dark:border-border-default/40 dark:border-slate-deep/60 transition-base"
        >
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs text-text-muted dark:text-text-secondary/70 mb-1">Total</p>
              <p class="text-lg sm:text-xl font-bold text-text-primary dark:text-text-primary">
                {{ booking.total_amount | money }}
              </p>
            </div>
            <div
              class="flex items-center gap-2 text-cta-default dark:text-text-primary font-semibold text-sm hover:text-warning-light dark:hover:text-warning-200 transition-base"
            >
              Ver detalle
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </div>
          </div>
        </div>
      </a>
    </article>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading() && !error() && bookings().length === 0">
    <p class="text-caption text-center py-8 text-text-secondary dark:text-text-secondary/70">
      No tenés reservas todavía.
    </p>
  </div>

  <!-- Empty state for filtered results -->
  <div
    *ngIf="!loading() && !error() && bookings().length > 0 && filteredBookings().length === 0"
    class="text-center py-12"
  >
    <p class="text-lg font-medium text-text-secondary dark:text-text-secondary/80 mb-2">
      No hay reservas con el estado "{{ getFilterLabel(statusFilter()) }}"
    </p>
    <button
      (click)="setStatusFilter('all')"
      class="px-4 py-2 bg-cta-default text-cta-text rounded-lg font-medium hover:bg-warning-light transition-colors"
    >
      Ver todas las reservas
    </button>
  </div>
</section>
