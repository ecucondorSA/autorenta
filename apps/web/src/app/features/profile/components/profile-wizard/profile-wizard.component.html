<div class="profile-wizard">
  <!-- Progress Bar -->
  <div class="wizard-progress">
    <div class="progress-bar-wrapper">
      <div
        class="progress-bar bg-surface-secondary dark:bg-surface-secondary/60 rounded-full h-2 overflow-hidden"
      >
        <div
          class="progress-bar-fill bg-cta-default h-full transition-all duration-300 ease-out"
          [style.width.%]="progressPercentage()"
        ></div>
      </div>
      <div class="flex justify-between mt-2 text-xs">
        @for (step of steps; track step.id; let i = $index) {
          <button
            type="button"
            (click)="goToStep(step.id)"
            [disabled]="saving()"
            class="flex flex-col items-center gap-1 transition-base disabled:opacity-50 disabled:cursor-not-allowed"
            [class.cursor-pointer]="
              !saving() && (isStepCompleted(step.id) || i < currentStepIndex())
            "
            [class.opacity-50]="i > currentStepIndex() && !isStepCompleted(step.id)"
          >
            <div
              class="flex h-6 w-6 items-center justify-center rounded-full border-2 transition-base"
              [class.bg-cta-default]="currentStep() === step.id"
              [class.border-cta-default]="currentStep() === step.id || isStepCompleted(step.id)"
              [class.bg-success-light]="isStepCompleted(step.id) && currentStep() !== step.id"
              [class.border-success-light]="isStepCompleted(step.id) && currentStep() !== step.id"
              [class.border-border-default]="currentStep() !== step.id && !isStepCompleted(step.id)"
            >
              @if (isStepCompleted(step.id) && currentStep() !== step.id) {
                <svg
                  class="h-4 w-4 text-text-primary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  ></path>
                </svg>
              } @else {
                <span class="text-xs font-semibold">{{ i + 1 }}</span>
              }
            </div>
            <span
              class="text-xs transition-base"
              [class.font-semibold]="currentStep() === step.id || isStepCompleted(step.id)"
              [class.text-cta-default]="currentStep() === step.id"
              [class.text-success-light]="isStepCompleted(step.id) && currentStep() !== step.id"
              [class.text-text-secondary]="currentStep() !== step.id && !isStepCompleted(step.id)"
            >
              {{ step.label }}
            </span>
          </button>
        }
      </div>
    </div>
  </div>

  <!-- Step Content -->
  <div class="wizard-content">
    <!-- Step 1: General -->
    @if (currentStep() === 'general') {
      <div class="step-content">
        <h3 class="step-title">Información General</h3>
        <p class="step-description">Completa tu nombre y elige tu rol en la plataforma</p>

        <form [formGroup]="generalForm" class="space-y-4">
          <!-- Full Name -->
          <div>
            <label
              class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
            >
              Nombre completo *
            </label>
            <input
              type="text"
              formControlName="full_name"
              class="input-premium w-full"
              [class.border-warning-light]="
                generalForm.controls.full_name.touched && generalForm.controls.full_name.invalid
              "
              placeholder="Juan Pérez"
            />
            @if (
              generalForm.controls.full_name.touched &&
              generalForm.controls.full_name.errors?.['required']
            ) {
              <p class="mt-1 text-xs text-warning-light">El nombre es obligatorio</p>
            }
            @if (
              generalForm.controls.full_name.touched &&
              generalForm.controls.full_name.errors?.['minlength']
            ) {
              <p class="mt-1 text-xs text-warning-light">
                El nombre debe tener al menos 3 caracteres
              </p>
            }
          </div>

          <!-- Role Selection -->
          <div>
            <label
              class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-2"
            >
              Rol *
            </label>
            <div class="space-y-3">
              @for (roleOption of roles; track roleOption.value) {
                <div
                  [ngClass]="{
                    'border-cta-default': generalForm.value.role === roleOption.value,
                    'bg-cta-default/5': generalForm.value.role === roleOption.value,
                    'border-border-default': generalForm.value.role !== roleOption.value,
                  }"
                  class="relative flex cursor-pointer rounded-xl border p-4 transition-base hover:bg-surface-secondary dark:hover:bg-slate-deep/60"
                >
                  <input
                    type="radio"
                    [value]="roleOption.value"
                    formControlName="role"
                    class="mt-1 h-4 w-4 border-border-default text-cta-default focus:ring-cta-default"
                  />
                  <label class="ml-3 flex flex-1 cursor-pointer flex-col">
                    <span
                      class="block text-sm font-medium text-text-primary dark:text-text-primary"
                    >
                      {{ roleOption.label }}
                    </span>
                    <span class="block text-xs text-text-secondary dark:text-text-secondary/70">
                      {{ roleOption.description }}
                    </span>
                  </label>
                </div>
              }
            </div>
          </div>
        </form>
      </div>
    }

    <!-- Step 2: Contact -->
    @if (currentStep() === 'contact') {
      <div class="step-content">
        <h3 class="step-title">Información de Contacto</h3>
        <p class="step-description">
          Agrega tu teléfono y WhatsApp para que otros usuarios puedan contactarte
        </p>

        <form [formGroup]="contactForm" class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
            >
              Teléfono
            </label>
            <input
              type="tel"
              formControlName="phone"
              class="input-premium w-full"
              placeholder="+598 99 123 456"
            />
            @if (
              contactForm.controls.phone.touched && contactForm.controls.phone.errors?.['pattern']
            ) {
              <p class="mt-1 text-xs text-warning-light">Formato de teléfono inválido</p>
            }
          </div>

          <div>
            <label
              class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
            >
              WhatsApp
              <span class="text-xs text-text-muted dark:text-text-secondary/60 ml-1"
                >(se guarda automáticamente)</span
              >
            </label>
            <input
              type="tel"
              formControlName="whatsapp"
              class="input-premium w-full"
              placeholder="+598 99 123 456"
            />
            @if (
              contactForm.controls.whatsapp.touched &&
              contactForm.controls.whatsapp.errors?.['pattern']
            ) {
              <p class="mt-1 text-xs text-warning-light">Formato de WhatsApp inválido</p>
            }
          </div>
        </form>
      </div>
    }

    <!-- Step 3: Address -->
    @if (currentStep() === 'address') {
      <div class="step-content">
        <h3 class="step-title">Dirección</h3>
        <p class="step-description">
          Completa tu dirección para mejorar las búsquedas de autos cercanos
        </p>

        <form [formGroup]="addressForm" class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
            >
              Calle y Número
            </label>
            <input
              type="text"
              formControlName="address_line1"
              class="input-premium w-full"
              placeholder="18 de Julio 1234"
            />
          </div>

          <div>
            <label
              class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
            >
              Apartamento, Suite, etc. (opcional)
            </label>
            <input
              type="text"
              formControlName="address_line2"
              class="input-premium w-full"
              placeholder="Apto 101"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label
                class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
              >
                Ciudad
                <span class="text-xs text-text-muted dark:text-text-secondary/60 ml-1">
                  <span class="inline-flex items-center gap-1">
                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"
                      ></path>
                    </svg>
                    Se guarda automáticamente
                  </span>
                </span>
              </label>
              <input
                type="text"
                formControlName="city"
                class="input-premium w-full"
                placeholder="Montevideo"
              />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
              >
                Departamento
              </label>
              <input
                type="text"
                formControlName="state"
                class="input-premium w-full"
                placeholder="Montevideo"
              />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
              >
                Código Postal
              </label>
              <input
                type="text"
                formControlName="postal_code"
                class="input-premium w-full"
                placeholder="11200"
              />
            </div>
          </div>

          <div>
            <label
              class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
            >
              País
            </label>
            <input
              type="text"
              formControlName="country"
              class="input-premium w-full"
              placeholder="Uruguay"
            />
          </div>
        </form>
      </div>
    }

    <!-- Step 4: License -->
    @if (currentStep() === 'license') {
      <div class="step-content">
        <h3 class="step-title">Licencia de Conducir</h3>
        <p class="step-description">Agrega tu licencia de conducir para poder reservar autos</p>

        <form [formGroup]="licenseForm" class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
            >
              Número de Licencia
            </label>
            <input
              type="text"
              formControlName="driver_license_number"
              class="input-premium w-full"
              placeholder="ABC123456"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                class="block text-sm font-medium text-text-secondary dark:text-text-secondary/80 mb-1"
              >
                País de Emisión
              </label>
              <input
                type="text"
                formControlName="driver_license_country"
                class="input-premium w-full"
                placeholder="Uruguay"
              />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-text-secondary dark:text-secondary/80 mb-1"
              >
                Fecha de Vencimiento
              </label>
              <input
                type="date"
                formControlName="driver_license_expiry"
                class="input-premium w-full"
              />
            </div>
          </div>
        </form>
      </div>
    }
  </div>

  <!-- Navigation Buttons -->
  <div class="wizard-actions">
    <div class="flex items-center justify-between gap-3">
      <button
        type="button"
        (click)="onCancelClick()"
        class="btn-secondary px-4 py-2 text-sm"
        [disabled]="saving()"
      >
        Cancelar
      </button>

      <div class="flex gap-3">
        <button
          type="button"
          (click)="previousStep()"
          class="btn-secondary px-4 py-2 text-sm"
          [disabled]="!canGoPrevious() || saving()"
        >
          Anterior
        </button>

        @if (isLastStep()) {
          <button
            type="button"
            (click)="saveCurrentStep()"
            class="btn-primary px-4 py-2 text-sm"
            [disabled]="!canGoNext() || saving()"
          >
            {{ saving() ? 'Guardando...' : 'Finalizar' }}
          </button>
        } @else {
          <button
            type="button"
            (click)="saveCurrentStep()"
            class="btn-primary px-4 py-2 text-sm"
            [disabled]="!canGoNext() || saving()"
          >
            {{ saving() ? 'Guardando...' : 'Guardar y continuar' }}
          </button>
        }
      </div>
    </div>
  </div>
</div>
