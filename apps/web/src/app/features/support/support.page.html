<ion-header>
  <ion-toolbar class="bg-surface-raised border-b border-border-default">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/" text="Inicio" class="text-text-primary"></ion-back-button>
    </ion-buttons>
    <ion-title class="text-text-primary">Soporte</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-surface-base">
  <div class="min-h-full py-6 px-4 max-w-4xl mx-auto">
    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-text-primary mb-2 font-satoshi">Centro de Soporte</h1>
      <p class="text-sm text-text-secondary">
        Crea un ticket de soporte o revisa el estado de tus consultas anteriores.
      </p>
    </div>

    <!-- Tab Navigation (inline, no modal) -->
    <div class="flex gap-2 mb-6 border-b border-border-default">
      <button
        type="button"
        (click)="selectTab('form')"
        [class]="
          selectedTab() === 'form'
            ? 'px-4 py-3 text-sm font-medium text-cta-default border-b-2 border-cta-default -mb-px'
            : 'px-4 py-3 text-sm font-medium text-text-secondary hover:text-text-primary'
        "
      >
        Nuevo Ticket
      </button>
      <button
        type="button"
        (click)="selectTab('tickets')"
        [class]="
          selectedTab() === 'tickets'
            ? 'px-4 py-3 text-sm font-medium text-cta-default border-b-2 border-cta-default -mb-px'
            : 'px-4 py-3 text-sm font-medium text-text-secondary hover:text-text-primary'
        "
      >
        Mis Tickets
        @if (tickets().length > 0) {
          <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-cta-default/10 text-cta-default">
            {{ tickets().length }}
          </span>
        }
      </button>
    </div>

    <!-- NEW TICKET FORM (No wizard, single page) -->
    @if (selectedTab() === 'form') {
      <form [formGroup]="ticketForm" (ngSubmit)="onSubmit()" class="space-y-6">
        <!-- Category Selection -->
        <div class="card-premium p-6">
          <h2 class="text-lg font-semibold mb-4 font-satoshi text-text-primary">
            Tipo de consulta
          </h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            @for (cat of categories; track cat.value) {
              <label
                [class]="
                  ticketForm.get('category')?.value === cat.value
                    ? 'border-2 border-cta-default bg-cta-default/5'
                    : 'border border-border-default hover:border-cta-default/50'
                "
                class="flex flex-col items-center p-4 rounded-lg cursor-pointer transition-colors"
              >
                <input
                  type="radio"
                  formControlName="category"
                  [value]="cat.value"
                  class="sr-only"
                />
                <ion-icon
                  [name]="getCategoryIcon(cat.icon)"
                  class="text-2xl mb-2 text-text-primary"
                ></ion-icon>
                <span class="text-sm text-center text-text-primary">{{ cat.label }}</span>
              </label>
            }
          </div>
          @if (getFieldError('category')) {
            <p class="mt-2 text-sm text-red-600">{{ getFieldError('category') }}</p>
          }
        </div>

        <!-- Urgency Level -->
        <div class="card-premium p-6">
          <h2 class="text-lg font-semibold mb-4 font-satoshi text-text-primary">
            Nivel de urgencia
          </h2>
          <div class="flex flex-wrap gap-3">
            @for (level of urgencyLevels; track level.value) {
              <label
                [class]="
                  ticketForm.get('urgency')?.value === level.value ? 'ring-2 ring-cta-default' : ''
                "
                class="flex items-center gap-2 px-4 py-2 rounded-full border cursor-pointer {{
                  level.color
                }}"
              >
                <input
                  type="radio"
                  formControlName="urgency"
                  [value]="level.value"
                  class="sr-only"
                />
                <span class="text-sm font-medium">{{ level.label }}</span>
              </label>
            }
          </div>
        </div>

        <!-- Subject & Description -->
        <div class="card-premium p-6 space-y-4">
          <h2 class="text-lg font-semibold font-satoshi text-text-primary">
            Detalles del problema
          </h2>

          <div>
            <label for="subject" class="block text-sm font-medium text-text-primary mb-1">
              Asunto
            </label>
            <input
              id="subject"
              type="text"
              formControlName="subject"
              placeholder="Describe brevemente tu problema"
              class="w-full px-4 py-3 rounded-lg border border-border-default bg-surface-base focus:outline-none focus:ring-2 focus:ring-cta-default focus:border-transparent text-text-primary placeholder-text-muted"
            />
            @if (getFieldError('subject')) {
              <p class="mt-1 text-sm text-red-600">{{ getFieldError('subject') }}</p>
            }
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-text-primary mb-1">
              Descripcion detallada
            </label>
            <textarea
              id="description"
              formControlName="description"
              rows="5"
              placeholder="Proporciona todos los detalles relevantes sobre tu problema o consulta..."
              class="w-full px-4 py-3 rounded-lg border border-border-default bg-surface-base focus:outline-none focus:ring-2 focus:ring-cta-default focus:border-transparent text-text-primary placeholder-text-muted resize-none"
            ></textarea>
            @if (getFieldError('description')) {
              <p class="mt-1 text-sm text-red-600">{{ getFieldError('description') }}</p>
            }
          </div>
        </div>

        <!-- File Attachments -->
        <div class="card-premium p-6">
          <h2 class="text-lg font-semibold mb-4 font-satoshi text-text-primary">
            Archivos adjuntos (opcional)
          </h2>
          <p class="text-sm text-text-secondary mb-4">
            Puedes adjuntar capturas de pantalla, fotos o documentos relevantes.
          </p>

          <div class="flex items-center gap-4">
            <label
              class="flex items-center gap-2 px-4 py-2 rounded-lg border border-dashed border-border-default hover:border-cta-default cursor-pointer text-text-secondary hover:text-cta-default transition-colors"
            >
              <input
                type="file"
                multiple
                accept="image/*,.pdf,.doc,.docx"
                (change)="onFileSelected($event)"
                class="sr-only"
                [disabled]="uploadingFiles()"
              />
              @if (uploadingFiles()) {
                <ion-spinner name="crescent" class="w-5 h-5"></ion-spinner>
              } @else {
                <ion-icon name="attach-outline" class="text-xl"></ion-icon>
              }
              <span class="text-sm">Agregar archivos</span>
            </label>
          </div>

          <!-- Attachment List -->
          @if (pendingAttachments().length > 0) {
            <div class="mt-4 space-y-2">
              @for (url of pendingAttachments(); track url; let i = $index) {
                <div class="flex items-center justify-between p-2 rounded bg-surface-secondary">
                  <span class="text-sm text-text-primary truncate max-w-[200px]">
                    Archivo {{ i + 1 }}
                  </span>
                  <button
                    type="button"
                    (click)="removeAttachment(i)"
                    class="text-red-500 hover:text-red-700 text-sm"
                  >
                    Eliminar
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button
            type="submit"
            [disabled]="submitting() || ticketForm.invalid"
            class="btn-primary px-8 py-3 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            @if (submitting()) {
              <span class="flex items-center gap-2">
                <ion-spinner name="crescent" class="w-5 h-5"></ion-spinner>
                Enviando...
              </span>
            } @else {
              Enviar Ticket
            }
          </button>
        </div>
      </form>
    }

    <!-- TICKETS LIST -->
    @if (selectedTab() === 'tickets') {
      @if (loading()) {
        <div class="flex justify-center py-12">
          <ion-spinner name="crescent" class="w-12 h-12 text-cta-default"></ion-spinner>
        </div>
      } @else if (tickets().length === 0) {
        <div class="card-premium p-12 text-center">
          <ion-icon name="mail-unread-outline" class="text-5xl text-text-muted mb-4"></ion-icon>
          <h3 class="text-lg font-semibold text-text-primary mb-2">No tienes tickets</h3>
          <p class="text-sm text-text-secondary mb-4">
            Crea tu primer ticket de soporte usando el formulario.
          </p>
          <button type="button" (click)="selectTab('form')" class="btn-secondary">
            Crear Ticket
          </button>
        </div>
      } @else {
        <div class="space-y-4">
          @for (ticket of tickets(); track ticket.id) {
            <div class="card-premium p-4 hover:shadow-md transition-shadow">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-mono text-text-muted">
                      #{{ ticket.id.slice(0, 8) }}
                    </span>
                    <span
                      class="px-2 py-0.5 text-xs rounded-full {{ statusMap[ticket.status].color }}"
                    >
                      {{ statusMap[ticket.status].label }}
                    </span>
                  </div>
                  <h3 class="font-semibold text-text-primary truncate">
                    {{ ticket.subject }}
                  </h3>
                  <p class="text-sm text-text-secondary line-clamp-2 mt-1">
                    {{ ticket.description }}
                  </p>
                  <div class="flex items-center gap-4 mt-2 text-xs text-text-muted">
                    <span>{{ ticket.created_at | date: 'short' }}</span>
                  </div>
                </div>
                <div class="flex-shrink-0">
                  @if (getUrgencyInfo(ticket.urgency); as urgency) {
                    <span class="px-2 py-1 text-xs rounded {{ urgency.color }}">
                      {{ urgency.label }}
                    </span>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
    }
  </div>
</ion-content>
