<!-- Splash Screen Animado -->
<app-splash-screen></app-splash-screen>

<!-- PWA Components -->
<app-pwa-titlebar></app-pwa-titlebar>
<app-pwa-install-prompt></app-pwa-install-prompt>
<app-pwa-update-prompt></app-pwa-update-prompt>

<!-- Toast Notifications handled by Ionic ToastController -->
<!-- aria-live for screen reader accessibility (WCAG 4.1.3) -->
<div aria-live="polite" aria-atomic="true" class="sr-only" id="toast-announcer"></div>

<!-- App Shell - Layout Neutral Premium -->
<div
  class="min-h-dvh grid grid-rows-[auto_1fr_auto] bg-surface-base transition-opacity duration-500">
  <!-- Header Responsive -->
  <header *ngIf="!isHomePage()" id="main-header" [class]="
      isHomePage()
        ? 'header-transparent absolute top-0 left-0 right-0 z-50 pt-[env(safe-area-inset-top)]'
        : 'sticky top-0 z-sticky border-b border-border-default/70 backdrop-blur-md bg-white/[0.005] supports-[backdrop-filter]:bg-white/[0.005] shadow-sm pt-[env(safe-area-inset-top)]'
    ">
    <a class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 px-3 py-2 rounded-lg bg-surface-secondary dark:bg-surface-secondary"
      href="#main-content">
      {{ 'common.skipToContent' | translate }}
    </a>

    <div
      class="container-page px-container flex flex-col md:flex-row md:flex-wrap md:items-center gap-3 sm:gap-5 py-1 min-h-[3.5rem]">
      <div class="flex w-full md:flex-1 items-center gap-2 sm:gap-4 min-w-0">
        <!-- Logo -->
        <a routerLink="/" data-tour-step="welcome-hero"
          class="group flex items-center gap-3 hover:opacity-100 transition-base">
          <img ngSrc="/assets/images/autorentar-logo.svg" alt="Autorentar" width="320" height="80"
            priority
            class="h-10 md:h-12 w-auto object-contain drop-shadow-lg transition-transform duration-200 group-hover:scale-[1.04]" />
        </a>

        <!-- Desktop Navigation -->
        <nav id="main-nav" data-tour-step="welcome-nav"
          class="hidden lg:flex items-center gap-3 xl:gap-4 ml-2 xl:ml-6" role="navigation"
          aria-label="Principal">
          <a routerLink="/cars" routerLinkActive="nav-link-active"
            [routerLinkActiveOptions]="{ exact: false }" class="nav-link nav-link-primary">
            <app-header-icon name="cta-search" [size]="24" />
            <span>{{ 'nav.cars' | translate }}</span>
          </a>
          <a routerLink="/cars/publish" routerLinkActive="nav-link-active"
            class="nav-link nav-link-highlight">
            <app-header-icon name="cta-publish" [size]="26" />
            <span>Publicar auto</span>
          </a>
        </nav>
      </div>

      <!-- Actions - improved spacing for tap targets -->
      <div
        class="flex w-full flex-wrap lg:flex-nowrap items-center gap-3 gap-y-3 sm:gap-4 lg:gap-5 justify-between md:justify-end md:w-auto md:ml-auto border-t border-border-default/60 pt-2 md:border-none md:pt-0">
        <app-verification-badge *ngIf="isAuthenticatedSig()"
          class="hidden lg:inline-flex"></app-verification-badge>
        <!-- Language Selector -->
        <app-language-selector></app-language-selector>
        <!-- Help Button -->
        <app-help-button></app-help-button>
        <!-- Notifications -->
        <app-notifications *ngIf="isAuthenticatedSig()"></app-notifications>
        <!-- Share App Button -->
        <app-share-button type="app" label="" buttonClass="icon-button h-10 w-10 lg:h-11 lg:w-11"
          ariaLabel="Compartir Autorentar"></app-share-button>

        <!-- User Profile Button -->
        <a *ngIf="!isAuthenticatedSig()" routerLink="/auth/login"
          class="btn-accent shadow-soft hover:shadow-elevated transition-shadow duration-200">
          {{ 'auth.login.button' | translate }}
        </a>
        <!-- Profile Menu Dropdown -->
        <div *ngIf="isAuthenticatedSig()" class="relative" data-profile-button>
          <button #profileButton (click)="toggleProfileMenu()" [class.ring-2]="profileMenuOpen()"
            [class.ring-cta-default]="profileMenuOpen()"
            class="relative flex items-center justify-center h-10 w-10 rounded-full overflow-hidden bg-surface-secondary hover:ring-2 hover:ring-cta-default/50 transition-all duration-200"
            [attr.aria-label]="'nav.profile' | translate" [attr.aria-expanded]="profileMenuOpen()"
            type="button" data-testid="user-menu">
            <img *ngIf="userProfile()?.avatar_url; else profilePlaceholder"
              [src]="userProfile()!.avatar_url" [alt]="userProfile()?.full_name || 'Profile'"
              class="h-full w-full object-cover" loading="lazy" />
            <ng-template #profilePlaceholder>
              <app-icon name="user" [size]="20" cssClass="text-secondary" />
            </ng-template>
          </button>

          <!-- Dropdown Menu - Reorganizado con secciones -->
          <div *ngIf="profileMenuOpen()" data-profile-menu
            appClickOutside
            [exclude]="profileMenuExcludedElements"
            (clickOutside)="closeProfileMenu()"
            class="absolute right-0 mt-2 w-72 rounded-2xl bg-surface-raised border border-border-default shadow-2xl z-50 max-h-[calc(100vh-120px)] overflow-y-auto overflow-x-hidden"
            role="menu" aria-orientation="vertical">

            <!-- User Info Header (sticky) -->
            <div class="sticky top-0 z-10 px-4 py-4 border-b border-border-subtle bg-gradient-to-br from-surface-raised to-surface-secondary/30 backdrop-blur-sm rounded-t-2xl">
              <div class="flex items-center gap-3">
                <div class="relative h-12 w-12 rounded-full overflow-hidden bg-surface-secondary ring-2 ring-cta-default/20">
                  <img *ngIf="userProfile()?.avatar_url" [src]="userProfile()!.avatar_url"
                    [alt]="userProfile()?.full_name || 'Profile'" class="h-full w-full object-cover" />
                  <app-icon *ngIf="!userProfile()?.avatar_url" name="user" [size]="24"
                    cssClass="absolute inset-0 m-auto text-secondary" />
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold text-primary truncate">
                    {{ userProfile()?.full_name || 'Usuario' }}
                  </p>
                  <p class="text-xs text-secondary/80 truncate">{{ userEmail() || '' }}</p>
                </div>
              </div>
            </div>

            <div class="py-2">
              <!-- SECCIÓN: MIS ACTIVIDADES -->
              <div class="px-4 py-2">
                <p class="text-[10px] font-bold uppercase tracking-wider text-blue-600">Mis Actividades</p>
              </div>

              <a routerLink="/bookings" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-blue-500/10 text-blue-600 group-hover:bg-blue-500/20">
                  <app-icon name="calendar" [size]="18" />
                </div>
                <span class="flex-1">Mis Reservas</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/cars/my" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-blue-500/10 text-blue-600 group-hover:bg-blue-500/20">
                  <app-icon name="archive" [size]="18" />
                </div>
                <span class="flex-1">Mis Autos</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/bookings/calendar" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-blue-500/10 text-blue-600 group-hover:bg-blue-500/20">
                  <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
                <span class="flex-1">Calendario</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/favorites" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-blue-500/10 text-blue-600 group-hover:bg-blue-500/20">
                  <app-icon name="heart" [size]="18" />
                </div>
                <span class="flex-1">Favoritos</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <div class="my-2 mx-3 border-t border-border-subtle"></div>

              <!-- SECCIÓN: COMUNICACIÓN -->
              <div class="px-4 py-2">
                <p class="text-[10px] font-bold uppercase tracking-wider text-violet-600">Comunicación</p>
              </div>

              <a routerLink="/messages" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-violet-500/10 text-violet-600 group-hover:bg-violet-500/20">
                  <app-icon name="message" [size]="18" />
                </div>
                <span class="flex-1">Mensajes</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/profile/notifications-settings" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-violet-500/10 text-violet-600 group-hover:bg-violet-500/20">
                  <app-icon name="bell" [size]="18" />
                </div>
                <span class="flex-1">Notificaciones</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <div class="my-2 mx-3 border-t border-border-subtle"></div>

              <!-- SECCIÓN: FINANZAS -->
              <div class="px-4 py-2">
                <p class="text-[10px] font-bold uppercase tracking-wider text-emerald-600">Finanzas</p>
              </div>

              <a routerLink="/wallet" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-emerald-500/10 text-emerald-600 group-hover:bg-emerald-500/20">
                  <app-icon name="wallet" [size]="18" />
                </div>
                <span class="flex-1">Wallet</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/wallet/payouts" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-emerald-500/10 text-emerald-600 group-hover:bg-emerald-500/20">
                  <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                  </svg>
                </div>
                <span class="flex-1">Retiros</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/wallet/earnings" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-emerald-500/10 text-emerald-600 group-hover:bg-emerald-500/20">
                  <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                  </svg>
                </div>
                <span class="flex-1">Mis Ganancias</span>
                <span class="text-[10px] font-semibold px-1.5 py-0.5 rounded bg-emerald-100 text-emerald-700">NEW</span>
              </a>

              <div class="my-2 mx-3 border-t border-border-subtle"></div>

              <!-- SECCIÓN: CONFIGURACIÓN -->
              <div class="px-4 py-2">
                <p class="text-[10px] font-bold uppercase tracking-wider text-gray-500">Configuración</p>
              </div>

              <a routerLink="/profile" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-gray-500/10 text-gray-600 group-hover:bg-gray-500/20">
                  <app-icon name="user" [size]="18" />
                </div>
                <span class="flex-1">Editar Perfil</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/profile/location-settings" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-gray-500/10 text-gray-600 group-hover:bg-gray-500/20">
                  <app-icon name="location" [size]="18" />
                </div>
                <span class="flex-1">Mi Dirección</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/profile/security" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-gray-500/10 text-gray-600 group-hover:bg-gray-500/20">
                  <app-icon name="shield" [size]="18" />
                </div>
                <span class="flex-1">Seguridad</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/profile/preferences" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-gray-500/10 text-gray-600 group-hover:bg-gray-500/20">
                  <app-icon name="settings" [size]="18" />
                </div>
                <span class="flex-1">Preferencias</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <a routerLink="/profile/driver-profile" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-gray-500/10 text-gray-600 group-hover:bg-gray-500/20">
                  <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <span class="flex-1">Conductor</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <div class="my-2 mx-3 border-t border-border-subtle"></div>

              <!-- SECCIÓN: AYUDA -->
              <div class="px-4 py-2">
                <p class="text-[10px] font-bold uppercase tracking-wider text-amber-600">Ayuda</p>
              </div>

              <a routerLink="/help" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-amber-500/10 text-amber-600 group-hover:bg-amber-500/20">
                  <app-icon name="help" [size]="18" />
                </div>
                <span class="flex-1">Centro de Ayuda</span>
                <span class="text-[10px] font-semibold px-1.5 py-0.5 rounded bg-amber-100 text-amber-700">NEW</span>
              </a>

              <a routerLink="/profile/contact" (click)="closeProfileMenu()"
                class="menu-item group" role="menuitem">
                <div class="menu-icon bg-amber-500/10 text-amber-600 group-hover:bg-amber-500/20">
                  <svg class="h-[18px] w-[18px]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                </div>
                <span class="flex-1">Contactar Soporte</span>
                <app-icon name="chevron-right" [size]="16" cssClass="menu-chevron" />
              </a>

              <div class="my-2 mx-3 border-t border-border-subtle"></div>

              <!-- CERRAR SESIÓN -->
              <button (click)="signOut()"
                class="menu-item group text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 w-full"
                role="menuitem" type="button">
                <div class="menu-icon bg-red-500/10 text-red-600 group-hover:bg-red-500/20">
                  <app-icon name="logout" [size]="18" />
                </div>
                <span class="flex-1 text-left">Cerrar Sesión</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Verification Prompt Banner -->
  <app-verification-prompt-banner
    *ngIf="isAuthenticatedSig() && !isOnVerificationPage()"></app-verification-prompt-banner>

  <!-- Pending Reviews Banner -->
  <div *ngIf="isAuthenticatedSig()" class="mx-auto max-w-7xl w-full px-4 pt-4">
    <app-pending-reviews-banner></app-pending-reviews-banner>
  </div>

  <!-- Main Content Area -->
  <main id="main-content" class="app-main w-full pb-20 md:pb-0"
    [class.container-page]="!fullBleedLayout()" [class.mx-auto]="!fullBleedLayout()"
    [class.max-w-none]="fullBleedLayout()" [class.px-container]="!fullBleedLayout()"
    [class.py-section-sm]="!fullBleedLayout()" [class.px-0]="fullBleedLayout()"
    [class.py-0]="fullBleedLayout()" [class.full-bleed-safe]="fullBleedLayout()">
    <div>
      <router-outlet></router-outlet>
    </div>
  </main>

  <!-- Floating Comparison Badge (ajustado para no chocar con bottom nav) -->
  <a *ngIf="compareCountSig() > 0" routerLink="/cars/compare"
    class="fixed bottom-24 right-6 md:bottom-6 z-40 flex items-center gap-3 px-5 py-3 rounded-full bg-cta-default text-cta-text shadow-2xl hover:shadow-3xl hover:scale-105 transition-all duration-300 animate-fade-in"
    aria-label="Ver comparación de autos">
    <app-icon name="clipboard" [size]="20" />
    <span class="font-semibold text-sm">Comparando ({{ compareCountSig() }})</span>
  </a>

  <!-- Footer Profesional (oculto en móvil, visible en desktop) -->
  <app-footer class="hidden md:block"></app-footer>
</div>

<!-- Bottom Navigation Bar (V2) - Visible solo en móvil -->
<!-- IMPORTANTE: Debe estar fuera del contenedor principal para que position:fixed funcione -->
<!-- TODO: Re-add when bottom-nav-bar component is created -->
<!-- <app-bottom-nav-bar class="md:hidden"></app-bottom-nav-bar> -->

<!-- Mobile Bottom Navigation (solo movil) - Renderizado via Portal Service directamente en body -->
<!-- El componente se crea dinamicamente en app.component.ts usando MobileBottomNavPortalService -->

<!-- Mobile Menu Drawer - Bottom Sheet Style -->
<app-mobile-menu-drawer
  *ngIf="isAuthenticatedSig()"
  [open]="mobileMenuDrawerOpen()"
  [userProfile]="userProfile()"
  (closeDrawer)="closeMobileMenuDrawer()">
</app-mobile-menu-drawer>

<!-- PWA Install Banner - Minimalista y menos intrusivo que pwa-install-prompt -->
<app-pwa-install-banner></app-pwa-install-banner>
