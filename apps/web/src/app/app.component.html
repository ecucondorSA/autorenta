<!-- Splash Loader -->
@if (showSplash()) {
  <app-splash></app-splash>
}

<!-- PWA Components -->
<app-pwa-titlebar></app-pwa-titlebar>
<app-pwa-install-prompt></app-pwa-install-prompt>
<app-pwa-update-prompt></app-pwa-update-prompt>

<!-- Professional Notification System (PrimeNG Toast) -->
<p-toast position="top-right" [life]="5000"></p-toast>

<!-- App Shell - Layout Neutral Premium -->
<div
  [class.opacity-0]="showSplash()"
  [class.pointer-events-none]="showSplash()"
  class="min-h-dvh grid grid-rows-[auto_1fr_auto] bg-surface-base dark:bg-surface-base transition-opacity duration-500"
>
  <!-- Header Responsive -->
  <header
    id="main-header"
    class="sticky top-0 z-sticky border-b border-border-default/70 dark:border-slate-700/50 backdrop-blur-md bg-surface-raised dark:bg-slate-900 supports-[backdrop-filter]:bg-surface-raised shadow-sm dark:shadow-slate-950/50 pt-[env(safe-area-inset-top)]"
  >
    <a
      class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 px-3 py-2 rounded-lg bg-surface-secondary dark:bg-surface-secondary"
      href="#main-content"
    >
      {{ 'common.skipToContent' | translate }}
    </a>

    <div
      class="container-page px-container flex flex-col md:flex-row md:flex-wrap md:items-center gap-3 sm:gap-5 py-1 min-h-[3.5rem]"
    >
      <div class="flex w-full md:flex-1 items-center gap-2 sm:gap-4 min-w-0">
        <!-- Menu Toggle (mobile) -->
        <button
          type="button"
          (click)="toggleSidebar()"
          class="icon-button lg:hidden shrink-0 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-cta-default"
          [attr.aria-label]="'nav.openMenu' | translate"
          aria-haspopup="dialog"
          aria-controls="mobile-sidebar"
          [attr.aria-expanded]="sidebarOpen()"
          #menuButton
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>

        <!-- Logo -->
        <a
          routerLink="/"
          data-tour-step="welcome-hero"
          class="group flex items-center gap-3 hover:opacity-100 transition-base"
        >
          <img
            ngSrc="/assets/images/autorentar-logo.png"
            alt="Autorentar"
            width="500"
            height="500"
            priority
            class="h-12 md:h-14 w-auto object-contain drop-shadow-lg transition-transform duration-200 group-hover:scale-[1.04] dark:drop-shadow-[0_0_8px_rgba(255,255,255,0.3)] dark:brightness-0 dark:invert"
          />
          <span class="flex flex-col leading-tight">
            <span
              class="text-[1.05rem] font-semibold text-text-primary dark:text-white group-hover:text-cta-default dark:group-hover:text-cyan-400 transition-colors"
            >
              Autorentar
            </span>
            <span
              class="text-[0.68rem] uppercase tracking-[0.22em] text-text-muted dark:text-gray-300"
            >
              Car Sharing
            </span>
          </span>
        </a>

        <!-- Desktop Navigation -->
        <nav
          id="main-nav"
          data-tour-step="welcome-nav"
          class="hidden lg:flex items-center gap-3 xl:gap-4 ml-2 xl:ml-6"
          role="navigation"
          aria-label="Principal"
        >
          <a
            routerLink="/cars"
            routerLinkActive="nav-link-active"
            [routerLinkActiveOptions]="{ exact: false }"
            class="nav-link nav-link-primary"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m21 21-4.35-4.35m1.35-4.65a6 6 0 1 1-12 0 6 6 0 0 1 12 0z"
              />
            </svg>
            <span>{{ 'nav.cars' | translate }}</span>
          </a>
          <a
            routerLink="/cars/publish"
            routerLinkActive="nav-link-active"
            class="nav-link nav-link-highlight"
          >
            Publicar auto
          </a>
          <a
            *ngIf="isAuthenticatedSig()"
            routerLink="/bookings"
            routerLinkActive="nav-link-active"
            class="nav-link"
          >
            {{ 'nav.bookings' | translate }}
          </a>
          <a
            *ngIf="isAuthenticatedSig()"
            routerLink="/wallet"
            routerLinkActive="nav-link-active"
            class="nav-link"
          >
            {{ 'nav.wallet' | translate }}
          </a>
          <a
            *ngIf="isAuthenticatedSig()"
            routerLink="/messages"
            routerLinkActive="nav-link-active"
            class="nav-link"
          >
            Mensajes
          </a>
          <a
            *ngIf="isAuthenticatedSig()"
            routerLink="/favorites"
            routerLinkActive="nav-link-active"
            class="nav-link"
          >
            Favoritos
          </a>
        </nav>
      </div>

      <!-- Actions -->
      <div
        class="flex w-full flex-wrap lg:flex-nowrap items-center gap-2 gap-y-3 sm:gap-3 lg:gap-4 justify-between md:justify-end md:w-auto md:ml-auto border-t border-border-default/60 dark:border-slate-700/60 pt-2 md:border-none md:pt-0"
      >
        <app-verification-badge
          *ngIf="isAuthenticatedSig()"
          class="hidden lg:inline-flex"
        ></app-verification-badge>
        <!-- Language Selector -->
        <app-language-selector></app-language-selector>
        <!-- Help Button -->
        <app-help-button></app-help-button>
        <!-- Notifications -->
        <app-notifications *ngIf="isAuthenticatedSig()"></app-notifications>
        <!-- Theme Toggle -->
        <button
          (click)="toggleDarkMode()"
          class="icon-button h-10 w-10 lg:h-11 lg:w-11"
          [attr.aria-label]="'common.changeTheme' | translate"
        >
          <svg
            *ngIf="!darkMode()"
            class="w-5 h-5 lg:w-6 lg:h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            />
          </svg>
          <svg
            *ngIf="darkMode()"
            class="w-5 h-5 lg:w-6 lg:h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            />
          </svg>
        </button>

        <!-- Share App Button -->
        <app-share-button
          type="app"
          label=""
          buttonClass="icon-button h-10 w-10 lg:h-11 lg:w-11"
          ariaLabel="Compartir Autorentar"
        ></app-share-button>

        <!-- User Profile Button -->
        <a
          *ngIf="!isAuthenticatedSig()"
          routerLink="/auth/login"
          class="btn-accent shadow-soft hover:shadow-elevated transition-shadow duration-200"
        >
          {{ 'auth.login.button' | translate }}
        </a>
        <!-- Profile Menu Dropdown -->
        <div *ngIf="isAuthenticatedSig()" class="relative" data-profile-button>
          <button
            (click)="toggleProfileMenu()"
            [class.ring-2]="profileMenuOpen()"
            [class.ring-cta-default]="profileMenuOpen()"
            class="relative flex items-center justify-center h-10 w-10 rounded-full overflow-hidden bg-surface-secondary dark:bg-surface-secondary hover:ring-2 hover:ring-cta-default/50 transition-all duration-200"
            [attr.aria-label]="'nav.profile' | translate"
            [attr.aria-expanded]="profileMenuOpen()"
            type="button"
          >
            <img
              *ngIf="userProfile()?.avatar_url; else profilePlaceholder"
              [src]="userProfile()!.avatar_url"
              [alt]="userProfile()?.full_name || 'Profile'"
              class="h-full w-full object-cover"
              loading="lazy"
            />
            <ng-template #profilePlaceholder>
              <svg
                class="w-5 h-5 text-text-secondary dark:text-text-secondary"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                />
              </svg>
            </ng-template>
          </button>

          <!-- Dropdown Menu -->
          <div
            *ngIf="profileMenuOpen()"
            data-profile-menu
            class="absolute right-0 mt-2 w-56 rounded-xl bg-surface-raised dark:bg-surface-raised border border-border-default dark:border-border-default shadow-xl z-50 max-h-[calc(100vh-120px)] overflow-y-auto overflow-x-hidden"
            role="menu"
            aria-orientation="vertical"
          >
            <!-- User Info Header (sticky cuando hay scroll) -->
            <div
              class="sticky top-0 z-10 px-4 py-4 border-b border-border-subtle dark:border-border-subtle bg-gradient-to-br from-surface-raised to-surface-secondary/30 dark:from-surface-raised dark:to-surface-secondary/20 backdrop-blur-sm"
            >
              <p class="text-sm font-semibold text-text-primary dark:text-text-primary mb-0.5">
                {{ userProfile()?.full_name || 'Usuario' }}
              </p>
              <p class="text-xs text-text-secondary dark:text-text-secondary/80 truncate">
                {{ userEmail() || '' }}
              </p>
            </div>

            <!-- Menu Items -->
            <div class="py-2">
              <a
                routerLink="/profile"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-primary/10 dark:bg-primary/10 group-hover:bg-primary/20 dark:group-hover:bg-primary/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-primary dark:text-primary"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Mi Perfil</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/cars/my"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-blue-500/10 dark:bg-blue-400/10 group-hover:bg-blue-500/20 dark:group-hover:bg-blue-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-blue-600 dark:text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                    />
                  </svg>
                </div>
                <span class="flex-1">Mis Carros</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/wallet"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-green-500/10 dark:bg-green-400/10 group-hover:bg-green-500/20 dark:group-hover:bg-green-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-green-600 dark:text-green-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Mi Wallet</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <div
                class="my-2 mx-1.5 border-t border-border-subtle dark:border-border-subtle"
              ></div>

              <!-- Verificación y Conductor (críticos) -->
              <a
                routerLink="/profile/verification"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-amber-50/80 dark:hover:bg-amber-900/20 active:bg-amber-100 dark:active:bg-amber-900/30 transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-amber-500/10 dark:bg-amber-400/10 group-hover:bg-amber-500/20 dark:group-hover:bg-amber-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-amber-600 dark:text-amber-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Verificación</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/profile/driver-profile"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-purple-500/10 dark:bg-purple-400/10 group-hover:bg-purple-500/20 dark:group-hover:bg-purple-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-purple-600 dark:text-purple-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Conductor</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/bookings"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-indigo-500/10 dark:bg-indigo-400/10 group-hover:bg-indigo-500/20 dark:group-hover:bg-indigo-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-indigo-600 dark:text-indigo-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Mis Reservas</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                *ngIf="userProfile()?.role === 'owner' || userProfile()?.role === 'both'"
                routerLink="/cars/my"
                (click)="closeProfileMenu()"
                class="flex items-center gap-3 px-4 py-2.5 text-sm text-text-primary dark:text-text-primary hover:bg-surface-secondary dark:hover:bg-surface-secondary transition-colors"
                role="menuitem"
              >
                <svg
                  class="h-5 w-5 text-text-secondary dark:text-text-secondary"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                  />
                </svg>
                Mis Autos
              </a>

              <div
                class="my-2 mx-1.5 border-t border-border-subtle dark:border-border-subtle"
              ></div>

              <!-- Configuración -->
              <a
                routerLink="/profile/contact"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-slate-500/10 dark:bg-slate-400/10 group-hover:bg-slate-500/20 dark:group-hover:bg-slate-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-slate-600 dark:text-slate-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Contacto</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/profile/location-settings"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-red-500/10 dark:bg-red-400/10 group-hover:bg-red-500/20 dark:group-hover:bg-red-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-red-600 dark:text-red-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Dirección</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/profile/notifications-settings"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-yellow-500/10 dark:bg-yellow-400/10 group-hover:bg-yellow-500/20 dark:group-hover:bg-yellow-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-yellow-600 dark:text-yellow-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                    />
                  </svg>
                </div>
                <span class="flex-1">Notificaciones</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/profile/preferences"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-gray-500/10 dark:bg-gray-400/10 group-hover:bg-gray-500/20 dark:group-hover:bg-gray-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-gray-600 dark:text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Preferencias</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/profile/security"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-cyan-500/10 dark:bg-cyan-400/10 group-hover:bg-cyan-500/20 dark:group-hover:bg-cyan-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-cyan-600 dark:text-cyan-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Seguridad</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/favorites"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-pink-500/10 dark:bg-pink-400/10 group-hover:bg-pink-500/20 dark:group-hover:bg-pink-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-pink-600 dark:text-pink-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Favoritos</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/messages"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-blue-500/10 dark:bg-blue-400/10 group-hover:bg-blue-500/20 dark:group-hover:bg-blue-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-blue-600 dark:text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Mensajes</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <a
                routerLink="/wallet/payouts"
                (click)="closeProfileMenu()"
                class="group flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-text-primary dark:text-text-primary hover:bg-surface-secondary/80 dark:hover:bg-surface-secondary/80 active:bg-surface-secondary dark:active:bg-surface-secondary transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-teal-500/10 dark:bg-teal-400/10 group-hover:bg-teal-500/20 dark:group-hover:bg-teal-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-teal-600 dark:text-teal-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"
                    />
                  </svg>
                </div>
                <span class="flex-1">Retiros</span>
                <svg
                  class="h-4 w-4 text-text-tertiary dark:text-text-tertiary opacity-0 group-hover:opacity-100 transition-opacity"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>

              <div class="my-2 border-t border-border-subtle dark:border-border-subtle"></div>

              <button
                (click)="signOut()"
                class="group w-full flex items-center gap-3.5 px-4 py-3 text-sm font-medium text-error-text hover:bg-error-bg/10 dark:hover:bg-error-bg/20 active:bg-error-bg/20 dark:active:bg-error-bg/30 transition-all duration-200 rounded-lg mx-1.5 my-0.5"
                role="menuitem"
                type="button"
              >
                <div
                  class="flex h-9 w-9 items-center justify-center rounded-lg bg-red-500/10 dark:bg-red-400/10 group-hover:bg-red-500/20 dark:group-hover:bg-red-400/20 transition-colors"
                >
                  <svg
                    class="h-5 w-5 text-error-text"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                    />
                  </svg>
                </div>
                <span class="flex-1">Cerrar Sesión</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Verification Prompt Banner -->
  <app-verification-prompt-banner
    *ngIf="isAuthenticatedSig() && !isOnVerificationPage()"
  ></app-verification-prompt-banner>

  <!-- Pending Reviews Banner -->
  <div *ngIf="isAuthenticatedSig()" class="mx-auto max-w-7xl w-full px-4 pt-4">
    <app-pending-reviews-banner></app-pending-reviews-banner>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div
    *ngIf="sidebarOpen()"
    class="fixed inset-0 bg-smoke-black/50 z-modal-backdrop lg:hidden"
    (click)="closeSidebar()"
    aria-hidden="true"
  ></div>

  <!-- Mobile Sidebar -->
  <aside
    id="mobile-sidebar"
    #sidebarPanel
    [class.translate-x-0]="sidebarOpen()"
    [class.-translate-x-full]="!sidebarOpen()"
    [class.hidden]="!sidebarOpen()"
    class="fixed left-0 top-0 h-full w-72 bg-surface-raised dark:bg-surface-raised dark:bg-surface-raised z-modal transform transition-smooth lg:hidden overflow-auto will-change-transform pt-[env(safe-area-inset-top)]"
    role="dialog"
    aria-modal="true"
    aria-label="Menú"
    tabindex="-1"
    (keydown)="onSidebarKeydown($event)"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-8">
        <span class="h5">{{ 'nav.menu' | translate }}</span>
        <button
          (click)="closeSidebar()"
          class="icon-button"
          [attr.aria-label]="'nav.closeMenu' | translate"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      <app-verification-badge
        *ngIf="isAuthenticatedSig()"
        class="mb-6 block lg:hidden"
      ></app-verification-badge>

      <nav class="space-y-2" role="navigation" aria-label="Móvil">
        <a
          routerLink="/cars"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          {{ 'nav.cars' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/cars/publish"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          {{ 'nav.publish' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/bookings"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          {{ 'nav.bookings' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/wallet"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          {{ 'nav.wallet' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/messages"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          Mensajes
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/favorites"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          Favoritos
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/wallet/payouts"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          Retiros
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/bookings/calendar"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          Calendario
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/profile"
          (click)="closeSidebar()"
          class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          <div
            class="relative h-8 w-8 flex-shrink-0 rounded-full overflow-hidden bg-surface-secondary dark:bg-surface-secondary/70"
          >
            <img
              *ngIf="userProfile()?.avatar_url; else sidebarPlaceholder"
              [src]="userProfile()!.avatar_url"
              [alt]="userProfile()?.full_name || 'Profile'"
              class="h-full w-full object-cover"
              loading="lazy"
            />
            <ng-template #sidebarPlaceholder>
              <svg
                class="h-full w-full p-1.5 text-text-secondary dark:text-text-secondary"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
            </ng-template>
          </div>
          {{ 'nav.profile' | translate }}
        </a>
      </nav>
    </div>
  </aside>

  <!-- Main Content Area -->
  <main
    id="main-content"
    class="app-main w-full pb-20 md:pb-0"
    [class.container-page]="!fullBleedLayout()"
    [class.mx-auto]="!fullBleedLayout()"
    [class.max-w-none]="fullBleedLayout()"
    [class.px-container]="!fullBleedLayout()"
    [class.py-section-sm]="!fullBleedLayout()"
    [class.px-0]="fullBleedLayout()"
    [class.py-0]="fullBleedLayout()"
    [class.full-bleed-safe]="fullBleedLayout()"
  >
    <div>
      <router-outlet></router-outlet>
    </div>
  </main>

  <!-- Floating Comparison Badge (ajustado para no chocar con bottom nav) -->
  <a
    *ngIf="compareCountSig() > 0"
    routerLink="/cars/compare"
    class="fixed bottom-24 right-6 md:bottom-6 z-40 flex items-center gap-3 px-5 py-3 rounded-full bg-cta-default text-cta-text shadow-2xl hover:shadow-3xl hover:scale-105 transition-all duration-300 animate-fade-in"
    aria-label="Ver comparación de autos"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
      />
    </svg>
    <span class="font-semibold text-sm">Comparando ({{ compareCountSig() }})</span>
  </a>

  <!-- Footer Profesional (oculto en móvil, visible en desktop) -->
  <app-footer class="hidden md:block"></app-footer>
</div>

<!-- Bottom Navigation Bar (V2) - Visible solo en móvil -->
<!-- IMPORTANTE: Debe estar fuera del contenedor principal para que position:fixed funcione -->
<!-- TODO: Re-add when bottom-nav-bar component is created -->
<!-- <app-bottom-nav-bar class="md:hidden"></app-bottom-nav-bar> -->

<!-- Mobile Bottom Navigation (solo móvil) - Renderizado via Portal Service directamente en body -->
<!-- El componente se crea dinámicamente en app.component.ts usando MobileBottomNavPortalService -->

<!-- PWA Install Banner - Minimalista y menos intrusivo que pwa-install-prompt -->
<app-pwa-install-banner></app-pwa-install-banner>
