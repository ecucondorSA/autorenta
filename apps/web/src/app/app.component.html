<!-- Splash Loader -->
@if (showSplash()) {
  <app-splash-loader></app-splash-loader>
}

<!-- PWA Components -->
<app-pwa-titlebar></app-pwa-titlebar>
<app-pwa-install-prompt></app-pwa-install-prompt>
<app-pwa-update-prompt></app-pwa-update-prompt>

<!-- Toast Notifications -->
<app-toast></app-toast>

<!-- App Shell - Layout Neutral Premium -->
<div
  [class.opacity-0]="showSplash()"
  [class.pointer-events-none]="showSplash()"
  class="min-h-dvh grid grid-rows-[auto_1fr_auto] bg-surface-base dark:bg-surface-base transition-opacity duration-500"
>
  <!-- Header (oculto en móvil, visible en desktop) -->
  <header
    id="main-header"
    class="hidden md:block sticky top-0 z-sticky border-b border-border-default dark:border-slate-700/50 backdrop-blur-md bg-surface-raised dark:bg-slate-900/95 shadow-sm dark:shadow-slate-950/50"
  >
    <a
      class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 px-3 py-2 rounded-lg bg-surface-secondary dark:bg-surface-secondary"
      href="#main-content"
    >
      {{ 'common.skipToContent' | translate }}
    </a>

    <div class="container-page px-container h-16 sm:h-16 flex items-center gap-5 lg:gap-8">
      <!-- Menu Toggle (mobile) -->
      <button
        (click)="toggleSidebar()"
        class="lg:hidden icon-button"
        [attr.aria-label]="'nav.openMenu' | translate"
        aria-controls="mobile-sidebar"
        [attr.aria-expanded]="sidebarOpen()"
        #menuButton
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          />
        </svg>
      </button>

      <!-- Logo -->
      <a
        routerLink="/"
        data-tour-step="welcome-hero"
        class="group flex items-center gap-3 hover:opacity-100 transition-base"
      >
        <img
          ngSrc="/assets/images/autorentar-logo.png"
          alt="Autorentar"
          width="500"
          height="500"
          priority
          class="h-12 md:h-14 w-auto object-contain drop-shadow-lg transition-transform duration-200 group-hover:scale-[1.04] dark:drop-shadow-[0_0_8px_rgba(255,255,255,0.3)] dark:brightness-0 dark:invert"
        />
        <span class="flex flex-col leading-tight">
          <span
            class="text-[1.05rem] font-semibold text-text-primary dark:text-white group-hover:text-cta-default dark:group-hover:text-cyan-400 transition-colors"
          >
            Autorentar
          </span>
          <span
            class="text-[0.68rem] uppercase tracking-[0.22em] text-text-muted dark:text-gray-300"
          >
            Car Sharing
          </span>
        </span>
      </a>

      <!-- Desktop Navigation -->
      <nav
        id="main-nav"
        data-tour-step="welcome-nav"
        class="hidden lg:flex items-center gap-3 xl:gap-4 ml-8"
        role="navigation"
        aria-label="Principal"
      >
        <a
          routerLink="/cars"
          routerLinkActive="nav-link-active"
          [routerLinkActiveOptions]="{ exact: false }"
          class="nav-link nav-link-primary"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="m21 21-4.35-4.35m1.35-4.65a6 6 0 1 1-12 0 6 6 0 0 1 12 0z"
            />
          </svg>
          <span>{{ 'nav.cars' | translate }}</span>
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/cars/publish"
          routerLinkActive="nav-link-active"
          class="nav-link"
        >
          {{ 'nav.publish' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/bookings"
          routerLinkActive="nav-link-active"
          class="nav-link"
        >
          {{ 'nav.bookings' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/wallet"
          routerLinkActive="nav-link-active"
          class="nav-link"
        >
          {{ 'nav.wallet' | translate }}
        </a>
      </nav>

      <!-- Actions -->
      <div class="ml-auto flex items-center gap-3 lg:gap-4">
        <app-verification-badge
          *ngIf="isAuthenticatedSig()"
          class="hidden lg:inline-flex"
        ></app-verification-badge>
        <!-- Language Selector -->
        <app-language-selector></app-language-selector>
        <!-- Help Button -->
        <app-help-button></app-help-button>
        <!-- Notifications -->
        <app-notifications *ngIf="isAuthenticatedSig()"></app-notifications>
        <!-- Theme Toggle -->
        <button
          (click)="toggleDarkMode()"
          class="icon-button h-10 w-10 lg:h-11 lg:w-11"
          [attr.aria-label]="'common.changeTheme' | translate"
        >
          <svg
            *ngIf="!darkMode()"
            class="w-5 h-5 lg:w-6 lg:h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            />
          </svg>
          <svg
            *ngIf="darkMode()"
            class="w-5 h-5 lg:w-6 lg:h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            />
          </svg>
        </button>

        <!-- Share App Button -->
        <app-share-button
          type="app"
          label=""
          buttonClass="icon-button h-10 w-10 lg:h-11 lg:w-11"
          ariaLabel="Compartir Autorentar"
        ></app-share-button>

        <!-- User Profile Button -->
        <a
          *ngIf="!isAuthenticatedSig()"
          routerLink="/auth/login"
          class="btn-accent shadow-soft hover:shadow-elevated transition-shadow duration-200"
        >
          {{ 'auth.login.button' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/profile"
          routerLinkActive="ring-2 ring-cta-default"
          class="relative flex items-center justify-center h-10 w-10 rounded-full overflow-hidden bg-surface-secondary dark:bg-surface-secondary hover:ring-2 hover:ring-cta-default/50 transition-all duration-200"
          [attr.aria-label]="'nav.profile' | translate"
        >
          <img
            *ngIf="userProfile()?.avatar_url; else profilePlaceholder"
            [src]="userProfile()!.avatar_url"
            [alt]="userProfile()?.full_name || 'Profile'"
            class="h-full w-full object-cover"
            loading="lazy"
          />
          <ng-template #profilePlaceholder>
            <svg
              class="w-5 h-5 text-text-secondary dark:text-text-secondary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              />
            </svg>
          </ng-template>
        </a>
      </div>
    </div>
  </header>

  <!-- Verification Prompt Banner -->
  <app-verification-prompt-banner *ngIf="isAuthenticatedSig()"></app-verification-prompt-banner>

  <!-- Pending Reviews Banner -->
  <div *ngIf="isAuthenticatedSig()" class="mx-auto max-w-7xl w-full px-4 pt-4">
    <app-pending-reviews-banner></app-pending-reviews-banner>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div
    *ngIf="sidebarOpen()"
    class="fixed inset-0 bg-smoke-black/50 z-modal-backdrop lg:hidden"
    (click)="closeSidebar()"
    aria-hidden="true"
  ></div>

  <!-- Mobile Sidebar -->
  <aside
    id="mobile-sidebar"
    #sidebarPanel
    [class.translate-x-0]="sidebarOpen()"
    [class.-translate-x-full]="!sidebarOpen()"
    [class.hidden]="!sidebarOpen()"
    class="fixed left-0 top-0 h-full w-72 bg-surface-raised dark:bg-surface-raised dark:bg-surface-raised z-modal transform transition-smooth lg:hidden overflow-auto will-change-transform"
    role="dialog"
    aria-modal="true"
    aria-label="Menú"
    tabindex="-1"
    (keydown)="onSidebarKeydown($event)"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-8">
        <span class="h5">{{ 'nav.menu' | translate }}</span>
        <button
          (click)="closeSidebar()"
          class="icon-button"
          [attr.aria-label]="'nav.closeMenu' | translate"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
            aria-hidden="true"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      <app-verification-badge
        *ngIf="isAuthenticatedSig()"
        class="mb-6 block lg:hidden"
      ></app-verification-badge>

      <nav class="space-y-2" role="navigation" aria-label="Móvil">
        <a
          routerLink="/cars"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          {{ 'nav.cars' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/cars/publish"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          {{ 'nav.publish' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/bookings"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          {{ 'nav.bookings' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/wallet"
          (click)="closeSidebar()"
          class="block px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          {{ 'nav.wallet' | translate }}
        </a>
        <a
          *ngIf="isAuthenticatedSig()"
          routerLink="/profile"
          (click)="closeSidebar()"
          class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-surface-secondary dark:hover:bg-slate-deep transition-base font-medium"
        >
          <div
            class="relative h-8 w-8 flex-shrink-0 rounded-full overflow-hidden bg-surface-secondary dark:bg-surface-secondary/70"
          >
            <img
              *ngIf="userProfile()?.avatar_url; else sidebarPlaceholder"
              [src]="userProfile()!.avatar_url"
              [alt]="userProfile()?.full_name || 'Profile'"
              class="h-full w-full object-cover"
              loading="lazy"
            />
            <ng-template #sidebarPlaceholder>
              <svg
                class="h-full w-full p-1.5 text-text-secondary dark:text-text-secondary"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z"
                />
              </svg>
            </ng-template>
          </div>
          {{ 'nav.profile' | translate }}
        </a>
      </nav>
    </div>
  </aside>

  <!-- Main Content Area -->
  <main
    id="main-content"
    class="app-main w-full pb-20 md:pb-0"
    [class.container-page]="!fullBleedLayout()"
    [class.mx-auto]="!fullBleedLayout()"
    [class.max-w-none]="fullBleedLayout()"
    [class.px-container]="!fullBleedLayout()"
    [class.py-section-sm]="!fullBleedLayout()"
    [class.px-0]="fullBleedLayout()"
    [class.py-0]="fullBleedLayout()"
    [class.full-bleed-safe]="fullBleedLayout()"
  >
    <router-outlet></router-outlet>
  </main>

  <!-- Mobile Bottom Navigation (solo móvil) -->
  <app-mobile-bottom-nav></app-mobile-bottom-nav>

  <!-- PWA Install Banner - Minimalista y menos intrusivo que pwa-install-prompt -->
  <app-pwa-install-banner></app-pwa-install-banner>

  <!-- Floating Comparison Badge (ajustado para no chocar con bottom nav) -->
  <a
    *ngIf="compareCountSig() > 0"
    routerLink="/cars/compare"
    class="fixed bottom-24 right-6 md:bottom-6 z-40 flex items-center gap-3 px-5 py-3 rounded-full bg-cta-default text-cta-text shadow-2xl hover:shadow-3xl hover:scale-105 transition-all duration-300 animate-fade-in"
    aria-label="Ver comparación de autos"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
      />
    </svg>
    <span class="font-semibold text-sm">Comparando ({{ compareCountSig() }})</span>
  </a>

  <!-- Footer Profesional (oculto en móvil, visible en desktop) -->
  <app-footer class="hidden md:block"></app-footer>
</div>
