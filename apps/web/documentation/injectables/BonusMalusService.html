<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>autorenta-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">autorenta-web documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">












<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >BonusMalusService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/services/bonus-malus.service.ts</code>
        </p>





            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#supabase" >supabase</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#calculateBonusMalus" >calculateBonusMalus</a>
                            </li>
                            <li>
                                <a href="#calculateMonetaryImpact" >calculateMonetaryImpact</a>
                            </li>
                            <li>
                                <a href="#getBonusMalusDisplay" >getBonusMalusDisplay</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getBonusMalusFactor" >getBonusMalusFactor</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getBonusMalusStats" >getBonusMalusStats</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getImprovementTips" >getImprovementTips</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getUserBonusMalus" >getUserBonusMalus</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#needsRecalculation" >needsRecalculation</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#recalculateAllBonusMalus" >recalculateAllBonusMalus</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>


            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="calculateBonusMalus"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>calculateBonusMalus</b></span>
                        <a href="#calculateBonusMalus"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>calculateBonusMalus(userId?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="58"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:58</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Calcula el factor bonus-malus para un usuario espec√≠fico</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/BonusMalusCalculation.html" target="_self" >Promise&lt;BonusMalusCalculation | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="calculateMonetaryImpact"></a>
                    <span class="name">
                        <span ><b>calculateMonetaryImpact</b></span>
                        <a href="#calculateMonetaryImpact"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>calculateMonetaryImpact(basePrice: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, factor: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="238"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:238</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Calcula el impacto monetario del factor bonus-malus en una reserva</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>basePrice</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>factor</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>literal type</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getBonusMalusDisplay"></a>
                    <span class="name">
                        <span ><b>getBonusMalusDisplay</b></span>
                        <a href="#getBonusMalusDisplay"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getBonusMalusDisplay(factor: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="98"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:98</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Convierte el factor bonus-malus en un objeto para mostrar en UI</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>factor</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/BonusMalusDisplay.html" target="_self" >BonusMalusDisplay</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getBonusMalusFactor"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getBonusMalusFactor</b></span>
                        <a href="#getBonusMalusFactor"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getBonusMalusFactor(userId?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="86"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:86</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene el factor bonus-malus simple (sin recalcular)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;number&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getBonusMalusStats"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getBonusMalusStats</b></span>
                        <a href="#getBonusMalusStats"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getBonusMalusStats()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="260"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:260</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene estad√≠sticas agregadas del sistema bonus-malus (para admin)</p>
</div>

                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type | null&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getImprovementTips"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getImprovementTips</b></span>
                        <a href="#getImprovementTips"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getImprovementTips(userId?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="175"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:175</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene recomendaciones personalizadas para mejorar el factor</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserBonusMalus"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getUserBonusMalus</b></span>
                        <a href="#getUserBonusMalus"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserBonusMalus(userId?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="20"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:20</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene el factor bonus-malus del usuario autenticado
Recalcula autom√°ticamente si es necesario</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;UserBonusMalus | null&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="needsRecalculation"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>needsRecalculation</b></span>
                        <a href="#needsRecalculation"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>needsRecalculation(userId?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="160"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:160</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Verifica si un usuario necesita recalcular su factor</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;boolean&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="recalculateAllBonusMalus"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>recalculateAllBonusMalus</b></span>
                        <a href="#recalculateAllBonusMalus"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>recalculateAllBonusMalus()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="293"
                                    class="link-to-prism">src/app/core/services/bonus-malus.service.ts:293</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Fuerza el rec√°lculo de todos los usuarios que lo necesiten (admin)</p>
</div>

                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="supabase"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>supabase</b></span>
                        <a href="#supabase"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>injectSupabase()</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="14" class="link-to-prism">src/app/core/services/bonus-malus.service.ts:14</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import type {
  UserBonusMalus,
  BonusMalusCalculation,
  BonusMalusDisplay,
  BonusMalusType,
} from &#x27;../models&#x27;;
import { injectSupabase } from &#x27;./supabase-client.service&#x27;;

@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class BonusMalusService {
  private readonly supabase &#x3D; injectSupabase();

  /**
   * Obtiene el factor bonus-malus del usuario autenticado
   * Recalcula autom√°ticamente si es necesario
   */
  async getUserBonusMalus(userId?: string): Promise&lt;UserBonusMalus | null&gt; {
    try {
      // Si no se proporciona userId, usar el usuario autenticado
      let targetUserId &#x3D; userId;
      if (!targetUserId) {
        const {
          data: { user },
          error: authError,
        } &#x3D; await this.supabase.auth.getUser();
        if (authError) throw authError;
        if (!user?.id) throw new Error(&#x27;Usuario no autenticado&#x27;);
        targetUserId &#x3D; user.id;
      }

      // Obtener factor (usa get_user_bonus_malus que recalcula si es necesario)
      const { data, error } &#x3D; await this.supabase
        .from(&#x27;user_bonus_malus&#x27;)
        .select(&#x27;*&#x27;)
        .eq(&#x27;user_id&#x27;, targetUserId)
        .maybeSingle();

      if (error) throw error;

      // Si no existe, calcular por primera vez
      if (!data) {
        await this.calculateBonusMalus(targetUserId);
        return await this.getUserBonusMalus(targetUserId);
      }

      return data as UserBonusMalus;
    } catch {
      return null;
    }
  }

  /**
   * Calcula el factor bonus-malus para un usuario espec√≠fico
   */
  async calculateBonusMalus(userId?: string): Promise&lt;BonusMalusCalculation | null&gt; {
    try {
      // Si no se proporciona userId, usar el usuario autenticado
      let targetUserId &#x3D; userId;
      if (!targetUserId) {
        const {
          data: { user },
          error: authError,
        } &#x3D; await this.supabase.auth.getUser();
        if (authError) throw authError;
        if (!user?.id) throw new Error(&#x27;Usuario no autenticado&#x27;);
        targetUserId &#x3D; user.id;
      }

      const { data, error } &#x3D; await this.supabase.rpc(&#x27;calculate_user_bonus_malus&#x27;, {
        p_user_id: targetUserId,
      });

      if (error) throw error;
      return data as BonusMalusCalculation;
    } catch {
      return null;
    }
  }

  /**
   * Obtiene el factor bonus-malus simple (sin recalcular)
   */
  async getBonusMalusFactor(userId?: string): Promise&lt;number&gt; {
    try {
      const bonusMalus &#x3D; await this.getUserBonusMalus(userId);
      return bonusMalus?.total_factor ?? 0;
    } catch {
      return 0;
    }
  }

  /**
   * Convierte el factor bonus-malus en un objeto para mostrar en UI
   */
  getBonusMalusDisplay(factor: number): BonusMalusDisplay {
    const percentage &#x3D; Math.abs(factor * 100);
    let type: BonusMalusType;
    let message: string;
    let icon: string;
    let color: string;
    const tips: string[] &#x3D; [];

    if (factor &lt; -0.05) {
      // BONUS significativo
      type &#x3D; &#x27;BONUS&#x27;;
      message &#x3D; &#x60;¬°Tienes un ${percentage.toFixed(0)}% de descuento!&#x60;;
      icon &#x3D; &#x27;üéâ&#x27;;
      color &#x3D; &#x27;text-success-light&#x27;;
      tips.push(&#x27;Mant√©n tu excelente reputaci√≥n para seguir obteniendo descuentos.&#x27;);
    } else if (factor &lt; 0) {
      // BONUS peque√±o
      type &#x3D; &#x27;BONUS&#x27;;
      message &#x3D; &#x60;Tienes un ${percentage.toFixed(0)}% de descuento&#x60;;
      icon &#x3D; &#x27;‚ú®&#x27;;
      color &#x3D; &#x27;text-success-light&#x27;;
      tips.push(&#x27;Completa m√°s reservas y mant√©n un buen rating para aumentar tu descuento.&#x27;);
    } else if (factor &#x3D;&#x3D;&#x3D; 0) {
      // NEUTRAL
      type &#x3D; &#x27;NEUTRAL&#x27;;
      message &#x3D; &#x27;Precio est√°ndar sin ajustes&#x27;;
      icon &#x3D; &#x27;‚ûñ&#x27;;
      color &#x3D; &#x27;text-text-secondary dark:text-text-secondary&#x27;;
      tips.push(&#x27;Completa reservas y obt√©n buenas calificaciones para recibir descuentos.&#x27;);
      tips.push(&#x27;Evita cancelaciones para no recibir recargos.&#x27;);
    } else if (factor &lt;&#x3D; 0.05) {
      // MALUS peque√±o
      type &#x3D; &#x27;MALUS&#x27;;
      message &#x3D; &#x60;Tienes un ${percentage.toFixed(0)}% de recargo&#x60;;
      icon &#x3D; &#x27;‚ö†Ô∏è&#x27;;
      color &#x3D; &#x27;text-warning-light&#x27;;
      tips.push(&#x27;Mejora tu rating completando reservas exitosas.&#x27;);
      tips.push(&#x27;Evita cancelaciones para reducir el recargo.&#x27;);
    } else {
      // MALUS significativo
      type &#x3D; &#x27;MALUS&#x27;;
      message &#x3D; &#x60;Tienes un ${percentage.toFixed(0)}% de recargo&#x60;;
      icon &#x3D; &#x27;‚õî&#x27;;
      color &#x3D; &#x27;text-error-text&#x27;;
      tips.push(&#x27;Tu historial necesita mejorar para reducir el recargo.&#x27;);
      tips.push(&#x27;Completa reservas sin incidentes y obt√©n mejores calificaciones.&#x27;);
      tips.push(&#x27;Verifica tu identidad para reducir el recargo.&#x27;);
    }

    return {
      type,
      percentage,
      message,
      icon,
      color,
      tips,
    };
  }

  /**
   * Verifica si un usuario necesita recalcular su factor
   */
  async needsRecalculation(userId?: string): Promise&lt;boolean&gt; {
    try {
      const bonusMalus &#x3D; await this.getUserBonusMalus(userId);
      if (!bonusMalus) return true;

      const nextRecalc &#x3D; new Date(bonusMalus.next_recalculation_at);
      return nextRecalc &lt; new Date();
    } catch {
      return false;
    }
  }

  /**
   * Obtiene recomendaciones personalizadas para mejorar el factor
   */
  async getImprovementTips(userId?: string): Promise&lt;string[]&gt; {
    try {
      const bonusMalus &#x3D; await this.getUserBonusMalus(userId);
      if (!bonusMalus) return [];

      const tips: string[] &#x3D; [];
      const metrics &#x3D; bonusMalus.metrics;

      // Analizar rating
      if (metrics.average_rating &lt; 4.0 &amp;&amp; metrics.average_rating &gt; 0) {
        tips.push(
          &#x27;üìä Mejora tu rating: Actualmente tienes &#x27; +
            metrics.average_rating.toFixed(1) +
            &#x27;/5.0. Enf√≥cate en la comunicaci√≥n y puntualidad.&#x27;,
        );
      }

      // Analizar cancelaciones
      if (metrics.cancellation_rate &gt; 0.1) {
        tips.push(
          &#x27;üö´ Reduce cancelaciones: Tu tasa actual es &#x27; +
            (metrics.cancellation_rate * 100).toFixed(0) +
            &#x27;%. Evita cancelar reservas confirmadas.&#x27;,
        );
      }

      // Analizar experiencia
      if (metrics.completed_rentals &lt; 10) {
        tips.push(
          &#x27;üöó Gana experiencia: Completa &#x27; +
            (10 - metrics.completed_rentals) +
            &#x27; reservas m√°s para obtener mejores descuentos.&#x27;,
        );
      }

      // Analizar verificaci√≥n
      if (!metrics.is_verified) {
        tips.push(
          &#x27;‚úÖ Verifica tu identidad: Los usuarios verificados reciben hasta 3% de descuento adicional.&#x27;,
        );
      }

      // Si el usuario ya est√° excelente
      if (
        metrics.average_rating &gt;&#x3D; 4.8 &amp;&amp;
        metrics.cancellation_rate &lt; 0.05 &amp;&amp;
        metrics.is_verified &amp;&amp;
        metrics.completed_rentals &gt;&#x3D; 20
      ) {
        tips.push(
          &#x27;üèÜ ¬°Excelente! Tienes el m√°ximo descuento posible. Mant√©n este nivel de servicio.&#x27;,
        );
      }

      return tips;
    } catch {
      return [];
    }
  }

  /**
   * Calcula el impacto monetario del factor bonus-malus en una reserva
   */
  calculateMonetaryImpact(
    basePrice: number,
    factor: number,
  ): {
    adjustedPrice: number;
    difference: number;
    percentageChange: number;
  } {
    const adjustedPrice &#x3D; basePrice * (1 + factor);
    const difference &#x3D; adjustedPrice - basePrice;
    const percentageChange &#x3D; factor * 100;

    return {
      adjustedPrice: Math.round(adjustedPrice * 100) / 100,
      difference: Math.round(difference * 100) / 100,
      percentageChange: Math.round(percentageChange * 10) / 10,
    };
  }

  /**
   * Obtiene estad√≠sticas agregadas del sistema bonus-malus (para admin)
   */
  async getBonusMalusStats(): Promise&lt;{
    totalUsers: number;
    usersWithBonus: number;
    usersWithMalus: number;
    usersNeutral: number;
    averageFactor: number;
  } | null&gt; {
    try {
      const { data, error } &#x3D; await this.supabase.from(&#x27;user_bonus_malus&#x27;).select(&#x27;total_factor&#x27;);

      if (error) throw error;

      const totalUsers &#x3D; data.length;
      const usersWithBonus &#x3D; data.filter((u) &#x3D;&gt; u.total_factor &lt; 0).length;
      const usersWithMalus &#x3D; data.filter((u) &#x3D;&gt; u.total_factor &gt; 0).length;
      const usersNeutral &#x3D; data.filter((u) &#x3D;&gt; u.total_factor &#x3D;&#x3D;&#x3D; 0).length;
      const averageFactor &#x3D; data.reduce((sum, u) &#x3D;&gt; sum + u.total_factor, 0) / totalUsers;

      return {
        totalUsers,
        usersWithBonus,
        usersWithMalus,
        usersNeutral,
        averageFactor,
      };
    } catch {
      return null;
    }
  }

  /**
   * Fuerza el rec√°lculo de todos los usuarios que lo necesiten (admin)
   */
  async recalculateAllBonusMalus(): Promise&lt;{ count: number; success: boolean }&gt; {
    try {
      const { data, error } &#x3D; await this.supabase.rpc(&#x27;recalculate_all_bonus_malus&#x27;);

      if (error) throw error;

      return {
        count: data as number,
        success: true,
      };
    } catch {
      return {
        count: 0,
        success: false,
      };
    }
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'BonusMalusService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
