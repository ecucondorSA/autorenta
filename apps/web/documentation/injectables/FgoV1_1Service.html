<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>autorenta-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">autorenta-web documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">












<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >FgoV1_1Service</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/services/fgo-v1-1.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Servicio para gestionar FGO v1.1 (Extensión de FgoService)</p>
<p>NUEVAS FUNCIONALIDADES v1.1:</p>
<ul>
<li>Gestión de parámetros por país/bucket</li>
<li>Snapshots de riesgo por booking</li>
<li>Inspecciones de vehículo</li>
<li>Evaluación de elegibilidad</li>
<li>Ejecución de waterfall</li>
<li>Métricas extendidas (PEM, RC dinámico)</li>
</ul>

            </p>



            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#riskSnapshotTable" >riskSnapshotTable</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#supabaseClient" >supabaseClient</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                <a href="#adjustAlphaDynamic" >adjustAlphaDynamic</a>
                            </li>
                            <li>
                                <a href="#assessEligibility" >assessEligibility</a>
                            </li>
                            <li>
                                <a href="#calculatePem" >calculatePem</a>
                            </li>
                            <li>
                                <a href="#calculateRcV1_1" >calculateRcV1_1</a>
                            </li>
                            <li>
                                <a href="#createInspection" >createInspection</a>
                            </li>
                            <li>
                                <a href="#createRiskSnapshot" >createRiskSnapshot</a>
                            </li>
                            <li>
                                <a href="#executeWaterfall" >executeWaterfall</a>
                            </li>
                            <li>
                                <a href="#getAllParameters" >getAllParameters</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getCurrentUserId" >getCurrentUserId</a>
                            </li>
                            <li>
                                <a href="#getInspectionByStage" >getInspectionByStage</a>
                            </li>
                            <li>
                                <a href="#getInspections" >getInspections</a>
                            </li>
                            <li>
                                <a href="#getMovements" >getMovements</a>
                            </li>
                            <li>
                                <a href="#getParameters" >getParameters</a>
                            </li>
                            <li>
                                <a href="#getRiskSnapshot" >getRiskSnapshot</a>
                            </li>
                            <li>
                                <a href="#getStatusV1_1" >getStatusV1_1</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#isAdmin" >isAdmin</a>
                            </li>
                            <li>
                                <a href="#paySiniestro" >paySiniestro</a>
                            </li>
                            <li>
                                <a href="#recalculateMetrics" >recalculateMetrics</a>
                            </li>
                            <li>
                                <a href="#signInspection" >signInspection</a>
                            </li>
                            <li>
                                <a href="#transferBetweenSubfunds" >transferBetweenSubfunds</a>
                            </li>
                            <li>
                                <a href="#updateParameters" >updateParameters</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(supabaseService: <a href="../injectables/SupabaseClientService.html" target="_self">SupabaseClientService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="50" class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:50</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>supabaseService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/SupabaseClientService.html" target="_self" >SupabaseClientService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="adjustAlphaDynamic"></a>
                    <span class="name">
                        <span ><b>adjustAlphaDynamic</b></span>
                        <a href="#adjustAlphaDynamic"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>adjustAlphaDynamic(countryCode: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, bucket: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="436"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:436</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Ajusta alpha dinámicamente según RC (solo ejecutable por admin/cron)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>countryCode</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>bucket</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/AlphaAdjustment.html" target="_self" >Observable&lt;AlphaAdjustment | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="assessEligibility"></a>
                    <span class="name">
                        <span ><b>assessEligibility</b></span>
                        <a href="#assessEligibility"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>assessEligibility(params: <a href="../interfaces/AssessEligibilityParams.html" target="_self">AssessEligibilityParams</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="475"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:475</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Evalúa la elegibilidad de un booking para cobertura FGO</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>params</td>
                                            <td>
                                                            <code><a href="../interfaces/AssessEligibilityParams.html" target="_self" >AssessEligibilityParams</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/EligibilityResult.html" target="_self" >Observable&lt;EligibilityResult | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="calculatePem"></a>
                    <span class="name">
                        <span ><b>calculatePem</b></span>
                        <a href="#calculatePem"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>calculatePem(countryCode?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, bucket?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, windowDays: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="357"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:357</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Calcula PEM (Pérdida Esperada Mensual) para un país/bucket</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>countryCode</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>bucket</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>windowDays</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>90</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/PemCalculation.html" target="_self" >Observable&lt;PemCalculation | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="calculateRcV1_1"></a>
                    <span class="name">
                        <span ><b>calculateRcV1_1</b></span>
                        <a href="#calculateRcV1_1"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>calculateRcV1_1(countryCode?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, bucket?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="399"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:399</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Calcula RC dinámico v1.1 (basado en PEM)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>countryCode</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>bucket</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/RcCalculationV1_1.html" target="_self" >Observable&lt;RcCalculationV1_1 | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createInspection"></a>
                    <span class="name">
                        <span ><b>createInspection</b></span>
                        <a href="#createInspection"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>createInspection(params: <a href="../interfaces/CreateInspectionParams.html" target="_self">CreateInspectionParams</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="204"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:204</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Crea una inspección de vehículo</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>params</td>
                                            <td>
                                                            <code><a href="../interfaces/CreateInspectionParams.html" target="_self" >CreateInspectionParams</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;BookingInspection | null&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createRiskSnapshot"></a>
                    <span class="name">
                        <span ><b>createRiskSnapshot</b></span>
                        <a href="#createRiskSnapshot"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>createRiskSnapshot(params: <a href="../interfaces/CreateRiskSnapshotParams.html" target="_self">CreateRiskSnapshotParams</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="140"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:140</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Crea un snapshot de riesgo para un booking</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>params</td>
                                            <td>
                                                            <code><a href="../interfaces/CreateRiskSnapshotParams.html" target="_self" >CreateRiskSnapshotParams</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;BookingRiskSnapshot | null&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="executeWaterfall"></a>
                    <span class="name">
                        <span ><b>executeWaterfall</b></span>
                        <a href="#executeWaterfall"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>executeWaterfall(params: <a href="../interfaces/ExecuteWaterfallParams.html" target="_self">ExecuteWaterfallParams</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="517"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:517</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Ejecuta el waterfall completo de cobros
IMPORTANTE: Solo ejecutable por service role (admin/sistema)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>params</td>
                                            <td>
                                                            <code><a href="../interfaces/ExecuteWaterfallParams.html" target="_self" >ExecuteWaterfallParams</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/WaterfallResult.html" target="_self" >Observable&lt;WaterfallResult | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getAllParameters"></a>
                    <span class="name">
                        <span ><b>getAllParameters</b></span>
                        <a href="#getAllParameters"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getAllParameters()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="87"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:87</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene todos los parámetros FGO (todos los países/buckets)</p>
</div>

                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/FgoParameters.html" target="_self" >Observable&lt;FgoParameters[]&gt;</a></code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getCurrentUserId"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getCurrentUserId</b></span>
                        <a href="#getCurrentUserId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getCurrentUserId()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="583"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:583</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene el ID del usuario actual</p>
</div>

                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string | null&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getInspectionByStage"></a>
                    <span class="name">
                        <span ><b>getInspectionByStage</b></span>
                        <a href="#getInspectionByStage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getInspectionByStage(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, stage: "check_in" | "check_out")</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="279"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:279</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene una inspección específica (por booking y stage)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>stage</td>
                                            <td>
                                                        <code>&quot;check_in&quot; | &quot;check_out&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;BookingInspection | null&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getInspections"></a>
                    <span class="name">
                        <span ><b>getInspections</b></span>
                        <a href="#getInspections"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getInspections(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="256"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:256</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene las inspecciones de un booking</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;BookingInspection[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getMovements"></a>
                    <span class="name">
                        <span ><b>getMovements</b></span>
                        <a href="#getMovements"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getMovements(limit: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, offset: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="590"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:590</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>limit</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>offset</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;FgoMovementView[]&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getParameters"></a>
                    <span class="name">
                        <span ><b>getParameters</b></span>
                        <a href="#getParameters"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getParameters(countryCode: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, bucket: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="63"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:63</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene los parámetros FGO para un país/bucket específico</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>countryCode</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>bucket</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/FgoParameters.html" target="_self" >Observable&lt;FgoParameters | null&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getRiskSnapshot"></a>
                    <span class="name">
                        <span ><b>getRiskSnapshot</b></span>
                        <a href="#getRiskSnapshot"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getRiskSnapshot(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="175"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:175</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene el snapshot de riesgo de un booking</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;BookingRiskSnapshot | null&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getStatusV1_1"></a>
                    <span class="name">
                        <span ><b>getStatusV1_1</b></span>
                        <a href="#getStatusV1_1"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getStatusV1_1()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="310"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:310</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Obtiene el estado extendido del FGO con métricas v1.1</p>
</div>

                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;FgoStatusV1_1 | null&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="isAdmin"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>isAdmin</b></span>
                        <a href="#isAdmin"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>isAdmin()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="565"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:565</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Verifica si el usuario actual es admin</p>
</div>

                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;boolean&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="paySiniestro"></a>
                    <span class="name">
                        <span ><b>paySiniestro</b></span>
                        <a href="#paySiniestro"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>paySiniestro(params: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="652"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:652</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>params</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="recalculateMetrics"></a>
                    <span class="name">
                        <span ><b>recalculateMetrics</b></span>
                        <a href="#recalculateMetrics"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>recalculateMetrics()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="610"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:610</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;literal type&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="signInspection"></a>
                    <span class="name">
                        <span ><b>signInspection</b></span>
                        <a href="#signInspection"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>signInspection(inspectionId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="234"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:234</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Firma una inspección (marca como completada)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>inspectionId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;boolean&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="transferBetweenSubfunds"></a>
                    <span class="name">
                        <span ><b>transferBetweenSubfunds</b></span>
                        <a href="#transferBetweenSubfunds"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>transferBetweenSubfunds(params: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="624"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:624</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>params</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateParameters"></a>
                    <span class="name">
                        <span ><b>updateParameters</b></span>
                        <a href="#updateParameters"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>updateParameters(params: <a href="../interfaces/UpdateParametersParams.html" target="_self">UpdateParametersParams</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="106"
                                    class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:106</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Actualiza parámetros FGO (solo admins)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>params</td>
                                            <td>
                                                            <code><a href="../interfaces/UpdateParametersParams.html" target="_self" >UpdateParametersParams</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Observable&lt;boolean&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="riskSnapshotTable"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>riskSnapshotTable</b></span>
                        <a href="#riskSnapshotTable"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>&#x27;booking_risk_snapshots&#x27;</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="50" class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:50</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="supabaseClient"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>supabaseClient</b></span>
                        <a href="#supabaseClient"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>SupabaseClient</code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="49" class="link-to-prism">src/app/core/services/fgo-v1-1.service.ts:49</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import { Observable, from, map, catchError, of } from &#x27;rxjs&#x27;;
import { SupabaseClient } from &#x27;@supabase/supabase-js&#x27;;

// Models v1.1
import {
  FgoParameters,
  FgoParametersDb,
  BookingRiskSnapshot,
  BookingRiskSnapshotDb,
  BookingInspection,
  BookingInspectionDb,
  FgoStatusV1_1,
  PemCalculation,
  RcCalculationV1_1,
  AlphaAdjustment,
  EligibilityResult,
  WaterfallResult,
  CreateRiskSnapshotParams,
  CreateInspectionParams,
  AssessEligibilityParams,
  ExecuteWaterfallParams,
  UpdateParametersParams,
  mapFgoParameters,
  mapBookingRiskSnapshot,
  mapBookingInspection,
  centsToUsd,
} from &#x27;../models/fgo-v1-1.model&#x27;;

// Models v1.0 (base)
import { FgoMovementView } from &#x27;../models/fgo.model&#x27;;
import { SupabaseClientService } from &#x27;./supabase-client.service&#x27;;

/**
 * Servicio para gestionar FGO v1.1 (Extensión de FgoService)
 *
 * NUEVAS FUNCIONALIDADES v1.1:
 * - Gestión de parámetros por país/bucket
 * - Snapshots de riesgo por booking
 * - Inspecciones de vehículo
 * - Evaluación de elegibilidad
 * - Ejecución de waterfall
 * - Métricas extendidas (PEM, RC dinámico)
 */
@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class FgoV1_1Service {
  private readonly supabaseClient: SupabaseClient;
  private readonly riskSnapshotTable &#x3D; &#x27;booking_risk_snapshots&#x27;;

  constructor(private readonly supabaseService: SupabaseClientService) {
    this.supabaseClient &#x3D; this.supabaseService.getClient();
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // PARÁMETROS FGO
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Obtiene los parámetros FGO para un país/bucket específico
   */
  getParameters(countryCode: string, bucket: string): Observable&lt;FgoParameters | null&gt; {
    return from(
      this.supabaseClient
        .from(&#x27;fgo_parameters&#x27;)
        .select(&#x27;*&#x27;)
        .eq(&#x27;country_code&#x27;, countryCode)
        .eq(&#x27;bucket&#x27;, bucket)
        .single(),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }
        return response.data ? mapFgoParameters(response.data as FgoParametersDb) : null;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  /**
   * Obtiene todos los parámetros FGO (todos los países/buckets)
   */
  getAllParameters(): Observable&lt;FgoParameters[]&gt; {
    return from(
      this.supabaseClient.from(&#x27;fgo_parameters&#x27;).select(&#x27;*&#x27;).order(&#x27;country_code&#x27;).order(&#x27;bucket&#x27;),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return [];
        }
        return (response.data || []).map((p) &#x3D;&gt; mapFgoParameters(p as FgoParametersDb));
      }),
      catchError((_error) &#x3D;&gt; {
        return of([]);
      }),
    );
  }

  /**
   * Actualiza parámetros FGO (solo admins)
   */
  updateParameters(params: UpdateParametersParams): Observable&lt;boolean&gt; {
    const updates: Partial&lt;FgoParametersDb&gt; &#x3D; {};

    if (params.alpha !&#x3D;&#x3D; undefined) updates.alpha &#x3D; params.alpha;
    if (params.rcFloor !&#x3D;&#x3D; undefined) updates.rc_floor &#x3D; params.rcFloor;
    if (params.eventCapUsd !&#x3D;&#x3D; undefined) updates.event_cap_usd &#x3D; params.eventCapUsd;
    if (params.perUserLimit !&#x3D;&#x3D; undefined) updates.per_user_limit &#x3D; params.perUserLimit;

    return from(
      this.supabaseClient
        .from(&#x27;fgo_parameters&#x27;)
        .update(updates)
        .eq(&#x27;country_code&#x27;, params.countryCode)
        .eq(&#x27;bucket&#x27;, params.bucket),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return false;
        }
        return true;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(false);
      }),
    );
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // SNAPSHOTS DE RIESGO
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Crea un snapshot de riesgo para un booking
   */
  createRiskSnapshot(params: CreateRiskSnapshotParams): Observable&lt;BookingRiskSnapshot | null&gt; {
    const snapshotData: Omit&lt;BookingRiskSnapshotDb, &#x27;created_at&#x27;&gt; &#x3D; {
      booking_id: params.bookingId,
      country_code: params.countryCode,
      bucket: params.bucket,
      fx_snapshot: params.fxSnapshot,
      currency: params.currency,
      estimated_hold_amount: params.estimatedHoldAmount,
      estimated_deposit: params.estimatedDeposit,
      franchise_usd: params.franchiseUsd,
      has_card: params.hasCard,
      has_wallet_security: params.hasWalletSecurity,
      meta: {},
    };

    return from(
      this.supabaseClient.from(this.riskSnapshotTable).insert(snapshotData).select().single(),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }
        return response.data
          ? mapBookingRiskSnapshot(response.data as BookingRiskSnapshotDb)
          : null;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  /**
   * Obtiene el snapshot de riesgo de un booking
   */
  getRiskSnapshot(bookingId: string): Observable&lt;BookingRiskSnapshot | null&gt; {
    return from(
      this.supabaseClient
        .from(this.riskSnapshotTable)
        .select(&#x27;*&#x27;)
        .eq(&#x27;booking_id&#x27;, bookingId)
        .maybeSingle(),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }
        return response.data
          ? mapBookingRiskSnapshot(response.data as BookingRiskSnapshotDb)
          : null;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // INSPECCIONES DE VEHÍCULO
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Crea una inspección de vehículo
   */
  createInspection(params: CreateInspectionParams): Observable&lt;BookingInspection | null&gt; {
    const inspectionData: Omit&lt;BookingInspectionDb, &#x27;id&#x27; | &#x27;created_at&#x27; | &#x27;signed_at&#x27;&gt; &#x3D; {
      booking_id: params.bookingId,
      stage: params.stage,
      inspector_id: params.inspectorId,
      photos: params.photos,
      odometer: params.odometer,
      fuel_level: params.fuelLevel,
      latitude: params.latitude,
      longitude: params.longitude,
    };

    return from(
      this.supabaseClient.from(&#x27;booking_inspections&#x27;).insert(inspectionData).select().single(),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }
        return response.data ? mapBookingInspection(response.data as BookingInspectionDb) : null;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  /**
   * Firma una inspección (marca como completada)
   */
  signInspection(inspectionId: string): Observable&lt;boolean&gt; {
    return from(
      this.supabaseClient
        .from(&#x27;booking_inspections&#x27;)
        .update({ signed_at: new Date().toISOString() })
        .eq(&#x27;id&#x27;, inspectionId),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return false;
        }
        return true;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(false);
      }),
    );
  }

  /**
   * Obtiene las inspecciones de un booking
   */
  getInspections(bookingId: string): Observable&lt;BookingInspection[]&gt; {
    return from(
      this.supabaseClient
        .from(&#x27;booking_inspections&#x27;)
        .select(&#x27;*&#x27;)
        .eq(&#x27;booking_id&#x27;, bookingId)
        .order(&#x27;created_at&#x27;, { ascending: true }),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return [];
        }
        return (response.data || []).map((i) &#x3D;&gt; mapBookingInspection(i as BookingInspectionDb));
      }),
      catchError((_error) &#x3D;&gt; {
        return of([]);
      }),
    );
  }

  /**
   * Obtiene una inspección específica (por booking y stage)
   */
  getInspectionByStage(
    bookingId: string,
    stage: &#x27;check_in&#x27; | &#x27;check_out&#x27;,
  ): Observable&lt;BookingInspection | null&gt; {
    return from(
      this.supabaseClient
        .from(&#x27;booking_inspections&#x27;)
        .select(&#x27;*&#x27;)
        .eq(&#x27;booking_id&#x27;, bookingId)
        .eq(&#x27;stage&#x27;, stage)
        .single(),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }
        return response.data ? mapBookingInspection(response.data as BookingInspectionDb) : null;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // MÉTRICAS EXTENDIDAS v1.1
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Obtiene el estado extendido del FGO con métricas v1.1
   */
  getStatusV1_1(): Observable&lt;FgoStatusV1_1 | null&gt; {
    return from(this.supabaseClient.from(&#x27;v_fgo_status_v1_1&#x27;).select(&#x27;*&#x27;).single()).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }

        const data &#x3D; response.data;
        if (!data) return null;

        return {
          // v1.0 fields
          liquidityBalance: centsToUsd(data.liquidity_balance_cents),
          capitalizationBalance: centsToUsd(data.capitalization_balance_cents),
          profitabilityBalance: centsToUsd(data.profitability_balance_cents),
          totalBalance: centsToUsd(data.total_fgo_balance_cents),
          alphaPercentage: data.alpha_percentage,
          targetMonthsCoverage: data.target_months_coverage,
          totalContributions: centsToUsd(data.total_contributions_cents),
          totalSiniestrosPaid: centsToUsd(data.total_siniestros_paid_cents),
          totalSiniestrosCount: data.total_siniestros_count,
          coverageRatio: data.coverage_ratio,
          lossRatio: data.loss_ratio,
          targetBalance: data.target_balance_cents ? centsToUsd(data.target_balance_cents) : null,
          status: data.status,

          // 🆕 v1.1 fields
          pemCents: data.pem_cents,
          pem: data.pem_cents ? centsToUsd(data.pem_cents) : null,
          lr90d: data.lr_90d,
          lr365d: data.lr_365d,
          totalEvents90d: data.total_events_90d || 0,
          avgRecoveryRate: data.avg_recovery_rate,

          lastCalculatedAt: new Date(data.last_calculated_at),
          updatedAt: new Date(data.updated_at),
        } as FgoStatusV1_1;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  /**
   * Calcula PEM (Pérdida Esperada Mensual) para un país/bucket
   */
  calculatePem(
    countryCode?: string,
    bucket?: string,
    windowDays &#x3D; 90,
  ): Observable&lt;PemCalculation | null&gt; {
    return from(
      this.supabaseClient.rpc(&#x27;calculate_pem&#x27;, {
        p_country_code: countryCode || null,
        p_bucket: bucket || null,
        p_window_days: windowDays,
      }),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }

        const results &#x3D; response.data as Record&lt;string, unknown&gt;[] | null;
        const data &#x3D; results?.[0];
        if (!data) return null;

        return {
          countryCode: data.country_code as string,
          bucket: data.bucket as string,
          pemCents: data.pem_cents as number,
          pem: centsToUsd(data.pem_cents as number),
          eventCount: data.event_count as number,
          avgEventCents: data.avg_event_cents as number,
          avgEvent: centsToUsd(data.avg_event_cents as number),
          totalPaid: centsToUsd(data.total_paid_cents as number),
          totalRecovered: centsToUsd(data.total_recovered_cents as number),
        } as PemCalculation;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  /**
   * Calcula RC dinámico v1.1 (basado en PEM)
   */
  calculateRcV1_1(countryCode?: string, bucket?: string): Observable&lt;RcCalculationV1_1 | null&gt; {
    return from(
      this.supabaseClient.rpc(&#x27;calculate_rc_v1_1&#x27;, {
        p_country_code: countryCode || null,
        p_bucket: bucket || null,
      }),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }

        const data &#x3D; response.data;
        if (!data) return null;

        return {
          pemCents: data.pem_cents,
          pem: centsToUsd(data.pem_cents),
          currentBalanceCents: data.current_balance_cents,
          currentBalance: centsToUsd(data.current_balance_cents),
          targetBalanceCents: data.target_balance_cents,
          targetBalance: centsToUsd(data.target_balance_cents),
          rc: data.rc,
          eventCount: data.event_count,
          status: data.status,
          calculatedAt: new Date(data.calculated_at),
        } as RcCalculationV1_1;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  /**
   * Ajusta alpha dinámicamente según RC (solo ejecutable por admin/cron)
   */
  adjustAlphaDynamic(countryCode: string, bucket: string): Observable&lt;AlphaAdjustment | null&gt; {
    return from(
      this.supabaseClient.rpc(&#x27;adjust_alpha_dynamic&#x27;, {
        p_country_code: countryCode,
        p_bucket: bucket,
      }),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }

        const data &#x3D; response.data;
        if (!data) return null;

        return {
          countryCode: data.country_code,
          bucket: data.bucket,
          rc: data.rc,
          previousAlpha: data.previous_alpha,
          newAlpha: data.new_alpha,
          adjusted: data.adjusted,
          adjustmentDelta: data.adjustment_delta,
          timestamp: new Date(data.timestamp),
        } as AlphaAdjustment;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // WATERFALL Y ELEGIBILIDAD
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Evalúa la elegibilidad de un booking para cobertura FGO
   */
  assessEligibility(params: AssessEligibilityParams): Observable&lt;EligibilityResult | null&gt; {
    return from(
      this.supabaseClient.rpc(&#x27;fgo_assess_eligibility&#x27;, {
        p_booking_id: params.bookingId,
        p_claim_amount_cents: params.claimAmountCents,
      }),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }

        const data &#x3D; response.data;
        if (!data) return null;

        return {
          eligible: data.eligible,
          reasons: data.reasons || [],
          rc: data.rc,
          rcStatus: data.rc_status,
          franchisePercentage: data.franchise_percentage,
          maxCoverCents: data.max_cover_cents,
          maxCoverUsd: data.max_cover_usd,
          eventCapUsd: data.event_cap_usd,
          monthlyPayoutUsedCents: data.monthly_payout_used_cents,
          monthlyCapCents: data.monthly_cap_cents,
          userEventsQuarter: data.user_events_quarter,
          userEventLimit: data.user_event_limit,
          fgoBalanceCents: data.fgo_balance_cents,
          snapshot: data.snapshot,
        } as EligibilityResult;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  /**
   * Ejecuta el waterfall completo de cobros
   * IMPORTANTE: Solo ejecutable por service role (admin/sistema)
   */
  executeWaterfall(params: ExecuteWaterfallParams): Observable&lt;WaterfallResult | null&gt; {
    return from(
      this.supabaseClient.rpc(&#x27;fgo_execute_waterfall&#x27;, {
        p_booking_id: params.bookingId,
        p_total_claim_cents: params.totalClaimCents,
        p_description: params.description,
        p_evidence_url: params.evidenceUrl || null,
      }),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return null;
        }

        const data &#x3D; response.data;
        if (!data) return null;

        return {
          ok: data.ok,
          error: data.error,
          bookingId: data.booking_id,
          totalClaimCents: data.total_claim_cents,
          breakdown: {
            holdCaptured: data.breakdown.hold_captured,
            walletDebited: data.breakdown.wallet_debited,
            extraCharged: data.breakdown.extra_charged,
            fgoPaid: data.breakdown.fgo_paid,
            remainingUncovered: data.breakdown.remaining_uncovered,
          },
          fgoMovementId: data.fgo_movement_id,
          fgoRef: data.fgo_ref,
          eligibility: data.eligibility,
          executedAt: new Date(data.executed_at),
        } as WaterfallResult;
      }),
      catchError((_error) &#x3D;&gt; {
        return of(null);
      }),
    );
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // UTILIDADES
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Verifica si el usuario actual es admin
   */
  async isAdmin(): Promise&lt;boolean&gt; {
    const {
      data: { user },
    } &#x3D; await this.supabaseClient.auth.getUser();
    if (!user) return false;

    const { data: profile } &#x3D; await this.supabaseClient
      .from(&#x27;profiles&#x27;)
      .select(&#x27;is_admin&#x27;)
      .eq(&#x27;id&#x27;, user.id)
      .single();

    return profile?.is_admin &#x3D;&#x3D;&#x3D; true;
  }

  /**
   * Obtiene el ID del usuario actual
   */
  async getCurrentUserId(): Promise&lt;string | null&gt; {
    const {
      data: { user },
    } &#x3D; await this.supabaseClient.auth.getUser();
    return user?.id || null;
  }

  getMovements(limit: number, offset: number): Observable&lt;FgoMovementView[]&gt; {
    return from(
      this.supabaseClient
        .from(&#x27;fgo_movements_view&#x27;) // Assuming a view with this name exists
        .select(&#x27;*&#x27;)
        .limit(limit)
        .range(offset, offset + limit - 1),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return [];
        }
        return response.data as FgoMovementView[];
      }),
      catchError((_error) &#x3D;&gt; {
        return of([]);
      }),
    );
  }

  recalculateMetrics(): Observable&lt;{ ok: boolean; error?: string }&gt; {
    return from(this.supabaseClient.rpc(&#x27;recalculate_fgo_metrics&#x27;)).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return { ok: false, error: response.error.message };
        }
        return { ok: true };
      }),
      catchError((_error) &#x3D;&gt; {
        return of({ ok: false, error: _error.message });
      }),
    );
  }

  transferBetweenSubfunds(params: {
    fromSubfund: string;
    toSubfund: string;
    amountCents: number;
    reason: string;
    adminId: string;
  }): Observable&lt;{ ok: boolean; ref?: string; error?: string }&gt; {
    return from(
      this.supabaseClient.rpc(&#x27;transfer_fgo_funds&#x27;, {
        p_from_subfund: params.fromSubfund,
        p_to_subfund: params.toSubfund,
        p_amount_cents: params.amountCents,
        p_reason: params.reason,
        p_admin_id: params.adminId,
      }),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return { ok: false, error: response.error.message };
        }
        return { ok: true, ref: response.data };
      }),
      catchError((_error) &#x3D;&gt; {
        return of({ ok: false, error: _error.message });
      }),
    );
  }

  paySiniestro(params: {
    bookingId: string;
    amountCents: number;
    description: string;
  }): Observable&lt;{ ok: boolean; ref?: string; error?: string }&gt; {
    return from(
      this.supabaseClient.rpc(&#x27;pay_fgo_siniestro&#x27;, {
        p_booking_id: params.bookingId,
        p_amount_cents: params.amountCents,
        p_description: params.description,
      }),
    ).pipe(
      map((response) &#x3D;&gt; {
        if (response.error) {
          return { ok: false, error: response.error.message };
        }
        return { ok: true, ref: response.data };
      }),
      catchError((_error) &#x3D;&gt; {
        return of({ ok: false, error: _error.message });
      }),
    );
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'FgoV1_1Service.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
