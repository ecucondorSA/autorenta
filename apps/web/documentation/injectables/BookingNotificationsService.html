<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>autorenta-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">autorenta-web documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">












<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >BookingNotificationsService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/services/booking-notifications.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>BookingNotificationsService</p>
<p>Servicio especializado para crear notificaciones automáticas
cuando cambia el estado de un booking o se realizan acciones importantes.</p>
<p>Integrado con el flujo completo de contratación.</p>

            </p>



            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#supabase" >supabase</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#createNotification" >createNotification</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#notifyActionRequired" >notifyActionRequired</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#notifyInspectionCompleted" >notifyInspectionCompleted</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#notifyReviewAvailable" >notifyReviewAvailable</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#notifyStatusChange" >notifyStatusChange</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>


            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createNotification"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>createNotification</b></span>
                        <a href="#createNotification"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createNotification(data: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="346"
                                    class="link-to-prism">src/app/core/services/booking-notifications.service.ts:346</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Helper para crear notificaciones en la base de datos</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>data</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="notifyActionRequired"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>notifyActionRequired</b></span>
                        <a href="#notifyActionRequired"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>notifyActionRequired(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>, action: <a href="../unknowns/app.html" target="_self">&quot;check_in&quot; | &quot;check_out&quot; | &quot;review&quot; | &quot;approve&quot; | &quot;payment&quot;</a>, targetUserId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="184"
                                    class="link-to-prism">src/app/core/services/booking-notifications.service.ts:184</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Notifica cuando se requiere acción del usuario (check-in, check-out, etc.)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>action</td>
                                            <td>
                                                            <code><a href="../miscellaneous/variables.html#app" target="_self" >&quot;check_in&quot; | &quot;check_out&quot; | &quot;review&quot; | &quot;approve&quot; | &quot;payment&quot;</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>targetUserId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="notifyInspectionCompleted"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>notifyInspectionCompleted</b></span>
                        <a href="#notifyInspectionCompleted"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>notifyInspectionCompleted(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>, inspectionType: "check_in" | "check_out", completedByUserId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="255"
                                    class="link-to-prism">src/app/core/services/booking-notifications.service.ts:255</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Notifica cuando se completa un check-in o check-out</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>inspectionType</td>
                                            <td>
                                                        <code>&quot;check_in&quot; | &quot;check_out&quot;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>completedByUserId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="notifyReviewAvailable"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>notifyReviewAvailable</b></span>
                        <a href="#notifyReviewAvailable"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>notifyReviewAvailable(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>, userId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="313"
                                    class="link-to-prism">src/app/core/services/booking-notifications.service.ts:313</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Notifica cuando se puede dejar una reseña (14 días después de completed)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>userId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="notifyStatusChange"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>notifyStatusChange</b></span>
                        <a href="#notifyStatusChange"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>notifyStatusChange(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>, oldStatus: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, newStatus: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="23"
                                    class="link-to-prism">src/app/core/services/booking-notifications.service.ts:23</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Notifica cuando un booking cambia de estado</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>oldStatus</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>newStatus</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="supabase"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>supabase</b></span>
                        <a href="#supabase"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>injectSupabase()</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="18" class="link-to-prism">src/app/core/services/booking-notifications.service.ts:18</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@angular/core&#x27;;
import type { Booking } from &#x27;../models&#x27;;
import { getErrorMessage } from &#x27;../utils/type-guards&#x27;;
import { injectSupabase } from &#x27;./supabase-client.service&#x27;;

/**
 * BookingNotificationsService
 *
 * Servicio especializado para crear notificaciones automáticas
 * cuando cambia el estado de un booking o se realizan acciones importantes.
 *
 * Integrado con el flujo completo de contratación.
 */
@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class BookingNotificationsService {
  private readonly supabase &#x3D; injectSupabase();

  /**
   * Notifica cuando un booking cambia de estado
   */
  async notifyStatusChange(booking: Booking, oldStatus: string, newStatus: string): Promise&lt;void&gt; {
    try {
      // Obtener información del auto y usuarios
      const { data: bookingData, error: bookingError } &#x3D; await this.supabase
        .from(&#x27;bookings&#x27;)
        .select(
          &#x27;*, cars(title, brand, model), renter:profiles!bookings_renter_id_fkey(full_name), owner:profiles!bookings_owner_id_fkey(full_name)&#x27;,
        )
        .eq(&#x27;id&#x27;, booking.id)
        .single();

      if (bookingError || !bookingData) {
        console.error(&#x27;Error fetching booking data for notification:&#x27;, bookingError);
        return;
      }

      const carTitle &#x3D;
        bookingData.cars?.title || &#x60;${bookingData.cars?.brand} ${bookingData.cars?.model}&#x60;;
      const renterName &#x3D; bookingData.renter?.full_name || &#x27;el locatario&#x27;;

      // Notificar según el cambio de estado
      switch (newStatus) {
        case &#x27;confirmed&#x27;:
          // Notificar al locatario que su reserva fue confirmada
          await this.createNotification({
            user_id: booking.renter_id,
            type: &#x27;payment_successful&#x27;,
            title: &#x27;¡Reserva Confirmada!&#x27;,
            body: &#x60;Tu reserva de ${carTitle} ha sido confirmada. Preparate para el check-in.&#x60;,
            cta_link: &#x60;/bookings/${booking.id}&#x60;,
            metadata: {
              booking_id: booking.id,
              car_id: booking.car_id,
              status: newStatus,
            },
          });

          // Notificar al locador que el pago fue completado
          await this.createNotification({
            user_id: booking.owner_id,
            type: &#x27;payment_successful&#x27;,
            title: &#x27;Pago Recibido&#x27;,
            body: &#x60;${renterName} completó el pago de la reserva de ${carTitle}.&#x60;,
            cta_link: &#x60;/bookings/${booking.id}&#x60;,
            metadata: {
              booking_id: booking.id,
              car_id: booking.car_id,
              status: newStatus,
            },
          });
          break;

        case &#x27;in_progress&#x27;:
          // Notificar al locatario que el alquiler comenzó
          await this.createNotification({
            user_id: booking.renter_id,
            type: &#x27;generic_announcement&#x27;,
            title: &#x27;¡Alquiler Iniciado!&#x27;,
            body: &#x60;El check-in de ${carTitle} ha sido completado. ¡Disfrutá tu viaje!&#x60;,
            cta_link: &#x60;/bookings/${booking.id}&#x60;,
            metadata: {
              booking_id: booking.id,
              car_id: booking.car_id,
              status: newStatus,
            },
          });

          // Notificar al locador
          await this.createNotification({
            user_id: booking.owner_id,
            type: &#x27;generic_announcement&#x27;,
            title: &#x27;Alquiler en Curso&#x27;,
            body: &#x60;El alquiler de ${carTitle} con ${renterName} ha comenzado.&#x60;,
            cta_link: &#x60;/bookings/${booking.id}&#x60;,
            metadata: {
              booking_id: booking.id,
              car_id: booking.car_id,
              status: newStatus,
            },
          });
          break;

        case &#x27;completed&#x27;:
          // Notificar al locatario que puede dejar reseña
          await this.createNotification({
            user_id: booking.renter_id,
            type: &#x27;generic_announcement&#x27;,
            title: &#x27;Reserva Completada&#x27;,
            body: &#x60;Tu reserva de ${carTitle} ha finalizado. Dejá tu reseña para ayudar a otros usuarios.&#x60;,
            cta_link: &#x60;/bookings/${booking.id}&#x60;,
            metadata: {
              booking_id: booking.id,
              car_id: booking.car_id,
              status: newStatus,
              can_review: true,
            },
          });

          // Notificar al locador sobre ganancias
          await this.createNotification({
            user_id: booking.owner_id,
            type: &#x27;payout_successful&#x27;,
            title: &#x27;Reserva Completada - Ganancias Disponibles&#x27;,
            body: &#x60;La reserva de ${carTitle} con ${renterName} ha finalizado. Tus ganancias están disponibles en tu wallet.&#x60;,
            cta_link: &#x60;/bookings/${booking.id}&#x60;,
            metadata: {
              booking_id: booking.id,
              car_id: booking.car_id,
              status: newStatus,
              can_review: true,
              earnings_available: true,
            },
          });
          break;

        case &#x27;cancelled&#x27;:
          // Notificar a ambas partes
          if (oldStatus &#x3D;&#x3D;&#x3D; &#x27;pending&#x27;) {
            // Cancelación de solicitud pendiente
            await this.createNotification({
              user_id: booking.renter_id,
              type: &#x27;booking_cancelled_for_renter&#x27;,
              title: &#x27;Reserva Cancelada&#x27;,
              body: &#x60;Tu solicitud de reserva para ${carTitle} ha sido cancelada.&#x60;,
              cta_link: &#x60;/bookings&#x60;,
              metadata: {
                booking_id: booking.id,
                car_id: booking.car_id,
                status: newStatus,
              },
            });

            await this.createNotification({
              user_id: booking.owner_id,
              type: &#x27;booking_cancelled_for_owner&#x27;,
              title: &#x27;Solicitud Cancelada&#x27;,
              body: &#x60;La solicitud de reserva para ${carTitle} ha sido cancelada.&#x60;,
              cta_link: &#x60;/bookings/owner&#x60;,
              metadata: {
                booking_id: booking.id,
                car_id: booking.car_id,
                status: newStatus,
              },
            });
          }
          break;

        default:
          // No notification for other status changes
          console.log(&#x60;[BookingNotifications] No notification configured for status: ${newStatus}&#x60;);
          break;
      }
    } catch (error) {
      console.error(&#x27;Error creating status change notification:&#x27;, error);
      // No lanzar error para no bloquear el flujo principal
    }
  }

  /**
   * Notifica cuando se requiere acción del usuario (check-in, check-out, etc.)
   */
  async notifyActionRequired(
    booking: Booking,
    action: &#x27;check_in&#x27; | &#x27;check_out&#x27; | &#x27;review&#x27; | &#x27;approve&#x27; | &#x27;payment&#x27;,
    targetUserId: string,
  ): Promise&lt;void&gt; {
    try {
      const { data: bookingData, error } &#x3D; await this.supabase
        .from(&#x27;bookings&#x27;)
        .select(&#x27;*, cars(title, brand, model)&#x27;)
        .eq(&#x27;id&#x27;, booking.id)
        .single();

      if (error || !bookingData) {
        console.error(&#x27;Error fetching booking data:&#x27;, error);
        return;
      }

      const carTitle &#x3D;
        bookingData.cars?.title || &#x60;${bookingData.cars?.brand} ${bookingData.cars?.model}&#x60;;

      const notifications: Record&lt;string, { title: string; body: string; cta_link: string }&gt; &#x3D; {
        check_in: {
          title: &#x27;Check-In Requerido&#x27;,
          body: &#x60;Es hora de realizar el check-in para ${carTitle}. Inspeccioná el vehículo antes de entregarlo.&#x60;,
          cta_link: &#x60;/bookings/${booking.id}/owner-check-in&#x60;,
        },
        check_out: {
          title: &#x27;Check-Out Requerido&#x27;,
          body: &#x60;Completá el check-out de ${carTitle} para finalizar la reserva.&#x60;,
          cta_link: &#x60;/bookings/${booking.id}/check-out&#x60;,
        },
        review: {
          title: &#x27;Dejá tu Reseña&#x27;,
          body: &#x60;Tu reserva de ${carTitle} ha finalizado. Compartí tu experiencia.&#x60;,
          cta_link: &#x60;/bookings/${booking.id}&#x60;,
        },
        approve: {
          title: &#x27;Nueva Solicitud de Reserva&#x27;,
          body: &#x60;Tenés una nueva solicitud de reserva para ${carTitle}. Revisala y aprobala.&#x60;,
          cta_link: &#x60;/bookings/${booking.id}&#x60;,
        },
        payment: {
          title: &#x27;Pago Pendiente&#x27;,
          body: &#x60;Completá el pago para confirmar tu reserva de ${carTitle}.&#x60;,
          cta_link: &#x60;/bookings/${booking.id}/detail-payment&#x60;,
        },
      };

      const notification &#x3D; notifications[action];
      if (!notification) return;

      await this.createNotification({
        user_id: targetUserId,
        type: &#x27;generic_announcement&#x27;,
        title: notification.title,
        body: notification.body,
        cta_link: notification.cta_link,
        metadata: {
          booking_id: booking.id,
          car_id: booking.car_id,
          action_required: action,
        },
      });
    } catch (error) {
      console.error(&#x27;Error creating action required notification:&#x27;, error);
    }
  }

  /**
   * Notifica cuando se completa un check-in o check-out
   */
  async notifyInspectionCompleted(
    booking: Booking,
    inspectionType: &#x27;check_in&#x27; | &#x27;check_out&#x27;,
    completedByUserId: string,
  ): Promise&lt;void&gt; {
    try {
      const { data: bookingData, error } &#x3D; await this.supabase
        .from(&#x27;bookings&#x27;)
        .select(
          &#x27;*, cars(title, brand, model), renter:profiles!bookings_renter_id_fkey(full_name), owner:profiles!bookings_owner_id_fkey(full_name)&#x27;,
        )
        .eq(&#x27;id&#x27;, booking.id)
        .single();

      if (error || !bookingData) return;

      const carTitle &#x3D;
        bookingData.cars?.title || &#x60;${bookingData.cars?.brand} ${bookingData.cars?.model}&#x60;;
      const isOwner &#x3D; completedByUserId &#x3D;&#x3D;&#x3D; booking.owner_id;
      const otherUserName &#x3D; isOwner ? bookingData.renter?.full_name : bookingData.owner?.full_name;

      if (inspectionType &#x3D;&#x3D;&#x3D; &#x27;check_in&#x27;) {
        // Notificar al locatario que puede hacer su check-in
        await this.createNotification({
          user_id: booking.renter_id,
          type: &#x27;inspection_reminder&#x27;,
          title: &#x27;Check-In del Locador Completado&#x27;,
          body: &#x60;El locador completó el check-in de ${carTitle}. Ahora es tu turno de confirmar la recepción.&#x60;,
          cta_link: &#x60;/bookings/${booking.id}/check-in&#x60;,
          metadata: {
            booking_id: booking.id,
            car_id: booking.car_id,
            inspection_type: &#x27;check_in&#x27;,
          },
        });
      } else if (inspectionType &#x3D;&#x3D;&#x3D; &#x27;check_out&#x27;) {
        // Notificar al locador que el locatario completó el check-out
        await this.createNotification({
          user_id: booking.owner_id,
          type: &#x27;inspection_reminder&#x27;,
          title: &#x27;Check-Out del Locatario Completado&#x27;,
          body: &#x60;${otherUserName} completó el check-out de ${carTitle}. Revisá el estado del vehículo.&#x60;,
          cta_link: &#x60;/bookings/${booking.id}/owner-check-out&#x60;,
          metadata: {
            booking_id: booking.id,
            car_id: booking.car_id,
            inspection_type: &#x27;check_out&#x27;,
          },
        });
      }
    } catch (error) {
      console.error(&#x27;Error creating inspection notification:&#x27;, error);
    }
  }

  /**
   * Notifica cuando se puede dejar una reseña (14 días después de completed)
   */
  async notifyReviewAvailable(booking: Booking, userId: string): Promise&lt;void&gt; {
    try {
      const { data: bookingData, error } &#x3D; await this.supabase
        .from(&#x27;bookings&#x27;)
        .select(&#x27;*, cars(title, brand, model)&#x27;)
        .eq(&#x27;id&#x27;, booking.id)
        .single();

      if (error || !bookingData) return;

      const carTitle &#x3D;
        bookingData.cars?.title || &#x60;${bookingData.cars?.brand} ${bookingData.cars?.model}&#x60;;

      await this.createNotification({
        user_id: userId,
        type: &#x27;generic_announcement&#x27;,
        title: &#x27;Dejá tu Reseña&#x27;,
        body: &#x60;Tu reserva de ${carTitle} ha finalizado. Compartí tu experiencia para ayudar a otros usuarios.&#x60;,
        cta_link: &#x60;/bookings/${booking.id}&#x60;,
        metadata: {
          booking_id: booking.id,
          car_id: booking.car_id,
          review_available: true,
        },
      });
    } catch (error) {
      console.error(&#x27;Error creating review notification:&#x27;, error);
    }
  }

  /**
   * Helper para crear notificaciones en la base de datos
   */
  private async createNotification(data: {
    user_id?: string;
    type: string;
    title: string;
    body: string;
    cta_link?: string;
    metadata?: Record&lt;string, unknown&gt;;
  }): Promise&lt;void&gt; {
    // If no user_id is provided, bail out early. This prevents passing
    // &#x60;undefined&#x60; into the DB and satisfies callers that may have
    // optional user ids on the booking model.
    if (!data.user_id) {
      console.warn(&#x27;Skipping notification creation: missing user_id&#x27;, data);
      return;
    }

    const { error } &#x3D; await this.supabase.from(&#x27;notifications&#x27;).insert({
      user_id: data.user_id,
      type: data.type,
      title: data.title,
      body: data.body,
      cta_link: data.cta_link,
      metadata: data.metadata || {},
    });

    if (error) {
      console.error(&#x27;Error creating notification:&#x27;, error);
      throw new Error(&#x60;Failed to create notification: ${getErrorMessage(error)}&#x60;);
    }
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'BookingNotificationsService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
