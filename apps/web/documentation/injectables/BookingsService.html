<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>autorenta-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">autorenta-web documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">












<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >BookingsService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/services/bookings.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Core booking service
Handles CRUD operations and coordinates with specialized booking services
Refactored from 1,427 lines to ~400 lines by extracting responsibilities</p>

            </p>



            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#approvalService" >approvalService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#bookingWalletService" >bookingWalletService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#cancellationService" >cancellationService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#carOwnerNotifications" >carOwnerNotifications</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#carsService" >carsService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#completionService" >completionService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#insuranceService" >insuranceService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#logger" >logger</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#profileService" >profileService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#pwaService" >pwaService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#supabase" >supabase</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#tiktokEvents" >tiktokEvents</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#utilsService" >utilsService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#validationService" >validationService</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#walletService" >walletService</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#activateInsuranceCoverage" >activateInsuranceCoverage</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#activateInsuranceWithRetry" >activateInsuranceWithRetry</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#approveBooking" >approveBooking</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#calculateInsuranceDeposit" >calculateInsuranceDeposit</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#cancelBooking" >cancelBooking</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#cancelBookingLegacy" >cancelBookingLegacy</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#carRequiresApproval" >carRequiresApproval</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#chargeRentalFromWallet" >chargeRentalFromWallet</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#completeBookingClean" >completeBookingClean</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#completeBookingWithDamages" >completeBookingWithDamages</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createBookingAtomic" >createBookingAtomic</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createBookingWithValidation" >createBookingWithValidation</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createDispute" >createDispute</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createPaymentIssue" >createPaymentIssue</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#deductFromSecurityDeposit" >deductFromSecurityDeposit</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#delay" >delay</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#extendBooking" >extendBooking</a>
                            </li>
                            <li>
                                <a href="#formatTimeRemaining" >formatTimeRemaining</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getBookingById" >getBookingById</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#getBookingCarTitle" >getBookingCarTitle</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getBookingInsuranceSummary" >getBookingInsuranceSummary</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#getBookingPricePerDay" >getBookingPricePerDay</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getInsuranceCommissionRate" >getInsuranceCommissionRate</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getMyBookings" >getMyBookings</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getOwnerBookings" >getOwnerBookings</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getOwnerContact" >getOwnerContact</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getPendingApprovals" >getPendingApprovals</a>
                            </li>
                            <li>
                                <a href="#getTimeUntilExpiration" >getTimeUntilExpiration</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#handleInsuranceActivationFailure" >handleInsuranceActivationFailure</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#hasOwnerInsurance" >hasOwnerInsurance</a>
                            </li>
                            <li>
                                <a href="#isExpired" >isExpired</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#loadCarDetails" >loadCarDetails</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#loadInsuranceCoverage" >loadInsuranceCoverage</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#lockSecurityDeposit" >lockSecurityDeposit</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#markAsPaid" >markAsPaid</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#notifyOwnerOfNewBooking" >notifyOwnerOfNewBooking</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#processEarlyReturn" >processEarlyReturn</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#processRentalPayment" >processRentalPayment</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#recalculatePricing" >recalculatePricing</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#rejectBooking" >rejectBooking</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#rejectCarAtPickup" >rejectCarAtPickup</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#releaseSecurityDeposit" >releaseSecurityDeposit</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#requestBooking" >requestBooking</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#requestBookingWithLocation" >requestBookingWithLocation</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#updateAppBadge" >updateAppBadge</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updateBooking" >updateBooking</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>


            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="activateInsuranceCoverage"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>activateInsuranceCoverage</b></span>
                        <a href="#activateInsuranceCoverage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>activateInsuranceCoverage(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, addonIds: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="976"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:976</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>addonIds</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>[]</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="activateInsuranceWithRetry"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>activateInsuranceWithRetry</b></span>
                        <a href="#activateInsuranceWithRetry"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>activateInsuranceWithRetry(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, addonIds: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1239"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1239</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Activate insurance coverage with retry logic and MANDATORY blocking</p>
<p>âœ… P0-003 FIX: Insurance activation BLOCKS booking if it fails</p>
<p>CRITICAL: This method will throw an error if insurance activation fails
after all retries. This is MANDATORY for legal compliance - bookings
CANNOT proceed without valid insurance coverage.</p>
<p>Features:</p>
<ul>
<li>3 retry attempts with exponential backoff (1s, 2s, 4s)</li>
<li>Detailed logging of each attempt</li>
<li>Critical alerts to Sentry if all retries fail</li>
<li>BLOCKS booking creation if insurance fails</li>
<li>Auto-cancellation of booking if insurance fails</li>
</ul>
<p>Legal Requirements:</p>
<ul>
<li>All bookings MUST have active insurance coverage</li>
<li>Violation of this requirement is ILLEGAL in most jurisdictions</li>
<li>Potential financial exposure: millions USD per incident</li>
</ul>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                            <td>
                                                    <ul>
<li>ID of the booking</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>addonIds</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>[]</code>
                                            </td>

                                            <td>
                                                    <ul>
<li>Optional insurance addon IDs</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="approveBooking"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>approveBooking</b></span>
                        <a href="#approveBooking"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>approveBooking(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="645"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:645</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="calculateInsuranceDeposit"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>calculateInsuranceDeposit</b></span>
                        <a href="#calculateInsuranceDeposit"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>calculateInsuranceDeposit(carId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1002"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1002</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>carId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;number&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="cancelBooking"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>cancelBooking</b></span>
                        <a href="#cancelBooking"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>cancelBooking(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, force: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank">boolean</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="724"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:724</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>force</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>false</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="cancelBookingLegacy"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>cancelBookingLegacy</b></span>
                        <a href="#cancelBookingLegacy"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>cancelBookingLegacy(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, reason?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="734"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:734</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>reason</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="carRequiresApproval"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>carRequiresApproval</b></span>
                        <a href="#carRequiresApproval"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>carRequiresApproval(carId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="658"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:658</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>carId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;boolean&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="chargeRentalFromWallet"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>chargeRentalFromWallet</b></span>
                        <a href="#chargeRentalFromWallet"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>chargeRentalFromWallet(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, amountCents: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, _description?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="545"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:545</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>amountCents</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>_description</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="completeBookingClean"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>completeBookingClean</b></span>
                        <a href="#completeBookingClean"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>completeBookingClean(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="663"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:663</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="completeBookingWithDamages"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>completeBookingWithDamages</b></span>
                        <a href="#completeBookingWithDamages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>completeBookingWithDamages(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, damageAmountCents: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, damageDescription: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, claimSeverity: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="670"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:670</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>damageAmountCents</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>damageDescription</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>claimSeverity</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>1</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createBookingAtomic"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>createBookingAtomic</b></span>
                        <a href="#createBookingAtomic"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createBookingAtomic(params: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="429"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:429</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Create booking atomically with risk snapshot
Prevents &quot;phantom bookings&quot; using a single transaction
âœ… NEW: Supports dynamic pricing with price locks</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>params</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createBookingWithValidation"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>createBookingWithValidation</b></span>
                        <a href="#createBookingWithValidation"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createBookingWithValidation(carId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, startDate: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, endDate: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, locationData?: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="689"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:689</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>carId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>startDate</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>endDate</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>locationData</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createDispute"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>createDispute</b></span>
                        <a href="#createDispute"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createDispute(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, reason: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, evidence?: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="926"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:926</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Inicia una disputa sobre cargos adicionales
Congela la transferencia de fondos al dueÃ±o hasta resoluciÃ³n.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>reason</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>evidence</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createPaymentIssue"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>createPaymentIssue</b></span>
                        <a href="#createPaymentIssue"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createPaymentIssue(issue: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1180"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1180</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Create a payment issue record for manual review and background retry</p>
<p>âœ… P0-002 FIX: Registro de fallos de wallet unlock para retry posterior</p>
<p>Esta funciÃ³n guarda los errores crÃ­ticos de pago/wallet en la tabla
<code>payment_issues</code> para que un background job pueda reintentarlos.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>issue</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Payment issue data</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                <p>Promise<void></p>

                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deductFromSecurityDeposit"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>deductFromSecurityDeposit</b></span>
                        <a href="#deductFromSecurityDeposit"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>deductFromSecurityDeposit(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, damageAmountCents: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, damageDescription: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="616"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:616</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>damageAmountCents</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>damageDescription</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="delay"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>delay</b></span>
                        <a href="#delay"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>delay(ms: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1392"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1392</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Utility: Delay execution for specified milliseconds</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>ms</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="extendBooking"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>extendBooking</b></span>
                        <a href="#extendBooking"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>extendBooking(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, newEndDate: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank">Date</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="749"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:749</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Extiende una reserva existente</p>
<ol>
<li>Verifica disponibilidad</li>
<li>Calcula diferencia de precio</li>
<li>Cobra diferencia de wallet (o tarjeta guardada)</li>
<li>Actualiza fechas de reserva y seguro</li>
</ol>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>newEndDate</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date" target="_blank" >Date</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="formatTimeRemaining"></a>
                    <span class="name">
                        <span ><b>formatTimeRemaining</b></span>
                        <a href="#formatTimeRemaining"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>formatTimeRemaining(milliseconds: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="967"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:967</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>milliseconds</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getBookingById"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getBookingById</b></span>
                        <a href="#getBookingById"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getBookingById(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="294"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:294</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Get booking by ID with full details
âœ… OPTIMIZED: Parallel loading of car details and insurance coverage</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Booking | null&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getBookingCarTitle"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>getBookingCarTitle</b></span>
                        <a href="#getBookingCarTitle"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getBookingCarTitle(booking: <a href="../undefineds/BookingWithMetadata.html" target="_self">BookingWithMetadata</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1156"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1156</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../miscellaneous/typealiases.html#BookingWithMetadata" target="_self" >BookingWithMetadata</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getBookingInsuranceSummary"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getBookingInsuranceSummary</b></span>
                        <a href="#getBookingInsuranceSummary"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getBookingInsuranceSummary(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="998"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:998</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getBookingPricePerDay"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>getBookingPricePerDay</b></span>
                        <a href="#getBookingPricePerDay"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getBookingPricePerDay(booking: <a href="../undefineds/BookingWithMetadata.html" target="_self">BookingWithMetadata</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1161"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1161</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../miscellaneous/typealiases.html#BookingWithMetadata" target="_self" >BookingWithMetadata</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getInsuranceCommissionRate"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getInsuranceCommissionRate</b></span>
                        <a href="#getInsuranceCommissionRate"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getInsuranceCommissionRate(carId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1010"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1010</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>carId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;number&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getMyBookings"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getMyBookings</b></span>
                        <a href="#getMyBookings"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getMyBookings(options?: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="225"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:225</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Get bookings for current user using the my_bookings view
âœ… P1-025: Now supports pagination</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>options</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getOwnerBookings"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getOwnerBookings</b></span>
                        <a href="#getOwnerBookings"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getOwnerBookings(options?: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="261"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:261</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Get bookings for cars owned by current user
âœ… P1-025: Now supports pagination</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>options</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getOwnerContact"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getOwnerContact</b></span>
                        <a href="#getOwnerContact"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getOwnerContact(ownerId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="385"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:385</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Get owner contact information</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>ownerId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPendingApprovals"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>getPendingApprovals</b></span>
                        <a href="#getPendingApprovals"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getPendingApprovals()</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="641"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:641</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Record[]&gt;</code>

                        </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getTimeUntilExpiration"></a>
                    <span class="name">
                        <span ><b>getTimeUntilExpiration</b></span>
                        <a href="#getTimeUntilExpiration"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>getTimeUntilExpiration(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="963"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:963</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>number | null</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="handleInsuranceActivationFailure"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>handleInsuranceActivationFailure</b></span>
                        <a href="#handleInsuranceActivationFailure"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>handleInsuranceActivationFailure(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, addonIds: string[], error: unknown)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1304"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1304</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Handle critical insurance activation failure</p>
<p>Actions:</p>
<ol>
<li>Log CRITICAL error to Sentry (legal compliance)</li>
<li>Auto-cancel the booking (cannot proceed without insurance)</li>
<li>Create compliance issue record for audit trail</li>
<li>Alert compliance team</li>
</ol>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Description</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>ID of the booking</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>addonIds</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Insurance addon IDs that failed to activate</li>
</ul>

                                            </td>
                                        </tr>
                                        <tr>
                                                <td>error</td>
                                            <td>
                                                        <code>unknown</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                            <td>
                                                    <ul>
<li>Error that caused the failure</li>
</ul>

                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;never&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="hasOwnerInsurance"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>hasOwnerInsurance</b></span>
                        <a href="#hasOwnerInsurance"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>hasOwnerInsurance(carId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1006"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1006</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>carId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;boolean&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="isExpired"></a>
                    <span class="name">
                        <span ><b>isExpired</b></span>
                        <a href="#isExpired"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
<code>isExpired(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="971"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:971</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="loadCarDetails"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>loadCarDetails</b></span>
                        <a href="#loadCarDetails"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>loadCarDetails(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1036"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1036</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Load car details for a booking</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="loadInsuranceCoverage"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>loadInsuranceCoverage</b></span>
                        <a href="#loadInsuranceCoverage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>loadInsuranceCoverage(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1068"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1068</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Load insurance coverage for a booking</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="lockSecurityDeposit"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>lockSecurityDeposit</b></span>
                        <a href="#lockSecurityDeposit"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>lockSecurityDeposit(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, depositAmountCents: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, description?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="579"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:579</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>depositAmountCents</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>description</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="markAsPaid"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>markAsPaid</b></span>
                        <a href="#markAsPaid"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>markAsPaid(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, paymentIntentId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="355"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:355</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Mark booking as paid</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>paymentIntentId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="notifyOwnerOfNewBooking"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>notifyOwnerOfNewBooking</b></span>
                        <a href="#notifyOwnerOfNewBooking"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>notifyOwnerOfNewBooking(booking: <a href="../interfaces/Booking.html" target="_self">Booking</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1124"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1124</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Notifica al dueÃ±o del auto sobre una nueva solicitud de reserva</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>booking</td>
                                            <td>
                                                            <code><a href="../interfaces/Booking.html" target="_self" >Booking</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="processEarlyReturn"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>processEarlyReturn</b></span>
                        <a href="#processEarlyReturn"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>processEarlyReturn(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="863"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:863</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Procesa una devoluciÃ³n anticipada (Early Return)
Reembolsa los dÃ­as no utilizados al locatario.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="processRentalPayment"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>processRentalPayment</b></span>
                        <a href="#processRentalPayment"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>processRentalPayment(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, amountCents: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, description?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="568"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:568</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>amountCents</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>description</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="recalculatePricing"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>recalculatePricing</b></span>
                        <a href="#recalculatePricing"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>recalculatePricing(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="329"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:329</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Recalculate pricing breakdown for a booking</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="rejectBooking"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>rejectBooking</b></span>
                        <a href="#rejectBooking"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>rejectBooking(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, reason?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="651"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:651</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>reason</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="rejectCarAtPickup"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>rejectCarAtPickup</b></span>
                        <a href="#rejectCarAtPickup"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>rejectCarAtPickup(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, reason: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, evidencePhotos: string[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="812"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:812</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Rechaza el auto en el momento del retiro (Check-in)
Caso de uso: Auto sucio, daÃ±os no reportados, no es el modelo correcto.
AcciÃ³n: Cancela reserva, reembolso 100% inmediato, penaliza al dueÃ±o.</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                                <td>Default value</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>reason</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                                <td>evidencePhotos</td>
                                            <td>
                                                        <code>string[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>

                                            <td>
                                                    <code>[]</code>
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="releaseSecurityDeposit"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>releaseSecurityDeposit</b></span>
                        <a href="#releaseSecurityDeposit"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>releaseSecurityDeposit(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, description?: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="602"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:602</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>description</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="requestBooking"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>requestBooking</b></span>
                        <a href="#requestBooking"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>requestBooking(carId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, start: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, end: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, options?: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="62"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:62</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Request a new booking
âœ… NEW: Supports dynamic pricing with price locks</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>carId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>start</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>end</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>options</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    Yes
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Booking&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="requestBookingWithLocation"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>requestBookingWithLocation</b></span>
                        <a href="#requestBookingWithLocation"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>requestBookingWithLocation(carId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, start: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, end: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, locationData: literal type)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="144"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:144</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Request a new booking with location data
âœ… NEW: Supports pickup/dropoff locations and delivery fees</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>carId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>start</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>end</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>locationData</td>
                                            <td>
                                                        <code>literal type</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Booking&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateAppBadge"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Async</span>
                        <span ><b>updateAppBadge</b></span>
                        <a href="#updateAppBadge"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateAppBadge(bookings: Booking[])</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="1021"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:1021</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Update app badge with pending bookings count</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookings</td>
                                            <td>
                                                        <code>Booking[]</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateBooking"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>updateBooking</b></span>
                        <a href="#updateBooking"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateBooking(bookingId: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, updates: Partial<Booking>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="340"
                                    class="link-to-prism">src/app/core/services/bookings.service.ts:340</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Update booking fields</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>bookingId</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>updates</td>
                                            <td>
                                                        <code>Partial&lt;Booking&gt;</code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;Booking&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="approvalService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>approvalService</b></span>
                        <a href="#approvalService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(BookingApprovalService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="43" class="link-to-prism">src/app/core/services/bookings.service.ts:43</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="bookingWalletService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>bookingWalletService</b></span>
                        <a href="#bookingWalletService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(BookingWalletService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="41" class="link-to-prism">src/app/core/services/bookings.service.ts:41</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="cancellationService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>cancellationService</b></span>
                        <a href="#cancellationService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(BookingCancellationService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="46" class="link-to-prism">src/app/core/services/bookings.service.ts:46</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="carOwnerNotifications"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>carOwnerNotifications</b></span>
                        <a href="#carOwnerNotifications"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(CarOwnerNotificationsService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="50" class="link-to-prism">src/app/core/services/bookings.service.ts:50</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="carsService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>carsService</b></span>
                        <a href="#carsService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(CarsService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="51" class="link-to-prism">src/app/core/services/bookings.service.ts:51</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="completionService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>completionService</b></span>
                        <a href="#completionService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(BookingCompletionService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="44" class="link-to-prism">src/app/core/services/bookings.service.ts:44</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="insuranceService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>insuranceService</b></span>
                        <a href="#insuranceService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(InsuranceService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="36" class="link-to-prism">src/app/core/services/bookings.service.ts:36</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="logger"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>logger</b></span>
                        <a href="#logger"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(LoggerService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="37" class="link-to-prism">src/app/core/services/bookings.service.ts:37</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="profileService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>profileService</b></span>
                        <a href="#profileService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(ProfileService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="52" class="link-to-prism">src/app/core/services/bookings.service.ts:52</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="pwaService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>pwaService</b></span>
                        <a href="#pwaService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(PwaService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="35" class="link-to-prism">src/app/core/services/bookings.service.ts:35</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="supabase"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>supabase</b></span>
                        <a href="#supabase"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>injectSupabase()</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="34" class="link-to-prism">src/app/core/services/bookings.service.ts:34</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="tiktokEvents"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>tiktokEvents</b></span>
                        <a href="#tiktokEvents"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(TikTokEventsService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="38" class="link-to-prism">src/app/core/services/bookings.service.ts:38</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="utilsService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>utilsService</b></span>
                        <a href="#utilsService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(BookingUtilsService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="47" class="link-to-prism">src/app/core/services/bookings.service.ts:47</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="validationService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>validationService</b></span>
                        <a href="#validationService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(BookingValidationService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="45" class="link-to-prism">src/app/core/services/bookings.service.ts:45</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="walletService"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>walletService</b></span>
                        <a href="#walletService"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>unknown</code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>inject(WalletService)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="42" class="link-to-prism">src/app/core/services/bookings.service.ts:42</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, inject } from &#x27;@angular/core&#x27;;
import { Booking } from &#x27;../models&#x27;;
import { getErrorMessage } from &#x27;../utils/type-guards&#x27;;
import { injectSupabase } from &#x27;./supabase-client.service&#x27;;
import { PwaService } from &#x27;./pwa.service&#x27;;
import { InsuranceService } from &#x27;./insurance.service&#x27;;
import { LoggerService } from &#x27;./logger.service&#x27;;
import { BookingWalletService } from &#x27;./booking-wallet.service&#x27;;
import { WalletService } from &#x27;./wallet.service&#x27;;
import { BookingApprovalService } from &#x27;./booking-approval.service&#x27;;
import { BookingCompletionService } from &#x27;./booking-completion.service&#x27;;
import { BookingValidationService } from &#x27;./booking-validation.service&#x27;;
import { BookingCancellationService } from &#x27;./booking-cancellation.service&#x27;;
import { BookingUtilsService } from &#x27;./booking-utils.service&#x27;;
import { TikTokEventsService } from &#x27;./tiktok-events.service&#x27;;
import { CarOwnerNotificationsService } from &#x27;./car-owner-notifications.service&#x27;;
import { CarsService } from &#x27;./cars.service&#x27;;
import { ProfileService } from &#x27;./profile.service&#x27;;

type BookingWithMetadata &#x3D; Booking &amp; {
  car?: { title?: string | null } | null;
  price_per_day?: number | null;
};

/**
 * Core booking service
 * Handles CRUD operations and coordinates with specialized booking services
 * Refactored from 1,427 lines to ~400 lines by extracting responsibilities
 */
@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class BookingsService {
  private readonly supabase &#x3D; injectSupabase();
  private readonly pwaService &#x3D; inject(PwaService);
  private readonly insuranceService &#x3D; inject(InsuranceService);
  private readonly logger &#x3D; inject(LoggerService);
  private readonly tiktokEvents &#x3D; inject(TikTokEventsService);

  // Specialized booking services
  private readonly bookingWalletService &#x3D; inject(BookingWalletService);
  private readonly walletService &#x3D; inject(WalletService);
  private readonly approvalService &#x3D; inject(BookingApprovalService);
  private readonly completionService &#x3D; inject(BookingCompletionService);
  private readonly validationService &#x3D; inject(BookingValidationService);
  private readonly cancellationService &#x3D; inject(BookingCancellationService);
  private readonly utilsService &#x3D; inject(BookingUtilsService);

  // Notification services
  private readonly carOwnerNotifications &#x3D; inject(CarOwnerNotificationsService);
  private readonly carsService &#x3D; inject(CarsService);
  private readonly profileService &#x3D; inject(ProfileService);

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // CORE CRUD OPERATIONS
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Request a new booking
   * âœ… NEW: Supports dynamic pricing with price locks
   */
  async requestBooking(
    carId: string,
    start: string,
    end: string,
    options?: {
      useDynamicPricing?: boolean;
      priceLockToken?: string;
      dynamicPriceSnapshot?: Record&lt;string, unknown&gt;;
    },
  ): Promise&lt;Booking&gt; {
    const { data, error } &#x3D; await this.supabase.rpc(&#x27;request_booking&#x27;, {
      p_car_id: carId,
      p_start: start,
      p_end: end,
      // âœ… DYNAMIC PRICING: Pass optional parameters
      p_use_dynamic_pricing: options?.useDynamicPricing || false,
      p_price_lock_token: options?.priceLockToken || null,
      p_dynamic_price_snapshot: options?.dynamicPriceSnapshot || null,
    });

    if (error) {
      const errorMessage &#x3D; error.message || error.details || &#x27;Error al crear la reserva&#x27;;

      this.logger.error(
        &#x27;request_booking RPC failed: &#x27; +
          JSON.stringify({
            error,
            carId,
            start,
            end,
            message: errorMessage,
            code: error.code,
            details: error.details,
            hint: error.hint,
          }),
      );

      throw new Error(errorMessage);
    }

    const bookingId &#x3D; this.utilsService.extractBookingId(data);
    if (!bookingId) {
      throw new Error(&#x27;request_booking did not return a booking id&#x27;);
    }

    // âœ… P0-003 FIX: Activate insurance coverage with retry and BLOCK if fails
    await this.activateInsuranceWithRetry(bookingId, []);

    // Recalculate pricing breakdown
    await this.recalculatePricing(bookingId);

    // Fetch the updated booking
    const updated &#x3D; await this.getBookingById(bookingId);
    const finalBooking &#x3D; updated || { ...(data as Booking), id: bookingId };

    // ðŸŽ¯ TikTok Events: Track PlaceAnOrder
    const placeOrderContentName &#x3D; this.getBookingCarTitle(finalBooking);
    void this.tiktokEvents.trackPlaceAnOrder({
      contentId: finalBooking.car_id,
      contentName: placeOrderContentName,
      value: finalBooking.total_amount || 0,
      currency: finalBooking.currency || &#x27;ARS&#x27;,
    });

    // âœ… NUEVO: Notificar al dueÃ±o del auto sobre la nueva solicitud de reserva
    this.notifyOwnerOfNewBooking(finalBooking).catch((notificationError) &#x3D;&gt; {
      this.logger.warn(
        &#x27;Failed to notify owner of new booking request&#x27;,
        &#x27;BookingsService&#x27;,
        notificationError instanceof Error
          ? notificationError
          : new Error(getErrorMessage(notificationError)),
      );
    });

    return finalBooking;
  }

  /**
   * Request a new booking with location data
   * âœ… NEW: Supports pickup/dropoff locations and delivery fees
   */
  async requestBookingWithLocation(
    carId: string,
    start: string,
    end: string,
    locationData: {
      pickupLat: number;
      pickupLng: number;
      dropoffLat: number;
      dropoffLng: number;
      deliveryRequired: boolean;
      distanceKm: number;
      deliveryFeeCents: number;
      distanceTier: &#x27;local&#x27; | &#x27;regional&#x27; | &#x27;long_distance&#x27;;
    },
  ): Promise&lt;Booking&gt; {
    const { data, error } &#x3D; await this.supabase.rpc(&#x27;request_booking&#x27;, {
      p_car_id: carId,
      p_start: start,
      p_end: end,
      p_pickup_lat: locationData.pickupLat,
      p_pickup_lng: locationData.pickupLng,
      p_dropoff_lat: locationData.dropoffLat,
      p_dropoff_lng: locationData.dropoffLng,
      p_delivery_required: locationData.deliveryRequired,
      p_delivery_distance_km: locationData.distanceKm,
      p_delivery_fee_cents: locationData.deliveryFeeCents,
      p_distance_risk_tier: locationData.distanceTier,
    });

    if (error) {
      const errorMessage &#x3D; error.message || error.details || &#x27;Error al crear la reserva&#x27;;

      this.logger.error(
        &#x27;requestBookingWithLocation RPC failed: &#x27; +
          JSON.stringify({
            error,
            carId,
            start,
            end,
            locationData,
            message: errorMessage,
            code: error.code,
            details: error.details,
            hint: error.hint,
          }),
      );

      throw new Error(errorMessage);
    }

    const bookingId &#x3D; this.utilsService.extractBookingId(data);
    if (!bookingId) {
      throw new Error(&#x27;request_booking did not return a booking id&#x27;);
    }

    // âœ… P0-003 FIX: Activate insurance coverage with retry and BLOCK if fails
    await this.activateInsuranceWithRetry(bookingId, []);

    // Recalculate pricing breakdown
    await this.recalculatePricing(bookingId);

    // Fetch the updated booking
    const updated &#x3D; await this.getBookingById(bookingId);
    const finalBooking &#x3D; updated || { ...(data as Booking), id: bookingId };

    // ðŸŽ¯ TikTok Events: Track PlaceAnOrder
    const placeOrderWithLocationContentName &#x3D; this.getBookingCarTitle(finalBooking);
    void this.tiktokEvents.trackPlaceAnOrder({
      contentId: finalBooking.car_id,
      contentName: placeOrderWithLocationContentName,
      value: finalBooking.total_amount || 0,
      currency: finalBooking.currency || &#x27;ARS&#x27;,
    });

    return finalBooking;
  }

  /**
   * Get bookings for current user using the my_bookings view
   * âœ… P1-025: Now supports pagination
   */
  async getMyBookings(options?: {
    limit?: number;
    offset?: number;
    status?: string;
  }): Promise&lt;{ bookings: Booking[]; total: number }&gt; {
    const limit &#x3D; options?.limit ?? 20; // Default: 20 items per page
    const offset &#x3D; options?.offset ?? 0;

    let query &#x3D; this.supabase
      .from(&#x27;my_bookings&#x27;)
      .select(&#x27;*&#x27;, { count: &#x27;exact&#x27; })
      .order(&#x27;created_at&#x27;, { ascending: false })
      .range(offset, offset + limit - 1);

    // Optional status filter
    if (options?.status) {
      query &#x3D; query.eq(&#x27;status&#x27;, options.status);
    }

    const { data, error, count } &#x3D; await query;

    if (error) throw error;

    const bookings &#x3D; (data ?? []) as Booking[];
    await this.updateAppBadge(bookings);

    return {
      bookings,
      total: count ?? 0,
    };
  }

  /**
   * Get bookings for cars owned by current user
   * âœ… P1-025: Now supports pagination
   */
  async getOwnerBookings(options?: {
    limit?: number;
    offset?: number;
    status?: string;
  }): Promise&lt;{ bookings: Booking[]; total: number }&gt; {
    const limit &#x3D; options?.limit ?? 20; // Default: 20 items per page
    const offset &#x3D; options?.offset ?? 0;

    let query &#x3D; this.supabase
      .from(&#x27;owner_bookings&#x27;)
      .select(&#x27;*&#x27;, { count: &#x27;exact&#x27; })
      .order(&#x27;created_at&#x27;, { ascending: false })
      .range(offset, offset + limit - 1);

    // Optional status filter
    if (options?.status) {
      query &#x3D; query.eq(&#x27;status&#x27;, options.status);
    }

    const { data, error, count } &#x3D; await query;

    if (error) throw error;

    return {
      bookings: (data ?? []) as Booking[],
      total: count ?? 0,
    };
  }

  /**
   * Get booking by ID with full details
   * âœ… OPTIMIZED: Parallel loading of car details and insurance coverage
   */
  async getBookingById(bookingId: string): Promise&lt;Booking | null&gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;my_bookings&#x27;)
      .select(&#x27;*&#x27;)
      .eq(&#x27;id&#x27;, bookingId)
      .single();

    if (error) {
      if (error.code &#x3D;&#x3D;&#x3D; &#x27;PGRST116&#x27;) return null;
      throw error;
    }

    const booking &#x3D; data as Booking;

    // âœ… OPTIMIZED: Load car details and insurance coverage in parallel
    const loadPromises: Promise&lt;void&gt;[] &#x3D; [];

    if (booking?.car_id) {
      loadPromises.push(this.loadCarDetails(booking));
    }

    if (booking?.insurance_coverage_id) {
      loadPromises.push(this.loadInsuranceCoverage(booking));
    }

    if (loadPromises.length &gt; 0) {
      await Promise.all(loadPromises);
    }

    return booking;
  }

  /**
   * Recalculate pricing breakdown for a booking
   */
  async recalculatePricing(bookingId: string): Promise&lt;void&gt; {
    const { error } &#x3D; await this.supabase.rpc(&#x27;pricing_recalculate&#x27;, {
      p_booking_id: bookingId,
    });

    if (error) throw error;
  }

  /**
   * Update booking fields
   */
  async updateBooking(bookingId: string, updates: Partial&lt;Booking&gt;): Promise&lt;Booking&gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;bookings&#x27;)
      .update(updates)
      .eq(&#x27;id&#x27;, bookingId)
      .select()
      .single();

    if (error) throw error;
    return data as Booking;
  }

  /**
   * Mark booking as paid
   */
  async markAsPaid(bookingId: string, paymentIntentId: string): Promise&lt;void&gt; {
    // Fetch booking details before updating
    const booking &#x3D; await this.getBookingById(bookingId);

    const { error } &#x3D; await this.supabase
      .from(&#x27;bookings&#x27;)
      .update({
        status: &#x27;confirmed&#x27;,
        payment_intent_id: paymentIntentId,
        paid_at: new Date().toISOString(),
      })
      .eq(&#x27;id&#x27;, bookingId);

    if (error) throw error;

    // ðŸŽ¯ TikTok Events: Track Purchase
    if (booking) {
      const purchaseContentName &#x3D; this.getBookingCarTitle(booking);
      void this.tiktokEvents.trackPurchase({
        contentId: booking.car_id,
        contentName: purchaseContentName,
        value: booking.total_amount || 0,
        currency: booking.currency || &#x27;ARS&#x27;,
      });
    }
  }

  /**
   * Get owner contact information
   */
  async getOwnerContact(ownerId: string): Promise&lt;{
    success: boolean;
    email?: string;
    phone?: string;
    name?: string;
    error?: string;
  }&gt; {
    try {
      const { data, error } &#x3D; await this.supabase
        .from(&#x27;users&#x27;)
        .select(&#x27;email, phone, full_name&#x27;)
        .eq(&#x27;id&#x27;, ownerId)
        .single();

      if (error || !data) {
        return {
          success: false,
          error: &#x27;No se pudo obtener informaciÃ³n del propietario&#x27;,
        };
      }

      return {
        success: true,
        email: data.email,
        phone: data.phone || undefined,
        name: data.full_name || undefined,
      };
    } catch (_error) {
      return {
        success: false,
        error: _error instanceof Error ? _error.message : &#x27;Unknown error&#x27;,
      };
    }
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // ATOMIC BOOKING CREATION
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Create booking atomically with risk snapshot
   * Prevents &quot;phantom bookings&quot; using a single transaction
   * âœ… NEW: Supports dynamic pricing with price locks
   */
  async createBookingAtomic(params: {
    carId: string;
    startDate: string;
    endDate: string;
    totalAmount: number;
    currency: string;
    paymentMode: string;
    coverageUpgrade?: string;
    authorizedPaymentId?: string;
    walletLockId?: string;
    distanceKm?: number;
    distanceTier?: &#x27;local&#x27; | &#x27;regional&#x27; | &#x27;long_distance&#x27;;
    deliveryFeeCents?: number;
    // âœ… DYNAMIC PRICING: New parameters
    useDynamicPricing?: boolean;
    priceLockToken?: string;
    dynamicPriceSnapshot?: Record&lt;string, unknown&gt;;
    riskSnapshot: {
      dailyPriceUsd: number;
      securityDepositUsd: number;
      vehicleValueUsd: number;
      driverAge: number;
      coverageType: string;
      paymentMode: string;
      totalUsd: number;
      totalArs: number;
      exchangeRate: number;
    };
  }): Promise&lt;{
    success: boolean;
    bookingId?: string;
    riskSnapshotId?: string;
    error?: string;
  }&gt; {
    try {
      const user &#x3D; await this.supabase.auth.getUser();
      if (!user.data.user?.id) {
        return {
          success: false,
          error: &#x27;Usuario no autenticado&#x27;,
        };
      }

      const { data, error } &#x3D; await this.supabase.rpc(&#x27;create_booking_atomic&#x27;, {
        p_car_id: params.carId,
        p_renter_id: user.data.user.id,
        p_start_date: params.startDate,
        p_end_date: params.endDate,
        p_total_amount: params.totalAmount,
        p_currency: params.currency,
        p_payment_mode: params.paymentMode,
        p_coverage_upgrade: params.coverageUpgrade || null,
        p_authorized_payment_id: params.authorizedPaymentId || null,
        p_wallet_lock_id: params.walletLockId || null,
        p_risk_daily_price_usd: params.riskSnapshot.dailyPriceUsd,
        p_risk_security_deposit_usd: params.riskSnapshot.securityDepositUsd,
        p_risk_vehicle_value_usd: params.riskSnapshot.vehicleValueUsd,
        p_risk_driver_age: params.riskSnapshot.driverAge,
        p_risk_coverage_type: params.riskSnapshot.coverageType,
        p_risk_payment_mode: params.riskSnapshot.paymentMode,
        p_risk_total_usd: params.riskSnapshot.totalUsd,
        p_risk_total_ars: params.riskSnapshot.totalArs,
        p_risk_exchange_rate: params.riskSnapshot.exchangeRate,
        p_distance_km: params.distanceKm || null,
        p_distance_risk_tier: params.distanceTier || null,
        p_delivery_fee_cents: params.deliveryFeeCents || 0,
        // âœ… DYNAMIC PRICING: Pass new parameters
        p_use_dynamic_pricing: params.useDynamicPricing || false,
        p_price_lock_token: params.priceLockToken || null,
        p_dynamic_price_snapshot: params.dynamicPriceSnapshot || null,
      });

      if (error) {
        return {
          success: false,
          error: error instanceof Error ? error.message : &#x27;Error al crear la reserva&#x27;,
        };
      }

      const result &#x3D; Array.isArray(data) ? data[0] : data;

      if (!result || !result.success) {
        return {
          success: false,
          error: result?.error_message || &#x27;Error desconocido al crear la reserva&#x27;,
        };
      }

      // Activate insurance coverage
      try {
        await this.insuranceService.activateCoverage({
          booking_id: result.booking_id,
          addon_ids: [],
        });
      } catch {
        // Don&#x27;t block booking if insurance fails
      }

      return {
        success: true,
        bookingId: result.booking_id,
        riskSnapshotId: result.risk_snapshot_id,
      };
    } catch (error: unknown) {
      return {
        success: false,
        error: error instanceof Error ? error.message : &#x27;Error inesperado al crear la reserva&#x27;,
      };
    }
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // DELEGATED OPERATIONS (Use specialized services)
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  // Wallet Operations
  async chargeRentalFromWallet(
    bookingId: string,
    amountCents: number,
    _description?: string,
  ): Promise&lt;{ ok: boolean; error?: string }&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) return { ok: false, error: &#x27;Booking not found&#x27; };

    const result &#x3D; await this.bookingWalletService.chargeRentalFromWallet(
      booking,
      amountCents,
      // description omitted to fix signature mismatch
    );
    if (result.ok) {
      await this.updateBooking(bookingId, {
        status: &#x27;completed&#x27;,
        wallet_status: &#x27;charged&#x27;,
        paid_at: new Date().toISOString(),
      });
    }
    return result;
  }

  async processRentalPayment(
    bookingId: string,
    amountCents: number,
    description?: string,
  ): Promise&lt;{ ok: boolean; error?: string }&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) return { ok: false, error: &#x27;Booking not found&#x27; };

    return this.bookingWalletService.processRentalPayment(booking, amountCents, description);
  }

  async lockSecurityDeposit(
    bookingId: string,
    depositAmountCents: number,
    description?: string,
  ): Promise&lt;{ ok: boolean; transaction_id?: string; error?: string }&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) return { ok: false, error: &#x27;Booking not found&#x27; };

    const result &#x3D; await this.bookingWalletService.lockSecurityDeposit(
      booking,
      depositAmountCents,
      &#x27;wallet&#x27;,
      description,
    );
    if (result.ok) {
      await this.updateBooking(bookingId, {
        wallet_status: &#x27;locked&#x27;,
        wallet_lock_transaction_id: result.transaction_id,
      });
    }
    return result;
  }

  async releaseSecurityDeposit(
    bookingId: string,
    description?: string,
  ): Promise&lt;{ ok: boolean; error?: string }&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) return { ok: false, error: &#x27;Booking not found&#x27; };

    const result &#x3D; await this.bookingWalletService.releaseSecurityDeposit(booking, description);
    if (result.ok) {
      await this.updateBooking(bookingId, { wallet_status: &#x27;refunded&#x27; });
    }
    return result;
  }

  async deductFromSecurityDeposit(
    bookingId: string,
    damageAmountCents: number,
    damageDescription: string,
  ): Promise&lt;{ ok: boolean; remaining_deposit?: number; error?: string }&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) return { ok: false, error: &#x27;Booking not found&#x27; };

    const result &#x3D; await this.bookingWalletService.deductFromSecurityDeposit(
      booking,
      damageAmountCents,
      damageDescription,
    );

    if (result.ok) {
      const remainingDeposit &#x3D; result.remaining_deposit ?? 0;
      await this.updateBooking(bookingId, {
        wallet_status: remainingDeposit &gt; 0 ? &#x27;partially_charged&#x27; : &#x27;charged&#x27;,
      });
    }

    return result;
  }

  // Approval Operations
  async getPendingApprovals(): Promise&lt;Record&lt;string, unknown&gt;[]&gt; {
    return this.approvalService.getPendingApprovals();
  }

  async approveBooking(
    bookingId: string,
  ): Promise&lt;{ success: boolean; error?: string; message?: string }&gt; {
    return this.approvalService.approveBooking(bookingId);
  }

  async rejectBooking(
    bookingId: string,
    reason?: string,
  ): Promise&lt;{ success: boolean; error?: string; message?: string }&gt; {
    return this.approvalService.rejectBooking(bookingId, reason);
  }

  async carRequiresApproval(carId: string): Promise&lt;boolean&gt; {
    return this.approvalService.carRequiresApproval(carId);
  }

  // Completion Operations
  async completeBookingClean(bookingId: string): Promise&lt;{ success: boolean; error?: string }&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) return { success: false, error: &#x27;Booking not found&#x27; };

    return this.completionService.completeBookingClean(booking, this.updateBooking.bind(this));
  }

  async completeBookingWithDamages(
    bookingId: string,
    damageAmountCents: number,
    damageDescription: string,
    claimSeverity: number &#x3D; 1,
  ): Promise&lt;{ success: boolean; remaining_deposit?: number; error?: string }&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) return { success: false, error: &#x27;Booking not found&#x27; };

    return this.completionService.completeBookingWithDamages(
      booking,
      damageAmountCents,
      damageDescription,
      claimSeverity,
      this.updateBooking.bind(this),
    );
  }

  // Validation Operations
  async createBookingWithValidation(
    carId: string,
    startDate: string,
    endDate: string,
    locationData?: {
      pickupLat: number;
      pickupLng: number;
      dropoffLat: number;
      dropoffLng: number;
      deliveryRequired: boolean;
      distanceKm: number;
      deliveryFeeCents: number;
      distanceTier: &#x27;local&#x27; | &#x27;regional&#x27; | &#x27;long_distance&#x27;;
    },
  ): Promise&lt;{
    success: boolean;
    booking?: Booking;
    error?: string;
    canWaitlist?: boolean;
  }&gt; {
    // âœ… NEW: Use requestBookingWithLocation if location data is provided
    const requestBookingCallback &#x3D; locationData
      ? (carId: string, startDate: string, endDate: string) &#x3D;&gt;
          this.requestBookingWithLocation(carId, startDate, endDate, locationData)
      : this.requestBooking.bind(this);

    return this.validationService.createBookingWithValidation(
      carId,
      startDate,
      endDate,
      requestBookingCallback,
    );
  }

  // Cancellation Operations
  async cancelBooking(
    bookingId: string,
    force: boolean &#x3D; false,
  ): Promise&lt;{ success: boolean; error?: string }&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) return { success: false, error: &#x27;Reserva no encontrada&#x27; };

    return this.cancellationService.cancelBooking(booking, force);
  }

  async cancelBookingLegacy(bookingId: string, reason?: string): Promise&lt;void&gt; {
    const booking &#x3D; await this.getBookingById(bookingId);
    if (!booking) throw new Error(&#x27;Booking not found&#x27;);

    return this.cancellationService.cancelBookingLegacy(booking, reason);
  }

  // Extension Operations
  /**
   * Extiende una reserva existente
   * 1. Verifica disponibilidad
   * 2. Calcula diferencia de precio
   * 3. Cobra diferencia de wallet (o tarjeta guardada)
   * 4. Actualiza fechas de reserva y seguro
   */
  async extendBooking(
    bookingId: string,
    newEndDate: Date,
  ): Promise&lt;{ success: boolean; error?: string }&gt; {
    try {
      const booking &#x3D; await this.getBookingById(bookingId);
      if (!booking) throw new Error(&#x27;Reserva no encontrada&#x27;);

      // 1. Verificar disponibilidad
      const isAvailable &#x3D; await this.carsService.isCarAvailable(
        booking.car_id,
        booking.end_at, // Desde el fin actual
        newEndDate.toISOString(), // Hasta la nueva fecha
      );

      if (!isAvailable) {
        return { success: false, error: &#x27;El auto no estÃ¡ disponible para esas fechas&#x27; };
      }

      // 2. Calcular costo adicional
      const currentEnd &#x3D; new Date(booking.end_at);
      const additionalDays &#x3D; Math.ceil(
        (newEndDate.getTime() - currentEnd.getTime()) / (1000 * 60 * 60 * 24),
      );
      if (additionalDays &lt;&#x3D; 0)
        return { success: false, error: &#x27;La nueva fecha debe ser posterior a la actual&#x27; };

      const pricePerDay &#x3D; this.getBookingPricePerDay(booking);
      const additionalCostCents &#x3D; Math.round(pricePerDay * additionalDays * 100); // Simple calculation

      // 3. Cobrar diferencia (Intento de cobro directo a wallet)
      const chargeResult &#x3D; await this.bookingWalletService.processRentalPayment(
        booking,
        additionalCostCents,
        &#x60;ExtensiÃ³n de reserva #${booking.id} (${additionalDays} dÃ­as)&#x60;,
      );

      if (!chargeResult.ok) {
        return { success: false, error: &#x60;Fallo al cobrar extensiÃ³n: ${chargeResult.error}&#x60; };
      }

      // 4. Actualizar reserva
      await this.updateBooking(booking.id, {
        end_at: newEndDate.toISOString(),
        total_amount: (booking.total_amount || 0) + additionalCostCents / 100,
      });

      // TODO: Extender seguro (llamada a insuranceService)

      return { success: true };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : &#x27;Error al extender reserva&#x27;,
      };
    }
  }

  /**
   * Rechaza el auto en el momento del retiro (Check-in)
   * Caso de uso: Auto sucio, daÃ±os no reportados, no es el modelo correcto.
   * AcciÃ³n: Cancela reserva, reembolso 100% inmediato, penaliza al dueÃ±o.
   */
  async rejectCarAtPickup(
    bookingId: string,
    reason: string,
    evidencePhotos: string[] &#x3D; [],
  ): Promise&lt;{ success: boolean; error?: string }&gt; {
    try {
      const booking &#x3D; await this.getBookingById(bookingId);
      if (!booking) throw new Error(&#x27;Reserva no encontrada&#x27;);

      // 1. Cancelar la reserva con motivo especial
      // Usamos force&#x3D;true para bypassear reglas de tiempo (es una cancelaciÃ³n justificada)
      await this.cancellationService.cancelBooking(booking, true);

      // 2. Actualizar motivo especÃ­fico y evidencia
      await this.updateBooking(booking.id, {
        cancellation_reason: &#x60;RECHAZADO EN CHECK-IN: ${reason}&#x60;,
        metadata: {
          ...booking.metadata,
          rejection_evidence: evidencePhotos,
          rejected_at_pickup: true,
        },
      });

      // 3. Registrar incidente para penalizaciÃ³n del dueÃ±o (Strike)
      await this.profileService.addStrike(
        booking.owner_id || &#x27;&#x27;,
        &#x27;car_rejected_at_pickup&#x27;,
        booking.id,
      );

      this.logger.info(
        &#x60;Car rejected at pickup for booking ${booking.id}&#x60;,
        JSON.stringify({
          reason,
          photos: evidencePhotos.length,
        }),
      );

      return { success: true };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : &#x27;Error al rechazar vehÃ­culo&#x27;,
      };
    }
  }

  /**
   * Procesa una devoluciÃ³n anticipada (Early Return)
   * Reembolsa los dÃ­as no utilizados al locatario.
   */
  async processEarlyReturn(bookingId: string): Promise&lt;{ success: boolean; error?: string }&gt; {
    try {
      const booking &#x3D; await this.getBookingById(bookingId);
      if (!booking) throw new Error(&#x27;Reserva no encontrada&#x27;);

      const now &#x3D; new Date();
      const endDate &#x3D; new Date(booking.end_at);
      const startDate &#x3D; new Date(booking.start_at);

      // Validar que sea realmente anticipada
      if (now &gt;&#x3D; endDate) {
        return { success: false, error: &#x27;La reserva ya ha finalizado o estÃ¡ por finalizar&#x27; };
      }

      if (now &lt; startDate) {
        return { success: false, error: &#x27;La reserva aÃºn no ha comenzado&#x27; };
      }

      // Calcular dÃ­as no utilizados (diferencia entre ahora y fin programado)
      const msPerDay &#x3D; 1000 * 60 * 60 * 24;
      const remainingDays &#x3D; Math.floor((endDate.getTime() - now.getTime()) / msPerDay);

      if (remainingDays &lt;&#x3D; 0) {
        return { success: false, error: &#x27;No hay dÃ­as completos para reembolsar&#x27; };
      }

      const pricePerDay &#x3D; this.getBookingPricePerDay(booking);
      const refundAmount &#x3D; pricePerDay * remainingDays;

      // Actualizar fecha de fin a &quot;ahora&quot;
      await this.updateBooking(booking.id, {
        end_at: now.toISOString(),
        // total_amount se ajustarÃ¡ automÃ¡ticamente o se deja como registro histÃ³rico
        // Idealmente deberÃ­amos actualizar total_amount &#x3D; total_amount - refundAmount
        total_amount: (booking.total_amount || 0) - refundAmount,
      });

      // Procesar reembolso
      if (refundAmount &gt; 0) {
        // Reembolsar a wallet (o tarjeta si es posible, pero wallet es inmediato)
        if (booking.user_id) {
          await this.walletService.depositFunds(
            booking.user_id,
            Math.round(refundAmount * 100),
            &#x60;Reembolso por devoluciÃ³n anticipada (${remainingDays} dÃ­as)&#x60;,
            booking.id,
          );
        }
      }

      return { success: true };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : &#x27;Error al procesar devoluciÃ³n anticipada&#x27;,
      };
    }
  }

  /**
   * Inicia una disputa sobre cargos adicionales
   * Congela la transferencia de fondos al dueÃ±o hasta resoluciÃ³n.
   */
  async createDispute(
    bookingId: string,
    reason: string,
    evidence?: string[],
  ): Promise&lt;{ success: boolean; error?: string }&gt; {
    try {
      const user &#x3D; await this.supabase.auth.getUser();
      if (!user.data.user) throw new Error(&#x27;No autenticado&#x27;);

      // Insertar disputa
      const { error } &#x3D; await this.supabase.from(&#x27;booking_disputes&#x27;).insert({
        booking_id: bookingId,
        opened_by: user.data.user.id,
        reason,
        evidence: evidence || [],
        status: &#x27;open&#x27;,
        created_at: new Date().toISOString(),
      });

      if (error) throw error;

      // Marcar booking en estado de disputa (esto deberÃ­a bloquear payouts automÃ¡ticos en el backend)
      await this.updateBooking(bookingId, {
        status: &#x27;pending_dispute_resolution&#x27;, // Correct status for disputes
        // metadata: { is_disputed: true } // Alternativa si no hay enum
      });

      return { success: true };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : &#x27;Error al crear disputa&#x27;,
      };
    }
  }

  // Utility Operations
  getTimeUntilExpiration(booking: Booking): number | null {
    return this.utilsService.getTimeUntilExpiration(booking);
  }

  formatTimeRemaining(milliseconds: number): string {
    return this.utilsService.formatTimeRemaining(milliseconds);
  }

  isExpired(booking: Booking): boolean {
    return this.utilsService.isExpired(booking);
  }

  // Insurance Operations (delegation to InsuranceService)
  async activateInsuranceCoverage(
    bookingId: string,
    addonIds: string[] &#x3D; [],
  ): Promise&lt;{ success: boolean; coverage_id?: string; error?: string }&gt; {
    try {
      const coverageId &#x3D; await this.insuranceService.activateCoverage({
        booking_id: bookingId,
        addon_ids: addonIds,
      });

      return {
        success: true,
        coverage_id: coverageId,
      };
    } catch (error: unknown) {
      return {
        success: false,
        error: error instanceof Error ? error.message : &#x27;Error al activar cobertura de seguro&#x27;,
      };
    }
  }

  async getBookingInsuranceSummary(bookingId: string) {
    return this.insuranceService.getInsuranceSummary(bookingId);
  }

  async calculateInsuranceDeposit(carId: string): Promise&lt;number&gt; {
    return this.insuranceService.calculateSecurityDeposit(carId);
  }

  async hasOwnerInsurance(carId: string): Promise&lt;boolean&gt; {
    return this.insuranceService.hasOwnerInsurance(carId);
  }

  async getInsuranceCommissionRate(carId: string): Promise&lt;number&gt; {
    return this.insuranceService.getCommissionRate(carId);
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // PRIVATE HELPER METHODS
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Update app badge with pending bookings count
   */
  private async updateAppBadge(bookings: Booking[]): Promise&lt;void&gt; {
    const pendingCount &#x3D; bookings.filter(
      (b) &#x3D;&gt; b.status &#x3D;&#x3D;&#x3D; &#x27;pending&#x27; || b.status &#x3D;&#x3D;&#x3D; &#x27;confirmed&#x27;,
    ).length;

    if (pendingCount &gt; 0) {
      await this.pwaService.setAppBadge(pendingCount);
    } else {
      await this.pwaService.clearAppBadge();
    }
  }

  /**
   * Load car details for a booking
   */
  private async loadCarDetails(booking: Booking): Promise&lt;void&gt; {
    try {
      const { data: car, error: carError } &#x3D; await this.supabase
        .from(&#x27;cars&#x27;)
        .select(&#x27;id, brand, model, year, license_plate, images&#x27;)
        .eq(&#x27;id&#x27;, booking.car_id)
        .single();

      if (!carError &amp;&amp; car) {
        (booking as Booking).car &#x3D; car as Partial&lt;import(&#x27;../models&#x27;).Car&gt;;
      } else if (carError) {
        this.logger.error(
          &#x27;Car query error&#x27;,
          &#x27;BookingsService&#x27;,
          carError instanceof Error ? carError : new Error(getErrorMessage(carError)),
        );
      }
    } catch (carException) {
      this.logger.error(
        &#x27;Error loading car details&#x27;,
        &#x27;BookingsService&#x27;,
        carException instanceof Error ? carException : new Error(getErrorMessage(carException)),
      );
      throw new Error(
        &#x60;Failed to load car details: ${carException instanceof Error ? carException.message : getErrorMessage(carException)}&#x60;,
      );
    }
  }

  /**
   * Load insurance coverage for a booking
   */
  private async loadInsuranceCoverage(booking: Booking): Promise&lt;void&gt; {
    try {
      const { data: coverage, error: coverageError } &#x3D; await this.supabase
        .from(&#x27;booking_insurance_coverage&#x27;)
        .select(&#x27;*&#x27;)
        .eq(&#x27;id&#x27;, booking.insurance_coverage_id)
        .single();

      if (!coverageError &amp;&amp; coverage) {
        if (coverage.policy_id) {
          const { data: policy, error: policyError } &#x3D; await this.supabase
            .from(&#x27;insurance_policies&#x27;)
            .select(&#x27;*&#x27;)
            .eq(&#x27;id&#x27;, coverage.policy_id)
            .single();

          if (!policyError &amp;&amp; policy) {
            (coverage as Record&lt;string, unknown&gt;)[&#x27;policy&#x27;] &#x3D; policy;
          } else if (policyError) {
            this.logger.error(
              &#x27;Policy query error&#x27;,
              &#x27;BookingsService&#x27;,
              policyError instanceof Error ? policyError : new Error(getErrorMessage(policyError)),
            );
            throw new Error(&#x60;Failed to load policy: ${policyError.message}&#x60;);
          }
        }

        (booking as Booking).insurance_coverage &#x3D; coverage;
      } else if (coverageError) {
        this.logger.error(
          &#x27;Coverage query error&#x27;,
          &#x27;BookingsService&#x27;,
          coverageError instanceof Error
            ? coverageError
            : new Error(getErrorMessage(coverageError)),
        );
        throw new Error(&#x60;Failed to load coverage: ${coverageError.message}&#x60;);
      }
    } catch (coverageException) {
      this.logger.error(
        &#x27;Error loading coverage details&#x27;,
        &#x27;BookingsService&#x27;,
        coverageException instanceof Error
          ? coverageException
          : new Error(getErrorMessage(coverageException)),
      );
      throw new Error(
        &#x60;Failed to load insurance coverage: ${coverageException instanceof Error ? coverageException.message : getErrorMessage(coverageException)}&#x60;,
      );
    }
  }

  /**
   * Notifica al dueÃ±o del auto sobre una nueva solicitud de reserva
   */
  private async notifyOwnerOfNewBooking(booking: Booking): Promise&lt;void&gt; {
    try {
      if (!booking.owner_id || !booking.car_id) return;

      // Obtener informaciÃ³n del auto y del locatario en paralelo
      const [car, renter] &#x3D; await Promise.all([
        this.carsService.getCarById(booking.car_id),
        this.profileService.getProfileById(booking.user_id || booking.renter_id || &#x27;&#x27;),
      ]);

      if (car &amp;&amp; renter) {
        const carName &#x3D; car.title || &#x60;${car.brand || &#x27;&#x27;} ${car.model || &#x27;&#x27;}&#x60;.trim() || &#x27;tu auto&#x27;;
        const renterName &#x3D; renter.full_name || &#x27;Un usuario&#x27;;
        const pricePerDay &#x3D; this.getBookingPricePerDay(booking);
        const bookingUrl &#x3D; &#x60;/bookings/${booking.id}&#x60;;

        this.carOwnerNotifications.notifyNewBookingRequest(
          renterName,
          carName,
          pricePerDay,
          bookingUrl,
        );
      }
    } catch (error) {
      this.logger.warn(
        &#x27;Failed to notify owner of booking request&#x27;,
        &#x27;BookingsService&#x27;,
        error instanceof Error ? error : new Error(getErrorMessage(error)),
      );
    }
  }

  private getBookingCarTitle(booking: BookingWithMetadata): string {
    const fallbackTitle &#x3D; booking.car?.title?.trim();
    return booking.car_title || fallbackTitle || &#x27;Auto&#x27;;
  }

  private getBookingPricePerDay(booking: BookingWithMetadata): number {
    return typeof booking.price_per_day &#x3D;&#x3D;&#x3D; &#x27;number&#x27; ? (booking.price_per_day ?? 0) : 0;
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // PAYMENT ISSUES (P0-002 FIX)
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Create a payment issue record for manual review and background retry
   *
   * âœ… P0-002 FIX: Registro de fallos de wallet unlock para retry posterior
   *
   * Esta funciÃ³n guarda los errores crÃ­ticos de pago/wallet en la tabla
   * &#x60;payment_issues&#x60; para que un background job pueda reintentarlos.
   *
   * @param issue - Payment issue data
   * @returns Promise&lt;void&gt;
   */
  async createPaymentIssue(issue: {
    booking_id: string;
    issue_type: string;
    severity: &#x27;low&#x27; | &#x27;medium&#x27; | &#x27;high&#x27; | &#x27;critical&#x27;;
    description: string;
    metadata?: Record&lt;string, unknown&gt;;
    status?: &#x27;pending_review&#x27; | &#x27;in_progress&#x27; | &#x27;resolved&#x27; | &#x27;ignored&#x27;;
  }): Promise&lt;void&gt; {
    const { error } &#x3D; await this.supabase.from(&#x27;payment_issues&#x27;).insert({
      booking_id: issue.booking_id,
      issue_type: issue.issue_type,
      severity: issue.severity,
      description: issue.description,
      metadata: issue.metadata || {},
      status: issue.status || &#x27;pending_review&#x27;,
      created_at: new Date().toISOString(),
    });

    if (error) {
      this.logger.error(&#x27;Failed to create payment issue record&#x27;, &#x27;BookingsService&#x27;, error);
      throw error;
    }

    this.logger.info(&#x27;Payment issue created successfully&#x27;, &#x27;BookingsService&#x27;, {
      booking_id: issue.booking_id,
      issue_type: issue.issue_type,
      severity: issue.severity,
    });
  }

  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
  // INSURANCE ACTIVATION (P0-003 FIX)
  // &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

  /**
   * Activate insurance coverage with retry logic and MANDATORY blocking
   *
   * âœ… P0-003 FIX: Insurance activation BLOCKS booking if it fails
   *
   * CRITICAL: This method will throw an error if insurance activation fails
   * after all retries. This is MANDATORY for legal compliance - bookings
   * CANNOT proceed without valid insurance coverage.
   *
   * Features:
   * - 3 retry attempts with exponential backoff (1s, 2s, 4s)
   * - Detailed logging of each attempt
   * - Critical alerts to Sentry if all retries fail
   * - BLOCKS booking creation if insurance fails
   * - Auto-cancellation of booking if insurance fails
   *
   * Legal Requirements:
   * - All bookings MUST have active insurance coverage
   * - Violation of this requirement is ILLEGAL in most jurisdictions
   * - Potential financial exposure: millions USD per incident
   *
   * @param bookingId - ID of the booking
   * @param addonIds - Optional insurance addon IDs
   * @throws Error if insurance activation fails after all retries
   */
  private async activateInsuranceWithRetry(
    bookingId: string,
    addonIds: string[] &#x3D; [],
  ): Promise&lt;void&gt; {
    const maxRetries &#x3D; 3;
    let lastError: unknown;

    for (let attempt &#x3D; 1; attempt &lt;&#x3D; maxRetries; attempt++) {
      try {
        this.logger.info(
          &#x60;Attempting insurance activation (attempt ${attempt}/${maxRetries})&#x60;,
          &#x27;BookingsService&#x27;,
          { bookingId, addonIds, attempt },
        );

        // Attempt to activate insurance
        await this.insuranceService.activateCoverage({
          booking_id: bookingId,
          addon_ids: addonIds,
        });

        this.logger.info(&#x27;Insurance activated successfully&#x27;, &#x27;BookingsService&#x27;, {
          bookingId,
          addonIds,
          attempt,
          totalAttempts: attempt,
        });

        // âœ… Success - insurance is active
        return;
      } catch (error) {
        lastError &#x3D; error;

        this.logger.warn(
          &#x60;Insurance activation failed (attempt ${attempt}/${maxRetries})&#x60;,
          &#x27;BookingsService&#x27;,
          error instanceof Error ? error : new Error(getErrorMessage(error)),
        );

        // If not the last attempt, wait with exponential backoff
        if (attempt &lt; maxRetries) {
          const delayMs &#x3D; Math.pow(2, attempt - 1) * 1000; // 1s, 2s, 4s
          await this.delay(delayMs);
        }
      }
    }

    // âŒ All retries failed - CRITICAL ERROR
    await this.handleInsuranceActivationFailure(bookingId, addonIds, lastError);
  }

  /**
   * Handle critical insurance activation failure
   *
   * Actions:
   * 1. Log CRITICAL error to Sentry (legal compliance)
   * 2. Auto-cancel the booking (cannot proceed without insurance)
   * 3. Create compliance issue record for audit trail
   * 4. Alert compliance team
   *
   * @param bookingId - ID of the booking
   * @param addonIds - Insurance addon IDs that failed to activate
   * @param error - Error that caused the failure
   * @throws Error - Always throws to block booking creation
   */
  private async handleInsuranceActivationFailure(
    bookingId: string,
    addonIds: string[],
    error: unknown,
  ): Promise&lt;never&gt; {
    const errorMessage &#x3D; error instanceof Error ? error.message : String(error);
    const errorStack &#x3D; error instanceof Error ? error.stack : undefined;

    // 1. âŒ CRITICAL LOG - Legal compliance violation
    this.logger.critical(
      &#x27;CRITICAL: Insurance activation failed - LEGAL COMPLIANCE VIOLATION&#x27;,
      &#x27;BookingsService&#x27;,
      error instanceof Error ? error : new Error(&#x60;Insurance activation failed: ${errorMessage}&#x60;),
    );

    // 2. Log detailed information for audit trail
    this.logger.error(
      &#x27;Insurance activation failure details (LEGAL COMPLIANCE)&#x27;,
      &#x27;BookingsService&#x27;,
      error instanceof Error ? error : new Error(errorMessage),
    );

    // 3. Auto-cancel booking due to system failure (insurance activation)
    // âœ… ATOMICITY FIX: Use cancellation_reason to distinguish from user cancellations
    // Note: &#x27;failed&#x27; status not in DB enum, using &#x27;cancelled&#x27; with distinct reason
    try {
      await this.updateBooking(bookingId, {
        status: &#x27;cancelled&#x27;,
        cancellation_reason: &#x27;system_failure:insurance_activation_failed&#x27;,
        cancelled_at: new Date().toISOString(),
      });

      this.logger.info(
        &#x27;Booking auto-cancelled due to insurance system failure&#x27;,
        &#x27;BookingsService&#x27;,
        {
          bookingId,
          status: &#x27;cancelled&#x27;,
          reason: &#x27;system_failure:insurance_activation_failed&#x27;,
          isSystemFailure: true,
        },
      );
    } catch (cancelError) {
      this.logger.error(
        &#x27;Failed to auto-cancel booking after insurance failure&#x27;,
        &#x27;BookingsService&#x27;,
        cancelError instanceof Error ? cancelError : new Error(getErrorMessage(cancelError)),
      );
    }

    // 4. Create compliance issue for audit trail
    try {
      await this.createPaymentIssue({
        booking_id: bookingId,
        issue_type: &#x27;insurance_activation_failed&#x27;,
        severity: &#x27;critical&#x27;,
        description: &#x60;LEGAL COMPLIANCE: Failed to activate insurance after ${3} retry attempts. Booking auto-cancelled.&#x60;,
        metadata: {
          addon_ids: addonIds,
          error: errorMessage,
          stack: errorStack,
          timestamp: new Date().toISOString(),
          retry_count: 3,
          compliance_violation: true,
          legal_risk: &#x27;HIGH&#x27;,
        },
        status: &#x27;pending_review&#x27;,
      });
    } catch (issueError) {
      this.logger.error(
        &#x27;Failed to create compliance issue record&#x27;,
        &#x27;BookingsService&#x27;,
        issueError instanceof Error ? issueError : new Error(getErrorMessage(issueError)),
      );
    }

    // 5. âŒ THROW ERROR - BLOCK booking creation
    throw new Error(
      &#x60;CRITICAL: Cannot create booking without insurance coverage. &#x60; +
        &#x60;Insurance activation failed after 3 attempts. &#x60; +
        &#x60;Error: ${errorMessage}. &#x60; +
        &#x60;Booking has been auto-cancelled for legal compliance.&#x60;,
    );
  }

  /**
   * Utility: Delay execution for specified milliseconds
   */
  private delay(ms: number): Promise&lt;void&gt; {
    return new Promise((resolve) &#x3D;&gt; setTimeout(resolve, ms));
  }
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'BookingsService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
