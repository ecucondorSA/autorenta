<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>autorenta-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">autorenta-web documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">

















<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  NotificationRow</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/services/user-notifications.service.ts</code>
        </p>




        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#body" 
>
                                            body
                                        </a>
                                </li>
                                <li>
                                        <a href="#created_at" 
>
                                            created_at
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#cta_link" 
>
                                            cta_link
                                        </a>
                                </li>
                                <li>
                                        <a href="#id" 
>
                                            id
                                        </a>
                                </li>
                                <li>
                                        <a href="#is_read" 
>
                                            is_read
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#metadata" 
>
                                            metadata
                                        </a>
                                </li>
                                <li>
                                        <a href="#title" 
>
                                            title
                                        </a>
                                </li>
                                <li>
                                        <a href="#type" 
>
                                            type
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="body"></a>
                                        <span class="name "><b>body</b>
                                            <a href="#body">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>body:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="created_at"></a>
                                        <span class="name "><b>created_at</b>
                                            <a href="#created_at">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>created_at:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="cta_link"></a>
                                        <span class="name "><b>cta_link</b>
                                            <a href="#cta_link">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>cta_link:     <code>string | null</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string | null</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="id"></a>
                                        <span class="name "><b>id</b>
                                            <a href="#id">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="is_read"></a>
                                        <span class="name "><b>is_read</b>
                                            <a href="#is_read">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>is_read:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="metadata"></a>
                                        <span class="name "><b>metadata</b>
                                            <a href="#metadata">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>metadata:     <code>Record&lt;string | unknown&gt; | null</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>Record&lt;string | unknown&gt; | null</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="title"></a>
                                        <span class="name "><b>title</b>
                                            <a href="#title">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>title:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="type"></a>
                                        <span class="name "><b>type</b>
                                            <a href="#type">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>type:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, signal, inject, OnDestroy, effect } from &#x27;@angular/core&#x27;;
import type { RealtimeChannel, RealtimePostgresInsertPayload } from &#x27;@supabase/supabase-js&#x27;;
import { injectSupabase } from &#x27;./supabase-client.service&#x27;;
import { AuthService } from &#x27;./auth.service&#x27;;

export interface NotificationItem {
  id: string;
  title: string;
  message: string;
  type: &#x27;info&#x27; | &#x27;success&#x27; | &#x27;warning&#x27; | &#x27;error&#x27;;
  read: boolean;
  createdAt: Date;
  actionUrl?: string;
  actionText?: string;
  metadata?: Record&lt;string, unknown&gt;;
}

interface NotificationRow {
  id: string;
  title: string;
  body: string;
  type: string;
  is_read: boolean;
  created_at: string;
  cta_link?: string | null;
  metadata?: Record&lt;string, unknown&gt; | null;
}

type NotificationListItem &#x3D; NotificationItem &amp; { dbType: string };

@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class NotificationsService implements OnDestroy {
  private readonly supabase &#x3D; injectSupabase();
  private readonly authService &#x3D; inject(AuthService);

  // Estado reactivo
  readonly notifications &#x3D; signal&lt;NotificationItem[]&gt;([]);
  readonly unreadCount &#x3D; signal(0);
  readonly connectionStatus &#x3D; signal&lt;&#x27;disconnected&#x27; | &#x27;connecting&#x27; | &#x27;connected&#x27; | &#x27;error&#x27;&gt;(
    &#x27;disconnected&#x27;,
  );

  // Referencia al channel de Realtime para poder hacer cleanup
  private realtimeChannel: RealtimeChannel | null &#x3D; null;
  private isSubscribed &#x3D; false;

  constructor() {
    // Efecto reactivo: suscribirse cuando el usuario se autentica
    effect(() &#x3D;&gt; {
      const isAuthenticated &#x3D; this.authService.isAuthenticated();

      if (isAuthenticated) {
        // Usuario autenticado: cargar notificaciones y suscribirse
        void this.initializeNotifications();
      } else {
        // Usuario no autenticado: limpiar suscripción
        this.unsubscribe();
        this.notifications.set([]);
        this.unreadCount.set(0);
      }
    });
  }

  ngOnDestroy(): void {
    this.unsubscribe();
  }

  /**
   * Inicializa notificaciones cuando el usuario está autenticado
   */
  private async initializeNotifications(): Promise&lt;void&gt; {
    // Cargar notificaciones existentes
    await this.loadNotificationsInternal();

    // Suscribirse a cambios en tiempo real
    await this.subscribeToRealtime();
  }

  /**
   * Método público para refrescar notificaciones manualmente
   */
  async refresh(): Promise&lt;void&gt; {
    await this.loadNotifications();
  }

  /**
   * Método público para cargar notificaciones
   */
  async loadNotifications(): Promise&lt;void&gt; {
    await this.loadNotificationsInternal();
  }

  private async loadNotificationsInternal() {
    try {
      const {
        data: { user },
      } &#x3D; await this.supabase.auth.getUser();
      if (!user) return;

      const { data, error } &#x3D; await this.supabase
        .from(&#x27;notifications&#x27;)
        .select(&#x27;*&#x27;)
        .eq(&#x27;user_id&#x27;, user.id)
        .order(&#x27;created_at&#x27;, { ascending: false })
        .limit(50)
        .returns&lt;NotificationRow[]&gt;();

      if (error) throw error as Error;

      const notifications: NotificationItem[] &#x3D; (data || []).map((notification) &#x3D;&gt;
        this.mapNotification(notification),
      );

      this.notifications.set(notifications);
      this.updateUnreadCount();
    } catch (_error) {
      console.error(&#x27;Error loading notifications:&#x27;, _error);
    }
  }

  /**
   * Suscribirse a cambios en tiempo real de notificaciones
   * Maneja reconexión automática y estado de conexión
   */
  private async subscribeToRealtime(): Promise&lt;void&gt; {
    try {
      const {
        data: { user },
      } &#x3D; await this.supabase.auth.getUser();

      if (!user) {
        console.warn(&#x27;[NotificationsService] No user found, skipping Realtime subscription&#x27;);
        this.connectionStatus.set(&#x27;disconnected&#x27;);
        return;
      }

      // Limpiar suscripción anterior si existe
      if (this.realtimeChannel) {
        this.unsubscribe();
      }

      this.connectionStatus.set(&#x27;connecting&#x27;);
      console.log(
        &#x27;[NotificationsService] Subscribing to Realtime notifications for user:&#x27;,
        user.id,
      );

      // Crear nuevo channel
      this.realtimeChannel &#x3D; this.supabase
        .channel(&#x60;notifications:${user.id}&#x60;)
        .on(
          &#x27;postgres_changes&#x27;,
          {
            event: &#x27;INSERT&#x27;,
            schema: &#x27;public&#x27;,
            table: &#x27;notifications&#x27;,
            filter: &#x60;user_id&#x3D;eq.${user.id}&#x60;,
          },
          (payload: RealtimePostgresInsertPayload&lt;NotificationRow&gt;) &#x3D;&gt; {
            console.log(&#x27;[NotificationsService] New notification received via Realtime:&#x27;, payload);
            this.addNotification(payload.new);
          },
        )
        .subscribe((status) &#x3D;&gt; {
          console.log(&#x27;[NotificationsService] Realtime subscription status:&#x27;, status);

          if (status &#x3D;&#x3D;&#x3D; &#x27;SUBSCRIBED&#x27;) {
            this.connectionStatus.set(&#x27;connected&#x27;);
            this.isSubscribed &#x3D; true;
            console.log(
              &#x27;[NotificationsService] ✅ Successfully subscribed to Realtime notifications&#x27;,
            );
          } else if (status &#x3D;&#x3D;&#x3D; &#x27;CHANNEL_ERROR&#x27;) {
            this.connectionStatus.set(&#x27;error&#x27;);
            this.isSubscribed &#x3D; false;
            console.error(&#x27;[NotificationsService] ❌ Realtime channel error&#x27;);

            // Intentar reconectar después de 5 segundos
            setTimeout(() &#x3D;&gt; {
              console.log(&#x27;[NotificationsService] Attempting to reconnect...&#x27;);
              void this.subscribeToRealtime();
            }, 5000);
          } else if (status &#x3D;&#x3D;&#x3D; &#x27;TIMED_OUT&#x27;) {
            this.connectionStatus.set(&#x27;error&#x27;);
            this.isSubscribed &#x3D; false;
            console.warn(&#x27;[NotificationsService] ⚠️ Realtime subscription timed out&#x27;);

            // Intentar reconectar después de 5 segundos
            setTimeout(() &#x3D;&gt; {
              console.log(&#x27;[NotificationsService] Attempting to reconnect after timeout...&#x27;);
              void this.subscribeToRealtime();
            }, 5000);
          } else if (status &#x3D;&#x3D;&#x3D; &#x27;CLOSED&#x27;) {
            this.connectionStatus.set(&#x27;disconnected&#x27;);
            this.isSubscribed &#x3D; false;
            console.log(&#x27;[NotificationsService] Realtime channel closed&#x27;);
          }
        });
    } catch (error) {
      console.error(&#x27;[NotificationsService] Error subscribing to Realtime:&#x27;, error);
      this.connectionStatus.set(&#x27;error&#x27;);
      this.isSubscribed &#x3D; false;

      // Intentar reconectar después de 5 segundos
      setTimeout(() &#x3D;&gt; {
        console.log(&#x27;[NotificationsService] Attempting to reconnect after error...&#x27;);
        void this.subscribeToRealtime();
      }, 5000);
    }
  }

  /**
   * Desuscribirse del channel de Realtime
   */
  private unsubscribe(): void {
    if (this.realtimeChannel) {
      console.log(&#x27;[NotificationsService] Unsubscribing from Realtime notifications&#x27;);
      this.supabase.removeChannel(this.realtimeChannel);
      this.realtimeChannel &#x3D; null;
      this.isSubscribed &#x3D; false;
      this.connectionStatus.set(&#x27;disconnected&#x27;);
    }
  }

  /**
   * Reconectar manualmente a Realtime
   */
  async reconnect(): Promise&lt;void&gt; {
    console.log(&#x27;[NotificationsService] Manual reconnect requested&#x27;);
    this.unsubscribe();
    await this.subscribeToRealtime();
  }

  private addNotification(notificationData: NotificationRow) {
    const notification &#x3D; this.mapNotification(notificationData, false);

    const current &#x3D; this.notifications();
    this.notifications.set([notification, ...current]);
    this.updateUnreadCount();

    // Mostrar notificación push si está disponible
    this.showBrowserNotification(notification);
  }

  private mapNotification(
    notification: NotificationRow,
    preserveReadState: boolean &#x3D; true,
  ): NotificationItem {
    return {
      id: notification.id,
      title: notification.title,
      message: notification.body,
      type: this.mapNotificationType(notification.type),
      read: preserveReadState ? (notification.is_read ?? false) : false,
      createdAt: new Date(notification.created_at),
      actionUrl: notification.cta_link ?? undefined,
      actionText: &#x27;Ver detalles&#x27;,
      metadata: notification.metadata ?? undefined,
    };
  }

  private mapNotificationWithDbType(notification: NotificationRow): NotificationListItem {
    return {
      ...this.mapNotification(notification),
      dbType: notification.type,
    };
  }

  // Map database notification types to UI types
  private mapNotificationType(dbType: string): &#x27;info&#x27; | &#x27;success&#x27; | &#x27;warning&#x27; | &#x27;error&#x27; {
    switch (dbType) {
      case &#x27;new_booking_for_owner&#x27;:
      case &#x27;payment_successful&#x27;:
      case &#x27;payout_successful&#x27;:
        return &#x27;success&#x27;;
      case &#x27;booking_cancelled_for_owner&#x27;:
      case &#x27;booking_cancelled_for_renter&#x27;:
      case &#x27;inspection_reminder&#x27;:
        return &#x27;warning&#x27;;
      case &#x27;new_chat_message&#x27;:
      case &#x27;generic_announcement&#x27;:
      default:
        return &#x27;info&#x27;;
    }
  }

  private updateUnreadCount() {
    const unread &#x3D; this.notifications().filter((n) &#x3D;&gt; !n.read).length;
    this.unreadCount.set(unread);
  }

  async markAsRead(notificationId: string) {
    try {
      const { error } &#x3D; await this.supabase
        .from(&#x27;notifications&#x27;)
        .update({ is_read: true })
        .eq(&#x27;id&#x27;, notificationId);

      if (error) throw error as Error;

      // Actualizar estado local
      const current &#x3D; this.notifications();
      const updated &#x3D; current.map((n) &#x3D;&gt; (n.id &#x3D;&#x3D;&#x3D; notificationId ? { ...n, read: true } : n));
      this.notifications.set(updated);
      this.updateUnreadCount();
    } catch (_error) {
      console.error(&#x27;Error marking notification as read:&#x27;, _error);
    }
  }

  async markAllAsRead() {
    try {
      const {
        data: { user },
      } &#x3D; await this.supabase.auth.getUser();
      if (!user) return;

      const { error } &#x3D; await this.supabase
        .from(&#x27;notifications&#x27;)
        .update({ is_read: true })
        .eq(&#x27;user_id&#x27;, user.id)
        .eq(&#x27;is_read&#x27;, false);

      if (error) throw error as Error;

      // Actualizar estado local
      const current &#x3D; this.notifications();
      const updated &#x3D; current.map((n) &#x3D;&gt; ({ ...n, read: true }));
      this.notifications.set(updated);
      this.unreadCount.set(0);
    } catch (_error) {
      console.error(&#x27;Error marking all notifications as read:&#x27;, _error);
    }
  }

  // Notificaciones push del navegador
  private async showBrowserNotification(notification: NotificationItem) {
    if (&#x27;Notification&#x27; in window &amp;&amp; Notification.permission &#x3D;&#x3D;&#x3D; &#x27;granted&#x27;) {
      const browserNotification &#x3D; new Notification(notification.title, {
        body: notification.message,
        icon: &#x27;/assets/icons/icon-192x192.png&#x27;,
        badge: &#x27;/assets/icons/icon-192x192.png&#x27;,
        tag: notification.id,
      });

      browserNotification.onclick &#x3D; () &#x3D;&gt; {
        if (notification.actionUrl) {
          window.location.href &#x3D; notification.actionUrl;
        }
        browserNotification.close();
      };

      // Auto-close después de 5 segundos
      setTimeout(() &#x3D;&gt; browserNotification.close(), 5000);
    }
  }

  async requestNotificationPermission(): Promise&lt;boolean&gt; {
    if (!(&#x27;Notification&#x27; in window)) {
      return false;
    }

    if (Notification.permission &#x3D;&#x3D;&#x3D; &#x27;granted&#x27;) {
      return true;
    }

    if (Notification.permission &#x3D;&#x3D;&#x3D; &#x27;denied&#x27;) {
      return false;
    }

    const permission &#x3D; await Notification.requestPermission();
    return permission &#x3D;&#x3D;&#x3D; &#x27;granted&#x27;;
  }

  // Métodos para crear notificaciones (desde backend)
  async createNotification(
    userId: string,
    notification: Omit&lt;NotificationItem, &#x27;id&#x27; | &#x27;read&#x27; | &#x27;createdAt&#x27;&gt;,
    dbType: string,
  ) {
    try {
      const { data, error } &#x3D; await this.supabase
        .from(&#x27;notifications&#x27;)
        .insert({
          user_id: userId,
          title: notification.title,
          body: notification.message,
          type: dbType,
          is_read: false,
          cta_link: notification.actionUrl || null,
          metadata: notification.metadata || {},
        })
        .select(&#x27;*&#x27;)
        .single();

      if (error) throw error as Error;
      if (data) {
        this.addNotification(data as NotificationRow);
      }
      return data as NotificationRow;
    } catch (_error) {
      console.error(&#x27;Error creating notification:&#x27;, _error);
      throw _error as Error;
    }
  }

  // Notificaciones predefinidas
  async notifyNewBookingForOwner(bookingId: string, carTitle: string, renterName: string) {
    const {
      data: { user },
    } &#x3D; await this.supabase.auth.getUser();
    if (!user) return;

    return this.createNotification(
      user.id,
      {
        title: &#x27;Nueva reserva recibida&#x27;,
        message: &#x60;${renterName} solicitó reservar tu ${carTitle}&#x60;,
        type: &#x27;success&#x27;,
        actionUrl: &#x60;/bookings/${bookingId}&#x60;,
        metadata: { bookingId, renterName, carTitle },
      },
      &#x27;new_booking_for_owner&#x27;,
    );
  }

  async notifyBookingCreated(bookingId: string, carTitle: string) {
    const {
      data: { user },
    } &#x3D; await this.supabase.auth.getUser();
    if (!user) return;

    return this.createNotification(
      user.id,
      {
        title: &#x27;Reserva creada&#x27;,
        message: &#x60;Tu solicitud de reserva para ${carTitle} ha sido enviada&#x60;,
        type: &#x27;success&#x27;,
        actionUrl: &#x60;/bookings/${bookingId}&#x60;,
        metadata: { bookingId, carTitle },
      },
      &#x27;booking_created&#x27;,
    );
  }

  async notifyBookingCancelledForOwner(bookingId: string, carTitle: string, renterName: string) {
    const {
      data: { user },
    } &#x3D; await this.supabase.auth.getUser();
    if (!user) return;

    return this.createNotification(
      user.id,
      {
        title: &#x27;Reserva cancelada&#x27;,
        message: &#x60;${renterName} canceló la reserva de tu ${carTitle}&#x60;,
        type: &#x27;warning&#x27;,
        actionUrl: &#x60;/bookings/${bookingId}&#x60;,
        metadata: { bookingId, renterName, carTitle },
      },
      &#x27;booking_cancelled_for_owner&#x27;,
    );
  }

  async notifyBookingCancelledForRenter(bookingId: string, carTitle: string, ownerName: string) {
    const {
      data: { user },
    } &#x3D; await this.supabase.auth.getUser();
    if (!user) return;

    return this.createNotification(
      user.id,
      {
        title: &#x27;Reserva cancelada&#x27;,
        message: &#x60;El anfitrión ${ownerName} canceló tu reserva para ${carTitle}&#x60;,
        type: &#x27;warning&#x27;,
        actionUrl: &#x60;/bookings/${bookingId}&#x60;,
        metadata: { bookingId, ownerName, carTitle },
      },
      &#x27;booking_cancelled_for_renter&#x27;,
    );
  }

  async notifyPaymentSuccessful(amount: number, currency: string &#x3D; &#x27;ARS&#x27;, bookingId?: string) {
    const {
      data: { user },
    } &#x3D; await this.supabase.auth.getUser();
    if (!user) return;

    return this.createNotification(
      user.id,
      {
        title: &#x27;Pago exitoso&#x27;,
        message: &#x60;Tu pago de ${amount.toLocaleString()} ${currency} fue procesado correctamente&#x60;,
        type: &#x27;success&#x27;,
        actionUrl: bookingId ? &#x60;/bookings/${bookingId}&#x60; : &#x27;/wallet&#x27;,
        metadata: { amount, currency, bookingId },
      },
      &#x27;payment_successful&#x27;,
    );
  }

  async notifyPayoutSuccessful(amount: number, currency: string &#x3D; &#x27;ARS&#x27;) {
    const {
      data: { user },
    } &#x3D; await this.supabase.auth.getUser();
    if (!user) return;

    return this.createNotification(
      user.id,
      {
        title: &#x27;Pago recibido&#x27;,
        message: &#x60;Se acreditaron ${amount.toLocaleString()} ${currency} en tu wallet&#x60;,
        type: &#x27;success&#x27;,
        actionUrl: &#x27;/wallet&#x27;,
        metadata: { amount, currency },
      },
      &#x27;payout_successful&#x27;,
    );
  }

  async notifyInspectionReminder(
    bookingId: string,
    carTitle: string,
    inspectionType: &#x27;pickup&#x27; | &#x27;return&#x27;,
  ) {
    const {
      data: { user },
    } &#x3D; await this.supabase.auth.getUser();
    if (!user) return;

    const message &#x3D;
      inspectionType &#x3D;&#x3D;&#x3D; &#x27;pickup&#x27;
        ? &#x60;Recuerda realizar la inspección de recogida para ${carTitle}&#x60;
        : &#x60;Recuerda realizar la inspección de devolución para ${carTitle}&#x60;;

    return this.createNotification(
      user.id,
      {
        title: &#x27;Recordatorio de inspección&#x27;,
        message,
        type: &#x27;warning&#x27;,
        actionUrl: &#x60;/bookings/${bookingId}&#x60;,
        metadata: { bookingId, carTitle, inspectionType },
      },
      &#x27;inspection_reminder&#x27;,
    );
  }

  async notifyGenericAnnouncement(title: string, message: string, actionUrl?: string) {
    const {
      data: { user },
    } &#x3D; await this.supabase.auth.getUser();
    if (!user) return;

    return this.createNotification(
      user.id,
      {
        title,
        message,
        type: &#x27;info&#x27;,
        actionUrl,
        metadata: {},
      },
      &#x27;generic_announcement&#x27;,
    );
  }

  // Additional methods for notifications page
  async loadAllNotifications(limit?: number, offset?: number) {
    try {
      const {
        data: { user },
      } &#x3D; await this.supabase.auth.getUser();
      if (!user) return [];

      let query &#x3D; this.supabase
        .from(&#x27;notifications&#x27;)
        .select(&#x27;*&#x27;)
        .eq(&#x27;user_id&#x27;, user.id)
        .order(&#x27;created_at&#x27;, { ascending: false });

      if (limit) query &#x3D; query.limit(limit);
      if (offset) query &#x3D; query.range(offset, offset + (limit || 50) - 1);

      const { data, error } &#x3D; await query.returns&lt;NotificationRow[]&gt;();

      if (error) throw error as Error;

      return (data || []).map((notification) &#x3D;&gt; this.mapNotificationWithDbType(notification));
    } catch (_error) {
      console.error(&#x27;Error loading all notifications:&#x27;, _error);
      return [];
    }
  }

  async filterNotificationsByType(dbType?: string) {
    try {
      const {
        data: { user },
      } &#x3D; await this.supabase.auth.getUser();
      if (!user) return [];

      let query &#x3D; this.supabase
        .from(&#x27;notifications&#x27;)
        .select(&#x27;*&#x27;)
        .eq(&#x27;user_id&#x27;, user.id)
        .order(&#x27;created_at&#x27;, { ascending: false });

      if (dbType &amp;&amp; dbType !&#x3D;&#x3D; &#x27;all&#x27;) {
        query &#x3D; query.eq(&#x27;type&#x27;, dbType);
      }

      const { data, error } &#x3D; await query.returns&lt;NotificationRow[]&gt;();

      if (error) throw error as Error;

      return (data || []).map((notification) &#x3D;&gt; this.mapNotificationWithDbType(notification));
    } catch (_error) {
      console.error(&#x27;Error filtering notifications:&#x27;, _error);
      return [];
    }
  }

  async deleteNotification(notificationId: string) {
    try {
      const { error } &#x3D; await this.supabase.from(&#x27;notifications&#x27;).delete().eq(&#x27;id&#x27;, notificationId);

      if (error) throw error as Error;

      // Update local state
      const current &#x3D; this.notifications();
      const updated &#x3D; current.filter((n) &#x3D;&gt; n.id !&#x3D;&#x3D; notificationId);
      this.notifications.set(updated);
      this.updateUnreadCount();
    } catch (_error) {
      console.error(&#x27;Error deleting notification:&#x27;, _error);
      throw _error as Error;
    }
  }

  async deleteAllRead() {
    try {
      const {
        data: { user },
      } &#x3D; await this.supabase.auth.getUser();
      if (!user) return;

      const { error } &#x3D; await this.supabase
        .from(&#x27;notifications&#x27;)
        .delete()
        .eq(&#x27;user_id&#x27;, user.id)
        .eq(&#x27;is_read&#x27;, true);

      if (error) throw error as Error;

      // Update local state
      const current &#x3D; this.notifications();
      const updated &#x3D; current.filter((n) &#x3D;&gt; !n.read);
      this.notifications.set(updated);
    } catch (_error) {
      console.error(&#x27;Error deleting read notifications:&#x27;, _error);
      throw _error as Error;
    }
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'NotificationRow.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
