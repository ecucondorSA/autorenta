<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>autorenta-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">autorenta-web documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">

















<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  OTPVerificationResult</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/services/phone-verification.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>OTP Verification Result</p>

            </p>


        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#error" 
>
                                            error
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#message" 
>
                                            message
                                        </a>
                                </li>
                                <li>
                                        <a href="#success" 
>
                                            success
                                        </a>
                                </li>
                                <li>
                                        <a href="#verified" 
>
                                            verified
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="error"></a>
                                        <span class="name "><b>error</b>
                                            <a href="#error">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>error:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="message"></a>
                                        <span class="name "><b>message</b>
                                            <a href="#message">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>message:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="success"></a>
                                        <span class="name "><b>success</b>
                                            <a href="#success">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>success:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="verified"></a>
                                        <span class="name "><b>verified</b>
                                            <a href="#verified">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>verified:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, inject } from &#x27;@angular/core&#x27;;
import type { AuthError } from &#x27;@supabase/supabase-js&#x27;;
import { VerificationBaseService, VerificationStatus } from &#x27;./verification-base.service&#x27;;
import { LoggerService } from &#x27;./logger.service&#x27;;

/**
 * Phone Verification Status (extends base with OTP-specific fields)
 */
export interface PhoneVerificationStatus extends VerificationStatus {
  otpSent: boolean;
}

/**
 * OTP Verification Result
 */
export interface OTPVerificationResult {
  success: boolean;
  verified: boolean;
  error?: string;
  message?: string;
}

type AuthErrorWithCode &#x3D; AuthError &amp; {
  code?: string;
  error_code?: string;
};

/**
 * Service for managing phone number verification via SMS OTP
 *
 * Extends VerificationBaseService with phone-specific functionality:
 * - Sending OTP codes via SMS
 * - Verifying OTP codes
 * - Phone-specific rate limiting (3 attempts per hour)
 * - Argentina phone number validation (+54)
 *
 * Base class provides:
 * - Cooldown management (calculateCooldownRemaining, startCooldownTimer)
 * - Auth listener initialization
 * - Status updates from user object
 * - Reactive state (signals)
 */
@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class PhoneVerificationService extends VerificationBaseService&lt;PhoneVerificationStatus&gt; {
  // VerificationBaseService abstract properties
  protected readonly verificationType &#x3D; &#x27;phone&#x27; as const;
  protected readonly cooldownMs &#x3D; 60 * 1000; // 60 seconds

  // Phone-specific rate limiting
  private readonly MAX_ATTEMPTS_PER_HOUR &#x3D; 3;
  private otpAttempts: number[] &#x3D; []; // Timestamps of OTP attempts
  private logger &#x3D; inject(LoggerService).createChildLogger(&#x27;PhoneVerificationService&#x27;);

  constructor() {
    super();
    this.checkStatus().catch((err) &#x3D;&gt; {
      this.logger.error(&#x27;Failed to check initial phone status&#x27;, { error: err });
    });
  }

  /**
   * Override extendStatus to add phone-specific fields
   */
  protected override extendStatus(baseStatus: VerificationStatus): PhoneVerificationStatus {
    return {
      ...baseStatus,
      otpSent: this.statusSignal().otpSent ?? false,
    };
  }

  /**
   * Check current phone verification status (implements abstract method)
   */
  async checkStatus(): Promise&lt;PhoneVerificationStatus&gt; {
    this.loading.set(true);
    this.error.set(null);

    try {
      // IMPORTANT: Refresh session first to get fresh user data from server
      // This prevents stale cache issues where phone_confirmed_at might be outdated
      await this.supabase.auth.refreshSession();

      const {
        data: { user },
      } &#x3D; await this.supabase.auth.getUser();

      if (!user) {
        throw new Error(&#x27;Usuario no autenticado&#x27;);
      }

      this.logger.info(&#x27;Fresh user data from server&#x27;, {
        isVerified: user.phone_confirmed_at !&#x3D;&#x3D; null,
      });

      this.updateStatusFromUser(user as unknown as Record&lt;string, unknown&gt;);
      return this.status();
    } catch (err) {
      const message &#x3D;
        err instanceof Error ? err.message : &#x27;No pudimos verificar el estado del teléfono&#x27;;
      this.error.set(message);
      throw err;
    } finally {
      this.loading.set(false);
    }
  }

  /**
   * Override updateStatusFromUser to include phone-specific logic
   */
  protected override updateStatusFromUser(user: Record&lt;string, unknown&gt;): void {
    super.updateStatusFromUser(user); // Call base implementation

    // Add phone-specific canResend logic (includes rate limiting)
    const currentStatus &#x3D; this.statusSignal();
    const canResendWithRateLimit &#x3D; currentStatus.canResend &amp;&amp; this.canSendOTP();

    this.statusSignal.set({
      ...currentStatus,
      canResend: canResendWithRateLimit,
      otpSent: currentStatus.otpSent &amp;&amp; !currentStatus.isVerified,
    } as PhoneVerificationStatus);
  }

  /**
   * Send OTP code to phone number (implements abstract sendVerification)
   * @param phone Phone number in E.164 format (e.g., +5491123456789)
   * @param countryCode Country code (default: +54 for Argentina)
   */
  async sendVerification(phone: string, countryCode: string &#x3D; &#x27;+54&#x27;): Promise&lt;void&gt; {
    this.loading.set(true);
    this.error.set(null);

    try {
      // Early validation: check if phone is empty or too short
      const cleanedPhone &#x3D; phone?.trim() || &#x27;&#x27;;
      if (!cleanedPhone || cleanedPhone.length &lt; 7) {
        const formatHint &#x3D; this.getPhoneFormatHint(countryCode);
        throw new Error(
          &#x60;Por favor ingresa un número de teléfono válido. Formato esperado: ${formatHint}&#x60;,
        );
      }

      // Check cooldown (using base class method)
      this.checkCooldown();

      // Check phone-specific rate limiting
      if (!this.canSendOTP()) {
        throw new Error(
          &#x27;Has alcanzado el límite de intentos por hora. Por favor intenta más tarde.&#x27;,
        );
      }

      // Format phone number (E.164 format)
      const formattedPhone &#x3D; this.formatPhoneNumber(cleanedPhone, countryCode);

      this.logger.info(&#x27;Phone formatting processed&#x27;, {
        countryCode,
      });

      // Check if formatted phone is empty or invalid
      if (!formattedPhone || formattedPhone.length &lt; 8) {
        const formatHint &#x3D; this.getPhoneFormatHint(countryCode);
        throw new Error(&#x60;Número de teléfono inválido. Formato esperado: ${formatHint}&#x60;);
      }

      // Validate phone number format
      if (!this.isValidPhoneNumber(formattedPhone, countryCode)) {
        const formatHint &#x3D; this.getPhoneFormatHint(countryCode);
        this.logger.warn(&#x27;Invalid phone format provided&#x27;, {
          countryCode,
          formatHint,
        });
        throw new Error(&#x60;Número de teléfono inválido. Formato esperado: ${formatHint}&#x60;);
      }

      // Send OTP via Supabase Auth
      const { error } &#x3D; await this.supabase.auth.signInWithOtp({
        phone: formattedPhone,
        options: {
          channel: &#x27;sms&#x27;,
        },
      });

      if (error) {
        const extendedError &#x3D; error as AuthErrorWithCode;
        const errorCode &#x3D; extendedError.code || extendedError.error_code || &#x27;&#x27;;
        const errorMessage &#x3D; extendedError.message || &#x27;&#x27;;

        // Provide more user-friendly error messages
        // Check for phone provider errors (multiple ways Supabase can return this)
        if (
          errorCode &#x3D;&#x3D;&#x3D; &#x27;phone_provider_disabled&#x27; ||
          errorCode &#x3D;&#x3D;&#x3D; &#x27;provider_disabled&#x27; ||
          errorMessage?.includes(&#x27;phone_provider_disabled&#x27;) ||
          errorMessage?.includes(&#x27;Unsupported phone provider&#x27;) ||
          errorMessage?.includes(&#x27;phone provider&#x27;) ||
          errorMessage?.includes(&#x27;SMS provider&#x27;)
        ) {
          throw new Error(
            &#x27;El servicio de SMS no está configurado para este país. Por favor contacta al soporte o intenta con otro número.&#x27;,
          );
        }

        // Handle other Supabase errors
        if (errorCode &#x3D;&#x3D;&#x3D; &#x27;phone_exists&#x27; || errorMessage?.includes(&#x27;phone_exists&#x27;)) {
          throw new Error(&#x27;Este número de teléfono ya está registrado.&#x27;);
        }

        if (
          errorCode &#x3D;&#x3D;&#x3D; &#x27;over_sms_send_rate_limit&#x27; ||
          errorMessage?.includes(&#x27;over_sms_send_rate_limit&#x27;) ||
          errorMessage?.includes(&#x27;rate limit&#x27;)
        ) {
          throw new Error(&#x27;Has excedido el límite de envíos. Por favor intenta más tarde.&#x27;);
        }

        // Handle invalid phone format errors from Supabase
        if (
          errorCode &#x3D;&#x3D;&#x3D; &#x27;validation_failed&#x27; ||
          errorMessage?.includes(&#x27;invalid phone&#x27;) ||
          errorMessage?.includes(&#x27;phone number&#x27;)
        ) {
          const formatHint &#x3D; this.getPhoneFormatHint(countryCode);
          throw new Error(
            &#x60;Número de teléfono inválido según el proveedor. Formato esperado: ${formatHint}&#x60;,
          );
        }

        // Log the full error for debugging
        this.logger.error(&#x27;Supabase authentication error&#x27;, {
          code: errorCode,
        });

        // Re-throw original error if we don&#x27;t have a specific message
        throw error;
      }

      // Update tracking (using base class method + phone-specific)
      this.recordSendTime();
      this.otpAttempts.push(Date.now());
      this.cleanupOldAttempts();

      // Call RPC function for logging
      await this.supabase.rpc(&#x27;send_phone_otp&#x27;, {
        p_phone: formattedPhone,
        p_country_code: countryCode,
      });

      // Update phone-specific status
      const currentStatus &#x3D; this.statusSignal();
      this.statusSignal.set({
        ...currentStatus,
        otpSent: true,
        value: formattedPhone,
      } as PhoneVerificationStatus);
    } catch (err) {
      const message &#x3D; err instanceof Error ? err.message : &#x27;No pudimos enviar el código SMS&#x27;;
      this.error.set(message);
      throw err;
    } finally {
      this.loading.set(false);
    }
  }

  /**
   * Send OTP code to phone number (convenience method, delegates to sendVerification)
   * @deprecated Use sendVerification instead
   */
  async sendOTP(phone: string, countryCode: string &#x3D; &#x27;+54&#x27;): Promise&lt;boolean&gt; {
    await this.sendVerification(phone, countryCode);
    return true;
  }

  /**
   * Verify OTP code
   * @param phone Phone number
   * @param token 6-digit OTP code
   */
  async verifyOTP(phone: string, token: string): Promise&lt;OTPVerificationResult&gt; {
    this.loading.set(true);
    this.error.set(null);

    try {
      // Validate token format
      if (!/^\d{6}$/.test(token)) {
        throw new Error(&#x27;El código debe tener 6 dígitos&#x27;);
      }

      // Verify OTP via Supabase Auth
      const {
        data: { user },
        error,
      } &#x3D; await this.supabase.auth.verifyOtp({
        phone,
        token,
        type: &#x27;sms&#x27;,
      });

      if (error) {
        throw error;
      }

      if (!user) {
        throw new Error(&#x27;Verificación fallida. Por favor intenta nuevamente.&#x27;);
      }

      // Call RPC function for post-verification
      await this.supabase.rpc(&#x27;verify_phone_otp&#x27;, {
        p_phone: phone,
        p_token: token,
      });

      // Update status
      await this.checkStatus();

      return {
        success: true,
        verified: true,
        message: &#x27;Teléfono verificado exitosamente&#x27;,
      };
    } catch (err) {
      const message &#x3D; err instanceof Error ? err.message : &#x27;Código inválido o expirado&#x27;;
      this.error.set(message);

      return {
        success: false,
        verified: false,
        error: message,
      };
    } finally {
      this.loading.set(false);
    }
  }

  /**
   * Format phone number to E.164 format
   */
  private formatPhoneNumber(phone: string, countryCode: string): string {
    if (!phone || typeof phone !&#x3D;&#x3D; &#x27;string&#x27;) {
      return &#x27;&#x27;;
    }

    // Remove all non-digit characters except +
    let cleaned &#x3D; phone.trim().replace(/[^\d+]/g, &#x27;&#x27;);

    // If already starts with +, validate and return
    if (cleaned.startsWith(&#x27;+&#x27;)) {
      // If it already has a country code, use it (might be different from selected)
      // But we&#x27;ll still validate it later
      return cleaned;
    }

    // If empty after cleaning, return empty
    if (!cleaned || cleaned.length &#x3D;&#x3D;&#x3D; 0) {
      return &#x27;&#x27;;
    }

    // Remove leading zeros
    cleaned &#x3D; cleaned.replace(/^0+/, &#x27;&#x27;);

    // If empty after removing zeros, return empty
    if (!cleaned || cleaned.length &#x3D;&#x3D;&#x3D; 0) {
      return &#x27;&#x27;;
    }

    // Add country code
    return &#x60;${countryCode}${cleaned}&#x60;;
  }

  /**
   * Get phone format hint for a country code
   */
  private getPhoneFormatHint(countryCode: string): string {
    const hints: Record&lt;string, string&gt; &#x3D; {
      &#x27;+54&#x27;: &#x27;+54 seguido de 10 dígitos (ej: +5491123456789)&#x27;,
      &#x27;+1&#x27;: &#x27;+1 seguido de 10 dígitos (ej: +15551234567)&#x27;,
      &#x27;+52&#x27;: &#x27;+52 seguido de 10 dígitos (ej: +525512345678)&#x27;,
      &#x27;+55&#x27;: &#x27;+55 seguido de 10-11 dígitos (ej: +5511987654321)&#x27;,
      &#x27;+56&#x27;: &#x27;+56 seguido de 9 dígitos (ej: +56912345678)&#x27;,
    };
    return hints[countryCode] || &#x27;formato E.164 internacional&#x27;;
  }

  /**
   * Validate phone number format (E.164)
   * Supports multiple countries with different digit lengths
   */
  private isValidPhoneNumber(phone: string, countryCode?: string): boolean {
    // E.164 format: +[country code][number]
    // Must start with + and have at least 7 digits after country code
    if (!phone.startsWith(&#x27;+&#x27;)) {
      return false;
    }

    // Remove the + and validate
    const withoutPlus &#x3D; phone.substring(1);

    // Must contain only digits after the +
    if (!/^\d+$/.test(withoutPlus)) {
      return false;
    }

    // Country-specific validation
    if (phone.startsWith(&#x27;+54&#x27;)) {
      // Argentina: +54 followed by 10 digits (total 12 digits after +)
      return /^\+54\d{10}$/.test(phone);
    } else if (phone.startsWith(&#x27;+1&#x27;)) {
      // USA/Canada: +1 followed by 10 digits (total 11 digits after +)
      return /^\+1\d{10}$/.test(phone);
    } else if (phone.startsWith(&#x27;+52&#x27;)) {
      // Mexico: +52 followed by 10 digits (total 12 digits after +)
      return /^\+52\d{10}$/.test(phone);
    } else if (phone.startsWith(&#x27;+55&#x27;)) {
      // Brazil: +55 followed by 10-11 digits (total 12-13 after +)
      return /^\+55\d{10,11}$/.test(phone);
    } else if (phone.startsWith(&#x27;+56&#x27;)) {
      // Chile: +56 followed by 9 digits (total 11 digits after +)
      return /^\+56\d{9}$/.test(phone);
    }

    // If country code is provided but doesn&#x27;t match, validate against it
    if (countryCode &amp;&amp; !phone.startsWith(countryCode)) {
      return false;
    }

    // Generic validation: at least 7 digits after country code, max 15 total
    // E.164 allows 1-15 digits total (including country code)
    const totalDigits &#x3D; withoutPlus.length;
    return totalDigits &gt;&#x3D; 8 &amp;&amp; totalDigits &lt;&#x3D; 15;
  }

  /**
   * Check if user can send OTP (rate limiting)
   */
  private canSendOTP(): boolean {
    this.cleanupOldAttempts();
    return this.otpAttempts.length &lt; this.MAX_ATTEMPTS_PER_HOUR;
  }

  /**
   * Remove attempts older than 1 hour
   */
  private cleanupOldAttempts(): void {
    const oneHourAgo &#x3D; Date.now() - 60 * 60 * 1000;
    this.otpAttempts &#x3D; this.otpAttempts.filter((timestamp) &#x3D;&gt; timestamp &gt; oneHourAgo);
  }

  /**
   * Override startCooldownTimer to include phone-specific rate limiting
   */
  override startCooldownTimer(callback: (seconds: number) &#x3D;&gt; void): () &#x3D;&gt; void {
    const interval &#x3D; setInterval(() &#x3D;&gt; {
      const remaining &#x3D; this.calculateCooldownRemaining();
      const currentStatus &#x3D; this.statusSignal();

      callback(remaining);

      if (remaining &#x3D;&#x3D;&#x3D; 0 &amp;&amp; !currentStatus.isVerified) {
        // Phone-specific: check rate limiting before allowing resend
        this.statusSignal.set({
          ...currentStatus,
          canResend: this.canSendOTP(),
          cooldownSeconds: 0,
        } as PhoneVerificationStatus);
        clearInterval(interval);
      } else {
        this.statusSignal.set({
          ...currentStatus,
          cooldownSeconds: remaining,
        } as PhoneVerificationStatus);
      }
    }, 1000);

    return () &#x3D;&gt; clearInterval(interval);
  }

  /**
   * Subscribe to phone verification changes (convenience method, delegates to base)
   * @deprecated Use subscribeToChanges instead
   */
  subscribeToPhoneChanges(callback: (verified: boolean) &#x3D;&gt; void): () &#x3D;&gt; void {
    return this.subscribeToChanges(callback);
  }

  /**
   * Convenience method for backward compatibility
   * @deprecated Use checkStatus instead
   */
  async checkPhoneStatus(): Promise&lt;PhoneVerificationStatus&gt; {
    return this.checkStatus();
  }

  /**
   * Get number of remaining OTP attempts
   */
  getRemainingAttempts(): number {
    this.cleanupOldAttempts();
    return Math.max(0, this.MAX_ATTEMPTS_PER_HOUR - this.otpAttempts.length);
  }

  /**
   * Clear error state
   */
  clearError(): void {
    this.error.set(null);
  }

  /**
   * Reset OTP sent state (for UI)
   */
  resetOTPSentState(): void {
    const currentStatus &#x3D; this.status();
    this.statusSignal.set({
      ...currentStatus,
      otpSent: false,
    } as PhoneVerificationStatus);
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'OTPVerificationResult.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
