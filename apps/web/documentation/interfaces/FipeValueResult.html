<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>autorenta-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">autorenta-web documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">

















<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  FipeValueResult</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/services/pricing.service.ts</code>
        </p>




        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#availableOptions" 
>
                                            availableOptions
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#data" 
>
                                            data
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#error" 
>
                                            error
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#errorCode" 
>
                                            errorCode
                                        </a>
                                </li>
                                <li>
                                        <a href="#success" 
>
                                            success
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#suggestions" 
>
                                            suggestions
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#timestamp" 
>
                                            timestamp
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="availableOptions"></a>
                                        <span class="name "><b>availableOptions</b>
                                            <a href="#availableOptions">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>availableOptions:     <code>literal type</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>literal type</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="data"></a>
                                        <span class="name "><b>data</b>
                                            <a href="#data">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>data:     <code>literal type</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>literal type</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="error"></a>
                                        <span class="name "><b>error</b>
                                            <a href="#error">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>error:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="errorCode"></a>
                                        <span class="name "><b>errorCode</b>
                                            <a href="#errorCode">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>errorCode:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="success"></a>
                                        <span class="name "><b>success</b>
                                            <a href="#success">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>success:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="suggestions"></a>
                                        <span class="name "><b>suggestions</b>
                                            <a href="#suggestions">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>suggestions:     <code>string[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string[]</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="timestamp"></a>
                                        <span class="name "><b>timestamp</b>
                                            <a href="#timestamp">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>timestamp:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, inject } from &#x27;@angular/core&#x27;;
import { environment } from &#x27;../../../environments/environment&#x27;;
import type { VehicleCategory } from &#x27;../models&#x27;;
import { injectSupabase } from &#x27;./supabase-client.service&#x27;;
import { DistanceCalculatorService } from &#x27;./distance-calculator.service&#x27;;

export interface QuoteBreakdown {
  price_subtotal: number;
  discount: number;
  service_fee: number;
  total: number;
  // Distance-based pricing fields
  delivery_fee?: number;
  delivery_distance_km?: number;
  distance_risk_tier?: &#x27;local&#x27; | &#x27;regional&#x27; | &#x27;long_distance&#x27;;
  // ✅ NEW: Dynamic pricing flags (Sprint 2)
  pricing_strategy?: &#x27;dynamic&#x27; | &#x27;custom&#x27;;
  dynamic_pricing_applied?: boolean;
}

export interface LocationCoords {
  lat: number;
  lng: number;
}

// ✅ VehicleCategory imported from ../models (uses base_daily_rate_pct)

export interface VehicleValueEstimation {
  estimated_value_usd: number;
  confidence: &#x27;high&#x27; | &#x27;medium&#x27; | &#x27;low&#x27; | &#x27;none&#x27;;
  source: &#x27;pricing_model&#x27; | &#x27;category_fallback&#x27;;
  category_id?: string;
  category_name?: string;
  suggested_daily_rate_usd?: number;
}

export interface FipeValueResult {
  success: boolean;
  data?: {
    value_brl: number;
    value_usd: number;
    value_ars: number;
    fipe_code: string;
    source: string;
    confidence: string;
    reference_month: string;
    brand_found: string;
    model_found: string;
  };
  error?: string;
  errorCode?: string; // ✅ NEW: Machine-readable error code
  suggestions?: string[]; // ✅ NEW: Actionable suggestions
  availableOptions?: {
    brands?: string[];
    models?: string[];
    years?: number[];
  };
  timestamp?: string;
}

export interface FipeBrand {
  code: string;
  name: string;
}

export interface FipeModel {
  code: string;
  name: string;
}

export interface FipeBaseModel {
  baseName: string;
  variants: FipeModel[];
}

@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class PricingService {
  private readonly supabase &#x3D; injectSupabase();
  private readonly distanceCalculator &#x3D; inject(DistanceCalculatorService);

  async quoteBooking(params: {
    carId: string;
    start: string;
    end: string;
    promoCode?: string;
    userLocation?: LocationCoords;
  }): Promise&lt;QuoteBreakdown&gt; {
    // Get base quote from RPC
    const { data, error } &#x3D; await this.supabase.rpc(&#x27;quote_booking&#x27;, {
      p_car_id: params.carId,
      p_start: params.start,
      p_end: params.end,
      p_promo: params.promoCode ?? null,
    });
    if (error) throw error;
    if (!data || data.length &#x3D;&#x3D;&#x3D; 0) {
      throw new Error(&#x27;No se pudo calcular la cotización&#x27;);
    }

    const baseQuote &#x3D; data[0] as QuoteBreakdown;

    // If user location provided, calculate delivery fee
    if (params.userLocation) {
      const distanceData &#x3D; await this.calculateDeliveryFee(params.carId, params.userLocation);

      if (distanceData) {
        baseQuote.delivery_fee &#x3D; distanceData.deliveryFeeCents / 100; // Convert to ARS
        baseQuote.delivery_distance_km &#x3D; distanceData.distanceKm;
        baseQuote.distance_risk_tier &#x3D; distanceData.tier;
        baseQuote.total +&#x3D; baseQuote.delivery_fee;
      }
    }

    return baseQuote;
  }

  /**
   * Calculate delivery fee based on distance between user and car
   * @param carId Car ID
   * @param userLocation User location coordinates
   * @returns Delivery fee data or null if car location not available
   */
  async calculateDeliveryFee(
    carId: string,
    userLocation: LocationCoords,
  ): Promise&lt;{
    distanceKm: number;
    deliveryFeeCents: number;
    tier: &#x27;local&#x27; | &#x27;regional&#x27; | &#x27;long_distance&#x27;;
  } | null&gt; {
    // Get car location
    const { data: car, error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .select(&#x27;location_lat, location_lng&#x27;)
      .eq(&#x27;id&#x27;, carId)
      .single();

    if (error || !car || !car.location_lat || !car.location_lng) {
      return null;
    }

    // Calculate distance
    const distanceKm &#x3D; this.distanceCalculator.calculateDistance(
      userLocation.lat,
      userLocation.lng,
      car.location_lat,
      car.location_lng,
    );

    // Calculate delivery fee
    const deliveryFeeCents &#x3D; this.distanceCalculator.calculateDeliveryFee(distanceKm);

    // Get tier
    const tier &#x3D; this.distanceCalculator.getDistanceTier(distanceKm);

    return {
      distanceKm,
      deliveryFeeCents,
      tier,
    };
  }

  async cancelWithFee(bookingId: string): Promise&lt;number&gt; {
    const { data, error } &#x3D; await this.supabase.rpc(&#x27;cancel_with_fee&#x27;, {
      p_booking_id: bookingId,
    });
    if (error) throw error;
    if (!data || data.length &#x3D;&#x3D;&#x3D; 0) {
      throw new Error(&#x27;No se pudo cancelar la reserva&#x27;);
    }
    return Number(data[0].cancel_fee ?? 0);
  }

  /**
   * Get all vehicle categories from database
   */
  async getVehicleCategories(): Promise&lt;VehicleCategory[]&gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;vehicle_categories&#x27;)
      .select(
        &#x27;id, code, name, name_es, base_daily_rate_pct, depreciation_rate_annual, surge_sensitivity, description, display_order, active&#x27;,
      )
      .eq(&#x27;active&#x27;, true)
      .order(&#x27;display_order&#x27;);

    if (error) {
      console.error(&#x27;[PricingService] Error fetching vehicle categories:&#x27;, error);
      return [];
    }
    return data || [];
  }

  /**
   * Estimate vehicle value using SQL function
   * Calls estimate_vehicle_value_usd(brand, model, year, country)
   */
  async estimateVehicleValue(params: {
    brand: string;
    model: string;
    year: number;
    country?: string;
  }): Promise&lt;VehicleValueEstimation | null&gt; {
    // Call estimate function (note: p_country not used by SQL function)
    const { data, error } &#x3D; await this.supabase.rpc(&#x27;estimate_vehicle_value_usd&#x27;, {
      p_brand: params.brand,
      p_model: params.model,
      p_year: params.year,
    });

    if (error) {
      return null;
    }

    if (!data || data.length &#x3D;&#x3D;&#x3D; 0) {
      return null;
    }

    const result &#x3D; data[0];

    // Map SQL column names to frontend interface
    // SQL returns: estimated_value, confidence_level, data_source, category_id
    const estimatedValue &#x3D; result.estimated_value || 0;

    // Calculate suggested daily rate (0.3% of vehicle value per day)
    const suggestedRate &#x3D; estimatedValue &gt; 0 ? estimatedValue * 0.003 : undefined;

    // Fetch category name if category_id exists
    let categoryName: string | undefined;
    if (result.category_id) {
      const { data: category } &#x3D; await this.supabase
        .from(&#x27;vehicle_categories&#x27;)
        .select(&#x27;name_es&#x27;)
        .eq(&#x27;id&#x27;, result.category_id)
        .single();
      categoryName &#x3D; category?.name_es;
    }

    return {
      estimated_value_usd: estimatedValue,
      confidence: result.confidence_level,
      source: result.data_source,
      category_id: result.category_id,
      category_name: categoryName,
      suggested_daily_rate_usd: suggestedRate,
    };
  }

  /**
   * Get vehicle value in realtime via Edge Function
   * Calls get-fipe-value Edge Function for fresh market data
   *
   * Note: This method requires exact brand/model names from vehicle database
   * Use brand_text_backup and model_text_backup from database which store exact names
   */
  async getFipeValueRealtime(params: {
    brand: string;
    model: string;
    year: number;
    country?: string;
  }): Promise&lt;FipeValueResult | null&gt; {
    try {
      const url &#x3D; &#x60;${environment.supabaseUrl}/functions/v1/get-fipe-value&#x60;;

      const response &#x3D; await fetch(url, {
        method: &#x27;POST&#x27;,
        headers: {
          Authorization: &#x60;Bearer ${environment.supabaseAnonKey}&#x60;,
          &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,
        },
        body: JSON.stringify({
          brand: params.brand,
          model: params.model,
          year: params.year,
          country: params.country || &#x27;AR&#x27;,
        }),
      });

      if (!response.ok) {
        return null;
      }

      const result: FipeValueResult &#x3D; await response.json();
      return result;
    } catch {
      return null;
    }
  }

  /**
   * Calculate suggested daily rate for a category
   * Uses base_rate_multiplier from category
   */
  async calculateSuggestedRate(params: {
    categoryId: string;
    estimatedValueUsd?: number;
  }): Promise&lt;number | null&gt; {
    const { data } &#x3D; await this.supabase
      .from(&#x27;vehicle_categories&#x27;)
      .select(&#x27;base_daily_rate_pct, code&#x27;)
      .eq(&#x27;id&#x27;, params.categoryId)
      .single();

    if (!data) {
      return null;
    }

    // If we have estimated value, use it with the category&#x27;s rate percentage
    if (params.estimatedValueUsd) {
      // Use the category&#x27;s base_daily_rate_pct (e.g., 0.0030 &#x3D; 0.30%)
      const ratePct &#x3D; data.base_daily_rate_pct || 0.003; // Fallback to 0.3% if null
      return params.estimatedValueUsd * ratePct;
    }

    // Otherwise use category default with average values
    // Assume average vehicle value by category:
    // Economy: $8k, Standard: $15k, Premium: $35k, Luxury: $80k
    const averageValues: Record&lt;string, number&gt; &#x3D; {
      economy: 8000,
      standard: 15000,
      premium: 35000,
      luxury: 80000,
    };

    const categoryCode &#x3D; data.code?.toLowerCase() || &#x27;&#x27;;
    const categoryName &#x3D; Object.keys(averageValues).find((name) &#x3D;&gt; categoryCode.includes(name));
    const avgValue &#x3D; categoryName ? averageValues[categoryName] : 15000;

    // Use the category&#x27;s base_daily_rate_pct
    const ratePct &#x3D; data.base_daily_rate_pct || 0.003; // Fallback to 0.3% if null
    return avgValue * ratePct;
  }

  /**
   * Get all vehicle brands from FIPE API
   * Calls public FIPE API directly (no auth required)
   */
  async getFipeBrands(): Promise&lt;FipeBrand[]&gt; {
    try {
      const response &#x3D; await fetch(&#x27;https://parallelum.com.br/fipe/api/v2/cars/brands&#x27;);

      if (!response.ok) {
        return [];
      }

      const brands: FipeBrand[] &#x3D; await response.json();
      return brands;
    } catch {
      return [];
    }
  }

  /**
   * Get all vehicle models for a specific brand from FIPE API
   * @param brandCode FIPE brand code (e.g., &quot;59&quot; for VW)
   */
  async getFipeModels(brandCode: string): Promise&lt;FipeModel[]&gt; {
    try {
      const response &#x3D; await fetch(
        &#x60;https://parallelum.com.br/fipe/api/v2/cars/brands/${brandCode}/models&#x60;,
      );

      if (!response.ok) {
        return [];
      }

      const models: FipeModel[] &#x3D; await response.json();
      return models;
    } catch {
      return [];
    }
  }

  /**
   * Extract base model name from full model name
   * e.g., &quot;Gol 1.0 Flex 12V 5p&quot; -&gt; &quot;Gol&quot;
   * e.g., &quot;Corolla XEi 2.0&quot; -&gt; &quot;Corolla&quot;
   */
  extractBaseModelName(fullModelName: string): string {
    // Remove engine specs (numbers with dots)
    let baseName &#x3D; fullModelName.replace(/\s+\d+\.\d+.*$/i, &#x27;&#x27;);

    // Remove version info in parentheses
    baseName &#x3D; baseName.replace(/\s*\(.*?\)\s*/g, &#x27; &#x27;);

    // Remove common version suffixes
    baseName &#x3D; baseName.replace(/\s+(Flex|Turbo|TDI|TSI|GTI|Sport|Plus|Life|Comfort).*$/i, &#x27;&#x27;);

    // Clean up extra spaces
    baseName &#x3D; baseName.trim().replace(/\s+/g, &#x27; &#x27;);

    return baseName;
  }

  /**
   * Group models by base name
   * Returns grouped models with first variant as representative
   */
  groupModelsByBaseName(models: FipeModel[]): FipeBaseModel[] {
    const grouped &#x3D; new Map&lt;string, FipeModel[]&gt;();

    for (const model of models) {
      const baseName &#x3D; this.extractBaseModelName(model.name);

      if (!grouped.has(baseName)) {
        grouped.set(baseName, []);
      }

      grouped.get(baseName)!.push(model);
    }

    // Convert to array and return
    return Array.from(grouped.entries()).map(([baseName, variants]) &#x3D;&gt; ({
      baseName,
      variants,
    }));
  }

  /**
   * Get FIPE models grouped by base name
   * Returns simplified list with one entry per model type
   */
  async getFipeBaseModels(brandCode: string): Promise&lt;FipeBaseModel[]&gt; {
    const allModels &#x3D; await this.getFipeModels(brandCode);
    return this.groupModelsByBaseName(allModels);
  }

  /**
   * Search FIPE value using base model name + year
   * Automatically finds best matching variant for the year
   */
  async getFipeValueByBaseModel(params: {
    brand: string;
    baseModel: string;
    year: number;
    brandCode: string;
    country?: string;
  }): Promise&lt;FipeValueResult | null&gt; {
    try {
      // Get all variants for this base model
      const allModels &#x3D; await this.getFipeModels(params.brandCode);
      const baseName &#x3D; params.baseModel;

      // Find variants matching base name
      const matchingVariants &#x3D; allModels.filter((model) &#x3D;&gt; {
        const modelBaseName &#x3D; this.extractBaseModelName(model.name);
        return modelBaseName.toLowerCase() &#x3D;&#x3D;&#x3D; baseName.toLowerCase();
      });

      if (matchingVariants.length &#x3D;&#x3D;&#x3D; 0) {
        return {
          success: false,
          error: &#x60;No se encontraron variantes para el modelo ${baseName}&#x60;,
        };
      }

      // Try each variant until we find one with data for this year
      for (const variant of matchingVariants) {
        const result &#x3D; await this.getFipeValueRealtime({
          brand: params.brand,
          model: variant.name,
          year: params.year,
          country: params.country || &#x27;AR&#x27;,
        });

        if (result &amp;&amp; result.success) {
          return result;
        }
      }

      // No variant had data for this year
      return {
        success: false,
        error: &#x60;No se encontró información de precio para ${baseName} ${params.year}&#x60;,
      };
    } catch {
      return null;
    }
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'FipeValueResult.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
