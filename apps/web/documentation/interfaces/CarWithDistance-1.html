<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>autorenta-web documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">autorenta-web documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">

















<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  CarWithDistance</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/core/services/cars.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>Car with distance from get_cars_within_radius RPC</p>

            </p>


        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#avg_rating" 
>
                                            avg_rating
                                        </a>
                                </li>
                                <li>
                                        <a href="#brand_text_backup" 
>
                                            brand_text_backup
                                        </a>
                                </li>
                                <li>
                                        <a href="#currency" 
>
                                            currency
                                        </a>
                                </li>
                                <li>
                                        <a href="#distance_km" 
>
                                            distance_km
                                        </a>
                                </li>
                                <li>
                                        <a href="#id" 
>
                                            id
                                        </a>
                                </li>
                                <li>
                                        <a href="#location_city" 
>
                                            location_city
                                        </a>
                                </li>
                                <li>
                                        <a href="#location_formatted_address" 
>
                                            location_formatted_address
                                        </a>
                                </li>
                                <li>
                                        <a href="#location_lat" 
>
                                            location_lat
                                        </a>
                                </li>
                                <li>
                                        <a href="#location_lng" 
>
                                            location_lng
                                        </a>
                                </li>
                                <li>
                                        <a href="#location_state" 
>
                                            location_state
                                        </a>
                                </li>
                                <li>
                                        <a href="#model_text_backup" 
>
                                            model_text_backup
                                        </a>
                                </li>
                                <li>
                                        <a href="#owner_id" 
>
                                            owner_id
                                        </a>
                                </li>
                                <li>
                                        <a href="#photos_count" 
>
                                            photos_count
                                        </a>
                                </li>
                                <li>
                                        <a href="#price_per_day" 
>
                                            price_per_day
                                        </a>
                                </li>
                                <li>
                                        <a href="#status" 
>
                                            status
                                        </a>
                                </li>
                                <li>
                                        <a href="#title" 
>
                                            title
                                        </a>
                                </li>
                                <li>
                                        <a href="#value_usd" 
>
                                            value_usd
                                        </a>
                                </li>
                                <li>
                                        <a href="#year" 
>
                                            year
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="avg_rating"></a>
                                        <span class="name "><b>avg_rating</b>
                                            <a href="#avg_rating">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>avg_rating:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="brand_text_backup"></a>
                                        <span class="name "><b>brand_text_backup</b>
                                            <a href="#brand_text_backup">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>brand_text_backup:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="currency"></a>
                                        <span class="name "><b>currency</b>
                                            <a href="#currency">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>currency:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="distance_km"></a>
                                        <span class="name "><b>distance_km</b>
                                            <a href="#distance_km">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>distance_km:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="id"></a>
                                        <span class="name "><b>id</b>
                                            <a href="#id">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="location_city"></a>
                                        <span class="name "><b>location_city</b>
                                            <a href="#location_city">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>location_city:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="location_formatted_address"></a>
                                        <span class="name "><b>location_formatted_address</b>
                                            <a href="#location_formatted_address">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>location_formatted_address:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="location_lat"></a>
                                        <span class="name "><b>location_lat</b>
                                            <a href="#location_lat">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>location_lat:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="location_lng"></a>
                                        <span class="name "><b>location_lng</b>
                                            <a href="#location_lng">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>location_lng:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="location_state"></a>
                                        <span class="name "><b>location_state</b>
                                            <a href="#location_state">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>location_state:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="model_text_backup"></a>
                                        <span class="name "><b>model_text_backup</b>
                                            <a href="#model_text_backup">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>model_text_backup:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="owner_id"></a>
                                        <span class="name "><b>owner_id</b>
                                            <a href="#owner_id">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>owner_id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="photos_count"></a>
                                        <span class="name "><b>photos_count</b>
                                            <a href="#photos_count">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>photos_count:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="price_per_day"></a>
                                        <span class="name "><b>price_per_day</b>
                                            <a href="#price_per_day">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>price_per_day:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="status"></a>
                                        <span class="name "><b>status</b>
                                            <a href="#status">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>status:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="title"></a>
                                        <span class="name "><b>title</b>
                                            <a href="#title">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>title:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="value_usd"></a>
                                        <span class="name "><b>value_usd</b>
                                            <a href="#value_usd">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>value_usd:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="year"></a>
                                        <span class="name "><b>year</b>
                                            <a href="#year">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>year:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, inject } from &#x27;@angular/core&#x27;;
import { v4 as uuidv4 } from &#x27;uuid&#x27;;
import { Car, CarFilters, CarPhoto } from &#x27;../models&#x27;;
import { optimizeImage } from &#x27;../utils/image.utils&#x27;;
import { CarAvailabilityService } from &#x27;./car-availability.service&#x27;;
import { injectSupabase } from &#x27;./supabase-client.service&#x27;;

// Type for raw car data from Supabase with photos joined
type CarWithPhotosRaw &#x3D; Record&lt;string, unknown&gt; &amp; {
  car_photos?: unknown[];
  owner?: unknown | unknown[];
};

@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class CarsService {
  private readonly supabase &#x3D; injectSupabase();
  private readonly carAvailabilityService &#x3D; inject(CarAvailabilityService);
  private readonly defaultValuationConfig &#x3D; {
    averageRentalDays: 300,
  };

  async createCar(input: Partial&lt;Car&gt;): Promise&lt;Car&gt; {
    const userId &#x3D; (await this.supabase.auth.getUser()).data.user?.id;
    if (!userId) {
      throw new Error(&#x27;Usuario no autenticado&#x27;);
    }

    // Validate required fields
    // ‚úÖ CRITICAL: brand_id/model_id son UUIDs (pueden ser null si usamos FIPE)
    // Si no hay UUIDs, debemos tener brand_text_backup y model_text_backup
    const hasBrandId &#x3D; !!input.brand_id;
    const hasModelId &#x3D; !!input.model_id;
    const hasBrandText &#x3D; !!input.brand_text_backup;
    const hasModelText &#x3D; !!input.model_text_backup;

    if (!hasBrandId &amp;&amp; !hasBrandText) {
      throw new Error(&#x27;Marca es requerida (brand_id o brand_text_backup)&#x27;);
    }
    if (!hasModelId &amp;&amp; !hasModelText) {
      throw new Error(&#x27;Modelo es requerido (model_id o model_text_backup)&#x27;);
    }
    if (!input.price_per_day || input.price_per_day &lt;&#x3D; 0) {
      throw new Error(&#x27;Precio por d√≠a debe ser mayor a 0&#x27;);
    }

    // Check for coordinates (using type assertion since location_lat/location_lng come from form)
    const carInput &#x3D; input as Record&lt;string, unknown&gt;;

    // ‚úÖ CRITICAL: Las coordenadas son OBLIGATORIAS para que el auto aparezca en b√∫squedas
    // Si no hay coordenadas, el auto ser√° invisible en el mapa y en b√∫squedas espaciales
    if (!carInput.location_lat || !carInput.location_lng) {
      throw new Error(
        &#x27;Ubicaci√≥n del veh√≠culo requerida. Por favor selecciona una ubicaci√≥n en el mapa o usa tu ubicaci√≥n actual.&#x27;,
      );
    }

    const cleanInput &#x3D; { ...input };

    // ‚úÖ CRITICAL: Mapear campos de ubicaci√≥n legacy (city, province, country)
    // La base de datos requiere city/province/country (NOT NULL)
    // pero el formulario env√≠a location_city/location_state/location_country
    const city &#x3D;
      (input as Record&lt;string, unknown&gt;).city ||
      (input as Record&lt;string, unknown&gt;).location_city ||
      &#x27;&#x27;;
    const province &#x3D;
      (input as Record&lt;string, unknown&gt;).province ||
      (input as Record&lt;string, unknown&gt;).location_state ||
      (input as Record&lt;string, unknown&gt;).location_province ||
      &#x27;&#x27;;
    const country &#x3D;
      (input as Record&lt;string, unknown&gt;).country ||
      (input as Record&lt;string, unknown&gt;).location_country ||
      &#x27;AR&#x27;;

    // Prepare clean data for insert
    const carData &#x3D; {
      ...cleanInput,
      // ‚úÖ Mapear campos legacy requeridos por la base de datos
      city: city || &#x27;Buenos Aires&#x27;, // Default si est√° vac√≠o
      province: province || &#x27;Buenos Aires&#x27;, // Default si est√° vac√≠o
      country: country || &#x27;AR&#x27;,
      owner_id: userId,
      status: input.status || &#x27;active&#x27;, // Default to active if not specified
      created_at: new Date().toISOString(),
    };

    console.log(&#x27;üöó Creating car with data:&#x27;, {
      ...carData,
      // Redact sensitive fields for logging
      owner_id: &#x27;***&#x27;,
    });

    const { data, error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .insert(carData)
      .select(&#x27;*, car_photos(*)&#x27;)
      .single();

    if (error) {
      console.error(&#x27;‚ùå Error creating car:&#x27;, error);
      throw error;
    }

    console.log(&#x27;‚úÖ Car created successfully:&#x27;, data.id);

    return {
      ...data,
      photos: data.car_photos || [],
    } as Car;
  }

  async uploadPhoto(file: File, carId: string, position &#x3D; 0): Promise&lt;CarPhoto&gt; {
    const userId &#x3D; (await this.supabase.auth.getUser()).data.user?.id;
    if (!userId) throw new Error(&#x27;Usuario no autenticado&#x27;);

    const optimizedFile &#x3D; await optimizeImage(file, {
      maxWidth: 1200,
      maxHeight: 900,
      quality: 0.85,
      format: &#x27;webp&#x27;,
    });

    const extension &#x3D; &#x27;webp&#x27;;
    const filePath &#x3D; &#x60;${userId}/${carId}/${uuidv4()}.${extension}&#x60;;
    const { error } &#x3D; await this.supabase.storage
      .from(&#x27;car-images&#x27;)
      .upload(filePath, optimizedFile, {
        cacheControl: &#x27;3600&#x27;,
        upsert: false,
      });
    if (error) throw error;
    const { data } &#x3D; this.supabase.storage.from(&#x27;car-images&#x27;).getPublicUrl(filePath);

    const photoId &#x3D; uuidv4();
    const { data: photoData, error: photoError } &#x3D; await this.supabase
      .from(&#x27;car_photos&#x27;)
      .insert({
        id: photoId,
        car_id: carId,
        stored_path: filePath,
        url: data.publicUrl,
        position,
        sort_order: position,
      })
      .select()
      .single();

    if (photoError) throw photoError;
    return photoData as CarPhoto;
  }

  async getCarPhotos(carId: string): Promise&lt;CarPhoto[]&gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;car_photos&#x27;)
      .select(&#x27;*&#x27;)
      .eq(&#x27;car_id&#x27;, carId)
      .order(&#x27;sort_order&#x27;, { ascending: true })
      .order(&#x27;position&#x27;, { ascending: true });

    if (error) throw error;
    return (data ?? []) as CarPhoto[];
  }

  suggestVehicleValueUsd(
    pricePerDay: number | null | undefined,
    options?: { averageRentalDays?: number },
  ): number {
    if (!pricePerDay || pricePerDay &lt;&#x3D; 0) {
      return 0;
    }

    const days &#x3D; options?.averageRentalDays ?? this.defaultValuationConfig.averageRentalDays;
    return Math.round(pricePerDay * days);
  }

  getDefaultAverageRentalDays(): number {
    return this.defaultValuationConfig.averageRentalDays;
  }

  async listActiveCars(filters: CarFilters): Promise&lt;Car[]&gt; {
    let query &#x3D; this.supabase
      .from(&#x27;cars&#x27;)
      .select(
        &#x60;
        *,
        car_photos(*),
        owner:profiles!cars_owner_id_fkey(
          id,
          full_name,
          avatar_url,
          rating_avg,
          rating_count,
          created_at
        )
      &#x60;,
      )
      .eq(&#x27;status&#x27;, &#x27;active&#x27;)
      .order(&#x27;created_at&#x27;, { ascending: false });

    if (filters.city) {
      query &#x3D; query.ilike(&#x27;location_city&#x27;, &#x60;%${filters.city}%&#x60;);
    }

    // ‚úÖ FIX P0.3: Filtrar por coordenadas (bounding box)
    if (filters.bounds) {
      query &#x3D; query
        .lte(&#x27;location_lat&#x27;, filters.bounds.north)
        .gte(&#x27;location_lat&#x27;, filters.bounds.south)
        .lte(&#x27;location_lng&#x27;, filters.bounds.east)
        .gte(&#x27;location_lng&#x27;, filters.bounds.west);
    }

    const { data, error } &#x3D; await query;
    if (error) throw error;

    // Data loaded successfully

    // ‚úÖ FIX P0.2: Filtrar por disponibilidad si hay fechas
    if (filters.from &amp;&amp; filters.to &amp;&amp; data) {
      const availableCars &#x3D; await this.carAvailabilityService.filterByAvailability(
        data as Car[],
        filters.from,
        filters.to,
        filters.blockedCarIds || [],
      );
      return (availableCars as unknown[]).map((car) &#x3D;&gt; {
        const typedCar &#x3D; car as CarWithPhotosRaw;
        return {
          ...typedCar,
          photos: typedCar.car_photos || [],
          owner: Array.isArray(typedCar.owner) ? typedCar.owner[0] : typedCar.owner,
        };
      }) as Car[];
    }

    return (data ?? []).map((car: CarWithPhotosRaw) &#x3D;&gt; ({
      ...car,
      photos: car.car_photos || [],
      owner: Array.isArray(car.owner) ? car.owner[0] : car.owner,
    })) as Car[];
  }

  async getCarById(id: string): Promise&lt;Car | null&gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .select(
        &#x60;
        *,
        car_photos(*),
        owner:profiles!cars_owner_id_fkey(
          id,
          full_name,
          avatar_url,
          rating_avg,
          rating_count,
          created_at
        )
      &#x60;,
      )
      .eq(&#x27;id&#x27;, id)
      .single();
    if (error) {
      if (error.code &#x3D;&#x3D;&#x3D; &#x27;PGRST116&#x27;) return null;
      throw error;
    }

    return {
      ...data,
      photos: data.car_photos || [],
    } as Car;
  }

  async listMyCars(): Promise&lt;Car[]&gt; {
    const userId &#x3D; (await this.supabase.auth.getUser()).data.user?.id;
    if (!userId) throw new Error(&#x27;Usuario no autenticado&#x27;);

    // 1. Get my orgs IDs (to include fleet cars)
    const { data: orgs } &#x3D; await this.supabase
      .from(&#x27;organization_members&#x27;)
      .select(&#x27;organization_id&#x27;)
      .eq(&#x27;user_id&#x27;, userId);

    const orgIds &#x3D; orgs?.map((o) &#x3D;&gt; o.organization_id) || [];

    // 2. Build query
    let query &#x3D; this.supabase
      .from(&#x27;cars&#x27;)
      .select(&#x27;*, car_photos(*)&#x27;)
      .order(&#x27;created_at&#x27;, { ascending: false });

    if (orgIds.length &gt; 0) {
      // Fetch cars where:
      // A) I am the owner (owner_id &#x3D; me)
      // B) OR the car belongs to an organization I am a member of
      query &#x3D; query.or(&#x60;owner_id.eq.${userId},organization_id.in.(${orgIds.join(&#x27;,&#x27;)})&#x60;);
    } else {
      // Fallback for individuals with no orgs
      query &#x3D; query.eq(&#x27;owner_id&#x27;, userId);
    }

    const { data, error } &#x3D; await query;
    if (error) throw error;

    return (data ?? []).map((car: CarWithPhotosRaw) &#x3D;&gt; ({
      ...car,
      photos: car.car_photos || [],
    })) as Car[];
  }

  /**
   * Alias for listMyCars for backward compatibility
   */
  async getMyCars(): Promise&lt;Car[]&gt; {
    return this.listMyCars();
  }

  /**
   * @deprecated Use CarAvailabilityService.getBlockedDateRanges instead
   */
  async getBlockedDateRanges(carId: string): Promise&lt;Array&lt;{ from: string; to: string }&gt;&gt; {
    const ranges &#x3D; await this.carAvailabilityService.getBlockedDates(carId);
    return ranges.map((r) &#x3D;&gt; ({ from: r.from, to: r.to }));
  }

  async deleteCar(carId: string): Promise&lt;void&gt; {
    const userId &#x3D; (await this.supabase.auth.getUser()).data.user?.id;
    if (!userId) throw new Error(&#x27;Usuario no autenticado&#x27;);
    const { error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .delete()
      .eq(&#x27;id&#x27;, carId)
      .eq(&#x27;owner_id&#x27;, userId);
    if (error) throw error;
  }

  /**
   * ‚úÖ NUEVO: Actualizar solo el status del auto
   */
  async updateCarStatus(carId: string, status: string): Promise&lt;void&gt; {
    const userId &#x3D; (await this.supabase.auth.getUser()).data.user?.id;
    if (!userId) throw new Error(&#x27;Usuario no autenticado&#x27;);

    const { error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .update({ status, updated_at: new Date().toISOString() })
      .eq(&#x27;id&#x27;, carId)
      .eq(&#x27;owner_id&#x27;, userId);

    if (error) throw error;
  }

  async updateCar(carId: string, input: Partial&lt;Car&gt;): Promise&lt;Car&gt; {
    const userId &#x3D; (await this.supabase.auth.getUser()).data.user?.id;
    if (!userId) throw new Error(&#x27;Usuario no autenticado&#x27;);

    // ‚úÖ CRITICAL: Mapear campos de ubicaci√≥n legacy (city, province, country)
    // La base de datos requiere city/province/country (NOT NULL)
    // pero el formulario env√≠a location_city/location_state/location_country
    const inputRecord &#x3D; input as Record&lt;string, unknown&gt;;
    const updateData: Record&lt;string, unknown&gt; &#x3D; { ...input };

    // Mapear location_city a city si existe
    if (inputRecord.location_city &amp;&amp; !inputRecord.city) {
      updateData.city &#x3D; inputRecord.location_city;
    }
    // Mapear location_state/location_province a province si existe
    if ((inputRecord.location_state || inputRecord.location_province) &amp;&amp; !inputRecord.province) {
      updateData.province &#x3D; inputRecord.location_state || inputRecord.location_province;
    }
    // Mapear location_country a country si existe
    if (inputRecord.location_country &amp;&amp; !inputRecord.country) {
      updateData.country &#x3D; inputRecord.location_country;
    }

    const { data, error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .update(updateData)
      .eq(&#x27;id&#x27;, carId)
      .eq(&#x27;owner_id&#x27;, userId)
      .select(&#x27;*, car_photos(*)&#x27;)
      .single();

    if (error) throw error;

    return {
      ...data,
      photos: data.car_photos || [],
    } as Car;
  }

  async listPendingCars(): Promise&lt;Car[]&gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .select(&#x27;*, car_photos(*)&#x27;)
      .eq(&#x27;status&#x27;, &#x27;draft&#x27;)
      .order(&#x27;created_at&#x27;, { ascending: false });
    if (error) throw error;

    return (data ?? []).map((car: CarWithPhotosRaw) &#x3D;&gt; ({
      ...car,
      photos: car.car_photos || [],
    })) as Car[];
  }

  async getCarBrands(): Promise&lt;Array&lt;{ id: string; name: string }&gt;&gt; {
    const { data, error } &#x3D; await this.supabase.from(&#x27;car_brands&#x27;).select(&#x27;id, name&#x27;).order(&#x27;name&#x27;);
    if (error) throw error;
    return data ?? [];
  }

  async getCarModels(
    brandId: string,
  ): Promise&lt;Array&lt;{ id: string; name: string; category: string; seats: number; doors: number }&gt;&gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;car_models&#x27;)
      .select(&#x27;id, name, category, seats, doors&#x27;)
      .eq(&#x27;brand_id&#x27;, brandId)
      .order(&#x27;name&#x27;);
    if (error) throw error;
    return data ?? [];
  }

  async getAllCarModels(): Promise&lt;
    Array&lt;{
      id: string;
      brand_id: string;
      name: string;
      category: string;
      seats: number;
      doors: number;
    }&gt;
  &gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;car_models&#x27;)
      .select(&#x27;id, brand_id, name, category, seats, doors&#x27;)
      .order(&#x27;name&#x27;);
    if (error) throw error;
    return data ?? [];
  }

  async getUserLastCar(): Promise&lt;Car | null&gt; {
    const userId &#x3D; (await this.supabase.auth.getUser()).data.user?.id;
    if (!userId) return null;

    const { data, error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .select(&#x27;*&#x27;)
      .eq(&#x27;owner_id&#x27;, userId)
      .order(&#x27;created_at&#x27;, { ascending: false })
      .limit(1)
      .single();

    if (error) {
      if (error.code &#x3D;&#x3D;&#x3D; &#x27;PGRST116&#x27;) return null; // No rows found
      throw error;
    }

    return data as Car;
  }

  async getCarsByOwner(ownerId: string): Promise&lt;Car[]&gt; {
    const { data, error } &#x3D; await this.supabase
      .from(&#x27;cars&#x27;)
      .select(&#x27;*&#x27;)
      .eq(&#x27;owner_id&#x27;, ownerId)
      .order(&#x27;created_at&#x27;, { ascending: false });

    if (error) {
      throw error;
    }

    return (data as Car[]) ?? [];
  }

  /**
   * @deprecated Use CarAvailabilityService.getAvailableCars instead
   */
  async getAvailableCars(
    startDate: string,
    endDate: string,
    options: {
      limit?: number;
      offset?: number;
      city?: string;
    } &#x3D; {},
  ): Promise&lt;Car[]&gt; {
    const available &#x3D; await this.carAvailabilityService.getAvailableCars(
      startDate,
      endDate,
      options,
    );
    // Map to Car model if needed (Supabase returns &#x60;cars&#x60; rows already compatible with &#x60;Car&#x60;).
    return available as Car[];
  }

  /**
   * @deprecated Use CarAvailabilityService.isCarAvailable instead
   */
  async isCarAvailable(carId: string, startDate: string, endDate: string): Promise&lt;boolean&gt; {
    return this.carAvailabilityService.checkAvailability(carId, startDate, endDate);
  }

  /**
   * @deprecated Use CarAvailabilityService.hasActiveBookings instead
   */
  async hasActiveBookings(carId: string): Promise&lt;{
    hasActive: boolean;
    count: number;
    bookings?: Array&lt;{ id: string; status: string; start_date: string; end_date: string }&gt;;
  }&gt; {
    return this.carAvailabilityService.hasActiveBookings(carId);
  }

  /**
   * @deprecated Use CarAvailabilityService.getNextAvailableRange instead
   */
  async getNextAvailableRange(
    carId: string,
    startDate: string,
    endDate: string,
    maxOptions &#x3D; 3,
  ): Promise&lt;
    Array&lt;{
      startDate: string;
      endDate: string;
      daysCount: number;
    }&gt;
  &gt; {
    return this.carAvailabilityService.getNextAvailableRange(carId, startDate, endDate, maxOptions);
  }

  /**
   * Get available cars using server-side RPC with PostGIS distance scoring.
   * This method uses the &#x60;get_available_cars&#x60; Postgres function which:
   * - Filters by availability (no overlapping bookings)
   * - Calculates distance from user location using ST_DistanceSphere
   * - Applies smart scoring (distance, rating, price, auto_approval)
   * - Returns cars sorted by score (distance prioritized for nearby cars)
   */
  async getAvailableCarsWithDistance(
    startDate: string,
    endDate: string,
    options: {
      lat?: number;
      lng?: number;
      limit?: number;
      offset?: number;
    } &#x3D; {},
  ): Promise&lt;CarWithScore[]&gt; {
    const { lat, lng, limit &#x3D; 12, offset &#x3D; 0 } &#x3D; options;

    const { data, error } &#x3D; await this.supabase.rpc(&#x27;get_available_cars&#x27;, {
      p_start_date: startDate,
      p_end_date: endDate,
      p_lat: lat ?? null,
      p_lng: lng ?? null,
      p_limit: limit,
      p_offset: offset,
    });

    if (error) {
      console.error(&#x27;Error calling get_available_cars RPC:&#x27;, error);
      throw error;
    }

    return (data || []) as CarWithScore[];
  }

  /**
   * Get cars within a specific radius from user location.
   * Uses the &#x60;get_cars_within_radius&#x60; Postgres function.
   */
  async getCarsWithinRadius(
    userLat: number,
    userLng: number,
    radiusKm: number,
    options: {
      startDate?: string;
      endDate?: string;
      limit?: number;
      offset?: number;
    } &#x3D; {},
  ): Promise&lt;CarWithDistance[]&gt; {
    const { startDate, endDate, limit &#x3D; 50, offset &#x3D; 0 } &#x3D; options;

    const { data, error } &#x3D; await this.supabase.rpc(&#x27;get_cars_within_radius&#x27;, {
      p_user_lat: userLat,
      p_user_lng: userLng,
      p_radius_km: radiusKm,
      p_start_date: startDate ?? null,
      p_end_date: endDate ?? null,
      p_limit: limit,
      p_offset: offset,
    });

    if (error) {
      console.error(&#x27;Error calling get_cars_within_radius RPC:&#x27;, error);
      throw error;
    }

    return (data || []) as CarWithDistance[];
  }
}

/**
 * Car with score from get_available_cars RPC
 */
export interface CarWithScore {
  id: string;
  owner_id: string;
  brand: string;
  model: string;
  year: number;
  plate: string;
  price_per_day: number;
  currency: string;
  status: string;
  location: {
    city?: string;
    state?: string;
    province?: string;
    country?: string;
    lat?: number;
    lng?: number;
  };
  images: string[];
  features: Record&lt;string, unknown&gt;;
  created_at: string;
  updated_at: string;
  total_bookings: number;
  avg_rating: number;
  score: number;
}

/**
 * Car with distance from get_cars_within_radius RPC
 */
export interface CarWithDistance {
  id: string;
  owner_id: string;
  title: string;
  brand_text_backup: string;
  model_text_backup: string;
  year: number;
  price_per_day: number;
  currency: string;
  value_usd: number;
  location_city: string;
  location_state: string;
  location_lat: number;
  location_lng: number;
  location_formatted_address: string;
  distance_km: number;
  status: string;
  photos_count: number;
  avg_rating: number;
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'CarWithDistance-1.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
