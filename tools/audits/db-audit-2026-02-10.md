# AutoRenta Database Audit Report
**Date:** 2026-02-10
**Project:** `aceacpaockyxgogxsfyc`
**Auditor:** Claude Opus 4.6

---

## Executive Summary

Cross-referenced **223 table references** in code against **~170 tables** and **35 views** in production.
Found **17 phantom tables** (code references tables that don't exist), **29 tables without RLS**,
and **6 tables with RLS enabled but zero policies** (effectively blocking all access).

---

## 1. PHANTOM TABLES (Code references, don't exist in production)

Tables that are `.from('table')` queried in code but do NOT exist as table or view in production.
Every query to these returns **HTTP 404** from PostgREST.

### Critical (high ref count, core features)

| Table | Code Refs | Domain | Impact |
|-------|-----------|--------|--------|
| `payment_intents` | 27 | Payments | Payment intent tracking broken. 27 services/components fail silently. |
| `booking_contracts` | 11 | Bookings | Contract PDF generation/retrieval fails. |
| `wallet_ledger` | 10 | Wallet | Double-entry accounting queries fail. Ledger history broken. |
| `documents` | 11 | Verification | Generic document queries fail (separate from `user_documents` which exists). |
| `disputes` | 7 | Disputes | Dispute management system non-functional. |
| `claims` | 7 | Insurance | Insurance claims tracking broken. |
| `insurance_policies` | 6 | Insurance | Policy management non-functional. |
| `payouts` | 6 | Payments | Payout tracking broken. |

### Medium (feature degradation)

| Table | Code Refs | Domain | Impact |
|-------|-----------|--------|--------|
| `mp_onboarding_states` | 5 | MercadoPago | MP onboarding state tracking missing. |
| `mp_webhook_logs` | 5 | MercadoPago | Webhook audit trail missing. |
| `user_favorite_cars` | 5 | Marketplace | Favorites feature broken. |
| `chargebacks` | 4 | Payments | Chargeback tracking non-functional. |
| `booking_inspections` | 4 | Bookings | Inspection records missing. |
| `mercadopago_accounts` | 3 | MercadoPago | MP account linking broken. |
| `preauthorizations` | 3 | Payments | Pre-auth tracking missing. |
| `vehicle_inspections` | 3 | Inspections | Vehicle inspection records missing. |
| `favorites` | 2 | Marketplace | Favorites table missing (code uses both `favorites` and `user_favorite_cars`). |

### Confirmed Views (OK)

| Name | Type | Status |
|------|------|--------|
| `my_bookings` | VIEW | Exists |
| `owner_bookings` | VIEW | Exists |
| `owner_pending_approvals` | VIEW | Exists |
| `v_car_reviews` | VIEW | Exists |
| `v_wallet_history` | VIEW | Exists |
| `wallet_history` | VIEW | Exists |
| `edge_brain_strategy_stats` | VIEW | Exists |

---

## 2. RLS SECURITY AUDIT

### Tables WITHOUT RLS (rowsecurity = false)

Any authenticated user can read/write these via PostgREST API.

| Table | Policy Count | Severity | Risk |
|-------|-------------|----------|------|
| **`payments`** | 0 | **CRITICAL** | Payment records exposed to any authenticated user |
| **`payment_captures_queue`** | 0 | **CRITICAL** | Payment capture queue exposed |
| **`pending_webhook_events`** | 0 | HIGH | Webhook payloads exposed |
| **`whatsapp_registration`** | 0 | HIGH | User phone numbers exposed |
| **`whatsapp_debounce`** | 0 | MEDIUM | Debounce state exposed |
| `accounting_accounts` | 0 | MEDIUM | Internal accounting |
| `accounting_audit_log` | 0 | MEDIUM | Audit trail exposed |
| `accounting_chart_of_accounts` | 0 | MEDIUM | Chart of accounts exposed |
| `accounting_period_balances` | 0 | LOW | Period balances |
| `accounting_period_closures` | 0 | LOW | Period closures |
| `cron_execution_log` | 0 | LOW | Cron logs |
| `ev_policy_violations` | 0 | MEDIUM | EV violations exposed |
| `iot_device_heartbeats` | 0 | MEDIUM | IoT data exposed |
| `iot_devices` | 0 | MEDIUM | Device registry exposed |
| `marketing_content_dlq` | 0 | LOW | Marketing DLQ |
| `notification_templates` | 0 | LOW | Templates |
| `playbook_executions` | 0 | LOW | Playbook state |
| `playbook_steps` | 0 | LOW | Playbook config |
| `pricing_class_factors` | 0 | MEDIUM | Pricing factors exposed |
| `pricing_seasons` | 0 | MEDIUM | Season pricing exposed |
| `promos` | 0 | LOW | Promo codes |
| `subscription_plans` | 0 | LOW | Plan definitions (public data) |
| `support_playbooks` | 0 | LOW | Support config |
| `support_ticket_messages` | 0 | MEDIUM | Support messages exposed |
| `system_flags` | 0 | LOW | System config |
| `vehicle_pricing_models` | 0 | LOW | Pricing models |
| `vehicle_telemetry` | 0 | HIGH | GPS telemetry exposed |
| `vehicle_tier_config` | 0 | LOW | Tier config |
| `wallet_transaction_backups` | 0 | HIGH | Transaction backups exposed |

### Tables WITH RLS but ZERO policies (blocked for everyone via PostgREST)

These tables have `ENABLE ROW LEVEL SECURITY` but no policies defined.
PostgREST returns empty results for ALL users (including owners of the data).

| Table | Severity | Impact |
|-------|----------|--------|
| **`reviews`** | **CRITICAL** | Nobody can read reviews via PostgREST. Review display broken. |
| **`wallets`** | **CRITICAL** | Nobody can read wallet info via PostgREST. Wallet display broken. |
| `accounting_provisions` | MEDIUM | Provisions inaccessible |
| `driver_score_snapshots` | LOW | Score history inaccessible |
| `fgo_metrics` | MEDIUM | FGO metrics inaccessible |
| `fgo_subfunds` | MEDIUM | FGO subfund data inaccessible |

> **Note:** `reviews` and `wallets` are likely queried via RPCs instead of direct PostgREST,
> which bypasses RLS when using `SECURITY DEFINER`. But direct `.from('reviews')` calls will fail.

---

## 3. FK COLUMNS WITHOUT CONSTRAINTS

UUID columns named `*_id` that lack foreign key constraints (data integrity risk).

### High Priority (core tables)

| Table | Column | Expected FK Target |
|-------|--------|--------------------|
| `bookings` | `dropoff_location_id` | locations? (table may not exist) |
| `bookings` | `pickup_location_id` | locations? (table may not exist) |
| `bookings` | `wallet_lock_id` | wallet_transactions? |
| `cars` | `brand_id` | car_brands? (table doesn't exist) |
| `cars` | `model_id` | car_models? (table doesn't exist) |
| `payments` | `payment_intent_id` | payment_intents (table doesn't exist!) |
| `user_stats` | `user_id` | profiles (missing FK) |

### Medium Priority (supporting tables)

| Table | Column | Expected FK Target |
|-------|--------|--------------------|
| `accounting_ledger` | `batch_id` | No clear target |
| `accounting_ledger` | `reference_id` | Polymorphic (intentional?) |
| `accounting_period_closures` | `closing_entries_batch_id` | No clear target |
| `accounting_provisions` | `reference_id` | Polymorphic |
| `admin_audit_log` | `resource_id` | Polymorphic (intentional) |
| `marketing_content_dlq` | `original_queue_id` | marketing_content_queue |
| `query_performance_log` | `user_id` | profiles |
| `recovery_cases` | `evidence_package_id` | evidence_packages |
| `wallet_audit_log` | `transaction_id` | wallet_transactions |
| `wallet_audit_log` | `user_id` | profiles |

> **Note:** View columns (v_*, my_bookings, owner_bookings) without FKs are expected — views
> don't support constraints.

---

## 4. PRIORITY ACTION ITEMS

### Immediate (Production Impact NOW)

1. **Enable RLS on `payments`** — Payment records readable by any authenticated user
2. **Enable RLS on `vehicle_telemetry`** — GPS data of all vehicles exposed
3. **Enable RLS on `wallet_transaction_backups`** — Financial backups exposed
4. **Add SELECT policy to `reviews`** — Reviews display likely broken for direct queries
5. **Add SELECT policy to `wallets`** — Wallet info blocked for direct queries

### Short-term (Feature Gaps)

6. **Create `payment_intents` table** — 27 code references, core payment flow
7. **Create `wallet_ledger` table** — 10 code references, financial tracking
8. **Create `booking_contracts` table** — 11 code references, contract management
9. **Create MercadoPago tables** (`mercadopago_accounts`, `mp_onboarding_states`, `mp_webhook_logs`)
10. **Create `disputes` and `chargebacks` tables** — Dispute management system

### Medium-term (Data Integrity)

11. **Add FK constraints** on `bookings.wallet_lock_id`, `payments.payment_intent_id`
12. **Add FK constraint** on `user_stats.user_id` → `profiles.id`
13. **Enable RLS** on remaining 20+ tables without it
14. **Review phantom tables** — Determine if code is dead or tables need creation

---

## 5. VERIFICATION QUERIES

```sql
-- Verify RLS on payments (CRITICAL)
SELECT rowsecurity FROM pg_tables
WHERE schemaname='public' AND tablename='payments';

-- Check if reviews are accessible
SELECT count(*) FROM public.reviews; -- Should work with service_role

-- Verify payment_intents doesn't exist
SELECT EXISTS(SELECT 1 FROM information_schema.tables
  WHERE table_schema='public' AND table_name='payment_intents');

-- List all tables without RLS
SELECT tablename FROM pg_tables
WHERE schemaname='public' AND NOT rowsecurity
ORDER BY tablename;

-- List tables with RLS but no policies
SELECT t.tablename FROM pg_tables t
WHERE t.schemaname='public' AND t.rowsecurity
AND NOT EXISTS (
  SELECT 1 FROM pg_policies p
  WHERE p.schemaname='public' AND p.tablename=t.tablename
)
ORDER BY t.tablename;
```

---

## 6. STATISTICS SUMMARY

| Category | Count |
|----------|-------|
| Production tables | ~170 |
| Production views | 35 |
| Code table references | 223 unique |
| Code RPC references | 224 unique |
| Production RPCs (app only) | ~350+ |
| **Phantom tables** | **17** |
| **Tables without RLS** | **29** |
| **Tables with RLS, no policies** | **6** |
| **FK columns missing constraints** | **17** |
| Edge function secrets | 64+ unique |

---

*Generated by Claude Opus 4.6 — AutoRenta DB Audit v1.0*
