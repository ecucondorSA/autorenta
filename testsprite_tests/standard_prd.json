{
  "meta": {
    "project": "AutoRenta Booking and Owner Flows",
    "date": "2025-11-04",
    "prepared_by": "Generated by Claude Code"
  },
  "product_overview": "AutoRenta is a peer-to-peer car rental platform enabling users to book vehicles seamlessly and allowing car owners (locadores) to publish, manage their cars, reservations, wallets, and payments through integrated workflows. This includes a complete booking process for renters, comprehensive car owner management, and wallet deposit functionality integrated with MercadoPago.",
  "core_goals": [
    "Enable locatarios (renters) to find, book, and pay for cars quickly and securely.",
    "Empower locadores (car owners) to publish vehicles, manage reservations, communicate with renters, and handle earnings and withdrawals efficiently.",
    "Integrate wallet functionality to support pre-loaded funds via MercadoPago deposits for faster and seamless payments.",
    "Assure high reliability, security, and smooth user experience across booking, payments, and wallet operations.",
    "Provide clear and transparent pricing, availability, and communication at every step of the rental process."
  ],
  "key_features": [
    "Booking flow for locatarios with real-time availability, dynamic pricing, multiple payment options (wallet and MercadoPago), and instant confirmation.",
    "Car publication and management flow for locadores including detailed car info, photos, geolocation, and MercadoPago onboarding verification.",
    "Wallet system supporting deposits, balance tracking, transaction history, and withdrawals with proper validations and commissions.",
    "Integrated messaging system for communication between car owners and renters.",
    "Admin and dashboard features for locadores with metrics on cars, bookings, earnings, and withdrawals.",
    "Robust security with authentication, authorization, RLS policies, and data validation.",
    "Edge cases handling such as booking conflicts, insufficient funds, delayed payments, and duplicate webhook processing."
  ],
  "user_flow_summary": [
    "Locatarios browse cars on map or list, filter by date and price, select a car, pick rental dates, review price breakdown, choose payment method, and complete booking with confirmation.",
    "Locadores publish cars through a detailed form with photo uploads, MercadoPago onboarding check, manage their fleet, view and update bookings, start and finish rentals, and handle payouts to bank accounts.",
    "Users deposit funds into their wallet via MercadoPago using credit cards or cash payments, with webhook-based confirmation updating balances and transaction history.",
    "Booking and payment flows handle alternative scenarios including insufficient wallet balance, booking conflicts, MercadoPago payment failures, and delays gracefully.",
    "Locadores and locatarios communicate through an integrated messaging system linked to specific cars and bookings."
  ],
  "validation_criteria": [
    "Booking conversion rate from car view to confirmed booking is ≥ 60%.",
    "Average booking completion time is under 3 minutes.",
    "Payment success rate across wallet and MercadoPago payments is over 95%.",
    "Wallet deposit success rate is over 95% with less than 1% duplicate deposits due to webhook idempotency.",
    "System correctly prevents users from booking their own cars and double booking through date overlap validation.",
    "All wallet and withdrawal operations enforce balance and amount validations preventing overdrafts.",
    "MercadoPago OAuth onboarding for locadores returns valid tokens before activating car publications.",
    "Edge case flows like webhook delays, payment rejection, and booking conflicts provide appropriate user feedback and error handling.",
    "RLS policies ensure users only access their own data and prevent unauthorized modifications.",
    "Performance targets are met: page loads under 2 seconds, price calculation APIs respond under 300ms, and booking/payment operations respond promptly."
  ],
  "code_summary": {
    "tech_stack": [
      "TypeScript",
      "Angular 17",
      "Supabase (PostgreSQL)",
      "Cloudflare Pages",
      "Cloudflare Workers",
      "Tailwind CSS",
      "Mapbox GL JS",
      "MercadoPago API"
    ],
    "features": [
      {
        "name": "authentication",
        "description": "Sistema de autenticación completo con login, registro, recuperación de contraseña y callbacks de OAuth",
        "files": [
          "apps/web/src/app/features/auth/login/login.page.ts",
          "apps/web/src/app/features/auth/register/register.page.ts",
          "apps/web/src/app/features/auth/reset-password/reset-password.page.ts",
          "apps/web/src/app/features/auth/callback/auth-callback.page.ts",
          "apps/web/src/app/core/services/auth.service.ts",
          "apps/web/src/app/core/guards/auth.guard.ts"
        ]
      },
      {
        "name": "car-publication",
        "description": "Permite a los locadores publicar sus autos con fotos, información detallada y ubicación en mapa",
        "files": [
          "apps/web/src/app/features/cars/publish/publish-car-v2.page.ts",
          "apps/web/src/app/core/services/cars.service.ts",
          "apps/web/src/app/core/services/geocoding.service.ts"
        ]
      },
      {
        "name": "car-listing",
        "description": "Búsqueda y visualización de autos en mapa o listado con filtros avanzados",
        "files": [
          "apps/web/src/app/features/cars/list/cars-list.page.ts",
          "apps/web/src/app/features/cars/detail/car-detail.page.ts",
          "apps/web/src/app/features/cars/compare/compare.page.ts",
          "apps/web/src/app/core/services/cars.service.ts",
          "apps/web/src/app/core/services/car-locations.service.ts"
        ]
      },
      {
        "name": "booking-system",
        "description": "Sistema completo de reservas desde selección de auto hasta confirmación de pago",
        "files": [
          "apps/web/src/app/features/bookings/checkout/state/checkout-state.service.ts",
          "apps/web/src/app/features/bookings/booking-detail/booking-detail.page.ts",
          "apps/web/src/app/features/bookings/booking-success/booking-success.page.ts",
          "apps/web/src/app/features/bookings/booking-detail-payment/booking-detail-payment.page.ts",
          "apps/web/src/app/core/services/bookings.service.ts",
          "apps/web/src/app/core/services/booking-confirmation.service.ts"
        ]
      },
      {
        "name": "payment-system",
        "description": "Integración con MercadoPago para pagos de bookings y depósitos en wallet",
        "files": [
          "apps/web/src/app/core/services/payments.service.ts",
          "apps/web/src/app/core/services/payment-gateway.factory.ts",
          "apps/web/src/app/core/services/mercadopago-booking-gateway.service.ts",
          "apps/web/src/app/core/services/checkout-payment.service.ts",
          "apps/web/src/app/features/bookings/booking-detail-payment/booking-detail-payment.page.ts"
        ]
      },
      {
        "name": "wallet-system",
        "description": "Sistema de wallet con depósitos, retiros y gestión de fondos bloqueados",
        "files": [
          "apps/web/src/app/features/wallet/wallet.page.ts",
          "apps/web/src/app/core/services/wallet.service.ts",
          "apps/web/src/app/core/services/wallet-ledger.service.ts",
          "apps/web/src/app/core/services/withdrawal.service.ts"
        ]
      },
      {
        "name": "user-profile",
        "description": "Gestión de perfil de usuario con avatar, verificación y configuración de cuenta",
        "files": [
          "apps/web/src/app/features/profile/profile-expanded.page.ts",
          "apps/web/src/app/features/profile/profile.page.ts",
          "apps/web/src/app/core/services/profile.service.ts",
          "apps/web/src/app/features/users/public-profile.page.ts"
        ]
      },
      {
        "name": "mercadopago-onboarding",
        "description": "Onboarding de MercadoPago para locadores que quieren recibir pagos",
        "files": [
          "apps/web/src/app/features/profile/mercadopago-connect.component.ts",
          "apps/web/src/app/core/services/mercadopago-oauth.service.ts",
          "apps/web/src/app/core/services/marketplace-onboarding.service.ts",
          "apps/web/src/app/features/auth/mercadopago-callback.page.ts",
          "apps/web/src/app/core/guards/mercadopago.guard.ts"
        ]
      },
      {
        "name": "messaging",
        "description": "Sistema de mensajería entre locadores y locatarios",
        "files": [
          "apps/web/src/app/features/messages/inbox.page.ts",
          "apps/web/src/app/features/messages/messages.page.ts",
          "apps/web/src/app/core/services/messages.service.ts",
          "apps/web/src/app/core/services/messages.repo.ts"
        ]
      },
      {
        "name": "admin-dashboard",
        "description": "Panel de administración para gestión de usuarios, autos, bookings y pagos",
        "files": [
          "apps/web/src/app/features/admin/admin-dashboard.page.ts",
          "apps/web/src/app/features/admin/dashboard/admin-dashboard.page.ts",
          "apps/web/src/app/features/admin/accounting-dashboard/accounting-dashboard.component.ts",
          "apps/web/src/app/core/services/admin.service.ts"
        ]
      },
      {
        "name": "reviews-system",
        "description": "Sistema de reviews y ratings entre usuarios después de completar bookings",
        "files": [
          "apps/web/src/app/core/services/reviews.service.ts",
          "apps/web/src/app/features/bookings/booking-detail/review-management.component.ts"
        ]
      },
      {
        "name": "document-verification",
        "description": "Proceso de verificación de documentos de identidad para usuarios",
        "files": [
          "apps/web/src/app/core/services/verification.service.ts",
          "apps/web/src/app/core/services/face-verification.service.ts",
          "apps/web/src/app/core/services/verification-state.service.ts"
        ]
      },
      {
        "name": "insurance-fgo",
        "description": "Sistema de seguro Full Glass Option (FGO) para bookings",
        "files": [
          "apps/web/src/app/core/services/fgo.service.ts",
          "apps/web/src/app/core/services/fgo-v1-1.service.ts",
          "apps/web/src/app/core/services/fgo-policy-engine.service.ts",
          "apps/web/src/app/features/bookings/insurance-selector/insurance-selector.component.ts"
        ]
      },
      {
        "name": "risk-calculation",
        "description": "Cálculo de riesgo para bookings y gestión de snapshots de riesgo",
        "files": [
          "apps/web/src/app/core/services/risk.service.ts",
          "apps/web/src/app/core/services/risk-calculator.service.ts",
          "apps/web/src/app/core/services/risk-matrix.service.ts"
        ]
      },
      {
        "name": "pricing-dynamic",
        "description": "Sistema de precios dinámicos basado en demanda, temporada y otros factores",
        "files": [
          "apps/web/src/app/core/services/pricing.service.ts",
          "apps/web/src/app/core/services/dynamic-pricing.service.ts",
          "apps/web/src/app/core/services/realtime-pricing.service.ts"
        ]
      },
      {
        "name": "split-payment",
        "description": "Sistema de split payment para dividir pagos entre plataforma y locador",
        "files": [
          "apps/web/src/app/core/services/split-payment.service.ts",
          "apps/web/src/app/core/services/payout.service.ts",
          "apps/web/src/app/core/services/settlement.service.ts"
        ]
      },
      {
        "name": "guided-tour",
        "description": "Sistema de tours guiados interactivos para onboarding de usuarios",
        "files": [
          "apps/web/src/app/core/guided-tour/guided-tour.service.ts",
          "apps/web/src/app/core/guided-tour/services/tour-orchestrator.service.ts",
          "apps/web/src/app/core/services/tour.service.ts"
        ]
      },
      {
        "name": "pwa",
        "description": "Funcionalidades de Progressive Web App con instalación y actualizaciones",
        "files": [
          "apps/web/src/app/core/services/pwa.service.ts",
          "apps/web/src/app/core/services/pwa-install.service.ts"
        ]
      },
      {
        "name": "notifications",
        "description": "Sistema de notificaciones push y en-app para eventos importantes",
        "files": [
          "apps/web/src/app/core/services/notification.service.ts",
          "apps/web/src/app/core/services/push-notification.service.ts"
        ]
      },
      {
        "name": "analytics",
        "description": "Sistema de analytics y telemetría para tracking de eventos",
        "files": [
          "apps/web/src/app/core/services/analytics.service.ts",
          "apps/web/src/app/core/services/telemetry.service.ts"
        ]
      }
    ]
  }
}
