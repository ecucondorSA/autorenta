name: Validate Lockfile

on:
  pull_request:
    branches: [main, develop, staging]
    paths:
      - 'package.json'
      - 'apps/*/package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'

jobs:
  validate-lockfile:
    name: Check Lockfile is Up to Date
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      
      - name: Check lockfile is up to date
        run: |
          echo "üîç Validating lockfile..."
          pnpm install --lockfile-only --ignore-scripts
          
          if git diff --quiet pnpm-lock.yaml; then
            echo "‚úÖ Lockfile is up to date"
          else
            echo "‚ùå Lockfile is outdated!"
            echo ""
            echo "üìù The lockfile doesn't match package.json"
            echo ""
            echo "To fix this, run:"
            echo "  pnpm install --lockfile-only"
            echo "  git add pnpm-lock.yaml"
            echo "  git commit -m 'chore: update lockfile'"
            echo ""
            git diff pnpm-lock.yaml
            exit 1
          fi
      
      - name: Verify lockfile integrity
        run: |
          echo "üîê Verifying lockfile integrity..."
          pnpm install --frozen-lockfile --ignore-scripts
          echo "‚úÖ Lockfile integrity verified"
