name: ðŸš¦ Production Readiness Check

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 8 * * 1' # Ejecutar cada lunes a las 8 AM

jobs:
  quality-gate:
    name: ðŸ›¡ï¸ Quality Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: ðŸŽ¨ Lint Check
        run: pnpm lint
        continue-on-error: false

      - name: ðŸ”’ Security Audit
        run: pnpm audit --prod --audit-level=high
        continue-on-error: true # Advertencia por ahora, cambiar a false para bloquear

  test-coverage:
    name: ðŸ§ª Unit Tests & Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: Run Tests with Coverage
        run: pnpm test:unit:coverage
      
      # AquÃ­ podrÃ­amos aÃ±adir un paso para fallar si el coverage es bajo
      # Por ahora solo reporta

  build-verification:
    name: ðŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install

      - name: Build Web App
        run: pnpm build:web
        env:
          NODE_ENV: production
          # Variables ficticias para validar que el build no falla por falta de ellas
          # (Angular a veces requiere que existan en tiempo de build)
          NG_APP_SUPABASE_URL: "https://example.supabase.co"
          NG_APP_SUPABASE_ANON_KEY: "dummy-key"
          
  e2e-smoke:
    name: ðŸŽ­ E2E Smoke Tests
    runs-on: ubuntu-latest
    needs: [build-verification]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install
        
      - name: Install Playwright Browsers
        run: pnpm exec playwright install chromium --with-deps

      # Ejecutamos solo los tests de "smoke" o crÃ­ticos
      # Asumiendo que existen o ejecutando un subconjunto seguro
      # Si no hay tag @smoke, ejecutamos el test de login como ejemplo
      - name: Run E2E Smoke Tests
        run: pnpm exec playwright test tests/renter/booking/success-page.spec.ts --project=chromium
        continue-on-error: true

  final-verdict:
    name: ðŸ Readiness Verdict
    needs: [quality-gate, test-coverage, build-verification, e2e-smoke]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Decide
        run: |
          echo "### ðŸš¦ Production Readiness Report" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.quality-gate.result }}" == "success" ]; then
            echo "âœ… Quality Gate: PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Quality Gate: FAIL" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-coverage.result }}" == "success" ]; then
            echo "âœ… Unit Tests: PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Unit Tests: FAIL" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-verification.result }}" == "success" ]; then
            echo "âœ… Build Check: PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build Check: FAIL" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.e2e-smoke.result }}" == "success" ]; then
            echo "âœ… E2E Smoke: PASS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ E2E Smoke: WARNING (Check logs)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.quality-gate.result }}" == "success" ] && [ "${{ needs.build-verification.result }}" == "success" ]; then
             echo "## ðŸš€ READY FOR PRODUCTION (With Cautions)" >> $GITHUB_STEP_SUMMARY
             echo "Core checks passed. Verify E2E results manually if warning exists." >> $GITHUB_STEP_SUMMARY
          else
             echo "## â›” NOT READY FOR PRODUCTION" >> $GITHUB_STEP_SUMMARY
             echo "Critical checks failed. Do not deploy." >> $GITHUB_STEP_SUMMARY
             exit 1
          fi
