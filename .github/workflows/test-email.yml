name: Test Email

on:
  workflow_dispatch:
    inputs:
      destinatario:
        description: 'Email de destino'
        required: true
        default: 'admin@autorentar.com'

jobs:
  send-test-email:
    runs-on: ubuntu-latest
    steps:
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Create and run email script
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          DESTINATARIO: ${{ github.event.inputs.destinatario }}
        run: |
          mkdir email-test && cd email-test
          bun init -y
          bun add nodemailer

          cat > send.ts << 'EOF'
          import nodemailer from "nodemailer";

          const transporter = nodemailer.createTransport({
            service: "gmail",
            auth: {
              user: process.env.GMAIL_USER,
              pass: process.env.GMAIL_APP_PASSWORD,
            },
          });

          const dest = process.env.DESTINATARIO || "admin@autorentar.com";

          const info = await transporter.sendMail({
            from: process.env.GMAIL_USER,
            to: dest,
            subject: "Test AutoRenta - Email Corporativo",
            html: `<h2>Test AutoRenta</h2><p>Email a <strong>${dest}</strong> funciona correctamente.</p>`,
          });

          console.log("âœ… Email enviado:", info.messageId);
          EOF

          bun send.ts
