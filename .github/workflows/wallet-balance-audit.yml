name: Wallet Balance Audit

on:
  schedule:
    # Run daily at 5:00 AM Argentina time (8:00 UTC)
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  audit:
    name: Audit Wallet Balances
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Call Wallet Reconciliation Function
        id: reconcile
        uses: actions/github-script@v7
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        with:
          script: |
            const supabaseUrl = process.env.SUPABASE_URL;
            const supabaseKey = process.env.SUPABASE_SERVICE_KEY;

            console.log('Calling wallet-reconciliation edge function...');

            if (!supabaseUrl || !supabaseKey) {
              console.warn('SUPABASE_URL or SUPABASE_SERVICE_KEY not configured, skipping audit');
              core.setOutput('discrepancies', '0');
              core.setOutput('fund_ok', 'true');
              core.setOutput('total_difference', '0');
              return { success: true, skipped: true };
            }

            const response = await fetch(
              `${supabaseUrl}/functions/v1/wallet-reconciliation`,
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${supabaseKey}`,
                  'Content-Type': 'application/json',
                },
              }
            );

            if (!response.ok) {
              const errorText = await response.text();
              console.error(`Function call failed: ${response.status}`, errorText);
              throw new Error(`Function call failed: ${response.status} - ${errorText.slice(0, 200)}`);
            }

            const result = await response.json();
            console.log('Reconciliation result:', JSON.stringify(result, null, 2));

            if (!result.success) {
              throw new Error(`Reconciliation failed: ${result.error}`);
            }

            const report = result.report;
            core.setOutput('discrepancies', report.discrepancies_found);
            core.setOutput('fund_ok', report.coverage_fund_ok);
            core.setOutput('total_difference', report.total_difference);

            // Check for issues
            if (report.discrepancies_found > 0 || !report.coverage_fund_ok) {
              core.setFailed(`Wallet audit found ${report.discrepancies_found} discrepancies`);
            } else {
              console.log('All wallet balances verified successfully');
            }

            return result;

      - name: Create Issue on Discrepancy
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const discrepancies = '${{ steps.reconcile.outputs.discrepancies }}';
            const fundOk = '${{ steps.reconcile.outputs.fund_ok }}';
            const totalDiff = '${{ steps.reconcile.outputs.total_difference }}';

            const totalDiffFormatted = (parseInt(totalDiff || '0') / 100).toFixed(2);
            const body =
              '## Wallet Balance Audit Alert\n\n' +
              '**Discrepancies Found:** ' + discrepancies + '\n' +
              '**Coverage Fund OK:** ' + fundOk + '\n' +
              '**Total Difference:** ARS ' + totalDiffFormatted + '\n\n' +
              '### Action Required\n' +
              '1. Review the wallet reconciliation logs\n' +
              '2. Identify affected users\n' +
              '3. Investigate the cause of discrepancies\n' +
              '4. Apply corrections if necessary\n\n' +
              '### Links\n' +
              '- [Workflow Run](https://github.com/' + context.repo.owner + '/' + context.repo.repo +
              '/actions/runs/' + context.runId + ')\n\n' +
              '---\n' +
              '*Auto-generated by Wallet Balance Audit workflow*';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[CRITICAL] Wallet Balance Audit: Discrepancies Found',
              body: body,
              labels: ['alert', 'wallet', 'critical'],
            });

      - name: Additional Direct DB Check
        if: always()
        uses: actions/github-script@v7
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        with:
          script: |
            const supabaseUrl = process.env.SUPABASE_URL;
            const supabaseKey = process.env.SUPABASE_SERVICE_KEY;

            if (!supabaseUrl || !supabaseKey) {
              console.warn('SUPABASE_URL or SUPABASE_SERVICE_KEY not configured, skipping direct DB check');
              return;
            }

            // Check for negative balances (should never happen)
            const negativeBalancesRes = await fetch(
              supabaseUrl + '/rest/v1/user_wallets?available_balance=lt.0&select=user_id,available_balance',
              {
                headers: {
                  'apikey': supabaseKey,
                  'Authorization': 'Bearer ' + supabaseKey,
                }
              }
            );

            const negativeBalances = await negativeBalancesRes.json();

            if (!Array.isArray(negativeBalances)) {
              console.warn('Unexpected response for negative balances query:', JSON.stringify(negativeBalances).slice(0, 200));
              return;
            }

            if (negativeBalances.length > 0) {
              console.error('CRITICAL: Found users with negative balances!', negativeBalances);
              core.setFailed('Found ' + negativeBalances.length + ' users with negative balances');
            } else {
              console.log('No negative balances found');
            }

            // Check for orphaned locked funds (locked > 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const orphanedLocksRes = await fetch(
              supabaseUrl + '/rest/v1/wallet_locked_funds?locked_at=lt.' + thirtyDaysAgo.toISOString() +
                '&released_at=is.null&select=*',
              {
                headers: {
                  'apikey': supabaseKey,
                  'Authorization': 'Bearer ' + supabaseKey,
                }
              }
            );

            const orphanedLocks = await orphanedLocksRes.json();

            if (!Array.isArray(orphanedLocks)) {
              console.warn('Unexpected response for orphaned locks query:', JSON.stringify(orphanedLocks).slice(0, 200));
              return;
            }

            if (orphanedLocks.length > 0) {
              console.warn('Found ' + orphanedLocks.length + ' locked funds older than 30 days');
              // Log but don't fail - this might be expected in some cases
            }

  notify-failure:
    name: Notify on Critical Failure
    runs-on: ubuntu-latest
    needs: audit
    if: failure()
    steps:
      - name: Send Critical Alert
        uses: actions/github-script@v7
        with:
          script: |
            const webhookUrl = '${{ secrets.INCIDENT_WEBHOOK_URL }}';
            if (!webhookUrl) return;

            await fetch(webhookUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                source: 'github',
                severity: 'critical',
                title: 'Wallet Balance Audit Failed',
                message: 'Critical wallet balance discrepancies detected. Immediate investigation required.',
                metadata: {
                  workflow: 'wallet-balance-audit',
                  run_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                },
                timestamp: new Date().toISOString(),
              }),
            });
