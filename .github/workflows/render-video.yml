name: Render Marketing Video

on:
  repository_dispatch:
    types: [render-video]
  workflow_dispatch:
    inputs:
      carName:
        description: 'Car Name'
        required: true
        default: 'Fiat Cronos'
      pricePerDay:
        description: 'Price Per Day'
        required: true
        default: '45000'
      imageUrl:
        description: 'Image URL'
        required: true
        default: 'https://http2.mlstatic.com/D_NQ_NP_977366-MLA74676867375_022024-O.webp'
      jobId:
        description: 'Job ID (optional)'
        required: false
        default: 'manual-test'
      compositionId:
        description: 'Composition ID (CarPromo or CarPromoV2)'
        required: false
        default: 'CarPromo'

jobs:
  render:
    name: Render Video
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # FIX: Install dependencies at ROOT to handle workspaces correctly
      - name: Install Dependencies (Root)
        run: pnpm install
        # No working-directory, run at root

      - name: Install FFMPEG
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Determine Props
        id: props
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "PROPS={\"carName\": \"${{ inputs.carName }}\", \"pricePerDay\": ${{ inputs.pricePerDay }}, \"imageUrl\": \"${{ inputs.imageUrl }}\"}" >> $GITHUB_ENV
            echo "JOB_ID=${{ inputs.jobId }}" >> $GITHUB_ENV
            echo "COMP_ID=${{ inputs.compositionId }}" >> $GITHUB_ENV
          else
            echo "PROPS=${{ toJson(github.event.client_payload.props) }}" >> $GITHUB_ENV
            echo "JOB_ID=${{ github.event.client_payload.job_id }}" >> $GITHUB_ENV
            echo "COMP_ID=${{ github.event.client_payload.composition_id || 'CarPromo' }}" >> $GITHUB_ENV
          fi

      - name: Render Video
        working-directory: apps/video-studio
        run: |
          echo "Rendering with props: $PROPS using Composition: $COMP_ID"
          # FIX: Use swangle (software rendering) for CI stability
          # --chrome-prop=--disable-gpu prevents crash on headless runners
          # --chrome-prop=--disable-web-security prevents CORS/ORB issues with external images
          pnpm exec remotion render src/index.ts $COMP_ID out/video.mp4 --props="$PROPS" --gl=swangle --chrome-prop=--disable-gpu --chrome-prop=--no-sandbox --chrome-prop=--disable-web-security --log=verbose

      - name: Upload to Supabase Storage
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          JOB_ID: ${{ env.JOB_ID }}
          MARKETING_BUCKET: 'marketing-media' 
        run: |
          node tools/upload-video.js

      - name: Update Database Record (If Job ID exists)
        if: env.JOB_ID != 'manual-test'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          JOB_ID: ${{ env.JOB_ID }}
        run: |
          VIDEO_URL=$(cat video_url.txt)
          echo "Updating DB for Job $JOB_ID with URL $VIDEO_URL"
          
          curl -X PATCH "$SUPABASE_URL/rest/v1/marketing_content_queue?id=eq.$JOB_ID" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"media_url\": \"$VIDEO_URL\", \"status\": \"pending\", \"media_type\": \"video\"}"
