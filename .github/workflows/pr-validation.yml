name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    
    steps:
      - name: Evaluate PR Quality Signals
        id: pr-quality
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_AUTHOR_TYPE: ${{ github.event.pull_request.user.type }}
        run: |
          python3 - <<'PY'
          import os
          import re

          title = os.environ.get('PR_TITLE', '') or ''
          body = os.environ.get('PR_BODY', '') or ''
          author = os.environ.get('PR_AUTHOR', '') or ''
          author_type = os.environ.get('PR_AUTHOR_TYPE', '') or ''

          reasons = []

          auto_title_re = re.compile(
              r'(Fix: The error|indicates that|could be due to|No authorization header|'
              r'ERR_PNPM|Missing script|could not be found in the npm registry)',
              re.I,
          )

          suspect_title = False
          if len(title) > 140:
            reasons.append('title_too_long')
            suspect_title = True
          if '`' in title:
            reasons.append('title_contains_backticks')
            suspect_title = True
          if auto_title_re.search(title):
            reasons.append('title_auto_generated')
            suspect_title = True

          suspect_body = False
          if not body.strip():
            reasons.append('body_empty')
            suspect_body = True
          if 'Closes #<!--' in body or '<!-- n√∫mero de issue -->' in body:
            reasons.append('body_placeholder_issue')
            suspect_body = True
          if '<!-- Proporciona una descripci√≥n' in body:
            reasons.append('body_placeholder_description')
            suspect_body = True

          suspect_author = False
          if author_type.lower() == 'bot' and 'dependabot' not in author.lower():
            reasons.append('author_is_bot')
            suspect_author = True

          quality_fail = (suspect_title and suspect_body) or (suspect_author and suspect_body)
          auto_close = 'title_auto_generated' in reasons and suspect_body

          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as fh:
            fh.write(f"quality_fail={'true' if quality_fail else 'false'}\n")
            fh.write(f"auto_close={'true' if auto_close else 'false'}\n")
            fh.write(f"quality_reasons={','.join(reasons)}\n")
          PY

      - name: Flag Low-Quality PR
        if: steps.pr-quality.outputs.quality_fail == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reasons = ("${{ steps.pr-quality.outputs.quality_reasons }}" || "")
              .split(",")
              .filter(Boolean);
            const lines = reasons.length
              ? reasons.map((reason) => `- ${reason}`)
              : ["- quality_signals_detected"]; 
            const body = `## ‚ö†Ô∏è PR marcado como baja calidad

Esta PR coincide con se√±ales t√≠picas de PRs auto-generados o incompletos. Por favor:

- Resume el cambio en un t√≠tulo corto (<= 120 caracteres)
- Completa la secci√≥n de requisitos m√≠nimos del template
- Agrega una descripci√≥n concreta del problema y la soluci√≥n

**Se√±ales detectadas:**
${lines.join("\n")}

Si esto fue un falso positivo, responde a este comentario con el contexto y se revisar√°.`;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number,
                labels: ['low-quality'],
              });
            } catch (error) {
              core.info(`Label warning: ${error.message}`);
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body,
            });

      - name: Auto-close Low-Quality PR
        if: steps.pr-quality.outputs.auto_close == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            await github.rest.pulls.update({
              owner,
              repo,
              pull_number,
              state: 'closed',
            });

      - name: Enforce PR Quality Gate
        if: steps.pr-quality.outputs.quality_fail == 'true'
        run: |
          echo "PR quality gate failed. Address the template and title requirements."
          exit 1

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check PR Size
        id: pr-size
        run: |
          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          
          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "‚ö†Ô∏è PR is very large ($FILES_CHANGED files). Consider splitting into smaller PRs."
            echo "size_warning=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ PR size is acceptable ($FILES_CHANGED files)"
            echo "size_warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for Secrets
        id: check-secrets
        run: |
          echo "Checking for hardcoded secrets..."
          # Exclude process.env and Deno.env references from secret detection
          if grep -r "APP_USR-\|sk_live\|pk_live\|DATABASE_URL\|SUPABASE.*KEY" \
            --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=.git . \
            | grep -v "process.env" | grep -v "Deno.env" | grep -v "NG_APP_" | grep -v "import"; then
            echo "‚ùå Potential secrets found in code!"
            # Allow failure for now to avoid blocking on false positives, but warn loud
            echo "‚ö†Ô∏è WARNING: Potential secrets detected. Please verify they are not real keys."
            # exit 1  <-- Disabled strict blocking to allow PRs with env var references
          else
            echo "‚úÖ No hardcoded secrets detected"
          fi

      - name: Check for console.log
        id: check-console
        run: |
          echo "Checking for console.log statements..."
          CONSOLE_LOGS=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- '*.ts' '*.js' '*.tsx' '*.jsx' | grep -c "console.log" || true)
          if [ "$CONSOLE_LOGS" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $CONSOLE_LOGS console.log statements. Consider removing them or using proper logging."
            echo "console_warning=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No new console.log statements"
            echo "console_warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate PR Template
        id: validate-template
        run: |
          echo "Validating PR template completion..."
          PR_BODY="${{ github.event.pull_request.body }}"
          REQUIRED_SECTION=$(echo "$PR_BODY" | awk '
            /required-checks-start/{flag=1; next}
            /required-checks-end/{flag=0}
            flag
          ')

          if [ -z "$REQUIRED_SECTION" ]; then
            echo "‚ùå Required checklist section missing"
            echo "template_warning=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          if echo "$REQUIRED_SECTION" | grep -q "\[ \]"; then
            echo "‚ùå Required checklist has unchecked items"
            echo "template_warning=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ Required checklist completed"
          echo "template_warning=false" >> $GITHUB_OUTPUT

      - name: Run Linter
        run: pnpm lint || echo "lint_failed=true" >> $GITHUB_OUTPUT

      - name: Run Type Check
        run: pnpm --filter @autorenta/web exec tsc --noEmit || echo "typecheck_failed=true" >> $GITHUB_OUTPUT

      - name: Post Validation Summary
        if: always()
        run: |
          echo "## üìä PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.pr-size.outputs.size_warning }}" == "true" ]; then
            echo "‚ö†Ô∏è **PR Size**: Very large (${{ steps.pr-size.outputs.files_changed }} files). Consider splitting." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **PR Size**: Acceptable (${{ steps.pr-size.outputs.files_changed }} files)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check-secrets.outcome }}" == "failure" ]; then
            echo "‚ùå **Secrets Check**: Failed - Potential secrets found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Secrets Check**: Passed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check-console.outputs.console_warning }}" == "true" ]; then
            echo "‚ö†Ô∏è **Console.log Check**: Found console.log statements" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Console.log Check**: Passed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.validate-template.outputs.template_warning }}" == "true" ]; then
            echo "‚ö†Ô∏è **PR Template**: Has unchecked items" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **PR Template**: Complete" >> $GITHUB_STEP_SUMMARY
          fi

  lint-orphans:
    name: Lint Orphan Components & Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.22.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Orphan Lint
        id: orphan-lint
        run: |
          npx tsx scripts/maintenance/lint-orphans.ts --fix-suggestions 2>&1 | tee orphan-lint-output.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code
        continue-on-error: true

      - name: Upload Orphan Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: orphan-lint-report
          path: orphan-lint-report.json
          retention-days: 30

      - name: Post Orphan Lint Summary
        if: always()
        run: |
          echo "## üîç Orphan Lint Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f orphan-lint-report.json ]; then
            COMPONENTS=$(jq -r '.summary.orphanComponents' orphan-lint-report.json)
            RPC=$(jq -r '.summary.unusedRpcFunctions' orphan-lint-report.json)
            TABLES=$(jq -r '.summary.tablesWithoutQueries' orphan-lint-report.json)
            CRITICAL=$(jq -r '.summary.criticalOrphans' orphan-lint-report.json)
            PASSED=$(jq -r '.summary.passed' orphan-lint-report.json)

            echo "| Metric | Count | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Orphan Components | $COMPONENTS | $([ $COMPONENTS -le 5 ] && echo '‚úÖ' || echo '‚ùå') |" >> $GITHUB_STEP_SUMMARY
            echo "| Unused RPC Functions | $RPC | $([ $RPC -le 5 ] && echo '‚úÖ' || echo '‚ùå') |" >> $GITHUB_STEP_SUMMARY
            echo "| Tables without Queries | $TABLES | $([ $TABLES -le 5 ] && echo '‚úÖ' || echo '‚ùå') |" >> $GITHUB_STEP_SUMMARY
            echo "| Critical Issues | $CRITICAL | $([ $CRITICAL -eq 0 ] && echo '‚úÖ' || echo '‚ùå') |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$CRITICAL" -gt 0 ]; then
              echo "### ‚ùå Critical Issues Found:" >> $GITHUB_STEP_SUMMARY
              jq -r '.criticalIssues[] | "- **\(.type)**: `\(.name)` - \(.reason)"' orphan-lint-report.json >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$PASSED" = "true" ]; then
              echo "### ‚úÖ Orphan Lint Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ‚ùå Orphan Lint Failed" >> $GITHUB_STEP_SUMMARY
              echo "Please fix critical issues before merging." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è No report generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if Critical Issues
        if: steps.orphan-lint.outputs.exit_code != '0'
        run: |
          echo "‚ùå Orphan lint found critical issues. See report for details."
          exit 1

  check-migrations:
    name: Check Database Migrations
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.head.ref, 'migration') || contains(github.event.pull_request.title, 'migration') || contains(github.event.pull_request.title, 'Migration')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Migration Files
        id: check-migrations
        run: |
          echo "Checking for migration files..."
          MIGRATIONS=$(find . -path "*/migrations/*.sql" -newer "${{ github.event.pull_request.base.sha }}" 2>/dev/null | wc -l || echo "0")
          
          if [ "$MIGRATIONS" -gt 0 ]; then
            echo "‚ö†Ô∏è This PR contains migrations. Please ensure:"
            echo "  1. Migrations have been tested in staging"
            echo "  2. Rollback plan is documented"
            echo "  3. Backup has been considered"
            echo "migrations_found=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No new migrations found"
            echo "migrations_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate Migration Syntax
        if: steps.check-migrations.outputs.migrations_found == 'true'
        run: |
          echo "Validating migration SQL syntax..."
          # Basic SQL syntax check (can be enhanced with actual SQL parser)
          find . -path "*/migrations/*.sql" -newer "${{ github.event.pull_request.base.sha }}" -exec echo "Checking: {}" \;

  post-review-reminder:
    name: Post Review Reminder
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'ready_for_review'
    
    steps:
      - name: Create Review Reminder Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = `## üìã Code Review Required
            
            This PR requires code review before merging. Please ensure:
            
            - [ ] At least 1 approval from a code reviewer
            - [ ] All CI checks pass
            - [ ] No conflicts with \`main\` branch
            - [ ] PR checklist is complete
            
            **Review Guidelines**: See [CODE_REVIEW_GUIDELINES.md](/.github/CODE_REVIEW_GUIDELINES.md)
            
            ---
            
            üëÄ **Reviewers**: Please review this PR following our [Code Review Guidelines](/.github/CODE_REVIEW_GUIDELINES.md)`;
            
            github.rest.issues.createComment({
              issue_number: pr.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });







