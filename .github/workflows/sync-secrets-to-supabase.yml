name: Sync Secrets to Supabase

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "sync" to confirm'
        required: true
      secrets_to_sync:
        description: 'Which secrets to sync'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - mercadopago
          - social_media
          - tiktok

permissions:
  contents: read

jobs:
  sync-secrets:
    name: Sync Secrets to Supabase Edge Functions
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'sync'

    steps:
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # ============================================================
      # MERCADOPAGO SECRETS
      # ============================================================
      - name: Sync MERCADOPAGO_ACCESS_TOKEN
        if: contains(fromJson('["all", "mercadopago"]'), github.event.inputs.secrets_to_sync)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          MP_TOKEN: ${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
        run: |
          if [ -z "$MP_TOKEN" ]; then
            echo "‚ö†Ô∏è MERCADOPAGO_ACCESS_TOKEN not found in GitHub Secrets - skipping"
          else
            echo "üîÑ Syncing MERCADOPAGO_ACCESS_TOKEN..."
            supabase secrets set MERCADOPAGO_ACCESS_TOKEN="$MP_TOKEN" --project-ref "$SUPABASE_PROJECT_ID"
            echo "‚úÖ MERCADOPAGO_ACCESS_TOKEN synced"
          fi

      # ============================================================
      # FACEBOOK/INSTAGRAM (META) SECRETS
      # ============================================================
      - name: Sync FACEBOOK_ACCESS_TOKEN
        if: contains(fromJson('["all", "social_media"]'), github.event.inputs.secrets_to_sync)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          FB_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
        run: |
          if [ -z "$FB_TOKEN" ]; then
            echo "‚ö†Ô∏è FACEBOOK_ACCESS_TOKEN not found in GitHub Secrets - skipping"
          else
            echo "üîÑ Syncing FACEBOOK_ACCESS_TOKEN..."
            supabase secrets set FACEBOOK_ACCESS_TOKEN="$FB_TOKEN" --project-ref "$SUPABASE_PROJECT_ID"
            echo "‚úÖ FACEBOOK_ACCESS_TOKEN synced"
          fi

      - name: Sync FACEBOOK_PAGE_ID
        if: contains(fromJson('["all", "social_media"]'), github.event.inputs.secrets_to_sync)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          FB_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
        run: |
          if [ -z "$FB_PAGE_ID" ]; then
            echo "‚ö†Ô∏è FACEBOOK_PAGE_ID not found in GitHub Secrets - skipping"
          else
            echo "üîÑ Syncing FACEBOOK_PAGE_ID..."
            supabase secrets set FACEBOOK_PAGE_ID="$FB_PAGE_ID" --project-ref "$SUPABASE_PROJECT_ID"
            echo "‚úÖ FACEBOOK_PAGE_ID synced"
          fi

      - name: Sync INSTAGRAM_ACCESS_TOKEN
        if: contains(fromJson('["all", "social_media"]'), github.event.inputs.secrets_to_sync)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          IG_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
        run: |
          if [ -z "$IG_TOKEN" ]; then
            echo "‚ö†Ô∏è INSTAGRAM_ACCESS_TOKEN not found in GitHub Secrets - skipping"
          else
            echo "üîÑ Syncing INSTAGRAM_ACCESS_TOKEN..."
            supabase secrets set INSTAGRAM_ACCESS_TOKEN="$IG_TOKEN" --project-ref "$SUPABASE_PROJECT_ID"
            echo "‚úÖ INSTAGRAM_ACCESS_TOKEN synced"
          fi

      - name: Sync INSTAGRAM_PAGE_ID
        if: contains(fromJson('["all", "social_media"]'), github.event.inputs.secrets_to_sync)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          IG_PAGE_ID: ${{ secrets.INSTAGRAM_PAGE_ID }}
        run: |
          if [ -z "$IG_PAGE_ID" ]; then
            echo "‚ö†Ô∏è INSTAGRAM_PAGE_ID not found in GitHub Secrets - skipping"
          else
            echo "üîÑ Syncing INSTAGRAM_PAGE_ID..."
            supabase secrets set INSTAGRAM_PAGE_ID="$IG_PAGE_ID" --project-ref "$SUPABASE_PROJECT_ID"
            echo "‚úÖ INSTAGRAM_PAGE_ID synced"
          fi

      # ============================================================
      # TIKTOK SECRETS
      # ============================================================
      - name: Sync TIKTOK_ACCESS_TOKEN
        if: contains(fromJson('["all", "social_media", "tiktok"]'), github.event.inputs.secrets_to_sync)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          TT_TOKEN: ${{ secrets.TIKTOK_ACCESS_TOKEN }}
        run: |
          if [ -z "$TT_TOKEN" ]; then
            echo "‚ö†Ô∏è TIKTOK_ACCESS_TOKEN not found in GitHub Secrets - skipping"
          else
            echo "üîÑ Syncing TIKTOK_ACCESS_TOKEN..."
            supabase secrets set TIKTOK_ACCESS_TOKEN="$TT_TOKEN" --project-ref "$SUPABASE_PROJECT_ID"
            echo "‚úÖ TIKTOK_ACCESS_TOKEN synced"
          fi

      # ============================================================
      # TWITTER SECRETS
      # ============================================================
      - name: Sync TWITTER_ACCESS_TOKEN
        if: contains(fromJson('["all", "social_media"]'), github.event.inputs.secrets_to_sync)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          TW_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        run: |
          if [ -z "$TW_TOKEN" ]; then
            echo "‚ö†Ô∏è TWITTER_ACCESS_TOKEN not found in GitHub Secrets - skipping"
          else
            echo "üîÑ Syncing TWITTER_ACCESS_TOKEN..."
            supabase secrets set TWITTER_ACCESS_TOKEN="$TW_TOKEN" --project-ref "$SUPABASE_PROJECT_ID"
            echo "‚úÖ TWITTER_ACCESS_TOKEN synced"
          fi

      # ============================================================
      # VERIFICATION
      # ============================================================
      - name: Verify Synced Secrets
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "üìã Current Supabase Edge Function Secrets:"
          echo "==========================================="
          supabase secrets list --project-ref "$SUPABASE_PROJECT_ID" | grep -E "NAME|MERCADOPAGO|FACEBOOK|INSTAGRAM|TIKTOK|TWITTER" || echo "No matching secrets found"
          echo ""
          echo "‚úÖ Sync complete!"
