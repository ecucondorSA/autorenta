name: Commission Reconciliation

on:
  schedule:
    # Weekly on Sundays at 6:00 AM Argentina time (9:00 UTC)
    - cron: '0 9 * * 0'
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Days to reconcile'
        required: false
        default: '7'

permissions:
  contents: read
  issues: write

jobs:
  reconcile-commissions:
    name: Reconcile Platform Commissions
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Call payment-reconciliation Edge Function
        id: reconcile
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DAYS_BACK: ${{ inputs.days_back || '7' }}
        run: |
          echo "Reconciling commissions (last ${DAYS_BACK} days)..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${SUPABASE_URL}/functions/v1/payment-reconciliation?days=${DAYS_BACK}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq . 2>/dev/null || echo "$BODY"

          # Extract commission check specifically
          COMMISSION_CHECK=$(echo "$BODY" | jq -r '.results[] | select(.check == "commission_percentage_audit")')
          COMMISSION_ISSUES=$(echo "$COMMISSION_CHECK" | jq -r '.issues_count // 0')
          TOTAL_ISSUES=$(echo "$BODY" | jq -r '.summary.total_issues // 0')
          OVERALL=$(echo "$BODY" | jq -r '.overall_status // "unknown"')

          echo "commission_issues=$COMMISSION_ISSUES" >> $GITHUB_OUTPUT
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "overall=$OVERALL" >> $GITHUB_OUTPUT

          if [ "$HTTP_CODE" = "500" ]; then
            echo "::error::Reconciliation found critical issues"
            exit 1
          fi

          if [ "$COMMISSION_ISSUES" -gt "5" ]; then
            echo "::warning::Found $COMMISSION_ISSUES commission discrepancies"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Commission Reconciliation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall Status | ${{ steps.reconcile.outputs.overall || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commission Issues | ${{ steps.reconcile.outputs.commission_issues || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Issues (all checks) | ${{ steps.reconcile.outputs.total_issues || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by payment-reconciliation Edge Function (check #6)*" >> $GITHUB_STEP_SUMMARY
