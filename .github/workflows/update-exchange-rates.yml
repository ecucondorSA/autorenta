name: Update Exchange Rates

on:
  schedule:
    # Ejecutar cada 6 horas (rates crypto fluct√∫an pero no afectan reservas en tiempo real)
    # Llama Edge Function con x-region header para evitar geo-blocking de Binance
    - cron: '0 */6 * * *'
  workflow_dispatch: # Permitir ejecuci√≥n manual

jobs:
  update-rates:
    runs-on: ubuntu-latest
    steps:
      - name: Call Edge Function with region configuration
        env:
          SUPABASE_URL: https://aceacpaockyxgogxsfyc.supabase.co
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -e

          echo "üìä Calling Edge Function sync-binance-rates..."
          echo "üåç Testing working regions to bypass Binance geo-blocking..."

          # Regiones verificadas que funcionan (sa-east-1 m√°s cercana a Argentina/Brasil)
          # Testeado 2025-11-05: sa-east-1 ‚úÖ, eu-central-1 ‚úÖ, ap-southeast-1 ‚úÖ
          # Bloqueadas: us-west-2 ‚ùå
          REGIONS=("sa-east-1" "eu-central-1" "ap-southeast-1" "eu-west-1" "ap-south-1")
          SUCCESS=false

          for REGION in "${REGIONS[@]}"; do
            echo ""
            echo "üîÑ Trying region: $REGION"

            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              "${SUPABASE_URL}/functions/v1/sync-binance-rates" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "Content-Type: application/json" \
              -H "x-region: ${REGION}")

            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)

            echo "üì° HTTP Status: $HTTP_CODE"
            echo "üì¶ Response: $BODY"

            # Verificar si fue exitoso (200 y no contiene error 451)
            if [ "$HTTP_CODE" = "200" ] && ! echo "$BODY" | grep -q "451"; then
              echo "‚úÖ Success with region: $REGION"
              SUCCESS=true
              break
            else
              echo "‚ùå Failed with region: $REGION"
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "‚ùå All regions failed. Binance might be blocking all Supabase regions."
            exit 1
          fi

          echo ""
          echo "‚úÖ Exchange rates updated successfully at $(date)"

      - name: Verify update
        env:
          SUPABASE_URL: https://aceacpaockyxgogxsfyc.supabase.co
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üîç Verifying database update..."
          curl -s "${SUPABASE_URL}/rest/v1/exchange_rates?is_active=eq.true&select=pair,platform_rate,last_updated" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" | jq .
