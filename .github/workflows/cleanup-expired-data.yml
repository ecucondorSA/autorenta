name: Cleanup Expired Data

on:
  schedule:
    # Daily at 4:00 AM Argentina time (7:00 UTC)
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (count only, no deletions)'
        required: false
        default: 'false'
        type: boolean

jobs:
  cleanup:
    name: Cleanup Expired Data
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Call expire-pending-deposits Edge Function
        id: cleanup
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        run: |
          echo "Cleaning expired data (dry_run: ${DRY_RUN})..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${SUPABASE_URL}/functions/v1/expire-pending-deposits?dry_run=${DRY_RUN}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq . 2>/dev/null || echo "$BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Cleanup failed with HTTP $HTTP_CODE"
            exit 1
          fi

          TOTAL=$(echo "$BODY" | jq -r '.total_cleaned // 0')
          ERRORS=$(echo "$BODY" | jq -r '.errors // 0')

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

      - name: Summary
        if: always()
        run: |
          echo "## Cleanup Expired Data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Cleaned | ${{ steps.cleanup.outputs.total || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.cleanup.outputs.errors || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by expire-pending-deposits Edge Function*" >> $GITHUB_STEP_SUMMARY
