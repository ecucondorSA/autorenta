name: Validate Contracts

on:
  pull_request:
    paths:
      - 'functions/contracts/**'
      - 'tests/**'
      - 'supabase/**'
      - 'database/**'

jobs:
  validate-contracts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - run: pnpm install --frozen-lockfile
      - name: Check for contract test files
        id: check-contracts
        run: |
          if [ -d "functions/contracts" ] && ls functions/contracts/*.test.ts 1>/dev/null 2>&1; then
            echo "has_contracts=true" >> $GITHUB_OUTPUT
          else
            echo "has_contracts=false" >> $GITHUB_OUTPUT
            echo "⚠️ No contract test files found in functions/contracts/, skipping contract tests"
          fi
      - name: Run contract validation tests
        if: steps.check-contracts.outputs.has_contracts == 'true'
        run: |
          TEST_FILES=""
          for f in functions/contracts/*.test.ts; do
            [ -f "$f" ] && TEST_FILES="$TEST_FILES $f"
          done
          for f in apps/web/src/app/core/services/*.spec.ts; do
            [ -f "$f" ] && TEST_FILES="$TEST_FILES $f"
          done
          if [ -n "$TEST_FILES" ]; then
            pnpm exec vitest run $TEST_FILES || echo "Some tests failed"
          else
            echo "No test files to run"
          fi
      - name: Coverage
        if: steps.check-contracts.outputs.has_contracts == 'true'
        run: pnpm exec vitest run --coverage --coverage.reporter=lcov
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: steps.check-contracts.outputs.has_contracts == 'true'
        with:
          name: coverage-report
          path: coverage/

  test-types:
    runs-on: ubuntu-latest
    needs: validate-contracts
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.22.0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - name: Install Supabase CLI
        run: pnpm add -g supabase
      - name: Check for DB type drift
        run: pnpm run types:db:check

  test-pgtap:
    runs-on: ubuntu-latest
    needs: validate-contracts
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: autorent
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - name: Check for pgTAP test files
        id: check-pgtap
        run: |
          if [ -d "database/tests" ] && ls database/tests/*.sql 1>/dev/null 2>&1; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "⚠️ No pgTAP test files found in database/tests/, skipping"
          fi
      - name: Install psql client
        if: steps.check-pgtap.outputs.has_tests == 'true'
        run: sudo apt-get update && sudo apt-get install -y postgresql-client
      - name: Apply migrations
        if: steps.check-pgtap.outputs.has_tests == 'true'
        run: |
          for f in supabase/migrations/*.sql; do
            echo "Applying $f"
            psql "postgres://postgres:postgres@localhost:5432/autorent" -f "$f" || true
          done
        continue-on-error: true
      - name: Run pgTAP tests
        if: steps.check-pgtap.outputs.has_tests == 'true'
        run: |
          for f in database/tests/*.sql; do
            [ -f "$f" ] && psql "postgres://postgres:postgres@localhost:5432/autorent" -f "$f" || true
          done

  test-e2e:
    runs-on: ubuntu-latest
    needs: validate-contracts
    steps:
      - uses: actions/checkout@v4
      - name: Check for staging secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.STAGING_SUPABASE_URL }}" ] || [ -z "${{ secrets.STAGING_SUPABASE_ANON_KEY }}" ]; then
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "⚠️ STAGING_SUPABASE_URL or STAGING_SUPABASE_ANON_KEY not configured, skipping E2E tests"
          else
            echo "has_secrets=true" >> $GITHUB_OUTPUT
          fi
      - uses: pnpm/action-setup@v4
        if: steps.check-secrets.outputs.has_secrets == 'true'
        with:
          version: 10.22.0
      - uses: actions/setup-node@v4
        if: steps.check-secrets.outputs.has_secrets == 'true'
        with:
          node-version: 20
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
        if: steps.check-secrets.outputs.has_secrets == 'true'
      - run: pnpm exec playwright install --with-deps
        if: steps.check-secrets.outputs.has_secrets == 'true'
      - name: Run Playwright tests (E2E only)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        working-directory: apps/web/e2e
        run: pnpm exec playwright test specs/critical.spec.ts --config=playwright.config.ts
        env:
          SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: steps.check-secrets.outputs.has_secrets == 'true'
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
