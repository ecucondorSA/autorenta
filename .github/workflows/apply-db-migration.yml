name: Apply DB Migration

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to apply (e.g., 20260201230000_payment_retry_queue.sql)'
        required: true
        type: string
      confirm:
        description: 'Type "apply" to confirm'
        required: true
        type: string

permissions:
  contents: read

jobs:
  apply-migration:
    name: Apply Migration to Supabase
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'apply'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate migration file exists
        id: validate
        run: |
          MIGRATION_PATH="supabase/migrations/${{ github.event.inputs.migration_file }}"
          if [ ! -f "$MIGRATION_PATH" ]; then
            echo "âŒ Migration file not found: $MIGRATION_PATH"
            ls -la supabase/migrations/ | head -20
            exit 1
          fi
          echo "âœ… Migration file found: $MIGRATION_PATH"
          echo "migration_path=$MIGRATION_PATH" >> $GITHUB_OUTPUT

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      - name: Show migration content
        run: |
          echo "ğŸ“„ Migration content:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          head -50 ${{ steps.validate.outputs.migration_path }}
          echo "..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Apply migration via direct SQL
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ”„ Applying migration via direct SQL..."

          # Install psql
          sudo apt-get update -qq && sudo apt-get install -y -qq postgresql-client

          # Execute migration
          psql "$DATABASE_URL" -f ${{ steps.validate.outputs.migration_path }}

          echo "âœ… Migration applied successfully"

      - name: Verify functions exist
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ğŸ” Verifying created objects..."
          psql "$DATABASE_URL" -c "SELECT proname, pg_get_function_arguments(oid) FROM pg_proc WHERE proname LIKE '%pending_retries%';"
          echo "âœ… Migration complete."
