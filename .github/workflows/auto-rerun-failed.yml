name: Auto Re-run Failed Jobs

on:
  workflow_run:
    workflows:
      - CI
      - PR Validation
      - E2E Tests
      - Patchright E2E Tests
      - Validate Contracts
      - SQL Tests
      - ðŸ”„ Types Sync Check
      - ðŸš€ Semantic Release
    types: [completed]

permissions:
  actions: write
  contents: read

jobs:
  rerun-failed:
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.run_attempt == 1 &&
      github.event.workflow_run.event != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Backoff
        run: sleep 120

      - name: Re-run failed jobs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.payload.workflow_run.id;
            await github.rest.actions.reRunWorkflowFailedJobs({
              owner,
              repo,
              run_id: runId,
            });
