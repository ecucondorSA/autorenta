name: CI

on:
  push:
    branches: [main, develop, staging]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10.22.0'

jobs:
  # ============================================
  # REQUIRED GATE - Must pass to merge
  # ============================================
  build-gate:
    name: ðŸš¨ Build Gate (Required)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript Check
        run: pnpm --filter @autorenta/web exec tsc --noEmit

      - name: Build Production
        run: pnpm build:web
        env:
          NODE_ENV: production

      - name: Security Audit (Critical only)
        run: pnpm audit --prod --audit-level=critical || true

  lint-gate:
    name: ðŸš¨ Lint Gate (Required)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

  # ============================================
  # QUALITY CHECKS - Informational (for now)
  # TODO: Make required after fixing 167 tests
  # ============================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-gate]
    # IMPORTANT: This job is NOT in the required checks list
    # Remove this comment block once tests are fixed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Unit Tests
        id: tests
        run: pnpm test:quick
        # NO continue-on-error - job will fail if tests fail

      - name: Run Tests with Coverage
        if: steps.tests.outcome == 'success'
        run: pnpm test:coverage

      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: apps/web/coverage/
          retention-days: 30

      - name: Test Summary
        if: failure()
        run: |
          echo "::warning::Unit tests failed. This is tracked as tech debt."
          echo "See: https://github.com/${{ github.repository }}/issues?q=is:issue+label:test-debt"

  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build-gate]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run E2E Tests
        run: pnpm test:e2e
        env:
          CI: true
          NG_APP_SUPABASE_URL: ${{ secrets.NG_APP_SUPABASE_URL }}
          NG_APP_SUPABASE_ANON_KEY: ${{ secrets.NG_APP_SUPABASE_ANON_KEY }}
          NG_APP_MAPBOX_ACCESS_TOKEN: ${{ secrets.MAPBOX_ACCESS_TOKEN }}
          NG_APP_MERCADOPAGO_PUBLIC_KEY: ${{ secrets.MERCADOPAGO_PROD_PUBLIC_KEY }}
          QASE_API_TOKEN: ${{ secrets.QASE_API_TOKEN }}
          QASE_PROJECT_CODE: ${{ secrets.QASE_PROJECT_CODE }}

      - name: Upload E2E Artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: e2e-artifacts
          path: |
            tests/e2e-results/
            tests/screenshots/
            tests/videos/
          retention-days: 7

  bundle-analysis:
    name: ðŸ“Š Bundle Analysis
    runs-on: ubuntu-latest
    needs: [build-gate]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build with Analysis
        run: |
          cd apps/web
          npm run analyze

      - name: Upload Bundle Report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: apps/web/dist/web/report.html
          retention-days: 14

  # ============================================
  # CI STATUS SUMMARY
  # ============================================
  ci-status:
    name: âœ… CI Status
    runs-on: ubuntu-latest
    needs: [build-gate, lint-gate, unit-tests, e2e-tests]
    if: always()
    steps:
      - name: Check Required Gates
        run: |
          echo "## CI Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Required gates
          echo "### ðŸš¨ Required Gates" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build-gate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint-gate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Quality checks
          echo "### ðŸ§ª Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY

          # Fail if required gates failed
          if [[ "${{ needs.build-gate.result }}" != "success" ]] || [[ "${{ needs.lint-gate.result }}" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Required gates failed - PR cannot be merged**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Required gates passed**" >> $GITHUB_STEP_SUMMARY
