name: TestSprite E2E Tests

on:
  # Run on pull requests to main
  pull_request:
    branches: [main]
    paths:
      - 'apps/web/src/**'
      - 'tests/e2e/**'
      - 'docs/prd/**'

  # Run on push to main (after merge)
  push:
    branches: [main]
    paths:
      - 'apps/web/src/**'
      - 'tests/e2e/**'

  # Scheduled daily smoke tests
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC = 11 PM Argentina (previous day)

  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  testsprite-e2e:
    name: E2E Tests - TestSprite
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        suite: [booking-flow, wallet-deposit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: npm run build
        working-directory: apps/web
        env:
          NODE_ENV: production

      - name: Create test environment file
        run: |
          cat > .env.test << EOF
          # Test environment for CI/CD
          PLAYWRIGHT_BASE_URL=${{ github.event.inputs.environment == 'production' && 'https://autorenta.com' || 'https://autorenta-web-preview.pages.dev' }}

          # Test users (from GitHub secrets if available)
          TEST_LOCATARIO_EMAIL=test+locatario@autorentar.com
          TEST_LOCATARIO_PASSWORD=${{ secrets.TEST_LOCATARIO_PASSWORD || 'TestPassword123!' }}

          # API URLs
          API_BASE_URL=${{ github.event.inputs.environment == 'production' && 'https://autorenta.com' || 'https://autorenta-web-preview.pages.dev' }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

          # TestSprite
          TESTSPRITE_API_KEY=${{ secrets.TESTSPRITE_API_KEY }}
          EOF

      - name: Run E2E Tests - Booking Flow
        if: matrix.suite == 'booking-flow'
        run: |
          npx playwright test tests/e2e/booking-flow-wallet-payment.spec.ts \
            --project=chromium:e2e \
            --reporter=html,json,junit
        continue-on-error: true
        env:
          TESTSPRITE_API_KEY: ${{ secrets.TESTSPRITE_API_KEY }}

      - name: Run E2E Tests - Wallet Deposit
        if: matrix.suite == 'wallet-deposit'
        run: |
          npx playwright test tests/e2e/wallet-deposit-flow.spec.ts \
            --project=chromium:e2e \
            --reporter=html,json,junit
        continue-on-error: true
        env:
          TESTSPRITE_API_KEY: ${{ secrets.TESTSPRITE_API_KEY }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testsprite-results-${{ matrix.suite }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.suite }}
          path: test-results/html-report/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = 'test-results/results.json';

            if (!fs.existsSync(resultsPath)) {
              console.log('No test results found');
              return;
            }

            const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
            const { stats } = results;

            const passRate = ((stats.expected / stats.total) * 100).toFixed(1);
            const emoji = passRate >= 90 ? 'âœ…' : passRate >= 70 ? 'âš ï¸' : 'âŒ';

            const comment = `## ${emoji} TestSprite E2E Tests - ${{ matrix.suite }}

            **Pass Rate**: ${passRate}% (${stats.expected}/${stats.total})

            | Status | Count |
            |--------|-------|
            | âœ… Passed | ${stats.expected} |
            | âŒ Failed | ${stats.unexpected} |
            | â­ï¸ Skipped | ${stats.skipped} |
            | â±ï¸ Duration | ${(stats.duration / 1000).toFixed(1)}s |

            [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: comment
            });

  # Smoke tests for production (scheduled only)
  smoke-tests:
    name: Smoke Tests - Production
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * *'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Run smoke tests
        run: |
          # Only run basic validation tests in production
          npx playwright test tests/visitor/01-homepage.spec.ts \
            --project=chromium:visitor \
            --reporter=html
        env:
          PLAYWRIGHT_BASE_URL: https://autorenta.com

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Send notification or create issue
            const title = 'ğŸš¨ Production Smoke Tests Failed';
            const body = `
            Scheduled smoke tests failed on production.

            **Time**: ${new Date().toISOString()}
            **Workflow**: ${{ github.workflow }}
            **Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please investigate immediately.
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.name,
              title: title,
              body: body,
              labels: ['bug', 'production', 'urgent']
            });

  # Summary job (runs after all test suites)
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [testsprite-e2e]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Generate summary
        run: |
          echo "## ğŸ“Š TestSprite E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count artifacts
          ARTIFACT_COUNT=$(ls -1 all-results | wc -l)
          echo "**Test Suites**: $ARTIFACT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List artifacts
          echo "### ğŸ“¦ Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          ls -1 all-results >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "âœ… **All test results uploaded as artifacts**" >> $GITHUB_STEP_SUMMARY

      - name: Check if tests passed
        run: |
          # This job will fail if any test suite failed
          if [ "${{ needs.testsprite-e2e.result }}" != "success" ]; then
            echo "âŒ One or more test suites failed"
            exit 1
          fi
          echo "âœ… All test suites passed"
