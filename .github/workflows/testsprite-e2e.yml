name: TestSprite E2E Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'tests/e2e/**'
      - 'apps/web/**'
      - '.github/workflows/testsprite-e2e.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'tests/e2e/**'
      - 'apps/web/**'
  workflow_dispatch:
    inputs:
      test_file:
        description: 'Specific test file to run (e.g., complete-porsche-publication-flow.spec.ts)'
        required: false
        type: string

jobs:
  e2e-tests:
    name: Run E2E Tests on TestSprite
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - name: 'Porsche Publication'
            file: 'tests/e2e/complete-porsche-publication-flow.spec.ts'
          - name: 'BMW Publication'
            file: 'tests/e2e/complete-bmw-publication-flow.spec.ts'
          - name: 'Mercedes Publication'
            file: 'tests/e2e/complete-mercedes-publication-flow.spec.ts'
          - name: 'Toyota Publication'
            file: 'tests/e2e/complete-toyota-publication-flow.spec.ts'
          - name: 'Error Scenarios'
            file: 'tests/e2e/car-publication-error-scenarios.spec.ts'
          - name: 'Photo Validation'
            file: 'tests/e2e/car-publication-photo-validation.spec.ts'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create .env.test
        run: |
          cat > .env.test << 'ENVEOF'
          # Supabase
          NG_APP_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          NG_APP_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

          # Mapbox
          NG_APP_MAPBOX_ACCESS_TOKEN=${{ secrets.MAPBOX_ACCESS_TOKEN }}

          # MercadoPago
          NG_APP_MERCADOPAGO_PUBLIC_KEY=${{ secrets.MERCADOPAGO_PUBLIC_KEY }}

          # Local URLs
          NG_APP_PAYMENTS_WEBHOOK_URL=http://localhost:8787/webhooks/payments
          NG_APP_URL=http://localhost:4200
          NG_APP_CLOUDFLARE_WORKER_URL=http://localhost:8787

          # Test config
          NODE_ENV=test
          ENVEOF

      - name: Start development server
        run: |
          cd apps/web
          npm start &
          echo "Waiting for server to be ready..."
          npx wait-on http://localhost:4200 --timeout 120000
        env:
          NG_APP_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NG_APP_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          NG_APP_MAPBOX_ACCESS_TOKEN: ${{ secrets.MAPBOX_ACCESS_TOKEN }}

      - name: Run E2E tests - ${{ matrix.test-suite.name }}
        id: playwright-test
        run: |
          npx playwright test ${{ matrix.test-suite.file }} \
            --reporter=list,html,json \
            --output=test-results/${{ matrix.test-suite.name }} \
            --project=chromium:e2e
        continue-on-error: true
        env:
          CI: true
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: results-${{ matrix.test-suite.name }}.xml

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.test-suite.name }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Upload test results to TestSprite (if configured)
        if: always() && env.TESTSPRITE_API_KEY != ''
        run: |
          # TestSprite CLI integration (when available)
          # npx testsprite upload-results --api-key=${{ secrets.TESTSPRITE_API_KEY }}
          echo "TestSprite integration: Upload results here"
        env:
          TESTSPRITE_API_KEY: ${{ secrets.TESTSPRITE_API_KEY }}

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const testName = '${{ matrix.test-suite.name }}';
            const status = '${{ steps.playwright-test.outcome }}';
            const emoji = status === 'success' ? 'âœ…' : 'âŒ';

            const comment = `## ${emoji} E2E Test Results: ${testName}

            **Status**: ${status}
            **Test File**: \`${{ matrix.test-suite.file }}\`
            **Commit**: ${{ github.sha }}

            View full report in the Actions artifacts.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail job if tests failed
        if: steps.playwright-test.outcome == 'failure'
        run: exit 1

  summary:
    name: E2E Tests Summary
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "All E2E test suites have completed"
          echo "Check individual job results above"

      - name: Post summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ“Š E2E Tests Summary

            All 6 test suites have been executed:
            - Porsche Publication Flow
            - BMW Publication Flow
            - Mercedes Publication Flow
            - Toyota Publication Flow
            - Error Scenarios
            - Photo Validation

            **Total Tests**: 41 tests
            **Test Files**: 6 files

            Check the individual results above for details.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
