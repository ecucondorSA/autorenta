name: ðŸ”— RPC Contract Check

# Verifica que todos los RPCs usados en el frontend existen en la BD
# Detecta problemas de integraciÃ³n ANTES de que lleguen a producciÃ³n

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - 'apps/web/src/**/*.ts'
  pull_request:
    paths:
      - 'supabase/migrations/**'
      - 'apps/web/src/**/*.ts'
  workflow_dispatch:
  schedule:
    # Run daily at 7 AM UTC to catch drift
    - cron: '0 7 * * *'

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

jobs:
  extract-rpcs:
    name: ðŸ“‹ Extract RPC calls from frontend
    runs-on: ubuntu-latest
    outputs:
      rpc_list: ${{ steps.extract.outputs.rpc_list }}
      rpc_count: ${{ steps.extract.outputs.rpc_count }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract all RPC function names from frontend code
        id: extract
        run: |
          echo "ðŸ” Scanning frontend code for RPC calls..."

          # Extract all .rpc('function_name') calls
          RPC_CALLS=$(grep -roh "\.rpc(['\"][a-z_]*['\"]" apps/web/src/ 2>/dev/null | \
            sed "s/\.rpc(['\"]//g" | sed "s/['\"]//g" | \
            sort -u | tr '\n' ',' | sed 's/,$//')

          echo "ðŸ“‹ Found RPC calls: $RPC_CALLS"

          # Count them
          RPC_COUNT=$(echo "$RPC_CALLS" | tr ',' '\n' | wc -l)
          echo "ðŸ“Š Total unique RPC functions: $RPC_COUNT"

          echo "rpc_list=$RPC_CALLS" >> $GITHUB_OUTPUT
          echo "rpc_count=$RPC_COUNT" >> $GITHUB_OUTPUT

  verify-rpcs:
    name: âœ… Verify RPCs exist in database
    runs-on: ubuntu-latest
    needs: extract-rpcs
    if: needs.extract-rpcs.outputs.rpc_count > 0
    steps:
      - uses: actions/checkout@v4

      - name: Check required secrets
        id: check-secrets
        run: |
          if [ -z "$SUPABASE_PROJECT_ID" ] || [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "âš ï¸ SUPABASE_PROJECT_ID or SUPABASE_DB_PASSWORD not configured"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup psql client
        if: steps.check-secrets.outputs.skip != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Verify each RPC exists
        if: steps.check-secrets.outputs.skip != 'true'
        run: |
          echo "ðŸ”— Connecting to database via pooler..."

          DB_URL="postgresql://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-1-sa-east-1.pooler.supabase.com:6543/postgres?sslmode=require&connect_timeout=10"

          # Test connection first
          if ! psql "$DB_URL" -c "SELECT 1" > /dev/null 2>&1; then
            echo "::error::âŒ Cannot connect to database. Check SUPABASE_PROJECT_ID and SUPABASE_DB_PASSWORD secrets."
            exit 1
          fi
          echo "âœ… Database connection OK"

          RPC_LIST="${{ needs.extract-rpcs.outputs.rpc_list }}"

          # Load allowlist
          ALLOWLIST=""
          if [ -f ".github/rpc-allowlist.txt" ]; then
            ALLOWLIST=$(grep -v '^#' .github/rpc-allowlist.txt | grep -v '^$' | cut -d'|' -f1 | tr -d ' ')
            echo "ðŸ“‹ Loaded allowlist"
          fi

          # Build SQL array from RPC list (single query instead of 166 connections)
          SQL_ARRAY=$(echo "$RPC_LIST" | tr ',' '\n' | sed "s/^/'/;s/$/'/" | tr '\n' ',' | sed 's/,$//')

          # Single query: get all existing public functions that match frontend RPCs
          EXISTING=$(psql "$DB_URL" -t -A -c "
            SELECT DISTINCT p.proname
            FROM pg_proc p
            JOIN pg_namespace n ON p.pronamespace = n.oid
            WHERE n.nspname = 'public'
            AND p.proname IN ($SQL_ARRAY)
            ORDER BY p.proname;
          " 2>&1)

          if [ $? -ne 0 ]; then
            echo "::error::âŒ Database query failed: $EXISTING"
            exit 1
          fi

          FOUND=0
          MISSING=""
          ALLOWED_MISSING=""

          for RPC in $(echo "$RPC_LIST" | tr ',' '\n'); do
            [ -z "$RPC" ] && continue

            if echo "$EXISTING" | grep -qx "$RPC"; then
              FOUND=$((FOUND + 1))
            else
              if echo "$ALLOWLIST" | grep -qx "$RPC"; then
                echo "âš ï¸ ALLOWED MISSING: $RPC"
                ALLOWED_MISSING="$ALLOWED_MISSING $RPC"
              else
                echo "âŒ MISSING: $RPC"
                MISSING="$MISSING $RPC"
              fi
            fi
          done

          ALLOWED_COUNT=$(echo "$ALLOWED_MISSING" | wc -w)

          echo ""
          echo "ðŸ“Š Results: $FOUND found, $ALLOWED_COUNT allowed missing"

          if [ "$ALLOWED_COUNT" -gt 0 ]; then
            echo "::warning::âš ï¸ $ALLOWED_COUNT RPCs in allowlist (known tech debt)"
          fi

          if [ -n "$MISSING" ]; then
            echo ""
            echo "::error::âŒ NEW missing RPC functions (not in allowlist):$MISSING"
            echo ""
            echo "Fix: add migration, remove RPC call, or add to .github/rpc-allowlist.txt"
            exit 1
          fi

          echo "âœ… All $FOUND RPCs verified ($ALLOWED_COUNT allowed missing)!"

  check-migrations-applied:
    name: ðŸ”„ Check migrations are applied
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_PROJECT_ID }}" ] || [ -z "${{ secrets.SUPABASE_DB_PASSWORD }}" ]; then
            echo "âš ï¸ Database secrets not configured, skipping migration check"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup psql client
        if: steps.check-secrets.outputs.skip != 'true'
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Compare local vs remote migrations
        if: steps.check-secrets.outputs.skip != 'true'
        run: |
          DB_URL="postgresql://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-1-sa-east-1.pooler.supabase.com:6543/postgres?sslmode=require&connect_timeout=10"

          echo "ðŸ“‚ Local migrations:"
          LOCAL_MIGRATIONS=$(ls -1 supabase/migrations/*.sql 2>/dev/null | xargs -I {} basename {} | sort)
          echo "$LOCAL_MIGRATIONS" | head -20
          LOCAL_COUNT=$(echo "$LOCAL_MIGRATIONS" | wc -l)
          echo "Total: $LOCAL_COUNT"

          echo ""
          echo "ðŸŒ Remote migrations:"
          REMOTE_MIGRATIONS=$(psql "$DB_URL" -t -c "
            SELECT name FROM supabase_migrations.schema_migrations ORDER BY name
          " 2>/dev/null | tr -d ' ' | grep -v '^$' | sort)
          echo "$REMOTE_MIGRATIONS" | head -20
          REMOTE_COUNT=$(echo "$REMOTE_MIGRATIONS" | grep -v '^$' | wc -l)
          echo "Total: $REMOTE_COUNT"

          # Find migrations that are local but not remote (pending)
          PENDING=$(comm -23 <(echo "$LOCAL_MIGRATIONS") <(echo "$REMOTE_MIGRATIONS") 2>/dev/null)

          if [ -n "$PENDING" ]; then
            echo ""
            echo "::warning::âš ï¸ Pending migrations (local but not applied to remote):"
            echo "$PENDING"
          else
            echo ""
            echo "âœ… All local migrations are applied to remote"
          fi

  summary:
    name: ðŸ“ Generate Summary
    runs-on: ubuntu-latest
    needs: [extract-rpcs, verify-rpcs, check-migrations-applied]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸ”— RPC Contract Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| RPC Extraction | ${{ needs.extract-rpcs.outputs.rpc_count }} functions found |" >> $GITHUB_STEP_SUMMARY
          echo "| RPC Verification | ${{ needs.verify-rpcs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Migrations Check | ${{ needs.check-migrations-applied.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.verify-rpcs.result }}" == "failure" ]; then
            echo "### âŒ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "NEW RPC functions (not in allowlist) are missing from the database." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To fix:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Add the missing migration to create the function" >> $GITHUB_STEP_SUMMARY
            echo "2. Or remove the RPC call from the frontend" >> $GITHUB_STEP_SUMMARY
            echo "3. Or add to \`.github/rpc-allowlist.txt\` if intentionally deferred" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All RPCs verified" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some RPCs may be in the allowlist (known tech debt). See \`.github/rpc-allowlist.txt\`." >> $GITHUB_STEP_SUMMARY
          fi
