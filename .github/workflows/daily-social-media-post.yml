name: Daily Social Media Post

on:
  schedule:
    # Run daily at 10:00 AM Argentina time (13:00 UTC)
    - cron: '0 13 * * *'
  workflow_dispatch:
    inputs:
      content_type:
        description: 'Type of content to generate'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - tip
          - promo
          - car_spotlight
          - community
      platform:
        description: 'Platform to post to (TikTok/Twitter suspended since 2026-01-22)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - instagram
          - facebook
      dry_run:
        description: 'Dry run (no actual posting)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  issues: write

jobs:
  generate-and-post:
    name: Generate & Publish Content
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Determine Content Type & Platform
        id: config
        run: |
          # Get day of week (1=Monday, 7=Sunday)
          DOW=$(date +%u)

          # Schedule (Updated 2026-01-29):
          # TikTok/Twitter SUSPENDED since 2026-01-22
          # Only Instagram and Facebook are active
          #
          # Mon: Tips on Instagram
          # Tue: Car spotlight on Facebook
          # Wed: Promo on Instagram
          # Thu: Community on Facebook
          # Fri: Promo on Instagram
          # Sat: Car spotlight on Facebook
          # Sun: Community on Instagram

          if [ "${{ inputs.content_type }}" != "auto" ] && [ -n "${{ inputs.content_type }}" ]; then
            CONTENT_TYPE="${{ inputs.content_type }}"
          else
            case $DOW in
              1) CONTENT_TYPE="tip" ;;
              2) CONTENT_TYPE="car_spotlight" ;;
              3) CONTENT_TYPE="promo" ;;
              4) CONTENT_TYPE="community" ;;
              5) CONTENT_TYPE="promo" ;;
              6) CONTENT_TYPE="car_spotlight" ;;
              7) CONTENT_TYPE="community" ;;
              *) CONTENT_TYPE="tip" ;;
            esac
          fi

          if [ "${{ inputs.platform }}" != "auto" ] && [ -n "${{ inputs.platform }}" ]; then
            PLATFORM="${{ inputs.platform }}"
          else
            # Alternate between Instagram (odd days) and Facebook (even days)
            case $DOW in
              1|3|5|7) PLATFORM="instagram" ;;
              2|4|6)   PLATFORM="facebook" ;;
              *)       PLATFORM="instagram" ;;
            esac
          fi

          echo "content_type=$CONTENT_TYPE" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "dry_run=${{ inputs.dry_run || 'false' }}" >> $GITHUB_OUTPUT

          echo "üìÖ Day of week: $DOW"
          echo "üìù Content type: $CONTENT_TYPE"
          echo "üì± Platform: $PLATFORM"

      - name: Generate Marketing Content
        id: generate
        uses: actions/github-script@v7
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CONTENT_TYPE: ${{ steps.config.outputs.content_type }}
          PLATFORM: ${{ steps.config.outputs.platform }}
        with:
          script: |
            const supabaseUrl = process.env.SUPABASE_URL;
            const supabaseKey = process.env.SUPABASE_SERVICE_KEY;
            const contentType = process.env.CONTENT_TYPE;
            const platform = process.env.PLATFORM;

            console.log('Generating ' + contentType + ' content for ' + platform + '...');

            // Call generate-marketing-content Edge Function
            // Always generate images - Instagram and Facebook both require media
            const response = await fetch(supabaseUrl + '/functions/v1/generate-marketing-content', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + supabaseKey,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                content_type: contentType,
                platform: platform,
                language: 'es',
                generate_image: true, // Always generate - required for Instagram/Facebook
                save_to_db: true, // Required to upload image to storage and get URL
              }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error('Generation failed: ' + response.status + ' - ' + errorText);
            }

            const result = await response.json();

            if (!result.success) {
              throw new Error('Generation failed: ' + result.error);
            }

            console.log('Generated content:');
            console.log('  Caption: ' + result.text.caption.substring(0, 100) + '...');
            console.log('  Hashtags: ' + result.text.hashtags.join(', '));
            console.log('  CTA: ' + result.text.call_to_action);
            console.log('  Image: ' + (result.image?.url ? 'Yes ‚úÖ' : 'No ‚ùå'));

            // Validate image was generated (required for Instagram/Facebook)
            const mediaUrl = result.image?.url || '';
            if (!mediaUrl) {
              console.warn('‚ö†Ô∏è WARNING: No image generated. Instagram/Facebook require media.');
              console.warn('Publishing may fail without an image.');
            }

            // Store in outputs
            core.setOutput('caption', result.text.caption);
            core.setOutput('hashtags', JSON.stringify(result.text.hashtags));
            core.setOutput('cta', result.text.call_to_action);
            core.setOutput('media_url', mediaUrl);
            core.setOutput('suggested_time', result.suggested_post_time || '');
            core.setOutput('has_image', mediaUrl ? 'true' : 'false');

            return result;

      - name: Publish to Social Media
        id: publish
        if: steps.config.outputs.dry_run != 'true'
        uses: actions/github-script@v7
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PLATFORM: ${{ steps.config.outputs.platform }}
          CAPTION: ${{ steps.generate.outputs.caption }}
          HASHTAGS: ${{ steps.generate.outputs.hashtags }}
          MEDIA_URL: ${{ steps.generate.outputs.media_url }}
        with:
          script: |
            const supabaseUrl = process.env.SUPABASE_URL;
            const supabaseKey = process.env.SUPABASE_SERVICE_KEY;
            const platform = process.env.PLATFORM;
            const caption = process.env.CAPTION;
            const hashtags = JSON.parse(process.env.HASHTAGS || '[]');
            const mediaUrl = process.env.MEDIA_URL;

            console.log('Publishing to ' + platform + '...');
            console.log('  Media URL: ' + (mediaUrl ? '‚úÖ ' + mediaUrl.substring(0, 50) + '...' : '‚ùå MISSING'));

            // Warn if no media (Instagram/Facebook require it)
            if (!mediaUrl) {
              console.warn('‚ö†Ô∏è No media URL provided. This will likely fail for Instagram/Facebook.');
            }

            // Call social-media-publisher Edge Function
            const response = await fetch(supabaseUrl + '/functions/v1/social-media-publisher', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + supabaseKey,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                platform: platform,
                content: {
                  text: caption,
                  media_url: mediaUrl || undefined,
                  media_type: mediaUrl ? 'image' : undefined,
                  hashtags: hashtags,
                },
              }),
            });

            const result = await response.json();

            if (!result.success) {
              console.error('Publishing failed: ' + result.error);
              core.setOutput('success', 'false');
              core.setOutput('error', result.error);
              return result;
            }

            console.log('‚úÖ Published successfully!');
            console.log('  Post ID: ' + result.post_id);
            console.log('  Post URL: ' + result.post_url);

            core.setOutput('success', 'true');
            core.setOutput('post_id', result.post_id);
            core.setOutput('post_url', result.post_url);

            return result;

      - name: Create Summary Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const platform = '${{ steps.config.outputs.platform }}';
            const contentType = '${{ steps.config.outputs.content_type }}';
            const dryRun = '${{ steps.config.outputs.dry_run }}' === 'true';
            const success = '${{ steps.publish.outputs.success }}' === 'true';
            const postUrl = '${{ steps.publish.outputs.post_url }}';
            const error = '${{ steps.publish.outputs.error }}';
            const caption = `${{ steps.generate.outputs.caption }}`.replace(/`/g, '').substring(0, 200);
            const today = new Date().toISOString().split('T')[0];
            const status = dryRun ? 'üîµ DRY RUN' : (success ? '‚úÖ SUCCESS' : '‚ùå FAILED');

            const title = '[SOCIAL MEDIA] ' + today + ' - ' + platform.toUpperCase() + ' - ' + status;


            let body = '## Daily Social Media Post - ' + today + '\n\n' +
              '| Field | Value |\n' +
              '|-------|-------|\n' +
              '| Platform | ' + platform + ' |\n' +
              '| Content Type | ' + contentType + ' |\n' +
              '| Status | ' + status + ' |\n' +
              (postUrl ? '| Post URL | [View Post](' + postUrl + ') |\n' : '') +
              (error ? '| Error | ' + error + ' |\n' : '') +
              '\n### Generated Caption\n' +
              '```\n' +
              caption + '...\n' +
              '```\n\n' +
              '---\n' +
              '*Auto-generated by Daily Social Media Post workflow*';

            // Only create issue if not dry run, or if failed
            if (!dryRun || !success) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['marketing', 'social-media', dryRun ? 'dry-run' : (success ? 'success' : 'failed')],
              });
            }
